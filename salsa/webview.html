<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 00:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webview</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Webview</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org595cf88">1. Webview on android-N</a>
<ul>
<li><a href="#orgcf8ca6b">1.1. Webview provider list</a></li>
<li><a href="#orgfdf9f59">1.2. Keep track of installed/current webview provider</a>
<ul>
<li><a href="#org8438c44">1.2.1. receiving package manager broadcast</a></li>
<li><a href="#orgd00b44c">1.2.2. change webview provider from `DeveloperSettings`</a></li>
</ul>
</li>
<li><a href="#org92f3176">1.3. Load the provider</a>
<ul>
<li><a href="#orga7ffe8e">1.3.1. Load java class</a></li>
<li><a href="#orgc3805b7">1.3.2. Load native libraries</a></li>
</ul>
</li>
<li><a href="#orgfaf1591">1.4. aosp, GMS, chrome, webview.apk, webviewgoogle.apk</a></li>
<li><a href="#org870a933">1.5. To summaries</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org595cf88" class="outline-2">
<h2 id="org595cf88"><span class="section-number-2">1</span> Webview on android-N</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgcf8ca6b" class="outline-3">
<h3 id="orgcf8ca6b"><span class="section-number-3">1.1</span> Webview provider list</h3>
<div class="outline-text-3" id="text-1-1">
<p>
frameworks/base/core/res/res/xml/config_webview_packages.xml:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="font-weight: bold;">webviewproviders</span>&gt;
    &lt;<span style="font-weight: bold;">webviewprovider</span> <span style="font-weight: bold; font-style: italic;">description</span>=<span style="font-style: italic;">"Android WebView"</span> <span style="font-weight: bold; font-style: italic;">packageName</span>=<span style="font-style: italic;">"com.android.webview"</span> <span style="font-weight: bold; font-style: italic;">availableByDefault</span>=<span style="font-style: italic;">"true"</span>&gt;
    &lt;/<span style="font-weight: bold;">webviewprovider</span>&gt;
&lt;/<span style="font-weight: bold;">webviewproviders</span>&gt;
</pre>
</div>

<p>
In Android N, user could choose the webview `provider`, according to
the `webviewprovider` list and the actually installed packages.
</p>
</div>
</div>

<div id="outline-container-orgfdf9f59" class="outline-3">
<h3 id="orgfdf9f59"><span class="section-number-3">1.2</span> Keep track of installed/current webview provider</h3>
<div class="outline-text-3" id="text-1-2">
<p>
WebViewUpdateService keeps track of the installed webview providers
</p>
</div>

<div id="outline-container-org8438c44" class="outline-4">
<h4 id="org8438c44"><span class="section-number-4">1.2.1</span> receiving package manager broadcast</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-java">mWebViewUpdatedReceiver = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">BroadcastReceiver</span>() {
        <span style="font-weight: bold;">switch</span> (intent.getAction()) {
            <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_REMOVED:
                mImpl.packageStateChanged(packageNameFromIntent(intent),
                                          PACKAGE_REMOVED, userId);
                <span style="font-weight: bold;">break</span>;
            <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_CHANGED:
                <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
            <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_ADDED:
                <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
        };
    };

<span style="font-weight: bold; text-decoration: underline;">IntentFilter</span> <span style="font-weight: bold; font-style: italic;">filter</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">IntentFilter</span>();
filter.addAction(<span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_ADDED);
filter.addAction(<span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_REMOVED);
filter.addAction(<span style="font-weight: bold; text-decoration: underline;">Intent</span>.ACTION_PACKAGE_CHANGED);
filter.addDataScheme(<span style="font-style: italic;">"package"</span>);
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">mImpl.getWebViewPackages() corresponding to the `webview provider</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">list`, thus, only packages in the `webview provider list` are considered</span>
<span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">WebViewProviderInfo</span> <span style="font-weight: bold; font-style: italic;">provider</span> : mImpl.getWebViewPackages()) {
    filter.addDataSchemeSpecificPart(provider.packageName, <span style="font-weight: bold; text-decoration: underline;">PatternMatcher</span>.PATTERN_LITERAL);
}
</pre>
</div>

<p>
mImpl.packageStateChanged will remember the `current webview provider`
as mCurrentWebViewPackage
</p>
</div>
</div>

<div id="outline-container-orgd00b44c" class="outline-4">
<h4 id="orgd00b44c"><span class="section-number-4">1.2.2</span> change webview provider from `DeveloperSettings`</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
`changeProviderAndSetting` will also remember the
mCurrentWebViewPackage, but is called by `DeveloperSettings` when the
user choose a webview provider
</p>
</div>
</div>
</div>

<div id="outline-container-org92f3176" class="outline-3">
<h3 id="org92f3176"><span class="section-number-3">1.3</span> Load the provider</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-orga7ffe8e" class="outline-4">
<h4 id="orga7ffe8e"><span class="section-number-4">1.3.1</span> Load java class</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-java">WebView ():
  ensureProviderCreated()
    mProvider = getFactory().createWebView(<span style="font-weight: bold;">this</span>, <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">PrivateAccess</span>());

<span style="font-weight: bold; text-decoration: underline;">getFactory</span>():
  <span style="font-weight: bold;">return</span> WebViewFactory.getProvider();
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">getProviderClass will load class from mCurrentWebViewPackage</span>
    <span style="font-weight: bold; text-decoration: underline;">Class</span>&lt;<span style="font-weight: bold; text-decoration: underline;">WebViewFactoryProvider</span>&gt; <span style="font-weight: bold; font-style: italic;">providerClass</span> = getProviderClass();
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">get the application context correponding to</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">mCurrentWebViewPackage</span>
      webViewContext = getWebViewContextAndSetProvider();
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">the class loader</span>
      <span style="font-weight: bold; text-decoration: underline;">ClassLoader</span> <span style="font-weight: bold; font-style: italic;">clazzLoader</span> = webViewContext.getClassLoader();
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">return the class:</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">`com.android.webview.chromium.WebViewChromiumFactoryProvider`</span>
      <span style="font-weight: bold;">return</span> (<span style="font-weight: bold; text-decoration: underline;">Class</span>&lt;<span style="font-weight: bold; text-decoration: underline;">WebViewFactoryProvider</span>&gt;) Class.forName(CHROMIUM_WEBVIEW_FACTORY, <span style="font-weight: bold; text-decoration: underline;">true</span>, clazzLoader);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">WebViewDelegate is used by the WebView provider implementation</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">to access the required framework functionality</span>
    sProviderInstance = providerClass.getConstructor(WebViewDelegate.<span style="font-weight: bold;">class</span>).newInstance(<span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">WebViewDelegate</span>());
    <span style="font-weight: bold;">return</span> sProviderInstance
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3805b7" class="outline-4">
<h4 id="orgc3805b7"><span class="section-number-4">1.3.2</span> Load native libraries</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Just use the standard `System.loadLibrary` to load native libraries,
which is based on `dlopen` and `dlsym`
</p>
</div>
</div>
</div>

<div id="outline-container-orgfaf1591" class="outline-3">
<h3 id="orgfaf1591"><span class="section-number-3">1.4</span> aosp, GMS, chrome, webview.apk, webviewgoogle.apk</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li><p>
aosp
</p>

<p>
aosp webview.apk is the sole provider
</p></li>

<li><p>
aosp + chrome (standalone)
</p>

<p>
because chrome's package name (com.android.chrome) is not listed in
the provider list, it can't be treated as a webview provider. The
aosp webview.apk is the sole provider
</p></li>

<li><p>
GMS
</p>

<p>
GMS will replace the provider list with
${GMS}/products/gms_overlay/frameworks/base/core/res/res/xml/config_webview_packages.xml,
which is:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="font-weight: bold;">webviewproviders</span>&gt;
  &lt;<span style="font-weight: bold;">webviewprovider</span> <span style="font-weight: bold; font-style: italic;">description</span>=<span style="font-style: italic;">"Chrome Stable"</span> <span style="font-weight: bold; font-style: italic;">packageName</span>=<span style="font-style: italic;">"com.android.chrome"</span> <span style="font-weight: bold; font-style: italic;">availableByDefault</span>=<span style="font-style: italic;">"true"</span>&gt;
  &lt;/<span style="font-weight: bold;">webviewprovider</span>&gt;
  &lt;<span style="font-weight: bold;">webviewprovider</span> <span style="font-weight: bold; font-style: italic;">description</span>=<span style="font-style: italic;">"Google WebView"</span> <span style="font-weight: bold; font-style: italic;">packageName</span>=<span style="font-style: italic;">"com.google.android.webview"</span> <span style="font-weight: bold; font-style: italic;">availableByDefault</span>=<span style="font-style: italic;">"true"</span> <span style="font-weight: bold; font-style: italic;">isFallback</span>=<span style="font-style: italic;">"true"</span>&gt;
  &lt;/<span style="font-weight: bold;">webviewprovider</span>&gt;
  &lt;<span style="font-weight: bold;">webviewprovider</span> <span style="font-weight: bold; font-style: italic;">description</span>=<span style="font-style: italic;">"Chrome Beta"</span> <span style="font-weight: bold; font-style: italic;">packageName</span>=<span style="font-style: italic;">"com.chrome.beta"</span>&gt;
  &lt;/<span style="font-weight: bold;">webviewprovider</span>&gt;
  <span style="font-weight: bold; font-style: italic;">&lt;!-- </span><span style="font-weight: bold; font-style: italic;">... </span><span style="font-weight: bold; font-style: italic;">--&gt;</span>
&lt;/<span style="font-weight: bold;">webviewproviders</span>&gt;  
</pre>
</div>

<p>
`com.android.chrome` correponds to GMS chrome,
`com.google.android.webview` correponds to GMS webviewgoogle.apk
</p>

<p>
Because `com.google.android.webview` is `fallback`, although it is
installed, it is disabled by the PackagedManagerService until all
other non-fallback providers are removed. so GMS chrome is the sole
provider on GMS
</p></li>
</ul>

<p>
It should be noted that GMS chrome is different from standalone
chrome: standalone chrome can't be treated as webview provider because
it doesn't meet the criteria listed below. 
</p>
</div>
</div>

<div id="outline-container-org870a933" class="outline-3">
<h3 id="org870a933"><span class="section-number-3">1.5</span> To summaries</h3>
<div class="outline-text-3" id="text-1-5">
<ol class="org-ol">
<li>android framework provides:

<ol class="org-ol">
<li><p>
WebView interface
</p>

<p>
which relay most of it's work to WebViewProvider implementation
</p></li>

<li><p>
WebViewFactory, WebViewUpdateService
</p>

<p>
find the WebViewProvider implementation
</p></li>

<li><p>
WebViewDelegate
</p>

<p>
WebViewProvider implementation use WebViewDelegate to access the
framework functionality
</p></li>

<li><p>
WebViewProvider interface
</p>

<p>
interface with the WebViewProvider implementation
</p></li>
</ol></li>

<li><p>
WebViewProvider implementation
</p>

<p>
any packages meets the following criteria could be a
valid WebViewProvider implementation:
</p>

<ol class="org-ol">
<li>listed in the webviewproviders list</li>

<li>has implemented the class
`com.android.webview.chromium.WebViewChromiumFactoryProvider`</li>

<li><p>
specifiy necessary meta-data in AndroidManifest.xml, like:
</p>

<p>
&lt;meta-data android:name="com.android.webview.WebViewLibrary"
android:value="libtest.so"/&gt;
</p></li>
</ol></li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-01-05 Thu 00:00<br />
Last updated: 2021-10-31 Sun 20:52</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
