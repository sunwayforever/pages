<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 11:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Java Annotation</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Java Annotation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org959155a">1. Java Annotation</a>
<ul>
<li><a href="#org37b2094">1.1. 定义 annotation</a>
<ul>
<li><a href="#orgeb17a3b">1.1.1. @Target</a></li>
<li><a href="#org041dc01">1.1.2. @Retention</a></li>
<li><a href="#orgb12d7fe">1.1.3. @interface</a></li>
</ul>
</li>
<li><a href="#org9619da0">1.2. 使用 annotation</a></li>
<li><a href="#org99d56cb">1.3. 运行时 annotation</a></li>
<li><a href="#orgeeb89f1">1.4. 编译时 annotation</a>
<ul>
<li><a href="#org13b040c">1.4.1. 使用 annotation processor</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org959155a" class="outline-2">
<h2 id="org959155a"><span class="section-number-2">1</span> Java Annotation</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org37b2094" class="outline-3">
<h3 id="org37b2094"><span class="section-number-3">1.1</span> 定义 annotation</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@Target</span>(<span style="font-weight: bold; text-decoration: underline;">ElementType</span>.<span style="font-weight: bold; text-decoration: underline;">TYPE</span>)
<span style="font-weight: bold; text-decoration: underline;">@Retention</span>(<span style="font-weight: bold; text-decoration: underline;">RetentionPolicy</span>.<span style="font-weight: bold; text-decoration: underline;">SOURCE</span>)
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">@interface</span> <span style="font-weight: bold; text-decoration: underline;">ClassAuthor</span> {
    <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold;">value</span>() <span style="font-weight: bold;">default</span> <span style="font-style: italic;">"sunway"</span>;
}

<span style="font-weight: bold; text-decoration: underline;">@Target</span>(<span style="font-weight: bold; text-decoration: underline;">ElementType</span>.<span style="font-weight: bold; text-decoration: underline;">METHOD</span>)
<span style="font-weight: bold; text-decoration: underline;">@Retention</span>(<span style="font-weight: bold; text-decoration: underline;">RetentionPolicy</span>.<span style="font-weight: bold; text-decoration: underline;">RUNTIME</span>)
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">@interface</span> <span style="font-weight: bold; text-decoration: underline;">MethodAuthor</span> {
    <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold;">name</span>() <span style="font-weight: bold;">default</span> <span style="font-style: italic;">"sunway"</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">version</span>();
}

</pre>
</div>
</div>

<div id="outline-container-orgeb17a3b" class="outline-4">
<h4 id="orgeb17a3b"><span class="section-number-4">1.1.1</span> @Target</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
使用 @Target 定义该 annotation 可以用在哪里:
</p>

<ul class="org-ul">
<li>CONSTRUCTOR</li>
<li>FIELD</li>
<li>LOCAL_VARIABLE</li>
<li>METHOD</li>
<li>PACKAGE</li>
<li>PARAMETER</li>
<li>TYPE (包括 class, interface, enum)</li>
</ul>

<p>
例如:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@TypeAnnotation</span>
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MyAnnotatedClass</span> {
    <span style="font-weight: bold; text-decoration: underline;">@FieldAnnotation</span>
    <span style="font-weight: bold;">private</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">foo</span>;

    <span style="font-weight: bold; text-decoration: underline;">@ConstructorAnnotation</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">MyAnnotatedClass</span>() {
    }

    <span style="font-weight: bold; text-decoration: underline;">@MethodAnnotation</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold;">bar</span>(<span style="font-weight: bold; text-decoration: underline;">@ParameterAnnotation</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">str</span>) {
        <span style="font-weight: bold; text-decoration: underline;">@LocalVariableAnnotation</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">asdf</span> = <span style="font-style: italic;">"asdf"</span>;
        <span style="font-weight: bold;">return</span> asdf + str;
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org041dc01" class="outline-4">
<h4 id="org041dc01"><span class="section-number-4">1.1.2</span> @Retention</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
@Retention 定义该 annotation 信息如何保存
</p>

<ul class="org-ul">
<li><p>
RetentionPolicy.SOURCE
</p>

<p>
annotation 保存在源码中, 但不保留在 .class 中. 这种 annotation 通常是通过
annotation processor 来处理
</p></li>

<li><p>
RetentionPolicy.CLASS
</p>

<p>
annotation 保存在 .class 中, 但 jvm 运行时并不会加载它们. 直接分析 .class 文件
的编译时工具可以处理这类的 annotation, 例如 findbugs
</p></li>

<li><p>
RetentionPolicy.RUNTIME
</p>

<p>
annotation 保存在 .class 中, 且 jvm 运行时会加载它们, 所以可以在运行时通过
反射得到.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgb12d7fe" class="outline-4">
<h4 id="orgb12d7fe"><span class="section-number-4">1.1.3</span> @interface</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
使用 @interface 来定义 annotation 的内容, 与定义一个接口的语法类似, 且最终会编译
生成一个具体的 class, 其中 value() 是一个特殊的方法, 参考 
</p>
</div>
</div>
</div>

<div id="outline-container-org9619da0" class="outline-3">
<h3 id="org9619da0"><span class="section-number-3">1.2</span> 使用 annotation</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@ClassAuthor</span>(<span style="font-style: italic;">"sunway"</span>)
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Hello</span> {
    <span style="font-weight: bold; text-decoration: underline;">@MethodAuthor</span> (name = <span style="font-style: italic;">"sunway"</span>, version = 1)
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">foo</span>() {}
}
</pre>
</div>

<p>
若 annotation 定义了 value() 方法, 则可以使用 ClassAuthor 那种写法:
@annotation(value), 否则需要使用 MethodAuthor 那种写法:
@annotation(key1=value1,key1=value2)
</p>
</div>
</div>

<div id="outline-container-org99d56cb" class="outline-3">
<h3 id="org99d56cb"><span class="section-number-3">1.3</span> 运行时 annotation</h3>
<div class="outline-text-3" id="text-1-3">
<p>
对于 RetentionPolicy 为 RUNTIME 的 annotation, 可以在运行时通过反射来处理
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@Target</span>(<span style="font-weight: bold; text-decoration: underline;">ElementType</span>.<span style="font-weight: bold; text-decoration: underline;">TYPE</span>)
<span style="font-weight: bold; text-decoration: underline;">@Retention</span>(<span style="font-weight: bold; text-decoration: underline;">RetentionPolicy</span>.<span style="font-weight: bold; text-decoration: underline;">RUNTIME</span>)
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">@interface</span> <span style="font-weight: bold; text-decoration: underline;">RuntimeAuthor</span> {
    <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold;">name</span>() <span style="font-weight: bold;">default</span> <span style="font-style: italic;">"sunway"</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">age</span>() <span style="font-weight: bold;">default</span> 0;
}

<span style="font-weight: bold; text-decoration: underline;">@RuntimeAuthor</span> (name = <span style="font-style: italic;">"sunway"</span>, age = 16)
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HelloAnnotation3</span> {}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HelloAnnotation</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">argv</span>[]) {
        <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">Annotation</span> <span style="font-weight: bold; font-style: italic;">a</span> : HelloAnnotation3.<span style="font-weight: bold;">class</span>.getAnnotations()) {
            <span style="font-weight: bold;">if</span> (a <span style="font-weight: bold;">instanceof</span> RuntimeAuthor) {
                System.out.println(((<span style="font-weight: bold; text-decoration: underline;">RuntimeAuthor</span>)a).name());
                System.out.println(((<span style="font-weight: bold; text-decoration: underline;">RuntimeAuthor</span>)a).age());
            }
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeeb89f1" class="outline-3">
<h3 id="orgeeb89f1"><span class="section-number-3">1.4</span> 编译时 annotation</h3>
<div class="outline-text-3" id="text-1-4">
<p>
所有 annotation 都可以在编译时通过 annotation processor 处理, 包括
RetentionPolicy.{RUNTIME,CLASS}, 因为它们也保留在源码中
</p>
</div>

<div id="outline-container-org13b040c" class="outline-4">
<h4 id="org13b040c"><span class="section-number-4">1.4.1</span> 使用 annotation processor</h4>
<div class="outline-text-4" id="text-1-4-1">
<ol class="org-ol">
<li><p>
定义 processor
</p>

<ul class="org-ul">
<li>后续使用 processor时, process 可能会被调用多次.</li>

<li>通过 printMessage, 可以打印出 warning 或 error, 中断编译</li>

<li>可以编译时生成 java 源文件, 生成的文件会参与到后续的编译中</li>
</ul>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@SupportedSourceVersion</span>(<span style="font-weight: bold; text-decoration: underline;">SourceVersion</span>.<span style="font-weight: bold; text-decoration: underline;">RELEASE_8</span>)
<span style="font-weight: bold; text-decoration: underline;">@SupportedAnnotationTypes</span>({<span style="font-style: italic;">"Author"</span>})
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MyProcessor</span> <span style="font-weight: bold;">extends</span> <span style="font-weight: bold; text-decoration: underline;">AbstractProcessor</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Override</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">boolean</span> <span style="font-weight: bold;">process</span>(<span style="font-weight: bold; text-decoration: underline;">Set</span>&lt;? <span style="font-weight: bold;">extends</span> <span style="font-weight: bold; text-decoration: underline;">TypeElement</span>&gt; <span style="font-weight: bold; font-style: italic;">annotations</span>, <span style="font-weight: bold; text-decoration: underline;">RoundEnvironment</span> <span style="font-weight: bold; font-style: italic;">roundEnv</span>) {
        <span style="font-weight: bold;">if</span> (annotations.isEmpty()) {
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
        }
        System.out.println(<span style="font-style: italic;">"process"</span>);
        <span style="font-weight: bold; text-decoration: underline;">StringBuilder</span> <span style="font-weight: bold; font-style: italic;">builder</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">StringBuilder</span>()
                                .append(<span style="font-style: italic;">"import java.util.HashMap;"</span>)
                                .append(<span style="font-style: italic;">"public class GeneratedAuthors {\n"</span>)
                                .append(<span style="font-style: italic;">" private static HashMap&lt;String,String&gt; sAuthors=new HashMap(); "</span>)
                                .append(<span style="font-style: italic;">" public static String dump() {return sAuthors.toString();}"</span>)
                                .append(<span style="font-style: italic;">" static {"</span>);

        <span style="font-weight: bold; text-decoration: underline;">Map</span>&lt;<span style="font-weight: bold; text-decoration: underline;">String</span>, <span style="font-weight: bold; text-decoration: underline;">String</span>&gt; <span style="font-weight: bold; font-style: italic;">authors</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">HashMap</span>();
        <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">TypeElement</span> <span style="font-weight: bold; font-style: italic;">annotation</span> : annotations ) {
            <span style="font-weight: bold;">for</span> ( <span style="font-weight: bold; text-decoration: underline;">Element</span> <span style="font-weight: bold; font-style: italic;">element</span> : roundEnv.getElementsAnnotatedWith(annotation) ) {
                <span style="font-weight: bold; text-decoration: underline;">Author</span> <span style="font-weight: bold; font-style: italic;">author</span> = element.getAnnotation(Author.<span style="font-weight: bold;">class</span>);
                processingEnv.getMessager().printMessage(<span style="font-weight: bold; text-decoration: underline;">Diagnostic</span>.<span style="font-weight: bold; text-decoration: underline;">Kind</span>.NOTE, <span style="font-style: italic;">"found @Author at "</span> + element + <span style="font-style: italic;">" value: "</span> + author.value());

                <span style="font-weight: bold; text-decoration: underline;">RuntimeAuthor</span> <span style="font-weight: bold; font-style: italic;">runtimeAuthor</span> = element.getAnnotation(RuntimeAuthor.<span style="font-weight: bold;">class</span>);
                <span style="font-weight: bold;">if</span> (runtimeAuthor != <span style="font-weight: bold; text-decoration: underline;">null</span>) {
                    processingEnv.getMessager().printMessage(<span style="font-weight: bold; text-decoration: underline;">Diagnostic</span>.<span style="font-weight: bold; text-decoration: underline;">Kind</span>.NOTE, <span style="font-style: italic;">"found @RuntimeAuthor at "</span> + element + <span style="font-style: italic;">" value: "</span> + runtimeAuthor.name());
                }

                <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">process &#21487;&#20197;&#20013;&#26029;&#32534;&#35793;</span>
                <span style="font-weight: bold;">if</span> (!author.value().equals(<span style="font-style: italic;">"sunway"</span>)) {
                    processingEnv.getMessager().printMessage(<span style="font-weight: bold; text-decoration: underline;">Diagnostic</span>.<span style="font-weight: bold; text-decoration: underline;">Kind</span>.ERROR, <span style="font-style: italic;">"author must be sunway"</span>);
                }
                authors.put(element.toString(), author.value());
                builder.append(<span style="font-style: italic;">"sAuthors.put("</span>)
                        .append(<span style="font-style: italic;">"\""</span> + element.toString() + <span style="font-style: italic;">"\","</span> + <span style="font-style: italic;">"\""</span> + author.value() + <span style="font-style: italic;">"\""</span> + <span style="font-style: italic;">");"</span>);
            }
        }
        builder.append(<span style="font-style: italic;">"}}"</span>);
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">generate code</span>
        <span style="font-weight: bold;">try</span> {
            <span style="font-weight: bold; text-decoration: underline;">JavaFileObject</span> <span style="font-weight: bold; font-style: italic;">sourceFile</span> = processingEnv.getFiler().createSourceFile(
                <span style="font-style: italic;">"GeneratedAuthors"</span>);

            <span style="font-weight: bold; text-decoration: underline;">PrintWriter</span> <span style="font-weight: bold; font-style: italic;">out</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">PrintWriter</span>(sourceFile.openWriter());
            out.write(builder.toString());
            out.close();

        } <span style="font-weight: bold;">catch</span> (<span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold; font-style: italic;">e</span>) {
        }

        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
    }

}

</pre>
</div></li>

<li><p>
使用编译完的 processor
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-bash">javac -cp . -processor MyProcessor *.java
</pre>
</div></li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2019-07-11 Thu 00:00<br />
Last updated: 2021-09-16 Thu 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
