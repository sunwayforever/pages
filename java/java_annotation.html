<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 二 15:54 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Java Annotation</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Java Annotation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org803617c">1. Java Annotation</a>
<ul>
<li><a href="#org5e33bbc">1.1. 定义 annotation</a>
<ul>
<li><a href="#orgbde379c">1.1.1. @Target</a></li>
<li><a href="#org35b39ca">1.1.2. @Retention</a></li>
<li><a href="#orgcc2cd28">1.1.3. @interface</a></li>
</ul>
</li>
<li><a href="#orgb965365">1.2. 使用 annotation</a></li>
<li><a href="#org3b00326">1.3. 运行时 annotation</a></li>
<li><a href="#org982b366">1.4. 编译时 annotation</a>
<ul>
<li><a href="#org8640e00">1.4.1. 使用 annotation processor</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org803617c" class="outline-2">
<h2 id="org803617c"><span class="section-number-2">1</span> Java Annotation</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org5e33bbc" class="outline-3">
<h3 id="org5e33bbc"><span class="section-number-3">1.1</span> 定义 annotation</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2; font-weight: bold;">@Target</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">ElementType</span>.<span style="color: #b58900;">TYPE</span><span style="color: #757575;">)</span>
<span style="color: #268bd2; font-weight: bold;">@Retention</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">RetentionPolicy</span>.<span style="color: #b58900;">SOURCE</span><span style="color: #757575;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">@interface</span> <span style="color: #b58900;">ClassAuthor</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">value</span><span style="color: #757575;">()</span> <span style="color: #859900;">default</span> <span style="color: #2aa198;">"sunway"</span>;
<span style="color: #757575;">}</span>

<span style="color: #268bd2; font-weight: bold;">@Target</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">ElementType</span>.<span style="color: #b58900;">METHOD</span><span style="color: #757575;">)</span>
<span style="color: #268bd2; font-weight: bold;">@Retention</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">RetentionPolicy</span>.<span style="color: #b58900;">RUNTIME</span><span style="color: #757575;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">@interface</span> <span style="color: #b58900;">MethodAuthor</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span><span style="color: #757575;">()</span> <span style="color: #859900;">default</span> <span style="color: #2aa198;">"sunway"</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">version</span><span style="color: #757575;">()</span>;
<span style="color: #757575;">}</span>

</pre>
</div>
</div>

<div id="outline-container-orgbde379c" class="outline-4">
<h4 id="orgbde379c"><span class="section-number-4">1.1.1</span> @Target</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
使用 @Target 定义该 annotation 可以用在哪里:
</p>

<ul class="org-ul">
<li>CONSTRUCTOR</li>
<li>FIELD</li>
<li>LOCAL_VARIABLE</li>
<li>METHOD</li>
<li>PACKAGE</li>
<li>PARAMETER</li>
<li>TYPE (包括 class, interface, enum)</li>
</ul>

<p>
例如:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2; font-weight: bold;">@TypeAnnotation</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #b58900;">MyAnnotatedClass</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@FieldAnnotation</span>
    <span style="color: #859900;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">foo</span>;

    <span style="color: #268bd2; font-weight: bold;">@ConstructorAnnotation</span>
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">MyAnnotatedClass</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #757575;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@MethodAnnotation</span>
    <span style="color: #859900;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">bar</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">@ParameterAnnotation</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">str</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #268bd2; font-weight: bold;">@LocalVariableAnnotation</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">asdf</span> = <span style="color: #2aa198;">"asdf"</span>;
        <span style="color: #859900;">return</span> asdf + str;
    <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org35b39ca" class="outline-4">
<h4 id="org35b39ca"><span class="section-number-4">1.1.2</span> @Retention</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
@Retention 定义该 annotation 信息如何保存
</p>

<ul class="org-ul">
<li><p>
RetentionPolicy.SOURCE
</p>

<p>
annotation 保存在源码中, 但不保留在 .class 中. 这种 annotation 通常是通过
annotation processor 来处理
</p></li>

<li><p>
RetentionPolicy.CLASS
</p>

<p>
annotation 保存在 .class 中, 但 jvm 运行时并不会加载它们. 直接分析 .class 文件的编译时工具可以处理这类的 annotation, 例如 findbugs
</p></li>

<li><p>
RetentionPolicy.RUNTIME
</p>

<p>
annotation 保存在 .class 中, 且 jvm 运行时会加载它们, 所以可以在运行时通过反射得到.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgcc2cd28" class="outline-4">
<h4 id="orgcc2cd28"><span class="section-number-4">1.1.3</span> @interface</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
使用 @interface 来定义 annotation 的内容, 与定义一个接口的语法类似, 且最终会编译生成一个具体的 class, 其中 value() 是一个特殊的方法, 参考 
</p>
</div>
</div>
</div>

<div id="outline-container-orgb965365" class="outline-3">
<h3 id="orgb965365"><span class="section-number-3">1.2</span> 使用 annotation</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2; font-weight: bold;">@ClassAuthor</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"sunway"</span><span style="color: #757575;">)</span>
<span style="color: #859900;">class</span> <span style="color: #b58900;">Hello</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@MethodAuthor</span> <span style="color: #757575;">(</span>name = <span style="color: #2aa198;">"sunway"</span><span style="color: #757575;">,</span> version = 1<span style="color: #757575;">)</span>
    <span style="color: #859900;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">foo</span><span style="color: #757575;">()</span> <span style="color: #757575;">{}</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
若 annotation 定义了 value() 方法, 则可以使用 ClassAuthor 那种写法:
@annotation(value), 否则需要使用 MethodAuthor 那种写法:
@annotation(key1=value1,key1=value2)
</p>
</div>
</div>

<div id="outline-container-org3b00326" class="outline-3">
<h3 id="org3b00326"><span class="section-number-3">1.3</span> 运行时 annotation</h3>
<div class="outline-text-3" id="text-1-3">
<p>
对于 RetentionPolicy 为 RUNTIME 的 annotation, 可以在运行时通过反射来处理
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2; font-weight: bold;">@Target</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">ElementType</span>.<span style="color: #b58900;">TYPE</span><span style="color: #757575;">)</span>
<span style="color: #268bd2; font-weight: bold;">@Retention</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">RetentionPolicy</span>.<span style="color: #b58900;">RUNTIME</span><span style="color: #757575;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">@interface</span> <span style="color: #b58900;">RuntimeAuthor</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span><span style="color: #757575;">()</span> <span style="color: #859900;">default</span> <span style="color: #2aa198;">"sunway"</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">age</span><span style="color: #757575;">()</span> <span style="color: #859900;">default</span> 0;
<span style="color: #757575;">}</span>

<span style="color: #268bd2; font-weight: bold;">@RuntimeAuthor</span> <span style="color: #757575;">(</span>name = <span style="color: #2aa198;">"sunway"</span><span style="color: #757575;">,</span> age = 16<span style="color: #757575;">)</span>
<span style="color: #859900;">class</span> <span style="color: #b58900;">HelloAnnotation3</span> <span style="color: #757575;">{}</span>

<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #b58900;">HelloAnnotation</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">argv</span>[]<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">Annotation</span> <span style="color: #268bd2;">a</span> : HelloAnnotation3.<span style="color: #859900;">class</span>.getAnnotations<span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>a <span style="color: #859900;">instanceof</span> RuntimeAuthor<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
                System.out.println<span style="color: #757575;">(((</span><span style="color: #b58900;">RuntimeAuthor</span><span style="color: #757575;">)</span>a<span style="color: #757575;">)</span>.name<span style="color: #757575;">())</span>;
                System.out.println<span style="color: #757575;">(((</span><span style="color: #b58900;">RuntimeAuthor</span><span style="color: #757575;">)</span>a<span style="color: #757575;">)</span>.age<span style="color: #757575;">())</span>;
            <span style="color: #757575;">}</span>
        <span style="color: #757575;">}</span>
    <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org982b366" class="outline-3">
<h3 id="org982b366"><span class="section-number-3">1.4</span> 编译时 annotation</h3>
<div class="outline-text-3" id="text-1-4">
<p>
所有 annotation 都可以在编译时通过 annotation processor 处理, 包括
RetentionPolicy.{RUNTIME,CLASS}, 因为它们也保留在源码中
</p>
</div>

<div id="outline-container-org8640e00" class="outline-4">
<h4 id="org8640e00"><span class="section-number-4">1.4.1</span> 使用 annotation processor</h4>
<div class="outline-text-4" id="text-1-4-1">
<ol class="org-ol">
<li><p>
定义 processor
</p>

<ul class="org-ul">
<li>后续使用 processor时, process 可能会被调用多次.</li>

<li>通过 printMessage, 可以打印出 warning 或 error, 中断编译</li>

<li>可以编译时生成 java 源文件, 生成的文件会参与到后续的编译中</li>
</ul>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2; font-weight: bold;">@SupportedSourceVersion</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">SourceVersion</span>.<span style="color: #b58900;">RELEASE_8</span><span style="color: #757575;">)</span>
<span style="color: #268bd2; font-weight: bold;">@SupportedAnnotationTypes</span><span style="color: #757575;">({</span><span style="color: #2aa198;">"Author"</span><span style="color: #757575;">})</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #b58900;">MyProcessor</span> <span style="color: #859900;">extends</span> <span style="color: #b58900;">AbstractProcessor</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">process</span><span style="color: #757575;">(</span><span style="color: #b58900;">Set</span>&lt;? <span style="color: #859900;">extends</span> <span style="color: #b58900;">TypeElement</span>&gt; <span style="color: #268bd2;">annotations</span><span style="color: #757575;">,</span> <span style="color: #b58900;">RoundEnvironment</span> <span style="color: #268bd2;">roundEnv</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>annotations.isEmpty<span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
            <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #757575;">}</span>
        System.out.println<span style="color: #757575;">(</span><span style="color: #2aa198;">"process"</span><span style="color: #757575;">)</span>;
        <span style="color: #b58900;">StringBuilder</span> <span style="color: #268bd2;">builder</span> = <span style="color: #859900;">new</span> <span style="color: #b58900;">StringBuilder</span><span style="color: #757575;">()</span>
                                .append<span style="color: #757575;">(</span><span style="color: #2aa198;">"import java.util.HashMap;"</span><span style="color: #757575;">)</span>
                                .append<span style="color: #757575;">(</span><span style="color: #2aa198;">"public class GeneratedAuthors {\n"</span><span style="color: #757575;">)</span>
                                .append<span style="color: #757575;">(</span><span style="color: #2aa198;">" private static HashMap&lt;String,String&gt; sAuthors=new HashMap(); "</span><span style="color: #757575;">)</span>
                                .append<span style="color: #757575;">(</span><span style="color: #2aa198;">" public static String dump() {return sAuthors.toString();}"</span><span style="color: #757575;">)</span>
                                .append<span style="color: #757575;">(</span><span style="color: #2aa198;">" static {"</span><span style="color: #757575;">)</span>;

        <span style="color: #b58900;">Map</span>&lt;<span style="color: #b58900;">String</span><span style="color: #757575;">,</span> <span style="color: #b58900;">String</span>&gt; <span style="color: #268bd2;">authors</span> = <span style="color: #859900;">new</span> <span style="color: #b58900;">HashMap</span><span style="color: #757575;">()</span>;
        <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">TypeElement</span> <span style="color: #268bd2;">annotation</span> : annotations <span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
            <span style="color: #859900;">for</span> <span style="color: #757575;">(</span> <span style="color: #b58900;">Element</span> <span style="color: #268bd2;">element</span> : roundEnv.getElementsAnnotatedWith<span style="color: #757575;">(</span>annotation<span style="color: #757575;">)</span> <span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
                <span style="color: #b58900;">Author</span> <span style="color: #268bd2;">author</span> = element.getAnnotation<span style="color: #757575;">(</span>Author.<span style="color: #859900;">class</span><span style="color: #757575;">)</span>;
                processingEnv.getMessager<span style="color: #757575;">()</span>.printMessage<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">Diagnostic</span>.<span style="color: #268bd2; font-weight: bold;">Kind</span>.NOTE<span style="color: #757575;">,</span> <span style="color: #2aa198;">"found @Author at "</span> + element + <span style="color: #2aa198;">" value: "</span> + author.value<span style="color: #757575;">())</span>;

                <span style="color: #b58900;">RuntimeAuthor</span> <span style="color: #268bd2;">runtimeAuthor</span> = element.getAnnotation<span style="color: #757575;">(</span>RuntimeAuthor.<span style="color: #859900;">class</span><span style="color: #757575;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>runtimeAuthor != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
                    processingEnv.getMessager<span style="color: #757575;">()</span>.printMessage<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">Diagnostic</span>.<span style="color: #268bd2; font-weight: bold;">Kind</span>.NOTE<span style="color: #757575;">,</span> <span style="color: #2aa198;">"found @RuntimeAuthor at "</span> + element + <span style="color: #2aa198;">" value: "</span> + runtimeAuthor.name<span style="color: #757575;">())</span>;
                <span style="color: #757575;">}</span>

                <span style="color: #586e75;">// </span><span style="color: #586e75;">process &#21487;&#20197;&#20013;&#26029;&#32534;&#35793;</span>
                <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>author.value<span style="color: #757575;">()</span>.equals<span style="color: #757575;">(</span><span style="color: #2aa198;">"sunway"</span><span style="color: #757575;">))</span> <span style="color: #757575;">{</span>
                    processingEnv.getMessager<span style="color: #757575;">()</span>.printMessage<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">Diagnostic</span>.<span style="color: #268bd2; font-weight: bold;">Kind</span>.ERROR<span style="color: #757575;">,</span> <span style="color: #2aa198;">"author must be sunway"</span><span style="color: #757575;">)</span>;
                <span style="color: #757575;">}</span>
                authors.put<span style="color: #757575;">(</span>element.toString<span style="color: #757575;">(),</span> author.value<span style="color: #757575;">())</span>;
                builder.append<span style="color: #757575;">(</span><span style="color: #2aa198;">"sAuthors.put("</span><span style="color: #757575;">)</span>
                        .append<span style="color: #757575;">(</span><span style="color: #2aa198;">"\""</span> + element.toString<span style="color: #757575;">()</span> + <span style="color: #2aa198;">"\","</span> + <span style="color: #2aa198;">"\""</span> + author.value<span style="color: #757575;">()</span> + <span style="color: #2aa198;">"\""</span> + <span style="color: #2aa198;">");"</span><span style="color: #757575;">)</span>;
            <span style="color: #757575;">}</span>
        <span style="color: #757575;">}</span>
        builder.append<span style="color: #757575;">(</span><span style="color: #2aa198;">"}}"</span><span style="color: #757575;">)</span>;
        <span style="color: #586e75;">// </span><span style="color: #586e75;">generate code</span>
        <span style="color: #859900;">try</span> <span style="color: #757575;">{</span>
            <span style="color: #b58900;">JavaFileObject</span> <span style="color: #268bd2;">sourceFile</span> = processingEnv.getFiler<span style="color: #757575;">()</span>.createSourceFile<span style="color: #757575;">(</span>
                <span style="color: #2aa198;">"GeneratedAuthors"</span><span style="color: #757575;">)</span>;

            <span style="color: #b58900;">PrintWriter</span> <span style="color: #268bd2;">out</span> = <span style="color: #859900;">new</span> <span style="color: #b58900;">PrintWriter</span><span style="color: #757575;">(</span>sourceFile.openWriter<span style="color: #757575;">())</span>;
            out.write<span style="color: #757575;">(</span>builder.toString<span style="color: #757575;">())</span>;
            out.close<span style="color: #757575;">()</span>;

        <span style="color: #757575;">}</span> <span style="color: #859900;">catch</span> <span style="color: #757575;">(</span><span style="color: #b58900;">Exception</span> <span style="color: #268bd2;">e</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #757575;">}</span>

        <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
    <span style="color: #757575;">}</span>

<span style="color: #757575;">}</span>

</pre>
</div></li>

<li><p>
使用编译完的 processor
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-bash">javac -cp . -processor MyProcessor *.java
</pre>
</div></li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2019-07-11 四 00:00<br />
Last updated: 2021-09-16 四 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
