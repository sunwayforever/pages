<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 01:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Backtrace</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Backtrace</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7c49152">1. backtrace/libcorkscrew 原理</a>
<ul>
<li><a href="#orgabf7f5f">1.1. unwind_backtrace</a>
<ul>
<li><a href="#org36c59e4">1.1.1. 基于 frame pointer</a></li>
<li><a href="#orgb8c98b8">1.1.2. 基于 dwarf</a></li>
<li><a href="#org6f34232">1.1.3. 基于代码分析</a></li>
</ul>
</li>
<li><a href="#orgcd10c02">1.2. find_symbol</a></li>
<li><a href="#org3bb10db">1.3. misc</a>
<ul>
<li><a href="#org43e5f95">1.3.1. 使用了 omit-frame-pointer 同时又调用了 alloca 的代码如何 unwindle</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org7c49152" class="outline-2">
<h2 id="org7c49152"><span class="section-number-2">1</span> backtrace/libcorkscrew 原理</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgabf7f5f" class="outline-3">
<h3 id="orgabf7f5f"><span class="section-number-3">1.1</span> unwind_backtrace</h3>
<div class="outline-text-3" id="text-1-1">
<p>
stack unwindling 的目的是为了得到保存在每个 stack frame 里的 ra (return addr),
然后在 elf 的符号表中可以 ra 对应的符号
</p>
</div>

<div id="outline-container-org36c59e4" class="outline-4">
<h4 id="org36c59e4"><span class="section-number-4">1.1.1</span> 基于 frame pointer</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
当编译器没有使用 omit-frame-pointer 时, 函数调用时大约会这样:
</p>

<div class="org-src-container">
<pre class="src src-mips">sw      $fp, 0($sp)         # 保存 fp
move    $fp, $sp            # fp 指向当前 stack base
sub     $sp, 12             # 分配 stack frame
sw      $ra, -4($fp)        # 保存 ra, 也可以用 sw $ra, 4($sp)
sw      $s1, -8($fp)        # 保存 callee saved reg, 也可以用 sw $ra, 0($sp)
</pre>
</div>

<p>
所以 stack unwindling 时:
</p>

<ol class="org-ol">
<li>通过 fp 可以得到当前 stack base</li>
<li>*(fp) 即上一个 stack frame 的 fp</li>
<li>*(fp-4) 即 ra</li>
</ol>
</div>
</div>


<div id="outline-container-orgb8c98b8" class="outline-4">
<h4 id="orgb8c98b8"><span class="section-number-4">1.1.2</span> 基于 dwarf</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
<a href="linux/dwarf.html#org426ba5e">debug_frame 与 frame unwinding</a>
</p>
</div>
</div>

<div id="outline-container-org6f34232" class="outline-4">
<h4 id="org6f34232"><span class="section-number-4">1.1.3</span> 基于代码分析</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
当 elf 既没有使用 frame pointer, 又没有提供 eh_debug 时, 如何进行 stack
unwindling?
</p>

<p>
libcorkscrew 的方法大概是:
</p>

<ol class="org-ol">
<li>通过 signal 或 ptrace 获得当前 frame 的 pc, sp</li>

<li>ra &lt;- pc</li>

<li>从 ra 开始, 向后依次读取每条指令, 当读到 `add sp, imm` 时, 认为 imm 即是 stack
size, 把 sp+imm 做为当前 frame 的基址 BP</li>

<li>继续向后扫描到 `sw ra, imm(sp)`, 确定 ra 的 offset 为 imm, 则 BP+imm 的值即是
ra</li>

<li>重复 3, 处理下一个 frame</li>
</ol>


<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">ssize_t</span> <span style="font-weight: bold;">unwind_backtrace_common</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">memory_t</span>* <span style="font-weight: bold; font-style: italic;">memory</span>,
                                       <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">map_info_t</span>* <span style="font-weight: bold; font-style: italic;">map_info_list</span>,
                                       <span style="font-weight: bold; text-decoration: underline;">unwind_state_t</span>* <span style="font-weight: bold; font-style: italic;">state</span>,
                                       <span style="font-weight: bold; text-decoration: underline;">backtrace_frame_t</span>* <span style="font-weight: bold; font-style: italic;">backtrace</span>,
                                       <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">ignore_depth</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">max_depth</span>) {
    <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">ignored_frames</span> = 0;
    <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">returned_frames</span> = 0;

    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">index</span> = 0; returned_frames &lt; max_depth; index++) {
        <span style="font-weight: bold; text-decoration: underline;">uintptr_t</span> <span style="font-weight: bold; font-style: italic;">pc</span> = state-&gt;pc;

        frame = add_backtrace_entry(pc, backtrace, ignore_depth, max_depth,
                                    &amp;ignored_frames, &amp;returned_frames);

        <span style="font-weight: bold;">for</span> (addr = state-&gt;pc; maxcheck-- &gt; 0 &amp;&amp; !found_start; addr -= 4) {
            <span style="font-weight: bold; text-decoration: underline;">uint32_t</span> <span style="font-weight: bold; font-style: italic;">op</span>;
            <span style="font-weight: bold;">if</span> (!try_get_word(memory, addr, &amp;op)) <span style="font-weight: bold;">break</span>;

            <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">gcc &#32534;&#35793;&#22120;&#20250;&#29983;&#25104;&#19979;&#38754;&#30340;&#20195;&#30721;:</span>
<span style="font-weight: bold; font-style: italic;">             * sw ra, imm(sp)</span>
<span style="font-weight: bold; font-style: italic;">             * addiu sp, imm</span>
<span style="font-weight: bold; font-style: italic;">             * &#21363;&#21453;&#21521;&#26597;&#25214;&#25351;&#20196;&#26102;, &#20250;&#20808;&#25214;&#21040; 0x27bd0000, &#20877;&#25214;&#21040; 0xafbf0000</span>
<span style="font-weight: bold; font-style: italic;">             *</span><span style="font-weight: bold; font-style: italic;"> */</span>
            <span style="font-weight: bold;">switch</span> (op &amp; 0xffff0000) {
                <span style="font-weight: bold;">case</span> 0x27bd0000:  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">addiu sp, imm</span>
                {
                    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">looking for stack being decremented</span>
                    <span style="font-weight: bold; text-decoration: underline;">int32_t</span> <span style="font-weight: bold; font-style: italic;">immediate</span> = ((((<span style="font-weight: bold; text-decoration: underline;">int</span>)op) &lt;&lt; 16) &gt;&gt; 16);
                    <span style="font-weight: bold;">if</span> (immediate &lt; 0) {
                        stack_size = -immediate;
                        found_start = <span style="font-weight: bold; text-decoration: underline;">true</span>;
                        ALOGV(<span style="font-style: italic;">"@0x%08x: found stack adjustment=%d\n"</span>, addr,
                              stack_size);
                    }
                } <span style="font-weight: bold;">break</span>;
                <span style="font-weight: bold;">case</span> 0xafbf0000:  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">sw ra, imm(sp)</span>
                    ra_offset = ((((<span style="font-weight: bold; text-decoration: underline;">int</span>)op) &lt;&lt; 16) &gt;&gt; 16);
                    ALOGV(<span style="font-style: italic;">"@0x%08x: found ra offset=%d\n"</span>, addr, ra_offset);
                    <span style="font-weight: bold;">break</span>;
                <span style="font-weight: bold;">default</span>:
                    <span style="font-weight: bold;">break</span>;
            }
        }

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">NOTE: &#21521;&#21518;&#25195;&#25551;&#25351;&#20196;&#26102;&#20250;&#20462;&#27491; state-&gt;sp, &#28982;&#21518;&#20877;&#35835;&#21462; ra_offset &#22788;&#30340;&#20540;</span><span style="font-weight: bold; font-style: italic;"> */</span>
        <span style="font-weight: bold;">if</span> (ra_offset) {
            <span style="font-weight: bold; text-decoration: underline;">uint32_t</span> <span style="font-weight: bold; font-style: italic;">next_ra</span>;
            <span style="font-weight: bold;">if</span> (!try_get_word(memory, state-&gt;sp + ra_offset, &amp;next_ra)) <span style="font-weight: bold;">break</span>;
            state-&gt;ra = next_ra;
        }

        <span style="font-weight: bold;">if</span> (stack_size) {
            <span style="font-weight: bold;">if</span> (frame) frame-&gt;stack_size = stack_size;
            state-&gt;sp += stack_size;
        }

        state-&gt;pc = state-&gt;ra;
    }

    <span style="font-weight: bold;">return</span> returned_frames;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd10c02" class="outline-3">
<h3 id="orgcd10c02"><span class="section-number-3">1.2</span> find_symbol</h3>
<div class="outline-text-3" id="text-1-2">
<p>
stack unwindling 确定了每个 frame 对应的 pc, 通过查找 elf 符号表 (symtab,
dynsym) 来确定每个 frame 对应哪个函数.
</p>

<p>
这一步只需要符号表, 并不需要 debug 信息, 所以无法确定具体的行号.
</p>

<p>
例如:
</p>

<pre class="example" id="org11790a6">
62: 0000000000001160    22 FUNC    GLOBAL DEFAULT   16 main
</pre>

<p>
0x1160 main 在 elf 中的 <b>相对</b> 地址, 22 是 main 的 大小
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">find_symbol_ptrace</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ptrace_context_t</span>* <span style="font-weight: bold; font-style: italic;">context</span>, <span style="font-weight: bold; text-decoration: underline;">uintptr_t</span> <span style="font-weight: bold; font-style: italic;">addr</span>,
                        <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">map_info_t</span>** <span style="font-weight: bold; font-style: italic;">out_map_info</span>,
                        <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">symbol_t</span>** <span style="font-weight: bold; font-style: italic;">out_symbol</span>) {
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">map_info_t</span>* <span style="font-weight: bold; font-style: italic;">mi</span> = find_map_info(context-&gt;map_info_list, addr);

    symbol = find_symbol(data-&gt;symbol_table, addr - mi-&gt;start);
}
</pre>
</div>

<ol class="org-ol">
<li>libcorkscrew 拿到的 addr 是进程中的绝对地址</li>
<li>通过读取 /proc/pid/maps 获得 maps, 根据 addr 获得它位哪个 map</li>
<li>通过 addr - mi-&gt;start 获得相对地址</li>
<li>用这个相对地址在 elf 符号表中查找它对应的符号</li>
</ol>
</div>
</div>


<div id="outline-container-org3bb10db" class="outline-3">
<h3 id="org3bb10db"><span class="section-number-3">1.3</span> misc</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org43e5f95" class="outline-4">
<h4 id="org43e5f95"><span class="section-number-4">1.3.1</span> 使用了 omit-frame-pointer 同时又调用了 alloca 的代码如何 unwindle</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
使用了 alloca 的代码会忽略 omit-frame-pointer&#x2026;
</p>

<pre class="example" id="orga686fd9">
$&gt; cat test.c
void foo() {
  alloca(0xff);
} 
$&gt; gcc test.c -c -fomit-frame-pointer -O0
$&gt; objdump -d test.o
00000000 &lt;foo&gt;:
0:   27bdffe8        addiu   sp,sp,-24
4:   afbe0014        sw      s8,20(sp)
8:   03a0f025        move    s8,sp           ;; s8 即 fp
c:   27bdff40        addiu   sp,sp,-256      ;; alloca
10:   00000000        nop
14:   03c0e825        move    sp,s8
18:   8fbe0014        lw      s8,20(sp)
1c:   27bd0018        addiu   sp,sp,24
20:   03e00008        jr      ra
24:   00000000        nop

$&gt; cat test.c
void foo() {}
$&gt; gcc test.c -c -O0
$&gt; objdump -d test.o

00000000 &lt;foo&gt;:
0:   27bdfff8        addiu   sp,sp,-8
4:   afbe0004        sw      s8,4(sp)
8:   03a0f025        move    s8,sp
c:   00000000        nop
10:   03c0e825        move    sp,s8
14:   8fbe0004        lw      s8,4(sp)
18:   27bd0008        addiu   sp,sp,8
1c:   03e00008        jr      ra
20:   00000000        nop

$&gt; gcc test.c -c -O0 -fomit-frame-pointer
$&gt; objdump -d test.o

00000000 &lt;foo&gt;:
0:   00000000        nop
4:   03e00008        jr      ra
8:   00000000        nop
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2020-11-26 Thu 00:00<br />
Last updated: 2022-01-24 Mon 21:41</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
