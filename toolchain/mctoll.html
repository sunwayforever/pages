<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>mctoll</title>


<link rel="stylesheet" type="text/css" href="/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="./htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="./readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
</head>
<body>
<div id="content" class="content">
<h1 class="title">mctoll</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org000000f">1. mctoll</a>
<ul>
<li><a href="#org0000001">1.1. 测试</a></li>
<li><a href="#org0000006">1.2. 总结</a></li>
<li><a href="#org0000009">1.3. 为什么使用 llvm ir</a></li>
<li><a href="#org000000c">1.4. 其它 asm lifting 工具</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000000f" class="outline-2">
<h2 id="org000000f"><span class="section-number-2">1.</span> mctoll</h2>
<div class="outline-text-2" id="text-1">
<p>
`This tool statically (AOT) translates (or raises) binaries to LLVM IR.`
</p>

<p>
<a href="https://github.com/Microsoft/llvm-mctoll">https://github.com/Microsoft/llvm-mctoll</a>
</p>

<p>
<a href="https://dse.in.tum.de/wp-content/uploads/2022/01/translating_x86_binaries_into_llvm_intermediate_representation.pdf">translating_x86_binaries_into_llvm_intermediate_representation</a>
</p>
</div>

<div id="outline-container-org0000001" class="outline-3">
<h3 id="org0000001"><span class="section-number-3">1.1.</span> 测试</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<a href="https://github.com/sunwayforever/llvm-toy/tree/mctoll">https://github.com/sunwayforever/llvm-toy/tree/mctoll</a>
</p>

<pre class="example" id="org0000000">
$&gt; cd &lt;path-to-llvm&gt;/mctoll
$&gt; ./mctoll_build.sh
$&gt; make
</pre>

<p>
原始的 c 代码:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span><span class="org-parenthesis">,</span> <span class="org-type">char</span> **<span class="org-variable-name">argv</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
  <span class="org-type">int</span> <span class="org-variable-name">a</span> = argc;
  <span class="org-type">int</span> <span class="org-variable-name">b</span> = argc + 1;
  <span class="org-keyword">return</span> b;
<span class="org-parenthesis">}</span>
</pre>
</div>

<p>
原始的汇编:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter"># </span><span class="org-comment">at&amp;t &#35821;&#27861;, `op src, dst`</span>
<span class="org-function-name">main</span>:
 <span class="org-keyword">1</span>     pushq   <span class="org-variable-name">%rbp</span>
 <span class="org-keyword">2</span>     movq    <span class="org-variable-name">%rsp</span><span class="org-parenthesis">,</span> <span class="org-variable-name">%rbp</span>
 <span class="org-keyword">3</span>     movl    $0<span class="org-parenthesis">,</span> -4<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
 <span class="org-keyword">4</span>     movl    <span class="org-variable-name">%edi</span><span class="org-parenthesis">,</span> -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
 <span class="org-keyword">5</span>     movq    <span class="org-variable-name">%rsi</span><span class="org-parenthesis">,</span> -16<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
 <span class="org-keyword">6</span>     movl    -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
 <span class="org-keyword">7</span>     movl    <span class="org-variable-name">%eax</span><span class="org-parenthesis">,</span> -20<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
 <span class="org-keyword">8</span>     movl    -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
 <span class="org-keyword">9</span>     addl    $1<span class="org-parenthesis">,</span> <span class="org-variable-name">%eax</span>
<span class="org-function-name">10</span>     <span class="org-keyword">movl</span>    <span class="org-variable-name">%eax</span><span class="org-parenthesis">,</span> -24<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
<span class="org-function-name">11</span>     <span class="org-keyword">movl</span>    -24<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
<span class="org-function-name">12</span>     <span class="org-keyword">popq</span>    <span class="org-variable-name">%rbp</span>
<span class="org-function-name">13</span>     <span class="org-keyword">retq</span>
</pre>
</div>

<p>
用汇编生成 binary 后通过 mctoll 转换回来的 llvm ir:
</p>

<div class="org-src-container">
<pre class="src src-llvm"><span class="org-keyword">define</span> <span class="org-keyword">dso_local</span> <span class="org-type">i32</span> @main<span class="org-parenthesis">(</span><span class="org-type">i32</span> <span class="org-variable-name">%arg1</span><span class="org-parenthesis">,</span> <span class="org-type">i64</span> <span class="org-variable-name">%arg2</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
<span class="org-variable-name">entry:</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">%rbp &#35782;&#21035;&#20026; stktop_4 (stack top), &#21518;&#32493;&#38024;&#23545; stack &#30340;&#20351;&#29992; (-4(%rbp), -8(%rbp)...)</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#37117;&#20351;&#29992; stktop_4 &#36825;&#20010; llvm &#23616;&#37096;&#21464;&#37327;&#26469;&#34920;&#31034;</span>
  <span class="org-variable-name">%stktop_4</span> = <span class="org-keyword">alloca</span> <span class="org-type">i8</span><span class="org-parenthesis">,</span> <span class="org-type">i32</span> <span class="org-preprocessor">32</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">RBP_N.20/16/8/4 &#23545;&#24212; {-20, -16, -8, -4}(%rbp), &#20854;&#20013; _N &#34920;&#31034; negative?</span>
  <span class="org-variable-name">%tos</span> = <span class="org-keyword">ptrtoint</span> <span class="org-type">ptr</span> <span class="org-variable-name">%stktop_4</span> <span class="org-keyword">to</span> <span class="org-type">i64</span>
  <span class="org-variable-name">%0</span> = <span class="org-keyword">add</span> <span class="org-type">i64</span> <span class="org-variable-name">%tos</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">12</span>
  <span class="org-variable-name">%RBP_N.20</span> = <span class="org-keyword">inttoptr</span> <span class="org-type">i64</span> <span class="org-variable-name">%0</span> <span class="org-keyword">to</span> <span class="org-type">ptr</span>
  <span class="org-variable-name">%1</span> = <span class="org-keyword">add</span> <span class="org-type">i64</span> <span class="org-variable-name">%tos</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">16</span>
  <span class="org-variable-name">%RBP_N.16</span> = <span class="org-keyword">inttoptr</span> <span class="org-type">i64</span> <span class="org-variable-name">%1</span> <span class="org-keyword">to</span> <span class="org-type">ptr</span>
  <span class="org-variable-name">%2</span> = <span class="org-keyword">add</span> <span class="org-type">i64</span> <span class="org-variable-name">%tos</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">24</span>
  <span class="org-variable-name">%RBP_N.8</span> = <span class="org-keyword">inttoptr</span> <span class="org-type">i64</span> <span class="org-variable-name">%2</span> <span class="org-keyword">to</span> <span class="org-type">ptr</span>
  <span class="org-variable-name">%3</span> = <span class="org-keyword">add</span> <span class="org-type">i64</span> <span class="org-variable-name">%tos</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">28</span>
  <span class="org-variable-name">%RBP_N.4</span> = <span class="org-keyword">inttoptr</span> <span class="org-type">i64</span> <span class="org-variable-name">%3</span> <span class="org-keyword">to</span> <span class="org-type">ptr</span>
  <span class="org-variable-name">%4</span> = <span class="org-keyword">add</span> <span class="org-type">i64</span> <span class="org-variable-name">%tos</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">0</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">RSP_P.0 &#23545;&#24212; $rsp, _P &#34920;&#31034; positive?</span>
  <span class="org-variable-name">%RSP_P.0</span> = <span class="org-keyword">inttoptr</span> <span class="org-type">i64</span> <span class="org-variable-name">%4</span> <span class="org-keyword">to</span> <span class="org-type">ptr</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#20889;&#20102;&#19968;&#20010; `DEADBEEF` &#21040; 0(RSP), &#34920;&#31034;&#26410;&#21021;&#22987;&#21270;</span>
  <span class="org-keyword">store</span> <span class="org-type">i64</span> <span class="org-preprocessor">3735928559</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RSP_P.0</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">8</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">1 pushq   %rbp &#26159; prologue &#29983;&#25104;&#30340;, &#19981;&#38656;&#35201;&#32763;&#35793;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">2 movq    %rsp, %rbp</span>
  <span class="org-variable-name">%RBP</span> = <span class="org-keyword">ptrtoint</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RSP_P.0</span> <span class="org-keyword">to</span> <span class="org-type">i64</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">3 movl    $0, -4(%rbp)</span>
  <span class="org-keyword">store</span> <span class="org-type">i32</span> <span class="org-preprocessor">0</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.4</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">mctoll &#30693;&#36947; x86 system-v abi &#37324; edi &#20195;&#34920; arg1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">4 movl    %edi, -8(%rbp)</span>
  <span class="org-keyword">store</span> <span class="org-type">i32</span> <span class="org-variable-name">%arg1</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.8</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">mctoll &#30693;&#36947; rsi &#20195;&#34920; arg2</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">5 movq    %rsi, -16(%rbp)</span>
  <span class="org-keyword">store</span> <span class="org-type">i64</span> <span class="org-variable-name">%arg2</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.16</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">6 movl    -8(%rbp), %eax</span>
  <span class="org-variable-name">%memload</span> = <span class="org-keyword">load</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.8</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">7 movl    %eax, -20(%rbp)</span>
  <span class="org-keyword">store</span> <span class="org-type">i32</span> <span class="org-variable-name">%memload</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.20</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">8 movl    -8(%rbp), %eax</span>
  <span class="org-variable-name">%memload1</span> = <span class="org-keyword">load</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%RBP_N.8</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>

  <span class="org-comment-delimiter">; </span><span class="org-comment">eax &#23545;&#24212; %EAX &#36825;&#20010; llvm &#23616;&#37096;&#21464;&#37327;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">9 addl    $1, %eax</span>
  <span class="org-variable-name">%EAX</span> = <span class="org-keyword">add</span> <span class="org-type">i32</span> <span class="org-variable-name">%memload1</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">x86 &#30340; addl &#25351;&#20196;&#20250;&#35774;&#32622; cf, pf, zf, of, sf &#36825;&#20960;&#20010; flag &#23492;&#23384;&#22120;:</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">https://en.wikipedia.org/wiki/FLAGS_register</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">cf: carry, &#34920;&#31034;&#26080;&#31526;&#21495;&#21152;&#27861;&#26159;&#21542;&#26377;&#36827;&#20301;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">of: overflow, &#34920;&#31034;&#26377;&#31526;&#21495;&#21152;&#27861;&#26159;&#21542;&#26377;&#28322;&#20986;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">zf: zero, &#34920;&#31034;&#32467;&#26524;&#26159;&#21542;&#20026; 0</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">sf: sign, &#34920;&#31034;&#27491;&#36127;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">pf: parity, &#34920;&#31034;&#32467;&#26524;&#20302; 8 &#20301;&#20013; 1 &#30340;&#20010;&#25968;&#26159;&#22855;&#25968;&#36824;&#26159;&#20598;&#25968;</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#36825;&#37324;&#36890;&#36807; llvm.{s,u}add.with.overflow.i32 intrinsic &#37325;&#26032;&#35745;&#31639;&#20102; `addl $1, %eax`,</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#24182;&#26681;&#25454;&#32467;&#26524;&#35774;&#32622;&#21508;&#20010; flag</span>
  <span class="org-variable-name">%5</span> = <span class="org-keyword">call</span> <span class="org-parenthesis">{</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">i1</span> <span class="org-parenthesis">}</span> @llvm.uadd.with.overflow.i32<span class="org-parenthesis">(</span><span class="org-type">i32</span> <span class="org-variable-name">%memload1</span><span class="org-parenthesis">,</span> <span class="org-type">i32</span> <span class="org-preprocessor">1</span><span class="org-parenthesis">)</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#36890;&#36807;&#36820;&#22238;&#30340; i1 &#31867;&#22411;&#30340;&#20540;&#21028;&#26029;&#26159;&#21542;&#26377; cf</span>
  <span class="org-variable-name">%CF</span> = <span class="org-keyword">extractvalue</span> <span class="org-parenthesis">{</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">i1</span> <span class="org-parenthesis">}</span> <span class="org-variable-name">%5</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">1</span>
  <span class="org-variable-name">%6</span> = <span class="org-keyword">and</span> <span class="org-type">i32</span> <span class="org-variable-name">%EAX</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">255</span>
  <span class="org-variable-name">%7</span> = <span class="org-keyword">call</span> <span class="org-type">i32</span> @llvm.ctpop.i32<span class="org-parenthesis">(</span><span class="org-type">i32</span> <span class="org-variable-name">%6</span><span class="org-parenthesis">)</span>
  <span class="org-variable-name">%8</span> = <span class="org-keyword">and</span> <span class="org-type">i32</span> <span class="org-variable-name">%7</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#26681;&#25454; eax &#20302; 8 &#20301; 1 &#30340;&#20010;&#25968; (llvm.ctpop.i32) &#35774;&#32622; pf</span>
  <span class="org-variable-name">%PF</span> = <span class="org-keyword">icmp</span> eq <span class="org-type">i32</span> <span class="org-variable-name">%8</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">0</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">&#36890;&#36807; %eax &#30340;&#20540;&#26159;&#21542;&#20026;&#38646;&#35774;&#32622; zf</span>
  <span class="org-variable-name">%ZF</span> = <span class="org-keyword">icmp</span> eq <span class="org-type">i32</span> <span class="org-variable-name">%EAX</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">0</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">-2147483648 &#20026; 0x80000000, &#26681;&#25454;&#31526;&#21495;&#20301;&#35774;&#32622; sf</span>
  <span class="org-variable-name">%highbit</span> = <span class="org-keyword">and</span> <span class="org-type">i32</span> -<span class="org-preprocessor">2147483648</span><span class="org-parenthesis">,</span> <span class="org-variable-name">%EAX</span>
  <span class="org-variable-name">%SF</span> = <span class="org-keyword">icmp</span> ne <span class="org-type">i32</span> <span class="org-variable-name">%highbit</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">0</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">OF &#34920;&#31034;&#26377;&#31526;&#21495;&#21152;&#27861;&#28322;&#20986;, &#25152;&#20197;&#36890;&#36807; llvm.sadd.with.overflow.i32 &#21448;&#35745;&#31639;&#20102;&#19968;&#27425;&#21152;&#27861;...</span>
  <span class="org-variable-name">%9</span> = <span class="org-keyword">call</span> <span class="org-parenthesis">{</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">i1</span> <span class="org-parenthesis">}</span> @llvm.sadd.with.overflow.i32<span class="org-parenthesis">(</span><span class="org-type">i32</span> <span class="org-variable-name">%memload1</span><span class="org-parenthesis">,</span> <span class="org-type">i32</span> <span class="org-preprocessor">1</span><span class="org-parenthesis">)</span>
  <span class="org-variable-name">%OF</span> = <span class="org-keyword">extractvalue</span> <span class="org-parenthesis">{</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">i1</span> <span class="org-parenthesis">}</span> <span class="org-variable-name">%9</span><span class="org-parenthesis">,</span> <span class="org-preprocessor">1</span>

  <span class="org-comment-delimiter">; </span><span class="org-comment">10 movl    %eax, -24(%rbp)</span>
  <span class="org-keyword">store</span> <span class="org-type">i32</span> <span class="org-variable-name">%EAX</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%stktop_4</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">11 movl    -24(%rbp), %eax</span>
  <span class="org-variable-name">%memload2</span> = <span class="org-keyword">load</span> <span class="org-type">i32</span><span class="org-parenthesis">,</span> <span class="org-type">ptr</span> <span class="org-variable-name">%stktop_4</span><span class="org-parenthesis">,</span> align <span class="org-preprocessor">1</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">mctoll &#30693;&#36947; systemv abi &#36890;&#36807; eax &#20445;&#23384;&#36820;&#22238;&#20540;</span>
  <span class="org-keyword">ret</span> <span class="org-type">i32</span> <span class="org-variable-name">%memload2</span>
<span class="org-parenthesis">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000006" class="outline-3">
<h3 id="org0000006"><span class="section-number-3">1.2.</span> 总结</h3>
<div class="outline-text-3" id="text-1-2">
<p>
想像中的 assembly lifting 的工作方式:
</p>

<pre class="example" id="org0000004">
c -&gt; llvm ir -&gt; asm ---+
        ^              |
        |              |
        +---lifting----+
</pre>

<p>
实现上 assembly lifting 的工作方式:
</p>

<pre class="example" id="org0000005">
c -&gt; llvm ir -&gt; asm --lifting--&gt; llvm ir
</pre>

<p>
mctoll 的主要思路是:
</p>

<ol class="org-ol">
<li>汇编中的寄存器, stack 等均被转换为 llvm 局部变量</li>

<li>把汇编指令转换为 llvm 指令以及 llvm intrinsic</li>

<li>特别的, 需要根据调用约定识别出函数参数和返回值, 对应 llvm 的函数参数和返回值,
而不是普通的局部变量</li>
</ol>

<p>
由于 x86 指令的复杂性 (例如 addl 对各个 flag 寄存器的修改), 一条 x86 汇编往往需要生成多条 llvm 指令
</p>

<p>
mctoll 把寄存器做为 llvm 局部变量的做法, 和 <a href="qemu_tcg.html#ID-fedb153b-c9a7-4ad1-a66e-e08b91173dd3">QEMU TCG</a> 类似. 不同的是, mctoll 可以使用 llvm opt 和 llc 对 llvm ir 进行优化和 lower, 最终这些局部变量极可能会重新变成寄存器. 另外, llvm opt 也可以去掉一些没有用到的 llvm ir (例如针对 flag 寄存器的处理)
</p>

<p>
例如, 通过 mctoll+opt+llc 生成的 riscv 汇编为:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span>    sp<span class="org-parenthesis">,</span> sp<span class="org-parenthesis">,</span> -32
    <span class="org-keyword">lui</span>     a2<span class="org-parenthesis">,</span> 228023
    <span class="org-keyword">slli</span>    a2<span class="org-parenthesis">,</span> a2<span class="org-parenthesis">,</span> 2
    <span class="org-keyword">addi</span>    a2<span class="org-parenthesis">,</span> a2<span class="org-parenthesis">,</span> -273
    <span class="org-keyword">sd</span>      a2<span class="org-parenthesis">,</span> 0<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">li</span>      a2<span class="org-parenthesis">,</span> 0
    <span class="org-keyword">sw</span>      a2<span class="org-parenthesis">,</span> 28<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">sw</span>      a0<span class="org-parenthesis">,</span> 24<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">sd</span>      a1<span class="org-parenthesis">,</span> 16<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">lw</span>      a0<span class="org-parenthesis">,</span> 24<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">sw</span>      a0<span class="org-parenthesis">,</span> 12<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">lw</span>      a0<span class="org-parenthesis">,</span> 24<span class="org-parenthesis">(</span>sp<span class="org-parenthesis">)</span>
    <span class="org-keyword">addiw</span>   a0<span class="org-parenthesis">,</span> a0<span class="org-parenthesis">,</span> 1
    <span class="org-keyword">addi</span>    sp<span class="org-parenthesis">,</span> sp<span class="org-parenthesis">,</span> 32
    <span class="org-keyword">ret</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000009" class="outline-3">
<h3 id="org0000009"><span class="section-number-3">1.3.</span> 为什么使用 llvm ir</h3>
<div class="outline-text-3" id="text-1-3">
<p>
尝试把 x86 asm 直接转换为 riscv asm:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">main</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">prologue:</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">riscv &#30340; prologue &#31867;&#20284;&#20110;&#19979;&#38754;&#36825;&#31181;:</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">addi sp, sp, xxx</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">sw ra, xx(sp)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">sw .....</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#38656;&#35201;&#35745;&#31639;&#20986; stack size, csr, &#36824;&#35201;&#32771;&#34385; riscv &#23545; stack &#23545;&#40784;&#30340;&#35201;&#27714;</span>
    <span class="org-keyword">pushq</span>   <span class="org-variable-name">%rbp</span>
    <span class="org-keyword">movq</span>    <span class="org-variable-name">%rsp</span><span class="org-parenthesis">,</span> <span class="org-variable-name">%rbp</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#21487;&#20197;&#25226; rbp &#21487;&#20197;&#26144;&#23556;&#20026; fp, &#20294;&#26159;&#33509; target &#19981;&#25903;&#25345; fp &#24590;&#20040;&#22788;&#29702;? &#25163;&#24037;&#36716;&#25442;&#20026; sp?</span>
    <span class="org-keyword">movl</span>    $0<span class="org-parenthesis">,</span> -4<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">edi, rsi &#21487;&#20197;&#26144;&#23556;&#20026; a0, a1, &#20294; riscv &#30340; calling convertion &#19982; x86 &#19981;&#21516;, &#20363;</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#22914; x86 &#21069; 6 &#20010;&#21442;&#25968;&#25918;&#22312;&#23492;&#23384;&#22120;, &#20854;&#23427;&#25918;&#22312;&#26632;&#19978;, &#20294; riscv &#21069; 8 &#20010;&#25918;&#22312;&#23492;&#23384;&#22120;&#19978;,</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#38656;&#35201;&#24590;&#20040;&#36716;&#25442;</span>
    <span class="org-keyword">movl</span>    <span class="org-variable-name">%edi</span><span class="org-parenthesis">,</span> -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#22914;&#26524; riscv &#19981;&#25903;&#25345; rv64g, &#26080;&#27861;&#30452;&#25509;&#26144;&#23556; 64 &#20301;&#30340; rsi &#21040; riscv &#23492;&#23384;&#22120;</span>
    <span class="org-keyword">movq</span>    <span class="org-variable-name">%rsi</span><span class="org-parenthesis">,</span> -16<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">x86_64 &#21482;&#26377; 10 &#20010; gpr, &#20294; riscv &#26377; 32 &#20010; gpr, &#30452;&#25509;&#26144;&#23556;&#26080;&#27861;&#21033;&#29992;&#20840;&#37096; riscv &#23492;&#23384;&#22120;</span>
    <span class="org-keyword">movl</span>    -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
    <span class="org-keyword">movl</span>    <span class="org-variable-name">%eax</span><span class="org-parenthesis">,</span> -20<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
    <span class="org-keyword">movl</span>    -8<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">x86 &#30340; addl &#38656;&#35201;&#20462;&#25913;&#22810;&#20010; flag, riscv &#38656;&#35201;&#29983;&#25104;&#22810;&#26465;&#25351;&#20196;, &#36825;&#20123;&#25351;&#20196;&#20998;&#37197;&#23492;&#23384;&#22120;</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#26102;&#24590;&#20040;&#36991;&#20813;&#20914;&#31361;? riscv &#20013;&#22914;&#20309;&#26816;&#26597; add &#26159;&#21542;&#26377;&#28322;&#20986;?</span>
    <span class="org-keyword">addl</span>    $1<span class="org-parenthesis">,</span> <span class="org-variable-name">%eax</span>
    <span class="org-keyword">movl</span>    <span class="org-variable-name">%eax</span><span class="org-parenthesis">,</span> -24<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">)</span>
    <span class="org-keyword">movl</span>    -24<span class="org-parenthesis">(</span><span class="org-variable-name">%rbp</span><span class="org-parenthesis">),</span> <span class="org-variable-name">%eax</span>
    <span class="org-keyword">popq</span>    <span class="org-variable-name">%rbp</span>
    <span class="org-keyword">retq</span>
</pre>
</div>

<p>
上面注释中列出来的所有问题, 其实在实现后端时都已经处理过了&#x2026;通过转换为 llvm ir,
可以避免重新实现一次后端.
</p>

<p>
另外, 利用 llvm opt, 还可以对生成的 llvm ir 进行优化, 可能生成比原来的汇编更好的代码.
</p>
</div>
</div>

<div id="outline-container-org000000c" class="outline-3">
<h3 id="org000000c"><span class="section-number-3">1.4.</span> 其它 asm lifting 工具</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<a href="https://stackoverflow.com/questions/4636498/recompile-a-x86-code-with-llvm-to-some-faster-one-x86/4636583#4636583">recompile-a-x86-code-with-llvm-to-some-faster-one-x86</a>
</p>

<p>
<a href="https://github.com/avast/retdec">https://github.com/avast/retdec</a>
</p>

<p>
<a href="https://github.com/lifting-bits">https://github.com/lifting-bits</a>
</p>

<p>
<a href="https://github.com/aengelke/rellume">https://github.com/aengelke/rellume</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway@dogdog.run<br />
Date: 2023-08-02 Wed 10:41<br />
Last updated: 2023-08-02 Wed 18:58</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</div>
</body>
</html>