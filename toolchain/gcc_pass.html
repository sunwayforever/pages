<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GCC Pass</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">GCC Pass</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000051">1. GCC Pass</a>
<ul>
<li><a href="#org0000000">1.1. Overview</a></li>
<li><a href="#org0000003">1.2. debug options</a></li>
<li><a href="#org000003c">1.3. tree pass</a>
<ul>
<li><a href="#org0000008">1.3.1. pass_build_cfg</a></li>
<li><a href="#org000000b">1.3.2. pass_ccp</a></li>
<li><a href="#org0000009">1.3.3. pass_fowrprop</a></li>
<li><a href="#org000000c">1.3.4. pass_pre</a></li>
<li><a href="#org000000f">1.3.5. pass_early_vrp</a></li>
<li><a href="#org0000012">1.3.6. pass_profile</a></li>
<li><a href="#org0000015">1.3.7. pass_dce</a></li>
<li><a href="#org0000018">1.3.8. pass_dse</a></li>
<li><a href="#org000001b">1.3.9. pass_copy_prop</a></li>
<li><a href="#org000001e">1.3.10. pass_sink_code</a></li>
<li><a href="#org0000021">1.3.11. pass_nrv</a></li>
<li><a href="#org0000024">1.3.12. pass_return_slot</a></li>
<li><a href="#org0000027">1.3.13. loop</a></li>
<li><a href="#org000002a">1.3.14. pass_loop</a></li>
<li><a href="#org000002d">1.3.15. pass_empty_loop</a></li>
<li><a href="#org0000030">1.3.16. pass_complete_unroll</a></li>
<li><a href="#org0000033">1.3.17. pass_loop_prefetch</a></li>
<li><a href="#org0000036">1.3.18. pass_lim</a></li>
<li><a href="#org0000039">1.3.19. pass_linear_transform</a></li>
</ul>
</li>
<li><a href="#ID-59094f94-ca0a-47eb-b9f5-1b3004a18716">1.4. rtl pass</a>
<ul>
<li><a href="#org0000044">1.4.1. pass_expand</a></li>
<li><a href="#org0000053">1.4.2. pass_ira</a></li>
<li><a href="#org0000056">1.4.3. pass_reload</a></li>
<li><a href="#org0000062">1.4.4. pass_thread_prologue_and_epilogue</a></li>
<li><a href="#org000003f">1.4.5. pass_peephole2</a></li>
<li><a href="#org0000068">1.4.6. pass_final</a></li>
<li><a href="#org0000045">1.4.7. pass_sched</a></li>
<li><a href="#org0000042">1.4.8. pass_rtl_dse1</a></li>
</ul>
</li>
<li><a href="#org000004e">1.5. others</a>
<ul>
<li><a href="#org000004b">1.5.1. GCC Expand Mult</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000051" class="outline-2">
<h2 id="org0000051"><span class="section-number-2">1</span> GCC Pass</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
所有的 pass 及其执行的顺序都在 passes.def 中指定.
</p>
</div>
</div>

<div id="outline-container-org0000003" class="outline-3">
<h3 id="org0000003"><span class="section-number-3">1.2</span> debug options</h3>
<div class="outline-text-3" id="text-1-2">
<p>
用来 debug pass 的命令行参数有:
</p>

<ol class="org-ol">
<li>`-fdump-{kind}-all`</li>
<li>`-fdump-{kind}-{pass}`</li>
<li>`-fdump-{kind}-{pass}-{options}`</li>
<li>`-fdisable-{kind}-{pass}`</li>
<li>`-fenable-{kind}-{pass}`</li>
<li>`-fopt-info`</li>
</ol>

<p>
其中:
</p>

<ol class="org-ol">
<li>kind 可以是 `tree` 或 `rtl`, 表示 gimple pass 或 rtl pass</li>

<li><p>
pass 是 pass 的名字, 例如 ccp, evrp, 从代码中的 pass_data_xxx 中可以得到具体的名字, 例如:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">const</span> <span class="org-type">pass_data</span> <span class="org-variable-name">pass_data_ccp</span> = {
    GIMPLE_PASS,               <span class="org-comment-delimiter">/* </span><span class="org-comment">type</span><span class="org-comment-delimiter"> */</span>
    <span class="org-string">"ccp"</span>,                     <span class="org-comment-delimiter">/* </span><span class="org-comment">name</span><span class="org-comment-delimiter"> */</span>
    OPTGROUP_NONE,             <span class="org-comment-delimiter">/* </span><span class="org-comment">optinfo_flags</span><span class="org-comment-delimiter"> */</span>
    TV_TREE_CCP,               <span class="org-comment-delimiter">/* </span><span class="org-comment">tv_id</span><span class="org-comment-delimiter"> */</span>
    (PROP_cfg | PROP_ssa),     <span class="org-comment-delimiter">/* </span><span class="org-comment">properties_required</span><span class="org-comment-delimiter"> */</span>
    0,                         <span class="org-comment-delimiter">/* </span><span class="org-comment">properties_provided</span><span class="org-comment-delimiter"> */</span>
    0,                         <span class="org-comment-delimiter">/* </span><span class="org-comment">properties_destroyed</span><span class="org-comment-delimiter"> */</span>
    0,                         <span class="org-comment-delimiter">/* </span><span class="org-comment">todo_flags_start</span><span class="org-comment-delimiter"> */</span>
    TODO_update_address_taken, <span class="org-comment-delimiter">/* </span><span class="org-comment">todo_flags_finish</span><span class="org-comment-delimiter"> */</span>
};
</pre>
</div></li>

<li>options 可以是 `details`, `graph`, `all` 等, 例如 `-fdump-tree-ccp1-details`</li>
</ol>

<p>
具体 pass 的名字, enable/disable 情况, pass 间的依赖等可以通过 `-fdump-passes` 查看, 例如:
</p>

<p>
`gcc test.c -O0 -fdump-passes` 可以看到 `-O0` 下 `tree-ccp1` 及其上级依赖
`tree-early_optimizations` 为 OFF, 所以可以通过 `gcc test.c -O0
-fenable-tree-ccp1 -fenable-tree-early_optimizations` 来单独验证 pass_ccp1
</p>
</div>
</div>

<div id="outline-container-org000003c" class="outline-3">
<h3 id="org000003c"><span class="section-number-3">1.3</span> tree pass</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org0000008" class="outline-4">
<h4 id="org0000008"><span class="section-number-4">1.3.1</span> pass_build_cfg</h4>
<div class="outline-text-4" id="text-1-3-1">
<pre class="example" id="org0000006">
$&gt; cat test.c.011t.cfg

;; Function foo (foo, funcdef_no=0, decl_uid=1363, symbol_order=0)

;; 1 loops found
;;
;; Loop 0
;;  header 0, latch 1
;;  depth 0, outer -1
;;  nodes: 0 1 2 3 4 5
;; 2 succs { 3 4 }
;; 3 succs { 5 }
;; 4 succs { 5 }
;; 5 succs { 1 }
foo ()
{
  float y;
  float x;
  double D.1373;
  double D.1372;
  double D.1371;
  double D.1370;

  &lt;bb 2&gt;:
  x = 0.0;
  y = x * 2.0e+0;
  if (y &gt; 0.0)
    goto &lt;bb 3&gt;;
  else
    goto &lt;bb 4&gt;;

  &lt;bb 3&gt;:
  D.1370 = (double) y;
  D.1371 = D.1370 + 1.0e+0;
  D.1372 = (double) y;
  D.1373 = D.1371 + D.1372;
  y = (float) D.1373;
  goto &lt;bb 5&gt;;

  &lt;bb 4&gt;:
  y = 1.0e+0;

  &lt;bb 5&gt;:
  return;

}


</pre>

<p>
&lt;bb x&gt; 表示 basic block, 通过 `-fdump-tree-cfg-graph` 可以 dump 出 cfg 对应的
dot 文件, 转换为 png 后为:
</p>


<div id="org0000007" class="figure">
<p><img src="../extra/gimple_cfg.png" alt="gimple_cfg.png" />
</p>
</div>

<p>
转换为 cfg (或者 basic block) 的好处是同一个 basic block 内部都是线性的指令, 容易做 local optimization
</p>
</div>
</div>

<div id="outline-container-org000000b" class="outline-4">
<h4 id="org000000b"><span class="section-number-4">1.3.2</span> <a href="gcc_constant_propagation.html#ID-74f4bdf4-8f9d-4e60-9d4c-4fceb7b63e0c">pass_ccp</a></h4>
</div>

<div id="outline-container-org0000009" class="outline-4">
<h4 id="org0000009"><span class="section-number-4">1.3.3</span> <a href="gcc_forward_propagation.html#ID-97b15196-d8e8-4b9d-a06b-c9328234776d">pass_fowrprop</a></h4>
</div>

<div id="outline-container-org000000c" class="outline-4">
<h4 id="org000000c"><span class="section-number-4">1.3.4</span> pass_pre</h4>
</div>

<div id="outline-container-org000000f" class="outline-4">
<h4 id="org000000f"><span class="section-number-4">1.3.5</span> pass_early_vrp</h4>
</div>

<div id="outline-container-org0000012" class="outline-4">
<h4 id="org0000012"><span class="section-number-4">1.3.6</span> <a href="gcc_profile.html#ID-b679e100-573e-4625-87b4-06f810416a84">pass_profile</a></h4>
</div>

<div id="outline-container-org0000015" class="outline-4">
<h4 id="org0000015"><span class="section-number-4">1.3.7</span> pass_dce</h4>
</div>

<div id="outline-container-org0000018" class="outline-4">
<h4 id="org0000018"><span class="section-number-4">1.3.8</span> pass_dse</h4>
</div>

<div id="outline-container-org000001b" class="outline-4">
<h4 id="org000001b"><span class="section-number-4">1.3.9</span> pass_copy_prop</h4>
</div>

<div id="outline-container-org000001e" class="outline-4">
<h4 id="org000001e"><span class="section-number-4">1.3.10</span> pass_sink_code</h4>
</div>

<div id="outline-container-org0000021" class="outline-4">
<h4 id="org0000021"><span class="section-number-4">1.3.11</span> <a href="gcc_named_return_value.html#ID-e53c6711-2a42-473c-af42-a27179f8c22b">pass_nrv</a></h4>
</div>

<div id="outline-container-org0000024" class="outline-4">
<h4 id="org0000024"><span class="section-number-4">1.3.12</span> <a href="gcc_return_slot.html#ID-801a952f-ac2b-4551-946a-105d06d13446">pass_return_slot</a></h4>
</div>

<div id="outline-container-org0000027" class="outline-4">
<h4 id="org0000027"><span class="section-number-4">1.3.13</span> loop</h4>
</div>

<div id="outline-container-org000002a" class="outline-4">
<h4 id="org000002a"><span class="section-number-4">1.3.14</span> pass_loop</h4>
</div>

<div id="outline-container-org000002d" class="outline-4">
<h4 id="org000002d"><span class="section-number-4">1.3.15</span> pass_empty_loop</h4>
</div>

<div id="outline-container-org0000030" class="outline-4">
<h4 id="org0000030"><span class="section-number-4">1.3.16</span> pass_complete_unroll</h4>
</div>

<div id="outline-container-org0000033" class="outline-4">
<h4 id="org0000033"><span class="section-number-4">1.3.17</span> pass_loop_prefetch</h4>
</div>

<div id="outline-container-org0000036" class="outline-4">
<h4 id="org0000036"><span class="section-number-4">1.3.18</span> pass_lim</h4>
</div>

<div id="outline-container-org0000039" class="outline-4">
<h4 id="org0000039"><span class="section-number-4">1.3.19</span> pass_linear_transform</h4>
</div>
</div>

<div id="outline-container-ID-59094f94-ca0a-47eb-b9f5-1b3004a18716" class="outline-3">
<h3 id="ID-59094f94-ca0a-47eb-b9f5-1b3004a18716"><span class="section-number-3">1.4</span> rtl pass</h3>
<div class="outline-text-3" id="text-1-4">
</div>

<div id="outline-container-org0000044" class="outline-4">
<h4 id="org0000044"><span class="section-number-4">1.4.1</span> pass_expand</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
gimple 转换为 rtl
</p>
</div>
</div>

<div id="outline-container-org0000053" class="outline-4">
<h4 id="org0000053"><span class="section-number-4">1.4.2</span> pass_ira</h4>
<div class="outline-text-4" id="text-1-4-2">
<ol class="org-ol">
<li>寄存器分配</li>
<li>计算 frame_info, 例如计算 frame size 和需要保存和恢复的寄存器 (mask)</li>
</ol>
</div>

<div id="outline-container-org0000050" class="outline-5">
<h5 id="org0000050"><span class="section-number-5">1.4.2.1</span> frame_info</h5>
<div class="outline-text-5" id="text-1-4-2-1">
<p>
taget 需要定义 INITIAL_ELIMINATION_OFFSET 这个宏, 用来计算 frame info.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">riscv_compute_frame_info</span>(<span class="org-type">void</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">riscv_frame_info</span> *<span class="org-variable-name">frame</span>;
    <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">offset</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">interrupt_save_prologue_temp</span> = <span class="org-constant">false</span>;
    <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>, <span class="org-variable-name">i</span>, <span class="org-variable-name">num_x_saved</span> = 0, <span class="org-variable-name">num_f_saved</span> = 0;

    frame = &amp;cfun-&gt;machine-&gt;frame;
    memset(frame, 0, <span class="org-keyword">sizeof</span>(*frame));

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: naked function</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>cfun-&gt;machine-&gt;naked_p) {
        <span class="org-keyword">for</span> (regno = GP_REG_FIRST; regno &lt;= GP_REG_LAST; regno++)
            <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: riscv_save_reg_p &#29992;&#26469;&#30830;&#23450;&#23492;&#23384;&#22120;&#26159;&#21542;&#38656;&#35201;&#20445;&#23384;, &#20363;&#22914;:</span>
<span class="org-comment">             * &#22914;&#26524; regno &#26159; s0~</span><span class="org-comment-delimiter"> */</span>
            <span class="org-keyword">if</span> (riscv_save_reg_p(regno))
                frame-&gt;mask |= 1 &lt;&lt; (regno - GP_REG_FIRST), num_x_saved++;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">Find out which FPRs we need to save.  This loop must iterate over</span>
<span class="org-comment">           the same space as its companion in riscv_for_each_saved_reg.</span><span class="org-comment-delimiter">  */</span>
        <span class="org-keyword">if</span> (TARGET_HARD_FLOAT)
            <span class="org-keyword">for</span> (regno = FP_REG_FIRST; regno &lt;= FP_REG_LAST; regno++)
                <span class="org-keyword">if</span> (riscv_save_reg_p(regno))
                    frame-&gt;fmask |= 1 &lt;&lt; (regno - FP_REG_FIRST), num_f_saved++;
    }

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#35745;&#31639; offset &#26102;&#26159;&#25353;&#29031; stack &#20174;&#20302;&#21040;&#39640;&#30340;&#39034;&#24207;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 1. &#26632;&#39030;&#26159; outgoing args, &#21363; spill &#21040;&#26632;&#19978;&#30340; args</span><span class="org-comment-delimiter"> */</span>
    offset = RISCV_STACK_ALIGN(crtl-&gt;outgoing_args_size);
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 2. &#28982;&#21518;&#26159; local variable</span><span class="org-comment-delimiter"> */</span>
    offset += RISCV_STACK_ALIGN(get_frame_size());
    <span class="org-comment-delimiter">/* </span><span class="org-comment">The virtual frame pointer points above the local variables.</span><span class="org-comment-delimiter"> */</span>
    frame-&gt;frame_pointer_offset = offset;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 3. &#38656;&#35201;&#20445;&#23384;&#30340; fp</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (frame-&gt;fmask)
        offset += RISCV_STACK_ALIGN(num_f_saved * UNITS_PER_FP_REG);
    frame-&gt;fp_sp_offset = offset - UNITS_PER_FP_REG;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 4. &#38656;&#35201;&#20445;&#23384;&#30340; gp</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (frame-&gt;mask) {
        <span class="org-type">unsigned</span> <span class="org-variable-name">x_save_size</span> = RISCV_STACK_ALIGN(num_x_saved * UNITS_PER_WORD);
        offset += x_save_size;
    }
    frame-&gt;gp_sp_offset = offset - UNITS_PER_WORD;
    frame-&gt;hard_frame_pointer_offset = offset;
    frame-&gt;total_size = offset;
}
</pre>
</div>
</div>

<div id="outline-container-ID-eaff51af-4d01-4a5c-9810-c7382088881e" class="outline-6">
<h6 id="ID-eaff51af-4d01-4a5c-9810-c7382088881e"><span class="section-number-6">1.4.2.1.1</span> naked</h6>
<div class="outline-text-6" id="text-1-4-2-1-1">
<p>
naked function, 是指不需要 gcc 生成 prolog 和 epilogue 的函数, 例如一些完全用内联汇编写的函数.
</p>
</div>


<ul class="org-ul">
<li><a id="org0000054"></a>Backlinks<br />
<div class="outline-text-7" id="text-org0000054">
<p>
<a href="gcc_attribute.html#ID-463c82be-a55d-43c3-a8f2-cba1c1cd7599">GCC Attribute</a>
(<i>GCC Attribute &gt; naked</i>):   <a href="#ID-eaff51af-4d01-4a5c-9810-c7382088881e">naked</a>
</p>
</div>
</li>
</ul>
</div>


<div id="outline-container-org000004a" class="outline-6">
<h6 id="org000004a"><span class="section-number-6">1.4.2.1.2</span> riscv_save_reg_p</h6>
<div class="outline-text-6" id="text-1-4-2-1-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">bool</span> <span class="org-function-name">riscv_save_reg_p</span>(<span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>) {
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: global_regs &#26159;&#25351; global regizer variable</span>
<span class="org-comment">     * https://gcc.gnu.org/onlinedocs/gcc/Global-Register-Variables.html</span>
<span class="org-comment">     *</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">bool</span> <span class="org-variable-name">call_saved</span> = <span class="org-negation-char">!</span>global_regs[regno] &amp;&amp; <span class="org-negation-char">!</span>call_used_or_fixed_reg_p(regno);
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: df_regs_ever_live_p &#25351;&#35813; reg &#22312;&#24403;&#21069;&#20989;&#25968;&#20462;&#25913;&#36807;, &#20363;&#22914;, &#33509;&#20989;&#25968;&#26159; leaf</span>
<span class="org-comment">     * function, ra &#20250;&#22240;&#20026;&#27809;&#26377;&#20462;&#25913;&#36807;&#32780;&#19981;&#38656;&#35201;&#20445;&#23384;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">bool</span> <span class="org-variable-name">might_clobber</span> =
        crtl-&gt;saves_all_registers || df_regs_ever_live_p(regno);

    <span class="org-keyword">if</span> (call_saved &amp;&amp; might_clobber) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-keyword">if</span> (regno == HARD_FRAME_POINTER_REGNUM &amp;&amp; frame_pointer_needed) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-keyword">if</span> (regno == RETURN_ADDR_REGNUM &amp;&amp; crtl-&gt;calls_eh_return) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">return</span> <span class="org-constant">false</span>;
}

<span class="org-keyword">inline</span> <span class="org-type">bool</span> <span class="org-function-name">call_used_or_fixed_reg_p</span>(<span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>) {
    <span class="org-keyword">return</span> fixed_regs[regno] || this_target_hard_regs-&gt;x_call_used_regs[regno];
}
</pre>
</div>

<p>
FIXED_REGISTER 和 CALL_USED_REGISTERS 为 target 定义的, 例如:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">FIXED_REGISTERS</span>                                                       \
    { <span class="org-comment-delimiter">/* </span><span class="org-comment">General registers.</span><span class="org-comment-delimiter">  */</span>                                               \
        1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  \
            0, 0, 0, 0, 0, 0, 0, 0, 0, <span class="org-comment-delimiter">/* </span><span class="org-comment">Floating-point registers.</span><span class="org-comment-delimiter">  */</span>       \
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, \
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, <span class="org-comment-delimiter">/* </span><span class="org-comment">Others.</span><span class="org-comment-delimiter">  */</span>                      \
            1, 1                                                              \
    }

<span class="org-comment-delimiter">/* </span><span class="org-comment">a0-a7, t0-t6, fa0-fa7, and ft0-ft11 are volatile across calls.</span>
<span class="org-comment">   The call RTLs themselves clobber ra.</span><span class="org-comment-delimiter">  */</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">CALL_USED_REGISTERS</span>                                                   \
    { <span class="org-comment-delimiter">/* </span><span class="org-comment">General registers.</span><span class="org-comment-delimiter">  */</span>                                               \
        1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,  \
            0, 0, 0, 0, 0, 1, 1, 1, 1, <span class="org-comment-delimiter">/* </span><span class="org-comment">Floating-point registers.</span><span class="org-comment-delimiter">  */</span>       \
            1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, \
            0, 0, 0, 0, 0, 0, 1, 1, 1, 1, <span class="org-comment-delimiter">/* </span><span class="org-comment">Others.</span><span class="org-comment-delimiter">  */</span>                      \
            1, 1                                                              \
    }
</pre>
</div>

<p>
FIXED_REGISTERS 是有特殊意义的 reg, 任何时候不能被随便修改, 例如 zero, sp, gp, tp
</p>

<p>
CALL_USED_REGISTERS 包含 FIXED_REGISTERS, 以及其它在函数调用时可能被 caller 修改的 reg, 基本上 (CALL_USED_REGISTERS - FIXED_REGISTERS) 即 caller saved reg, 而
~CALL_USED_REGISTERS 即 callee saved reg.
</p>

<p>
另外 gcc 可以通过运行时参数 `-ffixed-reg` 控制哪些 reg 属于
FIXED_REGISTERS. FIXED_REGISTERS 不会被 ira 分配, 也不会被 prologue 保存
</p>
</div>
</div>

<div id="outline-container-org000004d" class="outline-6">
<h6 id="org000004d"><span class="section-number-6">1.4.2.1.3</span> backtrace</h6>
<div class="outline-text-6" id="text-1-4-2-1-3">
<div class="org-src-container">
<pre class="src src-rust">#0  riscv_save_reg_p (regno=0) at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3636
#1  0x0000000001544432 <span class="org-keyword">in</span> riscv_compute_frame_info () at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3766
#2  0x000000000154483f <span class="org-keyword">in</span> riscv_initial_elimination_offset (from=64, to=2) at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3850
#3  0x0000000001062641 <span class="org-keyword">in</span> set_initial_elim_offsets () at ../.././riscv-gcc/gcc/reload1.<span class="org-variable-name">c</span>:3769
#4  0x000000000105c432 <span class="org-keyword">in</span> calculate_elim_costs_all_insns () at ../.././riscv-gcc/gcc/reload1.<span class="org-variable-name">c</span>:1559
#5  0x0000000000e8eee5 <span class="org-keyword">in</span> ira_costs () at ../.././riscv-gcc/gcc/ira-costs.<span class="org-variable-name">c</span>:2296
#6  0x0000000000e85524 <span class="org-keyword">in</span> ira_build () at ../.././riscv-gcc/gcc/ira-build.<span class="org-variable-name">c</span>:3426
#7  0x0000000000e7b6ae <span class="org-keyword">in</span> ira (f=0x0) at ../.././riscv-gcc/gcc/ira.<span class="org-variable-name">c</span>:5655
#8  0x0000000000e7bf6b <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_ira</span>::execute (this=0x23413c0) at ../.././riscv-gcc/gcc/ira.<span class="org-variable-name">c</span>:5978
#9  0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x23413c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#10 0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x23413c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#11 0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2340220) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#12 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#13 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#14 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#15 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#16 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#17 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#18 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#19 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#20 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#21 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000056" class="outline-4">
<h4 id="org0000056"><span class="section-number-4">1.4.3</span> pass_reload</h4>
</div>

<div id="outline-container-org0000062" class="outline-4">
<h4 id="org0000062"><span class="section-number-4">1.4.4</span> pass_thread_prologue_and_epilogue</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
在函数中插入的 prologue 和 epilogue. prologue 是指函数开头需要插入的一些指令, 例如分配 stack frame, 保存寄存器. epilogue 是函数返回前需要插入指令, 例如释放
stack frame, 恢复寄存器.
</p>
</div>

<div id="outline-container-org0000059" class="outline-5">
<h5 id="org0000059"><span class="section-number-5">1.4.4.1</span> prologue</h5>
<div class="outline-text-5" id="text-1-4-4-1">
<p>
prologue 对应的 rtl 是由 md 中的通过 define_expand 定义的 prologue 决定的.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">rtx</span>
<span class="org-function-name">gen_prologue</span> (<span class="org-type">void</span>)
{
  <span class="org-type">rtx_insn</span> *<span class="org-variable-name">_val</span> = 0;
  start_sequence ();
  {
<span class="org-preprocessor">#define</span> <span class="org-variable-name">FAIL</span> <span class="org-keyword">return</span> (end_sequence (), _val)
<span class="org-preprocessor">#define</span> <span class="org-variable-name">DONE</span> <span class="org-keyword">return</span> (_val = get_insns (), end_sequence (), _val)
<span class="org-preprocessor">#line</span> 2202 <span class="org-string">"../.././riscv-gcc/gcc/config/riscv/riscv.md"</span>
{
  riscv_expand_prologue ();
  DONE;
}
<span class="org-preprocessor">#undef</span> DONE
<span class="org-preprocessor">#undef</span> FAIL
  }
  emit_insn (const1_rtx);
  _val = get_insns ();
  end_sequence ();
  <span class="org-keyword">return</span> _val;
}
</pre>
</div>

<p>
riscv_expand_prologue 负责生成函数开头的:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">addi</span> <span class="org-keyword">sp</span>, sp , xxx
<span class="org-function-name">sw</span> <span class="org-keyword">ra</span>, (4)sp
<span class="org-function-name">sw</span> <span class="org-keyword">s0</span>, (8)sp
## ...
</pre>
</div>

<p>
对应的 rtx
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#36825;&#27573;&#20195;&#30721;&#36127;&#36131;&#29983;&#25104;&#20989;&#25968;&#24320;&#22836;&#30340;</span>
<span class="org-comment"> * addi sp, sp , xxx</span>
<span class="org-comment"> * sw ra, (4)sp</span>
<span class="org-comment"> * sw s0, (8)sp</span>
<span class="org-comment"> * ...</span>
<span class="org-comment"> *</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">void</span> <span class="org-function-name">riscv_expand_prologue</span>(<span class="org-type">void</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">riscv_frame_info</span> *<span class="org-variable-name">frame</span> = &amp;cfun-&gt;machine-&gt;frame;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;total_size &#22312; pass_ira &#26102;&#30830;&#23450;&#19979;&#26469;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">size</span> = frame-&gt;total_size;
    <span class="org-type">unsigned</span> <span class="org-variable-name">mask</span> = frame-&gt;mask;
    <span class="org-type">rtx</span> <span class="org-variable-name">insn</span>;

    <span class="org-keyword">if</span> (flag_stack_usage_info) current_function_static_stack_size = size;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Save the registers.</span><span class="org-comment-delimiter">  */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;mask &#25351;&#21738;&#20123;&#23492;&#23384;&#22120;&#38656;&#35201;&#20445;&#23384;, &#20063;&#26159; pass_ira &#26102;&#30830;&#23450;&#30340;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> ((frame-&gt;mask | frame-&gt;fmask) != 0) {
        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#36825;&#37324;&#24182;&#27809;&#26377;&#30452;&#25509;&#20351;&#29992; frame-&gt;total_size, &#26159;&#22240;&#20026; total_size &#24456;&#22823;&#26102;</span>
<span class="org-comment">         * &#20250;&#26080;&#27861;&#36890;&#36807;&#19968;&#20010; addi &#23436;&#25104;, &#25152;&#20197;&#21487;&#20197;&#20808;&#20998;&#37197;&#36275;&#22815;&#23384;&#25918; saved reg &#30340;&#23567;&#19968;&#28857;&#30340;</span>
<span class="org-comment">         * `step`</span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">step1</span> = MIN(size, riscv_first_stack_step(frame));

        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: addi sp, sp, -step1</span><span class="org-comment-delimiter"> */</span>
        insn = gen_add3_insn(
            stack_pointer_rtx, stack_pointer_rtx, GEN_INT(-step1));
        size -= step1;
        riscv_for_each_saved_reg(size, riscv_save_reg, <span class="org-constant">false</span>, <span class="org-constant">false</span>);
    }

    frame-&gt;mask = mask; <span class="org-comment-delimiter">/* </span><span class="org-comment">Undo the above fib.</span><span class="org-comment-delimiter">  */</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#38656;&#35201;&#20445;&#23384; fp, &#20363;&#22914;&#23384;&#22312; alloca</span><span class="org-comment-delimiter">  */</span>
    <span class="org-keyword">if</span> (frame_pointer_needed) {
        insn = gen_add3_insn(
            hard_frame_pointer_rtx, stack_pointer_rtx,
            GEN_INT(frame-&gt;hard_frame_pointer_offset - size));
        RTX_FRAME_RELATED_P(emit_insn(insn)) = 1;

        riscv_emit_stack_tie();
    }

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;total_size &#21097;&#19979;&#30340;&#37096;&#20998;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (size &gt; 0) {
        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: SMALL_OPERAND &#26159;&#25351; 12 bit &#33021;&#34920;&#31034;&#30340;&#31435;&#21363;&#25968;</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">if</span> (SMALL_OPERAND(-size)) {
            insn = gen_add3_insn(
                stack_pointer_rtx, stack_pointer_rtx, GEN_INT(-size));
            RTX_FRAME_RELATED_P(emit_insn(insn)) = 1;
        } <span class="org-keyword">else</span> {
            riscv_emit_move(RISCV_PROLOGUE_TEMP(Pmode), GEN_INT(-size));
            emit_insn(gen_add3_insn(
                stack_pointer_rtx, stack_pointer_rtx,
                RISCV_PROLOGUE_TEMP(Pmode)));

            <span class="org-comment-delimiter">/* </span><span class="org-comment">Describe the effect of the previous instructions.</span><span class="org-comment-delimiter">  */</span>
            insn = plus_constant(Pmode, stack_pointer_rtx, -size);
            insn = gen_rtx_SET(stack_pointer_rtx, insn);
            riscv_set_frame_expr(insn);
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org000005c" class="outline-5">
<h5 id="org000005c"><span class="section-number-5">1.4.4.2</span> epilogue</h5>
</div>

<div id="outline-container-org000005f" class="outline-5">
<h5 id="org000005f"><span class="section-number-5">1.4.4.3</span> backtrace</h5>
<div class="outline-text-5" id="text-1-4-4-3">
<div class="org-src-container">
<pre class="src src-rust">#0  gen_prologue () at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">md</span>:2202
#1  0x000000000153aada <span class="org-keyword">in</span> target_gen_prologue () at ../.././riscv-gcc/gcc/config/riscv/sync.<span class="org-variable-name">md</span>:558
#2  0x0000000000d017d6 <span class="org-keyword">in</span> make_prologue_seq () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:5801
#3  0x0000000000d01d8b <span class="org-keyword">in</span> thread_prologue_and_epilogue_insns () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6019
#4  0x0000000000d02cbb <span class="org-keyword">in</span> rest_of_handle_thread_prologue_and_epilogue () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6510
#5  0x0000000000d02ecf <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_thread_prologue_and_epilogue</span>::execute (this=0x23416c0) at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6586
#6  0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x23416c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#7  0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x23416c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#8  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2341480) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#9  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2340220) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#10 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#11 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#12 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#13 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#14 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#15 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#16 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#17 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#18 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#19 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000003f" class="outline-4">
<h4 id="org000003f"><span class="section-number-4">1.4.5</span> <a href="gcc_peephole2.html#ID-5f849222-e2fa-426b-ad5d-bce729e0605e">pass_peephole2</a></h4>
</div>

<div id="outline-container-org0000068" class="outline-4">
<h4 id="org0000068"><span class="section-number-4">1.4.6</span> pass_final</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
生成汇编
</p>
</div>
</div>

<div id="outline-container-org0000045" class="outline-4">
<h4 id="org0000045"><span class="section-number-4">1.4.7</span> <a href="gcc_scheduler.html#ID-aa30d0cc-966e-407b-9ad3-a0b0fbad7c49">pass_sched</a></h4>
</div>

<div id="outline-container-org0000042" class="outline-4">
<h4 id="org0000042"><span class="section-number-4">1.4.8</span> pass_rtl_dse1</h4>
</div>


<div id="outline-container-org0000071" class="outline-4 references">
<h4 id="org0000071">Backlinks</h4>
<div class="outline-text-4" id="text-org0000071">
<p>
<a href="gcc_backend.html#ID-02e7f924-9cf7-4e3d-8ceb-1765fd3a2bed">GCC Backend</a>
(<i>GCC Backend &gt; rtl pass</i>):   <a href="#ID-59094f94-ca0a-47eb-b9f5-1b3004a18716">rtl pass</a>
</p>
</div>
</div>
</div>


<div id="outline-container-org000004e" class="outline-3">
<h3 id="org000004e"><span class="section-number-3">1.5</span> others</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org000004b" class="outline-4">
<h4 id="org000004b"><span class="section-number-4">1.5.1</span> <a href="gcc_expand_mult.html#ID-5cd7feb7-6e6c-47b5-b63c-6465c8354c1a">GCC Expand Mult</a></h4>
</div>
</div>
</div>


<div id="outline-container-org000007d" class="outline-2 references">
<h2 id="org000007d">Backlinks</h2>
<div class="outline-text-2" id="text-org000007d">
<p>
<a href="gcc.html#ID-19df5597-4fd4-47a1-9534-f6e0c327e8d5">GCC</a>
(<i>GCC &gt; GCC Pass</i>):   <a href="gcc_pass.html#ID-17957249-95aa-4d26-8d2b-48ece73cd8cd">GCC Pass</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-04-15 Fri 14:04<br />
Last updated: 2022-04-26 Tue 14:15</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
