<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-24 Mon 19:33 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linker Options</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linker Options</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org077407d">1. Linker Options</a>
<ul>
<li><a href="#orgddff343">1.1. environment variable</a>
<ul>
<li><a href="#org0a4358b">1.1.1. LD_LIBRARY_PATH</a></li>
<li><a href="#orge134c9c">1.1.2. LD_BIND_NOW</a></li>
<li><a href="#org24cc780">1.1.3. LD_PRELOAD</a></li>
<li><a href="#orgec165e1">1.1.4. LD_SHOW_AUXV</a></li>
</ul>
</li>
<li><a href="#org8e54fdc">1.2. init</a></li>
<li><a href="#org2e2625a">1.3. verbose</a></li>
<li><a href="#org31d9dc3">1.4. script</a></li>
<li><a href="#orgc55f992">1.5. entry</a></li>
<li><a href="#orgb009e0e">1.6. gc-sections</a></li>
<li><a href="#org7438434">1.7. nostdlib</a></li>
<li><a href="#org019513b">1.8. pie</a></li>
<li><a href="#org51e61dd">1.9. rpath</a></li>
<li><a href="#orgb2a1328">1.10. no-as-needed, whole-archive 及链接的顺序</a></li>
<li><a href="#org71e34da">1.11. section-start</a></li>
<li><a href="#orgbbf4b86">1.12. version_script</a></li>
<li><a href="#orgf1bd90d">1.13. soname</a></li>
<li><a href="#org030c169">1.14. Bsymbolic</a></li>
<li><a href="#org7da32c3">1.15. dynamic-linker</a></li>
<li><a href="#orga96770b">1.16. relro</a></li>
<li><a href="#org37aa5c3">1.17. wrap</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org077407d" class="outline-2">
<h2 id="org077407d"><span class="section-number-2">1</span> Linker Options</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgddff343" class="outline-3">
<h3 id="orgddff343"><span class="section-number-3">1.1</span> environment variable</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0a4358b" class="outline-4">
<h4 id="org0a4358b"><span class="section-number-4">1.1.1</span> LD_LIBRARY_PATH</h4>
</div>

<div id="outline-container-orge134c9c" class="outline-4">
<h4 id="orge134c9c"><span class="section-number-4">1.1.2</span> LD_BIND_NOW</h4>
</div>

<div id="outline-container-org24cc780" class="outline-4">
<h4 id="org24cc780"><span class="section-number-4">1.1.3</span> LD_PRELOAD</h4>
</div>


<div id="outline-container-orgec165e1" class="outline-4">
<h4 id="orgec165e1"><span class="section-number-4">1.1.4</span> LD_SHOW_AUXV</h4>
</div>
</div>

<div id="outline-container-org8e54fdc" class="outline-3">
<h3 id="org8e54fdc"><span class="section-number-3">1.2</span> init</h3>
<div class="outline-text-3" id="text-1-2">
<p>
默认情况下 linker 把发现 _init 函数并把它设置 .dynamic section 中的 DT_INIT
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">_init</span>() {
    printf(<span style="font-style: italic;">"%s\n"</span>, <span style="font-style: italic;">"init"</span>);
}

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> *<span style="font-weight: bold; font-style: italic;">argv</span>[]) {
    printf(<span style="font-style: italic;">"main: %p\n"</span>, &amp;main);
    <span style="font-weight: bold;">return</span> 0;
}

</pre>
</div>

<pre class="example" id="orgcb5c7de">
$&gt; arm-linux-androideabi-gcc test.c -fPIE -pie -O3 -g3
00000474 &lt;_init&gt;:
 474:	e59f0004 	ldr	r0, [pc, #4]	; 480 &lt;_init+0xc&gt;
 478:	e08f0000 	add	r0, pc, r0
 47c:	eaffffc2 	b	38c &lt;puts@plt&gt;
 480:	00000010 	andeq	r0, r0, r0, lsl r0


Dynamic section at offset 0xec0 contains 29 entries:
  Tag        Type                         Name/Value
 ...
 0x0000000c (INIT)                       0x474
 ...
</pre>

<p>
也可以通过 linker 的 -init 来指定而不使用默认的 _init 函数, 效果是一样
的. 
</p>
</div>
</div>

<div id="outline-container-org2e2625a" class="outline-3">
<h3 id="org2e2625a"><span class="section-number-3">1.3</span> verbose</h3>
</div>

<div id="outline-container-org31d9dc3" class="outline-3">
<h3 id="org31d9dc3"><span class="section-number-3">1.4</span> script</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<a href="linker_script.html#org58ac1f2">Linker Script</a>
</p>
</div>
</div>

<div id="outline-container-orgc55f992" class="outline-3">
<h3 id="orgc55f992"><span class="section-number-3">1.5</span> entry</h3>
</div>

<div id="outline-container-orgb009e0e" class="outline-3">
<h3 id="orgb009e0e"><span class="section-number-3">1.6</span> gc-sections</h3>
<div class="outline-text-3" id="text-1-6">
<p>
use `gc-sections`, `-ffunction-sections`, `-fdata-sections` to remove unused symbol
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-11-06 Fri]</span></span>
</p>

<p>
正常情况下, ld 在链接时会以 object 为单位, 把所有的同类 input section 集合成一个
section, 其中 ld 的 gc-sections 参数会导致没有用到的 input section 会被删除
</p>

<p>
gc-sections decides which <b><b>input</b></b> sections are used by examining symbols and
relocations.  The section containing the entry symbol and all sections
containing symbols undefined on the command-line will be kept, as will sections
containing symbols referenced by dynamic objects.  Note that when building
shared libraries, the linker must assume that any <b>visible</b> symbol is
referenced. Once this initial set of sections has been determined, the linker
recursively marks as used any section referenced by their relocations.
</p>

<p>
默认情况下同一个 object 中的所有函数都在同一个 input section, 导致只要有一个函数被
引用, 整个 input section 被会被保存.
</p>

<p>
通过 ffunction-sections, 可以使每个函数都在它自己的 section 中, 例如 foo 函数会
放在 .text.foo 中, 这样配合 gc-sections, 就可以删除没使用的函数
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">foo</span>() { printf(<span style="font-style: italic;">"hello\n"</span>); }
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span>** <span style="font-weight: bold; font-style: italic;">argv</span>) {}
</pre>
</div>

<pre class="example" id="org9f198c1">
$&gt; gcc test.c
$&gt; nm ./a.out|grep foo
0000000000001149 T foo

$&gt; gcc -ffunction-sections test.c -c
$&gt; readelf -S ./test.o|grep text
[ 1] .text             PROGBITS         0000000000000000  00000040
[ 5] .text.foo         PROGBITS         0000000000000000  00000046
[ 6] .rela.text.foo    RELA             0000000000000000  000002c8
[ 7] .text.main        PROGBITS         0000000000000000  0000005d

$&gt; gcc -ffunction-sections test.c -Wl,-gc-sections
$&gt; nm ./a.out|grep foo
</pre>
</div>
</div>

<div id="outline-container-org7438434" class="outline-3">
<h3 id="org7438434"><span class="section-number-3">1.7</span> nostdlib</h3>
<div class="outline-text-3" id="text-1-7">
<p>
<a href="bare_metal.html#org1c8f906">libgcc, crt0.o 与 nostdlib, nodefaultlibs, nostartfiles</a>
</p>
</div>
</div>

<div id="outline-container-org019513b" class="outline-3">
<h3 id="org019513b"><span class="section-number-3">1.8</span> pie</h3>
</div>

<div id="outline-container-org51e61dd" class="outline-3">
<h3 id="org51e61dd"><span class="section-number-3">1.9</span> rpath</h3>
<div class="outline-text-3" id="text-1-9">
<p>
<a href="android_linker.html#org2e63678">load_library</a>
</p>
</div>
</div>

<div id="outline-container-orgb2a1328" class="outline-3">
<h3 id="orgb2a1328"><span class="section-number-3">1.10</span> no-as-needed, whole-archive 及链接的顺序</h3>
<div class="outline-text-3" id="text-1-10">
<p>
无论 foo 是 libfoo.so 还是 libfoo.a, gcc test.o -lfoo -o test 与 gcc -lfoo
test.o -o test 都是有区别的
</p>

<p>
正常情况下 -lxx 需要放在 .o 之后, 因为 libxx 是否需要链接进来取决于前面是否有缺
失的符号.
</p>

<p>
gcc -lfoo test.o -o test 时, lfoo 并不会被链接, 因为处理命令行参数 lfoo 时, 当前
并没有解析 test.o, 也就是没有缺失的符号需要从 foo 中链接
</p>

<p>
通过 no-as-needed, 可以强制链接后面的 so
whole-archive 和 no-as-needed 类似, 但它对应的是静态库
</p>

<p>
&#x2013;no-as-needed
</p>

<p>
This option affects ELF DT_NEEDED tags for dynamic libraries mentioned on the
command line after the &#x2013;as-needed option.  Normally the linker will add a
DT_NEEDED tag for each dynamic library mentioned on the command line, regardless
of whether the library is actually needed or not. &#x2013;as-needed causes a DT_NEEDED
tag to only be emitted for a library that at that point in the link satisfies a
non-weak undefined symbol reference from a regular object file or, if the
library is not found in the DT_NEEDED lists of other needed libraries, a
non-weak undefined symbol reference from another needed dynamic library. Object
files or libraries appearing on the command line after the library in question
do not affect whether the library is seen as needed.  This is similar to the
rules for extraction of object files from archives.  &#x2013;no-as-needed restores the
default behaviour.
</p>

<p>
&#x2013;whole-archive
</p>

<p>
For each archive mentioned on the command line after the &#x2013;whole-archive option, include every object file in the archive in the
link, rather than searching the archive for the required object files.  This is normally used to turn an archive file into a shared
library, forcing every object to be included in the resulting shared library.  This option may be used more than once.
</p>

<p>
Two notes when using this option from gcc: First, gcc doesn't know about this option, so you have to use -Wl,-whole-archive.
Second, don't forget to use -Wl,-no-whole-archive after your list of archives, because gcc will add its own list of archives to your
link and you may not want this flag to affect those as well.
</p>


<p>
由于 -lxxx 的先后顺序很重要, 所以 Makefile 的 explicit rule 里有一个单独的
LDLIBS, 用来指定 -lxxx, 用来和 LDFLAGS 区分, 因为 explicit rule 大约是:
</p>

<p>
gcc $CPPFLAGS $CFLAGS $LDFLAGS test.o -o test $LDLIBS
</p>

<p>
以确保 -lxxx 会被放在 test.o 之后
</p>
</div>
</div>

<div id="outline-container-org71e34da" class="outline-3">
<h3 id="org71e34da"><span class="section-number-3">1.11</span> section-start</h3>
</div>

<div id="outline-container-orgbbf4b86" class="outline-3">
<h3 id="orgbbf4b86"><span class="section-number-3">1.12</span> version_script</h3>
<div class="outline-text-3" id="text-1-12">
<p>
<a href="version_script.html#orgd6d38e8">Version Script</a>
</p>
</div>
</div>

<div id="outline-container-orgf1bd90d" class="outline-3">
<h3 id="orgf1bd90d"><span class="section-number-3">1.13</span> soname</h3>
</div>

<div id="outline-container-org030c169" class="outline-3">
<h3 id="org030c169"><span class="section-number-3">1.14</span> Bsymbolic</h3>
</div>

<div id="outline-container-org7da32c3" class="outline-3">
<h3 id="org7da32c3"><span class="section-number-3">1.15</span> dynamic-linker</h3>
</div>

<div id="outline-container-orga96770b" class="outline-3">
<h3 id="orga96770b"><span class="section-number-3">1.16</span> relro</h3>
</div>

<div id="outline-container-org37aa5c3" class="outline-3">
<h3 id="org37aa5c3"><span class="section-number-3">1.17</span> wrap</h3>
<div class="outline-text-3" id="text-1-17">
<p>
如何给重写 malloc 并调用原来的 malloc
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">main.c</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span>** <span style="font-weight: bold; font-style: italic;">argv</span>) {
    malloc(10);
}

<span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">my_malloc.c</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold;">__real_malloc</span>(<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">size</span>);

<span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold;">__wrap_malloc</span>(<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">n</span>) {
    printf(<span style="font-style: italic;">"hello\n"</span>);
    <span style="font-weight: bold;">return</span> __real_malloc(n);
}
</pre>
</div>

<pre class="example" id="orgde9af10">
$&gt; gcc test.c my_malloc.c -Wl,--wrap,malloc -static -g
$&gt; gdb ./a.out
(gdb) disass main
Dump of assembler code for function main:
   0x0000000000401d35 &lt;+0&gt;:     endbr64 
   0x0000000000401d39 &lt;+4&gt;:     push   %rbp
   0x0000000000401d3a &lt;+5&gt;:     mov    %rsp,%rbp
   0x0000000000401d3d &lt;+8&gt;:     sub    $0x10,%rsp
   0x0000000000401d41 &lt;+12&gt;:    mov    %edi,-0x4(%rbp)
   0x0000000000401d44 &lt;+15&gt;:    mov    %rsi,-0x10(%rbp)
   0x0000000000401d48 &lt;+19&gt;:    mov    $0xa,%edi
   0x0000000000401d4d &lt;+24&gt;:    callq  0x401d59 &lt;__wrap_malloc&gt;
   0x0000000000401d52 &lt;+29&gt;:    mov    $0x0,%eax
   0x0000000000401d57 &lt;+34&gt;:    leaveq 
   0x0000000000401d58 &lt;+35&gt;:    retq   
$&gt; (gdb) disass __wrap_malloc
Dump of assembler code for function __wrap_malloc:
   0x0000000000401d59 &lt;+0&gt;:     endbr64 
   0x0000000000401d5d &lt;+4&gt;:     push   %rbp
   0x0000000000401d5e &lt;+5&gt;:     mov    %rsp,%rbp
   0x0000000000401d61 &lt;+8&gt;:     sub    $0x10,%rsp
   0x0000000000401d65 &lt;+12&gt;:    mov    %rdi,-0x8(%rbp)
   0x0000000000401d69 &lt;+16&gt;:    lea    0x93294(%rip),%rdi        # 0x495004
   0x0000000000401d70 &lt;+23&gt;:    callq  0x4118f0 &lt;puts&gt;
   0x0000000000401d75 &lt;+28&gt;:    mov    -0x8(%rbp),%rax
   0x0000000000401d79 &lt;+32&gt;:    mov    %rax,%rdi
   0x0000000000401d7c &lt;+35&gt;:    callq  0x41f1f0 &lt;malloc&gt;
   0x0000000000401d81 &lt;+40&gt;:    leaveq 
   0x0000000000401d82 &lt;+41&gt;:    retq   
End of assembler dump.
</pre>

<p>
通过 `Wl,&#x2013;wrap,malloc`, 所有对 malloc 的调用被 ld 修改为 __wrap_malloc, 且代码
中通过 __readl_malloc 可以引用原来的 malloc
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-08-02 Wed 00:00<br />
Last updated: 2022-01-24 Mon 19:26</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
