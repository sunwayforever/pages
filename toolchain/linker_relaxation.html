<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Linker Relaxation</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linker Relaxation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000010">1. Linker Relaxation</a>
<ul>
<li><a href="#org000000a">1.1. example</a>
<ul>
<li><a href="#org0000000">1.1.1. jalr</a></li>
<li><a href="#org0000007">1.1.2. gp</a></li>
</ul>
</li>
<li><a href="#org000000d">1.2. impls</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000010" class="outline-2">
<h2 id="org0000010"><span class="section-number-2">1</span> Linker Relaxation</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://www.sifive.com/blog/all-aboard-part-3-linker-relaxation-in-riscv-toolchain">https://www.sifive.com/blog/all-aboard-part-3-linker-relaxation-in-riscv-toolchain</a>
(<a href="../extra/All Aboard, Part 3_ Linker Relaxation in the RISC-V Toolchain - SiFive.pdf">local archive</a>)
</p>

<p>
<a href="https://riscv.org/wp-content/uploads/2019/03/11.15-Shiva-Chen-Compiler-Support-For-Linker-Relaxation-in-RISC-V-2019-03-13.pdf">https://riscv.org/wp-content/uploads/2019/03/11.15-Shiva-Chen-Compiler-Support-For-Linker-Relaxation-in-RISC-V-2019-03-13.pdf</a>
(<a href="../extra/11.15-Shiva-Chen-Compiler-Support-For-Linker-Relaxation-in-RISC-V-2019-03-13.pdf">local archive</a>)
</p>

<p>
gcc 编译和优化是以单个 object file 为单位, 导致两个问题:
</p>

<ol class="org-ol">
<li>symbol 的地址在 object file 中无法确定, gcc 必须通过 `auipc/lui` +
`add/load/store/jalr` 多条指令的方式确保 symbol 在最 `远` 的情况下也能访问.</li>

<li>跨 object file 的优化无法实现</li>
</ol>

<p>
为了解决这两个问题, 需要 <a href="static_linker.html#ID-ea089718-c0fc-4484-8da4-e44d5e1007ac">Static Linker</a> 去优化, 前者是 linker relaxation, 后者是
<a href="lto.html#ID-5b11f0d7-9689-4b4c-99ec-86e4a8599921">LTO</a>
</p>

<p>
riscv 中的 linker relaxation 主要有几种方式:
</p>

<ol class="org-ol">
<li>lui+(addi,ld,sw&#x2026;) 替换为 addi,ld,sw&#x2026;</li>

<li>auipc+jalr 替换为 jal</li>

<li>auipc+(addi,ld,sw&#x2026;) 替换为 addi,ld,sw&#x2026;</li>

<li>如果 symbol 在 __global_pointer\$ 附近, 则可以用 gp 做为基址寄存器</li>
</ol>
</div>

<div id="outline-container-org000000a" class="outline-3">
<h3 id="org000000a"><span class="section-number-3">1.1</span> example</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000000" class="outline-4">
<h4 id="org0000000"><span class="section-number-4">1.1.1</span> jalr</h4>
</div>

<div id="outline-container-org0000007" class="outline-4">
<h4 id="org0000007"><span class="section-number-4">1.1.2</span> gp</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
test.S:
</p>

<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> _start
    <span class="org-keyword">.section</span> .text

<span class="org-function-name">_start</span>:
    <span class="org-keyword">la</span> a1,here

    <span class="org-keyword">.section</span> .data
    <span class="org-keyword">.rept</span>   (1&lt;&lt;19)+1
    <span class="org-keyword">.byte</span>   0
    <span class="org-keyword">.endr</span>

    <span class="org-keyword">.section</span> .sdata
<span class="org-function-name">here</span>:
    <span class="org-keyword">ret</span>
</pre>
</div>

<p>
test.lds:
</p>

<pre class="example" id="org0000003">
SECTIONS
{
.text : { *(.text) }
.data : { *(.data) }
.bss : { *(.bss) }
.sdata : { *(.sdata);   __global_pointer$ = .;}
}
</pre>

<p>
没有经过 linker relaxation 的 obj 文件:
</p>

<pre class="example" id="org0000004">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc test.S  -O0 -c
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -D ./test.o

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   # NOTE: 这里显示 0x0 及 mv a1, a1 是因为相关操作数是 0
   # mv a1, a1 实际上是 addi a1, a1, 0 
   0:   00000597                auipc   a1,0x0 
   4:   00058593                mv      a1,a1

Disassembly of section .data:

0000000000000000 &lt;.data&gt;:
        ...

Disassembly of section .sdata:

0000000000000000 &lt;here&gt;:
   0:   8082                    ret

# 通过 objdump -r 可以显示 reloc 信息
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -D -r ./test.o

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:   00000597                auipc   a1,0x0
                        0: R_RISCV_PCREL_HI20   here
                        0: R_RISCV_RELAX        *ABS*
   4:   00058593                mv      a1,a1
                        4: R_RISCV_PCREL_LO12_I .L0 
                        4: R_RISCV_RELAX        *ABS*

Disassembly of section .data:

0000000000000000 &lt;.data&gt;:
        ...

Disassembly of section .sdata:

0000000000000000 &lt;here&gt;:
   0:   8082                    ret
</pre>

<p>
linker relaxation 的结果:
</p>

<pre class="example" id="org0000005">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc test.S  -O0  -nostdlib -T test.lds
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -D ./a.out

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:   ffe18593                addi    a1,gp,-2 # 80005 &lt;here&gt;

Disassembly of section .data:

0000000000000004 &lt;.data&gt;:
        ...

Disassembly of section .sdata:

0000000000080005 &lt;here&gt;:
   80005:       8082                    ret
</pre>

<p>
lds 中必须有定义 __global_pointer\$ 才可以使用基于 gp 的 relaxation. gcc 自带的
linker script 里 __global_pointer\$ 定义为:
</p>

<pre class="example" id="org0000006">
__global_pointer$ = MIN(__SDATA_BEGIN__ + 0x800,
                         MAX(__DATA_BEGIN__ + 0x800, __BSS_END__ - 0x800));
</pre>

<p>
其中的 0x800 使得通过 gp 可以访问 \_\_SDATA_BEGIN\_&ensp;开始的 13-bit 地址范围 (因为 riscv 中 imm 是有符号数)
</p>

<p>
另外, 基于 gp 的 relaxation 不适用于 call 指令
</p>
</div>
</div>
</div>

<div id="outline-container-org000000d" class="outline-3">
<h3 id="org000000d"><span class="section-number-3">1.2</span> impls</h3>
</div>
</div>


<div id="outline-container-org0000013" class="outline-2 references">
<h2 id="org0000013">Backlinks</h2>
<div class="outline-text-2" id="text-org0000013">
<p>
<a href="retargeting_gcc_to_riscv.html#ID-303d0f7f-03c2-4f31-ad7e-064162e3af10">Retargeting GCC To RISC-V</a>
(<i>Retargeting GCC To RISC-V &gt; binutils &gt; as &gt; macro</i>):  riscv_call 生成了 `auipc+jalr`, 因为 assembler 无法知道跳转的范围有多大, 用 auipc+jalr 是最保险的做法, 在 link 阶段通过 <a href="linker_relaxation.html#ID-b861e156-7ced-4e25-b047-455b5b075c1e">linker relaxation</a> 有可能会把它换成 jal
</p>

<p>
<a href="static_linker.html#ID-ea089718-c0fc-4484-8da4-e44d5e1007ac">Static Linker</a>
(<i>Static Linker &gt; Linker Relaxation</i>):   <a href="linker_relaxation.html#ID-b861e156-7ced-4e25-b047-455b5b075c1e">Linker Relaxation</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-04-06 Wed 19:22<br />
Last updated: 2022-04-07 Thu 10:18</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
