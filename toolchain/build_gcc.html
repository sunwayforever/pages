<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Build GCC Cross Compiler</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Build GCC Cross Compiler</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org000000b">1. Build GCC Cross Compiler</a>
<ul>
<li><a href="#org0000001">1.1. stage 1</a></li>
<li><a href="#org0000005">1.2. stage 2</a></li>
<li><a href="#org0000008">1.3. disable-bootstrap</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000000b" class="outline-2">
<h2 id="org000000b"><span class="section-number-2">1</span> Build GCC Cross Compiler</h2>
<div class="outline-text-2" id="text-1">
<p>
build gcc cross compiler 的步骤为:
</p>

<ol class="org-ol">
<li>build binutils</li>

<li>build gcc (stage 1)</li>

<li>build libc</li>

<li>build gcc (stage 2)</li>
</ol>

<p>
之所以需要编译两次 gcc, 主要是因为 gcc 代码不仅包含 gcc, 还包含许多其它的 lib,
例如 libatomic, libstdc++, libgcc 等, 这些库或多或少会依赖 libc.
</p>

<p>
因此需要
</p>

<ol class="org-ol">
<li>通过 stage 1 用 host gcc 编译出一个单独的 cross gcc</li>

<li>然后用编译出来的 cross gcc 编译 target libc</li>

<li>最后通过 stage 2 用 cross gcc 编译 target libatomic 等</li>
</ol>
</div>

<div id="outline-container-org0000001" class="outline-3">
<h3 id="org0000001"><span class="section-number-3">1.1</span> stage 1</h3>
<div class="outline-text-3" id="text-1-1">
<pre class="example" id="org0000000">
stamps/build-gcc-linux-stage1: $(GCC_SRCDIR) $(GCC_SRC_GIT) stamps/build-binutils-linux \
                               stamps/build-linux-headers
    cd $(notdir $@) &amp;&amp; $&lt;/configure \
        --target=$(LINUX_TUPLE) \
        $(CONFIGURE_HOST) \
        --prefix=$(INSTALL_DIR) \
        --with-sysroot=$(SYSROOT) \
        --with-newlib \
        --without-headers \
        --disable-shared \
        --disable-threads \
        --with-system-zlib \
        --enable-tls \
        --enable-languages=c \
        --disable-libatomic \
        --disable-libmudflap \
        --disable-libssp \
        --disable-libquadmath \
        --disable-libgomp \
        --disable-nls \
        --disable-bootstrap \
        --src=$(gccsrcdir) 
    # 这里 make all-gcc 而没是 make all-target, 所以 target 相关的例如 libatomic 不会被编译
    $(MAKE) -C $(notdir $@) inhibit-libc=true all-gcc
    $(MAKE) -C $(notdir $@) inhibit-libc=true install-gcc
    $(MAKE) -C $(notdir $@) inhibit-libc=true all-target-libgcc
    $(MAKE) -C $(notdir $@) inhibit-libc=true install-target-libgcc

</pre>
</div>
</div>

<div id="outline-container-org0000005" class="outline-3">
<h3 id="org0000005"><span class="section-number-3">1.2</span> stage 2</h3>
<div class="outline-text-3" id="text-1-2">
<pre class="example" id="org0000004">
stamps/build-gcc-linux-stage2: $(GCC_SRCDIR) $(GCC_SRC_GIT) $(addprefix stamps/build-glibc-linux-,$(GLIBC_MULTILIB_NAMES)) \
                               stamps/build-glibc-linux-headers
    cd $(notdir $@) &amp;&amp; $&lt;/configure \
        --target=$(LINUX_TUPLE) \
        $(CONFIGURE_HOST) \
        --prefix=$(INSTALL_DIR) \
        --with-sysroot=$(SYSROOT) \
        --with-pkgversion="$(GCCPKGVER)" \
        --with-system-zlib \
        --enable-shared \
        --enable-tls \
        --enable-languages=c,c++,fortran \
        --disable-libmudflap \
        --disable-libssp \
        --disable-libquadmath \
        --disable-libsanitizer \
        --disable-nls \
        --disable-bootstrap \
        --src=$(gccsrcdir) 
    # libc.so 已经在 sysroot 中, 可能 make all-target 了
    $(MAKE) -C $(notdir $@)
    $(MAKE) -C $(notdir $@) install
    cp -a $(INSTALL_DIR)/$(LINUX_TUPLE)/lib* $(SYSROOT)


</pre>
</div>
</div>

<div id="outline-container-org0000008" class="outline-3">
<h3 id="org0000008"><span class="section-number-3">1.3</span> disable-bootstrap</h3>
<div class="outline-text-3" id="text-1-3">
<p>
默认情况下编译 gcc 时会通过 3 个 stage 确定 gcc 编译的没有问题, 例如现在需要用
gcc 4 编译 gcc 9:
</p>

<ol class="org-ol">
<li>使用 gcc 4 编译出一个 gcc 9 (a)</li>
<li>使用 a 编译出另一个 gcc 9 (b)</li>
<li>使用 b 再编译一个 gcc 9 (c), 并确认一下 b 和 c 是相同的</li>
</ol>

<p>
在交叉编译时, b 通常不能在当前平台运行, 所以交叉编译时通常通过 disable-bootstrap
只执行 stage 1
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-03-22 Tue 13:39<br />
Last updated: 2022-03-22 Tue 15:05</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
