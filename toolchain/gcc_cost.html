<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GCC Cost</title>


<link rel="stylesheet" type="text/css" href="/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="./htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="./readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
</head>
<body>
<div id="content" class="content">
<h1 class="title">GCC Cost</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0000020">1. GCC Cost</a>
<ul>
<li><a href="#ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3">1.1. TARGET_RTX_COSTS</a></li>
<li><a href="#ID-2c365cee-bb91-4b01-a9b2-e2aff0c3e475">1.2. mtune</a>
<ul>
<li><a href="#org0000017">1.2.1. riscv_tune_param</a></li>
<li><a href="#org000001a">1.2.2. microarchitecture</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000020" class="outline-2">
<h2 id="org0000020"><span class="section-number-2">1.</span> GCC Cost</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://kristerw.blogspot.com/2018/01/gcc-back-end-performance-tuning.html">https://kristerw.blogspot.com/2018/01/gcc-back-end-performance-tuning.html</a>
</p>

<p>
<a href="https://gcc.gnu.org/onlinedocs/gcc-3.4.6/gccint/Costs.html">https://gcc.gnu.org/onlinedocs/gcc-3.4.6/gccint/Costs.html</a>
</p>

<p>
gcc cost model 是指 gcc 会考虑 arch 执行不同指令的代价, 以决定是否执行某些优化
</p>
</div>

<div id="outline-container-ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3" class="outline-3">
<h3 id="ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3"><span class="section-number-3">1.1.</span> TARGET_RTX_COSTS</h3>
<div class="outline-text-3" id="text-1-1">
<p>
以 <a href="gcc_expand_mult.html#ID-5cd7feb7-6e6c-47b5-b63c-6465c8354c1a">GCC Expand Mult</a> 为例, gcc 决定 mul 是否 expand 成 shift 时, 需要通过
TARGET_RTX_COSTS 这个 来找到各个 insn 的 cost, 例如, 如果 `x*12`
的 cost 小于 `(x&lt;&lt;1+x)&lt;&lt;2` 的 cost, 则这个 expand不会进行
</p>

<p>
riscv 的 TARGET_RTX_COSTS 实现在 riscv_rtx_costs:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">bool</span> <span class="org-function-name">riscv_rtx_costs</span><span class="org-parenthesis">(</span>
    <span class="org-type">rtx</span> <span class="org-variable-name">x</span><span class="org-parenthesis">,</span> <span class="org-type">machine_mode</span> <span class="org-variable-name">mode</span><span class="org-parenthesis">,</span> <span class="org-type">int</span> <span class="org-variable-name">outer_code</span><span class="org-parenthesis">,</span> <span class="org-type">int</span> <span class="org-variable-name">opno</span> ATTRIBUTE_UNUSED<span class="org-parenthesis">,</span>
    <span class="org-type">int</span> *<span class="org-variable-name">total</span><span class="org-parenthesis">,</span> <span class="org-type">bool</span> <span class="org-variable-name">speed</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-type">bool</span> <span class="org-variable-name">float_mode_p</span> = FLOAT_MODE_P<span class="org-parenthesis">(</span>mode<span class="org-parenthesis">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">cost</span>;

    <span class="org-keyword">switch</span> <span class="org-parenthesis">(</span>GET_CODE<span class="org-parenthesis">(</span>x<span class="org-parenthesis">))</span> <span class="org-parenthesis">{</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">case</span> ASHIFT:
        <span class="org-keyword">case</span> ASHIFTRT:
        <span class="org-keyword">case</span> LSHIFTRT:
            *total = riscv_binary_cost<span class="org-parenthesis">(</span>
                x<span class="org-parenthesis">,</span> SINGLE_SHIFT_COST<span class="org-parenthesis">,</span> CONSTANT_P<span class="org-parenthesis">(</span>XEXP<span class="org-parenthesis">(</span>x<span class="org-parenthesis">,</span> 1<span class="org-parenthesis">))</span> ? 4 : 9<span class="org-parenthesis">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">case</span> MINUS:
        <span class="org-keyword">case</span> PLUS:
            <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>float_mode_p<span class="org-parenthesis">)</span>
                <span class="org-comment-delimiter">/* </span><span class="org-comment">tune_param &#26159;&#26681;&#25454; -mtune=xxx &#21442;&#25968;&#20915;&#23450;&#30340;, &#20363;&#22914; xxx &#20026;</span>
<span class="org-comment">                 * sifive-7-series</span><span class="org-comment-delimiter"> */</span>
                *total = tune_param-&gt;fp_add[mode == DFmode];
            <span class="org-keyword">else</span>
                *total = riscv_binary_cost<span class="org-parenthesis">(</span>x<span class="org-parenthesis">,</span> 1<span class="org-parenthesis">,</span> 4<span class="org-parenthesis">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">case</span> MULT:
            <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>float_mode_p<span class="org-parenthesis">)</span>
                *total = tune_param-&gt;fp_mul[mode == DFmode];
            <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>TARGET_MUL<span class="org-parenthesis">)</span>
                <span class="org-comment-delimiter">/* </span><span class="org-comment">Estimate the cost of a library call.</span><span class="org-comment-delimiter">  */</span>
                *total = COSTS_N_INSNS<span class="org-parenthesis">(</span>speed ? 32 : 6<span class="org-parenthesis">)</span>;
            <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>GET_MODE_SIZE<span class="org-parenthesis">(</span>mode<span class="org-parenthesis">)</span> &gt; UNITS_PER_WORD<span class="org-parenthesis">)</span>
                *total = 3 * tune_param-&gt;int_mul[0] + COSTS_N_INSNS<span class="org-parenthesis">(</span>2<span class="org-parenthesis">)</span>;
            <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>speed<span class="org-parenthesis">)</span>
                *total = COSTS_N_INSNS<span class="org-parenthesis">(</span>1<span class="org-parenthesis">)</span>;
            <span class="org-keyword">else</span>
                *total = tune_param-&gt;int_mul[mode == DImode];
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">default</span>:
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;
    <span class="org-parenthesis">}</span>
<span class="org-parenthesis">}</span>
</pre>
</div>
</div>


<div id="outline-container-org0000023" class="outline-4 references">
<h4 id="org0000023">Backlinks</h4>
<div class="outline-text-4" id="text-org0000023">
<p>
<a href="gcc_expand_mult.html#ID-5cd7feb7-6e6c-47b5-b63c-6465c8354c1a">GCC Expand Mult</a>
(<i>GCC Expand Mult &gt; impls &gt; set_src_cost</i>):  set_src_cost 最终会调用到 <a href="#ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3">TARGET_RTX_COSTS</a> 这个 target hook
</p>

<p>
<a href="gcc_target_hook.html#ID-ecd308f9-413b-467a-8d55-10bd7485a2bc">GCC Target Hook</a>
(<i>GCC Target Hook &gt; cost 相关 &gt; TARGET_RTX_COSTS</i>):   <a href="#ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3">TARGET_RTX_COSTS</a>
</p>
</div>
</div>
</div>


<div id="outline-container-ID-2c365cee-bb91-4b01-a9b2-e2aff0c3e475" class="outline-3">
<h3 id="ID-2c365cee-bb91-4b01-a9b2-e2aff0c3e475"><span class="section-number-3">1.2.</span> mtune</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<a href="https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html">https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html</a>
</p>

<p>
riscv_rtx_costs 会使用 `mtune` 参数定义的 tune_param 中 cost.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">riscv_tune_info</span> <span class="org-variable-name">riscv_tune_info_table</span>[] = <span class="org-parenthesis">{</span>
  <span class="org-comment-delimiter">/* </span><span class="org-comment">name,    microarchitecture,  riscv_tune_param</span><span class="org-comment-delimiter"> */</span>
  <span class="org-parenthesis">{</span> <span class="org-string">"rocket"</span><span class="org-parenthesis">,</span> generic<span class="org-parenthesis">,</span> &amp;rocket_tune_info <span class="org-parenthesis">},</span>
  <span class="org-parenthesis">{</span> <span class="org-string">"sifive-3-series"</span><span class="org-parenthesis">,</span> generic<span class="org-parenthesis">,</span> &amp;rocket_tune_info <span class="org-parenthesis">},</span>
  <span class="org-parenthesis">{</span> <span class="org-string">"sifive-5-series"</span><span class="org-parenthesis">,</span> generic<span class="org-parenthesis">,</span> &amp;rocket_tune_info <span class="org-parenthesis">},</span>
  <span class="org-parenthesis">{</span> <span class="org-string">"sifive-7-series"</span><span class="org-parenthesis">,</span> sifive_7<span class="org-parenthesis">,</span> &amp;sifive_7_tune_info <span class="org-parenthesis">},</span>
  <span class="org-parenthesis">{</span> <span class="org-string">"size"</span><span class="org-parenthesis">,</span> generic<span class="org-parenthesis">,</span> &amp;optimize_size_tune_info <span class="org-parenthesis">},</span>
<span class="org-parenthesis">}</span>;
</pre>
</div>
</div>

<div id="outline-container-org0000017" class="outline-4">
<h4 id="org0000017"><span class="section-number-4">1.2.1.</span> riscv_tune_param</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
以 `-mtune=sifive-7-series` 为例, 其对应的 tune_param 为
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">riscv_tune_param</span> <span class="org-variable-name">rocket_tune_info</span> = <span class="org-parenthesis">{</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_add(SFMode) &#30340; cost &#30456;&#24403;&#20110; 4 &#20010; nop</span><span class="org-comment-delimiter"> */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_add(DFMode) &#30340; cost &#30456;&#24403;&#20110; 5 &#20010; nop</span><span class="org-comment-delimiter"> */</span>
    <span class="org-parenthesis">{</span>COSTS_N_INSNS<span class="org-parenthesis">(</span>4<span class="org-parenthesis">),</span> COSTS_N_INSNS<span class="org-parenthesis">(</span>5<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_add</span><span class="org-comment-delimiter"> */</span>
    <span class="org-parenthesis">{</span>COSTS_N_INSNS<span class="org-parenthesis">(</span>4<span class="org-parenthesis">),</span> COSTS_N_INSNS<span class="org-parenthesis">(</span>5<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_mul</span><span class="org-comment-delimiter"> */</span>
    <span class="org-parenthesis">{</span>COSTS_N_INSNS<span class="org-parenthesis">(</span>20<span class="org-parenthesis">),</span> COSTS_N_INSNS<span class="org-parenthesis">(</span>20<span class="org-parenthesis">)},</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_div</span><span class="org-comment-delimiter"> */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">int_mul(SIMode) &#30456;&#24403;&#20110; 4 &#20010; nop</span><span class="org-comment-delimiter"> */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">int_mul(DIMode) &#30456;&#24403;&#20110; 4 &#20010; nop</span><span class="org-comment-delimiter"> */</span>
    <span class="org-parenthesis">{</span>COSTS_N_INSNS<span class="org-parenthesis">(</span>4<span class="org-parenthesis">),</span> COSTS_N_INSNS<span class="org-parenthesis">(</span>4<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">int_mul</span><span class="org-comment-delimiter"> */</span>
    <span class="org-parenthesis">{</span>COSTS_N_INSNS<span class="org-parenthesis">(</span>6<span class="org-parenthesis">),</span> COSTS_N_INSNS<span class="org-parenthesis">(</span>6<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">int_div</span><span class="org-comment-delimiter"> */</span>
    1<span class="org-parenthesis">,</span>                                      <span class="org-comment-delimiter">/* </span><span class="org-comment">issue_rate</span><span class="org-comment-delimiter"> */</span>
    3<span class="org-parenthesis">,</span>                                      <span class="org-comment-delimiter">/* </span><span class="org-comment">branch_cost</span><span class="org-comment-delimiter"> */</span>
    5<span class="org-parenthesis">,</span>                                      <span class="org-comment-delimiter">/* </span><span class="org-comment">memory_cost</span><span class="org-comment-delimiter"> */</span>
    <span class="org-constant">true</span><span class="org-parenthesis">,</span>                                   <span class="org-comment-delimiter">/* </span><span class="org-comment">slow_unaligned_access</span><span class="org-comment-delimiter"> */</span>
<span class="org-parenthesis">}</span>;
</pre>
</div>

<p>
mtune 参数有一个特殊的选项叫 `size`, 它对应的 tune_param 为
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">riscv_tune_param</span> <span class="org-variable-name">optimize_size_tune_info</span> = <span class="org-parenthesis">{</span>
  <span class="org-parenthesis">{</span>COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">),</span> COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_add</span><span class="org-comment-delimiter"> */</span>
  <span class="org-parenthesis">{</span>COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">),</span> COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_mul</span><span class="org-comment-delimiter"> */</span>
  <span class="org-parenthesis">{</span>COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">),</span> COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">fp_div</span><span class="org-comment-delimiter"> */</span>
  <span class="org-parenthesis">{</span>COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">),</span> COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">int_mul</span><span class="org-comment-delimiter"> */</span>
  <span class="org-parenthesis">{</span>COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">),</span> COSTS_N_INSNS <span class="org-parenthesis">(</span>1<span class="org-parenthesis">)},</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">int_div</span><span class="org-comment-delimiter"> */</span>
  1<span class="org-parenthesis">,</span>                        <span class="org-comment-delimiter">/* </span><span class="org-comment">issue_rate</span><span class="org-comment-delimiter"> */</span>
  1<span class="org-parenthesis">,</span>                        <span class="org-comment-delimiter">/* </span><span class="org-comment">branch_cost</span><span class="org-comment-delimiter"> */</span>
  2<span class="org-parenthesis">,</span>                        <span class="org-comment-delimiter">/* </span><span class="org-comment">memory_cost</span><span class="org-comment-delimiter"> */</span>
  <span class="org-constant">false</span><span class="org-parenthesis">,</span>                    <span class="org-comment-delimiter">/* </span><span class="org-comment">slow_unaligned_access</span><span class="org-comment-delimiter"> */</span>
<span class="org-parenthesis">}</span>;
</pre>
</div>

<p>
可见大部分的 cost 都很小, 这会导致许多基于 cost 的优化不会工作, 因为这些优化通常都会生成更多的 insn
</p>

<p>
另外, `-Os` 会强制 mtune 为 size:
</p>

<div class="org-src-container">
<pre class="src src-C">cpu = riscv_parse_tune<span class="org-parenthesis">(</span>
    riscv_tune_string
        ? riscv_tune_string
        : <span class="org-parenthesis">(</span>riscv_cpu_string ? riscv_cpu_string : RISCV_TUNE_STRING_DEFAULT<span class="org-parenthesis">))</span>;
<span class="org-comment-delimiter">/*</span><span class="org-comment"><span class="org-hl-todo"><span class="custom">NOTE</span></span></span><span class="org-comment">: -Os &#26102; optimize_size &#20026; true</span><span class="org-comment-delimiter"> */</span>
tune_param = optimize_size ? &amp;optimize_size_tune_info : cpu-&gt;tune_param;
</pre>
</div>
</div>

<div id="outline-container-org0000003" class="outline-5">
<h5 id="org0000003"><span class="section-number-5">1.2.1.1.</span> fp_add/fp_mul/fp_div/int_mul/int_div</h5>
<div class="outline-text-5" id="text-1-2-1-1">
<p>
表示执行 fp_add 等操作的 cost, 例如 <a href="gcc_expand_mult.html#ID-5cd7feb7-6e6c-47b5-b63c-6465c8354c1a">GCC Expand Mult</a> 会使用这个 cost 决定 mul 是否转换成 shift
</p>
</div>
</div>

<div id="outline-container-ID-98f35525-3f8c-4f76-8478-6cab3f3182be" class="outline-5">
<h5 id="ID-98f35525-3f8c-4f76-8478-6cab3f3182be"><span class="section-number-5">1.2.1.2.</span> slow_unaligned_access</h5>
<div class="outline-text-5" id="text-1-2-1-2">
<p>
TARGET_SLOW_UNALIGNED_ACCESS 会使用这个 tune_param
</p>

<p>
表示 arch 的 unaligned access 是否是 slow, 例如:
</p>

<div class="org-src-container">
<pre class="src src-C">  <span class="org-keyword">struct</span> <span class="org-keyword">__attribute__</span><span class="org-parenthesis">((</span><span class="org-type">packed</span><span class="org-parenthesis">))</span> <span class="org-type">X</span> <span class="org-parenthesis">{</span>
      <span class="org-type">short</span> <span class="org-variable-name">a</span>;
      <span class="org-type">int</span> <span class="org-variable-name">b</span>;
  <span class="org-parenthesis">}</span>;
-
  <span class="org-type">void</span> foo<span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">x</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      <span class="org-keyword">struct</span> <span class="org-type">X</span> <span class="org-variable-name">z</span>;
      z.a = 1;
      z.b = 2;
  <span class="org-parenthesis">}</span>
</pre>
</div>

<p>
默认情况下 slow_unaligned_access 为 true, 导致针对 z.b 的访问不会通过 sw 指令,
而要通过两个 sh
</p>

<pre class="example" id="org0000006">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O0  -c
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./test.o

0000000000000000 &lt;foo&gt;:
   0:   7179                    addi    sp,sp,-48
   2:   f422                    sd      s0,40(sp)
   4:   1800                    addi    s0,sp,48
   6:   87aa                    mv      a5,a0
   8:   fcf42e23                sw      a5,-36(s0)
   c:   4785                    li      a5,1
   e:   fef41423                sh      a5,-24(s0)

  12:   fea45783                lhu     a5,-22(s0)
  16:   8b81                    andi    a5,a5,0
  18:   0027e793                ori     a5,a5,2
  1c:   fef41523                sh      a5,-22(s0)

  20:   fec45783                lhu     a5,-20(s0)
  24:   8b81                    andi    a5,a5,0
  26:   fef41623                sh      a5,-20(s0)
  2a:   0001                    nop
  2c:   7422                    ld      s0,40(sp)
  2e:   6145                    addi    sp,sp,48
  30:   8082                    ret
</pre>

<p>
riscv 上指定 `-mtune=size` 使 slow_unaligned_access 为 false, 则 gcc 会使用 sw
访问没有对齐的 z.b
</p>

<pre class="example" id="org0000007">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O0  -c -mtune=size
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./test.o

0000000000000000 &lt;foo&gt;:
   0:   7179                    addi    sp,sp,-48
   2:   f422                    sd      s0,40(sp)
   4:   1800                    addi    s0,sp,48
   6:   87aa                    mv      a5,a0
   8:   fcf42e23                sw      a5,-36(s0)
   c:   4785                    li      a5,1
   e:   fef41423                sh      a5,-24(s0)
  12:   4789                    li      a5,2
  14:   fef42523                sw      a5,-22(s0)
  18:   0001                    nop
  1a:   7422                    ld      s0,40(sp)
  1c:   6145                    addi    sp,sp,48
  1e:   8082                    ret
</pre>

<p>
另外, 通过 `-mstrict-align` 可以忽略 slow_unaligned_access
</p>

<p>
上面例子的实现在 expand_assignment, 它会考虑 slow_unaligned_access 决定
store_bit_field 时生成 `and, or&#x2026;` 来操作 bitfield (具体代码在
store_fixed_bit_field_1) 还是直接 `sw`
</p>
</div>


<div id="outline-container-org0000008" class="outline-6 references">
<h6 id="org0000008">Backlinks</h6>
<div class="outline-text-6" id="text-org0000008">
<p>
<a href="gcc_target_hook.html#ID-ecd308f9-413b-467a-8d55-10bd7485a2bc">GCC Target Hook</a>
(<i>GCC Target Hook &gt; cost 相关 &gt; TARGET_SLOW_UNALIGNED_ACCESS</i>):   <a href="#ID-98f35525-3f8c-4f76-8478-6cab3f3182be">TARGET_SLOW_UNALIGNED_ACCESS</a>
</p>

<p>
<a href="../unaligned_memory_access.html#ID-3b293895-b3de-4368-9785-29b2bf0161fe">Unaligned Memory Access</a>
(<i>Unaligned Memory Access</i>):  如果编译器能判断出当前指令是 UMA, 则会根据 <a href="#ID-98f35525-3f8c-4f76-8478-6cab3f3182be">slow_unaligned_access</a> 和 `-mstrict-align` 参数决定对于 UMA 是直接生成 load/store 指令还是通过其它多条指令. 例如, 为了支持非对齐的 sw, 编译器可能会使用 4 条 sb 指令
</p>
</div>
</div>
</div>


<div id="outline-container-org000000b" class="outline-5">
<h5 id="org000000b"><span class="section-number-5">1.2.1.3.</span> issue_rate</h5>
<div class="outline-text-5" id="text-1-2-1-3">
<p>
<a href="gcc_scheduler.html#ID-38916ef6-f300-47db-8c70-41e3256af352">TARGET_SCHED_ISSUE_RATE</a> 会使用这个 tune_param
</p>
</div>
</div>

<div id="outline-container-ID-f497b668-4fa4-4876-845b-134dd50783e2" class="outline-5">
<h5 id="ID-f497b668-4fa4-4876-845b-134dd50783e2"><span class="section-number-5">1.2.1.4.</span> branch_cost</h5>
<div class="outline-text-5" id="text-1-2-1-4">
<p>
以 `abs(x)` 为例, expand_abs 时会根据 branch_cost 决定生成 `if (x&lt;0) {-x} else
{x}` 还是通过其它位运算的形式得到 abs(x)
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">foo</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">k</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span> <span class="org-keyword">return</span> abs<span class="org-parenthesis">(</span>k<span class="org-parenthesis">)</span>; <span class="org-parenthesis">}</span>
</pre>
</div>

<p>
当增大 branch_cost 时会生成这样的代码:
</p>

<pre class="example" id="org000000e">
0000000000000000 &lt;foo&gt;:
   0:   41f5579b                sraiw   a5,a0,0x1f
   4:   8d3d                    xor     a0,a0,a5
   6:   9d1d                    subw    a0,a0,a5
   8:   8082                    ret
</pre>

<p>
当减小 branch_cost 时会生成使用 branch 的代码:
</p>

<pre class="example" id="org000000f">
0000000000000000 &lt;foo&gt;:
   0:   87aa                    mv      a5,a0
   2:   00055463                bgez    a0,a &lt;.L2&gt;
   6:   40a007bb                negw    a5,a0

000000000000000a &lt;.L2&gt;:
   a:   0007851b                sext.w  a0,a5
   e:   8082                    ret
</pre>

<p>
另外, 上面这个例子也展示了 gcc builtin 的好处:
</p>

<p>
gcc builtin 里包含了一些常用的数学函数例如 abs, 当使用 builtin 的 abs 时, gcc 的
expand_abs 可以根据 branch_cost 决定生成什么样的代码, 但 libc 的 abs 则没有这种灵活性
</p>

<p>
虽然使用 mtune=size 把 branch_cost 设为 1, 但 libc 的 abs 的实现是固定的, 不会改变.
</p>

<pre class="example" id="org0000010">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O2   -fno-builtin -nostartfiles -static -mtune=size
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./a.out

00000000000100b0 &lt;foo&gt;:
   100b0:       a009                    j       100b2 &lt;abs&gt;

00000000000100b2 &lt;abs&gt;:
   100b2:       41f5579b                sraiw   a5,a0,0x1f
   100b6:       8d3d                    xor     a0,a0,a5
   100b8:       9d1d                    subw    a0,a0,a5
   100ba:       8082                    ret
</pre>

<p>
另外, <a href="gcc_pass.html#ID-5ca8cde0-446c-44da-b8fc-88510806ace8">pass_data_tree_ifcombine</a> 也会考虑 branch_cost 的影响: 当 branch_cost 较大时, 会把 `if (a) {if (b) {}}` 优化成 `if (a&amp;b)`
</p>
</div>


<div id="outline-container-org0000011" class="outline-6 references">
<h6 id="org0000011">Backlinks</h6>
<div class="outline-text-6" id="text-org0000011">
<p>
<a href="gcc_builtin.html#ID-b9dd7f04-f7f7-4a70-8f00-9e446df3339e">GCC Builtin</a>
(<i>GCC Builtin &gt; builtin optimization</i>):  另外, builtin 还可以利用 mtune 信息产生针对某一个 tune 的优化代码, 但 libc 中只 能产生针对某个 arch 的 `通用` 代码. 例如 <a href="#ID-f497b668-4fa4-4876-845b-134dd50783e2">branch_cost</a>
</p>
</div>
</div>
</div>


<div id="outline-container-org0000014" class="outline-5">
<h5 id="org0000014"><span class="section-number-5">1.2.1.5.</span> memory_cost</h5>
<div class="outline-text-5" id="text-1-2-1-5">
<div class="org-src-container">
<pre class="src src-C"><span class="org-constant">riscv_rtx_costs</span>:
    <span class="org-comment-delimiter">/*</span><span class="org-comment">...</span><span class="org-comment-delimiter">*/</span>
    <span class="org-keyword">case</span> MEM:
        <span class="org-comment-delimiter">/* </span><span class="org-comment">addressing cost, &#20363;&#22914; lui/auipc/got/</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">if</span> <span class="org-parenthesis">((</span>cost = riscv_address_insns<span class="org-parenthesis">(</span>XEXP<span class="org-parenthesis">(</span>x<span class="org-parenthesis">,</span> 0<span class="org-parenthesis">),</span> mode<span class="org-parenthesis">,</span> <span class="org-constant">true</span><span class="org-parenthesis">))</span> &gt; 0<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
            <span class="org-comment-delimiter">/* </span><span class="org-comment">memory cost</span><span class="org-comment-delimiter"> */</span>
            *total = COSTS_N_INSNS<span class="org-parenthesis">(</span>cost + tune_param-&gt;memory_cost<span class="org-parenthesis">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">true</span>;
        <span class="org-parenthesis">}</span>
    <span class="org-comment-delimiter">/*</span><span class="org-comment">...</span><span class="org-comment-delimiter">*/</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000001a" class="outline-4">
<h4 id="org000001a"><span class="section-number-4">1.2.2.</span> microarchitecture</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
<a href="gcc_scheduler.html#ID-83e0d370-1b5f-49c6-b151-46a9e108d076">microarchitecture</a> 主要是在 md 中定义 insn-latency 供 scheduler 使用
</p>
</div>
</div>


<div id="outline-container-org000001d" class="outline-4 references">
<h4 id="org000001d">Backlinks</h4>
<div class="outline-text-4" id="text-org000001d">
<p>
<a href="gcc_backend.html#ID-02e7f924-9cf7-4e3d-8ceb-1765fd3a2bed">GCC Backend</a>
(<i>GCC Backend &gt; misc &gt; mcpu/mtune/march/mabi &gt; mtune</i>):   <a href="#ID-2c365cee-bb91-4b01-a9b2-e2aff0c3e475">mtune</a>
</p>

<p>
<a href="llvm_backend.html#ID-e60ce82f-6f66-44e0-adb5-cef752145625">LLVM Backend</a>
(<i>LLVM Backend &gt; instruction selection &gt; 指令调度 &gt; mtune</i>):  这个定义与 <a href="#ID-2c365cee-bb91-4b01-a9b2-e2aff0c3e475">gcc mtune</a> 类似, 例如 IssueWidth 对应 gcc issue_rate, LoadLatency 对应 memory_cost? MispredictPenalty 对应 branch_cost?
</p>
</div>
</div>
</div>
</div>



<div id="outline-container-org0000024" class="outline-2 references">
<h2 id="org0000024">Backlinks</h2>
<div class="outline-text-2" id="text-org0000024">
<p>
<a href="gcc.html#ID-19df5597-4fd4-47a1-9534-f6e0c327e8d5">GCC</a>
(<i>GCC &gt; Cost</i>):   <a href="gcc_cost.html#ID-2599fa0b-be86-4b12-a480-ee638a440b1d">Cost</a>
</p>

<p>
<a href="gcc_target_hook.html#ID-ecd308f9-413b-467a-8d55-10bd7485a2bc">GCC Target Hook</a>
(<i>GCC Target Hook &gt; cost 相关</i>):   <a href="gcc_cost.html#ID-2599fa0b-be86-4b12-a480-ee638a440b1d">cost</a> 相关
</p>

<p>
<a href="gcc_scheduler.html#ID-83e0d370-1b5f-49c6-b151-46a9e108d076">microarchitecture</a>
(<i>GCC Scheduler &gt; microarchitecture</i>):  scheduler 工作时需要一个关键信息是指令的 latency, 例如 `sqrtsf2` 的 latency 在 sifive-3 是 25, 在 sifive-7 是 27, 这个值看起来和 <a href="gcc_cost.html#ID-2599fa0b-be86-4b12-a480-ee638a440b1d">GCC Cost</a> 有点类似?
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway@dogdog.run<br />
Date: 2022-04-24 Sun 15:49<br />
Last updated: 2023-08-17 Thu 14:22</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</div>
</body>
</html>