<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Linker Relocation</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linker Relocation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000022">1. Linker Relocation</a>
<ul>
<li><a href="#org0000009">1.1. example</a>
<ul>
<li><a href="#org0000001">1.1.1. la relocation</a></li>
<li><a href="#ID-119c2664-36d0-4cf5-ae13-0686350c3df8">1.1.2. jal relocation</a></li>
</ul>
</li>
<li><a href="#org000001f">1.2. riscv relocation</a>
<ul>
<li><a href="#org000000d">1.2.1. R_RISCV_PCREL_HI2</a></li>
<li><a href="#org0000011">1.2.2. R_RISCV_PCREL_LO12</a></li>
<li><a href="#org0000015">1.2.3. R_RISCV_HI20</a></li>
<li><a href="#org0000018">1.2.4. R_RISCV_RELAX</a></li>
<li><a href="#org000001c">1.2.5. R_RISCV_JAL</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000022" class="outline-2">
<h2 id="org0000022"><span class="section-number-2">1</span> Linker Relocation</h2>
<div class="outline-text-2" id="text-1">
<p>
编译器生成 object file 时, symbol 地址在 assembling 阶段无法确定, assembler 只能通过 <a href="bfd.html#ID-7569396e-eef7-485b-a1eb-8a545dec44ba">BFD</a> 写入重定位信息, 后面需要 link edtitor 进行 relocation
</p>

<p>
symbol 可以使用不同的 reloc_type, 例如:
</p>

<ul class="org-ul">
<li>使用绝对地址</li>

<li><p>
PCREL
</p>

<p>
pc-relative 地址, PCREL 对 <a href="pie.html#ID-d43ec148-ed52-4e44-a1ac-3a0a2e4c7475">PIE</a> 至关重要, 通过 PCREL 才能以`位置无关`的形式找到
GOT, 进而支持 PIE
</p></li>

<li><p>
TPREL
</p>

<p>
和 <a href="linker_relaxation.html#ID-376f9771-7419-48a1-bb83-4e10db90c297">tls relaxation</a> 有关
</p></li>

<li><p>
GPREL
</p>

<p>
和 <a href="linker_relaxation.html#ID-d1c81ee1-c5ca-41ad-a3fc-c3cc1b8f5dbf">gp relaxation</a> 有关
</p></li>

<li><p>
GOT
</p>

<p>
和 <a href="pie.html#ID-d43ec148-ed52-4e44-a1ac-3a0a2e4c7475">PIE</a> 有关
</p></li>

<li>&#x2026;</li>
</ul>

<p>
所谓不同的 reloc_type, 是指 linker 计算出真实地址后, 根据 reloc_type 决定如何
patch 指令, reloc_type 会包含如下信息:
</p>

<ol class="org-ol">
<li>要 patch 的数据相对于要 patch 的指令的 offset</li>

<li>要 patch 的数据的长度</li>

<li>是不是 relative</li>
</ol>

<p>
例如, 若 reloc_type 是 pc-relative (例如 auipc, jal, bne, &#x2026;), 则会把 `真实地址
` 与 `要 patch 的指令` 某种差值写入要 patch 的指令的操作数位置.
</p>
</div>

<div id="outline-container-org0000009" class="outline-3">
<h3 id="org0000009"><span class="section-number-3">1.1</span> example</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000001" class="outline-4">
<h4 id="org0000001"><span class="section-number-4">1.1.1</span> la relocation</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## &#32477;&#23545;&#22320;&#22336;
    ## &#22312;&#27719;&#32534;&#26102;&#24182;&#19981;&#20250;&#30495;&#27491;&#35745;&#31639; hello_msg &#30340;&#22320;&#22336;&#30340;&#39640; 20 &#20301;,
    ## &#22240;&#20026;&#27719;&#32534;&#26102;&#26080;&#27861;&#30830;&#23450; hello_msg &#30340;&#22320;&#22336;.
    ## &#36825;&#37324;&#21482;&#26159;&#30830;&#23450;&#19968;&#20010; symbol (hello_msg) &#21644; reloc_type (BFD_RELOC_RISCV_HI20),
    ## &#36825;&#20004;&#20010;&#20449;&#24687;&#21253;&#21547;&#22312; obj &#25991;&#20214;&#20013;, &#26368;&#21518;&#22312;&#38142;&#25509;&#26102;&#30001; link editor &#22788;&#29702;
    <span class="org-keyword">lui</span> a0, <span class="org-variable-name">%hi</span>(hello_msg)
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%lo</span>(hello_msg)
    <span class="org-keyword">call</span> printf

    ## pc-relative &#22320;&#22336;
<span class="org-function-name">1</span>:
    <span class="org-keyword">auipc</span> a0, <span class="org-variable-name">%pcrel</span>_hi(hello_msg)
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%pcrel</span>_lo(1b)
    <span class="org-keyword">call</span> printf

    ## got &#22320;&#22336;
<span class="org-function-name">1</span>:
    <span class="org-keyword">auipc</span> a0, $got_pcrel_hi(hello_msg)
    <span class="org-keyword">addi</span> a0, $pcrel_lo(1b)
    ## got &#38656;&#35201;&#19968;&#20010;&#39069;&#22806;&#30340; ld &#25165;&#33021;&#33719;&#21462; hello_msg &#30340;&#22320;&#22336;
    <span class="org-keyword">ld</span> a0, 0(a0)
    ## la &#20266;&#25351;&#20196;&#22312; pic &#26102;&#20250;&#29983;&#25104;&#31867;&#20284;&#30340;&#20195;&#30721;:
    ## auipc   a0,0x60
    ## ld      a0,956(a0) # 70810 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;
    ## la a0,hello_msg
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

    <span class="org-keyword">.data</span>
<span class="org-function-name">hello_msg</span>:    .asciz <span class="org-string">"hello\n"</span>
</pre>
</div>

<p>
上面的 `%hi`, `pcrel_hi` 等是 , 会导致 obj 中不同的 relocation
type:
</p>

<pre class="example" id="org0000000">
readelf -a test.o
------
Relocation section '.rela.text' at offset 0x180 contains 17 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000004  00040000001a R_RISCV_HI20      0000000000000000 hello_msg + 0
000000000004  000000000033 R_RISCV_RELAX                        0
000000000008  00040000001b R_RISCV_LO12_I    0000000000000000 hello_msg + 0
000000000008  000000000033 R_RISCV_RELAX                        0
00000000000c  000800000012 R_RISCV_CALL      0000000000000000 printf + 0
00000000000c  000000000033 R_RISCV_RELAX                        0
000000000014  000400000017 R_RISCV_PCREL_HI2 0000000000000000 hello_msg + 0
000000000014  000000000033 R_RISCV_RELAX                        0
000000000018  000500000018 R_RISCV_PCREL_LO1 0000000000000014 .1 + 0
000000000018  000000000033 R_RISCV_RELAX                        0
00000000001c  000800000012 R_RISCV_CALL      0000000000000000 printf + 0
00000000001c  000000000033 R_RISCV_RELAX                        0
000000000024  000400000014 R_RISCV_GOT_HI20  0000000000000000 hello_msg + 0
000000000028  000600000018 R_RISCV_PCREL_LO1 0000000000000024 .L0  + 0
000000000028  000000000033 R_RISCV_RELAX                        0
00000000002c  000800000012 R_RISCV_CALL      0000000000000000 printf + 0
00000000002c  000000000033 R_RISCV_RELAX                        0

objdump -d test.o
------
0000000000000000 &lt;main&gt;:
   0:   1171                    addi    sp,sp,-4
   2:   c206                    sw      ra,4(sp)
   4:   00000537                lui     a0,0x0
   8:   00050513                mv      a0,a0
   c:   00000097                auipc   ra,0x0
  10:   000080e7                jalr    ra # c &lt;main+0xc&gt;

0000000000000014 &lt;.1&gt;:
  14:   00000517                auipc   a0,0x0
  18:   00050513                mv      a0,a0
  1c:   00000097                auipc   ra,0x0
  20:   000080e7                jalr    ra # 1c &lt;.1+0x8&gt;
  24:   00000517                auipc   a0,0x0
  28:   00053503                ld      a0,0(a0) # 24 &lt;.1+0x10&gt;
  2c:   00000097                auipc   ra,0x0
  30:   000080e7                jalr    ra # 2c &lt;.1+0x18&gt;
  34:   4092                    lw      ra,4(sp)
  36:   0111                    addi    sp,sp,4
  38:   00000513                li      a0,0
  3c:   8082                    ret

</pre>
</div>
</div>

<div id="outline-container-ID-119c2664-36d0-4cf5-ae13-0686350c3df8" class="outline-4">
<h4 id="ID-119c2664-36d0-4cf5-ae13-0686350c3df8"><span class="section-number-4">1.1.2</span> jal relocation</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
jal 的操作数也是一个 symbol, 但根据 symbol 的位置, 分为两种情况:
</p>

<ol class="org-ol">
<li>symbol 在当前 section</li>

<li>symbol 在其它 section</li>
</ol>

<p>
之所以区分这两种情况, 是因为 section 的地址是不确定的 (<a href="linker_script.html#ID-1047822f-1bc3-4e98-8874-d7fa2e59260e">Linker Script</a> 可以配置
section 的地址). 但如果 symbol 在当前 section, 因为 jal 的操作数是 PCREL 的, 所以操作数会是确定的值.
</p>

<p>
symbol 在同一个 section:
</p>

<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> _start
    <span class="org-keyword">.section</span> .text
<span class="org-function-name">_start</span>:
    <span class="org-keyword">jal</span> here

<span class="org-function-name">here</span>:
    <span class="org-keyword">ret</span>
</pre>
</div>

<pre class="example" id="org0000004">
$&gt; /opt/riscv/bin/riscv-elf-gcc test.S -O0 -c
$&gt; /opt/riscv/bin/riscv-elf-objdump -d test.o

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:   004000ef                jal     ra,4 &lt;here&gt;

0000000000000004 &lt;here&gt;:
   4:   8082                    ret
</pre>

<p>
symbol 不在同一个 section:
</p>

<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> _start
    <span class="org-keyword">.section</span> .text
<span class="org-function-name">_start</span>:
    <span class="org-keyword">jal</span> here

    <span class="org-keyword">.section</span> .mysection
<span class="org-function-name">here</span>:
    <span class="org-keyword">ret</span>
</pre>
</div>

<pre class="example" id="org0000005">
$&gt; riscv64-linux-gnu-objdump -d test.o

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:   000000ef                jal     ra,0 &lt;_start&gt; 

$&gt; readelf -a test.o

Relocation section '.rela.text' at offset 0x100 contains 1 entry:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000000  000400000011 R_RISCV_JAL       0000000000000000 here + 0
</pre>
</div>


<div id="outline-container-org0000006" class="outline-5 references">
<h5 id="org0000006">Backlinks</h5>
<div class="outline-text-5" id="text-org0000006">
<p>
<a href="riscv_tutorial.html#ID-653c6b58-7ee1-4e07-bf3f-d5eea450748e">RISC-V Tutorial</a>
(<i>RISC-V Tutorial &gt; RISC-V Assembly &gt; RV32I &gt; Overview</i>):     与 B 指令类似, 没有使用 imm[0], J 跳转范围扩大为 [-1M, +1M]+pc (<a href="#ID-119c2664-36d0-4cf5-ae13-0686350c3df8">jal relocation</a>)
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org000001f" class="outline-3">
<h3 id="org000001f"><span class="section-number-3">1.2</span> riscv relocation</h3>
<div class="outline-text-3" id="text-1-2">
<p>
relocation 是 <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc">psABI</a> 的一部分, riscv 常用的 relocation 包括:
</p>

<ul class="org-ul">
<li>R_RISCV_COPY</li>
<li>R_RISCV_JUMP_SLOT</li>
<li>R_RISCV_JAL</li>
<li>R_RISCV_CALL</li>
<li>R_RISCV_GOT_HI20</li>
<li>R_RISCV_PCREL_HI20</li>
<li>R_RISCV_PCREL_LO12_I</li>
<li>R_RISCV_PCREL_LO12_S</li>
<li>R_RISCV_HI20</li>
<li>R_RISCV_LO12_I</li>
<li>R_RISCV_LO12_S</li>
<li>R_RISCV_TPREL_HI20</li>
<li>R_RISCV_TPREL_LO12_I</li>
<li>R_RISCV_TPREL_LO12_S</li>
<li>R_RISCV_TPREL_ADD</li>
<li>R_RISCV_ALIGN</li>
<li>R_RISCV_GPREL_I</li>
<li>R_RISCV_GPREL_S</li>
<li>R_RISCV_TPREL_I</li>
<li>R_RISCV_TPREL_S</li>
<li>R_RISCV_RELAX</li>
</ul>
</div>


<div id="outline-container-org000000d" class="outline-4">
<h4 id="org000000d"><span class="section-number-4">1.2.1</span> R_RISCV_PCREL_HI2</h4>
<div class="outline-text-4" id="text-1-2-1">
<pre class="example" id="org000000c">
000000000014  000400000017 R_RISCV_PCREL_HI2 0000000000000000 hello_msg + 0

表示

  14:   00000517                auipc   a0,0x0

这条指令在重定位时需要用 hello_msg 的真正地址的高 20 位与 pc 的高 20 位的差值
写到原指令中 (00000517) 的 imm 部分.
</pre>
</div>
</div>

<div id="outline-container-org0000011" class="outline-4">
<h4 id="org0000011"><span class="section-number-4">1.2.2</span> R_RISCV_PCREL_LO12</h4>
<div class="outline-text-4" id="text-1-2-2">
<pre class="example" id="org0000010">
000000000018  000500000018 R_RISCV_PCREL_LO1 0000000000000014 .1 + 0

对应

  18:   00050513                mv      a0,a0

表示指令的 imm 部分应该用 hello_msg 的低 12 位与 pc 的低 12 的差来填充
</pre>
</div>
</div>

<div id="outline-container-org0000015" class="outline-4">
<h4 id="org0000015"><span class="section-number-4">1.2.3</span> R_RISCV_HI20</h4>
<div class="outline-text-4" id="text-1-2-3">
<pre class="example" id="org0000014">
000000000004  00040000001a R_RISCV_HI20      0000000000000000 hello_msg + 0

表示

   4:   00000537                lui     a0,0x0

这条指令的 imm 部分应该用 hello_msg 的真正地址的高 20 位直接填充

</pre>
</div>
</div>

<div id="outline-container-org0000018" class="outline-4">
<h4 id="org0000018"><span class="section-number-4">1.2.4</span> R_RISCV_RELAX</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
这个和 <a href="linker_relaxation.html#ID-b861e156-7ced-4e25-b047-455b5b075c1e">Linker Relaxation</a> 有关
</p>
</div>
</div>

<div id="outline-container-org000001c" class="outline-4">
<h4 id="org000001c"><span class="section-number-4">1.2.5</span> R_RISCV_JAL</h4>
<div class="outline-text-4" id="text-1-2-5">
<p>
R_RISCV_JAL 类型的 reloc_type 和 PCREL 应该类似, 但 JAL 有一个额外的限制是它跳转的范围在 [-1M,1M] 之间, 所以下面的代码会链接不过
</p>

<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> _start
    <span class="org-keyword">.section</span> .text
<span class="org-function-name">_start</span>:
    <span class="org-keyword">jal</span> here
    ## &#30475;&#36215;&#26469;&#20687; ld &#30340; bug: jal &#30340;&#36339;&#36716;&#33539;&#22260;&#24212;&#35813;&#26159; [-1m,1m], &#20294;
    ## &#36825;&#37324;&#26174;&#31034;&#26159; [-0.5m,0.5m]...
    ## .rept 0x7ffff-1 &#21487;&#20197;&#38142;&#25509;&#36890;&#36807;    
    <span class="org-keyword">.rept</span> 0x7ffff
    <span class="org-keyword">.byte</span>   0
    <span class="org-keyword">.endr</span>
<span class="org-function-name">here</span>:
    <span class="org-keyword">ret</span>
</pre>
</div>

<pre class="example" id="org000001b">
$&gt; riscv64-linux-gnu-gcc test.S  -nostdlib -O0
/tmp/ccuebMtl.o: in function `_start':
(.text+0x0): relocation truncated to fit: R_RISCV_JAL against `here'
collect2: error: ld returned 1 exit status
</pre>
</div>
</div>
</div>
</div>




<div id="outline-container-org0000025" class="outline-2 references">
<h2 id="org0000025">Backlinks</h2>
<div class="outline-text-2" id="text-org0000025">
<p>
<a href="static_linker.html#ID-ea089718-c0fc-4484-8da4-e44d5e1007ac">Static Linker</a>
(<i>Static Linker &gt; Linker Relocation</i>):   <a href="linker_relocation.html#ID-4fabbae2-594b-4f7d-bcb9-756212cfbe9f">Linker Relocation</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-04-08 Fri 13:50<br />
Last updated: 2022-04-08 Fri 14:15</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
