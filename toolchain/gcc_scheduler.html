<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GCC Scheduler</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">GCC Scheduler</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000008">1. GCC Scheduler</a>
<ul>
<li><a href="#org0000002">1.1. example</a></li>
<li><a href="#ID-38916ef6-f300-47db-8c70-41e3256af352">1.2. TARGET_SCHED_ISSUE_RATE</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000008" class="outline-2">
<h2 id="org0000008"><span class="section-number-2">1</span> GCC Scheduler</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://en.wikipedia.org/wiki/Instruction_scheduling">https://en.wikipedia.org/wiki/Instruction_scheduling</a>
</p>

<p>
<a href="https://gcc.gnu.org/wiki/InstructionScheduling">https://gcc.gnu.org/wiki/InstructionScheduling</a>
</p>

<p>
<a href="https://gcc.gnu.org/onlinedocs/gccint/Scheduling.html">https://gcc.gnu.org/onlinedocs/gccint/Scheduling.html</a>
</p>

<p>
所谓指令调度, 是指 gcc 对指令进行重新排列以减少流水线 stall, 例如:
</p>

<div class="org-src-container">
<pre class="src src-asm">## before 
<span class="org-function-name">lw</span> <span class="org-keyword">a0</span>, 0(sp)
<span class="org-function-name">addi</span> <span class="org-keyword">a0</span>, a0, 1
<span class="org-function-name">addi</span> <span class="org-keyword">a1</span>, a1, 1
<span class="org-function-name">addi</span> <span class="org-keyword">a2</span>, a2, 1    
## after
<span class="org-function-name">lw</span> <span class="org-keyword">a0</span>, 0(sp)
<span class="org-function-name">addi</span> <span class="org-keyword">a1</span>, a1, 1
<span class="org-function-name">addi</span> <span class="org-keyword">a2</span>, a2, 1    
<span class="org-function-name">addi</span> <span class="org-keyword">a0</span>, a0, 1
</pre>
</div>

<p>
由于 cpu 本身支持乱序执行, 所以 gcc 的 scheduler 可能并不是特别重要, 但由于
scheduler 可以根据 schedule 结果修改指令本身(而不仅仅是调整位置, 例如调整寄存器分配), 所以 scheduler与硬件的乱序执行还是会有些不同.
</p>
</div>

<div id="outline-container-org0000002" class="outline-3">
<h3 id="org0000002"><span class="section-number-3">1.1</span> example</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">foo</span>(<span class="org-type">int</span> <span class="org-variable-name">k</span>) {
    <span class="org-type">int</span> <span class="org-variable-name">x</span> = 0;
    <span class="org-type">int</span> <span class="org-variable-name">y</span> = 0;
    <span class="org-type">int</span> <span class="org-variable-name">z</span> = 0;
    x = 1;
    y = 1;
    z = 1;
}
</pre>
</div>

<p>
使用了 scheduler:
</p>

<pre class="example" id="org0000000">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O0  -c -fenable-rtl-sched1
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./test.o

0000000000000000 &lt;foo&gt;:
   0:   7179                    addi    sp,sp,-48
   2:   f422                    sd      s0,40(sp)
   4:   1800                    addi    s0,sp,48
   6:   87aa                    mv      a5,a0
   8:   863e                    mv      a2,a5
   a:   fe042623                sw      zero,-20(s0)
   e:   fe042423                sw      zero,-24(s0)
  12:   fe042223                sw      zero,-28(s0)
  16:   4685                    li      a3,1
  18:   4705                    li      a4,1
  1a:   4785                    li      a5,1
  1c:   fcc42e23                sw      a2,-36(s0)
  20:   fed42623                sw      a3,-20(s0)
  24:   fee42423                sw      a4,-24(s0)
  28:   fef42223                sw      a5,-28(s0)
  2c:   0001                    nop
  2e:   7422                    ld      s0,40(sp)
  30:   6145                    addi    sp,sp,48
  32:   8082                    ret
</pre>

<p>
没使用 scheduler:
</p>

<pre class="example" id="org0000001">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O0  -c
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./test.o

0000000000000000 &lt;foo&gt;:
   0:   7179                    addi    sp,sp,-48
   2:   f422                    sd      s0,40(sp)
   4:   1800                    addi    s0,sp,48
   6:   87aa                    mv      a5,a0
   8:   fcf42e23                sw      a5,-36(s0)
   c:   fe042623                sw      zero,-20(s0)
  10:   fe042423                sw      zero,-24(s0)
  14:   fe042223                sw      zero,-28(s0)
  18:   4785                    li      a5,1
  1a:   fef42623                sw      a5,-20(s0)
  1e:   4785                    li      a5,1
  20:   fef42423                sw      a5,-24(s0)
  24:   4785                    li      a5,1
  26:   fef42223                sw      a5,-28(s0)
  2a:   0001                    nop
  2c:   7422                    ld      s0,40(sp)
  2e:   6145                    addi    sp,sp,48
  30:   8082                    ret
</pre>
</div>
</div>

<div id="outline-container-ID-38916ef6-f300-47db-8c70-41e3256af352" class="outline-3">
<h3 id="ID-38916ef6-f300-47db-8c70-41e3256af352"><span class="section-number-3">1.2</span> TARGET_SCHED_ISSUE_RATE</h3>
<div class="outline-text-3" id="text-1-2">
</div>


<div id="outline-container-org0000005" class="outline-4 references">
<h4 id="org0000005">Backlinks</h4>
<div class="outline-text-4" id="text-org0000005">
<p>
<a href="gcc_backend.html#ID-c5c23657-59a8-4dc0-9987-6912638a6faf">gcc target hook</a>
(<i>GCC Backend &gt; gcc target hook &gt; schedule &gt; TARGET_SCHED_ISSUE_RATE</i>):   <a href="#ID-38916ef6-f300-47db-8c70-41e3256af352">TARGET_SCHED_ISSUE_RATE</a>
</p>
</div>
</div>
</div>
</div>



<div id="outline-container-org000000b" class="outline-2 references">
<h2 id="org000000b">Backlinks</h2>
<div class="outline-text-2" id="text-org000000b">
<p>
<a href="gcc_cost.html#ID-2599fa0b-be86-4b12-a480-ee638a440b1d">GCC Cost</a>
(<i>GCC Cost &gt; 定义 cost &gt; mtune &gt; issue_rate</i>):  issue_rate 和<a href="gcc_scheduler.html#ID-aa30d0cc-966e-407b-9ad3-a0b0fbad7c49">指令调度</a>有关.
</p>

<p>
<a href="gcc_pass.html#ID-17957249-95aa-4d26-8d2b-48ece73cd8cd">GCC Pass</a>
(<i>GCC Pass &gt; rtl pass &gt; pass_sched</i>):   <a href="gcc_scheduler.html#ID-aa30d0cc-966e-407b-9ad3-a0b0fbad7c49">pass_sched</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-04-25 Mon 17:56<br />
Last updated: 2022-04-25 Mon 19:09</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
