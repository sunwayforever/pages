<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>LLVM TableGen</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">LLVM TableGen</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000012">1. LLVM TableGen</a>
<ul>
<li><a href="#org0000000">1.1. llvm-tblgen</a></li>
<li><a href="#org0000008">1.2. td</a>
<ul>
<li><a href="#org0000005">1.2.1. example</a></li>
</ul>
</li>
<li><a href="#org000000b">1.3. gen-dag-isel</a></li>
<li><a href="#org000000f">1.4. gen-instr-info</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000012" class="outline-2">
<h2 id="org0000012"><span class="section-number-2">1</span> LLVM TableGen</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://llvm.org/docs/TableGen/index.html">https://llvm.org/docs/TableGen/index.html</a>
</p>

<p>
<a href="https://llvm.org/docs/TableGen/ProgRef.html">https://llvm.org/docs/TableGen/ProgRef.html</a>
</p>

<p>
tablegen 是整个 llvm backend 核心的数据结构, llvm backend 的所有组件都需要通过
tablegen 来解释 target description (td) 文件, 拿到自己关注的数据.
</p>

<p>
要了解 td 文件, 除了 tablegen 本身的语法, 更重要的是 SelectionDAGISel 和其它模块如何使用 tablegen 的数据, 因为这些数据完全是由各个模块负责解释.
</p>

<p>
target description 和 gcc <a href="gcc_backend.html#ID-5304f835-9c6a-49bc-89a5-ca01e2520167">machine description</a> 基本是类似, 它们都包含:
</p>

<ol class="org-ol">
<li>instruction selection 相关的 pattern</li>

<li>target instruction 对应的 assembly</li>

<li>和 scheduling 相关的 instruction latency</li>
</ol>

<p>
但 td 是使用一个新的 DSL 对这些信息进行层次化的定义, 而 md 的定义并不是层次化的:
例如 add,sub 指令需要有单独的完整定义, 虽然它们有许多相似的地方.
</p>

<p>
另外, md 不包含寄存器信息和指令的编码信息, 所以 gcc 需要自己从头实现 as/disass,
而不是像 llvm 可以使用 td 的信息自动生成 as/disass 的部分代码.
</p>
</div>

<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1</span> llvm-tblgen</h3>
<div class="outline-text-3" id="text-1-1">
<p>
llvm-tblgen 包括两部分功能:
</p>

<ol class="org-ol">
<li>解析 td 文件, 生成 records, 这个 records 是 td 展开的结果, 不涉及具体的语义</li>

<li>把 records 按命令行参数提供的 action 进一步解析, 生成对应的 inc 文件, 例如
`-gen-dag-isel` 参数会导致 llvm-tblgen 按 isel 的需求去解析 records, 生成
RISCVGenDAGISel.inc</li>
</ol>

<p>
所以 llvm-tblgen 是认识 llvm 相关的 action 的语义的, 例如 `gen-register-info`,
`gen-instr-info`, `gen-dag-isel`&#x2026;, 但通过 `-print-records` 和
`-print-detailed-records`, 可以只看 td 展开的 records, 而不做进一步分析.
</p>
</div>
</div>

<div id="outline-container-org0000008" class="outline-3">
<h3 id="org0000008"><span class="section-number-3">1.2</span> td</h3>
<div class="outline-text-3" id="text-1-2">
<ol class="org-ol">
<li>TableGen DSL 类似于 c++</li>

<li>支持类似模板的参数</li>

<li>支持多重继承</li>

<li>通过 class 关键字定义 abstract record</li>

<li>通过 def 关键字来定义 concrete record</li>
</ol>

<p>
使用 `llvm-tblgen xxx.td [-print-records, -print-detailed-records]` 可以查找 td
展开后的结果.
</p>
</div>

<div id="outline-container-org0000005" class="outline-4">
<h4 id="org0000005"><span class="section-number-4">1.2.1</span> example</h4>
<div class="outline-text-4" id="text-1-2-1">
<pre class="example" id="org0000003">
// 使用 class 来定义一个 abstract record
class A&lt;string n&gt; {
      string Name=n;
}

class B&lt;int a&gt; {
      // 定义了四个 field
      // 支持 string, int, bit, bits&lt;&gt;, list 五种数据类型
      int A=a;
      bit Bit;
      bits&lt;10&gt; Bits;
      list&lt;int&gt; List=[a];
      // 其它 class 的实例也能做为 field
      A ClassA;
}

// 多重继承, 并通过模板参数初始化基类
class AB&lt;string n,int a, A x&gt;:A&lt;n&gt;,B&lt;a&gt; {
      // bits 可以通过 {a-b} 的形式访问 bit
      // 通过 let 修改基类的 field
      let Bits{2-0}=a;
      let Bit=true;
      let List=[a,a];
      // 声明 AB 类自己的 field, 通过 Name 访问基类的 field
      // # 用来拼接两个 string
      string X=Name#Name;
      let ClassA=x;
}

// 使用 def 定义 concrete record 
def a:A&lt;"a"&gt;{}

def ab0:AB&lt;"0",2, a&gt; {}
</pre>

<p>
llvm-tblgen test.td 展开的结果:
</p>

<pre class="example" id="org0000004">

</pre>
</div>
</div>
</div>

<div id="outline-container-org000000b" class="outline-3">
<h3 id="org000000b"><span class="section-number-3">1.3</span> gen-dag-isel</h3>
</div>

<div id="outline-container-org000000f" class="outline-3">
<h3 id="org000000f"><span class="section-number-3">1.4</span> gen-instr-info</h3>
<div class="outline-text-3" id="text-1-4">
<pre class="example" id="org000000e">
def ADDW  : ALUW_rr&lt;0b0000000, 0b000, "addw", /*Commutable*/1&gt;,
            Sched&lt;[WriteIALU32, ReadIALU32, ReadIALU32]&gt;;

class ALUW_rr&lt;bits&lt;7&gt; funct7, bits&lt;3&gt; funct3, string opcodestr,
              bit Commutable = 0&gt;
    : RVInstR&lt;funct7, funct3, OPC_OP_32, (outs GPR:$rd),
              (ins GPR:$rs1, GPR:$rs2), opcodestr, "$rd, $rs1, $rs2"&gt; {
    ...                        
}

class RVInstR&lt;bits&lt;7&gt; funct7, bits&lt;3&gt; funct3, RISCVOpcode opcode, dag outs,
              dag ins, string opcodestr, string argstr&gt;
    : RVInst&lt;outs, ins, opcodestr, argstr, [], InstFormatR&gt; {
    ...
}

class RVInst&lt;dag outs, dag ins, string opcodestr, string argstr,
             list&lt;dag&gt; pattern, InstFormat format&gt;
    : Instruction {
    ...

}

class Instruction : InstructionEncoding {
      ...
}

class InstructionEncoding {
      ...
}
</pre>
</div>
</div>
</div>


<div id="outline-container-org0000015" class="outline-2 references">
<h2 id="org0000015">Backlinks</h2>
<div class="outline-text-2" id="text-org0000015">
<p>
<a href="llvm_backend.html#ID-e60ce82f-6f66-44e0-adb5-cef752145625">LLVM Backend</a>
(<i>LLVM Backend &gt; TableGen</i>):   <a href="llvm_tablegen.html#ID-5e67daa8-ff56-4a3c-ac3c-de840f1abe46">TableGen</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-05-11 Wed 14:53<br />
Last updated: 2022-05-11 Wed 19:54</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
