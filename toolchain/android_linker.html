<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 20:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Android Linker</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Android Linker</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9106fb1">1. Android Linker</a>
<ul>
<li><a href="#orgc2e135c">1.1. linker 启动</a>
<ul>
<li><a href="#orgf30b483">1.1.1. kernel 部分</a></li>
<li><a href="#org305da28">1.1.2. linker 部分</a></li>
<li><a href="#orgb41b2b4">1.1.3. 总结</a></li>
</ul>
</li>
<li><a href="#org2d6e6fd">1.2. linker 自身的重定位</a>
<ul>
<li><a href="#org3d060d2">1.2.1. linker_so.prelink_image</a></li>
<li><a href="#org3e78fcd">1.2.2. linker_so.link_image</a></li>
<li><a href="#orgdc0c87b">1.2.3. __libc_init_main_thread</a></li>
<li><a href="#org60278de">1.2.4. linker_so.protect_relro</a></li>
<li><a href="#org376e7be">1.2.5. __libc_init_globals</a></li>
<li><a href="#orged7b08c">1.2.6. linker_so.call_constructors</a></li>
</ul>
</li>
<li><a href="#org572df0d">1.3. linker 主逻辑</a>
<ul>
<li><a href="#org621e4d5">1.3.1. __linker_init_post_relocation</a></li>
<li><a href="#org3d9d223">1.3.2. find_libraries</a></li>
<li><a href="#org3c6ce19">1.3.3. LoadTask::load</a></li>
<li><a href="#org7a4daa2">1.3.4. LoadSegments</a></li>
<li><a href="#orgf316eca">1.3.5. link_image</a></li>
</ul>
</li>
<li><a href="#org6df4f83">1.4. libdl</a>
<ul>
<li><a href="#org70b1e97">1.4.1. dlopen</a></li>
<li><a href="#orgeb78ad2">1.4.2. dlsym</a></li>
<li><a href="#orgac4d075">1.4.3. RTLD_XXX</a></li>
</ul>
</li>
<li><a href="#org1edf9a6">1.5. android_namespace</a>
<ul>
<li><a href="#orgf2d15cc">1.5.1. android_namespace_t</a></li>
<li><a href="#org790555e">1.5.2. g_default_namespace</a></li>
<li><a href="#org7f3d3ef">1.5.3. g_anonymous_namespace</a></li>
<li><a href="#orgcd268d4">1.5.4. classloader-namespace</a></li>
<li><a href="#org348a6f1">1.5.5. g_public_namespace</a></li>
<li><a href="#orged753ec">1.5.6. classloader-namespace 初始化</a></li>
<li><a href="#org79bbae9">1.5.7. 使用 classloader-namespace 来 load so</a></li>
<li><a href="#org3dd6dc1">1.5.8. find_library</a></li>
<li><a href="#org4467bae">1.5.9. 总结</a></li>
</ul>
</li>
<li><a href="#org606be8b">1.6. dependencies tree</a></li>
<li><a href="#org2b36fe0">1.7. misc</a>
<ul>
<li><a href="#org17d9362">1.7.1. version_tracker</a></li>
<li><a href="#orgff22d82">1.7.2. how linker is compiled</a></li>
<li><a href="#org7118a5d">1.7.3. RTLD_GLOBAL, DF_1_GLOBAL, global_group</a></li>
</ul>
</li>
<li><a href="#org7d22a97">1.8. summary</a></li>
</ul>
</li>
<li><a href="#org83b7ec3">2. init</a></li>
<li><a href="#org74443c9">3. link_image</a></li>
<li><a href="#orgecd1352">4. find_libraries</a></li>
<li><a href="#org9c1bb43">5. dlfcn</a></li>
<li><a href="#orgdd6946a">6. android_namespace</a></li>
<li><a href="#orgb19dfe4">7. version_tracker</a></li>
</ul>
</div>
</div>

<div id="outline-container-org9106fb1" class="outline-2">
<h2 id="org9106fb1"><span class="section-number-2">1</span> Android Linker</h2>
<div class="outline-text-2" id="text-1">
</div>

<div id="outline-container-orgc2e135c" class="outline-3">
<h3 id="orgc2e135c"><span class="section-number-3">1.1</span> linker 启动</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgf30b483" class="outline-4">
<h4 id="orgf30b483"><span class="section-number-4">1.1.1</span> kernel 部分</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
以 exec("/system/bin/linker") 为例:
</p>

<ol class="org-ol">
<li><p>
linker 本身的 interp 是它自己:
</p>

<pre class="example" id="org57f6ec6">
~@tj02433pcu&gt; readelf -a /system/bin/linker|grep 'program inter'
       [Requesting program interpreter: /system/bin/linker]
</pre></li>

<li><p>
linker 的 entry 为 __dl__start, 地址为 0x28fc
</p>

<pre class="example" id="org4a5d349">
~@tj02433pcu&gt; readelf -a /system/bin/linker|grep 'Entry point'
  Entry point address:               0x28fc
</pre></li>
</ol>

<p>
kernel 会如下设置:
</p>

<ol class="org-ol">
<li><p>
/system/bin/linker 做为 exectuable 被 map 一次, 然后由于 linker 指
定了 iterp 是 /system/bin/linker, 所以它会做为 shared object 再次被
map 一次
</p>

<pre class="example" id="org42b4ea8">
00000000aaaaa000    440K r-x--  /system/bin/linker  &lt;--- 做为 exectuable 被 map
00000000aab18000     12K rw---  /system/bin/linker  
00000000aab1b000     20K rw---    [heap]
00000000f777b000    440K r-x--  /system/bin/linker  &lt;--- 做为 interp 再次被 map
00000000f77e9000     12K rw---  /system/bin/linker
00000000f77ec000     20K rw---    [anon]
00000000fffcf000    132K rw---    [stack]
00000000ffff0000      4K r-x--    [vectors]
</pre></li>

<li><p>
控制会转移到 interp, 其入口为 0xf777d8fc, 这个地址对应于 interp 的
__dl__start:
</p>

<pre class="example" id="orgb578c42">
f777b000 (inter 被 map 的地址) + 0x28fc (entry point) = 0xf777d8fc
</pre></li>

<li>aux vector

<ol class="org-ol">
<li>AT_BASE 为 0xf777b000, 即 interp 被 map 的地址</li>

<li>AT_ENTRY 为 0xaaaac8fc, 即 exectuable 本身的 entry, 由于
exectuable 被 map 在0xaaaaa000, 所以其 entry 为
0xaaaaa0000 + 0x28fc = 0xaaaac8fc (至于 exectuable 为什么被 map
在 0xaaaaa000, 参考 ELF_ET_DYN_BASE)</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-org305da28" class="outline-4">
<h4 id="org305da28"><span class="section-number-4">1.1.2</span> linker 部分</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">__linker_init</span>:
  <span style="font-weight: bold;">ElfW</span>(Addr) linker_addr = args.getauxval(AT_BASE);
  <span style="font-weight: bold;">ElfW</span>(Addr) entry_point = args.getauxval(AT_ENTRY);
  <span style="font-weight: bold;">if</span> (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point):
    __libc_format_fd(STDOUT_FILENO,
                   <span style="font-style: italic;">"This is %s, the helper program\n"</span>,
                   args.argv[0]);
    exit(0)
  linker_so.base = linker_addr;
  linker_so.size = phdr_table_get_load_size(phdr, elf_hdr-&gt;e_phnum);
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">load_bias &#26159; so &#20013;&#30340; vadd &#19982;&#23454;&#38469;&#22320;&#22336;&#30340;&#20559;&#31227;&#37327;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  linker_so.load_bias = get_elf_exec_load_bias(elf_hdr);
  linker_so.dynamic = nullptr;
  linker_so.phdr = phdr;
  linker_so.phnum = elf_hdr-&gt;e_phnum;
  linker_so.set_linker_flag();

<span style="font-weight: bold; text-decoration: underline;">get_elf_exec_load_bias</span>:
  <span style="font-weight: bold;">ElfW</span>(Addr) offset = elf-&gt;e_phoff;
  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Phdr</span>)* phdr_table =
    reinterpret_cast&lt;<span style="font-weight: bold;">const</span> ElfW(Phdr)*&gt;(reinterpret_cast&lt;uintptr_t&gt;(elf) + offset);
  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Phdr</span>)* phdr_end = phdr_table + elf-&gt;e_phnum;

  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Phdr</span>)* phdr = phdr_table; phdr &lt; phdr_end; phdr++):
    <span style="font-weight: bold;">if</span> (phdr-&gt;p_type == PT_LOAD):
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">elf_hdr + (phdr-&gt;p_offset) &#26159;&#36825;&#20010; segment &#34987;&#26144;&#23556;&#30340;&#23454;&#38469;&#22320;&#22336;,</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#19982;p_vaddr &#30340;&#24046;&#21363;&#26159; load_bias, &#36825;&#19968;&#28857;&#21482;&#33021;&#31532;&#19968;&#20010; PT_LOAD &#26377;&#25928;:</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#22240;&#20026; elf_hdr &#23454;&#38469;&#23601;&#26159;&#31532;&#19968;&#20010; PT_LAOD &#23454;&#38469;&#30340;&#26144;&#23556;&#22320;&#22336;, &#32780;&#19988;&#23427;&#30340;</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">phdr-&gt;p_offset &#20026; 0</span>
      <span style="font-weight: bold;">return</span> reinterpret_cast&lt;ElfW(Addr)&gt;(elf) + phdr-&gt;p_offset - phdr-&gt;p_vaddr;
</pre>
</div>

<p>
_start 即 __dl__start 函数 (参考 ), 这里由于 linker 本身并没有完成重定
位, 所以通过 GOT 引用到的 __dl__start 地址是 GOT 中原始的值, 即 0x28fc
</p>

<pre class="example" id="org598c461">
objdump -D linker:

0006fddc &lt;__dl__GLOBAL_OFFSET_TABLE_-0x218&gt;:
   6fddc:	000715b8 			; &lt;UNDEFINED&gt; instruction: 0x000715b8
   6fde0:	000711d0 	ldrdeq	r1, [r7], -r0
   6fde4:	000716bc 			; &lt;UNDEFINED&gt; instruction: 0x000716bc
   6fde8:	0006eaf4 	strdeq	lr, [r6], -r4
   6fdec:	00070174 	andeq	r0, r7, r4, ror r1
   6fdf0:	000028fc 	strdeq	r2, [r0], -ip              &lt;--- GOT 中的原始值为 0x28fc
</pre>

<p>
而 entry_point 的值是 0xaaaac8fc, 所以这里的条件并不会成立.
</p>

<p>
linker 后续的代码会完成 linker 本身及 exectuable (这里也是 linker&#x2026;)
的重定位, 包括填充 exectuable 对应的 GOT 表, 然后第二次跳转到
__linker_init
</p>

<pre class="example" id="org6e0f98e">
~/source/sharklj1@tj02433pcu&gt; d debug exec out/target/product/sp9850j_1h10/symbols/system/bin/linker /system/bin/linker
Remote debugging from host 127.0.0.1
__dl__start () at bionic/linker/arch/arm/begin.S:32
32        mov r0, sp
(gdb) b __dl___linker_init
Breakpoint 1 at 0xaaab6e38: __dl___linker_init. (2 locations)
(gdb) c
Continuing.

Breakpoint 1, __linker_init (raw_args=0xfffefa80) at bionic/linker/linker.cpp:4400
4400      KernelArgumentBlock args(raw_args);
(gdb) n
4402      ElfW(Addr) linker_addr = args.getauxval(AT_BASE);
(gdb) 
4403      ElfW(Addr) entry_point = args.getauxval(AT_ENTRY);
(gdb) 
4404      ElfW(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);
(gdb) 
4405      ElfW(Phdr)* phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);
(gdb) 
4407      soinfo linker_so(nullptr, nullptr, nullptr, 0, 0);
(gdb) 
4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e80      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e82      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e84      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e86      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
// 这里引用 r2 (即 _start) 使用的是 interp 的 GOT
(gdb) p /x $r2
$2 = 0x28fc
(gdb) p entry_point
$3 = 2863319292
(gdb) p /x entry_point
$4 = 0xaaaac8fc
(gdb) n
4423      linker_so.base = linker_addr;
(gdb) c
Continuing.

Breakpoint 1, __linker_init (raw_args=0xfffefa80) at bionic/linker/linker.cpp:4400
4400      KernelArgumentBlock args(raw_args);
(gdb) n
4402      ElfW(Addr) linker_addr = args.getauxval(AT_BASE);
(gdb) 
4403      ElfW(Addr) entry_point = args.getauxval(AT_ENTRY);
(gdb) 
4404      ElfW(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);
(gdb) 
4405      ElfW(Phdr)* phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);
(gdb) 
4407      soinfo linker_so(nullptr, nullptr, nullptr, 0, 0);
(gdb) 
4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xaaab6e80      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e82      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e84      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e86      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
// 这里引用 r2 (即 _start) 使用的是 executable 的 GOT
(gdb) p /x $r2
$5 = 0xaaaac8fc
(gdb) p /x entry_point
$6 = 0xaaaac8fc
(gdb) c
This is /system/bin/linker, the helper program
</pre>
</div>
</div>

<div id="outline-container-orgb41b2b4" class="outline-4">
<h4 id="orgb41b2b4"><span class="section-number-4">1.1.3</span> 总结</h4>
<div class="outline-text-4" id="text-1-1-3">
<ol class="org-ol">
<li>kernel 负责分别将 linker 和 exectuable(在本例中即 linker 自身) map
到某个位置 (最基本的重定位), 并设置好 AT_BASE 和 AT_ENTRY</li>
<li>kernel 随后跳转到 linker(interp 的 __dl__start</li>
<li>__dl__start 负责进行 linker 自身及 exectuable 的重定位</li>
<li>linker 最后跳转到 AT_ENTRY 指定的 exectuable 的 entry</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org2d6e6fd" class="outline-3">
<h3 id="org2d6e6fd"><span class="section-number-3">1.2</span> linker 自身的重定位</h3>
<div class="outline-text-3" id="text-1-2">
<p>
linker 作为 interp 启动后需要首先完成自身的重定位.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">__linker_init</span>:
  linker_so.prelink_image()
  linker_so.link_image(g_empty_list, g_empty_list, nullptr)
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">link_image &#21518;, linker &#25165;&#33021;&#20351;&#29992;&#20854;&#20840;&#23616;&#21464;&#37327;, &#21253;&#25324;&#21518;&#38754;&#35201;&#20351;&#29992;&#30340; __libc_globals</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">__libc_init_main_thread</span>(args);
  linker_so.protect_relro()
  <span style="font-weight: bold;">__libc_init_globals</span>(args);
  linker_so.call_constructors();
</pre>
</div>
</div>

<div id="outline-container-org3d060d2" class="outline-4">
<h4 id="org3d060d2"><span class="section-number-4">1.2.1</span> linker_so.prelink_image</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li><p>
prelink_image
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">prelink_image</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#26597;&#25214; PT_DYNAMIC &#31867;&#22411;&#30340; phdr, &#20197;&#33719;&#24471; .dynamic section &#30340;&#22320;&#22336;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">phdr_table_get_dynamic_section</span>(phdr, phnum, load_bias, &amp;dynamic, &amp;dynamic_flags);
    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i&lt;phdr_count; ++i) {
      <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Phdr</span>)&amp; phdr = phdr_table[i];
      <span style="font-weight: bold;">if</span> (phdr.p_type == PT_DYNAMIC) {
        *dynamic = reinterpret_cast&lt;ElfW(Dyn)*&gt;(load_bias + phdr.p_vaddr);
        <span style="font-weight: bold;">return</span>
   <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#35299;&#26512; dynamic section &#30340;&#20449;&#24687;</span><span style="font-weight: bold; font-style: italic;"> */</span>
   <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#20250;&#20570;&#26368;&#22522;&#26412;&#30340;&#37325;&#23450;&#20301;: dynamic section &#20013;&#35760;&#24405;&#30340;&#21508;&#31181; p_ptr &#21152;&#19978;</span>
<span style="font-weight: bold; font-style: italic;">    * &#19968;&#20010; load_bias &#23601;&#26159;&#23545;&#24212;&#30340;&#20869;&#23384;&#30340;&#22320;&#22336;</span><span style="font-weight: bold; font-style: italic;"> */</span>
   <span style="font-weight: bold;">for</span> (ElfW(Dyn)* d = dynamic; d-&gt;d_tag != DT_NULL; ++d):
     <span style="font-weight: bold;">switch</span> (d-&gt;d_tag) {
         <span style="font-weight: bold;">case</span> DT_STRTAB:
           strtab_ = reinterpret_cast&lt;<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>*&gt;(load_bias + d-&gt;d_un.d_ptr); <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_STRSZ:
           strtab_size_ = d-&gt;d_un.d_val; <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_SYMTAB:
           symtab_ = reinterpret_cast&lt;ElfW(Sym)*&gt;(load_bias + d-&gt;d_un.d_ptr); <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_RELA:
           rela_ = reinterpret_cast&lt;ElfW(Rela)*&gt;(load_bias + d-&gt;d_un.d_ptr); <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_INIT:
           init_func_ = reinterpret_cast&lt;linker_function_t&gt;(load_bias + d-&gt;d_un.d_ptr); <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_INIT_ARRAY:
           init_array_ = reinterpret_cast&lt;linker_function_t*&gt;(load_bias + d-&gt;d_un.d_ptr); <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_NEEDED:
           ++needed_count; <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_SONAME:
           <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">this is parsed after we have strtab initialized (see below).</span>
           <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold;">case</span> DT_RUNPATH:
           <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">this is parsed after we have strtab initialized (see below).</span>
           <span style="font-weight: bold;">break</span>;
         <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#35299;&#26512; strtab, &#32473;&#20381;&#36182;&#20110; strtab &#30340; entry &#36171;&#20540; (soname, runpath)</span><span style="font-weight: bold; font-style: italic;"> */</span>
    <span style="font-weight: bold;">for</span> (ElfW(Dyn)* d = dynamic; d-&gt;d_tag != DT_NULL; ++d) {
      <span style="font-weight: bold;">switch</span> (d-&gt;d_tag) {
        <span style="font-weight: bold;">case</span> DT_SONAME:
          set_soname(get_string(d-&gt;d_un.d_val)); <span style="font-weight: bold;">break</span>;
        <span style="font-weight: bold;">case</span> DT_RUNPATH:
          set_dt_runpath(get_string(d-&gt;d_un.d_val)); <span style="font-weight: bold;">break</span>;
</pre>
</div></li>

<li><p>
get_string
</p>

<p>
DT_SONAME 和 DT_RUNPATH 的 d_val 是相对于 dynstr 的 offset
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">get_string</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; strtab_ &#26469;&#33258; .dynamic &#20013; DT_STRTAB, &#23454;&#38469;&#19978;&#25351;&#21521; .dynstr (&#32780;</span>
<span style="font-weight: bold; font-style: italic;">   * &#19981;&#26159; .strtab)</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">return</span> strtab_ + index;
</pre>
</div>

<pre class="example" id="org7f87c20">
$&gt; readelf -a ./a.out

Dynamic section at offset 0x8a0 contains 27 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [/home/sunway/libtest.so]
 ...
 0x0000000000000005 (STRTAB)             0x3a8


Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  ... 
  [ 6] .dynstr           STRTAB           00000000000003a8  000003a8
       00000000000000ce  0000000000000000   A       0     0     1

$&gt; readelf -p .synstr ./a.out
String dump of section '.dynstr':
  [     1]  libc.so.6
  ...
  [    32]  /home/sunway/libtest.so
  ...

$&gt; od -x ./a.out +0x8a0
0004240 0001 0000 0000 0000 0001 0000 0000 0000
0004260 000f 0000 0000 0000 0032 0000 0000 0000
...
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org3e78fcd" class="outline-4">
<h4 id="org3e78fcd"><span class="section-number-4">1.2.2</span> linker_so.link_image</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">link_image</span>:
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">relocate rel{a}.dyn</span>
  <span style="font-weight: bold;">relocate</span>(version_tracker, plain_reloc_iterator(rela_, rela_count_), global_group, local_group)
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">relocate rel{a}.plt</span>
  <span style="font-weight: bold;">relocate</span>(version_tracker, plain_reloc_iterator(plt_rela_, plt_rela_count_), global_group, local_group)
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21442;&#32771; GNU_RELRO</span>
  <span style="font-weight: bold;">protect_relro</span>()

plain_reloc_iterator:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">plain_reloc_iterator &#29992;&#26469;&#36941;&#21382; {plt_}rel{a}_ (&#21363; .rel{a}.{dyn,plt})</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold;">  #if</span> <span style="font-weight: bold;">defined</span>(USE_RELA)
    <span style="font-weight: bold;">typedef</span> ElfW(Rela) rel_t;
<span style="font-weight: bold;">  #else</span>
    <span style="font-weight: bold;">typedef</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(Rel) rel_t;
<span style="font-weight: bold;">  #endif</span>

  <span style="font-weight: bold;">plain_reloc_iterator</span>(<span style="font-weight: bold; text-decoration: underline;">rel_t</span>* <span style="font-weight: bold; font-style: italic;">rel_array</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">count</span>)
    : begin_(rel_array), end_(begin_ + count), current_(begin_) {}

  <span style="font-weight: bold; text-decoration: underline;">rel_t</span>* <span style="font-weight: bold;">next</span>()
    <span style="font-weight: bold;">return</span> current_++;

<span style="font-weight: bold; text-decoration: underline;">relocate</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36941;&#21382; .rel{a}.plt</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">idx</span> = 0; rel_iterator.has_next(); ++idx):
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">rel-&gt;r_info &#21253;&#21547;&#20102; relocation type &#21644; sym index</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">rel-&gt;r_offset &#25351;&#31034;&#20102;&#38656;&#35201; patch &#30340; got.plt &#30340;&#20301;&#32622; </span>
    ElfW(Word) type = ELFW(R_TYPE)(rel-&gt;r_info);
    <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Word</span>) sym = ELFW(R_SYM)(rel-&gt;r_info);

    <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Addr</span>) reloc = static_cast&lt;ElfW(Addr)&gt;(rel-&gt;r_offset + load_bias);
    <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Addr</span>) sym_addr = 0;
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">sym_name</span> = nullptr;
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">rel &#21644; rela &#33719;&#24471; addend &#26041;&#24335;&#19981;&#21516;: rela &#30340; addend &#30452;&#25509;&#20445;&#23384;&#22312;</span>
<span style="font-weight: bold; font-style: italic;">     * rel-&gt;r_addend, &#32780; rel &#30340; addend &#20445;&#23384;&#22312; *relc &#22788;</span><span style="font-weight: bold; font-style: italic;"> */</span>
    <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Addr</span>) addend = get_addend(rel, reloc);

    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">relocate &#26102;, &#33509; sym &#19981;&#20026;&#31354;, &#38656;&#35201;&#20174;&#20854;&#23427;&#22320;&#26041; (so &#25110; executable)</span>
<span style="font-weight: bold; font-style: italic;">     * &#20013;&#26597;&#25214; sym &#30340;&#22320;&#22336;&#26469; patch, &#33509; sym &#20026;&#31354;, &#21017;&#19981;&#38656;&#35201;&#26597;&#25214;, &#30452;&#25509;&#26681;&#25454;</span>
<span style="font-weight: bold; font-style: italic;">     * load_bias &#20043;&#31867;&#30340;&#36827;&#34892; patch &#21363;&#21487;</span><span style="font-weight: bold; font-style: italic;"> */</span>
    <span style="font-weight: bold;">if</span> (sym != 0):
      sym_name = get_string(symtab_[sym].st_name);
      <span style="font-weight: bold;">soinfo_do_lookup</span>(this, sym_name, vi, &amp;lsi, global_group, local_group, &amp;s)
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">sym_name &#22312;&#25152;&#26377;&#30340; so, executable &#20013;&#37117;&#27809;&#26377;&#25214;&#21040;, undefined</span>
      <span style="font-weight: bold;">if</span> (s == nullptr):
        s = &amp;symtab_[sym];
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#20801;&#35768; undefined &#30340; weak symbol &#23384;&#22312;, &#21442;&#32771; `weak_symbol`</span>
        <span style="font-weight: bold;">if</span> (ELF_ST_BIND(s-&gt;st_info) != STB_WEAK):
          <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25214;&#21040;&#19968;&#20010; symbol: lsi &#26159; symbol &#25152;&#22312;&#30340; so, s &#26159; symbol &#23545;&#24212;&#30340;</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">dynsym entry</span>
      sym_addr = lsi-&gt;resolve_symbol_address(s);

    <span style="font-weight: bold;">switch</span> type:
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">R_GENERIC_JUMP_SLOT &#26159;&#26368;&#24120;&#29992;&#30340; relocation type, &#20363;&#22914;&#35843;&#29992; printf</span>
      <span style="font-weight: bold;">case</span> R_GENERIC_JUMP_SLOT:
        *reinterpret_cast&lt;ElfW(Addr)*&gt;(reloc) = (sym_addr + addend);

      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">R_GENERIC_GLOB_DAT &#29992;&#26469;&#35775;&#38382;&#20840;&#23616;&#21464;&#37327;, &#20363;&#22914; extern int x</span>
      <span style="font-weight: bold;">case</span> R_GENERIC_GLOB_DAT:
        *reinterpret_cast&lt;ElfW(Addr)*&gt;(reloc) = (sym_addr + addend);

      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#35775;&#38382; pc relative: &#20363;&#22914;&#35775;&#38382;&#24403;&#21069; so &#20013;&#30340;&#20840;&#23616;&#21464;&#37327;&#26102;&#20250;&#20351;&#29992;&#36825;&#31181; relocation</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">[[file:PIC_PIE.org::*pic/no-pic%20%E7%9A%84%E5%8C%BA%E5%88%AB][pic/no-pic &#30340;&#21306;&#21035;]]</span>
      <span style="font-weight: bold;">case</span> R_GENERIC_RELATIVE:
        *reinterpret_cast&lt;ElfW(Addr)*&gt;(reloc) = (load_bias + addend);
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>

<p>
resolve_symbol_address:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">resolve_symbol_address</span>:
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">st_value &#26159; dysym &#30340;&#25104;&#21592;</span>
  <span style="font-weight: bold;">return</span> static_cast&lt;ElfW(Addr)&gt;(s-&gt;st_value + load_bias);
</pre>
</div>

<p>
关于 weak_symbol 
</p>
</div>

<div id="outline-container-org7bd156b" class="outline-5">
<h5 id="org7bd156b"><span class="section-number-5">1.2.2.1</span> soinfo_do_lookup</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<p>
<a href="https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md">https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md</a>
</p>

<p>
soinfo_do_lookup 的输入是:
</p>

<ol class="org-ol">
<li>symbol name</li>
<li>this so</li>
<li>global_group, 包含 1. exectuable 自己 2. LD_PRELOAD 引入的 so 3. DF_1_GLOBAL
的 so</li>
<li>local_group, 通过 walk_dependencies_tree 获得的 so ,包含所有DT_NEEDED 引入的
so</li>
</ol>

<p>
soinfo_do_lookup 需要考虑几点:
</p>

<ol class="org-ol">
<li>global 或 local group</li>

<li>DT_SYMBOLIC,</li>

<li>HASH</li>
</ol>

<p>
简单的说, soinfo_do_lookup 的作用是:
按一定顺序在 exectuable 和各个 so 中按名字查找某个符号, 返回 so 和符号
的信息, 查找过程中使用 .hash 或 .gnu.hash 中的信息来加速.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">soinfo_do_lookup</span>:
  <span style="font-weight: bold;">if</span> (si_from-&gt;has_DT_SYMBOLIC):
    <span style="font-weight: bold; font-style: italic;">/* </span>
<span style="font-weight: bold; font-style: italic;">     *  Note that this is unlikely since static linker avoids generating</span>
<span style="font-weight: bold; font-style: italic;">     *  relocations for -Bsymbolic linked dynamic executables.</span>
<span style="font-weight: bold; font-style: italic;">     *  &#36825;&#19968;&#28857;&#21442;&#32771; DT_SYMBOLIC</span>
<span style="font-weight: bold; font-style: italic;">     */</span>
    <span style="font-weight: bold;">if</span> (!si_from-&gt;find_symbol_by_name(symbol_name, vi, &amp;s)):
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;

    <span style="font-weight: bold;">if</span> (s != nullptr):
      *si_found_in = si_from;

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">1. Look for it in global_group</span>
    <span style="font-weight: bold;">if</span> (s == nullptr):
      global_group.visit([&amp;](<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">global_si</span>):
          global_si-&gt;find_symbol_by_name(symbol_name, vi, &amp;s)

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">2. Look for it in the local group</span>
    <span style="font-weight: bold;">if</span> (s == nullptr):
      local_group.visit([&amp;](<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">local_si</span>):
        <span style="font-weight: bold;">if</span> (local_si == si_from &amp;&amp; si_from-&gt;has_DT_SYMBOLIC):
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">local_group &#26159;&#21253;&#21547; this so &#30340;</span>
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">we already did this - skip</span>
          <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
        local_si-&gt;find_symbol_by_name(symbol_name, vi, &amp;s)
</pre>
</div>
</div>
</div>

<div id="outline-container-org0bbe600" class="outline-5">
<h5 id="org0bbe600"><span class="section-number-5">1.2.2.2</span> find_symbol_by_name</h5>
<div class="outline-text-5" id="text-1-2-2-2">
<p>

</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">find_symbol_by_name</span>:
  <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">success</span> =
    is_gnu_hash() ?
    gnu_lookup(symbol_name, vi, &amp;symbol_index) :
    elf_lookup(symbol_name, vi, &amp;symbol_index);

  <span style="font-weight: bold;">if</span> (success):
    *symbol = symbol_index == 0 ? nullptr : symtab_ + symbol_index;

<span style="font-weight: bold; text-decoration: underline;">elf_lookup</span>:
  <span style="font-weight: bold; text-decoration: underline;">uint32_t</span> <span style="font-weight: bold; font-style: italic;">hash</span> = symbol_name.elf_hash();
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">uint32_t</span> <span style="font-weight: bold; font-style: italic;">n</span> = bucket_[hash % nbucket_]; n != 0; n = chain_[n]):
    ElfW(Sym)* s = symtab_ + n;
  <span style="font-weight: bold;">if</span> (strcmp(get_string(s-&gt;st_name), symbol_name.get_name()) == 0 &amp;&amp;
      is_symbol_global_and_defined(this, s)):
    *symbol_index = n;
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdc0c87b" class="outline-4">
<h4 id="orgdc0c87b"><span class="section-number-4">1.2.3</span> __libc_init_main_thread</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">__libc_init_main_thread</span>:
  <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">pthread_internal_t</span> <span style="font-weight: bold; font-style: italic;">main_thread</span>;
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">pthread_create &#36890;&#36807; clone &#26102;&#25351;&#23450;&#30340; tls &#21442;&#25968;&#26469;&#35774;&#32622; tls</span>
  <span style="font-weight: bold;">__set_tls</span>(main_thread.tls);
  main_thread.tid = __set_tid_address(&amp;main_thread.tid);
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807; pthread_create &#21019;&#24314;&#30340;&#32447;&#31243;&#20063;&#38656;&#35201;&#35843;&#29992; __init_tls</span>
  __init_tls(&amp;main_thread);
    thread-&gt;tls[TLS_SLOT_SELF] = thread-&gt;tls;
    thread-&gt;tls[TLS_SLOT_THREAD_ID] = thread;
  __init_alternate_signal_stack(&amp;main_thread);
</pre>
</div>
</div>

<div id="outline-container-org31a0bcf" class="outline-5">
<h5 id="org31a0bcf"><span class="section-number-5">1.2.3.1</span> set_tid_address</h5>
</div>

<div id="outline-container-org0bf3a32" class="outline-5">
<h5 id="org0bf3a32"><span class="section-number-5">1.2.3.2</span> set_tls</h5>
</div>
</div>

<div id="outline-container-org60278de" class="outline-4">
<h4 id="org60278de"><span class="section-number-4">1.2.4</span> linker_so.protect_relro</h4>
</div>

<div id="outline-container-org376e7be" class="outline-4">
<h4 id="org376e7be"><span class="section-number-4">1.2.5</span> __libc_init_globals</h4>
<div class="outline-text-4" id="text-1-2-5">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">__libc_init_globals</span>:
  __libc_auxv = args.auxv;
  __libc_globals.mutate([&amp;args](<span style="font-weight: bold; text-decoration: underline;">libc_globals</span>* <span style="font-weight: bold; font-style: italic;">globals</span>) {
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#32473; __libc_globals-&gt;vdso[] &#36171;&#20540;. &#30456;&#24403;&#20110;&#20197;&#25163;&#24037;&#30340;&#26041;&#24335;&#23436;&#25104;&#20102;&#23545; vdso</span>
<span style="font-weight: bold; font-style: italic;">     * &#20013;&#23450;&#20041;&#30340;&#20989;&#25968; (gettimeofday, clock_gettime) &#30340;&#37325;&#23450;&#20301;, &#19981;&#20165;&#20165;</span>
<span style="font-weight: bold; font-style: italic;">     * linker init, &#24212;&#29992;&#33258;&#24049;&#30340; __libc_preinit &#20063;&#38656;&#35201;&#36890;&#36807;&#30456;&#21516;&#30340;&#26041;&#24335;&#32473;</span>
<span style="font-weight: bold; font-style: italic;">     * vdso &#36171;&#20540;</span><span style="font-weight: bold; font-style: italic;">*/</span>
    __libc_init_vdso(globals, args);
    __libc_init_setjmp_cookie(globals, args);
  });
</pre>
</div>
</div>
</div>

<div id="outline-container-orged7b08c" class="outline-4">
<h4 id="orged7b08c"><span class="section-number-4">1.2.6</span> linker_so.call_constructors</h4>
<div class="outline-text-4" id="text-1-2-6">
<p>
linker 由 c++ 写的并且本身有许多全局变量, 所以
linker_so.call_constructors 用来初始化这些全局变量
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">call_constructors</span>:
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#23545; linker &#26469;&#35828;, &#24403;&#21069;&#36824;&#27809;&#26377; children</span>
  <span style="font-weight: bold;">get_children</span>().for_each([] (<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span>) {
    si-&gt;call_constructors();
  });

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#35843;&#29992; init_func_, &#31867;&#22411;&#20026; linker_function_t (void (*T) ())</span>
  call_function(<span style="font-style: italic;">"DT_INIT"</span>, init_func_);
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">.init_array &#26159;&#22810;&#20010;&#20989;&#25968;&#25351;&#38024;&#32452;&#25104;&#30340;&#25968;&#32452;, c++ &#30340; ctor &#37117;&#26159;&#36890;&#36807;</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">.init_array &#23454;&#29616;&#30340;</span>
  call_array(<span style="font-style: italic;">"DT_INIT_ARRAY"</span>, init_array_, init_array_count_, <span style="font-weight: bold; text-decoration: underline;">false</span>);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org572df0d" class="outline-3">
<h3 id="org572df0d"><span class="section-number-3">1.3</span> linker 主逻辑</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org621e4d5" class="outline-4">
<h4 id="org621e4d5"><span class="section-number-4">1.3.1</span> __linker_init_post_relocation</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">__linker_init_post_relocation</span>:
  <span style="font-weight: bold;">__libc_init_AT_SECURE</span>(args);
  <span style="font-weight: bold;">__system_properties_init</span>();
  <span style="font-weight: bold;">debuggerd_init</span>();
  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">LD_DEBUG</span> = getenv(<span style="font-style: italic;">"LD_DEBUG"</span>);
  <span style="font-weight: bold;">if</span> (LD_DEBUG != nullptr):
    g_ld_debug_verbosity = atoi(LD_DEBUG);

  <span style="font-weight: bold;">if</span> (!getauxval(AT_SECURE)):
    ldpath_env = getenv(<span style="font-style: italic;">"LD_LIBRARY_PATH"</span>);
    ldpreload_env = getenv(<span style="font-style: italic;">"LD_PRELOAD"</span>);

  <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">executable_path</span> = get_executable_path();
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">executable &#20026; RTLD_GLOBAL</span>
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span> = soinfo_alloc(&amp;g_default_namespace, executable_path, &amp;file_stat, 0, RTLD_GLOBAL);

  si-&gt;phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(args.getauxval(AT_PHDR));
  si-&gt;phnum = args.getauxval(AT_PHNUM);
  si-&gt;entry = args.getauxval(AT_ENTRY);

  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i &lt; si-&gt;phnum; ++i):
    <span style="font-weight: bold;">if</span> (si-&gt;phdr[i].p_type == PT_PHDR):
      si-&gt;load_bias = reinterpret_cast&lt;ElfW(Addr)&gt;(si-&gt;phdr) - si-&gt;phdr[i].p_vaddr;
      si-&gt;base = reinterpret_cast&lt;ElfW(Addr)&gt;(si-&gt;phdr) - si-&gt;phdr[i].p_offset;
      <span style="font-weight: bold;">break</span>;

  <span style="font-weight: bold;">ElfW</span>(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(si-&gt;base);

  <span style="font-weight: bold;">parse_LD_LIBRARY_PATH</span>(ldpath_env);
  <span style="font-weight: bold;">parse_LD_PRELOAD</span>(ldpreload_env);

  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; ld_preload_name : g_ld_preload_names):
    needed_library_name_list.push_back(ld_preload_name.c_str());
    ++needed_libraries_count;
    ++ld_preloads_count;

  <span style="font-weight: bold;">for_each_dt_needed</span>(si, [&amp;](<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">name</span>):
    needed_library_name_list.push_back(name);
    ++needed_libraries_count;

  <span style="font-weight: bold;">if</span> (needed_libraries_count &gt; 0):
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">1. &#21152;&#36733; exectuable &#26102; DT_NEEDED &#24341;&#20837;&#30340; so &#40664;&#35748;&#20026; RTLD_GLOBAL</span>
<span style="font-weight: bold; font-style: italic;">    *  2. add_as_children &#20026; true, &#19982; dlopen &#26102;&#19981;&#21516;</span><span style="font-weight: bold; font-style: italic;"> */</span>
    find_libraries(&amp;g_default_namespace, si, needed_library_names, needed_libraries_count,
                   nullptr, &amp;g_ld_preloads, ld_preloads_count, RTLD_GLOBAL, nullptr,
                   <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">add_as_children</span><span style="font-weight: bold; font-style: italic;"> */</span> <span style="font-weight: bold; text-decoration: underline;">true</span>))
  <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (needed_libraries_count == 0):
    si-&gt;link_image(g_empty_list, soinfo::soinfo_list_t::make_list(si), nullptr))
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">vdso</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">add_vdso</span>(args);
  si-&gt;call_constructors();
  <span style="font-weight: bold;">return</span> si-&gt;entry;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3d9d223" class="outline-4">
<h4 id="org3d9d223"><span class="section-number-4">1.3.2</span> find_libraries</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">find_libraries</span>:
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i &lt; library_names_count; ++i):
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* name = library_names[i];
    load_tasks.push_back(LoadTask::create(name, start_with, &amp;readers_map));

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">step 1, expand load_tasks to include all DT_NEEDED libraries</span><span style="font-weight: bold; font-style: italic;"> */</span>

  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i&lt;load_tasks.size(); ++i):
    LoadTask* task = load_tasks[i];
    <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">needed_by</span> = task-&gt;get_needed_by();
    <span style="font-weight: bold;">find_library_internal</span>(ns, task, &amp;zip_archive_cache, &amp;load_tasks, rtld_flags)

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">step 2, load libraries in random order</span><span style="font-weight: bold; font-style: italic;"> */</span>
  shuffle(&amp;load_list);  
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">auto</span>&amp;&amp; task : load_list):
    task-&gt;load()

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">step 3, pre-link all DT_NEEDED libraries in breadth first order.</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">auto</span>&amp;&amp; task : load_tasks) {
    <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span> = task-&gt;get_soinfo();
    <span style="font-weight: bold;">if</span> (!si-&gt;is_linked() &amp;&amp; !si-&gt;prelink_image()) {}

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">step 4, link libraries.</span><span style="font-weight: bold; font-style: italic;"> */</span>
  soinfo::soinfo_list_t local_group;
  walk_dependencies_tree(
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509; add_as_children &#20026; true, &#34920;&#31034;&#38750; dlopen &#30340;&#24773;&#20917;, walk_dependencies_tree &#30340; root &#20026; start_with</span>
<span style="font-weight: bold; font-style: italic;">       * &#33509; add_as_children &#20026; false, &#34920;&#31034; dlopen, &#21152;&#36733;&#30340; so &#24418;&#25104; disjoint tree, root &#20026; soinfos, &#32780;&#19981;&#26159; start_with</span><span style="font-weight: bold; font-style: italic;"> */</span>
      (start_with != nullptr &amp;&amp; add_as_children) ? &amp;start_with : soinfos,
      (start_with != nullptr &amp;&amp; add_as_children) ? 1 : soinfos_count,
      [&amp;] (<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span>) {
        local_group.push_back(si);
      });

  local_group.visit([&amp;](<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span>) {
      <span style="font-weight: bold;">if</span> (!si-&gt;is_linked()) {
        <span style="font-weight: bold;">if</span> (!si-&gt;link_image(global_group, local_group, extinfo)) {
          <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
        }
      }
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
    });

</pre>
</div>
</div>

<div id="outline-container-org4605c6b" class="outline-5">
<h5 id="org4605c6b"><span class="section-number-5">1.3.2.1</span> find_library_internal</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">find_library_internal</span>:
  <span style="font-weight: bold;">if</span> (find_loaded_library_by_soname(ns, task-&gt;get_name(), &amp;candidate)):
    task-&gt;set_soinfo(candidate);
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">load_library &#20250;&#25214;&#21040;&#24182;&#25171;&#24320; so, &#35835;&#21462; DT_NEEDED, &#24182;&#25226;&#23427;&#20204;&#21152;&#21040; load_tasks</span>
<span style="font-weight: bold; font-style: italic;">   * &#20013;, &#20294;&#27492;&#26102;&#24182;&#19981;&#20250;&#20570; link_image &#30340;&#21160;&#20316;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags)
</pre>
</div>
</div>

<div id="outline-container-orgd05df59" class="outline-6">
<h6 id="orgd05df59"><span class="section-number-6">1.3.2.1.1</span> load_library</h6>
<div class="outline-text-6" id="text-1-3-2-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">load_library</span>:
  <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">fd</span> = open_library(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath);
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span> = soinfo_alloc(ns, realpath.c_str(), &amp;file_stat, file_offset, rtld_flags);
  <span style="font-weight: bold;">for_each_dt_needed</span>(task-&gt;get_elf_reader(), [&amp;](<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">name</span>) {
    load_tasks-&gt;push_back(LoadTask::create(name, si, task-&gt;get_readers_map()));
  });

<span style="font-weight: bold; text-decoration: underline;">open_library</span>:
  <span style="font-weight: bold;">if</span> (strchr(name, <span style="font-style: italic;">'/'</span>) != nullptr):
    fd = open(name, O_RDONLY | O_CLOEXEC)
    *realpath = name;
    <span style="font-weight: bold;">return</span> fd

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#25353;&#22914;&#19979;&#39034;&#24207;&#26597;&#25214; so:</span>
<span style="font-weight: bold; font-style: italic;">   * 1. ld_library_path</span>
<span style="font-weight: bold; font-style: italic;">   * 2. needed_by-&gt;rpath</span>
<span style="font-weight: bold; font-style: italic;">   * 3. default library path: /system/lib{64}</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold; text-decoration: underline;">int</span> fd = open_library_on_paths(zip_archive_cache, name, file_offset, ns-&gt;get_ld_library_paths(), realpath);
  <span style="font-weight: bold;">if</span> (fd == -1 &amp;&amp; needed_by != nullptr):
    fd = open_library_on_paths(zip_archive_cache, name, file_offset, needed_by-&gt;get_dt_runpath(), realpath);
  <span style="font-weight: bold;">if</span> (fd == -1):
    fd = open_library_on_paths(zip_archive_cache, name, file_offset, ns-&gt;get_default_library_paths(), realpath);
</pre>
</div>

<p>
load_library 在考虑 rpath 时, 使用的是 needed_by-&gt;rpath, 但
soinfo-&gt;needed_by 在实现上是一个指针而非一个列表, 实际的情况是 soinfo
有可能被多个 so NEEDED, 那哪个 so 才是它的 needed_by? 答案是
find_library_internal 时遇到的第一个 so
</p>

<pre class="example" id="org2d4185d">
$&gt; cat r1.c

void r() {
    printf("r1\n");
}

$&gt; cat r2.c

void r() {
    printf("r2\n");
}

$&gt; cat foo.c

extern void r();
void foo() {
    printf("foo\n");
    r();
}

$&gt; cat bar.c

extern void r();
void bar() {
    printf("bar\n");
}

$&gt; cat main.c

#include &lt;stdio.h&gt;
extern void foo();
int main(int argc, char *argv[]) {
    foo();
    return 0;
}

$&gt; gcc -shared r1.c -o /home/sunway/r1/libr.so
$&gt; gcc -shared r2.c -o /home/sunway/r2/libr.so
$&gt; cp /home/sunway/r1/libr.so ./libr.so
$&gt; gcc -shared foo.c -o libfoo.so -Wl,-rpath=/home/sunway/r1 libr.so
$&gt; gcc -shared bar.c -o libbar.so -Wl,-rpath=/home/sunway/r2 libr.so
$&gt; gcc main.c libfoo.so libbar.so
$&gt; LD_LIBRARY_PATH=. ./a.out
r1
$&gt; gcc main.c libbar.so libfoo.so
$&gt; LD_LIBRARY_PATH=. ./a.out
r2
</pre>
</div>
</div>
</div>

<div id="outline-container-org45e162c" class="outline-5">
<h5 id="org45e162c"><span class="section-number-5">1.3.2.2</span> walk_dependencies_tree</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<p>
walk_dependencies_tree 把树上以 start_with 为根的所有的 so (并非
solist 中所有的 so, 因为因为 dlopen 加载的 so 并不在树上) 以 BFS 方式
进行遍历放在 local_group中, 后面 link_image 也会按这个顺序在
local_group 中进行soinfo_do_lookup
</p>

<pre class="example" id="orgba990c3">
main.c
----------

#include &lt;stdio.h&gt;

extern void foo();

int main(int argc, char *argv[]) {
    foo();
    return 0;
}

foo.c
----------
extern void bar();

void x() {
    printf("x from foo\n");
}

void foo() {
    bar();
}

bar.c
----------
void x() {
    printf("x from bar\n");
}

void bar() {
    x();
}

foo2.c
----------

void x() {
    printf("x from foo2\n");
}

$&gt; gcc bar.c -shared -O0 -g3 -o libbar.so
$&gt; gcc foo.c -shared -O0 -g3 -o libfoo.so libbar.so
$&gt; gcc foo2.c -shared -O0 -g3 -o libfoo2.so

$&gt; gcc main.c -O0 -g3 libfoo2.so libfoo.so libbar.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from foo2

$&gt; gcc main.c -O0 -g3 libfoo.so libbar.so libfoo2.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from foo

$&gt; gcc main.c -O0 -g3 libbar.so libfoo2.so libfoo.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from bar
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c6ce19" class="outline-4">
<h4 id="org3c6ce19"><span class="section-number-4">1.3.3</span> LoadTask::load</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
LoadTask::load 的作用是 kernel 的 load_elf_library 基本相同
</p>

<div class="org-src-container">
<pre class="src src-c">LoadTask::load:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">elf_reader.Load &#20250; mmap so &#20013;&#30340; PTLOAD segments</span><span style="font-weight: bold; font-style: italic;"> */</span>
  elf_reader.Load(extinfo_)
  si_-&gt;base = elf_reader.load_start();
  si_-&gt;size = elf_reader.load_size();
  si_-&gt;set_mapped_by_caller(elf_reader.is_mapped_by_caller());
  si_-&gt;load_bias = elf_reader.load_bias();
  si_-&gt;phnum = elf_reader.phdr_count();
  si_-&gt;phdr = elf_reader.loaded_phdr();

ElfReader::Load:
  ReserveAddressSpace(extinfo)
  <span style="font-weight: bold;">LoadSegments</span>()
  <span style="font-weight: bold;">FindPhdr</span>()
</pre>
</div>
</div>
</div>

<div id="outline-container-org7a4daa2" class="outline-4">
<h4 id="org7a4daa2"><span class="section-number-4">1.3.4</span> LoadSegments</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
LoadSegments 负责相应的 PT_LOAD mmap 进来, 但对于 .bss 有特殊处理:
</p>

<pre class="example" id="org374d083">
$&gt; readelf -a a.out

   [24] .bss              NOBITS           0000000000201030  00001030
       0000000000000010  0000000000000000  WA       0     0     4

   LOAD           0x0000000000000e10 0x0000000000200e10 0x0000000000200e10
                  0x0000000000000220 0x0000000000000230  RW     0x200000

   03     .init_array .fini_array .dynamic .got .got.plt .data .bss

第二个 PT_LOAD 的 file siz 为 0x220, 但 memory size 为 0x230, 因为这个
PT_LOAD 最后是一个大小为 0x10 的 .bss

LoadSegments 的这段代码负责把超出 file size 的部分都 zero fill, 这与
.bss 的要求是一致的, 所以 .bss 放在 PT_LOAD 的最后并不是巧合.

zero fill 时 linker 是通过 anonymous mmap 做到的:

man 2 mmap:

  MAP_ANONYMOUS
              The mapping is not backed by any file; its contents are initialized to zero.

通过 mmap 而不是直接 zero fill 可以利用 COW 达到更好的性能
</pre>
</div>
</div>

<div id="outline-container-orgf316eca" class="outline-4">
<h4 id="orgf316eca"><span class="section-number-4">1.3.5</span> link_image</h4>
</div>
</div>

<div id="outline-container-org6df4f83" class="outline-3">
<h3 id="org6df4f83"><span class="section-number-3">1.4</span> libdl</h3>
<div class="outline-text-3" id="text-1-4">
<p>
android 的 libdl 的实现在 linker 中, 而不是在 libdl.so 中. libdl.so 只
是用来保证编译时能通过. 实际运行时 libdl.so 并不会被加载,因为它只是提
供了一些保证编译通过的 stub 函数. android linker 在运行时通过
get_libdl_info 自己构造了一个对应于 libdl.so 的 soinfo.
</p>
</div>

<div id="outline-container-org70b1e97" class="outline-4">
<h4 id="org70b1e97"><span class="section-number-4">1.4.1</span> dlopen</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold;">dlopen</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">filename</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">flags</span>):
  <span style="font-weight: bold; text-decoration: underline;">void</span>* caller_addr = __builtin_return_address(0);
  <span style="font-weight: bold;">dlopen_ext</span>(filename, flags, nullptr, caller_addr);
    <span style="font-weight: bold;">do_dlopen</span>(filename, flags, extinfo, caller_addr);

<span style="font-weight: bold; text-decoration: underline;">do_dlopen</span>:
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">caller</span> = find_containing_library(caller_addr);
  <span style="font-weight: bold; text-decoration: underline;">android_namespace_t</span>* <span style="font-weight: bold; font-style: italic;">ns</span> = get_caller_namespace(caller);
    caller != nullptr ? caller-&gt;get_primary_namespace() : g_anonymous_namespace;
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807; system.loadLibrary() &#21457;&#36215;&#30340; dlopen &#35843;&#29992;&#38656;&#35201;&#20351;&#29992;</span>
<span style="font-weight: bold; font-style: italic;">   * classloader-namepsace, &#25351;&#23450;&#22312; extinfo &#20013;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE) != 0):
    ns = extinfo-&gt;library_namespace;

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">dlopen &#26102;&#25351;&#23450;&#30340; flags (&#20363;&#22914; RTLD_GLOBAL) &#20250;&#24433;&#21709;&#22240;&#20026;&#23427;&#30340; DT_NEEDED</span>
<span style="font-weight: bold; font-style: italic;">   * &#32780;&#21152;&#36733;&#30340;&#20854;&#23427;&#30340; so &#20063;&#20351;&#29992;&#30456;&#21516;&#30340; flag</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span> = find_library(ns, name, flags, extinfo, caller);
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">find_library &#20250;&#35843;&#29992; find_libraries, &#20294; add_as_children &#20026;</span>
<span style="font-weight: bold; font-style: italic;">     * false, &#21017; dlopen load &#30340; so &#24182;&#19981;&#20250;&#25346;&#22312; dependencies tree &#20013; (&#20294;</span>
<span style="font-weight: bold; font-style: italic;">     * &#36824;&#22312; soinfo list), &#36825;&#23601;&#23548;&#33268;&#20102; dlopen &#30340; so &#26080;&#27861;&#36890;&#36807;</span>
<span style="font-weight: bold; font-style: italic;">     * walk_dependencies_tree &#25214;&#21040; (&#20363;&#22914; link_image)</span><span style="font-weight: bold; font-style: italic;">*/</span>
    <span style="font-weight: bold;">find_libraries</span>()
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">dlopen &#26102; laod_tasks &#21021;&#22987;&#21482;&#26377;&#19968;&#39033;, &#21363;&#35201; dlopen &#30340; so, start_with &#20026;&#35843;&#29992; dlopen</span>
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#30340;&#20195;&#30721;&#25152;&#22312;&#30340; so</span>
      <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i&lt;load_tasks.size(); ++i):
        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#26102; load_tasks &#20013;&#30340; task-&gt;get_needed_by &#22343;&#20026; start_with</span><span style="font-weight: bold; font-style: italic;">  */</span>
        soinfo* needed_by = task-&gt;get_needed_by();
        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">needed_by != start_with &#30340;&#21028;&#26029;&#20250;&#23548;&#33268; dlopen &#26368;&#32456;&#20250;&#24418;&#25104;&#19968;&#26869;</span>
<span style="font-weight: bold; font-style: italic;">         * disjoint tree: &#23427;&#30340;&#26681;&#26159; load_tasks[0], &#19988; load_tasks[0] &#24182;&#27809;</span>
<span style="font-weight: bold; font-style: italic;">         * &#26377;&#21152;&#21040; start_with &#25152;&#22312;&#30340;&#26641;&#20013;</span><span style="font-weight: bold; font-style: italic;"> */</span>
        <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">is_dt_needed</span> = needed_by != nullptr &amp;&amp; (needed_by != start_with || add_as_children);
        <span style="font-weight: bold;">find_library_internal</span>()
        <span style="font-weight: bold;">if</span> (is_dt_needed):
          needed_by-&gt;add_child(si);
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>

  si-&gt;call_constructors();
  <span style="font-weight: bold;">return</span> si-&gt;to_handle();
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb78ad2" class="outline-4">
<h4 id="orgeb78ad2"><span class="section-number-4">1.4.2</span> dlsym</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">dlsym</span>:
  <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">caller_addr</span> = __builtin_return_address(0);
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">caller</span> = find_containing_library(caller_addr);
  <span style="font-weight: bold; text-decoration: underline;">android_namespace_t</span>* <span style="font-weight: bold; font-style: italic;">ns</span> = get_caller_namespace(caller);
  <span style="font-weight: bold;">if</span> (handle == RTLD_DEFAULT || handle == RTLD_NEXT):
    sym = dlsym_linear_lookup(ns, sym_name, vi, &amp;found, caller, handle);
  <span style="font-weight: bold;">else</span>:
    soinfo* si = soinfo_from_handle(handle);
    sym = dlsym_handle_lookup(si, &amp;found, sym_name, vi);

  <span style="font-weight: bold;">if</span> ((bind == STB_GLOBAL || bind == STB_WEAK) &amp;&amp; sym-&gt;st_shndx != 0):
    *symbol = reinterpret_cast&lt;<span style="font-weight: bold; text-decoration: underline;">void</span>*&gt;(found-&gt;resolve_symbol_address(sym));
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
  <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;

<span style="font-weight: bold; text-decoration: underline;">dlsym_linear_lookup</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509; handle &#20026; RTLD_DEFAULT &#25110; RTLD_NEXT, &#21017;&#36827;&#34892;&#32447;&#24615;&#26597;&#25214;, &#21363;&#25353;&#29031; so</span>
<span style="font-weight: bold; font-style: italic;">   * &#34987;&#21152;&#36733;&#30340;&#39034;&#24207;&#36824;&#26597;&#25214;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">auto</span>&amp; soinfo_list = ns-&gt;soinfo_list();
  <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">start</span> = soinfo_list.begin();

  <span style="font-weight: bold;">if</span> (handle == RTLD_NEXT):
    <span style="font-weight: bold;">auto</span> it = soinfo_list.find(caller);
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">RTLD_NEXT &#26159;&#19968;&#20010;&#29305;&#27530;&#30340; handle: &#20174;&#23427;&#30340; `&#19979;&#19968;&#20010;` so &#24320;&#22987;&#26597;&#25214;, `&#19979;</span>
<span style="font-weight: bold; font-style: italic;">     * &#19968;&#20010;` &#22312;&#36825;&#37324;&#23454;&#38469;&#23601;&#26159; so &#34987;&#21152;&#36733;&#30340;&#39034;&#24207; (BFS)</span><span style="font-weight: bold; font-style: italic;">*/</span>
    start = ++it;
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509; RTLD_DEFAULT, &#21017;&#20174;&#31532;&#19968;&#20010; so &#24320;&#22987;&#26597;&#25214;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">it</span> = start, end = soinfo_list.end(); it != end; ++it):
    soinfo* si = *it;
    <span style="font-weight: bold;">if</span> ((si-&gt;get_rtld_flags() &amp; RTLD_GLOBAL) == 0):
      <span style="font-weight: bold;">continue</span>;
    <span style="font-weight: bold;">if</span> (si-&gt;find_symbol_by_name(symbol_name, vi, &amp;s)):
      *found = si
      <span style="font-weight: bold;">break</span>

dlsym_handle_lookup:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">root &#20026; handle &#20195;&#34920;&#30340; soinfo</span><span style="font-weight: bold; font-style: italic;"> */</span>
  walk_dependencies_tree(&amp;root, 1, [&amp;](<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">current_soinfo</span>) {
    <span style="font-weight: bold;">if</span> (!current_soinfo-&gt;find_symbol_by_name(symbol_name, vi, &amp;result)):
      result = nullptr;
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;

    <span style="font-weight: bold;">if</span> (result != nullptr):
      *found = current_soinfo;
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
    }
</pre>
</div>
</div>
</div>

<div id="outline-container-orgac4d075" class="outline-4">
<h4 id="orgac4d075"><span class="section-number-4">1.4.3</span> RTLD_XXX</h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<div id="outline-container-org2f693e4" class="outline-5">
<h5 id="org2f693e4"><span class="section-number-5">1.4.3.1</span> RTDL_DEFAULT</h5>
<div class="outline-text-5" id="text-1-4-3-1">
<p>
参考 dlsym_linear_lookup
</p>
</div>
</div>

<div id="outline-container-org77e6b82" class="outline-5">
<h5 id="org77e6b82"><span class="section-number-5">1.4.3.2</span> RTLD_NEXT</h5>
<div class="outline-text-5" id="text-1-4-3-2">
<p>
参考 dlsym_linear_lookup
</p>
</div>
</div>

<div id="outline-container-org2ed4197" class="outline-5">
<h5 id="org2ed4197"><span class="section-number-5">1.4.3.3</span> RTLD_GLOBAL</h5>
<div class="outline-text-5" id="text-1-4-3-3">
<p>
dlopen 时指定 RTLD_GLOBAL 与 DF_1_GLOBAL 功能相同.
</p>

<ol class="org-ol">
<li>在 create_namespace 时, 若 parent_ns 的 type 不是 shared, 则只有
RTLD_GLOBAL 类型的 so 才会被 child ns 继承</li>

<li>exectuable, preload 及所有加载 exectuable 时因为 DT_NEEDED 导入的
so 都是 RTLD_GLOBAL</li>

<li>dlopen 时指定了 RTLD_GLOBAL 时 load 的 so 以及因为它的 DT_NEEDED 导
入的 so 是 RTLD_GLOBAL</li>

<li>有 DF_1_GLOBAL flag 的 so 在 dlopen 时默认为 RTLD_GLOBAL, 且会覆盖
dlopen 的 RTLD<sub>LOCAL|GLOBAL</sub> 参数 (参考 find_libraries)</li>

<li>link_image 时, global_group (包括 executable, preload, RTLD_GLOBAL 和
DF_1_GLOBAL), 优先被查找, 其它的 so 通过 dependency tree 的 BFS 遍历被查找,
由于 RTLD_LOCAL 的so 因为没有挂在 start_from so 的 dependency tree
(add_as_children)上, 所以 link_image 时这些 so 无法被找到.</li>

<li>dlsym 使用 RTLD_DEFAULT 或 RTLD_NEXT 时使用线性查找, 但只会从
RTLD_GLOBAL 类型的 so 中查找符号</li>
</ol>
</div>
</div>


<div id="outline-container-org7f04ed1" class="outline-5">
<h5 id="org7f04ed1"><span class="section-number-5">1.4.3.4</span> RTLD_LOCAL</h5>
</div>

<div id="outline-container-orgedce09d" class="outline-5">
<h5 id="orgedce09d"><span class="section-number-5">1.4.3.5</span> RTLD_LAZY</h5>
</div>

<div id="outline-container-org9afdfbb" class="outline-5">
<h5 id="org9afdfbb"><span class="section-number-5">1.4.3.6</span> RTLD_NOLOAD</h5>
</div>

<div id="outline-container-org0145435" class="outline-5">
<h5 id="org0145435"><span class="section-number-5">1.4.3.7</span> RTLD_NODELETE</h5>
</div>
</div>
</div>

<div id="outline-container-org1edf9a6" class="outline-3">
<h3 id="org1edf9a6"><span class="section-number-3">1.5</span> android_namespace</h3>
<div class="outline-text-3" id="text-1-5">
<p>
android_namespace 的作用是阻止某些情况下 link 某些 so, 例如:
</p>

<ol class="org-ol">
<li>app 自己的代码想要 link /system/lib/libcutils.so 是不允许的, 因为
libcutils.so 不是稳定的接口, 为了应用的兼容性, android 禁用应用程序
使用 libcutils.so.</li>

<li>android 原生的 native 代码(例如 installd) 使用 libcutils.so 是允许
的.</li>
</ol>

<p>
为了支持以上的功能, android 提供了 android_namespace 的概念
</p>
</div>

<div id="outline-container-orgf2d15cc" class="outline-4">
<h4 id="orgf2d15cc"><span class="section-number-4">1.5.1</span> android_namespace_t</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">android_namespace_t</span> {
  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">name_</span>;
  <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">is_isolated_</span>;
  std::vector&lt;std::string&gt; ld_library_paths_;
  std::vector&lt;std::string&gt; default_library_paths_;
  std::vector&lt;std::string&gt; permitted_paths_;
  soinfo::soinfo_list_t soinfo_list_;  
}
</pre>
</div>

<p>
app 代码自己使用的 namepsace 是 isolated, 它能使用的 so 有如下的限
定:
</p>

<ol class="org-ol">
<li>soinfo_list_ 已经加载的 so 可以使用 (这通过是从 parent namepsace 复
制了一部分过来)</li>

<li>包含在 ld_library_paths_ 和 default_library_paths_ 中的 so</li>

<li>如果 so 是通过绝对路径加载的 (跳过了 ld_library_paths_ 和
default_library_paths_), 则它必须位于 permitted_paths_ 之内</li>
</ol>

<p>
一共三种 android_namespace:
</p>

<ol class="org-ol">
<li>g_default_namespace</li>

<li>g_anonymous_namespace</li>

<li>classloader-namespace</li>
</ol>
</div>
</div>

<div id="outline-container-org790555e" class="outline-4">
<h4 id="org790555e"><span class="section-number-4">1.5.2</span> g_default_namespace</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
g_default_namespace 是不受任何限制的 namepsace, 它可以访问任何位置
</p>
</div>
</div>

<div id="outline-container-org7f3d3ef" class="outline-4">
<h4 id="org7f3d3ef"><span class="section-number-4">1.5.3</span> g_anonymous_namespace</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
通常情况下所有代码都有其 caller namespace, 例如 g_default_namespace
加载了 libx.so 后, libx.so 中代码调用 dlopen 时, 通过 caller 代码的位
置所在的 so (libx.so) 可以确定它的 caller namespace 是
g_default_namespace
</p>

<p>
dlopen 时会根据 caller namespace 为决定是否可以 dlopen 成功.
</p>

<p>
但如果代码是自动生成的 (例如 jit), 则无法获得 caller namespace, 这时会
使用 g_anonymous_namespace 作为 caller namespace, 它的能力也是受限的.
</p>
</div>
</div>

<div id="outline-container-orgcd268d4" class="outline-4">
<h4 id="orgcd268d4"><span class="section-number-4">1.5.4</span> classloader-namespace</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
classloader-namespace 是 android 引入 namespace 的主要原因:
</p>

<p>
java 通过 PathClassLoader 加载 java 类后, java 可能会通过 jni load 某
个 so, 这时 android 会通过 classloader-namespace 限制这个 load 的行为
只能 load app 自己的 so (/data/app/lib&#x2026;) 或某些 public 的 so
</p>
</div>
</div>

<div id="outline-container-org348a6f1" class="outline-4">
<h4 id="org348a6f1"><span class="section-number-4">1.5.5</span> g_public_namespace</h4>
<div class="outline-text-4" id="text-1-5-5">
<p>
g_public_namespace 并不是一个 android_namespace_t, 它只是一些 soinfo
的集合, classloader-namespace 在 dlopen 时允许使用 g_public_namespace
中的 soinfo
</p>
</div>
</div>

<div id="outline-container-orged753ec" class="outline-4">
<h4 id="orged753ec"><span class="section-number-4">1.5.6</span> classloader-namespace 初始化</h4>
<div class="outline-text-4" id="text-1-5-6">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">JNI_CreateJavaVM</span>:
  android::InitializeNativeLoader();
    g_namespaces-&gt;Initialize();
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#35835;&#21462; /system/etc/public.libraries.txt</span><span style="font-weight: bold; font-style: italic;"> */</span>
      <span style="font-weight: bold;">ReadConfig</span>(public_native_libraries_system_config, &amp;sonames)
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#30830;&#20445; public_libraries_ &#37117;&#24050;&#32463;&#34987; load &#21040; g_default_namespace,</span>
<span style="font-weight: bold; font-style: italic;">       * &#21518;&#38754;&#20250;&#29992;&#21040;&#36825;&#19968;&#28857;</span><span style="font-weight: bold; font-style: italic;"> */</span>
      <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; soname : sonames):
        dlopen(soname.c_str(), RTLD_NOW | RTLD_NODELETE);
      public_libraries_ = base::Join(sonames, <span style="font-style: italic;">':'</span>);

<span style="font-weight: bold; text-decoration: underline;">PathClassLoaderFactory</span>:<span style="font-weight: bold;">createClassLoader</span> (librarySearchPath, libraryPermittedPath):
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">librarySearchPath &#19968;&#33324;&#26159; /data/app/xxx/lib &#36825;&#31181;&#24418;&#24335;,</span>
<span style="font-weight: bold; font-style: italic;">   * libraryPermittedPath &#19968;&#33324;&#26159; /data</span><span style="font-weight: bold; font-style: italic;"> */</span>

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314;&#20986;&#26469;&#30340; namespace &#20250;&#19982; classloader &#32465;&#23450;&#22312;&#19968;&#36215;</span><span style="font-weight: bold; font-style: italic;"> */</span>
  createClassloaderNamespace(pathClassloader,
                               librarySearchPath,
                               libraryPermittedPath,
                               isNamespaceShared);

    g_namespaces-&gt;Create(env,class_loader, is_shared, library_path, permitted_path);

<span style="font-weight: bold; text-decoration: underline;">android_namespace_t</span>* <span style="font-weight: bold;">Create</span>(<span style="font-weight: bold; text-decoration: underline;">JNIEnv</span>* <span style="font-weight: bold; font-style: italic;">env</span>,
                            <span style="font-weight: bold; text-decoration: underline;">jobject</span> <span style="font-weight: bold; font-style: italic;">class_loader</span>,
                            <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">is_shared</span>,
                            <span style="font-weight: bold; text-decoration: underline;">jstring</span> <span style="font-weight: bold; font-style: italic;">java_library_path</span>,
                            <span style="font-weight: bold; text-decoration: underline;">jstring</span> <span style="font-weight: bold; font-style: italic;">java_permitted_path</span>):

  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">init g_public_namespace</span><span style="font-weight: bold; font-style: italic;"> */</span>
  !initialized_ &amp;&amp; !InitPublicNamespace(library_path.c_str())



InitPublicNamespace(library_path.c_str():
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">public_libraries_ &#20445;&#23384;&#22312; /system/etc/public.libraries.txt</span><span style="font-weight: bold; font-style: italic;"> */</span>
    android_init_namespaces(public_libraries_.c_str(), library_path)
      <span style="font-weight: bold;">init_namespaces</span>(public_ns_sonames, anon_ns_library_path)
        <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; soname : sonames):
          <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#21069;&#38754; InitializeNativeLoader &#21487;&#20197;&#30830;&#20445; public_libraries_ &#37117;</span>
<span style="font-weight: bold; font-style: italic;">           * &#24050;&#32463;&#34987; load &#21040; g_default_namespace &#20013;&#20102;</span><span style="font-weight: bold; font-style: italic;"> */</span>
          find_loaded_library_by_soname(&amp;g_default_namespace, soname.c_str(), &amp;candidate);
          g_public_namespace.push_back(candidate);
        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#22312;&#36825;&#37324;&#21021;&#22987;&#21270;&#20102; g_anonymous_namespace, &#21487;&#35265;&#23427;&#30340; library_path</span>
<span style="font-weight: bold; font-style: italic;">         * &#26159; /dat/app/xxx/lib, &#23427;&#20250;&#20174; g_default_namespace copy &#37027;&#20123;&#24050;</span>
<span style="font-weight: bold; font-style: italic;">         * &#32463; load &#36827;&#26469;&#30340; GLOBAL &#30340; so (&#21442;&#32771; create_namespace)</span><span style="font-weight: bold; font-style: italic;"> */</span>
        anon_ns = create_namespace(nullptr, <span style="font-style: italic;">"(anonymous)"</span>, nullptr, anon_ns_library_path, ANDROID_NAMESPACE_TYPE_REGULAR, nullptr, &amp;g_default_namespace);
</pre>
</div>
</div>
</div>

<div id="outline-container-org79bbae9" class="outline-4">
<h4 id="org79bbae9"><span class="section-number-4">1.5.7</span> 使用 classloader-namespace 来 load so</h4>
<div class="outline-text-4" id="text-1-5-7">
</div>
<div id="outline-container-orgbbfcd30" class="outline-5">
<h5 id="orgbbfcd30"><span class="section-number-5">1.5.7.1</span> java 通过 loadLibrary</h5>
<div class="outline-text-5" id="text-1-5-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">OpenNativeLibrary</span>:
  ns = g_namespaces-&gt;FindNamespaceByClassLoader(env, class_loader);
  <span style="font-weight: bold;">android_dlopen_ext</span>(path, RTLD_NOW, &amp;extinfo);
    <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">caller_addr</span> = __builtin_return_address(0);
    <span style="font-weight: bold;">dlopen_ext</span>(filename, flags, extinfo, caller_addr);
      <span style="font-weight: bold;">do_dlopen</span>(filename, flags, extinfo, caller_addr);

<span style="font-weight: bold; text-decoration: underline;">do_dlopen</span>:
  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">caller</span> = find_containing_library(caller_addr);
  <span style="font-weight: bold; text-decoration: underline;">android_namespace_t</span>* <span style="font-weight: bold; font-style: italic;">ns</span> = get_caller_namespace(caller);
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#25972;&#20010;&#35843;&#29992;&#26159;&#36890;&#36807; java &#23618;&#30340; loadLibrary &#21457;&#36215;&#30340;, &#25152;&#20197; ns &#26159;&#36890;&#36807;</span>
<span style="font-weight: bold; font-style: italic;">   * classloader &#33719;&#24471;&#30340;, &#32780;&#19981;&#26159;&#36890;&#36807; get_caller_namespace</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE) != 0):
    ns = extinfo-&gt;library_namespace;

  <span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span> = find_library(ns, name, flags, extinfo, caller);
  <span style="font-weight: bold;">if</span> (si != nullptr):
    si-&gt;call_constructors();
    <span style="font-weight: bold;">return</span> si-&gt;to_handle();
</pre>
</div>
</div>
</div>

<div id="outline-container-org6bcd67f" class="outline-5">
<h5 id="org6bcd67f"><span class="section-number-5">1.5.7.2</span> jni 中通过 dlopen</h5>
<div class="outline-text-5" id="text-1-5-7-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold;">dlopen</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">filename</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">flags</span>):
  <span style="font-weight: bold; text-decoration: underline;">void</span>* caller_addr = __builtin_return_address(0);
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">dlopen &#30452;&#25509;&#20351;&#29992; dlopen_ext, &#26597;&#25214; ns &#20381;&#36182;&#20110; caller_addr</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">return</span> dlopen_ext(filename, flags, nullptr, caller_addr);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3dd6dc1" class="outline-4">
<h4 id="org3dd6dc1"><span class="section-number-4">1.5.8</span> find_library</h4>
<div class="outline-text-4" id="text-1-5-8">
<p>
find_library 的过程在前面 linker 初始化已经提过, 但没有考虑 ns
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">find_library</span>:
  <span style="font-weight: bold;">find_libraries</span>(ns, needed_by, &amp;name, 1, &amp;si, nullptr, 0, rtld_flags, extinfo, <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">add_as_children</span><span style="font-weight: bold; font-style: italic;"> */</span> <span style="font-weight: bold; text-decoration: underline;">false</span>)
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    <span style="font-weight: bold;">find_library_internal</span>(ns, task, &amp;zip_archive_cache, &amp;load_tasks, rtld_flags)
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#30001;&#20110; ns &#21019;&#24314;&#26102;&#20174; parent copy &#20102;&#19968;&#25209; soinfo, &#25152;&#20197;&#36825;&#37324;&#26377;&#21487;&#33021;&#30452;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">     * &#36820;&#22238;&#21069;&#38754;&#24050;&#32463;&#21152;&#36733;&#36807;&#30340; so (&#21487;&#33021;&#26159;&#20174; parent copy &#36807;&#26469;&#30340;)</span><span style="font-weight: bold; font-style: italic;"> */</span>
    <span style="font-weight: bold;">if</span> (find_loaded_library_by_soname(ns, task-&gt;get_name(), &amp;candidate)):
      task-&gt;set_soinfo(candidate);
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#26159;&#21542;&#23646;&#20110; g_public_namespace</span>
    <span style="font-weight: bold;">if</span> (ns != &amp;g_default_namespace):
      candidate = g_public_namespace.find_if([&amp;](<span style="font-weight: bold; text-decoration: underline;">soinfo</span>* <span style="font-weight: bold; font-style: italic;">si</span>) {
          <span style="font-weight: bold;">return</span> strcmp(task-&gt;get_name(), si-&gt;get_soname()) == 0;
        });

      <span style="font-weight: bold;">if</span> (candidate != nullptr):
        ns-&gt;add_soinfo(candidate);
        task-&gt;set_soinfo(candidate);
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;

    <span style="font-weight: bold;">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags)
      <span style="font-weight: bold;">open_library</span>(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath)
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">open_library &#25214;&#21040;&#36825;&#20010; so, &#20294;&#19981;&#26159; is_accessible, &#20363;&#22914;&#36890;&#36807;&#32477;&#23545;</span>
<span style="font-weight: bold; font-style: italic;">       * &#36335;&#24452;&#25351;&#23450;&#20102;&#19968;&#20010; so, &#20294; so &#24182;&#19981;&#22312; permitted_paths &#20013;</span><span style="font-weight: bold; font-style: italic;"> */</span>
      <span style="font-weight: bold;">if</span> (!ns-&gt;is_accessible(realpath)):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4467bae" class="outline-4">
<h4 id="org4467bae"><span class="section-number-4">1.5.9</span> 总结</h4>
<div class="outline-text-4" id="text-1-5-9">
<ol class="org-ol">
<li>classloader-namespace 是受限 (isolated) 的 namepsace, 只能加载 app
自己的 so, 从 parent 继承过来的一些 so 以及 public so</li>

<li>通过 classloader 或 caller_address 来确定当前使用的 ns</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org606be8b" class="outline-3">
<h3 id="org606be8b"><span class="section-number-3">1.6</span> dependencies tree</h3>
<div class="outline-text-3" id="text-1-6">
<p>
find_libraries 一方面会把 so 放在 soinfo list 中, 另一方面会通过
need_by 把它们组织成一个 dependencies tree.
</p>

<p>
但有一个例外: dlopen 一个 so 时会把所有涉及到的 so 加到 list 中, 但这
些 so 自身形成一棵独立的 dependencies tree, 它们并不会被加到
start_with 所在的那棵树上.
</p>

<p>
为了能在后续 link_image 时能使用 dlopen(RTLD_GLOBAL) 方式打开的 so, 这
棵独立的树上的 GLOBAL 的 so 会被加入到 global_group
(make_global_group) 中, 以便能使用这样so.
</p>

<p>
dependencies tree 有两个用处:
</p>

<ol class="org-ol">
<li>link_image</li>

<li>dlsym_handle_lookup</li>
</ol>
</div>
</div>


<div id="outline-container-org2b36fe0" class="outline-3">
<h3 id="org2b36fe0"><span class="section-number-3">1.7</span> misc</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-org17d9362" class="outline-4">
<h4 id="org17d9362"><span class="section-number-4">1.7.1</span> version_tracker</h4>
<div class="outline-text-4" id="text-1-7-1">
</div>
<div id="outline-container-orgf4a59e6" class="outline-5">
<h5 id="orgf4a59e6"><span class="section-number-5">1.7.1.1</span> init</h5>
<div class="outline-text-5" id="text-1-7-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">link_image</span>:
  version_tracker::init
  init_verneed(si_from) &amp;&amp; init_verdef(si_from);
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">init &#23436;&#25104;&#21518;, version_tracker &#26377;&#22914;&#19979;&#30340;&#25968;&#32452;:</span>

<span style="font-weight: bold; font-style: italic;">     version_infos[source_index].name = ...;</span>
<span style="font-weight: bold; font-style: italic;">     version_infos[source_index].target_si = ...;</span>

<span style="font-weight: bold; font-style: italic;">     &#35813;&#25968;&#32452;&#22823;&#23567;&#31561;&#20110; dynsym &#22823;&#23567;, &#23545;&#20110;&#24403;&#21069; so &#23450;&#20041;&#30340;&#31526;&#21495;, &#20449;&#24687;&#26159;&#20174; init_verdef &#33719;&#24471;&#30340;, target_si &#20026;&#24403;&#21069; so, </span>
<span style="font-weight: bold; font-style: italic;">     &#23545;&#20110;&#26410;&#23450;&#20041;&#30340;&#31526;&#21495;, &#20449;&#24687;&#26159;&#20174; init_verneed &#33719;&#24471;&#30340;, target_si &#20026; .gnu.version_r &#20013;&#25351;&#23450;&#30340; so</span>

<span style="font-weight: bold; font-style: italic;">     &#21518;&#32493;&#22312;&#26597;&#25214;&#31526;&#21495;&#26102;, &#38656;&#35201;&#27604;&#36739; version_info &#26159;&#21542;&#19968;&#33268;</span>
<span style="font-weight: bold; font-style: italic;">   */</span>

<span style="font-weight: bold; text-decoration: underline;">init_verneed</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; .gnu.version_r &#33719;&#24471;&#22914;&#19979;&#20449;&#24687;:</span>
<span style="font-weight: bold; font-style: italic;">   * 1. sym &#20381;&#36182;&#30340; version &#30340;&#21517;&#23383;</span>
<span style="font-weight: bold; font-style: italic;">   * 2. &#35813; version &#22312;&#21738;&#20010; soinfo &#34987;&#23450;&#20041;</span>
<span style="font-weight: bold; font-style: italic;">   *</span><span style="font-weight: bold; font-style: italic;"> */</span>

<span style="font-weight: bold; text-decoration: underline;">init_verdef</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; .gnu.version_d &#33719;&#24471;&#22914;&#19979;&#20449;&#24687;:</span>
<span style="font-weight: bold; font-style: italic;">   * 1. sym &#20381;&#36182;&#30340; version &#30340;&#21517;&#23383;</span>
<span style="font-weight: bold; font-style: italic;">   * 2. &#19981;&#38656;&#35201;&#26597;&#25214; version &#22312;&#21738;&#23450;&#20041;: &#23427;&#32943;&#23450;&#26159;&#22312;&#24403;&#21069; so &#23450;&#20041;&#30340;</span><span style="font-weight: bold; font-style: italic;"> */</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org20485a4" class="outline-5">
<h5 id="org20485a4"><span class="section-number-5">1.7.1.2</span> relocate</h5>
<div class="outline-text-5" id="text-1-7-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold; text-decoration: underline;">relocate</span>:
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; so &#20013;&#38656;&#35201;&#37325;&#23450;&#20301;&#30340; sym</span><span style="font-weight: bold; font-style: italic;"> */</span>
  sym_name = get_string(symtab_[sym].st_name);
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33719;&#24471; version_info</span><span style="font-weight: bold; font-style: italic;"> */</span>
  <span style="font-weight: bold;">lookup_version_info</span>(version_tracker, sym, sym_name, &amp;vi))
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Versym</span>) sym_ver = *(get_versym(sym));
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">*sym_ver &#26159; sym &#30340; version &#30340; index &#20540;</span><span style="font-weight: bold; font-style: italic;"> */</span>
    *vi = version_tracker.get_version_info(sym_ver);
      <span style="font-weight: bold;">return</span> &amp;version_infos[source_symver];
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807; lookup_version_info, &#33719;&#24471;&#20102; sym &#35201;&#27714;&#30340; version name, &#20197;&#21450;</span><span style="font-weight: bold; font-style: italic;"> */</span>

  <span style="font-weight: bold;">soinfo_do_lookup</span>(this, sym_name, vi, &amp;lsi, global_group, local_group, &amp;s)
    si-&gt;find_symbol_by_name(symbol_name, vi, &amp;s)
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">suppose not using gnu hash</span><span style="font-weight: bold; font-style: italic;"> */</span>
      <span style="font-weight: bold;">elf_lookup</span>(symbol_name, vi, &amp;symbol_index)

elf_lookup:
  <span style="font-weight: bold;">if</span> (!find_verdef_version_index(vi, &amp;verneed)):
    for_each_verdef(this,
      [&amp;](size_t, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Verdef</span>)* verdef, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Verdaux</span>)* verdaux) {
                      <span style="font-weight: bold;">if</span> (verdef-&gt;vd_hash == vi-&gt;elf_hash &amp;&amp;
                          strcmp(vi-&gt;name, get_string(verdaux-&gt;vda_name)) == 0) {
                        *versym = verdef-&gt;vd_ndx;
                        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
                      }

                      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
                    }
      );
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span>;
  <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#22312;&#24403;&#21069; so &#30340; .gnu.version_d &#20013;&#25214;&#21040;&#35201;&#27714;&#30340; version name &#23545;&#24212;&#30340;</span>
<span style="font-weight: bold; font-style: italic;">   * version index (verneed)</span><span style="font-weight: bold; font-style: italic;"> */</span>

  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">uint32_t</span> <span style="font-weight: bold; font-style: italic;">n</span> = bucket_[hash % nbucket_]; n != 0; n = chain_[n]):
    ElfW(Sym)* s = symtab_ + n;
    <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#35835;&#21462; .gnu.version &#33719;&#24471;&#24403;&#21069; so &#20013; sym (n) &#30340; version (verdef)</span><span style="font-weight: bold; font-style: italic;"> */</span>
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ElfW</span>(<span style="font-weight: bold; font-style: italic;">Versym</span>)* verdef = get_versym(n);
    <span style="font-weight: bold;">if</span> (
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">check version</span><span style="font-weight: bold; font-style: italic;"> */</span>
      check_symbol_version(verneed, verdef) &amp;&amp;
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">check name</span><span style="font-weight: bold; font-style: italic;"> */</span>
      strcmp(get_string(s-&gt;st_name), symbol_name.get_name()) == 0 &amp;&amp;
      <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">check visibility</span><span style="font-weight: bold; font-style: italic;"> */</span>
      is_symbol_global_and_defined(this, s)):
      *symbol_index = n;
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf43f41c" class="outline-5">
<h5 id="orgf43f41c"><span class="section-number-5">1.7.1.3</span> 总结</h5>
<div class="outline-text-5" id="text-1-7-1-3">
<p>
link_image 时会针对要 link 的当前 so 构造一个 version_tracker, 主要就
是读取了 .gnu.version 和 .gnu.version_r, 确定 UNDEF 的符号要求的
version 的名字 (verneed)
</p>

<p>
relocate 时需要判断 so 中某个 sym 的 verdef 与 verneed 是否相同. 而
verdef 是通过读取 so 的 .gnu.version 和 .gnu.version_d 获得的. 
</p>
</div>
</div>
</div>

<div id="outline-container-orgff22d82" class="outline-4">
<h4 id="orgff22d82"><span class="section-number-4">1.7.2</span> how linker is compiled</h4>
<div class="outline-text-4" id="text-1-7-2">
<pre class="example" id="org5494733">
clang++ -nostdlib -Bstatic  -Wl,--gc-sections -o /linker_intermediates/LINKED/linker64 -Lout/target/product/sp9850j_1h10/obj/lib

-Wl,-z,noexecstack -Wl,-z,relro -Wl,-z,now -Wl,--build-id=md5 -Wl,--warn-shared-textrel -Wl,--fatal-warnings -Wl,-maarch64linux -Wl,--hash-style=gnu -Wl,--fix-cortex-a53-843419 -fuse-ld=gold -Wl,--icf=safe -Wl,--no-undefined-version -Wl,--allow-shlib-undefined    -target aarch64-linux-android -Bprebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/aarch64-linux-android/bin   -shared -Wl,-Bsymbolic -Wl,--exclude-libs,ALL -Wl,--no-undefined

/linker_intermediates/arch/arm64/begin.o   /linker_intermediates/debugger.o /linker_intermediates/dlfcn.o /linker_intermediates/linker.o /linker_intermediates/linker_allocator.o /linker_intermediates/linker_block_allocator.o /linker_intermediates/linker_dlwarning.o /linker_intermediates/linker_gdb_support.o /linker_intermediates/linker_mapped_file_fragment.o /linker_intermediates/linker_memory.o /linker_intermediates/linker_phdr.o /linker_intermediates/linker_sdk_versions.o /linker_intermediates/linker_utils.o /linker_intermediates/rt.o       /linker_intermediates/linker_libc_support.o

-Wl,--whole-archive   -Wl,--no-whole-archive /libziparchive_intermediates/libziparchive.a /libutils_intermediates/libutils.a /libbase_intermediates/libbase.a /libz_intermediates/libz.a /liblog_intermediates/liblog.a /libc++_static_intermediates/libc++_static.a /libm_intermediates/libm.a /libdl_intermediates/libdl.a /libcompiler_rt-extras_intermediates/libcompiler_rt-extras.a 

-Wl,--start-group
/libc_intermediates/libc.a /libc_nomalloc_intermediates/libc_nomalloc.a  prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/../lib/gcc/aarch64-linux-android/4.9/../../../../aarch64-linux-android/lib/../lib64/libatomic.a prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/../lib/gcc/aarch64-linux-android/4.9/libgcc.a
-Wl,--end-group

aarch64-linux-android-objcopy --prefix-symbols=__dl_ /linker_intermediates/LINKED/linker64                         
</pre>

<p>
所以 linker 是一个 DSO, 而且它编译时使用了 Bsymbolic, 所以在完成自身的
重定位之前, 它就已经可以正确的调用自身的各种函数了, 因为这些函数不是通
过 plt 的方式来调用的.
</p>

<p>
参考 
</p>
</div>
</div>

<div id="outline-container-org7118a5d" class="outline-4">
<h4 id="org7118a5d"><span class="section-number-4">1.7.3</span> RTLD_GLOBAL, DF_1_GLOBAL, global_group</h4>
<div class="outline-text-4" id="text-1-7-3">
<p>
RTLD_GLOBAL 与 DF_1_GLOBAL 有关:
</p>

<ol class="org-ol">
<li>dlopen 时使用 RTLD_GLOBAL flag</li>
<li>应用启动时加载的 so (通过 DT_NEEDED, 自动指定了 RTLD_GLOBAL)</li>
<li>dlopen 时 load 了一个指定了 DF_1_GLOBAL 的 so</li>
</ol>

<p>
三种情况 load 的 so 都带有 RTLD_GLOBAL 标记, 后续 dlopen 打开的 so 可以直接使用
这些 so中的符号. <a href="http://www.informit.com/articles/article.aspx?p=22435">http://www.informit.com/articles/article.aspx?p=22435</a>
</p>

<p>
global_group 也和 DF_1_GLOBAL 有关:
</p>

<p>
exectuable, LD_PRELOAD (不包含其 DT_NEEDED 引入的 so) 以及 DF_1_GLOBAL 的 so 属
于 global_group, 在 lookup 时优先考虑
</p>
</div>
</div>
</div>

<div id="outline-container-org7d22a97" class="outline-3">
<h3 id="org7d22a97"><span class="section-number-3">1.8</span> summary</h3>
<div class="outline-text-3" id="text-1-8">
<p>
linker 主要的代码是:
</p>

<ol class="org-ol">
<li>load_library, 找到 so</li>

<li>find_libraries, 解析 DT_NEEDED, 构造依赖树</li>

<li>对各个 so 以 BFS 的顺序进行 link_image, 进行 GOT 和 PLT 的重定位</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org83b7ec3" class="outline-2">
<h2 id="org83b7ec3"><span class="section-number-2">2</span> init</h2>
</div>

<div id="outline-container-org74443c9" class="outline-2">
<h2 id="org74443c9"><span class="section-number-2">3</span> link_image</h2>
</div>

<div id="outline-container-orgecd1352" class="outline-2">
<h2 id="orgecd1352"><span class="section-number-2">4</span> find_libraries</h2>
</div>

<div id="outline-container-org9c1bb43" class="outline-2">
<h2 id="org9c1bb43"><span class="section-number-2">5</span> dlfcn</h2>
</div>

<div id="outline-container-orgdd6946a" class="outline-2">
<h2 id="orgdd6946a"><span class="section-number-2">6</span> android_namespace</h2>
</div>

<div id="outline-container-orgb19dfe4" class="outline-2">
<h2 id="orgb19dfe4"><span class="section-number-2">7</span> version_tracker</h2>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-04-27 Thu 00:00<br />
Last updated: 2021-10-26 Tue 19:44</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
