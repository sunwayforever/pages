<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 19:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Android Linker</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Android Linker</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02cfde9">1. Android Linker</a>
<ul>
<li><a href="#org33a6818">1.1. linker 启动</a>
<ul>
<li><a href="#org66a00e8">1.1.1. kernel 部分</a></li>
<li><a href="#orgcf52473">1.1.2. linker 部分</a></li>
<li><a href="#org0fdc2d8">1.1.3. 总结</a></li>
</ul>
</li>
<li><a href="#org20ba130">1.2. linker 自身的重定位</a>
<ul>
<li><a href="#org3418599">1.2.1. linker_so.prelink_image</a></li>
<li><a href="#org8c76789">1.2.2. linker_so.link_image</a></li>
<li><a href="#orga914b7c">1.2.3. __libc_init_main_thread</a></li>
<li><a href="#orgda36692">1.2.4. linker_so.protect_relro</a></li>
<li><a href="#org0190776">1.2.5. __libc_init_globals</a></li>
<li><a href="#org6a9535d">1.2.6. linker_so.call_constructors</a></li>
</ul>
</li>
<li><a href="#org866716e">1.3. linker 主逻辑</a>
<ul>
<li><a href="#org83a6fbe">1.3.1. __linker_init_post_relocation</a></li>
<li><a href="#org75b2f57">1.3.2. find_libraries</a></li>
<li><a href="#org12dc2fd">1.3.3. LoadTask::load</a></li>
<li><a href="#orgc04e002">1.3.4. LoadSegments</a></li>
<li><a href="#org9d35189">1.3.5. link_image</a></li>
</ul>
</li>
<li><a href="#orga13200c">1.4. libdl</a>
<ul>
<li><a href="#orgb4f567e">1.4.1. dlopen</a></li>
<li><a href="#org83d5ef7">1.4.2. dlsym</a></li>
<li><a href="#orgf3d1862">1.4.3. RTLD_XXX</a></li>
</ul>
</li>
<li><a href="#org648a009">1.5. android_namespace</a>
<ul>
<li><a href="#org13c18d6">1.5.1. android_namespace_t</a></li>
<li><a href="#org75ad76d">1.5.2. g_default_namespace</a></li>
<li><a href="#org036061c">1.5.3. g_anonymous_namespace</a></li>
<li><a href="#org4c6e679">1.5.4. classloader-namespace</a></li>
<li><a href="#orgc4c6507">1.5.5. g_public_namespace</a></li>
<li><a href="#orge547f39">1.5.6. classloader-namespace 初始化</a></li>
<li><a href="#orga4545ca">1.5.7. 使用 classloader-namespace 来 load so</a></li>
<li><a href="#org86b6a03">1.5.8. find_library</a></li>
<li><a href="#orgc859c0d">1.5.9. 总结</a></li>
</ul>
</li>
<li><a href="#org74c0770">1.6. dependencies tree</a></li>
<li><a href="#org55ebd2e">1.7. misc</a>
<ul>
<li><a href="#org6aac646">1.7.1. version_tracker</a></li>
<li><a href="#orgb309f18">1.7.2. how linker is compiled</a></li>
<li><a href="#orgb86d7cc">1.7.3. RTLD_GLOBAL, DF_1_GLOBAL, global_group</a></li>
</ul>
</li>
<li><a href="#org4913190">1.8. summary</a></li>
</ul>
</li>
<li><a href="#org5666638">2. init</a></li>
<li><a href="#orgc88c1fb">3. link_image</a></li>
<li><a href="#org8dd94a1">4. find_libraries</a></li>
<li><a href="#orgafde92c">5. dlfcn</a></li>
<li><a href="#org11e4315">6. android_namespace</a></li>
<li><a href="#org9513946">7. version_tracker</a></li>
</ul>
</div>
</div>

<div id="outline-container-org02cfde9" class="outline-2">
<h2 id="org02cfde9"><span class="section-number-2">1</span> Android Linker</h2>
<div class="outline-text-2" id="text-1">
</div>

<div id="outline-container-org33a6818" class="outline-3">
<h3 id="org33a6818"><span class="section-number-3">1.1</span> linker 启动</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org66a00e8" class="outline-4">
<h4 id="org66a00e8"><span class="section-number-4">1.1.1</span> kernel 部分</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
以 exec("/system/bin/linker") 为例:
</p>

<ol class="org-ol">
<li><p>
linker 本身的 interp 是它自己:
</p>

<pre class="example" id="orgb403c2e">
~@tj02433pcu&gt; readelf -a /system/bin/linker|grep 'program inter'
       [Requesting program interpreter: /system/bin/linker]
</pre></li>

<li><p>
linker 的 entry 为 __dl__start, 地址为 0x28fc
</p>

<pre class="example" id="orgf89575c">
~@tj02433pcu&gt; readelf -a /system/bin/linker|grep 'Entry point'
  Entry point address:               0x28fc
</pre></li>
</ol>

<p>
kernel 会如下设置:
</p>

<ol class="org-ol">
<li><p>
/system/bin/linker 做为 exectuable 被 map 一次, 然后由于 linker 指定了 iterp 是 /system/bin/linker, 所以它会做为 shared object 再次被
map 一次
</p>

<pre class="example" id="orgce3139a">
00000000aaaaa000    440K r-x--  /system/bin/linker  &lt;--- 做为 exectuable 被 map
00000000aab18000     12K rw---  /system/bin/linker  
00000000aab1b000     20K rw---    [heap]
00000000f777b000    440K r-x--  /system/bin/linker  &lt;--- 做为 interp 再次被 map
00000000f77e9000     12K rw---  /system/bin/linker
00000000f77ec000     20K rw---    [anon]
00000000fffcf000    132K rw---    [stack]
00000000ffff0000      4K r-x--    [vectors]
</pre></li>

<li><p>
控制会转移到 interp, 其入口为 0xf777d8fc, 这个地址对应于 interp 的
__dl__start:
</p>

<pre class="example" id="org56e14f7">
f777b000 (inter 被 map 的地址) + 0x28fc (entry point) = 0xf777d8fc
</pre></li>

<li>aux vector

<ol class="org-ol">
<li>AT_BASE 为 0xf777b000, 即 interp 被 map 的地址</li>

<li>AT_ENTRY 为 0xaaaac8fc, 即 exectuable 本身的 entry, 由于
exectuable 被 map 在0xaaaaa000, 所以其 entry 为
0xaaaaa0000 + 0x28fc = 0xaaaac8fc (至于 exectuable 为什么被 map
在 0xaaaaa000, 参考 ELF_ET_DYN_BASE)</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orgcf52473" class="outline-4">
<h4 id="orgcf52473"><span class="section-number-4">1.1.2</span> linker 部分</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">__linker_init</span>:
  <span style="color: #268bd2;">ElfW</span><span style="color: #757575;">(</span><span style="color: #b58900;">Addr</span><span style="color: #757575;">)</span> linker_addr = args.getauxval<span style="color: #757575;">(</span>AT_BASE<span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">ElfW</span><span style="color: #757575;">(</span><span style="color: #b58900;">Addr</span><span style="color: #757575;">)</span> entry_point = args.getauxval<span style="color: #757575;">(</span>AT_ENTRY<span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>&amp;_start<span style="color: #757575;">)</span> == entry_point<span style="color: #757575;">)</span>:
    __libc_format_fd<span style="color: #757575;">(</span>STDOUT_FILENO<span style="color: #757575;">,</span>
                   <span style="color: #2aa198;">"This is %s, the helper program\n"</span><span style="color: #757575;">,</span>
                   args.argv[0]<span style="color: #757575;">)</span>;
    exit<span style="color: #757575;">(</span>0<span style="color: #757575;">)</span>
  linker_so.base = linker_addr;
  linker_so.size = phdr_table_get_load_size<span style="color: #757575;">(</span>phdr<span style="color: #757575;">,</span> elf_hdr-&gt;e_phnum<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">load_bias &#26159; so &#20013;&#30340; vadd &#19982;&#23454;&#38469;&#22320;&#22336;&#30340;&#20559;&#31227;&#37327;</span><span style="color: #586e75;"> */</span>
  linker_so.load_bias = get_elf_exec_load_bias<span style="color: #757575;">(</span>elf_hdr<span style="color: #757575;">)</span>;
  linker_so.dynamic = nullptr;
  linker_so.phdr = phdr;
  linker_so.phnum = elf_hdr-&gt;e_phnum;
  linker_so.set_linker_flag<span style="color: #757575;">()</span>;

<span style="color: #268bd2; font-weight: bold;">get_elf_exec_load_bias</span>:
  <span style="color: #268bd2;">ElfW</span><span style="color: #757575;">(</span><span style="color: #b58900;">Addr</span><span style="color: #757575;">)</span> offset = elf-&gt;e_phoff;
  <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Phdr</span><span style="color: #757575;">)</span>* phdr_table =
    reinterpret_cast&lt;<span style="color: #859900;">const</span> ElfW<span style="color: #757575;">(</span>Phdr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>reinterpret_cast&lt;uintptr_t&gt;<span style="color: #757575;">(</span>elf<span style="color: #757575;">)</span> + offset<span style="color: #757575;">)</span>;
  <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Phdr</span><span style="color: #757575;">)</span>* phdr_end = phdr_table + elf-&gt;e_phnum;

  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Phdr</span><span style="color: #757575;">)</span>* phdr = phdr_table; phdr &lt; phdr_end; phdr++<span style="color: #757575;">)</span>:
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>phdr-&gt;p_type == PT_LOAD<span style="color: #757575;">)</span>:
      <span style="color: #586e75;">// </span><span style="color: #586e75;">elf_hdr + (phdr-&gt;p_offset) &#26159;&#36825;&#20010; segment &#34987;&#26144;&#23556;&#30340;&#23454;&#38469;&#22320;&#22336;,</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19982;p_vaddr &#30340;&#24046;&#21363;&#26159; load_bias, &#36825;&#19968;&#28857;&#21482;&#33021;&#31532;&#19968;&#20010; PT_LOAD &#26377;&#25928;:</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22240;&#20026; elf_hdr &#23454;&#38469;&#23601;&#26159;&#31532;&#19968;&#20010; PT_LAOD &#23454;&#38469;&#30340;&#26144;&#23556;&#22320;&#22336;, &#32780;&#19988;&#23427;&#30340;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">phdr-&gt;p_offset &#20026; 0</span>
      <span style="color: #859900;">return</span> reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>elf<span style="color: #757575;">)</span> + phdr-&gt;p_offset - phdr-&gt;p_vaddr;
</pre>
</div>

<p>
_start 即 __dl__start 函数 (参考 ), 这里由于 linker 本身并没有完成重定位, 所以通过 GOT 引用到的 __dl__start 地址是 GOT 中原始的值, 即 0x28fc
</p>

<pre class="example" id="orgef21293">
objdump -D linker:

0006fddc &lt;__dl__GLOBAL_OFFSET_TABLE_-0x218&gt;:
   6fddc:	000715b8 			; &lt;UNDEFINED&gt; instruction: 0x000715b8
   6fde0:	000711d0 	ldrdeq	r1, [r7], -r0
   6fde4:	000716bc 			; &lt;UNDEFINED&gt; instruction: 0x000716bc
   6fde8:	0006eaf4 	strdeq	lr, [r6], -r4
   6fdec:	00070174 	andeq	r0, r7, r4, ror r1
   6fdf0:	000028fc 	strdeq	r2, [r0], -ip              &lt;--- GOT 中的原始值为 0x28fc
</pre>

<p>
而 entry_point 的值是 0xaaaac8fc, 所以这里的条件并不会成立.
</p>

<p>
linker 后续的代码会完成 linker 本身及 exectuable (这里也是 linker&#x2026;)
的重定位, 包括填充 exectuable 对应的 GOT 表, 然后第二次跳转到
__linker_init
</p>

<pre class="example" id="org5cac332">
~/source/sharklj1@tj02433pcu&gt; d debug exec out/target/product/sp9850j_1h10/symbols/system/bin/linker /system/bin/linker
Remote debugging from host 127.0.0.1
__dl__start () at bionic/linker/arch/arm/begin.S:32
32        mov r0, sp
(gdb) b __dl___linker_init
Breakpoint 1 at 0xaaab6e38: __dl___linker_init. (2 locations)
(gdb) c
Continuing.

Breakpoint 1, __linker_init (raw_args=0xfffefa80) at bionic/linker/linker.cpp:4400
4400      KernelArgumentBlock args(raw_args);
(gdb) n
4402      ElfW(Addr) linker_addr = args.getauxval(AT_BASE);
(gdb) 
4403      ElfW(Addr) entry_point = args.getauxval(AT_ENTRY);
(gdb) 
4404      ElfW(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);
(gdb) 
4405      ElfW(Phdr)* phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);
(gdb) 
4407      soinfo linker_so(nullptr, nullptr, nullptr, 0, 0);
(gdb) 
4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e80      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e82      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e84      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xf7787e86      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
// 这里引用 r2 (即 _start) 使用的是 interp 的 GOT
(gdb) p /x $r2
$2 = 0x28fc
(gdb) p entry_point
$3 = 2863319292
(gdb) p /x entry_point
$4 = 0xaaaac8fc
(gdb) n
4423      linker_so.base = linker_addr;
(gdb) c
Continuing.

Breakpoint 1, __linker_init (raw_args=0xfffefa80) at bionic/linker/linker.cpp:4400
4400      KernelArgumentBlock args(raw_args);
(gdb) n
4402      ElfW(Addr) linker_addr = args.getauxval(AT_BASE);
(gdb) 
4403      ElfW(Addr) entry_point = args.getauxval(AT_ENTRY);
(gdb) 
4404      ElfW(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);
(gdb) 
4405      ElfW(Phdr)* phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);
(gdb) 
4407      soinfo linker_so(nullptr, nullptr, nullptr, 0, 0);
(gdb) 
4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) ni
0xaaab6e80      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e82      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e84      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
(gdb) 
0xaaab6e86      4416      if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) {
// 这里引用 r2 (即 _start) 使用的是 executable 的 GOT
(gdb) p /x $r2
$5 = 0xaaaac8fc
(gdb) p /x entry_point
$6 = 0xaaaac8fc
(gdb) c
This is /system/bin/linker, the helper program
</pre>
</div>
</div>

<div id="outline-container-org0fdc2d8" class="outline-4">
<h4 id="org0fdc2d8"><span class="section-number-4">1.1.3</span> 总结</h4>
<div class="outline-text-4" id="text-1-1-3">
<ol class="org-ol">
<li>kernel 负责分别将 linker 和 exectuable(在本例中即 linker 自身) map
到某个位置 (最基本的重定位), 并设置好 AT_BASE 和 AT_ENTRY</li>
<li>kernel 随后跳转到 linker(interp 的 __dl__start</li>
<li>__dl__start 负责进行 linker 自身及 exectuable 的重定位</li>
<li>linker 最后跳转到 AT_ENTRY 指定的 exectuable 的 entry</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org20ba130" class="outline-3">
<h3 id="org20ba130"><span class="section-number-3">1.2</span> linker 自身的重定位</h3>
<div class="outline-text-3" id="text-1-2">
<p>
linker 作为 interp 启动后需要首先完成自身的重定位.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">__linker_init</span>:
  linker_so.prelink_image<span style="color: #757575;">()</span>
  linker_so.link_image<span style="color: #757575;">(</span>g_empty_list<span style="color: #757575;">,</span> g_empty_list<span style="color: #757575;">,</span> nullptr<span style="color: #757575;">)</span>
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">link_image &#21518;, linker &#25165;&#33021;&#20351;&#29992;&#20854;&#20840;&#23616;&#21464;&#37327;, &#21253;&#25324;&#21518;&#38754;&#35201;&#20351;&#29992;&#30340; __libc_globals</span><span style="color: #586e75;"> */</span>
  <span style="color: #268bd2;">__libc_init_main_thread</span><span style="color: #757575;">(</span><span style="color: #b58900;">args</span><span style="color: #757575;">)</span>;
  linker_so.protect_relro<span style="color: #757575;">()</span>
  <span style="color: #268bd2;">__libc_init_globals</span><span style="color: #757575;">(</span><span style="color: #b58900;">args</span><span style="color: #757575;">)</span>;
  linker_so.call_constructors<span style="color: #757575;">()</span>;
</pre>
</div>
</div>

<div id="outline-container-org3418599" class="outline-4">
<h4 id="org3418599"><span class="section-number-4">1.2.1</span> linker_so.prelink_image</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li><p>
prelink_image
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">prelink_image</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#26597;&#25214; PT_DYNAMIC &#31867;&#22411;&#30340; phdr, &#20197;&#33719;&#24471; .dynamic section &#30340;&#22320;&#22336;</span><span style="color: #586e75;"> */</span>
  <span style="color: #268bd2;">phdr_table_get_dynamic_section</span><span style="color: #757575;">(</span><span style="color: #b58900;">phdr</span><span style="color: #757575;">,</span> <span style="color: #b58900;">phnum</span><span style="color: #757575;">,</span> <span style="color: #b58900;">load_bias</span><span style="color: #757575;">,</span> &amp;dynamic<span style="color: #757575;">,</span> &amp;dynamic_flags<span style="color: #757575;">)</span>;
    <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">i</span> = 0; i&lt;phdr_count; ++i<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Phdr</span><span style="color: #757575;">)</span>&amp; phdr = phdr_table[i];
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>phdr.p_type == PT_DYNAMIC<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        *dynamic = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Dyn<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>load_bias + phdr.p_vaddr<span style="color: #757575;">)</span>;
        <span style="color: #859900;">return</span>
   <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#35299;&#26512; dynamic section &#30340;&#20449;&#24687;</span><span style="color: #586e75;"> */</span>
   <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36825;&#37324;&#20250;&#20570;&#26368;&#22522;&#26412;&#30340;&#37325;&#23450;&#20301;: dynamic section &#20013;&#35760;&#24405;&#30340;&#21508;&#31181; p_ptr &#21152;&#19978;</span>
<span style="color: #586e75;">    * &#19968;&#20010; load_bias &#23601;&#26159;&#23545;&#24212;&#30340;&#20869;&#23384;&#30340;&#22320;&#22336;</span><span style="color: #586e75;"> */</span>
   <span style="color: #859900;">for</span> <span style="color: #757575;">(</span>ElfW<span style="color: #757575;">(</span>Dyn<span style="color: #757575;">)</span>* d = dynamic; d-&gt;d_tag != DT_NULL; ++d<span style="color: #757575;">)</span>:
     <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>d-&gt;d_tag<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
         <span style="color: #859900;">case</span> DT_STRTAB:
           strtab_ = reinterpret_cast&lt;<span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*&gt;<span style="color: #757575;">(</span>load_bias + d-&gt;d_un.d_ptr<span style="color: #757575;">)</span>; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_STRSZ:
           strtab_size_ = d-&gt;d_un.d_val; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_SYMTAB:
           symtab_ = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Sym<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>load_bias + d-&gt;d_un.d_ptr<span style="color: #757575;">)</span>; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_RELA:
           rela_ = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Rela<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>load_bias + d-&gt;d_un.d_ptr<span style="color: #757575;">)</span>; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_INIT:
           init_func_ = reinterpret_cast&lt;linker_function_t&gt;<span style="color: #757575;">(</span>load_bias + d-&gt;d_un.d_ptr<span style="color: #757575;">)</span>; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_INIT_ARRAY:
           init_array_ = reinterpret_cast&lt;linker_function_t*&gt;<span style="color: #757575;">(</span>load_bias + d-&gt;d_un.d_ptr<span style="color: #757575;">)</span>; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_NEEDED:
           ++needed_count; <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_SONAME:
           <span style="color: #586e75;">// </span><span style="color: #586e75;">this is parsed after we have strtab initialized (see below).</span>
           <span style="color: #859900;">break</span>;
         <span style="color: #859900;">case</span> DT_RUNPATH:
           <span style="color: #586e75;">// </span><span style="color: #586e75;">this is parsed after we have strtab initialized (see below).</span>
           <span style="color: #859900;">break</span>;
         <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#35299;&#26512; strtab, &#32473;&#20381;&#36182;&#20110; strtab &#30340; entry &#36171;&#20540; (soname, runpath)</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">for</span> <span style="color: #757575;">(</span>ElfW<span style="color: #757575;">(</span>Dyn<span style="color: #757575;">)</span>* d = dynamic; d-&gt;d_tag != DT_NULL; ++d<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>d-&gt;d_tag<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">case</span> DT_SONAME:
          set_soname<span style="color: #757575;">(</span>get_string<span style="color: #757575;">(</span>d-&gt;d_un.d_val<span style="color: #757575;">))</span>; <span style="color: #859900;">break</span>;
        <span style="color: #859900;">case</span> DT_RUNPATH:
          set_dt_runpath<span style="color: #757575;">(</span>get_string<span style="color: #757575;">(</span>d-&gt;d_un.d_val<span style="color: #757575;">))</span>; <span style="color: #859900;">break</span>;
</pre>
</div></li>

<li><p>
get_string
</p>

<p>
DT_SONAME 和 DT_RUNPATH 的 d_val 是相对于 dynstr 的 offset
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">get_string</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36825;&#37324;&#30340; strtab_ &#26469;&#33258; .dynamic &#20013; DT_STRTAB, &#23454;&#38469;&#19978;&#25351;&#21521; .dynstr (&#32780;</span>
<span style="color: #586e75;">   * &#19981;&#26159; .strtab)</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">return</span> strtab_ + index;
</pre>
</div>

<pre class="example" id="orga72f992">
$&gt; readelf -a ./a.out

Dynamic section at offset 0x8a0 contains 27 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [/home/sunway/libtest.so]
 ...
 0x0000000000000005 (STRTAB)             0x3a8


Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  ... 
  [ 6] .dynstr           STRTAB           00000000000003a8  000003a8
       00000000000000ce  0000000000000000   A       0     0     1

$&gt; readelf -p .synstr ./a.out
String dump of section '.dynstr':
  [     1]  libc.so.6
  ...
  [    32]  /home/sunway/libtest.so
  ...

$&gt; od -x ./a.out +0x8a0
0004240 0001 0000 0000 0000 0001 0000 0000 0000
0004260 000f 0000 0000 0000 0032 0000 0000 0000
...
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org8c76789" class="outline-4">
<h4 id="org8c76789"><span class="section-number-4">1.2.2</span> linker_so.link_image</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">link_image</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">relocate rel{a}.dyn</span>
  <span style="color: #268bd2;">relocate</span><span style="color: #757575;">(</span><span style="color: #b58900;">version_tracker</span><span style="color: #757575;">,</span> plain_reloc_iterator<span style="color: #757575;">(</span><span style="color: #b58900;">rela_</span><span style="color: #757575;">,</span> <span style="color: #b58900;">rela_count_</span><span style="color: #757575;">),</span> <span style="color: #b58900;">global_group</span><span style="color: #757575;">,</span> <span style="color: #b58900;">local_group</span><span style="color: #757575;">)</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">relocate rel{a}.plt</span>
  <span style="color: #268bd2;">relocate</span><span style="color: #757575;">(</span><span style="color: #b58900;">version_tracker</span><span style="color: #757575;">,</span> plain_reloc_iterator<span style="color: #757575;">(</span><span style="color: #b58900;">plt_rela_</span><span style="color: #757575;">,</span> <span style="color: #b58900;">plt_rela_count_</span><span style="color: #757575;">),</span> <span style="color: #b58900;">global_group</span><span style="color: #757575;">,</span> <span style="color: #b58900;">local_group</span><span style="color: #757575;">)</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21442;&#32771; GNU_RELRO</span>
  <span style="color: #268bd2;">protect_relro</span><span style="color: #757575;">()</span>

plain_reloc_iterator:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">plain_reloc_iterator &#29992;&#26469;&#36941;&#21382; {plt_}rel{a}_ (&#21363; .rel{a}.{dyn,plt})</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">  #if</span> <span style="color: #268bd2;">defined</span><span style="color: #757575;">(</span>USE_RELA<span style="color: #757575;">)</span>
    <span style="color: #859900;">typedef</span> ElfW<span style="color: #757575;">(</span>Rela<span style="color: #757575;">)</span> rel_t;
<span style="color: #268bd2;">  #else</span>
    <span style="color: #859900;">typedef</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #b58900;">Rel</span><span style="color: #757575;">)</span> rel_t;
<span style="color: #268bd2;">  #endif</span>

  <span style="color: #268bd2;">plain_reloc_iterator</span><span style="color: #757575;">(</span><span style="color: #b58900;">rel_t</span>* <span style="color: #268bd2;">rel_array</span><span style="color: #757575;">,</span> <span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">count</span><span style="color: #757575;">)</span>
    : begin_<span style="color: #757575;">(</span>rel_array<span style="color: #757575;">),</span> end_<span style="color: #757575;">(</span>begin_ + count<span style="color: #757575;">),</span> current_<span style="color: #757575;">(</span>begin_<span style="color: #757575;">)</span> <span style="color: #757575;">{}</span>

  <span style="color: #b58900;">rel_t</span>* <span style="color: #268bd2;">next</span><span style="color: #757575;">()</span>
    <span style="color: #859900;">return</span> current_++;

<span style="color: #268bd2; font-weight: bold;">relocate</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36941;&#21382; .rel{a}.plt</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">idx</span> = 0; rel_iterator.has_next<span style="color: #757575;">()</span>; ++idx<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">rel-&gt;r_info &#21253;&#21547;&#20102; relocation type &#21644; sym index</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">rel-&gt;r_offset &#25351;&#31034;&#20102;&#38656;&#35201; patch &#30340; got.plt &#30340;&#20301;&#32622; </span>
    ElfW<span style="color: #757575;">(</span>Word<span style="color: #757575;">)</span> type = ELFW<span style="color: #757575;">(</span>R_TYPE<span style="color: #757575;">)(</span>rel-&gt;r_info<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Word</span><span style="color: #757575;">)</span> sym = ELFW<span style="color: #757575;">(</span>R_SYM<span style="color: #757575;">)(</span>rel-&gt;r_info<span style="color: #757575;">)</span>;

    <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Addr</span><span style="color: #757575;">)</span> reloc = static_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>rel-&gt;r_offset + load_bias<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Addr</span><span style="color: #757575;">)</span> sym_addr = 0;
    <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">sym_name</span> = nullptr;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">rel &#21644; rela &#33719;&#24471; addend &#26041;&#24335;&#19981;&#21516;: rela &#30340; addend &#30452;&#25509;&#20445;&#23384;&#22312;</span>
<span style="color: #586e75;">     * rel-&gt;r_addend, &#32780; rel &#30340; addend &#20445;&#23384;&#22312; *relc &#22788;</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Addr</span><span style="color: #757575;">)</span> addend = get_addend<span style="color: #757575;">(</span>rel<span style="color: #757575;">,</span> reloc<span style="color: #757575;">)</span>;

    <span style="color: #586e75;">/* </span><span style="color: #586e75;">relocate &#26102;, &#33509; sym &#19981;&#20026;&#31354;, &#38656;&#35201;&#20174;&#20854;&#23427;&#22320;&#26041; (so &#25110; executable)</span>
<span style="color: #586e75;">     * &#20013;&#26597;&#25214; sym &#30340;&#22320;&#22336;&#26469; patch, &#33509; sym &#20026;&#31354;, &#21017;&#19981;&#38656;&#35201;&#26597;&#25214;, &#30452;&#25509;&#26681;&#25454;</span>
<span style="color: #586e75;">     * load_bias &#20043;&#31867;&#30340;&#36827;&#34892; patch &#21363;&#21487;</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sym != 0<span style="color: #757575;">)</span>:
      sym_name = get_string<span style="color: #757575;">(</span>symtab_[sym].st_name<span style="color: #757575;">)</span>;
      <span style="color: #268bd2;">soinfo_do_lookup</span><span style="color: #757575;">(</span><span style="color: #b58900;">this</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sym_name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">vi</span><span style="color: #757575;">,</span> &amp;lsi<span style="color: #757575;">,</span> <span style="color: #b58900;">global_group</span><span style="color: #757575;">,</span> <span style="color: #b58900;">local_group</span><span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">)</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">sym_name &#22312;&#25152;&#26377;&#30340; so, executable &#20013;&#37117;&#27809;&#26377;&#25214;&#21040;, undefined</span>
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>s == nullptr<span style="color: #757575;">)</span>:
        s = &amp;symtab_[sym];
        <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20801;&#35768; undefined &#30340; weak symbol &#23384;&#22312;, &#21442;&#32771; `weak_symbol`</span>
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ELF_ST_BIND<span style="color: #757575;">(</span>s-&gt;st_info<span style="color: #757575;">)</span> != STB_WEAK<span style="color: #757575;">)</span>:
          <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25214;&#21040;&#19968;&#20010; symbol: lsi &#26159; symbol &#25152;&#22312;&#30340; so, s &#26159; symbol &#23545;&#24212;&#30340;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">dynsym entry</span>
      sym_addr = lsi-&gt;resolve_symbol_address<span style="color: #757575;">(</span>s<span style="color: #757575;">)</span>;

    <span style="color: #859900;">switch</span> type:
      <span style="color: #586e75;">// </span><span style="color: #586e75;">R_GENERIC_JUMP_SLOT &#26159;&#26368;&#24120;&#29992;&#30340; relocation type, &#20363;&#22914;&#35843;&#29992; printf</span>
      <span style="color: #859900;">case</span> R_GENERIC_JUMP_SLOT:
        *reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>reloc<span style="color: #757575;">)</span> = <span style="color: #757575;">(</span>sym_addr + addend<span style="color: #757575;">)</span>;

      <span style="color: #586e75;">// </span><span style="color: #586e75;">R_GENERIC_GLOB_DAT &#29992;&#26469;&#35775;&#38382;&#20840;&#23616;&#21464;&#37327;, &#20363;&#22914; extern int x</span>
      <span style="color: #859900;">case</span> R_GENERIC_GLOB_DAT:
        *reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>reloc<span style="color: #757575;">)</span> = <span style="color: #757575;">(</span>sym_addr + addend<span style="color: #757575;">)</span>;

      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#35775;&#38382; pc relative: &#20363;&#22914;&#35775;&#38382;&#24403;&#21069; so &#20013;&#30340;&#20840;&#23616;&#21464;&#37327;&#26102;&#20250;&#20351;&#29992;&#36825;&#31181; relocation</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">[[file:PIC_PIE.org::*pic/no-pic%20%E7%9A%84%E5%8C%BA%E5%88%AB][pic/no-pic &#30340;&#21306;&#21035;]]</span>
      <span style="color: #859900;">case</span> R_GENERIC_RELATIVE:
        *reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>reloc<span style="color: #757575;">)</span> = <span style="color: #757575;">(</span>load_bias + addend<span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
</pre>
</div>

<p>
resolve_symbol_address:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">resolve_symbol_address</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">st_value &#26159; dysym &#30340;&#25104;&#21592;</span>
  <span style="color: #859900;">return</span> static_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>s-&gt;st_value + load_bias<span style="color: #757575;">)</span>;
</pre>
</div>

<p>
关于 weak_symbol 
</p>
</div>

<div id="outline-container-orgd0fc27e" class="outline-5">
<h5 id="orgd0fc27e"><span class="section-number-5">1.2.2.1</span> soinfo_do_lookup</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<p>
<a href="https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md">https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md</a>
</p>

<p>
soinfo_do_lookup 的输入是:
</p>

<ol class="org-ol">
<li>symbol name</li>
<li>this so</li>
<li>global_group, 包含 1. exectuable 自己 2. LD_PRELOAD 引入的 so 3. DF_1_GLOBAL
的 so</li>
<li>local_group, 通过 walk_dependencies_tree 获得的 so ,包含所有DT_NEEDED 引入的
so</li>
</ol>

<p>
soinfo_do_lookup 需要考虑几点:
</p>

<ol class="org-ol">
<li>global 或 local group</li>

<li>DT_SYMBOLIC,</li>

<li>HASH</li>
</ol>

<p>
简单的说, soinfo_do_lookup 的作用是:
按一定顺序在 exectuable 和各个 so 中按名字查找某个符号, 返回 so 和符号的信息, 查找过程中使用 .hash 或 .gnu.hash 中的信息来加速.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">soinfo_do_lookup</span>:
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>si_from-&gt;has_DT_SYMBOLIC<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">/* </span>
<span style="color: #586e75;">     *  Note that this is unlikely since static linker avoids generating</span>
<span style="color: #586e75;">     *  relocations for -Bsymbolic linked dynamic executables.</span>
<span style="color: #586e75;">     *  &#36825;&#19968;&#28857;&#21442;&#32771; DT_SYMBOLIC</span>
<span style="color: #586e75;">     */</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>si_from-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">))</span>:
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;

    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>s != nullptr<span style="color: #757575;">)</span>:
      *si_found_in = si_from;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">1. Look for it in global_group</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>s == nullptr<span style="color: #757575;">)</span>:
      global_group.visit<span style="color: #757575;">(</span>[&amp;]<span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">global_si</span><span style="color: #757575;">)</span>:
          global_si-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">)</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">2. Look for it in the local group</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>s == nullptr<span style="color: #757575;">)</span>:
      local_group.visit<span style="color: #757575;">(</span>[&amp;]<span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">local_si</span><span style="color: #757575;">)</span>:
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>local_si == si_from &amp;&amp; si_from-&gt;has_DT_SYMBOLIC<span style="color: #757575;">)</span>:
          <span style="color: #586e75;">// </span><span style="color: #586e75;">local_group &#26159;&#21253;&#21547; this so &#30340;</span>
          <span style="color: #586e75;">// </span><span style="color: #586e75;">we already did this - skip</span>
          <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
        local_si-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org809eea5" class="outline-5">
<h5 id="org809eea5"><span class="section-number-5">1.2.2.2</span> find_symbol_by_name</h5>
<div class="outline-text-5" id="text-1-2-2-2">
<p>

</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">find_symbol_by_name</span>:
  <span style="color: #b58900;">bool</span> <span style="color: #268bd2;">success</span> =
    is_gnu_hash<span style="color: #757575;">()</span> ?
    gnu_lookup<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;symbol_index<span style="color: #757575;">)</span> :
    elf_lookup<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;symbol_index<span style="color: #757575;">)</span>;

  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>success<span style="color: #757575;">)</span>:
    *symbol = symbol_index == 0 ? nullptr : symtab_ + symbol_index;

<span style="color: #268bd2; font-weight: bold;">elf_lookup</span>:
  <span style="color: #b58900;">uint32_t</span> <span style="color: #268bd2;">hash</span> = symbol_name.elf_hash<span style="color: #757575;">()</span>;
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">uint32_t</span> <span style="color: #268bd2;">n</span> = bucket_[hash % nbucket_]; n != 0; n = chain_[n]<span style="color: #757575;">)</span>:
    ElfW<span style="color: #757575;">(</span>Sym<span style="color: #757575;">)</span>* s = symtab_ + n;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>strcmp<span style="color: #757575;">(</span>get_string<span style="color: #757575;">(</span>s-&gt;st_name<span style="color: #757575;">),</span> symbol_name.get_name<span style="color: #757575;">())</span> == 0 &amp;&amp;
      is_symbol_global_and_defined<span style="color: #757575;">(</span>this<span style="color: #757575;">,</span> s<span style="color: #757575;">))</span>:
    *symbol_index = n;
    <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga914b7c" class="outline-4">
<h4 id="orga914b7c"><span class="section-number-4">1.2.3</span> __libc_init_main_thread</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">__libc_init_main_thread</span>:
  <span style="color: #859900;">static</span> <span style="color: #b58900;">pthread_internal_t</span> <span style="color: #268bd2;">main_thread</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">pthread_create &#36890;&#36807; clone &#26102;&#25351;&#23450;&#30340; tls &#21442;&#25968;&#26469;&#35774;&#32622; tls</span>
  <span style="color: #268bd2;">__set_tls</span><span style="color: #757575;">(</span>main_thread.tls<span style="color: #757575;">)</span>;
  main_thread.tid = __set_tid_address<span style="color: #757575;">(</span>&amp;main_thread.tid<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#36890;&#36807; pthread_create &#21019;&#24314;&#30340;&#32447;&#31243;&#20063;&#38656;&#35201;&#35843;&#29992; __init_tls</span>
  __init_tls<span style="color: #757575;">(</span>&amp;main_thread<span style="color: #757575;">)</span>;
    thread-&gt;tls[TLS_SLOT_SELF] = thread-&gt;tls;
    thread-&gt;tls[TLS_SLOT_THREAD_ID] = thread;
  __init_alternate_signal_stack<span style="color: #757575;">(</span>&amp;main_thread<span style="color: #757575;">)</span>;
</pre>
</div>
</div>

<div id="outline-container-org18426d8" class="outline-5">
<h5 id="org18426d8"><span class="section-number-5">1.2.3.1</span> set_tid_address</h5>
</div>

<div id="outline-container-org07d0c31" class="outline-5">
<h5 id="org07d0c31"><span class="section-number-5">1.2.3.2</span> set_tls</h5>
</div>
</div>

<div id="outline-container-orgda36692" class="outline-4">
<h4 id="orgda36692"><span class="section-number-4">1.2.4</span> linker_so.protect_relro</h4>
</div>

<div id="outline-container-org0190776" class="outline-4">
<h4 id="org0190776"><span class="section-number-4">1.2.5</span> __libc_init_globals</h4>
<div class="outline-text-4" id="text-1-2-5">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">__libc_init_globals</span>:
  __libc_auxv = args.auxv;
  __libc_globals.mutate<span style="color: #757575;">(</span>[&amp;args]<span style="color: #757575;">(</span><span style="color: #b58900;">libc_globals</span>* <span style="color: #268bd2;">globals</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#32473; __libc_globals-&gt;vdso[] &#36171;&#20540;. &#30456;&#24403;&#20110;&#20197;&#25163;&#24037;&#30340;&#26041;&#24335;&#23436;&#25104;&#20102;&#23545; vdso</span>
<span style="color: #586e75;">     * &#20013;&#23450;&#20041;&#30340;&#20989;&#25968; (gettimeofday, clock_gettime) &#30340;&#37325;&#23450;&#20301;, &#19981;&#20165;&#20165;</span>
<span style="color: #586e75;">     * linker init, &#24212;&#29992;&#33258;&#24049;&#30340; __libc_preinit &#20063;&#38656;&#35201;&#36890;&#36807;&#30456;&#21516;&#30340;&#26041;&#24335;&#32473;</span>
<span style="color: #586e75;">     * vdso &#36171;&#20540;</span><span style="color: #586e75;">*/</span>
    __libc_init_vdso<span style="color: #757575;">(</span>globals<span style="color: #757575;">,</span> args<span style="color: #757575;">)</span>;
    __libc_init_setjmp_cookie<span style="color: #757575;">(</span>globals<span style="color: #757575;">,</span> args<span style="color: #757575;">)</span>;
  <span style="color: #757575;">})</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a9535d" class="outline-4">
<h4 id="org6a9535d"><span class="section-number-4">1.2.6</span> linker_so.call_constructors</h4>
<div class="outline-text-4" id="text-1-2-6">
<p>
linker 由 c++ 写的并且本身有许多全局变量, 所以
linker_so.call_constructors 用来初始化这些全局变量
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">call_constructors</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23545; linker &#26469;&#35828;, &#24403;&#21069;&#36824;&#27809;&#26377; children</span>
  <span style="color: #268bd2;">get_children</span><span style="color: #757575;">()</span>.for_each<span style="color: #757575;">(</span>[] <span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    si-&gt;call_constructors<span style="color: #757575;">()</span>;
  <span style="color: #757575;">})</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#35843;&#29992; init_func_, &#31867;&#22411;&#20026; linker_function_t (void (*T) ())</span>
  call_function<span style="color: #757575;">(</span><span style="color: #2aa198;">"DT_INIT"</span><span style="color: #757575;">,</span> init_func_<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">.init_array &#26159;&#22810;&#20010;&#20989;&#25968;&#25351;&#38024;&#32452;&#25104;&#30340;&#25968;&#32452;, c++ &#30340; ctor &#37117;&#26159;&#36890;&#36807;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">.init_array &#23454;&#29616;&#30340;</span>
  call_array<span style="color: #757575;">(</span><span style="color: #2aa198;">"DT_INIT_ARRAY"</span><span style="color: #757575;">,</span> init_array_<span style="color: #757575;">,</span> init_array_count_<span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">false</span><span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org866716e" class="outline-3">
<h3 id="org866716e"><span class="section-number-3">1.3</span> linker 主逻辑</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org83a6fbe" class="outline-4">
<h4 id="org83a6fbe"><span class="section-number-4">1.3.1</span> __linker_init_post_relocation</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">__linker_init_post_relocation</span>:
  <span style="color: #268bd2;">__libc_init_AT_SECURE</span><span style="color: #757575;">(</span><span style="color: #b58900;">args</span><span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">__system_properties_init</span><span style="color: #757575;">()</span>;
  <span style="color: #268bd2;">debuggerd_init</span><span style="color: #757575;">()</span>;
  <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">LD_DEBUG</span> = getenv<span style="color: #757575;">(</span><span style="color: #2aa198;">"LD_DEBUG"</span><span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>LD_DEBUG != nullptr<span style="color: #757575;">)</span>:
    g_ld_debug_verbosity = atoi<span style="color: #757575;">(</span>LD_DEBUG<span style="color: #757575;">)</span>;

  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>getauxval<span style="color: #757575;">(</span>AT_SECURE<span style="color: #757575;">))</span>:
    ldpath_env = getenv<span style="color: #757575;">(</span><span style="color: #2aa198;">"LD_LIBRARY_PATH"</span><span style="color: #757575;">)</span>;
    ldpreload_env = getenv<span style="color: #757575;">(</span><span style="color: #2aa198;">"LD_PRELOAD"</span><span style="color: #757575;">)</span>;

  <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">executable_path</span> = get_executable_path<span style="color: #757575;">()</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">executable &#20026; RTLD_GLOBAL</span>
  <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span> = soinfo_alloc<span style="color: #757575;">(</span>&amp;g_default_namespace<span style="color: #757575;">,</span> executable_path<span style="color: #757575;">,</span> &amp;file_stat<span style="color: #757575;">,</span> 0<span style="color: #757575;">,</span> RTLD_GLOBAL<span style="color: #757575;">)</span>;

  si-&gt;phdr = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Phdr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>args.getauxval<span style="color: #757575;">(</span>AT_PHDR<span style="color: #757575;">))</span>;
  si-&gt;phnum = args.getauxval<span style="color: #757575;">(</span>AT_PHNUM<span style="color: #757575;">)</span>;
  si-&gt;entry = args.getauxval<span style="color: #757575;">(</span>AT_ENTRY<span style="color: #757575;">)</span>;

  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">i</span> = 0; i &lt; si-&gt;phnum; ++i<span style="color: #757575;">)</span>:
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>si-&gt;phdr[i].p_type == PT_PHDR<span style="color: #757575;">)</span>:
      si-&gt;load_bias = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>si-&gt;phdr<span style="color: #757575;">)</span> - si-&gt;phdr[i].p_vaddr;
      si-&gt;base = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Addr<span style="color: #757575;">)</span>&gt;<span style="color: #757575;">(</span>si-&gt;phdr<span style="color: #757575;">)</span> - si-&gt;phdr[i].p_offset;
      <span style="color: #859900;">break</span>;

  <span style="color: #268bd2;">ElfW</span><span style="color: #757575;">(</span><span style="color: #b58900;">Ehdr</span><span style="color: #757575;">)</span>* elf_hdr = reinterpret_cast&lt;ElfW<span style="color: #757575;">(</span>Ehdr<span style="color: #757575;">)</span>*&gt;<span style="color: #757575;">(</span>si-&gt;base<span style="color: #757575;">)</span>;

  <span style="color: #268bd2;">parse_LD_LIBRARY_PATH</span><span style="color: #757575;">(</span><span style="color: #b58900;">ldpath_env</span><span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">parse_LD_PRELOAD</span><span style="color: #757575;">(</span><span style="color: #b58900;">ldpreload_env</span><span style="color: #757575;">)</span>;

  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #859900;">auto</span>&amp; ld_preload_name : g_ld_preload_names<span style="color: #757575;">)</span>:
    needed_library_name_list.push_back<span style="color: #757575;">(</span>ld_preload_name.c_str<span style="color: #757575;">())</span>;
    ++needed_libraries_count;
    ++ld_preloads_count;

  <span style="color: #268bd2;">for_each_dt_needed</span><span style="color: #757575;">(</span><span style="color: #b58900;">si</span><span style="color: #757575;">,</span> [&amp;]<span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">name</span><span style="color: #757575;">)</span>:
    needed_library_name_list.push_back<span style="color: #757575;">(</span><span style="color: #b58900;">name</span><span style="color: #757575;">)</span>;
    ++needed_libraries_count;

  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>needed_libraries_count &gt; 0<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">1. &#21152;&#36733; exectuable &#26102; DT_NEEDED &#24341;&#20837;&#30340; so &#40664;&#35748;&#20026; RTLD_GLOBAL</span>
<span style="color: #586e75;">    *  2. add_as_children &#20026; true, &#19982; dlopen &#26102;&#19981;&#21516;</span><span style="color: #586e75;"> */</span>
    find_libraries<span style="color: #757575;">(</span>&amp;g_default_namespace<span style="color: #757575;">,</span> <span style="color: #b58900;">si</span><span style="color: #757575;">,</span> <span style="color: #b58900;">needed_library_names</span><span style="color: #757575;">,</span> <span style="color: #b58900;">needed_libraries_count</span><span style="color: #757575;">,</span>
                   <span style="color: #b58900;">nullptr</span><span style="color: #757575;">,</span> &amp;g_ld_preloads<span style="color: #757575;">,</span> <span style="color: #b58900;">ld_preloads_count</span><span style="color: #757575;">,</span> <span style="color: #b58900;">RTLD_GLOBAL</span><span style="color: #757575;">,</span> <span style="color: #b58900;">nullptr</span><span style="color: #757575;">,</span>
                   <span style="color: #586e75;">/* </span><span style="color: #586e75;">add_as_children</span><span style="color: #586e75;"> */</span> <span style="color: #268bd2; font-weight: bold;">true</span><span style="color: #757575;">))</span>
  <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>needed_libraries_count == 0<span style="color: #757575;">)</span>:
    si-&gt;link_image<span style="color: #757575;">(</span>g_empty_list<span style="color: #757575;">,</span> soinfo::soinfo_list_t::make_list<span style="color: #757575;">(</span>si<span style="color: #757575;">),</span> nullptr<span style="color: #757575;">))</span>
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">vdso</span><span style="color: #586e75;"> */</span>
  <span style="color: #268bd2;">add_vdso</span><span style="color: #757575;">(</span><span style="color: #b58900;">args</span><span style="color: #757575;">)</span>;
  si-&gt;call_constructors<span style="color: #757575;">()</span>;
  <span style="color: #859900;">return</span> si-&gt;entry;
</pre>
</div>
</div>
</div>

<div id="outline-container-org75b2f57" class="outline-4">
<h4 id="org75b2f57"><span class="section-number-4">1.3.2</span> find_libraries</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">find_libraries</span>:
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">i</span> = 0; i &lt; library_names_count; ++i<span style="color: #757575;">)</span>:
    <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* name = library_names[i];
    load_tasks.push_back<span style="color: #757575;">(</span>LoadTask::create<span style="color: #757575;">(</span>name<span style="color: #757575;">,</span> start_with<span style="color: #757575;">,</span> &amp;readers_map<span style="color: #757575;">))</span>;

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">step 1, expand load_tasks to include all DT_NEEDED libraries</span><span style="color: #586e75;"> */</span>

  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">i</span> = 0; i&lt;load_tasks.size<span style="color: #757575;">()</span>; ++i<span style="color: #757575;">)</span>:
    LoadTask* task = load_tasks[i];
    <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">needed_by</span> = task-&gt;get_needed_by<span style="color: #757575;">()</span>;
    <span style="color: #268bd2;">find_library_internal</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">task</span><span style="color: #757575;">,</span> &amp;zip_archive_cache<span style="color: #757575;">,</span> &amp;load_tasks<span style="color: #757575;">,</span> <span style="color: #b58900;">rtld_flags</span><span style="color: #757575;">)</span>

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">step 2, load libraries in random order</span><span style="color: #586e75;"> */</span>
  shuffle<span style="color: #757575;">(</span>&amp;load_list<span style="color: #757575;">)</span>;  
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">auto</span>&amp;&amp; task : load_list<span style="color: #757575;">)</span>:
    task-&gt;load<span style="color: #757575;">()</span>

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">step 3, pre-link all DT_NEEDED libraries in breadth first order.</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">auto</span>&amp;&amp; task : load_tasks<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span> = task-&gt;get_soinfo<span style="color: #757575;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>si-&gt;is_linked<span style="color: #757575;">()</span> &amp;&amp; <span style="color: #b58900; font-weight: bold;">!</span>si-&gt;prelink_image<span style="color: #757575;">())</span> <span style="color: #757575;">{}</span>

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">step 4, link libraries.</span><span style="color: #586e75;"> */</span>
  soinfo::soinfo_list_t local_group;
  walk_dependencies_tree<span style="color: #757575;">(</span>
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#33509; add_as_children &#20026; true, &#34920;&#31034;&#38750; dlopen &#30340;&#24773;&#20917;, walk_dependencies_tree &#30340; root &#20026; start_with</span>
<span style="color: #586e75;">       * &#33509; add_as_children &#20026; false, &#34920;&#31034; dlopen, &#21152;&#36733;&#30340; so &#24418;&#25104; disjoint tree, root &#20026; soinfos, &#32780;&#19981;&#26159; start_with</span><span style="color: #586e75;"> */</span>
      <span style="color: #757575;">(</span>start_with != nullptr &amp;&amp; add_as_children<span style="color: #757575;">)</span> ? &amp;start_with : soinfos<span style="color: #757575;">,</span>
      <span style="color: #757575;">(</span>start_with != nullptr &amp;&amp; add_as_children<span style="color: #757575;">)</span> ? 1 : soinfos_count<span style="color: #757575;">,</span>
      [&amp;] <span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        local_group.push_back<span style="color: #757575;">(</span>si<span style="color: #757575;">)</span>;
      <span style="color: #757575;">})</span>;

  local_group.visit<span style="color: #757575;">(</span>[&amp;]<span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>si-&gt;is_linked<span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>si-&gt;link_image<span style="color: #757575;">(</span>global_group<span style="color: #757575;">,</span> local_group<span style="color: #757575;">,</span> extinfo<span style="color: #757575;">))</span> <span style="color: #757575;">{</span>
          <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
        <span style="color: #757575;">}</span>
      <span style="color: #757575;">}</span>
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
    <span style="color: #757575;">})</span>;

</pre>
</div>
</div>

<div id="outline-container-org6a03df3" class="outline-5">
<h5 id="org6a03df3"><span class="section-number-5">1.3.2.1</span> find_library_internal</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">find_library_internal</span>:
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>find_loaded_library_by_soname<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> task-&gt;get_name<span style="color: #757575;">(),</span> &amp;candidate<span style="color: #757575;">))</span>:
    task-&gt;set_soinfo<span style="color: #757575;">(</span>candidate<span style="color: #757575;">)</span>;
    <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">load_library &#20250;&#25214;&#21040;&#24182;&#25171;&#24320; so, &#35835;&#21462; DT_NEEDED, &#24182;&#25226;&#23427;&#20204;&#21152;&#21040; load_tasks</span>
<span style="color: #586e75;">   * &#20013;, &#20294;&#27492;&#26102;&#24182;&#19981;&#20250;&#20570; link_image &#30340;&#21160;&#20316;</span><span style="color: #586e75;"> */</span>
  <span style="color: #268bd2;">load_library</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">task</span><span style="color: #757575;">,</span> <span style="color: #b58900;">zip_archive_cache</span><span style="color: #757575;">,</span> <span style="color: #b58900;">load_tasks</span><span style="color: #757575;">,</span> <span style="color: #b58900;">rtld_flags</span><span style="color: #757575;">)</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgc39a3ea"></a>load_library<br />
<div class="outline-text-6" id="text-1-3-2-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">load_library</span>:
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">fd</span> = open_library<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> zip_archive_cache<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> needed_by<span style="color: #757575;">,</span> &amp;file_offset<span style="color: #757575;">,</span> &amp;realpath<span style="color: #757575;">)</span>;
  <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span> = soinfo_alloc<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> realpath.c_str<span style="color: #757575;">(),</span> &amp;file_stat<span style="color: #757575;">,</span> file_offset<span style="color: #757575;">,</span> rtld_flags<span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">for_each_dt_needed</span><span style="color: #757575;">(</span>task-&gt;get_elf_reader<span style="color: #757575;">(),</span> [&amp;]<span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">name</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    load_tasks-&gt;push_back<span style="color: #757575;">(</span>LoadTask::create<span style="color: #757575;">(</span><span style="color: #b58900;">name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">si</span><span style="color: #757575;">,</span> task-&gt;get_readers_map<span style="color: #757575;">()))</span>;
  <span style="color: #757575;">})</span>;

<span style="color: #268bd2; font-weight: bold;">open_library</span>:
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>strchr<span style="color: #757575;">(</span>name<span style="color: #757575;">,</span> <span style="color: #2aa198;">'/'</span><span style="color: #757575;">)</span> != nullptr<span style="color: #757575;">)</span>:
    fd = open<span style="color: #757575;">(</span>name<span style="color: #757575;">,</span> O_RDONLY | O_CLOEXEC<span style="color: #757575;">)</span>
    *realpath = name;
    <span style="color: #859900;">return</span> fd

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#25353;&#22914;&#19979;&#39034;&#24207;&#26597;&#25214; so:</span>
<span style="color: #586e75;">   * 1. ld_library_path</span>
<span style="color: #586e75;">   * 2. needed_by-&gt;rpath</span>
<span style="color: #586e75;">   * 3. default library path: /system/lib{64}</span><span style="color: #586e75;"> */</span>
  <span style="color: #b58900;">int</span> fd = open_library_on_paths<span style="color: #757575;">(</span>zip_archive_cache<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> file_offset<span style="color: #757575;">,</span> ns-&gt;get_ld_library_paths<span style="color: #757575;">(),</span> realpath<span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>fd == -1 &amp;&amp; needed_by != nullptr<span style="color: #757575;">)</span>:
    fd = open_library_on_paths<span style="color: #757575;">(</span>zip_archive_cache<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> file_offset<span style="color: #757575;">,</span> needed_by-&gt;get_dt_runpath<span style="color: #757575;">(),</span> realpath<span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>fd == -1<span style="color: #757575;">)</span>:
    fd = open_library_on_paths<span style="color: #757575;">(</span>zip_archive_cache<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> file_offset<span style="color: #757575;">,</span> ns-&gt;get_default_library_paths<span style="color: #757575;">(),</span> realpath<span style="color: #757575;">)</span>;
</pre>
</div>

<p>
load_library 在考虑 rpath 时, 使用的是 needed_by-&gt;rpath, 但
soinfo-&gt;needed_by 在实现上是一个指针而非一个列表, 实际的情况是 soinfo
有可能被多个 so NEEDED, 那哪个 so 才是它的 needed_by? 答案是
find_library_internal 时遇到的第一个 so
</p>

<pre class="example" id="org6c0862f">
$&gt; cat r1.c

void r() {
    printf("r1\n");
}

$&gt; cat r2.c

void r() {
    printf("r2\n");
}

$&gt; cat foo.c

extern void r();
void foo() {
    printf("foo\n");
    r();
}

$&gt; cat bar.c

extern void r();
void bar() {
    printf("bar\n");
}

$&gt; cat main.c

#include &lt;stdio.h&gt;
extern void foo();
int main(int argc, char *argv[]) {
    foo();
    return 0;
}

$&gt; gcc -shared r1.c -o /home/sunway/r1/libr.so
$&gt; gcc -shared r2.c -o /home/sunway/r2/libr.so
$&gt; cp /home/sunway/r1/libr.so ./libr.so
$&gt; gcc -shared foo.c -o libfoo.so -Wl,-rpath=/home/sunway/r1 libr.so
$&gt; gcc -shared bar.c -o libbar.so -Wl,-rpath=/home/sunway/r2 libr.so
$&gt; gcc main.c libfoo.so libbar.so
$&gt; LD_LIBRARY_PATH=. ./a.out
r1
$&gt; gcc main.c libbar.so libfoo.so
$&gt; LD_LIBRARY_PATH=. ./a.out
r2
</pre>
</div>
</li>
</ol>
</div>

<div id="outline-container-org1a5975c" class="outline-5">
<h5 id="org1a5975c"><span class="section-number-5">1.3.2.2</span> walk_dependencies_tree</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<p>
walk_dependencies_tree 把树上以 start_with 为根的所有的 so (并非
solist 中所有的 so, 因为因为 dlopen 加载的 so 并不在树上) 以 BFS 方式进行遍历放在 local_group中, 后面 link_image 也会按这个顺序在
local_group 中进行soinfo_do_lookup
</p>

<pre class="example" id="orgd611a7a">
main.c
----------

#include &lt;stdio.h&gt;

extern void foo();

int main(int argc, char *argv[]) {
    foo();
    return 0;
}

foo.c
----------
extern void bar();

void x() {
    printf("x from foo\n");
}

void foo() {
    bar();
}

bar.c
----------
void x() {
    printf("x from bar\n");
}

void bar() {
    x();
}

foo2.c
----------

void x() {
    printf("x from foo2\n");
}

$&gt; gcc bar.c -shared -O0 -g3 -o libbar.so
$&gt; gcc foo.c -shared -O0 -g3 -o libfoo.so libbar.so
$&gt; gcc foo2.c -shared -O0 -g3 -o libfoo2.so

$&gt; gcc main.c -O0 -g3 libfoo2.so libfoo.so libbar.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from foo2

$&gt; gcc main.c -O0 -g3 libfoo.so libbar.so libfoo2.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from foo

$&gt; gcc main.c -O0 -g3 libbar.so libfoo2.so libfoo.so
$&gt; LD_LIBRARY_PATH=. ./a.out
x from bar
</pre>
</div>
</div>
</div>

<div id="outline-container-org12dc2fd" class="outline-4">
<h4 id="org12dc2fd"><span class="section-number-4">1.3.3</span> LoadTask::load</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
LoadTask::load 的作用是 kernel 的 load_elf_library 基本相同
</p>

<div class="org-src-container">
<pre class="src src-c">LoadTask::load:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">elf_reader.Load &#20250; mmap so &#20013;&#30340; PTLOAD segments</span><span style="color: #586e75;"> */</span>
  elf_reader.Load<span style="color: #757575;">(</span>extinfo_<span style="color: #757575;">)</span>
  si_-&gt;base = elf_reader.load_start<span style="color: #757575;">()</span>;
  si_-&gt;size = elf_reader.load_size<span style="color: #757575;">()</span>;
  si_-&gt;set_mapped_by_caller<span style="color: #757575;">(</span>elf_reader.is_mapped_by_caller<span style="color: #757575;">())</span>;
  si_-&gt;load_bias = elf_reader.load_bias<span style="color: #757575;">()</span>;
  si_-&gt;phnum = elf_reader.phdr_count<span style="color: #757575;">()</span>;
  si_-&gt;phdr = elf_reader.loaded_phdr<span style="color: #757575;">()</span>;

ElfReader::Load:
  ReserveAddressSpace<span style="color: #757575;">(</span>extinfo<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">LoadSegments</span><span style="color: #757575;">()</span>
  <span style="color: #268bd2;">FindPhdr</span><span style="color: #757575;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc04e002" class="outline-4">
<h4 id="orgc04e002"><span class="section-number-4">1.3.4</span> LoadSegments</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
LoadSegments 负责相应的 PT_LOAD mmap 进来, 但对于 .bss 有特殊处理:
</p>

<pre class="example" id="orga6b9923">
$&gt; readelf -a a.out

   [24] .bss              NOBITS           0000000000201030  00001030
       0000000000000010  0000000000000000  WA       0     0     4

   LOAD           0x0000000000000e10 0x0000000000200e10 0x0000000000200e10
                  0x0000000000000220 0x0000000000000230  RW     0x200000

   03     .init_array .fini_array .dynamic .got .got.plt .data .bss

第二个 PT_LOAD 的 file siz 为 0x220, 但 memory size 为 0x230, 因为这个
PT_LOAD 最后是一个大小为 0x10 的 .bss

LoadSegments 的这段代码负责把超出 file size 的部分都 zero fill, 这与
.bss 的要求是一致的, 所以 .bss 放在 PT_LOAD 的最后并不是巧合.

zero fill 时 linker 是通过 anonymous mmap 做到的:

man 2 mmap:

  MAP_ANONYMOUS
              The mapping is not backed by any file; its contents are initialized to zero.

通过 mmap 而不是直接 zero fill 可以利用 COW 达到更好的性能
</pre>
</div>
</div>

<div id="outline-container-org9d35189" class="outline-4">
<h4 id="org9d35189"><span class="section-number-4">1.3.5</span> link_image</h4>
</div>
</div>

<div id="outline-container-orga13200c" class="outline-3">
<h3 id="orga13200c"><span class="section-number-3">1.4</span> libdl</h3>
<div class="outline-text-3" id="text-1-4">
<p>
android 的 libdl 的实现在 linker 中, 而不是在 libdl.so 中. libdl.so 只是用来保证编译时能通过. 实际运行时 libdl.so 并不会被加载,因为它只是提供了一些保证编译通过的 stub 函数. android linker 在运行时通过
get_libdl_info 自己构造了一个对应于 libdl.so 的 soinfo.
</p>
</div>

<div id="outline-container-orgb4f567e" class="outline-4">
<h4 id="orgb4f567e"><span class="section-number-4">1.4.1</span> dlopen</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900;">void</span>* <span style="color: #268bd2;">dlopen</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">flags</span><span style="color: #757575;">)</span>:
  <span style="color: #b58900;">void</span>* caller_addr = __builtin_return_address<span style="color: #757575;">(</span>0<span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">dlopen_ext</span><span style="color: #757575;">(</span><span style="color: #b58900;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">nullptr</span><span style="color: #757575;">,</span> <span style="color: #b58900;">caller_addr</span><span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">do_dlopen</span><span style="color: #757575;">(</span><span style="color: #b58900;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">extinfo</span><span style="color: #757575;">,</span> <span style="color: #b58900;">caller_addr</span><span style="color: #757575;">)</span>;

<span style="color: #268bd2; font-weight: bold;">do_dlopen</span>:
  <span style="color: #b58900;">soinfo</span>* <span style="color: #859900;">const</span> <span style="color: #268bd2;">caller</span> = find_containing_library<span style="color: #757575;">(</span>caller_addr<span style="color: #757575;">)</span>;
  <span style="color: #b58900;">android_namespace_t</span>* <span style="color: #268bd2;">ns</span> = get_caller_namespace<span style="color: #757575;">(</span>caller<span style="color: #757575;">)</span>;
    caller != nullptr ? caller-&gt;get_primary_namespace<span style="color: #757575;">()</span> : g_anonymous_namespace;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36890;&#36807; system.loadLibrary() &#21457;&#36215;&#30340; dlopen &#35843;&#29992;&#38656;&#35201;&#20351;&#29992;</span>
<span style="color: #586e75;">   * classloader-namepsace, &#25351;&#23450;&#22312; extinfo &#20013;</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">((</span>extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE<span style="color: #757575;">)</span> != 0<span style="color: #757575;">)</span>:
    ns = extinfo-&gt;library_namespace;

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">dlopen &#26102;&#25351;&#23450;&#30340; flags (&#20363;&#22914; RTLD_GLOBAL) &#20250;&#24433;&#21709;&#22240;&#20026;&#23427;&#30340; DT_NEEDED</span>
<span style="color: #586e75;">   * &#32780;&#21152;&#36733;&#30340;&#20854;&#23427;&#30340; so &#20063;&#20351;&#29992;&#30456;&#21516;&#30340; flag</span><span style="color: #586e75;"> */</span>
  <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span> = find_library<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> flags<span style="color: #757575;">,</span> extinfo<span style="color: #757575;">,</span> caller<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">find_library &#20250;&#35843;&#29992; find_libraries, &#20294; add_as_children &#20026;</span>
<span style="color: #586e75;">     * false, &#21017; dlopen load &#30340; so &#24182;&#19981;&#20250;&#25346;&#22312; dependencies tree &#20013; (&#20294;</span>
<span style="color: #586e75;">     * &#36824;&#22312; soinfo list), &#36825;&#23601;&#23548;&#33268;&#20102; dlopen &#30340; so &#26080;&#27861;&#36890;&#36807;</span>
<span style="color: #586e75;">     * walk_dependencies_tree &#25214;&#21040; (&#20363;&#22914; link_image)</span><span style="color: #586e75;">*/</span>
    <span style="color: #268bd2;">find_libraries</span><span style="color: #757575;">()</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">dlopen &#26102; laod_tasks &#21021;&#22987;&#21482;&#26377;&#19968;&#39033;, &#21363;&#35201; dlopen &#30340; so, start_with &#20026;&#35843;&#29992; dlopen</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30340;&#20195;&#30721;&#25152;&#22312;&#30340; so</span>
      <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">i</span> = 0; i&lt;load_tasks.size<span style="color: #757575;">()</span>; ++i<span style="color: #757575;">)</span>:
        <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#21021;&#22987;&#26102; load_tasks &#20013;&#30340; task-&gt;get_needed_by &#22343;&#20026; start_with</span><span style="color: #586e75;">  */</span>
        soinfo* needed_by = task-&gt;get_needed_by<span style="color: #757575;">()</span>;
        <span style="color: #586e75;">/* </span><span style="color: #586e75;">needed_by != start_with &#30340;&#21028;&#26029;&#20250;&#23548;&#33268; dlopen &#26368;&#32456;&#20250;&#24418;&#25104;&#19968;&#26869;</span>
<span style="color: #586e75;">         * disjoint tree: &#23427;&#30340;&#26681;&#26159; load_tasks[0], &#19988; load_tasks[0] &#24182;&#27809;</span>
<span style="color: #586e75;">         * &#26377;&#21152;&#21040; start_with &#25152;&#22312;&#30340;&#26641;&#20013;</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">bool</span> <span style="color: #268bd2;">is_dt_needed</span> = needed_by != nullptr &amp;&amp; <span style="color: #757575;">(</span>needed_by != start_with || add_as_children<span style="color: #757575;">)</span>;
        <span style="color: #268bd2;">find_library_internal</span><span style="color: #757575;">()</span>
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>is_dt_needed<span style="color: #757575;">)</span>:
          needed_by-&gt;add_child<span style="color: #757575;">(</span>si<span style="color: #757575;">)</span>;
        <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>

  si-&gt;call_constructors<span style="color: #757575;">()</span>;
  <span style="color: #859900;">return</span> si-&gt;to_handle<span style="color: #757575;">()</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org83d5ef7" class="outline-4">
<h4 id="org83d5ef7"><span class="section-number-4">1.4.2</span> dlsym</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">dlsym</span>:
  <span style="color: #b58900;">void</span>* <span style="color: #268bd2;">caller_addr</span> = __builtin_return_address<span style="color: #757575;">(</span>0<span style="color: #757575;">)</span>;
  <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">caller</span> = find_containing_library<span style="color: #757575;">(</span>caller_addr<span style="color: #757575;">)</span>;
  <span style="color: #b58900;">android_namespace_t</span>* <span style="color: #268bd2;">ns</span> = get_caller_namespace<span style="color: #757575;">(</span>caller<span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>handle == RTLD_DEFAULT || handle == RTLD_NEXT<span style="color: #757575;">)</span>:
    sym = dlsym_linear_lookup<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> sym_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;found<span style="color: #757575;">,</span> caller<span style="color: #757575;">,</span> handle<span style="color: #757575;">)</span>;
  <span style="color: #859900;">else</span>:
    soinfo* si = soinfo_from_handle<span style="color: #757575;">(</span>handle<span style="color: #757575;">)</span>;
    sym = dlsym_handle_lookup<span style="color: #757575;">(</span>si<span style="color: #757575;">,</span> &amp;found<span style="color: #757575;">,</span> sym_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">)</span>;

  <span style="color: #859900;">if</span> <span style="color: #757575;">((</span>bind == STB_GLOBAL || bind == STB_WEAK<span style="color: #757575;">)</span> &amp;&amp; sym-&gt;st_shndx != 0<span style="color: #757575;">)</span>:
    *symbol = reinterpret_cast&lt;<span style="color: #b58900;">void</span>*&gt;<span style="color: #757575;">(</span>found-&gt;resolve_symbol_address<span style="color: #757575;">(</span>sym<span style="color: #757575;">))</span>;
    <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
  <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;

<span style="color: #268bd2; font-weight: bold;">dlsym_linear_lookup</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#33509; handle &#20026; RTLD_DEFAULT &#25110; RTLD_NEXT, &#21017;&#36827;&#34892;&#32447;&#24615;&#26597;&#25214;, &#21363;&#25353;&#29031; so</span>
<span style="color: #586e75;">   * &#34987;&#21152;&#36733;&#30340;&#39034;&#24207;&#36824;&#26597;&#25214;</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">auto</span>&amp; soinfo_list = ns-&gt;soinfo_list<span style="color: #757575;">()</span>;
  <span style="color: #859900;">auto</span> <span style="color: #b58900;">start</span> = soinfo_list.begin<span style="color: #757575;">()</span>;

  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>handle == RTLD_NEXT<span style="color: #757575;">)</span>:
    <span style="color: #859900;">auto</span> it = soinfo_list.find<span style="color: #757575;">(</span>caller<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">RTLD_NEXT &#26159;&#19968;&#20010;&#29305;&#27530;&#30340; handle: &#20174;&#23427;&#30340; `&#19979;&#19968;&#20010;` so &#24320;&#22987;&#26597;&#25214;, `&#19979;</span>
<span style="color: #586e75;">     * &#19968;&#20010;` &#22312;&#36825;&#37324;&#23454;&#38469;&#23601;&#26159; so &#34987;&#21152;&#36733;&#30340;&#39034;&#24207; (BFS)</span><span style="color: #586e75;">*/</span>
    start = ++it;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#33509; RTLD_DEFAULT, &#21017;&#20174;&#31532;&#19968;&#20010; so &#24320;&#22987;&#26597;&#25214;</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">auto</span> <span style="color: #b58900;">it</span> = start<span style="color: #757575;">,</span> end = soinfo_list.end<span style="color: #757575;">()</span>; it != end; ++it<span style="color: #757575;">)</span>:
    soinfo* si = *it;
    <span style="color: #859900;">if</span> <span style="color: #757575;">((</span>si-&gt;get_rtld_flags<span style="color: #757575;">()</span> &amp; RTLD_GLOBAL<span style="color: #757575;">)</span> == 0<span style="color: #757575;">)</span>:
      <span style="color: #859900;">continue</span>;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>si-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">))</span>:
      *found = si
      <span style="color: #859900;">break</span>

dlsym_handle_lookup:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">root &#20026; handle &#20195;&#34920;&#30340; soinfo</span><span style="color: #586e75;"> */</span>
  walk_dependencies_tree<span style="color: #757575;">(</span>&amp;root<span style="color: #757575;">,</span> 1<span style="color: #757575;">,</span> [&amp;]<span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">current_soinfo</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>current_soinfo-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;result<span style="color: #757575;">))</span>:
      result = nullptr;
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;

    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>result != nullptr<span style="color: #757575;">)</span>:
      *found = current_soinfo;
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
    <span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3d1862" class="outline-4">
<h4 id="orgf3d1862"><span class="section-number-4">1.4.3</span> RTLD_XXX</h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<div id="outline-container-org446846d" class="outline-5">
<h5 id="org446846d"><span class="section-number-5">1.4.3.1</span> RTDL_DEFAULT</h5>
<div class="outline-text-5" id="text-1-4-3-1">
<p>
参考 dlsym_linear_lookup
</p>
</div>
</div>

<div id="outline-container-org5ad0a23" class="outline-5">
<h5 id="org5ad0a23"><span class="section-number-5">1.4.3.2</span> RTLD_NEXT</h5>
<div class="outline-text-5" id="text-1-4-3-2">
<p>
参考 dlsym_linear_lookup
</p>
</div>
</div>

<div id="outline-container-org69ecdd0" class="outline-5">
<h5 id="org69ecdd0"><span class="section-number-5">1.4.3.3</span> RTLD_GLOBAL</h5>
<div class="outline-text-5" id="text-1-4-3-3">
<p>
dlopen 时指定 RTLD_GLOBAL 与 DF_1_GLOBAL 功能相同.
</p>

<ol class="org-ol">
<li>在 create_namespace 时, 若 parent_ns 的 type 不是 shared, 则只有
RTLD_GLOBAL 类型的 so 才会被 child ns 继承</li>

<li>exectuable, preload 及所有加载 exectuable 时因为 DT_NEEDED 导入的
so 都是 RTLD_GLOBAL</li>

<li>dlopen 时指定了 RTLD_GLOBAL 时 load 的 so 以及因为它的 DT_NEEDED 导入的 so 是 RTLD_GLOBAL</li>

<li>有 DF_1_GLOBAL flag 的 so 在 dlopen 时默认为 RTLD_GLOBAL, 且会覆盖
dlopen 的 RTLD<sub>LOCAL|GLOBAL</sub> 参数 (参考 find_libraries)</li>

<li>link_image 时, global_group (包括 executable, preload, RTLD_GLOBAL 和
DF_1_GLOBAL), 优先被查找, 其它的 so 通过 dependency tree 的 BFS 遍历被查找,
由于 RTLD_LOCAL 的so 因为没有挂在 start_from so 的 dependency tree
(add_as_children)上, 所以 link_image 时这些 so 无法被找到.</li>

<li>dlsym 使用 RTLD_DEFAULT 或 RTLD_NEXT 时使用线性查找, 但只会从
RTLD_GLOBAL 类型的 so 中查找符号</li>
</ol>
</div>
</div>


<div id="outline-container-org182cd89" class="outline-5">
<h5 id="org182cd89"><span class="section-number-5">1.4.3.4</span> RTLD_LOCAL</h5>
</div>

<div id="outline-container-org4125284" class="outline-5">
<h5 id="org4125284"><span class="section-number-5">1.4.3.5</span> RTLD_LAZY</h5>
</div>

<div id="outline-container-orgcd1a29d" class="outline-5">
<h5 id="orgcd1a29d"><span class="section-number-5">1.4.3.6</span> RTLD_NOLOAD</h5>
</div>

<div id="outline-container-org696159c" class="outline-5">
<h5 id="org696159c"><span class="section-number-5">1.4.3.7</span> RTLD_NODELETE</h5>
</div>
</div>
</div>

<div id="outline-container-org648a009" class="outline-3">
<h3 id="org648a009"><span class="section-number-3">1.5</span> android_namespace</h3>
<div class="outline-text-3" id="text-1-5">
<p>
android_namespace 的作用是阻止某些情况下 link 某些 so, 例如:
</p>

<ol class="org-ol">
<li>app 自己的代码想要 link /system/lib/libcutils.so 是不允许的, 因为
libcutils.so 不是稳定的接口, 为了应用的兼容性, android 禁用应用程序使用 libcutils.so.</li>

<li>android 原生的 native 代码(例如 installd) 使用 libcutils.so 是允许的.</li>
</ol>

<p>
为了支持以上的功能, android 提供了 android_namespace 的概念
</p>
</div>

<div id="outline-container-org13c18d6" class="outline-4">
<h4 id="org13c18d6"><span class="section-number-4">1.5.1</span> android_namespace_t</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">android_namespace_t</span> <span style="color: #757575;">{</span>
  <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">name_</span>;
  <span style="color: #b58900;">bool</span> <span style="color: #268bd2;">is_isolated_</span>;
  std::vector&lt;std::string&gt; ld_library_paths_;
  std::vector&lt;std::string&gt; default_library_paths_;
  std::vector&lt;std::string&gt; permitted_paths_;
  soinfo::soinfo_list_t soinfo_list_;  
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
app 代码自己使用的 namepsace 是 isolated, 它能使用的 so 有如下的限定:
</p>

<ol class="org-ol">
<li>soinfo_list_ 已经加载的 so 可以使用 (这通过是从 parent namepsace 复制了一部分过来)</li>

<li>包含在 ld_library_paths_ 和 default_library_paths_ 中的 so</li>

<li>如果 so 是通过绝对路径加载的 (跳过了 ld_library_paths_ 和
default_library_paths_), 则它必须位于 permitted_paths_ 之内</li>
</ol>

<p>
一共三种 android_namespace:
</p>

<ol class="org-ol">
<li>g_default_namespace</li>

<li>g_anonymous_namespace</li>

<li>classloader-namespace</li>
</ol>
</div>
</div>

<div id="outline-container-org75ad76d" class="outline-4">
<h4 id="org75ad76d"><span class="section-number-4">1.5.2</span> g_default_namespace</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
g_default_namespace 是不受任何限制的 namepsace, 它可以访问任何位置
</p>
</div>
</div>

<div id="outline-container-org036061c" class="outline-4">
<h4 id="org036061c"><span class="section-number-4">1.5.3</span> g_anonymous_namespace</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
通常情况下所有代码都有其 caller namespace, 例如 g_default_namespace
加载了 libx.so 后, libx.so 中代码调用 dlopen 时, 通过 caller 代码的位置所在的 so (libx.so) 可以确定它的 caller namespace 是
g_default_namespace
</p>

<p>
dlopen 时会根据 caller namespace 为决定是否可以 dlopen 成功.
</p>

<p>
但如果代码是自动生成的 (例如 jit), 则无法获得 caller namespace, 这时会使用 g_anonymous_namespace 作为 caller namespace, 它的能力也是受限的.
</p>
</div>
</div>

<div id="outline-container-org4c6e679" class="outline-4">
<h4 id="org4c6e679"><span class="section-number-4">1.5.4</span> classloader-namespace</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
classloader-namespace 是 android 引入 namespace 的主要原因:
</p>

<p>
java 通过 PathClassLoader 加载 java 类后, java 可能会通过 jni load 某个 so, 这时 android 会通过 classloader-namespace 限制这个 load 的行为只能 load app 自己的 so (/data/app/lib&#x2026;) 或某些 public 的 so
</p>
</div>
</div>

<div id="outline-container-orgc4c6507" class="outline-4">
<h4 id="orgc4c6507"><span class="section-number-4">1.5.5</span> g_public_namespace</h4>
<div class="outline-text-4" id="text-1-5-5">
<p>
g_public_namespace 并不是一个 android_namespace_t, 它只是一些 soinfo
的集合, classloader-namespace 在 dlopen 时允许使用 g_public_namespace
中的 soinfo
</p>
</div>
</div>

<div id="outline-container-orge547f39" class="outline-4">
<h4 id="orge547f39"><span class="section-number-4">1.5.6</span> classloader-namespace 初始化</h4>
<div class="outline-text-4" id="text-1-5-6">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">JNI_CreateJavaVM</span>:
  android::InitializeNativeLoader<span style="color: #757575;">()</span>;
    g_namespaces-&gt;Initialize<span style="color: #757575;">()</span>;
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#35835;&#21462; /system/etc/public.libraries.txt</span><span style="color: #586e75;"> */</span>
      <span style="color: #268bd2;">ReadConfig</span><span style="color: #757575;">(</span><span style="color: #b58900;">public_native_libraries_system_config</span><span style="color: #757575;">,</span> &amp;sonames<span style="color: #757575;">)</span>
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#30830;&#20445; public_libraries_ &#37117;&#24050;&#32463;&#34987; load &#21040; g_default_namespace,</span>
<span style="color: #586e75;">       * &#21518;&#38754;&#20250;&#29992;&#21040;&#36825;&#19968;&#28857;</span><span style="color: #586e75;"> */</span>
      <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #859900;">auto</span>&amp; soname : sonames<span style="color: #757575;">)</span>:
        dlopen<span style="color: #757575;">(</span>soname.c_str<span style="color: #757575;">(),</span> RTLD_NOW | RTLD_NODELETE<span style="color: #757575;">)</span>;
      public_libraries_ = base::Join<span style="color: #757575;">(</span>sonames<span style="color: #757575;">,</span> <span style="color: #2aa198;">':'</span><span style="color: #757575;">)</span>;

<span style="color: #268bd2; font-weight: bold;">PathClassLoaderFactory</span>:<span style="color: #268bd2;">createClassLoader</span> <span style="color: #757575;">(</span><span style="color: #b58900;">librarySearchPath</span><span style="color: #757575;">,</span> <span style="color: #b58900;">libraryPermittedPath</span><span style="color: #757575;">)</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">librarySearchPath &#19968;&#33324;&#26159; /data/app/xxx/lib &#36825;&#31181;&#24418;&#24335;,</span>
<span style="color: #586e75;">   * libraryPermittedPath &#19968;&#33324;&#26159; /data</span><span style="color: #586e75;"> */</span>

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#21019;&#24314;&#20986;&#26469;&#30340; namespace &#20250;&#19982; classloader &#32465;&#23450;&#22312;&#19968;&#36215;</span><span style="color: #586e75;"> */</span>
  createClassloaderNamespace<span style="color: #757575;">(</span>pathClassloader<span style="color: #757575;">,</span>
                               librarySearchPath<span style="color: #757575;">,</span>
                               libraryPermittedPath<span style="color: #757575;">,</span>
                               isNamespaceShared<span style="color: #757575;">)</span>;

    g_namespaces-&gt;Create<span style="color: #757575;">(</span>env<span style="color: #757575;">,</span>class_loader<span style="color: #757575;">,</span> is_shared<span style="color: #757575;">,</span> library_path<span style="color: #757575;">,</span> permitted_path<span style="color: #757575;">)</span>;

<span style="color: #b58900;">android_namespace_t</span>* <span style="color: #268bd2;">Create</span><span style="color: #757575;">(</span><span style="color: #b58900;">JNIEnv</span>* <span style="color: #268bd2;">env</span><span style="color: #757575;">,</span>
                            <span style="color: #b58900;">jobject</span> <span style="color: #268bd2;">class_loader</span><span style="color: #757575;">,</span>
                            <span style="color: #b58900;">bool</span> <span style="color: #268bd2;">is_shared</span><span style="color: #757575;">,</span>
                            <span style="color: #b58900;">jstring</span> <span style="color: #268bd2;">java_library_path</span><span style="color: #757575;">,</span>
                            <span style="color: #b58900;">jstring</span> <span style="color: #268bd2;">java_permitted_path</span><span style="color: #757575;">)</span>:

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">init g_public_namespace</span><span style="color: #586e75;"> */</span>
  <span style="color: #b58900; font-weight: bold;">!</span>initialized_ &amp;&amp; <span style="color: #b58900; font-weight: bold;">!</span>InitPublicNamespace<span style="color: #757575;">(</span>library_path.c_str<span style="color: #757575;">())</span>



InitPublicNamespace<span style="color: #757575;">(</span>library_path.c_str<span style="color: #757575;">()</span>:
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">public_libraries_ &#20445;&#23384;&#22312; /system/etc/public.libraries.txt</span><span style="color: #586e75;"> */</span>
    android_init_namespaces<span style="color: #757575;">(</span>public_libraries_.c_str<span style="color: #757575;">(),</span> library_path<span style="color: #757575;">)</span>
      <span style="color: #268bd2;">init_namespaces</span><span style="color: #757575;">(</span><span style="color: #b58900;">public_ns_sonames</span><span style="color: #757575;">,</span> <span style="color: #b58900;">anon_ns_library_path</span><span style="color: #757575;">)</span>
        <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #859900;">auto</span>&amp; soname : sonames<span style="color: #757575;">)</span>:
          <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#21069;&#38754; InitializeNativeLoader &#21487;&#20197;&#30830;&#20445; public_libraries_ &#37117;</span>
<span style="color: #586e75;">           * &#24050;&#32463;&#34987; load &#21040; g_default_namespace &#20013;&#20102;</span><span style="color: #586e75;"> */</span>
          find_loaded_library_by_soname<span style="color: #757575;">(</span>&amp;g_default_namespace<span style="color: #757575;">,</span> soname.c_str<span style="color: #757575;">(),</span> &amp;candidate<span style="color: #757575;">)</span>;
          g_public_namespace.push_back<span style="color: #757575;">(</span>candidate<span style="color: #757575;">)</span>;
        <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#22312;&#36825;&#37324;&#21021;&#22987;&#21270;&#20102; g_anonymous_namespace, &#21487;&#35265;&#23427;&#30340; library_path</span>
<span style="color: #586e75;">         * &#26159; /dat/app/xxx/lib, &#23427;&#20250;&#20174; g_default_namespace copy &#37027;&#20123;&#24050;</span>
<span style="color: #586e75;">         * &#32463; load &#36827;&#26469;&#30340; GLOBAL &#30340; so (&#21442;&#32771; create_namespace)</span><span style="color: #586e75;"> */</span>
        anon_ns = create_namespace<span style="color: #757575;">(</span>nullptr<span style="color: #757575;">,</span> <span style="color: #2aa198;">"(anonymous)"</span><span style="color: #757575;">,</span> nullptr<span style="color: #757575;">,</span> anon_ns_library_path<span style="color: #757575;">,</span> ANDROID_NAMESPACE_TYPE_REGULAR<span style="color: #757575;">,</span> nullptr<span style="color: #757575;">,</span> &amp;g_default_namespace<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orga4545ca" class="outline-4">
<h4 id="orga4545ca"><span class="section-number-4">1.5.7</span> 使用 classloader-namespace 来 load so</h4>
<div class="outline-text-4" id="text-1-5-7">
</div>
<div id="outline-container-orge0efa07" class="outline-5">
<h5 id="orge0efa07"><span class="section-number-5">1.5.7.1</span> java 通过 loadLibrary</h5>
<div class="outline-text-5" id="text-1-5-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">OpenNativeLibrary</span>:
  ns = g_namespaces-&gt;FindNamespaceByClassLoader<span style="color: #757575;">(</span>env<span style="color: #757575;">,</span> class_loader<span style="color: #757575;">)</span>;
  <span style="color: #268bd2;">android_dlopen_ext</span><span style="color: #757575;">(</span><span style="color: #b58900;">path</span><span style="color: #757575;">,</span> <span style="color: #b58900;">RTLD_NOW</span><span style="color: #757575;">,</span> &amp;extinfo<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span>* <span style="color: #268bd2;">caller_addr</span> = __builtin_return_address<span style="color: #757575;">(</span>0<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">dlopen_ext</span><span style="color: #757575;">(</span><span style="color: #b58900;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">extinfo</span><span style="color: #757575;">,</span> <span style="color: #b58900;">caller_addr</span><span style="color: #757575;">)</span>;
      <span style="color: #268bd2;">do_dlopen</span><span style="color: #757575;">(</span><span style="color: #b58900;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">extinfo</span><span style="color: #757575;">,</span> <span style="color: #b58900;">caller_addr</span><span style="color: #757575;">)</span>;

<span style="color: #268bd2; font-weight: bold;">do_dlopen</span>:
  <span style="color: #b58900;">soinfo</span>* <span style="color: #859900;">const</span> <span style="color: #268bd2;">caller</span> = find_containing_library<span style="color: #757575;">(</span>caller_addr<span style="color: #757575;">)</span>;
  <span style="color: #b58900;">android_namespace_t</span>* <span style="color: #268bd2;">ns</span> = get_caller_namespace<span style="color: #757575;">(</span>caller<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#25972;&#20010;&#35843;&#29992;&#26159;&#36890;&#36807; java &#23618;&#30340; loadLibrary &#21457;&#36215;&#30340;, &#25152;&#20197; ns &#26159;&#36890;&#36807;</span>
<span style="color: #586e75;">   * classloader &#33719;&#24471;&#30340;, &#32780;&#19981;&#26159;&#36890;&#36807; get_caller_namespace</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">((</span>extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE<span style="color: #757575;">)</span> != 0<span style="color: #757575;">)</span>:
    ns = extinfo-&gt;library_namespace;

  <span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span> = find_library<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> name<span style="color: #757575;">,</span> flags<span style="color: #757575;">,</span> extinfo<span style="color: #757575;">,</span> caller<span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>si != nullptr<span style="color: #757575;">)</span>:
    si-&gt;call_constructors<span style="color: #757575;">()</span>;
    <span style="color: #859900;">return</span> si-&gt;to_handle<span style="color: #757575;">()</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2c480a" class="outline-5">
<h5 id="orgb2c480a"><span class="section-number-5">1.5.7.2</span> jni 中通过 dlopen</h5>
<div class="outline-text-5" id="text-1-5-7-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900;">void</span>* <span style="color: #268bd2;">dlopen</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">filename</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">flags</span><span style="color: #757575;">)</span>:
  <span style="color: #b58900;">void</span>* caller_addr = __builtin_return_address<span style="color: #757575;">(</span>0<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">dlopen &#30452;&#25509;&#20351;&#29992; dlopen_ext, &#26597;&#25214; ns &#20381;&#36182;&#20110; caller_addr</span><span style="color: #586e75;"> */</span>
  <span style="color: #859900;">return</span> dlopen_ext<span style="color: #757575;">(</span>filename<span style="color: #757575;">,</span> flags<span style="color: #757575;">,</span> nullptr<span style="color: #757575;">,</span> caller_addr<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org86b6a03" class="outline-4">
<h4 id="org86b6a03"><span class="section-number-4">1.5.8</span> find_library</h4>
<div class="outline-text-4" id="text-1-5-8">
<p>
find_library 的过程在前面 linker 初始化已经提过, 但没有考虑 ns
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">find_library</span>:
  <span style="color: #268bd2;">find_libraries</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">needed_by</span><span style="color: #757575;">,</span> &amp;name<span style="color: #757575;">,</span> 1<span style="color: #757575;">,</span> &amp;si<span style="color: #757575;">,</span> <span style="color: #b58900;">nullptr</span><span style="color: #757575;">,</span> 0<span style="color: #757575;">,</span> <span style="color: #b58900;">rtld_flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">extinfo</span><span style="color: #757575;">,</span> <span style="color: #586e75;">/* </span><span style="color: #586e75;">add_as_children</span><span style="color: #586e75;"> */</span> <span style="color: #268bd2; font-weight: bold;">false</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
    <span style="color: #268bd2;">find_library_internal</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">task</span><span style="color: #757575;">,</span> &amp;zip_archive_cache<span style="color: #757575;">,</span> &amp;load_tasks<span style="color: #757575;">,</span> <span style="color: #b58900;">rtld_flags</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#30001;&#20110; ns &#21019;&#24314;&#26102;&#20174; parent copy &#20102;&#19968;&#25209; soinfo, &#25152;&#20197;&#36825;&#37324;&#26377;&#21487;&#33021;&#30452;&#25509;</span>
<span style="color: #586e75;">     * &#36820;&#22238;&#21069;&#38754;&#24050;&#32463;&#21152;&#36733;&#36807;&#30340; so (&#21487;&#33021;&#26159;&#20174; parent copy &#36807;&#26469;&#30340;)</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>find_loaded_library_by_soname<span style="color: #757575;">(</span>ns<span style="color: #757575;">,</span> task-&gt;get_name<span style="color: #757575;">(),</span> &amp;candidate<span style="color: #757575;">))</span>:
      task-&gt;set_soinfo<span style="color: #757575;">(</span>candidate<span style="color: #757575;">)</span>;
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26159;&#21542;&#23646;&#20110; g_public_namespace</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ns != &amp;g_default_namespace<span style="color: #757575;">)</span>:
      candidate = g_public_namespace.find_if<span style="color: #757575;">(</span>[&amp;]<span style="color: #757575;">(</span><span style="color: #b58900;">soinfo</span>* <span style="color: #268bd2;">si</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
          <span style="color: #859900;">return</span> strcmp<span style="color: #757575;">(</span>task-&gt;get_name<span style="color: #757575;">(),</span> si-&gt;get_soname<span style="color: #757575;">())</span> == 0;
        <span style="color: #757575;">})</span>;

      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>candidate != nullptr<span style="color: #757575;">)</span>:
        ns-&gt;add_soinfo<span style="color: #757575;">(</span>candidate<span style="color: #757575;">)</span>;
        task-&gt;set_soinfo<span style="color: #757575;">(</span>candidate<span style="color: #757575;">)</span>;
        <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;

    <span style="color: #268bd2;">load_library</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">task</span><span style="color: #757575;">,</span> <span style="color: #b58900;">zip_archive_cache</span><span style="color: #757575;">,</span> <span style="color: #b58900;">load_tasks</span><span style="color: #757575;">,</span> <span style="color: #b58900;">rtld_flags</span><span style="color: #757575;">)</span>
      <span style="color: #268bd2;">open_library</span><span style="color: #757575;">(</span><span style="color: #b58900;">ns</span><span style="color: #757575;">,</span> <span style="color: #b58900;">zip_archive_cache</span><span style="color: #757575;">,</span> <span style="color: #b58900;">name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">needed_by</span><span style="color: #757575;">,</span> &amp;file_offset<span style="color: #757575;">,</span> &amp;realpath<span style="color: #757575;">)</span>
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">open_library &#25214;&#21040;&#36825;&#20010; so, &#20294;&#19981;&#26159; is_accessible, &#20363;&#22914;&#36890;&#36807;&#32477;&#23545;</span>
<span style="color: #586e75;">       * &#36335;&#24452;&#25351;&#23450;&#20102;&#19968;&#20010; so, &#20294; so &#24182;&#19981;&#22312; permitted_paths &#20013;</span><span style="color: #586e75;"> */</span>
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>ns-&gt;is_accessible<span style="color: #757575;">(</span>realpath<span style="color: #757575;">))</span>:
        <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc859c0d" class="outline-4">
<h4 id="orgc859c0d"><span class="section-number-4">1.5.9</span> 总结</h4>
<div class="outline-text-4" id="text-1-5-9">
<ol class="org-ol">
<li>classloader-namespace 是受限 (isolated) 的 namepsace, 只能加载 app
自己的 so, 从 parent 继承过来的一些 so 以及 public so</li>

<li>通过 classloader 或 caller_address 来确定当前使用的 ns</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org74c0770" class="outline-3">
<h3 id="org74c0770"><span class="section-number-3">1.6</span> dependencies tree</h3>
<div class="outline-text-3" id="text-1-6">
<p>
find_libraries 一方面会把 so 放在 soinfo list 中, 另一方面会通过
need_by 把它们组织成一个 dependencies tree.
</p>

<p>
但有一个例外: dlopen 一个 so 时会把所有涉及到的 so 加到 list 中, 但这些 so 自身形成一棵独立的 dependencies tree, 它们并不会被加到
start_with 所在的那棵树上.
</p>

<p>
为了能在后续 link_image 时能使用 dlopen(RTLD_GLOBAL) 方式打开的 so, 这棵独立的树上的 GLOBAL 的 so 会被加入到 global_group
(make_global_group) 中, 以便能使用这样so.
</p>

<p>
dependencies tree 有两个用处:
</p>

<ol class="org-ol">
<li>link_image</li>

<li>dlsym_handle_lookup</li>
</ol>
</div>
</div>


<div id="outline-container-org55ebd2e" class="outline-3">
<h3 id="org55ebd2e"><span class="section-number-3">1.7</span> misc</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-org6aac646" class="outline-4">
<h4 id="org6aac646"><span class="section-number-4">1.7.1</span> version_tracker</h4>
<div class="outline-text-4" id="text-1-7-1">
</div>
<div id="outline-container-orgcfc4015" class="outline-5">
<h5 id="orgcfc4015"><span class="section-number-5">1.7.1.1</span> init</h5>
<div class="outline-text-5" id="text-1-7-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">link_image</span>:
  version_tracker::init
  init_verneed<span style="color: #757575;">(</span>si_from<span style="color: #757575;">)</span> &amp;&amp; init_verdef<span style="color: #757575;">(</span>si_from<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">init &#23436;&#25104;&#21518;, version_tracker &#26377;&#22914;&#19979;&#30340;&#25968;&#32452;:</span>

<span style="color: #586e75;">     version_infos[source_index].name = ...;</span>
<span style="color: #586e75;">     version_infos[source_index].target_si = ...;</span>

<span style="color: #586e75;">     &#35813;&#25968;&#32452;&#22823;&#23567;&#31561;&#20110; dynsym &#22823;&#23567;, &#23545;&#20110;&#24403;&#21069; so &#23450;&#20041;&#30340;&#31526;&#21495;, &#20449;&#24687;&#26159;&#20174; init_verdef &#33719;&#24471;&#30340;, target_si &#20026;&#24403;&#21069; so, </span>
<span style="color: #586e75;">     &#23545;&#20110;&#26410;&#23450;&#20041;&#30340;&#31526;&#21495;, &#20449;&#24687;&#26159;&#20174; init_verneed &#33719;&#24471;&#30340;, target_si &#20026; .gnu.version_r &#20013;&#25351;&#23450;&#30340; so</span>

<span style="color: #586e75;">     &#21518;&#32493;&#22312;&#26597;&#25214;&#31526;&#21495;&#26102;, &#38656;&#35201;&#27604;&#36739; version_info &#26159;&#21542;&#19968;&#33268;</span>
<span style="color: #586e75;">   */</span>

<span style="color: #268bd2; font-weight: bold;">init_verneed</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#26681;&#25454; .gnu.version_r &#33719;&#24471;&#22914;&#19979;&#20449;&#24687;:</span>
<span style="color: #586e75;">   * 1. sym &#20381;&#36182;&#30340; version &#30340;&#21517;&#23383;</span>
<span style="color: #586e75;">   * 2. &#35813; version &#22312;&#21738;&#20010; soinfo &#34987;&#23450;&#20041;</span>
<span style="color: #586e75;">   *</span><span style="color: #586e75;"> */</span>

<span style="color: #268bd2; font-weight: bold;">init_verdef</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#26681;&#25454; .gnu.version_d &#33719;&#24471;&#22914;&#19979;&#20449;&#24687;:</span>
<span style="color: #586e75;">   * 1. sym &#20381;&#36182;&#30340; version &#30340;&#21517;&#23383;</span>
<span style="color: #586e75;">   * 2. &#19981;&#38656;&#35201;&#26597;&#25214; version &#22312;&#21738;&#23450;&#20041;: &#23427;&#32943;&#23450;&#26159;&#22312;&#24403;&#21069; so &#23450;&#20041;&#30340;</span><span style="color: #586e75;"> */</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb36c1b4" class="outline-5">
<h5 id="orgb36c1b4"><span class="section-number-5">1.7.1.2</span> relocate</h5>
<div class="outline-text-5" id="text-1-7-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">relocate</span>:
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#24403;&#21069; so &#20013;&#38656;&#35201;&#37325;&#23450;&#20301;&#30340; sym</span><span style="color: #586e75;"> */</span>
  sym_name = get_string<span style="color: #757575;">(</span>symtab_[sym].st_name<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#33719;&#24471; version_info</span><span style="color: #586e75;"> */</span>
  <span style="color: #268bd2;">lookup_version_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">version_tracker</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sym</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sym_name</span><span style="color: #757575;">,</span> &amp;vi<span style="color: #757575;">))</span>
    <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Versym</span><span style="color: #757575;">)</span> sym_ver = *<span style="color: #757575;">(</span>get_versym<span style="color: #757575;">(</span>sym<span style="color: #757575;">))</span>;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">*sym_ver &#26159; sym &#30340; version &#30340; index &#20540;</span><span style="color: #586e75;"> */</span>
    *vi = version_tracker.get_version_info<span style="color: #757575;">(</span>sym_ver<span style="color: #757575;">)</span>;
      <span style="color: #859900;">return</span> &amp;version_infos[source_symver];
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36890;&#36807; lookup_version_info, &#33719;&#24471;&#20102; sym &#35201;&#27714;&#30340; version name, &#20197;&#21450;</span><span style="color: #586e75;"> */</span>

  <span style="color: #268bd2;">soinfo_do_lookup</span><span style="color: #757575;">(</span><span style="color: #b58900;">this</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sym_name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">vi</span><span style="color: #757575;">,</span> &amp;lsi<span style="color: #757575;">,</span> <span style="color: #b58900;">global_group</span><span style="color: #757575;">,</span> <span style="color: #b58900;">local_group</span><span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">)</span>
    si-&gt;find_symbol_by_name<span style="color: #757575;">(</span>symbol_name<span style="color: #757575;">,</span> vi<span style="color: #757575;">,</span> &amp;s<span style="color: #757575;">)</span>
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">suppose not using gnu hash</span><span style="color: #586e75;"> */</span>
      <span style="color: #268bd2;">elf_lookup</span><span style="color: #757575;">(</span><span style="color: #b58900;">symbol_name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">vi</span><span style="color: #757575;">,</span> &amp;symbol_index<span style="color: #757575;">)</span>

elf_lookup:
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>find_verdef_version_index<span style="color: #757575;">(</span>vi<span style="color: #757575;">,</span> &amp;verneed<span style="color: #757575;">))</span>:
    for_each_verdef<span style="color: #757575;">(</span>this<span style="color: #757575;">,</span>
      [&amp;]<span style="color: #757575;">(</span>size_t<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Verdef</span><span style="color: #757575;">)</span>* verdef<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Verdaux</span><span style="color: #757575;">)</span>* verdaux<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
                      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>verdef-&gt;vd_hash == vi-&gt;elf_hash &amp;&amp;
                          strcmp<span style="color: #757575;">(</span>vi-&gt;name<span style="color: #757575;">,</span> get_string<span style="color: #757575;">(</span>verdaux-&gt;vda_name<span style="color: #757575;">))</span> == 0<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
                        *versym = verdef-&gt;vd_ndx;
                        <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
                      <span style="color: #757575;">}</span>

                      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
                    <span style="color: #757575;">}</span>
      <span style="color: #757575;">)</span>;
    <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#22312;&#24403;&#21069; so &#30340; .gnu.version_d &#20013;&#25214;&#21040;&#35201;&#27714;&#30340; version name &#23545;&#24212;&#30340;</span>
<span style="color: #586e75;">   * version index (verneed)</span><span style="color: #586e75;"> */</span>

  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">uint32_t</span> <span style="color: #268bd2;">n</span> = bucket_[hash % nbucket_]; n != 0; n = chain_[n]<span style="color: #757575;">)</span>:
    ElfW<span style="color: #757575;">(</span>Sym<span style="color: #757575;">)</span>* s = symtab_ + n;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">&#36890;&#36807;&#35835;&#21462; .gnu.version &#33719;&#24471;&#24403;&#21069; so &#20013; sym (n) &#30340; version (verdef)</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">const</span> <span style="color: #b58900;">ElfW</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Versym</span><span style="color: #757575;">)</span>* verdef = get_versym<span style="color: #757575;">(</span>n<span style="color: #757575;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">check version</span><span style="color: #586e75;"> */</span>
      check_symbol_version<span style="color: #757575;">(</span>verneed<span style="color: #757575;">,</span> verdef<span style="color: #757575;">)</span> &amp;&amp;
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">check name</span><span style="color: #586e75;"> */</span>
      strcmp<span style="color: #757575;">(</span>get_string<span style="color: #757575;">(</span>s-&gt;st_name<span style="color: #757575;">),</span> symbol_name.get_name<span style="color: #757575;">())</span> == 0 &amp;&amp;
      <span style="color: #586e75;">/* </span><span style="color: #586e75;">check visibility</span><span style="color: #586e75;"> */</span>
      is_symbol_global_and_defined<span style="color: #757575;">(</span>this<span style="color: #757575;">,</span> s<span style="color: #757575;">))</span>:
      *symbol_index = n;
      <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6283d4" class="outline-5">
<h5 id="orgf6283d4"><span class="section-number-5">1.7.1.3</span> 总结</h5>
<div class="outline-text-5" id="text-1-7-1-3">
<p>
link_image 时会针对要 link 的当前 so 构造一个 version_tracker, 主要就是读取了 .gnu.version 和 .gnu.version_r, 确定 UNDEF 的符号要求的
version 的名字 (verneed)
</p>

<p>
relocate 时需要判断 so 中某个 sym 的 verdef 与 verneed 是否相同. 而
verdef 是通过读取 so 的 .gnu.version 和 .gnu.version_d 获得的. 
</p>
</div>
</div>
</div>

<div id="outline-container-orgb309f18" class="outline-4">
<h4 id="orgb309f18"><span class="section-number-4">1.7.2</span> how linker is compiled</h4>
<div class="outline-text-4" id="text-1-7-2">
<pre class="example" id="org06b1af0">
clang++ -nostdlib -Bstatic  -Wl,--gc-sections -o /linker_intermediates/LINKED/linker64 -Lout/target/product/sp9850j_1h10/obj/lib

-Wl,-z,noexecstack -Wl,-z,relro -Wl,-z,now -Wl,--build-id=md5 -Wl,--warn-shared-textrel -Wl,--fatal-warnings -Wl,-maarch64linux -Wl,--hash-style=gnu -Wl,--fix-cortex-a53-843419 -fuse-ld=gold -Wl,--icf=safe -Wl,--no-undefined-version -Wl,--allow-shlib-undefined    -target aarch64-linux-android -Bprebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/aarch64-linux-android/bin   -shared -Wl,-Bsymbolic -Wl,--exclude-libs,ALL -Wl,--no-undefined

/linker_intermediates/arch/arm64/begin.o   /linker_intermediates/debugger.o /linker_intermediates/dlfcn.o /linker_intermediates/linker.o /linker_intermediates/linker_allocator.o /linker_intermediates/linker_block_allocator.o /linker_intermediates/linker_dlwarning.o /linker_intermediates/linker_gdb_support.o /linker_intermediates/linker_mapped_file_fragment.o /linker_intermediates/linker_memory.o /linker_intermediates/linker_phdr.o /linker_intermediates/linker_sdk_versions.o /linker_intermediates/linker_utils.o /linker_intermediates/rt.o       /linker_intermediates/linker_libc_support.o

-Wl,--whole-archive   -Wl,--no-whole-archive /libziparchive_intermediates/libziparchive.a /libutils_intermediates/libutils.a /libbase_intermediates/libbase.a /libz_intermediates/libz.a /liblog_intermediates/liblog.a /libc++_static_intermediates/libc++_static.a /libm_intermediates/libm.a /libdl_intermediates/libdl.a /libcompiler_rt-extras_intermediates/libcompiler_rt-extras.a 

-Wl,--start-group
/libc_intermediates/libc.a /libc_nomalloc_intermediates/libc_nomalloc.a  prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/../lib/gcc/aarch64-linux-android/4.9/../../../../aarch64-linux-android/lib/../lib64/libatomic.a prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/../lib/gcc/aarch64-linux-android/4.9/libgcc.a
-Wl,--end-group

aarch64-linux-android-objcopy --prefix-symbols=__dl_ /linker_intermediates/LINKED/linker64                         
</pre>

<p>
所以 linker 是一个 DSO, 而且它编译时使用了 Bsymbolic, 所以在完成自身的重定位之前, 它就已经可以正确的调用自身的各种函数了, 因为这些函数不是通过 plt 的方式来调用的.
</p>

<p>
参考 
</p>
</div>
</div>

<div id="outline-container-orgb86d7cc" class="outline-4">
<h4 id="orgb86d7cc"><span class="section-number-4">1.7.3</span> RTLD_GLOBAL, DF_1_GLOBAL, global_group</h4>
<div class="outline-text-4" id="text-1-7-3">
<p>
RTLD_GLOBAL 与 DF_1_GLOBAL 有关:
</p>

<ol class="org-ol">
<li>dlopen 时使用 RTLD_GLOBAL flag</li>
<li>应用启动时加载的 so (通过 DT_NEEDED, 自动指定了 RTLD_GLOBAL)</li>
<li>dlopen 时 load 了一个指定了 DF_1_GLOBAL 的 so</li>
</ol>

<p>
三种情况 load 的 so 都带有 RTLD_GLOBAL 标记, 后续 dlopen 打开的 so 可以直接使用这些 so中的符号. <a href="http://www.informit.com/articles/article.aspx?p=22435">http://www.informit.com/articles/article.aspx?p=22435</a>
</p>

<p>
global_group 也和 DF_1_GLOBAL 有关:
</p>

<p>
exectuable, LD_PRELOAD (不包含其 DT_NEEDED 引入的 so) 以及 DF_1_GLOBAL 的 so 属于 global_group, 在 lookup 时优先考虑
</p>
</div>
</div>
</div>

<div id="outline-container-org4913190" class="outline-3">
<h3 id="org4913190"><span class="section-number-3">1.8</span> summary</h3>
<div class="outline-text-3" id="text-1-8">
<p>
linker 主要的代码是:
</p>

<ol class="org-ol">
<li>load_library, 找到 so</li>

<li>find_libraries, 解析 DT_NEEDED, 构造依赖树</li>

<li>对各个 so 以 BFS 的顺序进行 link_image, 进行 GOT 和 PLT 的重定位</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org5666638" class="outline-2">
<h2 id="org5666638"><span class="section-number-2">2</span> init</h2>
</div>

<div id="outline-container-orgc88c1fb" class="outline-2">
<h2 id="orgc88c1fb"><span class="section-number-2">3</span> link_image</h2>
</div>

<div id="outline-container-org8dd94a1" class="outline-2">
<h2 id="org8dd94a1"><span class="section-number-2">4</span> find_libraries</h2>
</div>

<div id="outline-container-orgafde92c" class="outline-2">
<h2 id="orgafde92c"><span class="section-number-2">5</span> dlfcn</h2>
</div>

<div id="outline-container-org11e4315" class="outline-2">
<h2 id="org11e4315"><span class="section-number-2">6</span> android_namespace</h2>
</div>

<div id="outline-container-org9513946" class="outline-2">
<h2 id="org9513946"><span class="section-number-2">7</span> version_tracker</h2>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-04-27 四 00:00<br />
Last updated: 2021-10-26 二 19:44</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

           <div id="disqus_thread"></div>
           <script>

           (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sunwayforever-github-io.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
           </script>
</div>
</body>
</html>
