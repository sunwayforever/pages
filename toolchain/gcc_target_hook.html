<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GCC Target Hook</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">GCC Target Hook</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org000001c">1. GCC Target Hook</a>
<ul>
<li><a href="#org0000000">1.1. TARGET_PRINT_OPERAND</a></li>
<li><a href="#org0000003">1.2. TARGET_PRINT_OPERAND_ADDRESS</a></li>
<li><a href="#org0000006">1.3. TARGET_CONDITIONAL_REGISTER_USAGE</a></li>
<li><a href="#org000000a">1.4. TARGET_STRUCT_VALUE_RTX</a></li>
<li><a href="#org0000013">1.5. cost 相关</a>
<ul>
<li><a href="#org000000d">1.5.1. TARGET_RTX_COSTS</a></li>
<li><a href="#org0000010">1.5.2. TARGET_SLOW_UNALIGNED_ACCESS</a></li>
</ul>
</li>
<li><a href="#org0000019">1.6. schedule 相关</a>
<ul>
<li><a href="#org0000016">1.6.1. TARGET_SCHED_ISSUE_RATE</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000001c" class="outline-2">
<h2 id="org000001c"><span class="section-number-2">1</span> GCC Target Hook</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://gcc.gnu.org/onlinedocs/gccint/Target-Macros.html#Target-Macros">https://gcc.gnu.org/onlinedocs/gccint/Target-Macros.html#Target-Macros</a>
</p>

<p>
<a href="gcc_backend.html#ID-02e7f924-9cf7-4e3d-8ceb-1765fd3a2bed">GCC Backend</a> 的 example 里看到的
</p>

<ul class="org-ul">
<li>riscv_print_operand</li>
<li>riscv_print_operand_address</li>
<li>riscv_conditional_register_usage</li>
</ul>

<p>
都是 target hook.
</p>

<p>
target hook 定义在 target.def 中, 以 conditional_register_usage 为例:
</p>

<ul class="org-ul">
<li><p>
riscv 通过 TARGET_CONDITIONAL_REGISTER_USAGE 定义一个 hook 的实现
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">TARGET_CONDITIONAL_REGISTER_USAGE</span> riscv_conditional_register_usage
</pre>
</div></li>

<li>代码中通过 targetm.conditional_register_usage () 调用到 target hook</li>
</ul>
</div>

<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1</span> TARGET_PRINT_OPERAND</h3>
</div>

<div id="outline-container-org0000003" class="outline-3">
<h3 id="org0000003"><span class="section-number-3">1.2</span> TARGET_PRINT_OPERAND_ADDRESS</h3>
</div>

<div id="outline-container-org0000006" class="outline-3">
<h3 id="org0000006"><span class="section-number-3">1.3</span> TARGET_CONDITIONAL_REGISTER_USAGE</h3>
</div>

<div id="outline-container-org000000a" class="outline-3">
<h3 id="org000000a"><span class="section-number-3">1.4</span> TARGET_STRUCT_VALUE_RTX</h3>
<div class="outline-text-3" id="text-1-4">
<p>
用来设置 <a href="gcc_named_return_value.html#ID-e53c6711-2a42-473c-af42-a27179f8c22b">GCC Named Return Value</a> 如何把 nrv 传递给 callee
</p>

<p>
例如:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">TARGET_STRUCT_VALUE_RTX</span> my_struct_value_rtx

<span class="org-keyword">static</span> <span class="org-type">rtx</span> <span class="org-function-name">my_struct_value_rtx</span>(
    tree <span class="org-type">fntype</span> <span class="org-variable-name">ATTRIBUTE_UNUSED</span>, <span class="org-type">int</span> <span class="org-variable-name">incoming</span> ATTRIBUTE_UNUSED) {
    <span class="org-keyword">return</span> gen_rtx_REG(Pmode, 13);
}
</pre>
</div>

<p>
表示用 reg 13 (riscv 的 a3) 传递 nrv. 若该宏没有定义, 则会把 nrv 看做 callee 的第一个参数来处理
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">X</span> {
    <span class="org-type">int</span> <span class="org-variable-name">a</span>;
    <span class="org-type">int</span> <span class="org-variable-name">b</span>;
    <span class="org-type">int</span> <span class="org-variable-name">c</span>;
    <span class="org-type">int</span> <span class="org-variable-name">d</span>;
    <span class="org-type">int</span> <span class="org-variable-name">e</span>;
    <span class="org-type">int</span> <span class="org-variable-name">f</span>;
};

<span class="org-keyword">struct</span> <span class="org-type">X</span> <span class="org-function-name">foo</span>(<span class="org-type">int</span> <span class="org-variable-name">a</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">X</span> <span class="org-variable-name">x</span> = {0};
    x.a = a;
    <span class="org-keyword">return</span> x;
}
</pre>
</div>

<pre class="example" id="org0000009">
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-gcc  test.c -O1 -c
$&gt; /opt/riscv/bin/riscv64-unknown-linux-gnu-objdump -d ./test.o

0000000000000000 &lt;foo&gt;:
   0:   c288                    sw      a0,0(a3)
   2:   0006a223                sw      zero,4(a3)
   6:   0006a423                sw      zero,8(a3)
   a:   0006a623                sw      zero,12(a3)
   e:   0006a823                sw      zero,16(a3)
  12:   0006aa23                sw      zero,20(a3)
  16:   8536                    mv      a0,a3
  18:   8082                    ret
</pre>
</div>
</div>

<div id="outline-container-org0000013" class="outline-3">
<h3 id="org0000013"><span class="section-number-3">1.5</span> cost 相关</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org000000d" class="outline-4">
<h4 id="org000000d"><span class="section-number-4">1.5.1</span> <a href="gcc_cost.html#ID-50a2267b-7dd0-4a07-997f-9dcc76933ba3">TARGET_RTX_COSTS</a></h4>
</div>

<div id="outline-container-org0000010" class="outline-4">
<h4 id="org0000010"><span class="section-number-4">1.5.2</span> <a href="gcc_cost.html#ID-98f35525-3f8c-4f76-8478-6cab3f3182be">TARGET_SLOW_UNALIGNED_ACCESS</a></h4>
</div>
</div>

<div id="outline-container-org0000019" class="outline-3">
<h3 id="org0000019"><span class="section-number-3">1.6</span> schedule 相关</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org0000016" class="outline-4">
<h4 id="org0000016"><span class="section-number-4">1.6.1</span> <a href="gcc_scheduler.html#ID-38916ef6-f300-47db-8c70-41e3256af352">TARGET_SCHED_ISSUE_RATE</a></h4>
</div>
</div>
</div>


<div id="outline-container-org000001f" class="outline-2 references">
<h2 id="org000001f">Backlinks</h2>
<div class="outline-text-2" id="text-org000001f">
<p>
<a href="gcc_backend.html#ID-02e7f924-9cf7-4e3d-8ceb-1765fd3a2bed">GCC Backend</a>
(<i>GCC Backend &gt; gcc target hook</i>):   <a href="gcc_target_hook.html#ID-ecd308f9-413b-467a-8d55-10bd7485a2bc">gcc target hook</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-04-26 Tue 19:45<br />
Last updated: 2022-04-26 Tue 19:48</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
