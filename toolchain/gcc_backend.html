<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GCC Backend</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">GCC Backend</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000076">1. GCC Backend</a>
<ul>
<li><a href="#org0000004">1.1. optab</a>
<ul>
<li><a href="#org000002e">1.1.1. overview</a></li>
<li><a href="#ID-c1ff5b55-a6cd-41c5-aab9-248f52262030">1.1.2. optab_libfunc</a></li>
</ul>
</li>
<li><a href="#ID-a354364f-e048-4d6f-b780-0271f16dfd6a">1.2. rtl</a>
<ul>
<li><a href="#org0000008">1.2.1. rtl.def</a></li>
<li><a href="#org000000c">1.2.2. constant expression</a></li>
<li><a href="#org000000f">1.2.3. register memory expression</a></li>
<li><a href="#org0000012">1.2.4. arithmetic expression</a></li>
<li><a href="#org0000016">1.2.5. conversion expression</a></li>
<li><a href="#org000000d">1.2.6. side effect expression</a></li>
<li><a href="#org0000020">1.2.7. misc</a></li>
</ul>
</li>
<li><a href="#ID-5304f835-9c6a-49bc-89a5-ca01e2520167">1.3. machine description</a>
<ul>
<li><a href="#org0000022">1.3.1. overview</a></li>
<li><a href="#org0000040">1.3.2. WAIT md 语法</a></li>
</ul>
</li>
<li><a href="#org0000073">1.4. WAIT pass</a>
<ul>
<li><a href="#org0000052">1.4.1. pass_expand</a></li>
<li><a href="#org0000055">1.4.2. pass_ira</a></li>
<li><a href="#org0000061">1.4.3. pass_thread_prologue_and_epilogue</a></li>
<li><a href="#org0000070">1.4.4. pass_final</a></li>
</ul>
</li>
<li><a href="#org000008c">1.5. example</a>
<ul>
<li><a href="#org000007d">1.5.1. gimple to rtl</a></li>
<li><a href="#org000001c">1.5.2. rtl to assembly</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000076" class="outline-2">
<h2 id="org0000076"><span class="section-number-2">1</span> GCC Backend</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000004" class="outline-3">
<h3 id="org0000004"><span class="section-number-3">1.1</span> optab</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org000002e" class="outline-4">
<h4 id="org000002e"><span class="section-number-4">1.1.1</span> overview</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
optab 的定义在 optabs.def, 主要是作用是记录了 optab (例如 add_optab) 与 rtl insn
的对应关系, gimple to rtl 时依靠这个对应关系找到 rtl expression
</p>
</div>
</div>

<div id="outline-container-ID-c1ff5b55-a6cd-41c5-aab9-248f52262030" class="outline-4">
<h4 id="ID-c1ff5b55-a6cd-41c5-aab9-248f52262030"><span class="section-number-4">1.1.2</span> optab_libfunc</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
当 optab_handler 找不到 `optab+machmode` 对应的 insn 时, 会通过 optab_libfunc 生成对某个外部函数的调用, 例如 __divsf3. 这些函数是在 <a href="bare_metal.html#ID-27a07646-18c6-4504-b36e-a5d63871a0d2">libgcc</a> 中实现的.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">rtx</span> <span class="org-function-name">optab_libfunc</span>(<span class="org-type">optab</span> <span class="org-variable-name">optab</span>, <span class="org-type">machine_mode</span> <span class="org-variable-name">mode</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">libfunc_entry</span> <span class="org-variable-name">e</span>;
    <span class="org-keyword">struct</span> <span class="org-type">libfunc_entry</span> **<span class="org-variable-name">slot</span>;

    e.op = optab;
    e.mode1 = mode;
    e.mode2 = VOIDmode;
    slot = libfunc_hash-&gt;find_slot(&amp;e, NO_INSERT);
    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>slot) {
        <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">optab_libcall_d</span> *<span class="org-variable-name">d</span> =
            &amp;normlib_def[optab - FIRST_NORM_OPTAB];

        <span class="org-keyword">if</span> (d-&gt;libcall_gen == <span class="org-constant">NULL</span>) <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">d-&gt;libcall_gen &#20013;&#20449;&#24687;&#26469;&#33258; optabs.def, &#20363;&#22914;</span>
<span class="org-comment">         * OPTAB_NL(add_optab, "add$P$a3", PLUS, "add", '3', gen_int_fp_fixed_libfunc)</span>
<span class="org-comment">         * &#34920;&#31034; add_optab &#30340; libcall_basename &#20026; "add", libcall_gen &#20026; gen_int_fp_fixed_libfunc,</span>
<span class="org-comment">         * &#21518;&#32773;&#20250;&#26681;&#25454; libcall_basename(add) &#21644; mode (sf) &#29983;&#25104;&#19968;&#20010;&#21517;&#20026; __addsf3 &#30340; libfunc_entry</span>
<span class="org-comment">         * &#21518;&#36890;&#36807; set_optab_libfunc &#35774;&#32622;&#21040; libfunc_hash, &#21518;&#32493;&#23601;&#21487;&#20197;&#29983;&#25104;&#23545; __addsf3 &#30340;&#35843;&#29992;</span>
<span class="org-comment">         *</span><span class="org-comment-delimiter"> */</span>

        d-&gt;libcall_gen(optab, d-&gt;libcall_basename, d-&gt;libcall_suffix, mode);
        slot = libfunc_hash-&gt;find_slot(&amp;e, NO_INSERT);
        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>slot) <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;
    }
    <span class="org-keyword">return</span> (*slot)-&gt;libfunc;
}
</pre>
</div>

<p>
实际上 soft-float 与 hard-float 的区别就是是通过 optab_libfunc 机制来体现的:
</p>

<pre class="example" id="org0000003">
(define_insn "div&lt;mode&gt;3"
  [(set (match_operand:ANYF           0 "register_operand" "=f")
    (div:ANYF (match_operand:ANYF 1 "register_operand" " f")
          (match_operand:ANYF 2 "register_operand" " f")))]
  "TARGET_HARD_FLOAT &amp;&amp; TARGET_FDIV"
  "fdiv.&lt;fmt&gt;\t%0,%1,%2"
  [(set_attr "type" "fdiv")
   (set_attr "mode" "&lt;UNITMODE&gt;")])
</pre>

<p>
当 TARGET_HARD_FLOAT 时, optab_handler 会找到这里会产生的 divsf3/divdf3 两条
insn. 否则就会通过 optab_libfunc 产生对 __divsf3/__divdf3 的调用
</p>
</div>
</div>
</div>

<div id="outline-container-ID-a354364f-e048-4d6f-b780-0271f16dfd6a" class="outline-3">
<h3 id="ID-a354364f-e048-4d6f-b780-0271f16dfd6a"><span class="section-number-3">1.2</span> rtl</h3>
<div class="outline-text-3" id="text-1-2">
<p>
rtl (register transfer language) 包含许多不同的 rtx (rtl expression), 例如:
</p>

<pre class="example" id="org0000007">
DEF_RTL_EXPR(PLUS, "plus", "ee", RTX_COMM_ARITH)
</pre>

<p>
表示:
</p>

<ol class="org-ol">
<li>rtx_code 为 PLUS</li>
<li>name 为 "plus"</li>
<li>format 为 "ee", 表示两个 operand 都是 `expression`</li>
<li>class 为 RTX_COMM_ARITH</li>
</ol>

<p>
多个 rtx 可嵌套, 例如 `(set x (plus a b))`, 其中:
</p>

<ol class="org-ol">
<li>`set`, `plus` 是 rtx_code</li>

<li>`(plus&#x2026;)` 是 `(set &#x2026;)` 的 operand, operand 类型可以是 expression, int,
string 等, 通过 XEXP, XINT, XWINT 和 XSTR 宏可以访问, 例如XEXP(x, 2) 是获得 x
的 operand[2] (假设它是一个 expression)</li>
</ol>
</div>


<div id="outline-container-org0000008" class="outline-4">
<h4 id="org0000008"><span class="section-number-4">1.2.1</span> rtl.def</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
rtl.def 相当于 rtl 语言的词汇表, 所有的 rtx 都定义在 rtl.def 中, 例如
symbol_ref, 可以直接在 md 中使用, 也可以在 c 代码中使用 gengenrtl 生成的
gen_rtx_SYMBOL_REF.
</p>

<p>
所以可以使用两种方式来写 rtl:
</p>

<ol class="org-ol">
<li>直接在 md 中用纯文本来构造, 然后通过 genemit 生成 rtx, 例如 md 中
`define_insn` 的做法,</li>

<li>通过 gengenrtl 工具扫描 rtl.def 生成权举类型 (例如 PLUS) 和函数 (例如
gen_rtx_PLUS), 然后通过 c 代码来构造 rtx, 例如 md 中 `define_expand` 的做法</li>
</ol>
</div>
</div>


<div id="outline-container-org000000c" class="outline-4">
<h4 id="org000000c"><span class="section-number-4">1.2.2</span> constant expression</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>const_int</li>

<li>const_string</li>

<li><p>
label_ref
</p>

<pre class="example" id="org000000b">
(define_insn "*branch&lt;mode&gt;"
  [(set (pc)
    (if_then_else
     (match_operator 1 "order_operator"
             [(match_operand:X 2 "register_operand" "r")
              (match_operand:X 3 "reg_or_0_operand" "rJ")])
     (label_ref (match_operand 0 "" ""))
     (pc)))]
  ""
  "b%C1\t%2,%z3,%0")
</pre></li>

<li>code_label</li>

<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org000000f" class="outline-4">
<h4 id="org000000f"><span class="section-number-4">1.2.3</span> register memory expression</h4>
<div class="outline-text-4" id="text-1-2-3">
<ul class="org-ul">
<li>reg</li>
<li>scratch</li>
<li>pc</li>
<li>mem</li>
<li>&#x2026;</li>
</ul>
</div>
</div>


<div id="outline-container-org0000012" class="outline-4">
<h4 id="org0000012"><span class="section-number-4">1.2.4</span> arithmetic expression</h4>
<div class="outline-text-4" id="text-1-2-4">
<ul class="org-ul">
<li>plus/minus/mult/div/mod</li>
<li>compare</li>
<li>neg</li>
<li>not/and/or/xor/ior</li>
<li>ashift</li>
<li>ss_abs/sqrt</li>
<li>clz/ctz</li>
<li>eq/ne/gt/gtu/lt</li>
<li>if_then_else</li>
<li>cond</li>
<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org0000016" class="outline-4">
<h4 id="org0000016"><span class="section-number-4">1.2.5</span> conversion expression</h4>
<div class="outline-text-4" id="text-1-2-5">
<ul class="org-ul">
<li>sign_extend/zero_extend</li>
<li>float_extend</li>
<li><p>
float_truncate
</p>

<p>
把 df truncate 成 sf:
</p>

<pre class="example" id="org0000015">
(define_insn "truncdfsf2"
  [(set (match_operand:SF     0 "register_operand" "=f")
    (float_truncate:SF
        (match_operand:DF 1 "register_operand" " f")))]
  "TARGET_DOUBLE_FLOAT"
  "fcvt.s.d\t%0,%1")
</pre></li>

<li>truncate</li>
<li>float</li>
<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org000000d" class="outline-4">
<h4 id="org000000d"><span class="section-number-4">1.2.6</span> side effect expression</h4>
<div class="outline-text-4" id="text-1-2-6">
<ul class="org-ul">
<li>set</li>
<li>call</li>
<li><p>
clobber
</p>

<p>
clobber 是指 rtl 会隐式的修改这个寄存器, 例如:
</p>

<pre class="example" id="org0000019">
(define_insn "call_internal"
  [(call (mem:SI (match_operand 0 "call_insn_operand" "l,S,U"))
     (match_operand 1 "" ""))
   (clobber (reg:SI RETURN_ADDR_REGNUM))]
  ""
  "@
   jalr\t%0
   call\t%0
   call\t%0@plt"
)
</pre>

<p>
call 会隐式给 ra 赋值, 所以用 `(clobber (reg:SI ra))`.
</p>

<p>
clobber 与 CALL_USED_REGISTERS 的意义类似.
</p></li>

<li><p>
use
</p>

<p>
use 是指 rtl 会隐式的读取这个寄存器, 防止前面针对这个寄存器的写操作被优化掉,例如:
</p>

<pre class="example" id="org000001a">
(define_insn "simple_return_internal"
  [(simple_return)
   (use (match_operand 0 "pmode_register_operand" ""))]
  ""
  "jr\t%0"
)
</pre>

<p>
表示 simple_return_internal 的第一个 operand 需要被隐式使用.
</p></li>

<li><p>
parallel
</p>

<p>
parallel 比较像 lisp 的 prog?
</p></li>

<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org0000020" class="outline-4">
<h4 id="org0000020"><span class="section-number-4">1.2.7</span> misc</h4>
<div class="outline-text-4" id="text-1-2-7">
<ul class="org-ul">
<li>code_label</li>

<li><p>
insn
</p>

<p>
insn 是一种特殊的 rtx, 它封装了其它的 rtx (通过 PATTERN(insn) 可以得到, 实际上就是 XEXP(3)), 同时用两个额外的 operand (0 和 1) 和其它 insn 关联起来, 这些
insn 用来表示一个完整的函数, 例如 pass_final dump 的结果:
</p>

<pre class="example" id="org000001e">
(insn 13 11 14 (set (reg:SI 15 a5 [74])
        (plus:SI (reg:SI 15 a5 [75])
            (const_int 1 [0x1]))) "test.c":5:10 3 {addsi3}
     (nil))
</pre></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-ID-5304f835-9c6a-49bc-89a5-ca01e2520167" class="outline-3">
<h3 id="ID-5304f835-9c6a-49bc-89a5-ca01e2520167"><span class="section-number-3">1.3</span> machine description</h3>
<div class="outline-text-3" id="text-1-3">
</div>

<div id="outline-container-org0000022" class="outline-4">
<h4 id="org0000022"><span class="section-number-4">1.3.1</span> overview</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
machine description 有两个作用:
</p>

<ol class="org-ol">
<li>gimple to rtl 时根据 optab 找到 md 中对应的 rtx</li>

<li>rtl to assembly 时根据 rtx 找到 md 中对应的 assembly</li>
</ol>
</div>
</div>

<div id="outline-container-org0000040" class="outline-4">
<h4 id="org0000040"><span class="section-number-4">1.3.2</span> WAIT md 语法</h4>
<div class="outline-text-4" id="text-1-3-2">
</div>
<div id="outline-container-org0000025" class="outline-5">
<h5 id="org0000025"><span class="section-number-5">1.3.2.1</span> define_insn</h5>
</div>

<div id="outline-container-org0000034" class="outline-5">
<h5 id="org0000034"><span class="section-number-5">1.3.2.2</span> define_expand</h5>
</div>

<div id="outline-container-org0000037" class="outline-5">
<h5 id="org0000037"><span class="section-number-5">1.3.2.3</span> define_mode_iterator</h5>
</div>

<div id="outline-container-org000002b" class="outline-5">
<h5 id="org000002b"><span class="section-number-5">1.3.2.4</span> define_mode_attr</h5>
</div>

<div id="outline-container-org000003d" class="outline-5">
<h5 id="org000003d"><span class="section-number-5">1.3.2.5</span> define_code_iterator</h5>
</div>

<div id="outline-container-org0000031" class="outline-5">
<h5 id="org0000031"><span class="section-number-5">1.3.2.6</span> define_code_attr</h5>
</div>

<div id="outline-container-org0000043" class="outline-5">
<h5 id="org0000043"><span class="section-number-5">1.3.2.7</span> define_c_enum</h5>
</div>

<div id="outline-container-org0000046" class="outline-5">
<h5 id="org0000046"><span class="section-number-5">1.3.2.8</span> define_constants</h5>
</div>

<div id="outline-container-org000003a" class="outline-5">
<h5 id="org000003a"><span class="section-number-5">1.3.2.9</span> define_attr</h5>
</div>

<div id="outline-container-org000004c" class="outline-5">
<h5 id="org000004c"><span class="section-number-5">1.3.2.10</span> 使用 emit-rtl.c 生成 rtl</h5>
</div>
</div>
</div>

<div id="outline-container-org0000073" class="outline-3">
<h3 id="org0000073"><span class="section-number-3">1.4</span> WAIT pass</h3>
<div class="outline-text-3" id="text-1-4">
<p>
所有的 pass 及其执行的顺序都在 passes.def 中指定.
</p>
</div>

<div id="outline-container-org0000052" class="outline-4">
<h4 id="org0000052"><span class="section-number-4">1.4.1</span> pass_expand</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
gimple 转换为 rtl
</p>
</div>
</div>

<div id="outline-container-org0000055" class="outline-4">
<h4 id="org0000055"><span class="section-number-4">1.4.2</span> pass_ira</h4>
<div class="outline-text-4" id="text-1-4-2">
<ol class="org-ol">
<li>寄存器分配</li>
<li>计算 frame_info, 例如计算 frame size 和需要保存和恢复的寄存器 (mask)</li>
</ol>
</div>


<div id="outline-container-org000005f" class="outline-5">
<h5 id="org000005f"><span class="section-number-5">1.4.2.1</span> frame_info</h5>
<div class="outline-text-5" id="text-1-4-2-1">
<p>
taget 需要定义 INITIAL_ELIMINATION_OFFSET 这个宏, 用来计算 frame info.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">riscv_compute_frame_info</span>(<span class="org-type">void</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">riscv_frame_info</span> *<span class="org-variable-name">frame</span>;
    <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">offset</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">interrupt_save_prologue_temp</span> = <span class="org-constant">false</span>;
    <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>, <span class="org-variable-name">i</span>, <span class="org-variable-name">num_x_saved</span> = 0, <span class="org-variable-name">num_f_saved</span> = 0;

    frame = &amp;cfun-&gt;machine-&gt;frame;
    memset(frame, 0, <span class="org-keyword">sizeof</span>(*frame));

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: naked function</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>cfun-&gt;machine-&gt;naked_p) {
        <span class="org-keyword">for</span> (regno = GP_REG_FIRST; regno &lt;= GP_REG_LAST; regno++)
            <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: riscv_save_reg_p &#29992;&#26469;&#30830;&#23450;&#23492;&#23384;&#22120;&#26159;&#21542;&#38656;&#35201;&#20445;&#23384;, &#20363;&#22914;:</span>
<span class="org-comment">             * &#22914;&#26524; regno &#26159; s0~</span><span class="org-comment-delimiter"> */</span>
            <span class="org-keyword">if</span> (riscv_save_reg_p(regno))
                frame-&gt;mask |= 1 &lt;&lt; (regno - GP_REG_FIRST), num_x_saved++;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">Find out which FPRs we need to save.  This loop must iterate over</span>
<span class="org-comment">           the same space as its companion in riscv_for_each_saved_reg.</span><span class="org-comment-delimiter">  */</span>
        <span class="org-keyword">if</span> (TARGET_HARD_FLOAT)
            <span class="org-keyword">for</span> (regno = FP_REG_FIRST; regno &lt;= FP_REG_LAST; regno++)
                <span class="org-keyword">if</span> (riscv_save_reg_p(regno))
                    frame-&gt;fmask |= 1 &lt;&lt; (regno - FP_REG_FIRST), num_f_saved++;
    }

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#35745;&#31639; offset &#26102;&#26159;&#25353;&#29031; stack &#20174;&#20302;&#21040;&#39640;&#30340;&#39034;&#24207;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 1. &#26632;&#39030;&#26159; outgoing args, &#21363; spill &#21040;&#26632;&#19978;&#30340; args</span><span class="org-comment-delimiter"> */</span>
    offset = RISCV_STACK_ALIGN(crtl-&gt;outgoing_args_size);
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 2. &#28982;&#21518;&#26159; local variable</span><span class="org-comment-delimiter"> */</span>
    offset += RISCV_STACK_ALIGN(get_frame_size());
    <span class="org-comment-delimiter">/* </span><span class="org-comment">The virtual frame pointer points above the local variables.</span><span class="org-comment-delimiter"> */</span>
    frame-&gt;frame_pointer_offset = offset;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 3. &#38656;&#35201;&#20445;&#23384;&#30340; fp</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (frame-&gt;fmask)
        offset += RISCV_STACK_ALIGN(num_f_saved * UNITS_PER_FP_REG);
    frame-&gt;fp_sp_offset = offset - UNITS_PER_FP_REG;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: 4. &#38656;&#35201;&#20445;&#23384;&#30340; gp</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (frame-&gt;mask) {
        <span class="org-type">unsigned</span> <span class="org-variable-name">x_save_size</span> = RISCV_STACK_ALIGN(num_x_saved * UNITS_PER_WORD);
        offset += x_save_size;
    }
    frame-&gt;gp_sp_offset = offset - UNITS_PER_WORD;
    frame-&gt;hard_frame_pointer_offset = offset;
    frame-&gt;total_size = offset;
}
</pre>
</div>
</div>

<div id="outline-container-ID-6bd2709c-1c3e-4e22-98d3-4e9edc4aec33" class="outline-6">
<h6 id="ID-6bd2709c-1c3e-4e22-98d3-4e9edc4aec33"><span class="section-number-6">1.4.2.1.1</span> naked</h6>
<div class="outline-text-6" id="text-1-4-2-1-1">
<p>
naked function, 是指不需要 gcc 生成 prolog 和 epilogue 的函数, 例如一些完全用内联汇编写的函数.
</p>
</div>


<ul class="org-ul">
<li><a id="org0000049"></a>Backlinks<br />
<div class="outline-text-7" id="text-org0000049">
<p>
<a href="gcc_attribute.html#ID-463c82be-a55d-43c3-a8f2-cba1c1cd7599">GCC Attribute</a>
(<i>GCC Attribute &gt; naked</i>):   <a href="#ID-6bd2709c-1c3e-4e22-98d3-4e9edc4aec33">naked</a>
</p>
</div>
</li>
</ul>
</div>


<div id="outline-container-org0000058" class="outline-6">
<h6 id="org0000058"><span class="section-number-6">1.4.2.1.2</span> riscv_save_reg_p</h6>
<div class="outline-text-6" id="text-1-4-2-1-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">bool</span> <span class="org-function-name">riscv_save_reg_p</span>(<span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>) {
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: global_regs &#26159;&#25351; global regizer variable</span>
<span class="org-comment">     * https://gcc.gnu.org/onlinedocs/gcc/Global-Register-Variables.html</span>
<span class="org-comment">     *</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">bool</span> <span class="org-variable-name">call_saved</span> = <span class="org-negation-char">!</span>global_regs[regno] &amp;&amp; <span class="org-negation-char">!</span>call_used_or_fixed_reg_p(regno);
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: df_regs_ever_live_p &#25351;&#35813; reg &#22312;&#24403;&#21069;&#20989;&#25968;&#20462;&#25913;&#36807;, &#20363;&#22914;, &#33509;&#20989;&#25968;&#26159; leaf</span>
<span class="org-comment">     * function, ra &#20250;&#22240;&#20026;&#27809;&#26377;&#20462;&#25913;&#36807;&#32780;&#19981;&#38656;&#35201;&#20445;&#23384;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">bool</span> <span class="org-variable-name">might_clobber</span> =
        crtl-&gt;saves_all_registers || df_regs_ever_live_p(regno);

    <span class="org-keyword">if</span> (call_saved &amp;&amp; might_clobber) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-keyword">if</span> (regno == HARD_FRAME_POINTER_REGNUM &amp;&amp; frame_pointer_needed) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-keyword">if</span> (regno == RETURN_ADDR_REGNUM &amp;&amp; crtl-&gt;calls_eh_return) <span class="org-keyword">return</span> <span class="org-constant">true</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">return</span> <span class="org-constant">false</span>;
}

<span class="org-keyword">inline</span> <span class="org-type">bool</span> <span class="org-function-name">call_used_or_fixed_reg_p</span>(<span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">regno</span>) {
    <span class="org-keyword">return</span> fixed_regs[regno] || this_target_hard_regs-&gt;x_call_used_regs[regno];
}
</pre>
</div>

<p>
FIXED_REGISTER 和 CALL_USED_REGISTERS 为 target 定义的, 例如:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">FIXED_REGISTERS</span>                                                       \
    { <span class="org-comment-delimiter">/* </span><span class="org-comment">General registers.</span><span class="org-comment-delimiter">  */</span>                                               \
        1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  \
            0, 0, 0, 0, 0, 0, 0, 0, 0, <span class="org-comment-delimiter">/* </span><span class="org-comment">Floating-point registers.</span><span class="org-comment-delimiter">  */</span>       \
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, \
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, <span class="org-comment-delimiter">/* </span><span class="org-comment">Others.</span><span class="org-comment-delimiter">  */</span>                      \
            1, 1                                                              \
    }

<span class="org-comment-delimiter">/* </span><span class="org-comment">a0-a7, t0-t6, fa0-fa7, and ft0-ft11 are volatile across calls.</span>
<span class="org-comment">   The call RTLs themselves clobber ra.</span><span class="org-comment-delimiter">  */</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">CALL_USED_REGISTERS</span>                                                   \
    { <span class="org-comment-delimiter">/* </span><span class="org-comment">General registers.</span><span class="org-comment-delimiter">  */</span>                                               \
        1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,  \
            0, 0, 0, 0, 0, 1, 1, 1, 1, <span class="org-comment-delimiter">/* </span><span class="org-comment">Floating-point registers.</span><span class="org-comment-delimiter">  */</span>       \
            1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, \
            0, 0, 0, 0, 0, 0, 1, 1, 1, 1, <span class="org-comment-delimiter">/* </span><span class="org-comment">Others.</span><span class="org-comment-delimiter">  */</span>                      \
            1, 1                                                              \
    }
</pre>
</div>

<p>
FIXED_REGISTERS 是有特殊意义的 reg, 任何时候不能被随便修改, 例如 zero, sp, gp, tp
</p>

<p>
CALL_USED_REGISTERS 包含 FIXED_REGISTERS, 以及其它在函数调用时可能被 caller 修改的 reg, 基本上 (CALL_USED_REGISTERS - FIXED_REGISTERS) 即 caller saved reg, 而
~CALL_USED_REGISTERS 即 callee saved reg.
</p>

<p>
另外 gcc 可以通过运行时参数 `-ffixed-reg` 控制哪些 reg 属于
FIXED_REGISTERS. FIXED_REGISTERS 不会被 ira 分配, 也不会被 prologue 保存
</p>
</div>
</div>

<div id="outline-container-org000006a" class="outline-6">
<h6 id="org000006a"><span class="section-number-6">1.4.2.1.3</span> backtrace</h6>
<div class="outline-text-6" id="text-1-4-2-1-3">
<div class="org-src-container">
<pre class="src src-rust">#0  riscv_save_reg_p (regno=0) at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3636
#1  0x0000000001544432 <span class="org-keyword">in</span> riscv_compute_frame_info () at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3766
#2  0x000000000154483f <span class="org-keyword">in</span> riscv_initial_elimination_offset (from=64, to=2) at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">c</span>:3850
#3  0x0000000001062641 <span class="org-keyword">in</span> set_initial_elim_offsets () at ../.././riscv-gcc/gcc/reload1.<span class="org-variable-name">c</span>:3769
#4  0x000000000105c432 <span class="org-keyword">in</span> calculate_elim_costs_all_insns () at ../.././riscv-gcc/gcc/reload1.<span class="org-variable-name">c</span>:1559
#5  0x0000000000e8eee5 <span class="org-keyword">in</span> ira_costs () at ../.././riscv-gcc/gcc/ira-costs.<span class="org-variable-name">c</span>:2296
#6  0x0000000000e85524 <span class="org-keyword">in</span> ira_build () at ../.././riscv-gcc/gcc/ira-build.<span class="org-variable-name">c</span>:3426
#7  0x0000000000e7b6ae <span class="org-keyword">in</span> ira (f=0x0) at ../.././riscv-gcc/gcc/ira.<span class="org-variable-name">c</span>:5655
#8  0x0000000000e7bf6b <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_ira</span>::execute (this=0x23413c0) at ../.././riscv-gcc/gcc/ira.<span class="org-variable-name">c</span>:5978
#9  0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x23413c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#10 0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x23413c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#11 0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2340220) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#12 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#13 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#14 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#15 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#16 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#17 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#18 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#19 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#20 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#21 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000061" class="outline-4">
<h4 id="org0000061"><span class="section-number-4">1.4.3</span> pass_thread_prologue_and_epilogue</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
在函数中插入的 prologue 和 epilogue. prologue 是指函数开头需要插入的一些指令, 例如分配 stack frame, 保存寄存器. epilogue 是函数返回前需要插入指令, 例如释放
stack frame, 恢复寄存器.
</p>
</div>

<div id="outline-container-org0000064" class="outline-5">
<h5 id="org0000064"><span class="section-number-5">1.4.3.1</span> prologue</h5>
<div class="outline-text-5" id="text-1-4-3-1">
<p>
prologue 对应的 rtl 是由 md 中的通过 define_expand 定义的 prologue 决定的.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">rtx</span>
<span class="org-function-name">gen_prologue</span> (<span class="org-type">void</span>)
{
  <span class="org-type">rtx_insn</span> *<span class="org-variable-name">_val</span> = 0;
  start_sequence ();
  {
<span class="org-preprocessor">#define</span> <span class="org-variable-name">FAIL</span> <span class="org-keyword">return</span> (end_sequence (), _val)
<span class="org-preprocessor">#define</span> <span class="org-variable-name">DONE</span> <span class="org-keyword">return</span> (_val = get_insns (), end_sequence (), _val)
<span class="org-preprocessor">#line</span> 2202 <span class="org-string">"../.././riscv-gcc/gcc/config/riscv/riscv.md"</span>
{
  riscv_expand_prologue ();
  DONE;
}
<span class="org-preprocessor">#undef</span> DONE
<span class="org-preprocessor">#undef</span> FAIL
  }
  emit_insn (const1_rtx);
  _val = get_insns ();
  end_sequence ();
  <span class="org-keyword">return</span> _val;
}
</pre>
</div>

<p>
riscv_expand_prologue 负责生成函数开头的:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">addi</span> <span class="org-keyword">sp</span>, sp , xxx
<span class="org-function-name">sw</span> <span class="org-keyword">ra</span>, (4)sp
<span class="org-function-name">sw</span> <span class="org-keyword">s0</span>, (8)sp
## ...
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#36825;&#27573;&#20195;&#30721;&#36127;&#36131;&#29983;&#25104;&#20989;&#25968;&#24320;&#22836;&#30340;</span>
<span class="org-comment"> * addi sp, sp , xxx</span>
<span class="org-comment"> * sw ra, (4)sp</span>
<span class="org-comment"> * sw s0, (8)sp</span>
<span class="org-comment"> * ...</span>
<span class="org-comment"> *</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">void</span> <span class="org-function-name">riscv_expand_prologue</span>(<span class="org-type">void</span>) {
    <span class="org-keyword">struct</span> <span class="org-type">riscv_frame_info</span> *<span class="org-variable-name">frame</span> = &amp;cfun-&gt;machine-&gt;frame;
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;total_size &#22312; pass_ira &#26102;&#30830;&#23450;&#19979;&#26469;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">size</span> = frame-&gt;total_size;
    <span class="org-type">unsigned</span> <span class="org-variable-name">mask</span> = frame-&gt;mask;
    <span class="org-type">rtx</span> <span class="org-variable-name">insn</span>;

    <span class="org-keyword">if</span> (flag_stack_usage_info) current_function_static_stack_size = size;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Save the registers.</span><span class="org-comment-delimiter">  */</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;mask &#25351;&#21738;&#20123;&#23492;&#23384;&#22120;&#38656;&#35201;&#20445;&#23384;, &#20063;&#26159; pass_ira &#26102;&#30830;&#23450;&#30340;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> ((frame-&gt;mask | frame-&gt;fmask) != 0) {
        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#36825;&#37324;&#24182;&#27809;&#26377;&#30452;&#25509;&#20351;&#29992; frame-&gt;total_size, &#26159;&#22240;&#20026; total_size &#24456;&#22823;&#26102;</span>
<span class="org-comment">         * &#20250;&#26080;&#27861;&#36890;&#36807;&#19968;&#20010; addi &#23436;&#25104;, &#25152;&#20197;&#21487;&#20197;&#20808;&#20998;&#37197;&#36275;&#22815;&#23384;&#25918; saved reg &#30340;&#23567;&#19968;&#28857;&#30340;</span>
<span class="org-comment">         * `step`</span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">HOST_WIDE_INT</span> <span class="org-variable-name">step1</span> = MIN(size, riscv_first_stack_step(frame));

        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: addi sp, sp, -step1</span><span class="org-comment-delimiter"> */</span>
        insn = gen_add3_insn(
            stack_pointer_rtx, stack_pointer_rtx, GEN_INT(-step1));
        size -= step1;
        riscv_for_each_saved_reg(size, riscv_save_reg, <span class="org-constant">false</span>, <span class="org-constant">false</span>);
    }

    frame-&gt;mask = mask; <span class="org-comment-delimiter">/* </span><span class="org-comment">Undo the above fib.</span><span class="org-comment-delimiter">  */</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#38656;&#35201;&#20445;&#23384; fp, &#20363;&#22914;&#23384;&#22312; alloca</span><span class="org-comment-delimiter">  */</span>
    <span class="org-keyword">if</span> (frame_pointer_needed) {
        insn = gen_add3_insn(
            hard_frame_pointer_rtx, stack_pointer_rtx,
            GEN_INT(frame-&gt;hard_frame_pointer_offset - size));
        RTX_FRAME_RELATED_P(emit_insn(insn)) = 1;

        riscv_emit_stack_tie();
    }

    <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: frame-&gt;total_size &#21097;&#19979;&#30340;&#37096;&#20998;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">if</span> (size &gt; 0) {
        <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: SMALL_OPERAND &#26159;&#25351; 12 bit &#33021;&#34920;&#31034;&#30340;&#31435;&#21363;&#25968;</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">if</span> (SMALL_OPERAND(-size)) {
            insn = gen_add3_insn(
                stack_pointer_rtx, stack_pointer_rtx, GEN_INT(-size));
            RTX_FRAME_RELATED_P(emit_insn(insn)) = 1;
        } <span class="org-keyword">else</span> {
            riscv_emit_move(RISCV_PROLOGUE_TEMP(Pmode), GEN_INT(-size));
            emit_insn(gen_add3_insn(
                stack_pointer_rtx, stack_pointer_rtx,
                RISCV_PROLOGUE_TEMP(Pmode)));

            <span class="org-comment-delimiter">/* </span><span class="org-comment">Describe the effect of the previous instructions.</span><span class="org-comment-delimiter">  */</span>
            insn = plus_constant(Pmode, stack_pointer_rtx, -size);
            insn = gen_rtx_SET(stack_pointer_rtx, insn);
            riscv_set_frame_expr(insn);
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000067" class="outline-5">
<h5 id="org0000067"><span class="section-number-5">1.4.3.2</span> epilogue</h5>
</div>

<div id="outline-container-org000005e" class="outline-5">
<h5 id="org000005e"><span class="section-number-5">1.4.3.3</span> backtrace</h5>
<div class="outline-text-5" id="text-1-4-3-3">
<div class="org-src-container">
<pre class="src src-rust">#0  gen_prologue () at ../.././riscv-gcc/gcc/config/riscv/riscv.<span class="org-variable-name">md</span>:2202
#1  0x000000000153aada <span class="org-keyword">in</span> target_gen_prologue () at ../.././riscv-gcc/gcc/config/riscv/sync.<span class="org-variable-name">md</span>:558
#2  0x0000000000d017d6 <span class="org-keyword">in</span> make_prologue_seq () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:5801
#3  0x0000000000d01d8b <span class="org-keyword">in</span> thread_prologue_and_epilogue_insns () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6019
#4  0x0000000000d02cbb <span class="org-keyword">in</span> rest_of_handle_thread_prologue_and_epilogue () at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6510
#5  0x0000000000d02ecf <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_thread_prologue_and_epilogue</span>::execute (this=0x23416c0) at ../.././riscv-gcc/gcc/function.<span class="org-variable-name">c</span>:6586
#6  0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x23416c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#7  0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x23416c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#8  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2341480) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#9  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2340220) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#10 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#11 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#12 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#13 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#14 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#15 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#16 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#17 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#18 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#19 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000070" class="outline-4">
<h4 id="org0000070"><span class="section-number-4">1.4.4</span> pass_final</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
生成汇编
</p>
</div>
</div>
</div>

<div id="outline-container-org000008c" class="outline-3">
<h3 id="org000008c"><span class="section-number-3">1.5</span> example</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">float</span> <span class="org-function-name">foo</span>(<span class="org-type">float</span> <span class="org-variable-name">x</span>) {
    <span class="org-keyword">if</span> (x &gt; 0.0) {
        <span class="org-keyword">return</span> x + 1.0;
    }
    <span class="org-keyword">return</span> 0.0;
}
</pre>
</div>
</div>

<div id="outline-container-org000007d" class="outline-4">
<h4 id="org000007d"><span class="section-number-4">1.5.1</span> gimple to rtl</h4>
<div class="outline-text-4" id="text-1-5-1">
</div>
<div id="outline-container-org000006d" class="outline-5">
<h5 id="org000006d"><span class="section-number-5">1.5.1.1</span> overview</h5>
<div class="outline-text-5" id="text-1-5-1-1">
<p>
rtl 的 `pass_expand` 用来把 gimple 转换为 rtl, 以 `两个浮点数相加` 为例:
</p>

<ol class="org-ol">
<li>add 对应的 gimple tree code 为 PLUS_EXPR, 定义在 tree.def 中</li>

<li>通过 `optab_for_tree_code` 查找 optab, PLUS_EXPR 对应的 optab 为 add_optab,
定义在 optabs.def. PLUS_EXPR 与 add_optab 的对应关系是预设好的.</li>

<li>通过 `optab_handler` 查找 add_optab 和 E_SFmode 对应的 insn_code 为
CODE_FOR_addsf3, 定义在 md 中, 由 gencodes 扫描 md 生成. add_optab 与
CODE_FOR_addsf3 的对应关系由 genopinit 根据 optabs.def 生成
(gen_insn@genopinit.c). 所以 <code>md 中需要定义哪些 insn 是由 optab 决定的</code>.</li>

<li>用 insn_code 做索引在 insn_data 中查找到 `gen_addsf3` 函数. insn_data 由
genoutput 扫描 md 生成. gen_addsf3 由 genemit 生成</li>

<li>gen_addsf3 生成 addsf3 对应的 rtl expression</li>

<li>rtl.def 定义了 rtl expression 使用的 expression code, 例如 SET, PLUS, &#x2026;</li>
</ol>
</div>

<div id="outline-container-org000006b" class="outline-6">
<h6 id="org000006b"><span class="section-number-6">1.5.1.1.1</span> backtrace</h6>
<div class="outline-text-6" id="text-1-5-1-1-1">
<div class="org-src-container">
<pre class="src src-rust">#0  gen_addsf3 (operand0=0x7fffffffb250, operand1=0x7ffff7786bb8, 
    operand2=0xf8360d &lt;maybe_legitimize_operands(insn_code, unsigned int, unsigned int, expand_operand*)+46&gt;) at insn-emit.<span class="org-variable-name">c</span>:45
#1  0x0000000000ef17fa <span class="org-keyword">in</span> <span class="org-constant">insn_gen_fn</span>::operator()&lt;rtx_def*, rtx_def*, rtx_def*&gt; (this=0x1ecacb8 &lt;insn_data+56&gt;) at ../.././riscv-gcc/gcc/recog.<span class="org-variable-name">h</span>:407
#2  0x0000000000f83a1e <span class="org-keyword">in</span> maybe_gen_insn (icode=CODE_FOR_addsf3, nops=3, ops=0x7fffffffb250) at ../.././riscv-gcc/gcc/optabs.<span class="org-variable-name">c</span>:7787
#3  0x0000000000f6ef4a <span class="org-keyword">in</span> expand_binop_directly (icode=CODE_FOR_addsf3, mode=E_SFmode, binoptab=add_optab, op0=0x7ffff7786be8, op1=0x7ffff7786c18, 
    target=0x7ffff7786bb8, unsignedp=0, methods=OPTAB_LIB_WIDEN, last=0x7ffff7676540) at ../.././riscv-gcc/gcc/optabs.<span class="org-variable-name">c</span>:1409
#4  0x0000000000f6f417 <span class="org-keyword">in</span> expand_binop (mode=E_SFmode, binoptab=add_optab, op0=0x7ffff7786be8, op1=0x7ffff7786c18, target=0x7ffff7786bb8, unsignedp=0, 
    methods=OPTAB_LIB_WIDEN) at ../.././riscv-gcc/gcc/optabs.<span class="org-variable-name">c</span>:1496
#5  0x0000000000c9079a <span class="org-keyword">in</span> expand_expr_real_2 (ops=0x7fffffffbb80, target=0x7ffff7786bb8, tmode=E_SFmode, modifier=EXPAND_NORMAL)
    at ../.././riscv-gcc/gcc/expr.<span class="org-variable-name">c</span>:10007
#6  0x0000000000b197f4 <span class="org-keyword">in</span> expand_gimple_stmt_1 (stmt=0x7ffff7784000) at ../.././riscv-gcc/gcc/cfgexpand.<span class="org-variable-name">c</span>:3947
#7  0x0000000000b199f1 <span class="org-keyword">in</span> expand_gimple_stmt (stmt=0x7ffff7784000) at ../.././riscv-gcc/gcc/cfgexpand.<span class="org-variable-name">c</span>:4008
#8  0x0000000000b20b17 <span class="org-keyword">in</span> expand_gimple_basic_block (bb=0x7ffff7761138, disable_tail_calls=false) at ../.././riscv-gcc/gcc/cfgexpand.<span class="org-variable-name">c</span>:6045
#9  0x0000000000b223d3 <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_expand</span>::execute (this=0x23401c0, fun=0x7ffff777e000) at ../.././riscv-gcc/gcc/cfgexpand.<span class="org-variable-name">c</span>:6729
#10 0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x23401c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#11 0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x23401c0) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#12 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#13 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#14 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#15 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#16 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#17 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#18 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#19 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#20 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#21 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000071" class="outline-5">
<h5 id="org0000071"><span class="section-number-5">1.5.1.2</span> gimple code</h5>
<div class="outline-text-5" id="text-1-5-1-2">
<pre class="example" id="org0000071">
float foo (float x)
{ 
  float D.1491;
  float _1;
  float _3;
  float _4;

  &lt;bb 2&gt; :
  if (x_2(D) &gt; 0.0)
    goto &lt;bb 3&gt;; [INV]
  else
    goto &lt;bb 4&gt;; [INV]

  &lt;bb 3&gt; :
  _4 = x_2(D) + 1.0e+0;
  // predicted unlikely by early return (on trees) predictor.
  goto &lt;bb 5&gt;; [INV]

  &lt;bb 4&gt; :
  _3 = 0.0;

  &lt;bb 5&gt; :
  # _1 = PHI &lt;_4(3), _3(4)&gt;
&lt;L2&gt;:
  return _1;


</pre>
</div>
</div>

<div id="outline-container-org0000074" class="outline-5">
<h5 id="org0000074"><span class="section-number-5">1.5.1.3</span> bb2</h5>
<div class="outline-text-5" id="text-1-5-1-3">
<p>
bb2 的第一个 stmt `if (x_2(D) &gt; 0.0)` 的处理过程:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-function-name">expand_gimple_basic_block</span>()
    <span class="org-keyword">if</span> (gimple_code (stmt) == GIMPLE_COND):
        new_bb = expand_gimple_cond (bb, as_a &lt;gcond *&gt; (stmt));

<span class="org-constant">expand_gimple_cond</span>:
   <span class="org-comment-delimiter">/* </span><span class="org-comment">tree code &#20026; GT_EXPR, &#23450;&#20041;&#22312; tree.def</span><span class="org-comment-delimiter"> */</span>
    code = gimple_cond_code (stmt);
    <span class="org-keyword">if</span> (true_edge-&gt;dest == bb-&gt;next_bb):
        jumpifnot_1 (code, op0, op1, label_rtx_for_bb (false_edge-&gt;dest), false_edge-&gt;probability);

<span class="org-constant">label_rtx_for_bb</span>:
    <span class="org-type">rtx_code_label</span> *<span class="org-variable-name">l</span> = gen_label_rtx ();
        <span class="org-comment-delimiter">/* </span><span class="org-comment">gen_rtx_CODE_LABEL &#29983;&#25104;&#19968;&#20010; `code_label` rtx</span><span class="org-comment-delimiter"> */</span>
        <span class="org-keyword">return</span> as_a &lt;rtx_code_label *&gt; (gen_rtx_CODE_LABEL (VOIDmode, NULL_RTX, NULL_RTX,<span class="org-constant">NULL</span>, label_num++, <span class="org-constant">NULL</span>));

<span class="org-constant">jumpifnot_1</span>:
    <span class="org-comment-delimiter">/* </span><span class="org-comment">code &#20026; GT</span><span class="org-comment-delimiter"> */</span>
    <span class="org-function-name">do_compare_rtx_and_jump</span> (op0, op1, code, unsignedp, mode,((mode == BLKmode) ? expr_size (treeop0) : NULL_RTX),
               if_false_label, if_true_label, prob);
        <span class="org-function-name">emit_cmp_and_jump_insns</span> (op0, op1, code, size, mode, unsignedp, if_true_label, prob);
            <span class="org-function-name">prepare_cmp_insn</span> (op0, op1, comparison, size, unsignedp, OPTAB_LIB_WIDEN, &amp;test, &amp;mode);
                <span class="org-keyword">enum</span> <span class="org-type">insn_code</span> <span class="org-variable-name">icode</span>;
                <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: GT_EXPR &#26144;&#23556;&#21040; cbranch_optab, &#21518;&#32773;&#21448;&#26144;&#23556;&#20026; CODE_FOR_cbranchsf4</span><span class="org-comment-delimiter"> */</span>
                icode = optab_handler (cbranch_optab, cmp_mode);
                <span class="org-type">rtx</span> <span class="org-variable-name">op0</span> = prepare_operand (icode, x, 1, mode, cmp_mode, unsignedp);
                <span class="org-type">rtx</span> <span class="org-variable-name">op1</span> = prepare_operand (icode, y, 2, mode, cmp_mode, unsignedp);
                <span class="org-function-name">XEXP</span> (test, 0) = op0;
                <span class="org-function-name">XEXP</span> (test, 1) = op1;
                <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: test &#26159;&#35201;&#36820;&#22238;&#30340; rtx</span><span class="org-comment-delimiter">  */</span>
                *ptest = test;
        <span class="org-type">emit_cmp_and_jump_insn_1</span>
            <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: GEN_FCN(icode) &#21363; gen_cbranchsf4</span><span class="org-comment-delimiter"> */</span>
            <span class="org-variable-name">insn</span> = emit_jump_insn (GEN_FCN (icode) (test, XEXP (test, 0), XEXP (test, 1), label));        
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000077" class="outline-5">
<h5 id="org0000077"><span class="section-number-5">1.5.1.4</span> bb3</h5>
<div class="outline-text-5" id="text-1-5-1-4">
<p>
bb3 的第一个 stmt `_4 = x_2(D) + 1.0e+0` 的处理过程:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-constant">expand_gimple_basic_block</span>:
    <span class="org-function-name">expand_gimple_stmt</span>(stmt);
       <span class="org-comment-delimiter">/* </span><span class="org-comment">stmt-&gt;code &#20026; GIMPLE_ASSIGN, stmt-&gt;subcode (tree code) &#20026; PLUS_EXPR</span><span class="org-comment-delimiter"> */</span>
       <span class="org-comment-delimiter">/* </span><span class="org-comment">target &#26159;&#38656;&#35201;&#34987; assign &#30340; rtx (&#20363;&#22914; reg)</span><span class="org-comment-delimiter"> */</span>
       temp = expand_expr_real_2 (&amp;ops, target, GET_MODE (target), EXPAND_NORMAL);
           <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: code &#20026; PLUS_EXPR, &#36820;&#22238;&#30340; this_optab &#20026; add_optab</span><span class="org-comment-delimiter"> */</span>
           this_optab = optab_for_tree_code (code, type, optab_default);
           <span class="org-comment-delimiter">/* </span><span class="org-comment">mode &#20026; E_SFmode</span><span class="org-comment-delimiter"> */</span>
           temp = expand_binop (mode, this_optab, op0, op1, target, unsignedp, OPTAB_LIB_WIDEN);
               <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: icode &#20026; CODE_FOR_addsf3</span><span class="org-comment-delimiter"> */</span>
               icode = optab_handler (binoptab, mode);
               create_output_operand (&amp;ops[0], target, tmp_mode);
               create_input_operand (&amp;ops[1], xop0, mode0);
               create_input_operand (&amp;ops[2], xop1, mode1);
               pat = maybe_gen_insn (icode, 3, ops);
                   <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: &#29983;&#25104; rtx</span><span class="org-comment-delimiter"> */</span>
                   <span class="org-function-name">gen_addsf3</span>(); 
</pre>
</div>
</div>
</div>

<div id="outline-container-org000007a" class="outline-5">
<h5 id="org000007a"><span class="section-number-5">1.5.1.5</span> bb4</h5>
<div class="outline-text-5" id="text-1-5-1-5">
<p>
bb4 的第一个 stmt `_3 = 0.0` 的处理过程:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-constant">expand_gimple_stmt</span>:
    <span class="org-comment-delimiter">/* </span><span class="org-comment">stmt-&gt;code &#20026; GIMPLE_ASSIGN, stmt-&gt;subcode &#20026; REAL_CST (real constant)</span><span class="org-comment-delimiter"> */</span>
    <span class="org-function-name">expand_assignment</span> (lhs, rhs, ...)
      result = store_expr (from, to_rtx, 0, nontemporal, <span class="org-constant">false</span>);
          <span class="org-function-name">emit_move_insn</span> (target, temp);
              <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: mov_optab &#23545;&#24212; CODE_FOR_movsf</span><span class="org-comment-delimiter"> */</span>
              code = optab_handler (mov_optab, mode);
              <span class="org-comment-delimiter">/* </span><span class="org-comment">NOTE: gen_movesf</span><span class="org-comment-delimiter"> */</span>
              <span class="org-function-name">emit_insn</span> (<span class="org-type">GEN_FCN</span> (<span class="org-function-name">code</span>) (x, y));


</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000001c" class="outline-4">
<h4 id="org000001c"><span class="section-number-4">1.5.2</span> rtl to assembly</h4>
<div class="outline-text-4" id="text-1-5-2">
</div>
<div id="outline-container-org0000083" class="outline-5">
<h5 id="org0000083"><span class="section-number-5">1.5.2.1</span> overview</h5>
<div class="outline-text-5" id="text-1-5-2-1">
<p>
rtl 通过一些 rtl pass 后最终由 rtl 的 `pass_final` 生成 assembly
</p>

<ol class="org-ol">
<li>通过 recog 函数查找 rtx_insn 对应的 insn_code. recog 由 genrecog 扫描 md 生成.
整个 recog 相当于一个根据 md 生成的巨大的 switch-case</li>

<li>通过 `get_insn_template` 从 insn_data 以 insn_code 为索引查找 assembly template</li>
</ol>
</div>

<div id="outline-container-org0000080" class="outline-6">
<h6 id="org0000080"><span class="section-number-6">1.5.2.1.1</span> backtrace</h6>
<div class="outline-text-6" id="text-1-5-2-1-1">
<div class="org-src-container">
<pre class="src src-rust">#0  get_insn_template (code=0, insn=0x7fffffffbc00) at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:2063
#1  0x0000000000ca46cb <span class="org-keyword">in</span> final_scan_insn_1 (insn=0x7ffff7676880, file=0x2352480, optimize_p=0, nopeepholes=0, seen=0x7fffffffbdbc)
    at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:3062
#2  0x0000000000ca4b06 <span class="org-keyword">in</span> final_scan_insn (insn=0x7ffff7676880, file=0x2352480, optimize_p=0, nopeepholes=0, seen=0x7fffffffbdbc)
    at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:3175
#3  0x0000000000ca2a44 <span class="org-keyword">in</span> final_1 (first=0x7ffff77870a8, file=0x2352480, seen=0, optimize_p=0) at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:2022
#4  0x0000000000ca76c5 <span class="org-keyword">in</span> rest_of_handle_final () at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:4680
#5  0x0000000000ca792f <span class="org-keyword">in</span> (anonymous namespace)::<span class="org-constant">pass_final</span>::execute (this=0x2342260) at ../.././riscv-gcc/gcc/final.<span class="org-variable-name">c</span>:4758
#6  0x0000000000fdd7d1 <span class="org-keyword">in</span> execute_one_pass (pass=0x2342260) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2567
#7  0x0000000000fddb1e <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2342260) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2656
#8  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2341d80) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#9  0x0000000000fddb4f <span class="org-keyword">in</span> execute_pass_list_1 (pass=0x2340220) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2657
#10 0x0000000000fddbab <span class="org-keyword">in</span> execute_pass_list (fn=0x7ffff777e000, pass=0x233c270) at ../.././riscv-gcc/gcc/passes.<span class="org-variable-name">c</span>:2667
#11 0x0000000000b6f617 <span class="org-keyword">in</span> <span class="org-constant">cgraph_node</span>::expand (this=0x7ffff7780000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:1830
#12 0x0000000000b6fd15 <span class="org-keyword">in</span> <span class="org-constant">cgraph_order_sort</span>::process (this=0x2333788) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2069
#13 0x0000000000b6ffce <span class="org-keyword">in</span> output_in_order () at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2137
#14 0x0000000000b705a6 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::compile (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2355
#15 0x0000000000b709d2 <span class="org-keyword">in</span> <span class="org-constant">symbol_table</span>::finalize_compilation_unit (this=0x7ffff7670000) at ../.././riscv-gcc/gcc/cgraphunit.<span class="org-variable-name">c</span>:2539
#16 0x000000000110d05f <span class="org-keyword">in</span> compile_file () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:482
#17 0x00000000011100c6 <span class="org-keyword">in</span> do_compile () at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2201
#18 0x00000000011103e8 <span class="org-keyword">in</span> <span class="org-constant">toplev</span>::main (this=0x7fffffffc176, argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/toplev.<span class="org-variable-name">c</span>:2340
#19 0x0000000001bf4bf5 <span class="org-keyword">in</span> main (argc=14, argv=0x7fffffffc288) at ../.././riscv-gcc/gcc/main.<span class="org-variable-name">c</span>:39
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000086" class="outline-5">
<h5 id="org0000086"><span class="section-number-5">1.5.2.2</span> final_scan_insn_1</h5>
<div class="outline-text-5" id="text-1-5-2-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-constant">final_scan_insn_1</span>:
    <span class="org-comment-delimiter">/* </span><span class="org-comment">insn code &#22312; rtl.def &#20013;&#23450;&#20041;</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">switch</span> (GET_CODE (insn)):
        <span class="org-keyword">case</span> CODE_LABEL:
            <span class="org-comment-delimiter">/* </span><span class="org-comment">internal_label &#25351;&#21521; default_internal_label, &#20135;&#29983; .L6: &#24418;&#24335;&#30340; label</span><span class="org-comment-delimiter"> */</span>
            targetm.asm_out.internal_label (file, <span class="org-string">"L"</span>, CODE_LABEL_NUMBER (insn));
                <span class="org-type">char</span> *<span class="org-keyword">const</span> <span class="org-variable-name">buf</span> = (<span class="org-type">char</span> *) alloca (40 + strlen (prefix));
                <span class="org-function-name">ASM_GENERATE_INTERNAL_LABEL</span> (buf, prefix, labelno);
                <span class="org-function-name">ASM_OUTPUT_INTERNAL_LABEL</span> (stream, buf);

        <span class="org-keyword">default</span>:
            insn_code_number = recog_memoized (insn);
            templ = get_insn_template (insn_code_number, insn);
            <span class="org-function-name">output_asm_insn</span> (templ, recog_data.operand);
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-03-24 Thu 12:17<br />
Last updated: 2022-03-31 Thu 17:45</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
