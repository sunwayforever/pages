<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 12:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CNN</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">CNN</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org45a3795">1. CNN</a>
<ul>
<li><a href="#org9660fa3">1.1. Conv1D</a></li>
<li><a href="#orga0b7c4c">1.2. Conv2D</a></li>
<li><a href="#org8161614">1.3. stride</a></li>
<li><a href="#org8d59d7a">1.4. padding</a></li>
<li><a href="#orgb5fdb8c">1.5. How To Calculate FLOPs</a></li>
<li><a href="#org9bad9bb">1.6. Dynamic Shaped Network</a></li>
<li><a href="#orgc55332e">1.7. 1x1 conv2d</a></li>
<li><a href="#orgf261fdf">1.8. 3x3 vs. 5x5</a></li>
<li><a href="#orgb2f70c6">1.9. Deconv2D</a>
<ul>
<li><a href="#org51e95c7">1.9.1. 通过加 padding 和 dilation 转换为 Conv2D</a></li>
<li><a href="#orgea418dd">1.9.2. 通过 gemm+col2im</a></li>
</ul>
</li>
<li><a href="#org459fcab">1.10. SeparatableConv2D / DepthwiseConv2D</a></li>
<li><a href="#org22a9ecb">1.11. Implementation</a>
<ul>
<li><a href="#org8fd52a4">1.11.1. Trivial</a></li>
<li><a href="#org2ce7229">1.11.2. im2col</a></li>
<li><a href="#org4103280">1.11.3. <span class="done DONE">DONE</span> winograd</a></li>
</ul>
</li>
<li><a href="#orgff86b70">1.12. Lenet</a>
<ul>
<li><a href="#orgf4ff66f">1.12.1. conv layer</a></li>
<li><a href="#orgee88119">1.12.2. pooling layer</a></li>
<li><a href="#org7607adc">1.12.3. why convolutions?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org45a3795" class="outline-2">
<h2 id="org45a3795"><span class="section-number-2">1</span> CNN</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9660fa3" class="outline-3">
<h3 id="org9660fa3"><span class="section-number-3">1.1</span> Conv1D</h3>
<div class="outline-text-3" id="text-1-1">

<div id="org044e912" class="figure">
<p><img src="../extra/conv1.png" alt="conv1.png" />
</p>
<p><span class="figure-number">Figure 1: </span>conv</p>
</div>
</div>
</div>

<div id="outline-container-orga0b7c4c" class="outline-3">
<h3 id="orga0b7c4c"><span class="section-number-3">1.2</span> Conv2D</h3>
<div class="outline-text-3" id="text-1-2">

<div id="org57201ed" class="figure">
<p><img src="../extra/conv2.png" alt="conv2.png" />
</p>
<p><span class="figure-number">Figure 2: </span>conv2</p>
</div>

<p>
kernel=[0,1,2; 2,2,0; 0,1,2] <img src="../extra/conv_ani.gif" alt="conv_ani.gif" />
</p>
</div>
</div>

<div id="outline-container-org8161614" class="outline-3">
<h3 id="org8161614"><span class="section-number-3">1.3</span> stride</h3>
</div>

<div id="outline-container-org8d59d7a" class="outline-3">
<h3 id="org8d59d7a"><span class="section-number-3">1.4</span> padding</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>W original size</li>
<li>F kernel size</li>
<li>S stride</li>
<li>O output size</li>
<li>P padding</li>
</ul>

<p>
\(O=\frac{W+2*P-F}{S}+1\)
</p>

<p>
若考虑 dilation 参数:
</p>

<ul class="org-ul">
<li>D dilation, 默认为 1</li>
</ul>

<p>
\(O=\frac{W+2*P-(D*(F-1)+1)}{S}+1\)
</p>

<p>
其中 \(D*(F-1)+1\) 相当于膨胀后的 kernel 大小
</p>


<div id="orgb384de5" class="figure">
<p><img src="../extra/conv_padding.gif" alt="conv_padding.gif" />
</p>
<p><span class="figure-number">Figure 3: </span>padding</p>
</div>

<ul class="org-ul">
<li><p>
valid padding
</p>

<p>
当 padding = valid 时, input 中无法对齐的部分被丢弃
</p></li>

<li><p>
same padding
</p>

<p>
当 padding = same 时, input 中无法对齐时会在前后补 0 
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> tensorflow
<span style="color: #859900;">import</span> tensorflow <span style="color: #859900;">as</span> tf
<span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">from</span> tensorflow.keras <span style="color: #859900;">import</span> layers

<span style="color: #268bd2;">x</span> = np.random.normal<span style="color: #757575;">(</span>size=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 15<span style="color: #757575;">,</span> 1<span style="color: #757575;">))</span>.astype<span style="color: #757575;">(</span><span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
<span style="color: #268bd2;">y</span> = layers.Conv1D<span style="color: #757575;">(</span>filters = 1<span style="color: #757575;">,</span> kernel_size = 10<span style="color: #757575;">,</span> strides = 3<span style="color: #757575;">,</span> padding = <span style="color: #2aa198;">"same"</span><span style="color: #757575;">)(</span>x<span style="color: #757575;">)</span>
<span style="color: #268bd2;">y2</span> = layers.Conv1D<span style="color: #757575;">(</span>filters = 1<span style="color: #757575;">,</span> kernel_size = 15<span style="color: #757575;">,</span> strides = 3<span style="color: #757575;">,</span> padding = <span style="color: #2aa198;">"same"</span><span style="color: #757575;">)(</span>x<span style="color: #757575;">)</span>
<span style="color: #268bd2;">y3</span> = layers.Conv1D<span style="color: #757575;">(</span>filters = 1<span style="color: #757575;">,</span> kernel_size = 10<span style="color: #757575;">,</span> strides = 3<span style="color: #757575;">,</span> padding = <span style="color: #2aa198;">"valid"</span><span style="color: #757575;">)(</span>x<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>x.shape<span style="color: #757575;">,</span>y.shape<span style="color: #757575;">,</span>y2.shape<span style="color: #757575;">,</span>y3.shape<span style="color: #757575;">)</span>
</pre>
</div>

<p>
(1, 15, 1) (1, 5, 1) (1, 5, 1) (1, 2, 1)
</p>

<p>
当 padding=same 时,  \(O=floor(\frac{W}{S})\), <span class="underline">与 kernel 无关</span>. 特别的, 当 S = 1 时, O == W, 这也是 SAME 名字的由来
</p>

<p>
当 padding=valid 时, \(O=(W - F)//S + 1\)
</p>

<p>
所以使用 same 能更容易的控制 conv 的 output shape
</p>
</div>
</div>

<div id="outline-container-orgb5fdb8c" class="outline-3">
<h3 id="orgb5fdb8c"><span class="section-number-3">1.5</span> <a href="nn_benchmark.html#org4988983">How To Calculate FLOPs</a></h3>
</div>

<div id="outline-container-org9bad9bb" class="outline-3">
<h3 id="org9bad9bb"><span class="section-number-3">1.6</span> <a href="dynamic_shaped_network.html#org87e6738">Dynamic Shaped Network</a></h3>
</div>

<div id="outline-container-orgc55332e" class="outline-3">
<h3 id="orgc55332e"><span class="section-number-3">1.7</span> 1x1 conv2d</h3>
</div>

<div id="outline-container-orgf261fdf" class="outline-3">
<h3 id="orgf261fdf"><span class="section-number-3">1.8</span> 3x3 vs. 5x5</h3>
</div>

<div id="outline-container-orgb2f70c6" class="outline-3">
<h3 id="orgb2f70c6"><span class="section-number-3">1.9</span> Deconv2D</h3>
<div class="outline-text-3" id="text-1-9">
<p>
Deconv2D 有两种等价的计算方法:
</p>
</div>

<div id="outline-container-org51e95c7" class="outline-4">
<h4 id="org51e95c7"><span class="section-number-4">1.9.1</span> 通过加 padding 和 dilation 转换为 Conv2D</h4>
<div class="outline-text-4" id="text-1-9-1">
<p>
<a href="https://datascience.stackexchange.com/questions/6107/what-are-deconvolutional-layers">https://datascience.stackexchange.com/questions/6107/what-are-deconvolutional-layers</a>
</p>
</div>
</div>

<div id="outline-container-orgea418dd" class="outline-4">
<h4 id="orgea418dd"><span class="section-number-4">1.9.2</span> 通过 gemm+col2im</h4>
<div class="outline-text-4" id="text-1-9-2">
<p>
<a href="https://bbs.cvmart.net/articles/1755">https://bbs.cvmart.net/articles/1755</a>
假设:
</p>

<ol class="org-ol">
<li>output 的 shape 为 \(C_{out}*H_{out}*W_{out}\)</li>
<li>W 的 shape 为 \(C_{out}*C_{in}*K_h*W_h\)</li>
<li>input 为 \(Cin*Hin*Win\)</li>
</ol>

<p>
计算 Conv2D 的过程为:
</p>

<ol class="org-ol">
<li>input 通过 im2col 转换为 \((C_{in}*K_h*K_w)*H_{out}*W_{out}\)</li>
<li>\(W = C_{out}*(C_{in}*K_h*K_w) \implies output = W * input = C_{out}*H_{out}*W_{out}\)</li>
</ol>

<p>
计算 Deconv2D 的过程为:
</p>

<ol class="org-ol">
<li>\(W^T = C_{out}*(K_h*W_h)*C_{in}\)</li>
<li>\(output = W^T * input = C_{out}*(K_h*W_h)*H_{in}*W_{in}\)</li>
<li>通过 col2im 填充输出为 \(C_{out}*H_{out}*W_{out}\)</li>
</ol>

<p>
我觉得可以这样直观的理解一下 gemm+col2im 的方式:
</p>

<p>
conv 本质上是把长度为 k 的 block 变成一个点, 实际就是一个 matmul((x,k),(k,1))
</p>

<p>
deconv 需要把这一个点再变回长度为 k 的 block, 那么做一个 matmul((x,1),(1,k)) 就可以了&#x2026;
</p>

<p>
(k,1) 是 conv kernel, (1,k) 是 deconv kernel, 所以 deconv 也叫 conv_transposed
</p>
</div>
</div>
</div>

<div id="outline-container-org459fcab" class="outline-3">
<h3 id="org459fcab"><span class="section-number-3">1.10</span> SeparatableConv2D / DepthwiseConv2D</h3>
</div>

<div id="outline-container-org22a9ecb" class="outline-3">
<h3 id="org22a9ecb"><span class="section-number-3">1.11</span> Implementation</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-org8fd52a4" class="outline-4">
<h4 id="org8fd52a4"><span class="section-number-4">1.11.1</span> Trivial</h4>
<div class="outline-text-4" id="text-1-11-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> matplotlib.pyplot <span style="color: #859900;">as</span> plt
<span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np

<span style="color: #859900;">from</span> skimage <span style="color: #859900;">import</span> io<span style="color: #757575;">,</span> color
<span style="color: #859900;">import</span> scipy.signal

<span style="color: #859900;">def</span> <span style="color: #268bd2;">convolve2d</span><span style="color: #757575;">(</span>image<span style="color: #757575;">,</span> kernel<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">kernel</span> = np.flipud<span style="color: #757575;">(</span>np.fliplr<span style="color: #757575;">(</span>kernel<span style="color: #757575;">))</span>   
    <span style="color: #268bd2;">output</span> = np.zeros_like<span style="color: #757575;">(</span>image<span style="color: #757575;">)</span>    
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Add zero padding to the input image</span>
    <span style="color: #268bd2;">padding</span>=kernel.shape[0]-1
    <span style="color: #859900;">if</span> padding%2!=0:
        <span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"error zero_padding"</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">offset</span>=padding//2
    <span style="color: #268bd2;">image_padded</span> = np.zeros<span style="color: #757575;">((</span>image.shape[0] + padding<span style="color: #757575;">,</span> image.shape[1] + padding<span style="color: #757575;">))</span>  
    <span style="color: #268bd2;">image_padded</span>[offset:-offset<span style="color: #757575;">,</span> offset:-offset] = image
    <span style="color: #859900;">for</span> x <span style="color: #859900;">in</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>image.shape[1]<span style="color: #757575;">)</span>:  
        <span style="color: #859900;">for</span> y <span style="color: #859900;">in</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>image.shape[0]<span style="color: #757575;">)</span>:
            <span style="color: #268bd2;">output</span>[y<span style="color: #757575;">,</span>x]=<span style="color: #757575;">(</span>kernel*image_padded[y:y+kernel.shape[0]<span style="color: #757575;">,</span>x:x+kernel.shape[0]]<span style="color: #757575;">)</span>.<span style="color: #839496;">sum</span><span style="color: #757575;">()</span>        
    <span style="color: #859900;">return</span> output

<span style="color: #859900;">def</span> <span style="color: #268bd2;">show_result</span><span style="color: #757575;">(</span>img<span style="color: #757575;">,</span>title<span style="color: #757575;">)</span>:
    <span style="color: #859900;">global</span> orig_image

    <span style="color: #268bd2;">ax1</span>=plt.subplot<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span>2<span style="color: #757575;">,</span>1<span style="color: #757575;">)</span>
    ax1.imshow<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">,</span> cmap=plt.cm.gray<span style="color: #757575;">)</span>
    ax1.axis<span style="color: #757575;">(</span><span style="color: #2aa198;">"off"</span><span style="color: #757575;">)</span>

    <span style="color: #268bd2;">image_sharpen</span> = img
    <span style="color: #268bd2;">ax2</span>=plt.subplot<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span>2<span style="color: #757575;">,</span>2<span style="color: #757575;">)</span>
    ax2.imshow<span style="color: #757575;">(</span>image_sharpen<span style="color: #757575;">,</span> cmap=plt.cm.gray<span style="color: #757575;">)</span>
    ax2.axis<span style="color: #757575;">(</span><span style="color: #2aa198;">"off"</span><span style="color: #757575;">)</span>
    plt.title<span style="color: #757575;">(</span>title<span style="color: #757575;">)</span>
    plt.show<span style="color: #757575;">()</span>

<span style="color: #268bd2;">orig_image</span> = io.imread<span style="color: #757575;">(</span><span style="color: #2aa198;">'../extra/image.png'</span><span style="color: #757575;">)</span> 
<span style="color: #268bd2;">orig_image</span> = color.rgb2gray<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">)</span>
<span style="color: #268bd2;">kernel_sharpen</span>=np.array<span style="color: #757575;">(</span>[[0<span style="color: #757575;">,</span>-1<span style="color: #757575;">,</span>0]<span style="color: #757575;">,</span>[-1<span style="color: #757575;">,</span>5<span style="color: #757575;">,</span>-1]<span style="color: #757575;">,</span>[0<span style="color: #757575;">,</span>-1<span style="color: #757575;">,</span>0]]<span style="color: #757575;">)</span>
<span style="color: #268bd2;">kernel_edge</span>=np.array<span style="color: #757575;">(</span>[[-1<span style="color: #757575;">,</span>-1<span style="color: #757575;">,</span>-1]<span style="color: #757575;">,</span>[-1<span style="color: #757575;">,</span>8<span style="color: #757575;">,</span>-1]<span style="color: #757575;">,</span>[-1<span style="color: #757575;">,</span>-1<span style="color: #757575;">,</span>-1]]<span style="color: #757575;">)</span>

show_result<span style="color: #757575;">(</span>convolve2d<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">,</span>kernel_sharpen<span style="color: #757575;">),</span><span style="color: #2aa198;">"sharpen"</span><span style="color: #757575;">)</span>    
show_result<span style="color: #757575;">(</span>convolve2d<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">,</span>kernel_edge<span style="color: #757575;">),</span><span style="color: #2aa198;">"edge detection"</span><span style="color: #757575;">)</span>    
</pre>
</div>


<div id="org3cc6566" class="figure">
<p><img src="convnets_files/convnets_11_0.png" alt="convnets_11_0.png" />
</p>
<p><span class="figure-number">Figure 4: </span>png</p>
</div>


<div id="orgfeed4c2" class="figure">
<p><img src="convnets_files/convnets_11_1.png" alt="convnets_11_1.png" />
</p>
<p><span class="figure-number">Figure 5: </span>png</p>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">m</span>=np.array<span style="color: #757575;">(</span>[[1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>1]<span style="color: #757575;">,</span>[1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>]<span style="color: #757575;">,</span>[1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>1]]<span style="color: #757575;">)</span>
<span style="color: #268bd2;">kernel</span>=np.array<span style="color: #757575;">(</span>[[0<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>0]<span style="color: #757575;">,</span>[0<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>0]<span style="color: #757575;">,</span>[0<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>0]]<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>m<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>kernel<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>convolve2d<span style="color: #757575;">(</span>m<span style="color: #757575;">,</span>kernel<span style="color: #757575;">))</span>
</pre>
</div>

<pre class="example" id="org7edc9be">
[[1 1 1]
 [1 1 1]
 [1 1 1]]
[[0 1 0]
 [0 1 0]
 [0 1 0]]
[[2 2 2]
 [3 3 3]
 [2 2 2]]
</pre>
</div>
</div>

<div id="outline-container-org2ce7229" class="outline-4">
<h4 id="org2ce7229"><span class="section-number-4">1.11.2</span> im2col</h4>
<div class="outline-text-4" id="text-1-11-2">
<p>
卷积操作实际上可以转换为普通的矩阵乘法
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_im2col_indices</span><span style="color: #757575;">(</span>x_shape<span style="color: #757575;">,</span> field_height<span style="color: #757575;">,</span> field_width<span style="color: #757575;">,</span> padding=1<span style="color: #757575;">,</span> stride=1<span style="color: #757575;">)</span>:
  <span style="color: #586e75;"># </span><span style="color: #586e75;">First figure out what the size of the output should be</span>
  <span style="color: #268bd2;">N</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">C</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">H</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">W</span> = x_shape
  <span style="color: #859900;">assert</span> <span style="color: #757575;">(</span>H + 2 * padding - field_height<span style="color: #757575;">)</span> % stride == 0
  <span style="color: #859900;">assert</span> <span style="color: #757575;">(</span>W + 2 * padding - field_height<span style="color: #757575;">)</span> % stride == 0
  <span style="color: #268bd2;">out_height</span> = <span style="color: #757575;">(</span>H + 2 * padding - field_height<span style="color: #757575;">)</span> // stride + 1
  <span style="color: #268bd2;">out_width</span> = <span style="color: #757575;">(</span>W + 2 * padding - field_width<span style="color: #757575;">)</span> // stride + 1

  <span style="color: #268bd2;">i0</span> = np.repeat<span style="color: #757575;">(</span>np.arange<span style="color: #757575;">(</span>field_height<span style="color: #757575;">),</span> field_width<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">i0</span> = np.tile<span style="color: #757575;">(</span>i0<span style="color: #757575;">,</span> C<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">i1</span> = stride * np.repeat<span style="color: #757575;">(</span>np.arange<span style="color: #757575;">(</span>out_height<span style="color: #757575;">),</span> out_width<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">j0</span> = np.tile<span style="color: #757575;">(</span>np.arange<span style="color: #757575;">(</span>field_width<span style="color: #757575;">),</span> field_height * C<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">j1</span> = stride * np.tile<span style="color: #757575;">(</span>np.arange<span style="color: #757575;">(</span>out_width<span style="color: #757575;">),</span> out_height<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">i</span> = i0.reshape<span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span> + i1.reshape<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> -1<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">j</span> = j0.reshape<span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span> + j1.reshape<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> -1<span style="color: #757575;">)</span>

  <span style="color: #268bd2;">k</span> = np.repeat<span style="color: #757575;">(</span>np.arange<span style="color: #757575;">(</span>C<span style="color: #757575;">),</span> field_height * field_width<span style="color: #757575;">)</span>.reshape<span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>

  <span style="color: #859900;">return</span> <span style="color: #757575;">(</span>k<span style="color: #757575;">,</span> i<span style="color: #757575;">,</span> j<span style="color: #757575;">)</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">im2col_indices</span><span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> field_height<span style="color: #757575;">,</span> field_width<span style="color: #757575;">,</span> padding=1<span style="color: #757575;">,</span> stride=1<span style="color: #757575;">)</span>:
  <span style="color: #2aa198;">""" An implementation of im2col based on some fancy indexing """</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">Zero-pad the input</span>
  <span style="color: #268bd2;">p</span> = padding
  <span style="color: #268bd2;">x_padded</span> = np.pad<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> <span style="color: #757575;">((</span>0<span style="color: #757575;">,</span> 0<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>0<span style="color: #757575;">,</span> 0<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>p<span style="color: #757575;">,</span> p<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>p<span style="color: #757575;">,</span> p<span style="color: #757575;">)),</span> mode=<span style="color: #2aa198;">'constant'</span><span style="color: #757575;">)</span>

  <span style="color: #268bd2;">k</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">i</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">j</span> = get_im2col_indices<span style="color: #757575;">(</span>x.shape<span style="color: #757575;">,</span> field_height<span style="color: #757575;">,</span> field_width<span style="color: #757575;">,</span> padding<span style="color: #757575;">,</span>
                               stride<span style="color: #757575;">)</span>

  <span style="color: #268bd2;">cols</span> = x_padded[:<span style="color: #757575;">,</span> k<span style="color: #757575;">,</span> i<span style="color: #757575;">,</span> j]
  <span style="color: #268bd2;">C</span> = x.shape[1]
  <span style="color: #268bd2;">cols</span> = cols.transpose<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 2<span style="color: #757575;">,</span> 0<span style="color: #757575;">)</span>.reshape<span style="color: #757575;">(</span>field_height * field_width * C<span style="color: #757575;">,</span> -1<span style="color: #757575;">)</span>
  <span style="color: #859900;">return</span> cols


<span style="color: #859900;">def</span> <span style="color: #268bd2;">col2im_indices</span><span style="color: #757575;">(</span>cols<span style="color: #757575;">,</span> x_shape<span style="color: #757575;">,</span> field_height=3<span style="color: #757575;">,</span> field_width=3<span style="color: #757575;">,</span> padding=1<span style="color: #757575;">,</span>
                   stride=1<span style="color: #757575;">)</span>:
  <span style="color: #2aa198;">""" An implementation of col2im based on fancy indexing and np.add.at """</span>
  <span style="color: #268bd2;">N</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">C</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">H</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">W</span> = x_shape
  <span style="color: #268bd2;">H_padded</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">W_padded</span> = H + 2 * padding<span style="color: #757575;">,</span> W + 2 * padding
  <span style="color: #268bd2;">x_padded</span> = np.zeros<span style="color: #757575;">((</span>N<span style="color: #757575;">,</span> C<span style="color: #757575;">,</span> H_padded<span style="color: #757575;">,</span> W_padded<span style="color: #757575;">),</span> dtype=cols.dtype<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">k</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">i</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">j</span> = get_im2col_indices<span style="color: #757575;">(</span>x_shape<span style="color: #757575;">,</span> field_height<span style="color: #757575;">,</span> field_width<span style="color: #757575;">,</span> padding<span style="color: #757575;">,</span>
                               stride<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">cols_reshaped</span> = cols.reshape<span style="color: #757575;">(</span>C * field_height * field_width<span style="color: #757575;">,</span> -1<span style="color: #757575;">,</span> N<span style="color: #757575;">)</span>
  <span style="color: #268bd2;">cols_reshaped</span> = cols_reshaped.transpose<span style="color: #757575;">(</span>2<span style="color: #757575;">,</span> 0<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>
  np.add.at<span style="color: #757575;">(</span>x_padded<span style="color: #757575;">,</span> <span style="color: #757575;">(</span><span style="color: #839496;">slice</span><span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">),</span> k<span style="color: #757575;">,</span> i<span style="color: #757575;">,</span> j<span style="color: #757575;">),</span> cols_reshaped<span style="color: #757575;">)</span>
  <span style="color: #859900;">if</span> padding == 0:
    <span style="color: #859900;">return</span> x_padded
  <span style="color: #859900;">return</span> x_padded[:<span style="color: #757575;">,</span> :<span style="color: #757575;">,</span> padding:-padding<span style="color: #757575;">,</span> padding:-padding]

<span style="color: #859900;">pass</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">convolve_im2col</span><span style="color: #757575;">(</span>image<span style="color: #757575;">,</span>kernel<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">image</span>=image.reshape<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>160<span style="color: #757575;">,</span>160<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">image_col</span>=im2col_indices<span style="color: #757575;">(</span>image<span style="color: #757575;">,</span> kernel.shape[0]<span style="color: #757575;">,</span>kernel.shape[1]<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">kernel</span>=kernel.reshape<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span>-1<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">image_conv</span>=np.dot<span style="color: #757575;">(</span>kernel<span style="color: #757575;">,</span>image_col<span style="color: #757575;">)</span>.reshape<span style="color: #757575;">(</span>160<span style="color: #757575;">,</span>160<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> image_conv

show_result<span style="color: #757575;">(</span>convolve_im2col<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">,</span>kernel_sharpen<span style="color: #757575;">),</span><span style="color: #2aa198;">"sharpen"</span><span style="color: #757575;">)</span>  
show_result<span style="color: #757575;">(</span>convolve_im2col<span style="color: #757575;">(</span>orig_image<span style="color: #757575;">,</span>kernel_edge<span style="color: #757575;">),</span><span style="color: #2aa198;">"edge"</span><span style="color: #757575;">)</span>  
</pre>
</div>


<div id="orge761ccd" class="figure">
<p><img src="convnets_files/convnets_15_0.png" alt="convnets_15_0.png" />
</p>
<p><span class="figure-number">Figure 6: </span>png</p>
</div>


<div id="orga5dd734" class="figure">
<p><img src="convnets_files/convnets_15_1.png" alt="convnets_15_1.png" />
</p>
<p><span class="figure-number">Figure 7: </span>png</p>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">test_image</span>=np.arange<span style="color: #757575;">(</span>0<span style="color: #757575;">,</span>64<span style="color: #757575;">,</span>1<span style="color: #757575;">)</span>.reshape<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>8<span style="color: #757575;">,</span>8<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>test_image<span style="color: #757575;">)</span>
<span style="color: #268bd2;">col</span>=im2col_indices<span style="color: #757575;">(</span>test_image<span style="color: #757575;">,</span>3<span style="color: #757575;">,</span>3<span style="color: #757575;">,</span>1<span style="color: #757575;">,</span>1<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>col.shape<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>col[:<span style="color: #757575;">,</span>0]<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>col[:<span style="color: #757575;">,</span>1]<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>col[:<span style="color: #757575;">,</span>2]<span style="color: #757575;">)</span>

</pre>
</div>

<pre class="example" id="orge534a42">
[[[[ 0  1  2  3  4  5  6  7]
   [ 8  9 10 11 12 13 14 15]
   [16 17 18 19 20 21 22 23]
   [24 25 26 27 28 29 30 31]
   [32 33 34 35 36 37 38 39]
   [40 41 42 43 44 45 46 47]
   [48 49 50 51 52 53 54 55]
   [56 57 58 59 60 61 62 63]]]]
(9, 64)
[0 0 0 0 0 1 0 8 9]
[ 0  0  0  0  1  2  8  9 10]
[ 0  0  0  1  2  3  9 10 11]
</pre>
</div>
</div>

<div id="outline-container-org4103280" class="outline-4">
<h4 id="org4103280"><span class="section-number-4">1.11.3</span> <span class="done DONE">DONE</span> winograd</h4>
<div class="outline-text-4" id="text-1-11-3">
<ul class="org-ul">
<li>State "DONE"       from "WAIT"       <span class="timestamp-wrapper"><span class="timestamp">[2021-10-25 一 19:10]</span></span></li>
</ul>

<p>
<a href="https://arxiv.org/pdf/1509.09308.pdf">https://arxiv.org/pdf/1509.09308.pdf</a>
</p>

<p>
winograd 在实现上有许多限制:
<a href="http://nvdla.org/hw/v1/ias/unit_description.html#winograd-convolution">http://nvdla.org/hw/v1/ias/unit_description.html#winograd-convolution</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgff86b70" class="outline-3">
<h3 id="orgff86b70"><span class="section-number-3">1.12</span> Lenet</h3>
<div class="outline-text-3" id="text-1-12">

<div id="orgdc61e6d" class="figure">
<p><img src="../extra/lenet5.png" alt="lenet5.png" />
</p>
<p><span class="figure-number">Figure 8: </span>lenet5</p>
</div>

<p>
Convnets 主要是在普通的 ANN 前面加入了几个 conv layer 和 pooling layer
</p>
</div>

<div id="outline-container-orgf4ff66f" class="outline-4">
<h4 id="orgf4ff66f"><span class="section-number-4">1.12.1</span> conv layer</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
conv layer 主要用来做 feature extraction
</p>
</div>
</div>

<div id="outline-container-orgee88119" class="outline-4">
<h4 id="orgee88119"><span class="section-number-4">1.12.2</span> pooling layer</h4>
<div class="outline-text-4" id="text-1-12-2">
<p>
pooling layer 一方面降低 feature map 的大小, 一方面有一定的 translation
invariance 的作用
</p>

<p>
常用的 pooling layer 是 max pooling
</p>


<div id="org85695be" class="figure">
<p><img src="../extra/max_pooling.png" alt="max_pooling.png" />
</p>
<p><span class="figure-number">Figure 9: </span>pooling</p>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">n</span> = 2 <span style="color: #586e75;"># </span><span style="color: #586e75;">two images</span>
<span style="color: #268bd2;">d</span> = 3 <span style="color: #586e75;"># </span><span style="color: #586e75;">3 channels per image</span>
<span style="color: #268bd2;">h</span> = 4 <span style="color: #586e75;"># </span><span style="color: #586e75;">image height</span>
<span style="color: #268bd2;">w</span> = 4 <span style="color: #586e75;"># </span><span style="color: #586e75;">image width</span>
<span style="color: #268bd2;">h2</span> = 2 <span style="color: #586e75;"># </span><span style="color: #586e75;">image height after max pooling</span>
<span style="color: #268bd2;">w2</span> = 2 <span style="color: #586e75;"># </span><span style="color: #586e75;">image width after max pooling</span>

<span style="color: #268bd2;">X</span>= np.arange<span style="color: #757575;">(</span>0<span style="color: #757575;">,</span> 96<span style="color: #757575;">)</span>.reshape<span style="color: #757575;">(</span>n<span style="color: #757575;">,</span> d<span style="color: #757575;">,</span> h<span style="color: #757575;">,</span> w<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"X"</span><span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>X<span style="color: #757575;">)</span>

<span style="color: #268bd2;">X</span> = images.reshape<span style="color: #757575;">(</span>n * d<span style="color: #757575;">,</span> 1<span style="color: #757575;">,</span> h<span style="color: #757575;">,</span> w<span style="color: #757575;">)</span>
<span style="color: #268bd2;">col</span> = im2col_indices<span style="color: #757575;">(</span>X<span style="color: #757575;">,</span> h2<span style="color: #757575;">,</span> h2<span style="color: #757575;">,</span> 0<span style="color: #757575;">,</span> 2<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"col"</span><span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>col<span style="color: #757575;">)</span>

<span style="color: #268bd2;">max_idx</span> = np.argmax<span style="color: #757575;">(</span>col<span style="color: #757575;">,</span> axis=0<span style="color: #757575;">)</span>

<span style="color: #268bd2;">out</span> = col[max_idx<span style="color: #757575;">,</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>max_idx.size<span style="color: #757575;">)</span>]

<span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"out"</span><span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>out<span style="color: #757575;">)</span>
<span style="color: #268bd2;">out</span> = out.reshape<span style="color: #757575;">(</span>h2<span style="color: #757575;">,</span>w2<span style="color: #757575;">,</span>n<span style="color: #757575;">,</span>d<span style="color: #757575;">)</span>
<span style="color: #268bd2;">out</span> = out.transpose<span style="color: #757575;">(</span>2<span style="color: #757575;">,</span> 3<span style="color: #757575;">,</span> 0<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>

<span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"after pooling"</span><span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>out<span style="color: #757575;">)</span>
</pre>
</div>

<pre class="example" id="org859b25c">
X
[[[[ 0  1  2  3]
   [ 4  5  6  7]
   [ 8  9 10 11]
   [12 13 14 15]]

  [[16 17 18 19]
   [20 21 22 23]
   [24 25 26 27]
   [28 29 30 31]]

  [[32 33 34 35]
   [36 37 38 39]
   [40 41 42 43]
   [44 45 46 47]]]


 [[[48 49 50 51]
   [52 53 54 55]
   [56 57 58 59]
   [60 61 62 63]]

  [[64 65 66 67]
   [68 69 70 71]
   [72 73 74 75]
   [76 77 78 79]]

  [[80 81 82 83]
   [84 85 86 87]
   [88 89 90 91]
   [92 93 94 95]]]]



---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-4-e4c6292afc32&gt; in &lt;module&gt;()
     10 print(X)
     11 
---&gt; 12 X = images.reshape(n * d, 1, h, w)
     13 col = im2col_indices(X, h2, h2, 0, 2)
     14 print("col")


NameError: name 'images' is not defined
</pre>
</div>
</div>

<div id="outline-container-org7607adc" class="outline-4">
<h4 id="org7607adc"><span class="section-number-4">1.12.3</span> why convolutions?</h4>
<div class="outline-text-4" id="text-1-12-3">
</div>
<div id="outline-container-orgb18d774" class="outline-5">
<h5 id="orgb18d774"><span class="section-number-5">1.12.3.1</span> parameter sharing</h5>
<div class="outline-text-5" id="text-1-12-3-1">
<p>
假设原始图片是 \(48 * 48 * 3\), 使用 3 个 \(3 * 3 * 3\) 的 kernel 做卷积,
输出为 \(46 * 46 * 3\)
</p>

<p>
若使用 fc layer, 需要 \(48 * 48 * 3 * 46 * 46 * 3\) 个 参数, 而使用卷积,
只需要 \(3 * 3 * 3 * 3\) 个参数
</p>

<p>
parameter sharing 是指, 输入的图片做卷积时图片的不同部分与相同的 kernel
做运算, 即共享这个 kernel, 而不像 fc layer
那样图片的不同部分使用不同的参数做运算
</p>
</div>
</div>

<div id="outline-container-orgdb7c221" class="outline-5">
<h5 id="orgdb7c221"><span class="section-number-5">1.12.3.2</span> feature extraction</h5>
<div class="outline-text-5" id="text-1-12-3-2">
<p>
图中显示的是不同层的 conv layer 学习到的 kernel 经过可视化处理后结果,
第一层的 kernel 可能只是用来检测边界, 后面的会检测更具体的 feature
</p>


<div id="org09e8019" class="figure">
<p><img src="../extra/visual_conv.png" alt="visual_conv.png" />
</p>
<p><span class="figure-number">Figure 10: </span>filter</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
