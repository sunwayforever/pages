<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 Tue 15:41 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>正则化与过拟合</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">正则化与过拟合</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7953c60">1. 正则化与过拟合</a>
<ul>
<li><a href="#org85f2107">1.1. 正则化的直观理解</a></li>
<li><a href="#org6319fa5">1.2. 增加样本</a></li>
<li><a href="#org471f330">1.3. 简化网络</a></li>
<li><a href="#org3516f61">1.4. L2 和 L1 正则化</a>
<ul>
<li><a href="#org758cf36">1.4.1. 无正则化</a></li>
<li><a href="#org6fa41b4">1.4.2. L2 正则化</a></li>
<li><a href="#org7a544bc">1.4.3. L1 正则化</a></li>
<li><a href="#orgf4a6607">1.4.4. 另一种解释</a></li>
</ul>
</li>
<li><a href="#org65b2401">1.5. Dropout</a></li>
<li><a href="#orgbef106e">1.6. Batch Normalization</a></li>
<li><a href="#org23faabe">1.7. pytorch 中使用正则化</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org7953c60" class="outline-2">
<h2 id="org7953c60"><span class="section-number-2">1</span> 正则化与过拟合</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org85f2107" class="outline-3">
<h3 id="org85f2107"><span class="section-number-3">1.1</span> 正则化的直观理解</h3>
<div class="outline-text-3" id="text-1-1">
<p>
以 L2 正则化为例, 假设加上损失函数之前:
</p>

<ul class="org-ul">
<li>\(loss=C0\)</li>

<li>\(\frac{\partial}{\partial{w_i}}loss= d0\)</li>
</ul>

<p>
加上 L2 正则化后:
</p>

<ul class="org-ul">
<li>\(loss=C0+\frac{\alpha}{2}\sum{w^2}\)</li>

<li>\(\frac{\partial}{\partial{w_i}}loss= d0+\alpha w_i\)</li>
</ul>


<ol class="org-ol">
<li>正则化后, 由损失函数的格式可知, w 会变得偏小</li>
<li>w 变小, 会导致拟合曲线更加平滑. 因为在拟合曲线中, w 是 x 的系数, w 偏小即曲线
的斜率会普遍变小, 从而更平滑</li>
<li>从 svm 的角度来看, L2 正则化项相当于一个约束, 要求 \(||w||\) 为某个值</li>
<li>w 变小, 导致样本中的少量噪音并不会使损失函数有很大的变化, 从而减小训练时噪音
的影响</li>
</ol>
</div>
</div>

<div id="outline-container-org6319fa5" class="outline-3">
<h3 id="org6319fa5"><span class="section-number-3">1.2</span> 增加样本</h3>
<div class="outline-text-3" id="text-1-2">
<p>
正则化是为了解决 overfitting 问题. 模型中的变量与样本的比值越大, 越容易发生
overfitting. 所以在不减少模型中变量的数目的前提下, 增加样本可以减轻 overfitting
</p>
</div>
</div>

<div id="outline-container-org471f330" class="outline-3">
<h3 id="org471f330"><span class="section-number-3">1.3</span> 简化网络</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li>减少 ANN hidden layer 的个数</li>
<li>减少神经元的个数</li>
</ol>
</div>
</div>

<div id="outline-container-org3516f61" class="outline-3">
<h3 id="org3516f61"><span class="section-number-3">1.4</span> L2 和 L1 正则化</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org758cf36" class="outline-4">
<h4 id="org758cf36"><span class="section-number-4">1.4.1</span> 无正则化</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-ipython">import numpy as np
import matplotlib.pyplot as plt
from sklearn.datasets import make_moons
from matplotlib.colors import ListedColormap
from torch.utils.data import Dataset, DataLoader
import torch

model = torch.nn.Sequential(
    torch.nn.Linear(2, 50), torch.nn.ReLU(), torch.nn.Linear(50, 1),
    torch.nn.Sigmoid())


class MoonDataset(Dataset):
    def __init__(self):
        X, Y = make_moons(n_samples=1000, noise=0.2)
        self.X = torch.from_numpy(X).float()
        self.Y = torch.from_numpy(Y).float().view(-1, 1)

    def __getitem__(self, index):
        return self.X[index], self.Y[index]

    def __len__(self):
        return len(self.X)


dataset = MoonDataset()
loader = DataLoader(dataset, batch_size=100)

criterion = torch.nn.BCELoss()

optimizer = torch.optim.Adam(model.parameters())

def add_regularization(loss):
    return loss

def train():
    for i in range(1000):
        for x, y in loader:
            loss = criterion(model(x), y)
            loss = add_regularization(loss)
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()

def visualize():
    cm = ListedColormap(['#FF0000', '#0000FF'])

    plt.subplot(121)
    plt.scatter(x=dataset.X[:, 0], y=dataset.X[:, 1], c=dataset.Y[:, 0], cmap=cm)

    xx, yy = np.meshgrid(np.arange(-4, 4, 0.02), np.arange(-4, 4, 0.02))
    X = np.c_[xx.ravel(), yy.ravel()]

    y_hat = model(torch.from_numpy(X).float()).detach().numpy()
    y_hat = (y_hat &gt; 0.5)[:, 0]
    y_hat = y_hat.reshape(xx.shape)

    cm = ListedColormap(['#FF0000', '#0000FF'])
    plt.contour(xx, yy, y_hat, cmap=cm)

    x = next(model.parameters()).view(-1, 1)
    plt.subplot(122)
    plt.hist(x.detach().numpy(), bins=50)
    plt.show()

    return sum(x)

train()
visualize()
</pre>
</div>

<pre class="example">
tensor([-7.9089])
</pre>


<div id="orgce59074" class="figure">
<p><img src="../extra/no_regularization.png" alt="no_regularization.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org6fa41b4" class="outline-4">
<h4 id="org6fa41b4"><span class="section-number-4">1.4.2</span> L2 正则化</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-ipython">def add_regularization(loss):
    for name, param in model.named_parameters():
        if 'bias' not in name:
            loss = loss + 0.5 * (0.001 * torch.sum(torch.pow(param, 2)))
    return loss

train()
visualize()
</pre>
</div>

<pre class="example">
tensor([-5.5809])
</pre>


<div id="orgaddd518" class="figure">
<p><img src="../extra/l2_regularization.png" alt="l2_regularization.png" />
</p>
</div>

<p>
可以看到 L2 正则化使得 w 的值变得较小
</p>
</div>
</div>

<div id="outline-container-org7a544bc" class="outline-4">
<h4 id="org7a544bc"><span class="section-number-4">1.4.3</span> L1 正则化</h4>
<div class="outline-text-4" id="text-1-4-3">
<div class="org-src-container">
<pre class="src src-ipython">def add_regularization(loss):
    for name, param in model.named_parameters():
        if 'bias' not in name:
            loss = loss + (0.001 * torch.sum(torch.abs(param)))
    return loss

train()
visualize()
</pre>
</div>

<pre class="example">
tensor([-7.9170])
</pre>


<div id="orgc7a04ef" class="figure">
<p><img src="../extra/l1_regularization.png" alt="l1_regularization.png" />
</p>
</div>

<p>
L1 正则化:
</p>

<ul class="org-ul">
<li>\(loss=C0+\frac{\alpha}{m}\sum{abs(w)}\)</li>

<li><p>
\(\frac{\partial}{\partial{w_i}}loss= d0+\frac{\alpha}{m}*sgn(w_i)\)
</p>

<p>
L1 正则化与 L2 相比, 对 w 的修正是一个定值, 而不像 L2 那样是一个与 w 成比例的
值. 这就导致当 w 较小时, L1 修正的范围会比 L2 大, 导致 w 容易减到 0 附近. 当 w
较大时, L1 修正的范围比 L2 小, 导致 w 较大.
</p>

<p>
反映到上面的直方图中, 许多值在零附近, 但值的范围与无正则化时类似.
</p>

<p>
所以 L1 会使得 w 比较稀疏, 适合做特征选择 (选择较大的 w 对应的特征)
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgf4a6607" class="outline-4">
<h4 id="orgf4a6607"><span class="section-number-4">1.4.4</span> 另一种解释</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
从 SVM 的角度来看, 正则化项可以看作是原优化问题的不等式约束, 例如对于 L2 来说,
即是 \(\sum{w_i^2} <= C\)
</p>

<p>
假设 w 为二维, 而 L2 是把 w 约束在一个圆内, 而 L1 是把 w 约束在一个菱形中.
</p>


<div id="org4402105" class="figure">
<p><img src="../extra/l1_l2_regularization.png" alt="l1_l2_regularization.png" />
</p>
</div>

<p>
可以看到 L1 优化时非常容易取得顶点位置, 导致部分权重为 0
</p>
</div>
</div>
</div>

<div id="outline-container-org65b2401" class="outline-3">
<h3 id="org65b2401"><span class="section-number-3">1.5</span> Dropout</h3>
</div>

<div id="outline-container-orgbef106e" class="outline-3">
<h3 id="orgbef106e"><span class="section-number-3">1.6</span> Batch Normalization</h3>
</div>

<div id="outline-container-org23faabe" class="outline-3">
<h3 id="org23faabe"><span class="section-number-3">1.7</span> pytorch 中使用正则化</h3>
<div class="outline-text-3" id="text-1-7">
<p>
pytorch 通过 optim 的 weight_decay 实现 L2 正则化, 而不是 把 L2 加到 loss 上再进
行 backward.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">SGD</span>(Optimizer):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">step</span>():
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
        <span style="font-weight: bold;">for</span> p <span style="font-weight: bold;">in</span> group[<span style="font-style: italic;">'params'</span>]:
            <span style="font-weight: bold; font-style: italic;">d_p</span> = p.grad.data
            <span style="font-weight: bold;">if</span> weight_decay != 0:
                <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">add_ &#20250;&#25226; weight_decay*p.data &#21152;&#21040; p.grad.data &#19978;</span>
                d_p.add_(weight_decay, p.data)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2018-07-25 Wed 00:00<br />
Last updated: 2022-01-25 Tue 14:49</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
