<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 12:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dynamic Shaped Network</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Dynamic Shaped Network</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org87e6738">1. <span class="done DONE">DONE</span> Dynamic Shaped Network</a>
<ul>
<li><a href="#org0cfd3e5">1.1. Fully Convolutional Networks</a></li>
<li><a href="#orga330b74">1.2. FCN for Semantic Segmentation</a></li>
<li><a href="#orgdb01f19">1.3. 通过 pooling 支持 Dense 层</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org87e6738" class="outline-2">
<h2 id="org87e6738"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> Dynamic Shaped Network</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>State "DONE"       from              <span class="timestamp-wrapper"><span class="timestamp">[2021-09-29 三 20:51]</span></span></li>
</ul>
</div>

<div id="outline-container-org0cfd3e5" class="outline-3">
<h3 id="org0cfd3e5"><span class="section-number-3">1.1</span> Fully Convolutional Networks</h3>
<div class="outline-text-3" id="text-1-1">
<p>
由于 cnn 层计算时并不需要针对特定的尺寸, 所以全卷积网络本来就是和 input shape 无关的
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">import</span> os
<span style="color: #859900;">import</span> tensorflow <span style="color: #859900;">as</span> tf
<span style="color: #859900;">from</span> tensorflow <span style="color: #859900;">import</span> keras
<span style="color: #859900;">from</span> tensorflow.keras <span style="color: #859900;">import</span> layers


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_model</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">inputs</span> = keras.Input<span style="color: #757575;">(</span>shape=<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>

    <span style="color: #268bd2;">outputs</span> = inputs
    <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>3<span style="color: #757575;">)</span>:
        <span style="color: #268bd2;">outputs</span> = layers.Conv2D<span style="color: #757575;">(</span>
            filters=16<span style="color: #757575;">,</span>
            kernel_size=[3<span style="color: #757575;">,</span> 3]<span style="color: #757575;">,</span>
            activation=<span style="color: #2aa198;">"relu"</span><span style="color: #757575;">,</span>
            padding=<span style="color: #2aa198;">"SAME"</span><span style="color: #757575;">,</span>
        <span style="color: #757575;">)(</span>outputs<span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> keras.Model<span style="color: #757575;">(</span>inputs<span style="color: #757575;">,</span> outputs<span style="color: #757575;">)</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    <span style="color: #268bd2;">model</span> = get_model<span style="color: #757575;">()</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span>model.predict<span style="color: #757575;">(</span>np.random.randn<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 10<span style="color: #757575;">,</span> 10<span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>.shape<span style="color: #757575;">)</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span>model.predict<span style="color: #757575;">(</span>np.random.randn<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 20<span style="color: #757575;">,</span> 20<span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>.shape<span style="color: #757575;">)</span>
</pre>
</div>

<p>
(1, 10, 10, 16)
(1, 20, 20, 16)
</p>
</div>
</div>

<div id="outline-container-orga330b74" class="outline-3">
<h3 id="orga330b74"><span class="section-number-3">1.2</span> FCN for Semantic Segmentation</h3>
<div class="outline-text-3" id="text-1-2">
<p>
FCN 比较适合 semantic segmentation 任务: conv 之后不需要 fc, 直接按一个 up
sample 即可 (deconv, unpooling, interpolate&#x2026;)
</p>

<p>
<a href="https://arxiv.org/pdf/1411.4038.pdf">https://arxiv.org/pdf/1411.4038.pdf</a>
</p>
</div>
</div>

<div id="outline-container-orgdb01f19" class="outline-3">
<h3 id="orgdb01f19"><span class="section-number-3">1.3</span> 通过 pooling 支持 Dense 层</h3>
<div class="outline-text-3" id="text-1-3">
<p>
传统的 cnn 卷积并不像全卷积网络, 它们通常最后需要一个 fully connected 来输出有用的信息, 而 fully connected 要求它的输入必须是确定大小的. 通过在 fully connected
前插入特殊的 pooling, 可以达到把 cnn 输出的 feature 变成固定大小.
</p>

<p>
正常的 pooling 使用 <b>定长</b> 的 stride, 针对变长的输入会产生 <b>变长</b> 的输出, 特殊的
pooling 使用和输入大小成正比的 <b>变长</b> stride, 针对变长的输入会产生 <b>定长</b> 的输出.
</p>

<p>
例如:
</p>

<ol class="org-ol">
<li>输入是 100, 使用 stride 为 2, 输出为 50</li>
<li>输入是 200, stride 会变为 4, 输出还是 50</li>
</ol>

<p>
GlobalAveragePooling2D 就是这样一种 pooling, 它的 stride 实际可以看做是变长的
[H,W]
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/usr/bin/env python3</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">-*- coding: utf-8 -*-</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">2021-09-24 10:32</span>
<span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">import</span> os
<span style="color: #859900;">import</span> tensorflow <span style="color: #859900;">as</span> tf
<span style="color: #859900;">from</span> tensorflow <span style="color: #859900;">import</span> keras
<span style="color: #859900;">from</span> tensorflow.keras <span style="color: #859900;">import</span> layers


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_model</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">inputs</span> = keras.Input<span style="color: #757575;">(</span>shape=<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>

    <span style="color: #268bd2;">outputs</span> = inputs
    <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>3<span style="color: #757575;">)</span>:
        <span style="color: #268bd2;">outputs</span> = layers.Conv2D<span style="color: #757575;">(</span>
            filters=16<span style="color: #757575;">,</span>
            kernel_size=[3<span style="color: #757575;">,</span> 3]<span style="color: #757575;">,</span>
            activation=<span style="color: #2aa198;">"relu"</span><span style="color: #757575;">,</span>
            padding=<span style="color: #2aa198;">"SAME"</span><span style="color: #757575;">,</span>
        <span style="color: #757575;">)(</span>outputs<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">outputs</span> = layers.GlobalAveragePooling2D<span style="color: #757575;">()(</span>outputs<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">outputs</span> = layers.Dense<span style="color: #757575;">(</span>1<span style="color: #757575;">)(</span>outputs<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> keras.Model<span style="color: #757575;">(</span>inputs<span style="color: #757575;">,</span> outputs<span style="color: #757575;">)</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    <span style="color: #268bd2;">model</span> = get_model<span style="color: #757575;">()</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span>model.layers[1].output.shape<span style="color: #757575;">)</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span>model.predict<span style="color: #757575;">(</span>np.random.randn<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 10<span style="color: #757575;">,</span> 10<span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>.shape<span style="color: #757575;">)</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span>model.predict<span style="color: #757575;">(</span>np.random.randn<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 20<span style="color: #757575;">,</span> 20<span style="color: #757575;">,</span> 3<span style="color: #757575;">))</span>.shape<span style="color: #757575;">)</span>

</pre>
</div>

<p>
另外还是一种称为 <a href="https://arxiv.org/pdf/1406.4729.pdf">Spatial Pyramid Pooling</a>, 它使用多个不同尺寸的变长 pooling, 所以称为 pyramid:
</p>

<p>
假设输入 feature map 是 [H,W,C], 且它使用这三种尺寸的 pooling:
</p>

<ol class="org-ol">
<li>[H,W], 输出 C*1</li>
<li>[H/2,W/2], 输出 C*4</li>
<li>[H/4,W/4], 输出 C*16</li>
</ol>

<p>
concat 在一起后输出 C*21 个值, 不论 H,W 是多少, 输出都是固定的 C*21
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
