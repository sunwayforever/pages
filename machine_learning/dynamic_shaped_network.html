<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!--  -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dynamic Shaped Network</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Dynamic Shaped Network</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org000000f">1. Dynamic Shaped Network</a>
<ul>
<li><a href="#org0000000">1.1. Fully Convolutional Networks</a></li>
<li><a href="#org0000003">1.2. FCN for Semantic Segmentation</a></li>
<li><a href="#org000000c">1.3. 通过 pooling 支持 Dense 层</a>
<ul>
<li><a href="#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">1.3.1. Global Average Pooling</a></li>
<li><a href="#ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb">1.3.2. Adaptive Average Pooling</a></li>
<li><a href="#ID-8391e6de-fb63-453a-a451-f2730baec121">1.3.3. Spatial Pyramid Pooling</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000000f" class="outline-2">
<h2 id="org000000f"><span class="section-number-2">1</span> Dynamic Shaped Network</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1</span> Fully Convolutional Networks</h3>
<div class="outline-text-3" id="text-1-1">
<p>
由于 cnn 层计算时并不需要针对特定的尺寸, 所以全卷积网络本来就是和 input shape 无
关的
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> tensorflow <span style="font-weight: bold;">as</span> tf
<span style="font-weight: bold;">from</span> tensorflow <span style="font-weight: bold;">import</span> keras
<span style="font-weight: bold;">from</span> tensorflow.keras <span style="font-weight: bold;">import</span> layers


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_model</span>():
    <span style="font-weight: bold; font-style: italic;">inputs</span> = keras.Input(shape=(<span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">None</span>, 3))

    <span style="font-weight: bold; font-style: italic;">outputs</span> = inputs
    <span style="font-weight: bold;">for</span> i <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(3):
        <span style="font-weight: bold; font-style: italic;">outputs</span> = layers.Conv2D(
            filters=16,
            kernel_size=[3, 3],
            activation=<span style="font-style: italic;">"relu"</span>,
            padding=<span style="font-style: italic;">"SAME"</span>,
        )(outputs)

    <span style="font-weight: bold;">return</span> keras.Model(inputs, outputs)


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    <span style="font-weight: bold; font-style: italic;">model</span> = get_model()
    <span style="font-weight: bold;">print</span>(model.predict(np.random.randn(1, 10, 10, 3)).shape)
    <span style="font-weight: bold;">print</span>(model.predict(np.random.randn(1, 20, 20, 3)).shape)
</pre>
</div>

<p>
(1, 10, 10, 16)
(1, 20, 20, 16)
</p>
</div>
</div>

<div id="outline-container-org0000003" class="outline-3">
<h3 id="org0000003"><span class="section-number-3">1.2</span> FCN for Semantic Segmentation</h3>
<div class="outline-text-3" id="text-1-2">
<p>
FCN 比较适合 semantic segmentation 任务: conv 之后不需要 fc, 直接按一个 up
sample 即可 (deconv, unpooling, interpolate&#x2026;)
</p>

<p>
<a href="https://arxiv.org/pdf/1411.4038.pdf">https://arxiv.org/pdf/1411.4038.pdf</a>
</p>
</div>
</div>

<div id="outline-container-org000000c" class="outline-3">
<h3 id="org000000c"><span class="section-number-3">1.3</span> 通过 pooling 支持 Dense 层</h3>
<div class="outline-text-3" id="text-1-3">
<p>
传统的 cnn 卷积并不像全卷积网络, 它们通常最后需要一个 fully connected 来输出有用
的信息, 而 fully connected 要求它的输入必须是确定大小的. 通过在 fully connected
前插入特殊的 pooling, 可以达到把 cnn 输出的 feature 变成固定大小.
</p>

<p>
正常的 pooling 使用 <b>定长</b> 的 stride, 针对变长的输入会产生 <b>变长</b> 的输出, 特殊的
pooling 使用和输入大小成正比的 <b>变长</b> stride, 针对变长的输入会产生 <b>定长</b> 的输出.
</p>

<p>
例如:
</p>

<ol class="org-ol">
<li>输入是 100, 使用 stride 为 2, 输出为 50</li>
<li>输入是 200, stride 会变为 4, 输出还是 50</li>
</ol>
</div>

<div id="outline-container-ID-f70d117b-3974-43d2-b082-a08c58cc87f5" class="outline-4">
<h4 id="ID-f70d117b-3974-43d2-b082-a08c58cc87f5"><span class="section-number-4">1.3.1</span> Global Average Pooling</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
GlobalAveragePooling2D 就是这样一种 pooling, 它的 stride 实际可以看做是变长的
[H,W]
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2021-09-24 10:32</span>
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> tensorflow <span style="font-weight: bold;">as</span> tf
<span style="font-weight: bold;">from</span> tensorflow <span style="font-weight: bold;">import</span> keras
<span style="font-weight: bold;">from</span> tensorflow.keras <span style="font-weight: bold;">import</span> layers


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_model</span>():
    <span style="font-weight: bold; font-style: italic;">inputs</span> = keras.Input(shape=(<span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">None</span>, 3))

    <span style="font-weight: bold; font-style: italic;">outputs</span> = inputs
    <span style="font-weight: bold;">for</span> i <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(3):
        <span style="font-weight: bold; font-style: italic;">outputs</span> = layers.Conv2D(
            filters=16,
            kernel_size=[3, 3],
            activation=<span style="font-style: italic;">"relu"</span>,
            padding=<span style="font-style: italic;">"SAME"</span>,
        )(outputs)

    <span style="font-weight: bold; font-style: italic;">outputs</span> = layers.GlobalAveragePooling2D()(outputs)
    <span style="font-weight: bold; font-style: italic;">outputs</span> = layers.Dense(1)(outputs)
    <span style="font-weight: bold;">return</span> keras.Model(inputs, outputs)


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    <span style="font-weight: bold; font-style: italic;">model</span> = get_model()
    <span style="font-weight: bold;">print</span>(model.layers[1].output.shape)
    <span style="font-weight: bold;">print</span>(model.predict(np.random.randn(1, 10, 10, 3)).shape)
    <span style="font-weight: bold;">print</span>(model.predict(np.random.randn(1, 20, 20, 3)).shape)

</pre>
</div>

<p>
(None, None, None, 16)
(1, 1)
(1, 1)
</p>
</div>


<div id="outline-container-org0000006" class="outline-5 references">
<h5 id="org0000006">Backlinks</h5>
<div class="outline-text-5" id="text-org0000006">
<p>
<a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">DeepLab</a>
(<i>DeepLab &gt; DeepLabV3 Network</i>):         除了 ASPP, 还有一个 Image Pooling 层, 它实际是对 block4 做了一个    <a href="#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">GlobalAveragePooling2D</a> 后再通过 1x1 conv2d 和 bilinear interpolation, 最终也是输    出 (h, w, 256)
</p>

<p>
<a href="faster_rcnn.html#ID-74fbc1ab-e6bd-4004-8f00-24ab33aa2ad5">Faster RCNN</a>
(<i>Faster RCNN &gt; ROIPooling</i>):      2. 通过 roi pooling 得到特定尺寸的 feature map, 所谓的 roi pooling 实际上    <a href="#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">GlobalAveragePooling</a> 或 <a href="#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a> 类似.
</p>
</div>
</div>
</div>


<div id="outline-container-ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb" class="outline-4">
<h4 id="ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb"><span class="section-number-4">1.3.2</span> Adaptive Average Pooling</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> torch
<span style="font-weight: bold;">from</span> torch <span style="font-weight: bold;">import</span> nn

<span style="font-weight: bold; font-style: italic;">m</span> = nn.AdaptiveAvgPool2d((5, 7))
<span style="font-weight: bold;">input</span> = torch.randn(1, 64, 8, 9)
<span style="font-weight: bold; font-style: italic;">output</span> = m(<span style="font-weight: bold;">input</span>)
<span style="font-weight: bold;">print</span>(output.shape)
</pre>
</div>

<p>
torch.Size([1, 64, 5, 7])
</p>

<p>
stride 实际可以看做是变长的 [H/a,W/b], 其中 (a,b) 是它的 output size
</p>

<p>
GlobalAveragePooling2D 是 AdaptiveAveragePooling2D 的特殊情况: output size 为
(1,1)
</p>
</div>


<div id="outline-container-org0000009" class="outline-5 references">
<h5 id="org0000009">Backlinks</h5>
<div class="outline-text-5" id="text-org0000009">
<p>
<a href="alexnet.html#ID-ed24e028-0d62-43c5-af7d-522977fbbce4">AlexNet</a>
(<i>AlexNet &gt; Network</i>):  torchvison 的 alexnet 加入了一个 <a href="#ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb">Adaptive Average Pooling</a>, 使得它能支持变长的输 入.
</p>

<p>
<a href="vgg.html#ID-8b9be85a-94c9-4ab5-8da5-cb8fba14aa9a">Vgg</a>
(<i>Vgg &gt; Network</i>):     features 后面的 7x7x512 是一个 <a href="#ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb">adaptive average pooling</a>    
</p>

<p>
<a href="pspnet.html#ID-5ab05d23-629f-4f08-929a-9d52513c1ef4">PSPNet</a>
(<i>PSPNet &gt; Network &gt; pyramid pooling module</i>):  1. 使用 4 个 <a href="#ID-b73003c4-220f-4ef0-ab4d-8829035dc4eb">Adaptive Average Pooling</a>, output size 分别为 1, 2, 3, 6    
</p>
</div>
</div>
</div>


<div id="outline-container-ID-8391e6de-fb63-453a-a451-f2730baec121" class="outline-4">
<h4 id="ID-8391e6de-fb63-453a-a451-f2730baec121"><span class="section-number-4">1.3.3</span> Spatial Pyramid Pooling</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
另外还是一种称为 <a href="https://arxiv.org/pdf/1406.4729.pdf">Spatial Pyramid Pooling</a>, 它使用多个不同尺寸的变长 pooling, 所以
称为 pyramid:
</p>

<p>
假设输入 feature map 是 [H,W,C], 且它使用这三种尺寸的 pooling:
</p>

<ol class="org-ol">
<li>[H,W], 输出 C*1</li>
<li>[H/2,W/2], 输出 C*4</li>
<li>[H/4,W/4], 输出 C*16</li>
</ol>

<p>
concat 在一起后输出 C*21 个值, 不论 H,W 是多少, 输出都是固定的 C*21
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org0000012" class="outline-2 references">
<h2 id="org0000012">Backlinks</h2>
<div class="outline-text-2" id="text-org0000012">
<p>
<a href="cnn.html#ID-bad26e8b-7690-4654-9ccc-c1e9044113a1">CNN</a>
(<i>CNN &gt; Dynamic Shaped Network</i>):   <a href="dynamic_shaped_network.html#ID-6f4a00fd-5bed-48f5-af06-e9596a1b14e1">Dynamic Shaped Network</a>
</p>
</div>



<div id="outline-container-org0000015" class="outline-5 references">
<h5 id="org0000015">Backlinks</h5>
<div class="outline-text-5" id="text-org0000015">
<p>
<a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">DeepLab</a>
(<i>DeepLab</i>):  DeepLab 是 google 提出的 semantic segmentation 模型, 最新的模型是 v3 和 v3+, 主 要思想是利用多个不同 dilation rate 的 <a href="cnn.html#ID-5936a1da-7b6d-4a14-82b4-658cbfe62b63">Dilated Conv2D</a> 来融合不同尺度上的特征, 有 点类似于 <a href="#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a>
</p>

<p>
<a href="faster_rcnn.html#ID-74fbc1ab-e6bd-4004-8f00-24ab33aa2ad5">Faster RCNN</a>
(<i>Faster RCNN &gt; ROIPooling</i>):      2. 通过 roi pooling 得到特定尺寸的 feature map, 所谓的 roi pooling 实际上    <a href="#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">GlobalAveragePooling</a> 或 <a href="#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a> 类似.
</p>

<p>
<a href="pspnet.html#ID-5ab05d23-629f-4f08-929a-9d52513c1ef4">PSPNet</a>
(<i>PSPNet</i>):  pspnet 是一个 semantic segmentation 模型, 它利用 <a href="#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a> 获得全 局上下文信息. 它的结构与 <a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">DeepLab</a> 非常像: 前者使用不同尺度的 pooling 叠加, 后者使 用不同尺度的 dilation conv 叠加.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: <br />
Last updated: </p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
