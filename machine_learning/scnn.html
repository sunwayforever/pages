<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 20:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SCNN</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">SCNN</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5b4f19d">1. SCNN</a>
<ul>
<li><a href="#orga32c04a">1.1. Tusimple Dataset</a></li>
<li><a href="#org383a564">1.2. Label</a></li>
<li><a href="#orgb478ea9">1.3. Network</a>
<ul>
<li><a href="#org1249c9b">1.3.1. backbone</a></li>
<li><a href="#org07e8422">1.3.2. message_passing</a></li>
<li><a href="#org0f45c85">1.3.3. upsample</a></li>
</ul>
</li>
<li><a href="#org1039db9">1.4. Inference</a></li>
<li><a href="#org3337e57">1.5. Loss</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org5b4f19d" class="outline-2">
<h2 id="org5b4f19d"><span class="section-number-2">1</span> SCNN</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://arxiv.org/pdf/1712.06080.pdf">https://arxiv.org/pdf/1712.06080.pdf</a>
</p>

<p>
SCNN 是一个针对车道线识别的语义分割模型.
</p>
</div>

<div id="outline-container-orga32c04a" class="outline-3">
<h3 id="orga32c04a"><span class="section-number-3">1.1</span> Tusimple Dataset</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<a href="https://github.com/TuSimple/tusimple-benchmark">https://github.com/TuSimple/tusimple-benchmark</a>
</p>

<p>
tusimple dataset 格式为:
</p>

<div class="org-src-container">
<pre class="src src-json">{
    <span style="font-weight: bold;">"lanes"</span>: [
        [-<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, <span style="font-weight: bold; text-decoration: underline;">587</span>, <span style="font-weight: bold; text-decoration: underline;">611</span>, <span style="font-weight: bold; text-decoration: underline;">600</span>, <span style="font-weight: bold; text-decoration: underline;">587</span>, <span style="font-weight: bold; text-decoration: underline;">574</span>, <span style="font-weight: bold; text-decoration: underline;">562</span>, <span style="font-weight: bold; text-decoration: underline;">549</span>,
         <span style="font-weight: bold; text-decoration: underline;">536</span>, <span style="font-weight: bold; text-decoration: underline;">523</span>, <span style="font-weight: bold; text-decoration: underline;">510</span>, <span style="font-weight: bold; text-decoration: underline;">497</span>, <span style="font-weight: bold; text-decoration: underline;">484</span>, <span style="font-weight: bold; text-decoration: underline;">472</span>, <span style="font-weight: bold; text-decoration: underline;">459</span>, <span style="font-weight: bold; text-decoration: underline;">446</span>, <span style="font-weight: bold; text-decoration: underline;">433</span>, <span style="font-weight: bold; text-decoration: underline;">420</span>, <span style="font-weight: bold; text-decoration: underline;">407</span>, <span style="font-weight: bold; text-decoration: underline;">395</span>, <span style="font-weight: bold; text-decoration: underline;">382</span>, <span style="font-weight: bold; text-decoration: underline;">369</span>, <span style="font-weight: bold; text-decoration: underline;">356</span>,
         <span style="font-weight: bold; text-decoration: underline;">343</span>, <span style="font-weight: bold; text-decoration: underline;">330</span>, <span style="font-weight: bold; text-decoration: underline;">317</span>, <span style="font-weight: bold; text-decoration: underline;">305</span>, <span style="font-weight: bold; text-decoration: underline;">292</span>, <span style="font-weight: bold; text-decoration: underline;">279</span>, <span style="font-weight: bold; text-decoration: underline;">266</span>, <span style="font-weight: bold; text-decoration: underline;">253</span>, <span style="font-weight: bold; text-decoration: underline;">240</span>, <span style="font-weight: bold; text-decoration: underline;">227</span>, <span style="font-weight: bold; text-decoration: underline;">215</span>, <span style="font-weight: bold; text-decoration: underline;">202</span>, <span style="font-weight: bold; text-decoration: underline;">189</span>, <span style="font-weight: bold; text-decoration: underline;">176</span>, <span style="font-weight: bold; text-decoration: underline;">163</span>,
         <span style="font-weight: bold; text-decoration: underline;">150</span>, <span style="font-weight: bold; text-decoration: underline;">137</span>, <span style="font-weight: bold; text-decoration: underline;">125</span>, <span style="font-weight: bold; text-decoration: underline;">112</span>, <span style="font-weight: bold; text-decoration: underline;">99</span>, <span style="font-weight: bold; text-decoration: underline;">86</span>, <span style="font-weight: bold; text-decoration: underline;">73</span>, <span style="font-weight: bold; text-decoration: underline;">60</span>, <span style="font-weight: bold; text-decoration: underline;">47</span>],

        [-<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, <span style="font-weight: bold; text-decoration: underline;">634</span>, <span style="font-weight: bold; text-decoration: underline;">665</span>, <span style="font-weight: bold; text-decoration: underline;">679</span>, <span style="font-weight: bold; text-decoration: underline;">693</span>, <span style="font-weight: bold; text-decoration: underline;">708</span>, <span style="font-weight: bold; text-decoration: underline;">717</span>, <span style="font-weight: bold; text-decoration: underline;">727</span>,
         <span style="font-weight: bold; text-decoration: underline;">737</span>, <span style="font-weight: bold; text-decoration: underline;">747</span>, <span style="font-weight: bold; text-decoration: underline;">756</span>, <span style="font-weight: bold; text-decoration: underline;">766</span>, <span style="font-weight: bold; text-decoration: underline;">776</span>, <span style="font-weight: bold; text-decoration: underline;">785</span>, <span style="font-weight: bold; text-decoration: underline;">795</span>, <span style="font-weight: bold; text-decoration: underline;">805</span>, <span style="font-weight: bold; text-decoration: underline;">815</span>, <span style="font-weight: bold; text-decoration: underline;">824</span>, <span style="font-weight: bold; text-decoration: underline;">834</span>, <span style="font-weight: bold; text-decoration: underline;">844</span>, <span style="font-weight: bold; text-decoration: underline;">853</span>, <span style="font-weight: bold; text-decoration: underline;">863</span>, <span style="font-weight: bold; text-decoration: underline;">873</span>,
         <span style="font-weight: bold; text-decoration: underline;">883</span>, <span style="font-weight: bold; text-decoration: underline;">892</span>, <span style="font-weight: bold; text-decoration: underline;">902</span>, <span style="font-weight: bold; text-decoration: underline;">912</span>, <span style="font-weight: bold; text-decoration: underline;">921</span>, <span style="font-weight: bold; text-decoration: underline;">931</span>, <span style="font-weight: bold; text-decoration: underline;">941</span>, <span style="font-weight: bold; text-decoration: underline;">950</span>, <span style="font-weight: bold; text-decoration: underline;">960</span>, <span style="font-weight: bold; text-decoration: underline;">970</span>, <span style="font-weight: bold; text-decoration: underline;">980</span>, <span style="font-weight: bold; text-decoration: underline;">989</span>, <span style="font-weight: bold; text-decoration: underline;">999</span>, <span style="font-weight: bold; text-decoration: underline;">1009</span>, <span style="font-weight: bold; text-decoration: underline;">1018</span>,
         <span style="font-weight: bold; text-decoration: underline;">1028</span>, <span style="font-weight: bold; text-decoration: underline;">1038</span>, <span style="font-weight: bold; text-decoration: underline;">1048</span>, <span style="font-weight: bold; text-decoration: underline;">1057</span>, <span style="font-weight: bold; text-decoration: underline;">1067</span>, <span style="font-weight: bold; text-decoration: underline;">1077</span>, <span style="font-weight: bold; text-decoration: underline;">1086</span>, <span style="font-weight: bold; text-decoration: underline;">1096</span>, <span style="font-weight: bold; text-decoration: underline;">1106</span>],

        [-<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, <span style="font-weight: bold; text-decoration: underline;">685</span>, <span style="font-weight: bold; text-decoration: underline;">730</span>, <span style="font-weight: bold; text-decoration: underline;">766</span>, <span style="font-weight: bold; text-decoration: underline;">797</span>, <span style="font-weight: bold; text-decoration: underline;">828</span>, <span style="font-weight: bold; text-decoration: underline;">858</span>, <span style="font-weight: bold; text-decoration: underline;">889</span>,
         <span style="font-weight: bold; text-decoration: underline;">919</span>, <span style="font-weight: bold; text-decoration: underline;">950</span>, <span style="font-weight: bold; text-decoration: underline;">981</span>, <span style="font-weight: bold; text-decoration: underline;">1011</span>, <span style="font-weight: bold; text-decoration: underline;">1042</span>, <span style="font-weight: bold; text-decoration: underline;">1073</span>, <span style="font-weight: bold; text-decoration: underline;">1103</span>, <span style="font-weight: bold; text-decoration: underline;">1134</span>, <span style="font-weight: bold; text-decoration: underline;">1164</span>, <span style="font-weight: bold; text-decoration: underline;">1195</span>, <span style="font-weight: bold; text-decoration: underline;">1226</span>, <span style="font-weight: bold; text-decoration: underline;">1256</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>,
         -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>,
         -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>, -<span style="font-weight: bold; text-decoration: underline;">2</span>]
    ],

    <span style="font-weight: bold;">"h_samples"</span>: [<span style="font-weight: bold; text-decoration: underline;">160</span>, <span style="font-weight: bold; text-decoration: underline;">170</span>, <span style="font-weight: bold; text-decoration: underline;">180</span>, <span style="font-weight: bold; text-decoration: underline;">190</span>, <span style="font-weight: bold; text-decoration: underline;">200</span>, <span style="font-weight: bold; text-decoration: underline;">210</span>, <span style="font-weight: bold; text-decoration: underline;">220</span>, <span style="font-weight: bold; text-decoration: underline;">230</span>, <span style="font-weight: bold; text-decoration: underline;">240</span>, <span style="font-weight: bold; text-decoration: underline;">250</span>, <span style="font-weight: bold; text-decoration: underline;">260</span>, <span style="font-weight: bold; text-decoration: underline;">270</span>, <span style="font-weight: bold; text-decoration: underline;">280</span>, <span style="font-weight: bold; text-decoration: underline;">290</span>,
                  <span style="font-weight: bold; text-decoration: underline;">300</span>, <span style="font-weight: bold; text-decoration: underline;">310</span>, <span style="font-weight: bold; text-decoration: underline;">320</span>, <span style="font-weight: bold; text-decoration: underline;">330</span>, <span style="font-weight: bold; text-decoration: underline;">340</span>, <span style="font-weight: bold; text-decoration: underline;">350</span>, <span style="font-weight: bold; text-decoration: underline;">360</span>, <span style="font-weight: bold; text-decoration: underline;">370</span>, <span style="font-weight: bold; text-decoration: underline;">380</span>, <span style="font-weight: bold; text-decoration: underline;">390</span>, <span style="font-weight: bold; text-decoration: underline;">400</span>, <span style="font-weight: bold; text-decoration: underline;">410</span>, <span style="font-weight: bold; text-decoration: underline;">420</span>, <span style="font-weight: bold; text-decoration: underline;">430</span>,
                  <span style="font-weight: bold; text-decoration: underline;">440</span>, <span style="font-weight: bold; text-decoration: underline;">450</span>, <span style="font-weight: bold; text-decoration: underline;">460</span>, <span style="font-weight: bold; text-decoration: underline;">470</span>, <span style="font-weight: bold; text-decoration: underline;">480</span>, <span style="font-weight: bold; text-decoration: underline;">490</span>, <span style="font-weight: bold; text-decoration: underline;">500</span>, <span style="font-weight: bold; text-decoration: underline;">510</span>, <span style="font-weight: bold; text-decoration: underline;">520</span>, <span style="font-weight: bold; text-decoration: underline;">530</span>, <span style="font-weight: bold; text-decoration: underline;">540</span>, <span style="font-weight: bold; text-decoration: underline;">550</span>, <span style="font-weight: bold; text-decoration: underline;">560</span>, <span style="font-weight: bold; text-decoration: underline;">570</span>,
                  <span style="font-weight: bold; text-decoration: underline;">580</span>, <span style="font-weight: bold; text-decoration: underline;">590</span>, <span style="font-weight: bold; text-decoration: underline;">600</span>, <span style="font-weight: bold; text-decoration: underline;">610</span>, <span style="font-weight: bold; text-decoration: underline;">620</span>, <span style="font-weight: bold; text-decoration: underline;">630</span>, <span style="font-weight: bold; text-decoration: underline;">640</span>, <span style="font-weight: bold; text-decoration: underline;">650</span>, <span style="font-weight: bold; text-decoration: underline;">660</span>, <span style="font-weight: bold; text-decoration: underline;">670</span>, <span style="font-weight: bold; text-decoration: underline;">680</span>, <span style="font-weight: bold; text-decoration: underline;">690</span>, <span style="font-weight: bold; text-decoration: underline;">700</span>, <span style="font-weight: bold; text-decoration: underline;">710</span>],

    <span style="font-weight: bold;">"raw_file"</span>: <span style="font-style: italic;">"hello_tusimple.jpg"</span>
}
</pre>
</div>

<p>
上面的 json 显示三条车道线线上的 56 个采样点的坐标, 例如:
</p>

<p>
第一条车道线的点为: (587,260), (611, 270), (600, 280)&#x2026;
第二条车道线的点为: (634,260), (665, 270), (679, 280)&#x2026;
第二条车道线的点为: (685,260), (730, 270), (766, 280)&#x2026;
</p>

<p>
每条 "lane" 中的负数坐标例如 -2 表示该车道线在该位置没有点. 这个样本中每条国道的
前 10 个点都是负数, 意味着图片的上面部分没有车道线, 因为这部分通常是天空背景.
</p>

<p>
tusimple dataset 标注的是车道线上的点的坐标, 但更多的数据集例如 culane
(<a href="https://xingangpan.github.io/projects/CULane.html">https://xingangpan.github.io/projects/CULane.html</a>) 标注的直接是代表图片分割信息
的 png 图片
</p>
</div>
</div>

<div id="outline-container-org383a564" class="outline-3">
<h3 id="org383a564"><span class="section-number-3">1.2</span> Label</h3>
<div class="outline-text-3" id="text-1-2">
<p>
模型的 label 称为 prob_map, 它的格式为: (H, W, class), 用来表示图片中的每个点所
属的 class (背景, 车道线 0, 车道线 1, &#x2026; ), 语义分割模型实际是一个逐像素
(per-pixel) 的分类模型.
</p>

<p>
有的数据集例如 culane 提供的标签直接就是 (H, W, class) 的格式. 由于 tusimple 提
供的是坐标的形式, 需要预处理一下, 这里用了一个有些 trick 的方法:
</p>

<ol class="org-ol">
<li>用 cv2 生成一个全 0 的图片</li>

<li>针对每一条车道线, 用 cv2.line 把点依次连接起来, 而且用车道线的类别的做为 line
color</li>

<li>把图片保存为 png, 即可得到和 culane 同样的标签数据.</li>

<li>训练时用 cv2 读取 png, 但只需要读取 rgb 中的某一个值 (例如 r) 做为该像素的
class label 即可</li>
</ol>
</div>
</div>

<div id="outline-container-orgb478ea9" class="outline-3">
<h3 id="orgb478ea9"><span class="section-number-3">1.3</span> Network</h3>
<div class="outline-text-3" id="text-1-3">

<div id="orgc07f87e" class="figure">
<p><img src="../extra/scnn.png" alt="scnn.png" />
</p>
</div>

<p>
scnn 网络结构分为三部分:
</p>

<ol class="org-ol">
<li>backbone</li>

<li>message_passing</li>

<li>upsample</li>
</ol>
</div>

<div id="outline-container-org1249c9b" class="outline-4">
<h4 id="org1249c9b"><span class="section-number-4">1.3.1</span> backbone</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
backbone 使用 vgg16 的特征提取部分, 但删除 33, 43 层 maxpooling, 因为 pooling 导
致空间信息丢失; 同时替换了最后几层 conv2d 为 dilated conv2d, 因为删除 pooling 会
导致 receptive field 变小, 通过 dilated conv2d 可以增加改善这种情况.
</p>

<p>
关于 pooling 与 semantic segmentation 可以参考: <a href="https://arxiv.org/pdf/1411.4038.pdf">fcn for semantic segmentation</a> 2015/3
</p>

<p>
关于 dilated conv2d 与 semantic segmentation 可以参考: <a href="https://arxiv.org/pdf/1511.07122.pdf">dilated_net</a> 2016/4, <a href="https://arxiv.org/pdf/1606.00915.pdf">deeplab</a> 2017/5
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36755;&#20986; img resize &#20026; [1, 3, 288, 800]</span>
<span style="font-weight: bold; font-style: italic;">x</span> = <span style="font-weight: bold;">self</span>.backbone(img)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 512, 36, 100]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org07e8422" class="outline-4">
<h4 id="org07e8422"><span class="section-number-4">1.3.2</span> message_passing</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">layer1, layer2 &#22522;&#26412;&#37117;&#26159;&#26222;&#36890;&#30340; conv2d</span>
<span style="font-weight: bold; font-style: italic;">x</span> = <span style="font-weight: bold;">self</span>.layer1(x)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 128, 36, 100]</span>
<span style="font-weight: bold; font-style: italic;">x</span> = <span style="font-weight: bold;">self</span>.message_passing_forward(x)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 128, 36, 100]</span>
<span style="font-weight: bold; font-style: italic;">x</span> = <span style="font-weight: bold;">self</span>.layer2(x)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 5, 36, 100]</span>
</pre>
</div>

<p>
message_passing_forward 是 SCNN 最核心的部分, 一共需要做 4 遍 message_passing:
up, down, left, right
</p>

<p>
以 down 为例, 计算步骤:
</p>

<ol class="org-ol">
<li>按 H 方向切成 H 个 (C,1,W) 的 slice</li>
<li>out[0]=slice[0]</li>
<li>out[1]=slice[1]+conv(out[0])</li>
<li>out[2]=slice[2]+conv(out[1])</li>
</ol>
<p>
&#x2026;
</p>

<p>
计算完以后 out shape 和 input shape 是一样的, 因为每一层 slice 时每层使用的 conv
都是使用的同一个 conv, 且:
</p>

<ol class="org-ol">
<li>stride = 1</li>

<li>padding=k//2</li>

<li>k 为奇数</li>
</ol>

<p>
所以 O=(I+2p-k)//s+1=I
</p>

<p>
另外整个过程和 rnn 很像: slice 是 input 序列, out 是 hidden state 序列
</p>

<p>
按论文的说法, 这样操作更容易捕获长条形状的物体 (比如车道线) 或大的物体的空间信息
</p>

<p>
Intuition:
</p>

<p>
为了让 cnn 能捕获大物体的信息, 需要有较大的 receptive field:
</p>

<ol class="org-ol">
<li>通过 pooling</li>
<li>通过更大的 kernel</li>
</ol>

<p>
前者会导致信息丢失, 后者计算量太大
</p>

<p>
SCNN 的作法是通过类似 rnn 的作法让空间中不同位置的信息能传递(合并)在一起, 让网络
能看到整个空间的信息
</p>
</div>
</div>

<div id="outline-container-org0f45c85" class="outline-4">
<h4 id="org0f45c85"><span class="section-number-4">1.3.3</span> upsample</h4>
<div class="outline-text-4" id="text-1-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">interpolate &#22312;&#36825;&#37324;&#26159;&#22312;&#20570; up sampling, 36*8=288, 100*8=800</span>
<span style="font-weight: bold; font-style: italic;">#</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22312; semantic segmentation &#32593;&#32476;&#20013;&#26368;&#21518;&#37117;&#38656;&#35201; up sampling &#25805;&#20316;, &#25165;&#33021;&#29983;&#25104;&#38024;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23545;&#27599;&#20010;&#20687;&#32032;&#30340; prob_map</span>
<span style="font-weight: bold; font-style: italic;">#</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#26242;&#26102;&#24573;&#30053; message_passing_forward &#19981;&#20851;&#27880;, scnn &#23454;&#38469;&#23601;&#26159;&#19981;&#26029;&#30340;&#20570;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">conv2d, &#25226; channel &#38477;&#25104; 5 &#20043;&#21518;, &#20877;&#20570;&#19968;&#20010; up sampling &#24674;&#22797;&#21407;&#22987;&#30340;&#23610;&#23544;</span>
<span style="font-weight: bold; font-style: italic;">#</span>
<span style="font-weight: bold; font-style: italic;">seg_pred</span> = F.interpolate(x, scale_factor=8, mode=<span style="font-style: italic;">"bilinear"</span>, align_corners=<span style="font-weight: bold; text-decoration: underline;">True</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">seg_pred: [1, 5, 288, 800]</span>
<span style="font-weight: bold; font-style: italic;">x</span> = <span style="font-weight: bold;">self</span>.layer3(x)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 5, 18, 50]</span>
<span style="font-weight: bold; font-style: italic;">x</span> = x.view(-1, <span style="font-weight: bold;">self</span>.fc_input_feature)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">x: [1, 4500]</span>
<span style="font-weight: bold; font-style: italic;">exist_pred</span> = <span style="font-weight: bold;">self</span>.fc(x)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">exist_pred: [1, 4]</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1039db9" class="outline-3">
<h3 id="org1039db9"><span class="section-number-3">1.4</span> Inference</h3>
<div class="outline-text-3" id="text-1-4">
<p>
scnn 的输出有两个: seg_pred 和 exist_pred
</p>

<p>
seg_pred: [5, 288, 800], 表示每一个像素所属 class 的概率.
</p>

<p>
0 表示属于 backgroud 的概率, 即这个像素不属于任何一条车道线.
1 表示属于车道线 0 的概率
&#x2026;
4 表示属于车道线 3 的概率, 一共有 4 条车道线
</p>

<p>
exist_pred: [1, 4], 表示检测到有相应车道的概率
</p>

<p>
seg_pred 这种针对所有像素的分类概率叫做 prob_map. lane detection 本质上是一个语
义分割的问题
</p>

<p>
有了 prob_map 后, 那些 argmax(prob_map,axis=0) == 1 的点就是预测出来的车道线 0
上的点
</p>
</div>
</div>

<div id="outline-container-org3337e57" class="outline-3">
<h3 id="org3337e57"><span class="section-number-3">1.5</span> Loss</h3>
<div class="outline-text-3" id="text-1-5">
<p>
scnn 的 loss 基本上就是针对每个像素计算 cross entropy loss 即可
</p>
</div>
</div>
</div>


<div id="outline-container-org01ba7b8" class="outline-2 references">
<h2 id="org01ba7b8">Backlinks</h2>
<div class="outline-text-2" id="text-org01ba7b8">
<p>
<a href="semantic_segmentation.html#ID-f0ab8524-324a-4743-82a4-7f54da6059ba">Semantic Segmentation</a>
(<i>Semantic Segmentation &gt; SCNN</i>):   <a href="scnn.html#ID-4948b51e-2ca0-46a9-817b-05081461b17d">SCNN</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-01-18 Tue 00:00<br />
Last updated: 2022-01-25 Tue 11:48</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
