<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!--  -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DeepLab</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">DeepLab</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000008">1. DeepLab</a>
<ul>
<li><a href="#org0000001">1.1. DeepLabV3 Network</a></li>
<li><a href="#org0000005">1.2. DeepLabV3+ Network</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000008" class="outline-2">
<h2 id="org0000008"><span class="section-number-2">1</span> DeepLab</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://arxiv.org/pdf/1706.05587.pdf">https://arxiv.org/pdf/1706.05587.pdf</a> 2017/12
</p>

<p>
DeepLab 是 google 提出的 semantic segmentation 模型, 最新的模型是 v3 和 v3+, 主
要思想是利用多个不同 dilation rate 的 <a href="cnn.html#ID-5936a1da-7b6d-4a14-82b4-658cbfe62b63">Dilated Conv2D</a> 来融合不同尺度上的特征, 有
点类似于 <a href="dynamic_shaped_network.html#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a>
</p>
</div>

<div id="outline-container-org0000001" class="outline-3">
<h3 id="org0000001"><span class="section-number-3">1.1</span> DeepLabV3 Network</h3>
<div class="outline-text-3" id="text-1-1">

<div id="org0000000" class="figure">
<p><img src="../extra/deeplab.png" alt="deeplab.png" />
</p>
</div>

<ol class="org-ol">
<li>backbone

<ol class="org-ol">
<li>block{1,2,3} 都是 <a href="resnet.html#ID-0c626f98-0eab-4638-b296-268c65207120">resnet</a> 的 block, 并且通过指定 stride = 2 达到 downsample 的
效果, 所以 output stride 依次是 4, 8, 16</li>

<li>block4 没有再做 downsample, 并且使用了 dilation rate = 2 的 dilated conv2d</li>
</ol></li>

<li><p>
ASPP
</p>

<p>
后面接了一个称为 ASPP (Atrous Spatial Pyramid Pooling) 的模块, 它与 SPP 类似,
分别使用 4 个不同 rate 的 dilated conv2d, 每个 conv2d 的输出都是 (h, w, 256)
</p>

<p>
除了 ASPP, 还有一个 Image Pooling 层, 它实际是对 block4 做了一个
<a href="dynamic_shaped_network.html#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">GlobalAveragePooling2D</a> 后再通过 1x1 conv2d 和 bilinear interpolation, 最终也是输
出 (h, w, 256)
</p></li>

<li><p>
upsample
</p>

<p>
ASPP 和 image pooling 按 channel concat 起来, 然后通过 1x1 conv 输出 (h, w,
C), C 为最终的 class 个数. deeplab_v3 最后会使用 bilinear interpolation 实现
的 upsampling 得到最终的输出,但在上面的图中这一步没有画出来.
</p></li>
</ol>

<p>
<a href="https://github.com/leimao/DeepLab-V3/blob/master/model.py">https://github.com/leimao/DeepLab-V3/blob/master/model.py</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_model</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">resnet backbone</span>
    <span style="font-weight: bold; font-style: italic;">feature_map</span> = <span style="font-weight: bold;">self</span>.backbone_initializer(base_architecture)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">aspp</span>
    <span style="font-weight: bold; font-style: italic;">pools</span> = atrous_spatial_pyramid_pooling(inputs=feature_map, filters=256, regularizer=<span style="font-weight: bold;">self</span>.regularizer)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">upsample</span>
    <span style="font-weight: bold; font-style: italic;">logits</span> = tf.layers.conv2d(inputs=pools, filters=<span style="font-weight: bold;">self</span>.num_classes, kernel_size=(1, 1), name=<span style="font-style: italic;">'logits'</span>)
    <span style="font-weight: bold; font-style: italic;">outputs</span> = tf.image.resize_bilinear(images=logits, size=(<span style="font-weight: bold;">self</span>.target_height, <span style="font-weight: bold;">self</span>.target_width), name=<span style="font-style: italic;">'resized_outputs'</span>)

    <span style="font-weight: bold;">return</span> outputs

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">atrous_spatial_pyramid_pooling</span>(inputs, filters=256):
    <span style="font-weight: bold; font-style: italic;">height</span> = tf.shape(inputs)[1]
    <span style="font-weight: bold; font-style: italic;">width</span> = tf.shape(inputs)[2]

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Atrous Spatial Pyramid Pooling</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Atrous 1x1</span>
    <span style="font-weight: bold; font-style: italic;">aspp1x1</span> = tf.layers.conv2d(inputs=inputs, filters=filters, kernel_size=(1, 1), padding=<span style="font-style: italic;">'same'</span>, kernel_regularizer=regularizer, name=<span style="font-style: italic;">'aspp1x1'</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Atrous 3x3, rate = 6</span>
    <span style="font-weight: bold; font-style: italic;">aspp3x3_1</span> = tf.layers.conv2d(inputs=inputs, filters=filters, kernel_size=(3, 3), padding=<span style="font-style: italic;">'same'</span>, dilation_rate=(6, 6), kernel_regularizer=regularizer, name=<span style="font-style: italic;">'aspp3x3_1'</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Atrous 3x3, rate = 12</span>
    <span style="font-weight: bold; font-style: italic;">aspp3x3_2</span> = tf.layers.conv2d(inputs=inputs, filters=filters, kernel_size=(3, 3), padding=<span style="font-style: italic;">'same'</span>, dilation_rate=(12, 12), kernel_regularizer=regularizer, name=<span style="font-style: italic;">'aspp3x3_2'</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Atrous 3x3, rate = 18</span>
    <span style="font-weight: bold; font-style: italic;">aspp3x3_3</span> = tf.layers.conv2d(inputs=inputs, filters=filters, kernel_size=(3, 3), padding=<span style="font-style: italic;">'same'</span>, dilation_rate=(18, 18), kernel_regularizer=regularizer, name=<span style="font-style: italic;">'aspp3x3_3'</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Image Level Pooling</span>
    <span style="font-weight: bold; font-style: italic;">image_feature</span> = tf.reduce_mean(inputs, [1, 2], keepdims=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">image_feature</span> = tf.layers.conv2d(inputs=image_feature, filters=filters, kernel_size=(1, 1), padding=<span style="font-style: italic;">'same'</span>)
    <span style="font-weight: bold; font-style: italic;">image_feature</span> = tf.image.resize_bilinear(images=image_feature, size=[height, width], align_corners=<span style="font-weight: bold; text-decoration: underline;">True</span>, name=<span style="font-style: italic;">'image_pool_feature'</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Merge Poolings</span>
    <span style="font-weight: bold; font-style: italic;">outputs</span> = tf.concat(values=[aspp1x1, aspp3x3_1, aspp3x3_2, aspp3x3_3, image_feature], axis=3, name=<span style="font-style: italic;">'aspp_pools'</span>)
    <span style="font-weight: bold; font-style: italic;">outputs</span> = tf.layers.conv2d(inputs=outputs, filters=filters, kernel_size=(1, 1), padding=<span style="font-style: italic;">'same'</span>, kernel_regularizer=regularizer, name=<span style="font-style: italic;">'aspp_outputs'</span>)

    <span style="font-weight: bold;">return</span> outputs
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000005" class="outline-3">
<h3 id="org0000005"><span class="section-number-3">1.2</span> DeepLabV3+ Network</h3>
<div class="outline-text-3" id="text-1-2">

<div id="org0000004" class="figure">
<p><img src="../extra/deeplab_v3_plus.png" alt="deeplab_v3_plus.png" />
</p>
</div>

<p>
DeepLabV3+ 参考了 <a href="unet.html#ID-568627dd-dea0-42f1-a19e-be76683cb9f6">UNet</a> 的 encoder-decoder 结构:
</p>

<ol class="org-ol">
<li>使用 DeepLabV3 做 encoder</li>

<li>通过一个 decoder 代替了 DeepLabV3 中最后一步 bilinear interpolation</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org000000b" class="outline-2 references">
<h2 id="org000000b">Backlinks</h2>
<div class="outline-text-2" id="text-org000000b">
<p>
<a href="pspnet.html#ID-5ab05d23-629f-4f08-929a-9d52513c1ef4">PSPNet</a>
(<i>PSPNet</i>):  pspnet 是一个 semantic segmentation 模型, 它利用 <a href="dynamic_shaped_network.html#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a> 获得全 局上下文信息. 它的结构与 <a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">DeepLab</a> 非常像: 前者使用不同尺度的 pooling 叠加, 后者使 用不同尺度的 dilation conv 叠加.
</p>

<p>
<a href="semantic_segmentation.html#ID-f0ab8524-324a-4743-82a4-7f54da6059ba">Semantic Segmentation</a>
(<i>Semantic Segmentation &gt; Overview</i>):      - (c) 并行的输入或中间层的融合, 例如 <a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">deeplab</a>, <a href="pspnet.html#ID-5ab05d23-629f-4f08-929a-9d52513c1ef4">pspnet</a>, <a href="icnet.html#ID-451151a7-0b4e-48c2-a99c-28b78f58aea9">icnet</a>
</p>

<p>
<a href="semantic_segmentation.html#ID-f0ab8524-324a-4743-82a4-7f54da6059ba">Semantic Segmentation</a>
(<i>Semantic Segmentation &gt; DeepLab</i>):   <a href="deeplab.html#ID-976a44ab-2450-49ba-8f7b-8f257a3af005">DeepLab</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: <br />
Last updated: </p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
