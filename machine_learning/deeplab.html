<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 二 15:53 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DeepLab</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">DeepLab</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0b06c99">1. DeepLab</a>
<ul>
<li><a href="#org94eb278">1.1. DeepLabV3 Network</a></li>
<li><a href="#orgd81493f">1.2. DeepLabV3+ Network</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0b06c99" class="outline-2">
<h2 id="org0b06c99"><span class="section-number-2">1</span> DeepLab</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://arxiv.org/pdf/1706.05587.pdf">https://arxiv.org/pdf/1706.05587.pdf</a> 2017/12
</p>

<p>
DeepLab 是 google 提出的 <a href="semantic_segmentation.html#ID-f0ab8524-324a-4743-82a4-7f54da6059ba">Semantic Segmentation</a> 模型, 最新的模型是 v3 和 v3+, 主要思想是利用多个不同 dilation rate 的 dilated conv2d 来融合不同尺度上的特征, 有点类似于 <a href="dynamic_shaped_network.html#ID-8391e6de-fb63-453a-a451-f2730baec121">Spatial Pyramid Pooling</a>
</p>
</div>

<div id="outline-container-org94eb278" class="outline-3">
<h3 id="org94eb278"><span class="section-number-3">1.1</span> DeepLabV3 Network</h3>
<div class="outline-text-3" id="text-1-1">

<div id="org7f82d64" class="figure">
<p><img src="../extra/deeplab.png" alt="deeplab.png" />
</p>
</div>

<ol class="org-ol">
<li>backbone

<ol class="org-ol">
<li>block{1,2,3} 都是 resnet 的 block, 并且通过指定 stride = 2 达到 downsample 的效果, 所以 output stride 依次是 4, 8, 16</li>

<li>block4 没有再做 downsample, 并且使用了 dilation rate = 2 的 dilated conv2d</li>
</ol></li>

<li><p>
ASPP
</p>

<p>
后面接了一个称为 ASPP (Atrous Spatial Pyramid Pooling) 的模块, 它与 SPP 类似,
分别使用 4 个不同 rate 的 dilated conv2d, 每个 conv2d 的输出都是 (h, w, 256)
</p>

<p>
除了 ASPP, 还有一个 Image Pooling 层, 它实际是对 block4 做了一个
<a href="dynamic_shaped_network.html#ID-f70d117b-3974-43d2-b082-a08c58cc87f5">GlobalAveragePooling2D</a> 后再通过 1x1 conv2d 和 bilinear interpolation, 最终也是输出 (h, w, 256)
</p></li>

<li><p>
upsample
</p>

<p>
ASPP 和 image pooling 按 channel concat 起来, 然后通过 1x1 conv 输出 (h, w,
C), C 为最终的 class 个数. deeplab_v3 最后会使用 bilinear interpolation 实现的 upsampling 得到最终的输出,但在上面的图中这一步没有画出来.
</p></li>
</ol>

<p>
<a href="https://github.com/leimao/DeepLab-V3/blob/master/model.py">https://github.com/leimao/DeepLab-V3/blob/master/model.py</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">get_model</span><span style="color: #757575;">()</span>:
    <span style="color: #586e75;"># </span><span style="color: #586e75;">resnet backbone</span>
    <span style="color: #268bd2;">feature_map</span> = <span style="color: #859900;">self</span>.backbone_initializer<span style="color: #757575;">(</span>base_architecture<span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">aspp</span>
    <span style="color: #268bd2;">pools</span> = atrous_spatial_pyramid_pooling<span style="color: #757575;">(</span>inputs=feature_map<span style="color: #757575;">,</span> filters=256<span style="color: #757575;">,</span> regularizer=<span style="color: #859900;">self</span>.regularizer<span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">upsample</span>
    <span style="color: #268bd2;">logits</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=pools<span style="color: #757575;">,</span> filters=<span style="color: #859900;">self</span>.num_classes<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">),</span> name=<span style="color: #2aa198;">'logits'</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">outputs</span> = tf.image.resize_bilinear<span style="color: #757575;">(</span>images=logits<span style="color: #757575;">,</span> size=<span style="color: #757575;">(</span><span style="color: #859900;">self</span>.target_height<span style="color: #757575;">,</span> <span style="color: #859900;">self</span>.target_width<span style="color: #757575;">),</span> name=<span style="color: #2aa198;">'resized_outputs'</span><span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> outputs

<span style="color: #859900;">def</span> <span style="color: #268bd2;">atrous_spatial_pyramid_pooling</span><span style="color: #757575;">(</span>inputs<span style="color: #757575;">,</span> filters=256<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">height</span> = tf.shape<span style="color: #757575;">(</span>inputs<span style="color: #757575;">)</span>[1]
    <span style="color: #268bd2;">width</span> = tf.shape<span style="color: #757575;">(</span>inputs<span style="color: #757575;">)</span>[2]

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Atrous Spatial Pyramid Pooling</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Atrous 1x1</span>
    <span style="color: #268bd2;">aspp1x1</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=inputs<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">,</span> kernel_regularizer=regularizer<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp1x1'</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Atrous 3x3, rate = 6</span>
    <span style="color: #268bd2;">aspp3x3_1</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=inputs<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>3<span style="color: #757575;">,</span> 3<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">,</span> dilation_rate=<span style="color: #757575;">(</span>6<span style="color: #757575;">,</span> 6<span style="color: #757575;">),</span> kernel_regularizer=regularizer<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp3x3_1'</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Atrous 3x3, rate = 12</span>
    <span style="color: #268bd2;">aspp3x3_2</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=inputs<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>3<span style="color: #757575;">,</span> 3<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">,</span> dilation_rate=<span style="color: #757575;">(</span>12<span style="color: #757575;">,</span> 12<span style="color: #757575;">),</span> kernel_regularizer=regularizer<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp3x3_2'</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Atrous 3x3, rate = 18</span>
    <span style="color: #268bd2;">aspp3x3_3</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=inputs<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>3<span style="color: #757575;">,</span> 3<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">,</span> dilation_rate=<span style="color: #757575;">(</span>18<span style="color: #757575;">,</span> 18<span style="color: #757575;">),</span> kernel_regularizer=regularizer<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp3x3_3'</span><span style="color: #757575;">)</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Image Level Pooling</span>
    <span style="color: #268bd2;">image_feature</span> = tf.reduce_mean<span style="color: #757575;">(</span>inputs<span style="color: #757575;">,</span> [1<span style="color: #757575;">,</span> 2]<span style="color: #757575;">,</span> keepdims=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">image_feature</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=image_feature<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">image_feature</span> = tf.image.resize_bilinear<span style="color: #757575;">(</span>images=image_feature<span style="color: #757575;">,</span> size=[height<span style="color: #757575;">,</span> width]<span style="color: #757575;">,</span> align_corners=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'image_pool_feature'</span><span style="color: #757575;">)</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Merge Poolings</span>
    <span style="color: #268bd2;">outputs</span> = tf.concat<span style="color: #757575;">(</span>values=[aspp1x1<span style="color: #757575;">,</span> aspp3x3_1<span style="color: #757575;">,</span> aspp3x3_2<span style="color: #757575;">,</span> aspp3x3_3<span style="color: #757575;">,</span> image_feature]<span style="color: #757575;">,</span> axis=3<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp_pools'</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">outputs</span> = tf.layers.conv2d<span style="color: #757575;">(</span>inputs=outputs<span style="color: #757575;">,</span> filters=filters<span style="color: #757575;">,</span> kernel_size=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">),</span> padding=<span style="color: #2aa198;">'same'</span><span style="color: #757575;">,</span> kernel_regularizer=regularizer<span style="color: #757575;">,</span> name=<span style="color: #2aa198;">'aspp_outputs'</span><span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> outputs
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd81493f" class="outline-3">
<h3 id="orgd81493f"><span class="section-number-3">1.2</span> DeepLabV3+ Network</h3>
<div class="outline-text-3" id="text-1-2">

<div id="orgafe4552" class="figure">
<p><img src="../extra/deeplab_v3_plus.png" alt="deeplab_v3_plus.png" />
</p>
</div>

<p>
DeepLabV3+ 参考了 <a href="unet.html#ID-568627dd-dea0-42f1-a19e-be76683cb9f6">UNet</a> 的 encoder-decoder 结构:
</p>

<ol class="org-ol">
<li>使用 DeepLabV3 做 encoder</li>

<li>通过一个 decoder 代替了 DeepLabV3 中最后一步 bilinear interpolation</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-01-19 三 00:00<br />
Last updated: 2022-01-25 二 13:51</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
