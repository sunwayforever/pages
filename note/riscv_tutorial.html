<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>RISC-V Tutorial</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">RISC-V Tutorial</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000012">1. RISC-V Tutorial</a>
<ul>
<li><a href="#org000001a">1.1. Setup Environment</a>
<ul>
<li><a href="#org0000001">1.1.1. Install Toolchain</a></li>
<li><a href="#org0000017">1.1.2. Build &amp; Run</a></li>
</ul>
</li>
<li><a href="#org000000f">1.2. RISC Assembly</a>
<ul>
<li><a href="#org000001e">1.2.1. Overview</a></li>
<li><a href="#org0000033">1.2.2. RV32I</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000012" class="outline-2">
<h2 id="org0000012"><span class="section-number-2">1</span> RISC-V Tutorial</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org000001a" class="outline-3">
<h3 id="org000001a"><span class="section-number-3">1.1</span> Setup Environment</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000001" class="outline-4">
<h4 id="org0000001"><span class="section-number-4">1.1.1</span> Install Toolchain</h4>
<div class="outline-text-4" id="text-1-1-1">
<pre class="example" id="org0000000">
$&gt; sudo apt install gcc-riscv64-linux-gnu
$&gt; sudo apt install qemu-user
$&gt; sudo ln -s /usr/riscv64-linux-gnu/lib/ld-linux-riscv64-lp64d.so.1 /lib
</pre>
</div>
</div>

<div id="outline-container-org0000017" class="outline-4">
<h4 id="org0000017"><span class="section-number-4">1.1.2</span> Build &amp; Run</h4>
<div class="outline-text-4" id="text-1-1-2">
</div>
<div id="outline-container-org0000005" class="outline-5">
<h5 id="org0000005"><span class="section-number-5">1.1.2.1</span> C</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<pre class="example" id="org0000004">
$&gt; riscv64-linux-gnu-gcc test.c -Wl,-rpath,/usr/riscv64-linux-gnu/lib/
$&gt; ./a.out
hello
</pre>
</div>
</div>

<div id="outline-container-org0000010" class="outline-5">
<h5 id="org0000010"><span class="section-number-5">1.1.2.2</span> ASM</h5>
<div class="outline-text-5" id="text-1-1-2-2">
</div>
<div id="outline-container-org0000009" class="outline-6">
<h6 id="org0000009"><span class="section-number-6">1.1.2.2.1</span> nostdlib</h6>
<div class="outline-text-6" id="text-1-1-2-2-1">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc ./test.s -nostdlib -static
    ## or riscv64-linux-gnu-as ./test.s -o test.o &amp;&amp; riscv64-linux-gnu-ld ./test.o -o ./a.out

    <span class="org-keyword">.global</span> _start

<span class="org-function-name">_start</span>:
    <span class="org-keyword">addi</span>  a0, x0, 1
    <span class="org-keyword">la</span>    a1, helloworld 
    <span class="org-keyword">addi</span>  a2, x0, 13
    ## &#22240;&#20026;&#26159;&#29992; qemu + linux &#26469;&#25191;&#34892;, &#25152;&#20197;&#36825;&#37324;&#20351;&#29992;&#30340;&#26159; linux &#30340; syscall num
    ## 64 &#26159; write, 93 &#26159; exit
    <span class="org-keyword">addi</span>  a7, x0, 64 
    <span class="org-keyword">ecall</span> 

    <span class="org-keyword">addi</span>    a0, x0, 0
    <span class="org-keyword">addi</span>    a7, x0, 93
    <span class="org-keyword">ecall</span> 

    <span class="org-keyword">.data</span>
<span class="org-function-name">helloworld</span>:      .ascii <span class="org-string">"Hello World!\n"</span>

</pre>
</div>

<pre class="example" id="org0000008">
Hello World!
</pre>
</div>
</div>

<div id="outline-container-org000000d" class="outline-6">
<h6 id="org000000d"><span class="section-number-6">1.1.2.2.2</span> stdlib</h6>
<div class="outline-text-6" id="text-1-1-2-2-2">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> a0, helloworld
    <span class="org-keyword">li</span> a1, 10
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">helloworld</span>:      .ascii <span class="org-string">"Hello World: %d!\n"</span>

</pre>
</div>

<pre class="example" id="org000000c">
Hello World: 10!
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000014" class="outline-5">
<h5 id="org0000014"><span class="section-number-5">1.1.2.3</span> Debug with QEMU GDB Server</h5>
<div class="outline-text-5" id="text-1-1-2-3">
<pre class="example" id="org0000013">
$&gt; qemu-riscv64 -g 12345  ./a.out

;; in another shell
$&gt; gdb-multiarch ./a.out
(gdb) target remote localhost 12345
Remote debugging using localhost:12345
_start () at test.s:7
7           addi  a0, x0, 1
</pre>

<p>
or use a simple wrapper script:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="org-keyword">if</span> [[ $<span class="org-variable-name">#</span> == 0 ]]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"usage qemu-gdb.sh &lt;exec&gt;"</span>
    <span class="org-keyword">exit</span> 1
<span class="org-keyword">fi</span>

<span class="org-variable-name">app</span>=$<span class="org-variable-name">1</span>

cat &gt;/tmp/gdb.cmds &lt;&lt;hello
<span class="org-sh-heredoc">target remote localhost:12345</span>
<span class="org-sh-heredoc">hello</span>

qemu-riscv64 -g 12345  ./a.out &amp;
<span class="org-variable-name">qemu_pid</span>=$<span class="org-variable-name">!</span>
gdb-multiarch $<span class="org-variable-name">app</span> -x /tmp/gdb.cmds
<span class="org-builtin">kill</span> -9 $<span class="org-variable-name">qemu_pid</span> &amp;&gt;/dev/null
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org000000f" class="outline-3">
<h3 id="org000000f"><span class="section-number-3">1.2</span> RISC Assembly</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org000001e" class="outline-4">
<h4 id="org000001e"><span class="section-number-4">1.2.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
RSIC ISA 同一个基础指令集 RV32I 和一系列的扩展指令集组成:
</p>

<ul class="org-ul">
<li>RV32I 针对整数操作的 ISA, 47 条指令</li>
<li>RV32M 乘法和除法, 8 条</li>
<li>RV32F 单精度浮点数, 32 条</li>
<li>RV32D 双精度浮点数, 32 条</li>
<li>RV32A 原子操作, 11 条</li>
</ul>

<p>
以上所有加起来称为 RV32G, 除此以外, 还有额外两个扩展:
</p>

<ul class="org-ul">
<li>RV32C 指令压缩</li>
<li>RV32V 向量操作</li>
</ul>

<p>
RISC-V 共定义了 32 个寄存器:
</p>


<div id="org000001d" class="figure">
<p><img src="../extra/riscv_reg.png" alt="riscv_reg.png" />
</p>
</div>

<p>
其中:
</p>

<ul class="org-ul">
<li>zero 始终为 0, 可以用来实现一些其它指令, 例如 addi t0, zero, 0x1 相当于给 t0
赋值为 1</li>
<li>ra 是 return address, 函数返回时默认返回地址在 ra, 通过 jalr zero, 0(ra) 返回</li>
<li>a0&#x2026;a7 做为函数参数, 同时 a0&#x2026;a1 做为函数返回值</li>
<li>t0&#x2026;t6 是 caller saved 通用寄存器</li>
<li>s1&#x2026;s11 是 callee saved 通用寄存器</li>
<li>fp, sp</li>
</ul>
</div>
</div>

<div id="outline-container-org0000033" class="outline-4">
<h4 id="org0000033"><span class="section-number-4">1.2.2</span> RV32I</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<div id="outline-container-org0000029" class="outline-5">
<h5 id="org0000029"><span class="section-number-5">1.2.2.1</span> Overview</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<p>
RV32I 共 47 条指令, 分为 6 种格式:
</p>


<div id="org0000021" class="figure">
<p><img src="../extra/riscv_format.png" alt="riscv_format.png" />
</p>
</div>

<ol class="org-ol">
<li><p>
R, register-register
</p>

<p>
R 指令需要三个操作数: rd(dest), rs1(op1), rs2(op2)
</p>

<p>
以 add 为例:
</p>

<pre class="example" id="org0000022">
7       5     5   3   5  7
------------------------------   
0000000 rs2   rs1 000 rd 0110011
------------------------------
        op1   op2     dest

rd = rs1 + rs2
</pre></li>

<li><p>
I, intermediate
</p>

<p>
I 指令需要三个操作数: rd, rs1, imm
</p>

<p>
I 指令包含 imm 和 load 两种操作, 因为两者的用法类似:
</p>

<ul class="org-ul">
<li>imm: rd(dest), rs1(op1), imm (op2)</li>

<li>load: rd(dest), rs1(base), imm(offset)</li>
</ul>

<p>
addi:
</p>

<pre class="example" id="org0000023">
12          5   3     5     7
------------------------------
imm[11:0]   rs1 000   rd    0010011
------------------------------
op1         op2       dest 

rd = rs1 + imm
</pre>

<p>
lw:
</p>

<pre class="example" id="org0000024">
imm[11:0]   rs1   010   rd    0000011
-------------------------------------
offset      base        dest 

rd = imm(rs1)
</pre></li>

<li><p>
S, store
</p>

<p>
S 指令需要 3 个操作数: rs1(src), rs2(base), imm(offset)
</p>

<p>
以 sw 为例:
</p>

<pre class="example" id="org0000025">
7              5     5   3   5        7 
---------------------------------------------
imm[11:5]      rs2   rs1 010 imm[4:0] 0100011
---------------------------------------------
offset[11:5]   src   base    offset[4:0]

imm[base] = rs2
</pre></li>

<li><p>
B, branch
</p>

<p>
B 指令和 S 格式基本相同, 只是 imm 部分 bit 分配有些不同.
</p>

<p>
rs1 (op1), rs2 (op2), imm (offset)
</p>

<p>
以 blt 为例:
</p>

<pre class="example" id="org0000026">
imm[12|10:5] rs2 rs1 100 imm[4:1|11] 1100011

if rs1 &lt; rs2: pc+=imm
</pre></li>

<li><p>
U, upper intermediate
</p>

<p>
U 指令只处理 imm 的高 20 bit, 只有两个操作数 rd (dest), imm
</p>

<p>
lui:
</p>

<pre class="example" id="org0000027">
imm[31:12] rd 0110111

rd[31:12]=imm, 即 rd 的高 20 位被赋值为 imm 的高 20 bit
</pre></li>

<li><p>
J, jump
</p>

<p>
J 指令与 U 指令格式基本相同
</p>

<p>
jal:
</p>

<pre class="example" id="org0000028">
imm[20|10:1|11|19:12] rd 1101111

rd = pc + 4
pc += imm*2
</pre></li>
</ol>
</div>
</div>

<div id="outline-container-org0000030" class="outline-5">
<h5 id="org0000030"><span class="section-number-5">1.2.2.2</span> Sample</h5>
<div class="outline-text-5" id="text-1-2-2-2">
</div>
<div id="outline-container-org000002d" class="outline-6">
<h6 id="org000002d"><span class="section-number-6">1.2.2.2.1</span> I-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-2-2-1">
<p>
I 类型指令都是 `xxx rd, rs1, imm` 的形式, 其中 imm 12 bit, 包含以下指令:
</p>

<ul class="org-ul">
<li>addi</li>
<li>slti, sltiu</li>
<li>andi, ori, xori</li>
<li>slli, srli, srai</li>
<li>lw, lh, lb</li>
<li>jalr</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## ------ addi (add imm) ------
    <span class="org-keyword">la</span> a0, addi_msg
    ## i &#25351;&#20196;&#30340; imm &#26159; 12 bit, &#33539;&#22260;&#26159; -2048, 2047, &#36229;&#36807;&#20250;&#32534;&#35793;&#19981;&#36807;
    ## a1 = zero + (-2048)
    <span class="org-keyword">addi</span> a1, zero, -2048
    <span class="org-keyword">jal</span> printf

    ## ------ slti (set less than imm), sltiu (set less than imm unsigned) ------
    <span class="org-keyword">la</span> a0, slti_msg
    <span class="org-keyword">li</span> t0, 1023
    ## &#24403; t0 &lt; 1024 &#26102;, a1 = 1, &#21542;&#21017; a1 = 0
    <span class="org-keyword">slti</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">la</span> a0, slti_msg
    <span class="org-keyword">li</span> t0, 1024
    <span class="org-keyword">slti</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">la</span> a0, sltiu_msg
    <span class="org-keyword">li</span> t0, -1
    ## &#24403; (unsiged)t0 &lt; (unsigned)1024 &#26102;, a1 = 1, &#21542;&#21017; a1 = 0
    <span class="org-keyword">sltu</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    ## ------ andi, ori, xori ------
    <span class="org-keyword">la</span> a0, and_or_xor_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">andi</span> a1, t0, 0x01
    <span class="org-keyword">ori</span> a2, t0, 0x01
    <span class="org-keyword">xori</span> a3, t0, 0x01
    <span class="org-keyword">jal</span> printf

    ## ------ slli (shift left logical imm) ------
    ## ------ srli (shift right logical imm) ------
    ## ------ srai (shift right arithmetic imm) ------
    <span class="org-keyword">la</span> a0, shift_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">slli</span> a1, t0, 4
    <span class="org-keyword">srli</span> a2, t0, 4
    <span class="org-keyword">li</span> t0, -0x11
    <span class="org-keyword">srli</span> a3, t0, 4
    <span class="org-keyword">srai</span> a4, t0, 4
    <span class="org-keyword">jal</span> printf

    ## ------ load: lw, lh, lb ------
    <span class="org-keyword">la</span> a0, load_msg
    <span class="org-keyword">la</span> t0, load_data
    <span class="org-keyword">lw</span> a1, 0(t0)
    <span class="org-keyword">lh</span> a2, 4(t0)
    <span class="org-keyword">lb</span> a3, 6(t0)
    <span class="org-keyword">lb</span> a4, 7(t0)
    <span class="org-keyword">jal</span> ra, printf

    ## ------ jalr ------
    <span class="org-keyword">call</span> jalr_test

    ## return
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

<span class="org-function-name">jalr_test</span>:
    ## jalr &#24120;&#29992;&#26469;&#20174;&#20989;&#25968;&#20013;&#36820;&#22238;, &#30456;&#24403;&#20110; rd=pc+4<span class="org-comment-delimiter">; </span><span class="org-comment">pc=offset(rs1)</span>
    <span class="org-keyword">jalr</span> zero, 0(ra)

    <span class="org-keyword">.data</span>
<span class="org-function-name">addi_msg</span>:      .asciz <span class="org-string">"addi: %d\n"</span>
<span class="org-function-name">slti_msg</span>:      .asciz <span class="org-string">"slti: %d\n"</span>
<span class="org-function-name">sltiu_msg</span>:     .asciz <span class="org-string">"sltiu: %d\n"</span>
<span class="org-function-name">and_or_xor_msg</span>:     .asciz <span class="org-string">"and_or_xor: 0x%x, 0x%x, 0x%x\n"</span>
<span class="org-function-name">shift_msg</span>:     .asciz <span class="org-string">"slli: 0x%x, srli: 0x%x, negative: srli: %lld srai: %lld\n"</span>
<span class="org-function-name">load_msg</span>:       .asciz <span class="org-string">"load: %d, %d, %d, %d\n"</span>
<span class="org-function-name">load_data</span>:
    <span class="org-keyword">.word</span> 1
    <span class="org-keyword">.half</span> 2
    <span class="org-keyword">.byte</span> 3
    <span class="org-keyword">.byte</span> 4

</pre>
</div>

<pre class="example" id="org000002c">
addi: -2048
slti: 1
slti: 0
sltiu: 0
and_or_xor: 0x1, 0x11, 0x10
slli: 0x110, srli: 0x1, negative: srli: 1152921504606846974 srai: -2
load: 1, 2, 3, 4
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-02-08 Tue 15:30<br />
Last updated: 2022-02-09 Wed 18:40</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
