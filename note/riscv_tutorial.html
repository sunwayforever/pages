<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>RISC-V Tutorial</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">RISC-V Tutorial</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000012">1. RISC-V Tutorial</a>
<ul>
<li><a href="#org000001d">1.1. Setup Environment</a>
<ul>
<li><a href="#org0000001">1.1.1. Install Toolchain</a></li>
<li><a href="#org000001a">1.1.2. Build &amp; Run</a></li>
</ul>
</li>
<li><a href="#org000000f">1.2. RISC Assembly</a>
<ul>
<li><a href="#org000002f">1.2.1. Overview</a></li>
<li><a href="#org0000021">1.2.2. Register</a></li>
<li><a href="#org0000047">1.2.3. RV32I</a></li>
<li><a href="#org000004c">1.2.4. Pseudo Instruction</a></li>
<li><a href="#org0000053">1.2.5. Demo</a></li>
</ul>
</li>
<li><a href="#org0000062">1.3. GNU Assembler</a></li>
<li><a href="#org000008a">1.4. Standard Extention</a>
<ul>
<li><a href="#org0000066">1.4.1. RV32M</a></li>
<li><a href="#org0000068">1.4.2. RV32F and RV32D</a></li>
<li><a href="#org000006b">1.4.3. RV32A</a></li>
<li><a href="#org000006e">1.4.4. RV32C</a></li>
<li><a href="#org0000071">1.4.5. RV32V</a></li>
<li><a href="#org0000074">1.4.6. RV64G</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000012" class="outline-2">
<h2 id="org0000012"><span class="section-number-2">1</span> RISC-V Tutorial</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org000001d" class="outline-3">
<h3 id="org000001d"><span class="section-number-3">1.1</span> Setup Environment</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000001" class="outline-4">
<h4 id="org0000001"><span class="section-number-4">1.1.1</span> Install Toolchain</h4>
<div class="outline-text-4" id="text-1-1-1">
<pre class="example" id="org0000000">
$&gt; sudo apt install gcc-riscv64-linux-gnu
$&gt; sudo apt install qemu-user
$&gt; sudo ln -s /usr/riscv64-linux-gnu/lib/ld-linux-riscv64-lp64d.so.1 /lib
</pre>
</div>
</div>

<div id="outline-container-org000001a" class="outline-4">
<h4 id="org000001a"><span class="section-number-4">1.1.2</span> Build &amp; Run</h4>
<div class="outline-text-4" id="text-1-1-2">
</div>
<div id="outline-container-org0000005" class="outline-5">
<h5 id="org0000005"><span class="section-number-5">1.1.2.1</span> C</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<pre class="example" id="org0000004">
$&gt; riscv64-linux-gnu-gcc test.c -Wl,-rpath,/usr/riscv64-linux-gnu/lib/
$&gt; ./a.out
hello
</pre>
</div>
</div>

<div id="outline-container-org0000010" class="outline-5">
<h5 id="org0000010"><span class="section-number-5">1.1.2.2</span> ASM</h5>
<div class="outline-text-5" id="text-1-1-2-2">
</div>
<div id="outline-container-org0000009" class="outline-6">
<h6 id="org0000009"><span class="section-number-6">1.1.2.2.1</span> nostdlib</h6>
<div class="outline-text-6" id="text-1-1-2-2-1">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc ./test.s -nostdlib -static
    ## or riscv64-linux-gnu-as ./test.s -o test.o &amp;&amp; riscv64-linux-gnu-ld ./test.o -o ./a.out

    <span class="org-keyword">.global</span> _start

<span class="org-function-name">_start</span>:
    <span class="org-keyword">addi</span>  a0, x0, 1
    <span class="org-keyword">la</span>    a1, helloworld 
    <span class="org-keyword">addi</span>  a2, x0, 13
    ## &#22240;&#20026;&#26159;&#29992; qemu + linux &#26469;&#25191;&#34892;, &#25152;&#20197;&#36825;&#37324;&#20351;&#29992;&#30340;&#26159; linux &#30340; syscall num
    ## 64 &#26159; write, 93 &#26159; exit
    <span class="org-keyword">addi</span>  a7, x0, 64 
    <span class="org-keyword">ecall</span> 

    <span class="org-keyword">addi</span>    a0, x0, 0
    <span class="org-keyword">addi</span>    a7, x0, 93
    <span class="org-keyword">ecall</span> 

    <span class="org-keyword">.data</span>
<span class="org-function-name">helloworld</span>:      .ascii <span class="org-string">"Hello World!\n"</span>

</pre>
</div>

<pre class="example" id="org0000008">
Hello World!
</pre>
</div>
</div>

<div id="outline-container-org000000d" class="outline-6">
<h6 id="org000000d"><span class="section-number-6">1.1.2.2.2</span> stdlib</h6>
<div class="outline-text-6" id="text-1-1-2-2-2">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> a0, helloworld
    <span class="org-keyword">li</span> a1, 10
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">helloworld</span>:      .ascii <span class="org-string">"Hello World: %d!\n"</span>

</pre>
</div>

<pre class="example" id="org000000c">
Hello World: 10!
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000014" class="outline-5">
<h5 id="org0000014"><span class="section-number-5">1.1.2.3</span> Debug with QEMU GDB Server</h5>
<div class="outline-text-5" id="text-1-1-2-3">
<pre class="example" id="org0000013">
$&gt; qemu-riscv64 -g 12345  ./a.out

;; in another shell
$&gt; gdb-multiarch ./a.out
(gdb) target remote localhost 12345
Remote debugging using localhost:12345
_start () at test.s:7
7           addi  a0, x0, 1
</pre>

<p>
or use a simple wrapper script:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="org-keyword">if</span> [[ $<span class="org-variable-name">#</span> == 0 ]]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"usage qemu-gdb.sh &lt;exec&gt;"</span>
    <span class="org-keyword">exit</span> 1
<span class="org-keyword">fi</span>

<span class="org-variable-name">app</span>=$<span class="org-variable-name">1</span>

cat &gt;/tmp/gdb.cmds &lt;&lt;hello
<span class="org-sh-heredoc">target remote localhost:12345</span>
<span class="org-sh-heredoc">hello</span>

qemu-riscv64 -g 12345  ./a.out &amp;
<span class="org-variable-name">qemu_pid</span>=$<span class="org-variable-name">!</span>
gdb-multiarch $<span class="org-variable-name">app</span> -x /tmp/gdb.cmds
<span class="org-builtin">kill</span> -9 $<span class="org-variable-name">qemu_pid</span> &amp;&gt;/dev/null
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000017" class="outline-5">
<h5 id="org0000017"><span class="section-number-5">1.1.2.4</span> Debug with Spike</h5>
<div class="outline-text-5" id="text-1-1-2-4">
<p>
<a href="https://github.com/riscv-software-src/riscv-isa-sim">https://github.com/riscv-software-src/riscv-isa-sim</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org000000f" class="outline-3">
<h3 id="org000000f"><span class="section-number-3">1.2</span> RISC Assembly</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<a href="https://riscv.org/technical/specifications/">https://riscv.org/technical/specifications/</a>
</p>

<p>
<a href="http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf">http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf</a>
</p>
</div>

<div id="outline-container-org000002f" class="outline-4">
<h4 id="org000002f"><span class="section-number-4">1.2.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
RSIC ISA 由一个基础指令集 RV32I 和一系列的扩展指令集组成:
</p>

<ul class="org-ul">
<li>RV32I 针对整数操作的 ISA, 47 条指令</li>
<li>RV32M 乘法和除法, 8 条</li>
<li>RV32F 单精度浮点数, 32 条</li>
<li>RV32D 双精度浮点数, 32 条</li>
<li>RV32A 原子操作, 11 条</li>
</ul>

<p>
以上所有加起来称为 RV32G, 除此以外, 还有额外两个扩展:
</p>

<ul class="org-ul">
<li>RV32C 指令压缩</li>
<li>RV32V 向量操作</li>
</ul>
</div>
</div>

<div id="outline-container-org0000021" class="outline-4">
<h4 id="org0000021"><span class="section-number-4">1.2.2</span> Register</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
RISC-V 共定义了 32 个寄存器:
</p>


<div id="org0000023" class="figure">
<p><img src="../extra/riscv_reg.png" alt="riscv_reg.png" />
</p>
</div>

<p>
其中:
</p>

<ul class="org-ul">
<li>zero 始终为 0, 可以用来实现一些其它指令, 例如 addi t0, zero, 0x1 相当于给 t0
赋值为 1</li>
<li>ra 是 return address, 函数返回时默认返回地址在 ra, 通过 jalr zero, 0(ra) 返回</li>
<li>a0&#x2026;a7 做为函数参数, 同时 a0&#x2026;a1 做为函数返回值</li>
<li>t0&#x2026;t6 是 caller saved 通用寄存器</li>
<li>s1&#x2026;s11 是 callee saved 通用寄存器</li>
<li>fp, sp</li>
</ul>
</div>
</div>


<div id="outline-container-org0000047" class="outline-4">
<h4 id="org0000047"><span class="section-number-4">1.2.3</span> RV32I</h4>
<div class="outline-text-4" id="text-1-2-3">
</div>
<div id="outline-container-org0000030" class="outline-5">
<h5 id="org0000030"><span class="section-number-5">1.2.3.1</span> Overview</h5>
<div class="outline-text-5" id="text-1-2-3-1">
<p>
RV32I 共 47 条指令, 长度均为 32bit, 分为 6 种格式:
</p>


<div id="org0000027" class="figure">
<p><img src="../extra/riscv_format.png" alt="riscv_format.png" />
</p>
</div>

<p>
所有指令都是 `两个 reg + 12 位 imm` 或 `1 个 reg + 20 位 imm` 的形式
</p>

<ol class="org-ol">
<li><p>
I, intermediate
</p>

<p>
I 指令需要三个操作数: rd, rs1, imm
</p>

<p>
I 指令包含 imm 和 load 两种操作, 因为两者的用法类似:
</p>

<ul class="org-ul">
<li>imm: rd(dest), rs1(op1), imm (op2)</li>

<li>load: rd(dest), rs1(base), imm(offset)</li>
</ul>

<p>
addi:
</p>

<pre class="example" id="org0000028">
12          5   3     5     7
------------------------------
imm[11:0]   rs1 000   rd    0010011
------------------------------
op1         op2       dest 
</pre>

<p>
lw:
</p>

<pre class="example" id="org0000029">
imm[11:0]   rs1   010   rd    0000011
-------------------------------------
offset      base        dest 
</pre></li>

<li><p>
R, register-register
</p>

<p>
R 指令需要三个操作数: rd(dest), rs1(op1), rs2(op2)
</p>

<p>
以 add 为例:
</p>

<pre class="example" id="org000002a">
7       5     5   3   5  7
------------------------------   
0000000 rs2   rs1 000 rd 0110011
------------------------------
        op1   op2     dest
</pre></li>

<li><p>
S, store
</p>

<p>
S 指令需要 3 个操作数: rs1(src), rs2(base), imm(offset)
</p>

<p>
以 sw 为例:
</p>

<pre class="example" id="org000002b">
7              5     5   3   5        7 
---------------------------------------------
imm[11:5]      rs2   rs1 010 imm[4:0] 0100011
---------------------------------------------
offset[11:5]   src   base    offset[4:0]
</pre></li>

<li><p>
B, branch
</p>

<p>
B 指令和 S 格式基本相同, 只是 imm 部分 bit 分配有些不同.
</p>

<p>
rs1 (op1), rs2 (op2), imm (offset)
</p>

<p>
以 blt 为例:
</p>

<pre class="example" id="org000002c">
imm[12|10:5] rs2 rs1 100 imm[4:1|11] 1100011
</pre>

<p>
imm 使用的是 imm[12:1], 因为 risc-v 指令最短是 16 bit, 所以 offset 是 2 字节对齐的, 即 imm[0] 必定为 0, 使用 imm[12:1] 可以使 branch 范围变为 8k
</p></li>

<li><p>
U, upper intermediate
</p>

<p>
U 指令只处理 imm 的高 20 bit, 只有两个操作数 rd (dest), imm
</p>

<p>
lui:
</p>

<pre class="example" id="org000002d">
imm[31:12] rd 0110111
</pre></li>

<li><p>
J, jump
</p>

<p>
J 指令与 U 指令格式基本相同
</p>

<p>
jal:
</p>

<pre class="example" id="org000002e">
imm[20|10:1|11|19:12] rd 1101111
</pre>

<p>
与 B 指令类似, 没有使用 imm[0], J 跳转范围扩大为 2M
</p></li>
</ol>
</div>
</div>

<div id="outline-container-org0000049" class="outline-5">
<h5 id="org0000049"><span class="section-number-5">1.2.3.2</span> Sample</h5>
<div class="outline-text-5" id="text-1-2-3-2">
</div>
<div id="outline-container-org0000033" class="outline-6">
<h6 id="org0000033"><span class="section-number-6">1.2.3.2.1</span> I-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-1">
<p>
I 类型指令都是 `xxx rd, rs1, imm` 的形式, 其中 imm 12 bit, 包含以下指令:
</p>

<ul class="org-ul">
<li>addi</li>
<li>slti, sltiu</li>
<li>andi, ori, xori</li>
<li>slli, srli, srai</li>
<li>lw, lh, lb</li>
<li>jalr</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## ------ addi (add imm) ------
    <span class="org-keyword">la</span> a0, addi_msg
    ## i &#25351;&#20196;&#30340; imm &#26159; 12 bit, &#33539;&#22260;&#26159; -2048, 2047, &#36229;&#36807;&#20250;&#32534;&#35793;&#19981;&#36807;
    ## a1 = zero + (-2048)
    <span class="org-keyword">addi</span> a1, zero, -2048
    <span class="org-keyword">jal</span> printf

    ## ------ slti (set less than imm), sltiu (set less than imm unsigned) ------
    <span class="org-keyword">la</span> a0, slti_msg
    <span class="org-keyword">li</span> t0, 1023
    ## &#24403; t0 &lt; 1024 &#26102;, a1 = 1, &#21542;&#21017; a1 = 0
    <span class="org-keyword">slti</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">la</span> a0, slti_msg
    <span class="org-keyword">li</span> t0, 1024
    <span class="org-keyword">slti</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    <span class="org-keyword">la</span> a0, sltiu_msg
    <span class="org-keyword">li</span> t0, -1
    ## &#24403; (unsiged)t0 &lt; (unsigned)1024 &#26102;, a1 = 1, &#21542;&#21017; a1 = 0
    <span class="org-keyword">sltiu</span> a1, t0, 1024
    <span class="org-keyword">jal</span> printf

    ## ------ andi, ori, xori ------
    <span class="org-keyword">la</span> a0, and_or_xor_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">andi</span> a1, t0, 0x01
    <span class="org-keyword">ori</span> a2, t0, 0x01
    <span class="org-keyword">xori</span> a3, t0, 0x01
    <span class="org-keyword">jal</span> printf

    ## ------ slli (shift left logical imm) ------
    ## ------ srli (shift right logical imm) ------
    ## ------ srai (shift right arithmetic imm) ------
    <span class="org-keyword">la</span> a0, shift_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">slli</span> a1, t0, 4
    <span class="org-keyword">srli</span> a2, t0, 4
    <span class="org-keyword">li</span> t0, -0x11
    <span class="org-keyword">srli</span> a3, t0, 4
    <span class="org-keyword">srai</span> a4, t0, 4
    <span class="org-keyword">jal</span> printf

    ## ------ load: lw, lh, lb ------
    <span class="org-keyword">la</span> a0, load_msg
    <span class="org-keyword">la</span> t0, load_data
    <span class="org-keyword">lw</span> a1, 0(t0)
    <span class="org-keyword">lh</span> a2, 4(t0)
    <span class="org-keyword">lb</span> a3, 6(t0)
    <span class="org-keyword">lb</span> a4, 7(t0)
    <span class="org-keyword">jal</span> ra, printf

    ## ------ jalr ------
    <span class="org-keyword">call</span> jalr_test

    ## return
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

<span class="org-function-name">jalr_test</span>:
    ## jalr rd, imm(rs1), &#30456;&#24403;&#20110; rd=pc+4<span class="org-comment-delimiter">; </span><span class="org-comment">pc=imm(rs1)</span>
    ## jalr &#21487;&#20197;&#29992;&#26469;&#20174;&#20989;&#25968;&#20013;&#36820;&#22238;
    ## &#21478;&#22806;, J &#21644; B &#25351;&#20196;&#36339;&#36716;&#26102;&#37117;&#26159; pc relative &#36339;&#36716;. &#36890;&#36807; I &#25351;&#20196;&#30340; jalr
    ## &#21487;&#20197;&#23454;&#29616;&#25972;&#20010;&#22320;&#22336;&#31354;&#38388;&#33539;&#22260;&#30340;&#36339;&#36716;
    <span class="org-keyword">jalr</span> zero, 0(ra)

    <span class="org-keyword">.data</span>
<span class="org-function-name">addi_msg</span>:      .asciz <span class="org-string">"addi: %d\n"</span>
<span class="org-function-name">slti_msg</span>:      .asciz <span class="org-string">"slti: %d\n"</span>
<span class="org-function-name">sltiu_msg</span>:     .asciz <span class="org-string">"sltiu: %d\n"</span>
<span class="org-function-name">and_or_xor_msg</span>:     .asciz <span class="org-string">"and_or_xor: 0x%x, 0x%x, 0x%x\n"</span>
<span class="org-function-name">shift_msg</span>:     .asciz <span class="org-string">"slli: 0x%x, srli: 0x%x, negative: srli: %lld srai: %lld\n"</span>
<span class="org-function-name">load_msg</span>:       .asciz <span class="org-string">"load: %d, %d, %d, %d\n"</span>
<span class="org-function-name">load_data</span>:
    <span class="org-keyword">.word</span> 1
    <span class="org-keyword">.half</span> 2
    <span class="org-keyword">.byte</span> 3
    <span class="org-keyword">.byte</span> 4

</pre>
</div>

<pre class="example" id="org0000032">
addi: -2048
slti: 1
slti: 0
sltiu: 0
and_or_xor: 0x1, 0x11, 0x10
slli: 0x110, srli: 0x1, negative: srli: 1152921504606846974 srai: -2
load: 1, 2, 3, 4
</pre>
</div>
</div>

<div id="outline-container-org0000034" class="outline-6">
<h6 id="org0000034"><span class="section-number-6">1.2.3.2.2</span> R-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-2">
<p>
R 类型指令格式为 `xxx rd, rs1, rs2`, 与 I 类型指令有许多类似, 包含以下指令:
</p>

<ul class="org-ul">
<li>add, sub</li>
<li>slt, sltu</li>
<li>and, or, xor</li>
<li>sll, srl, sra</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## ------ addi (add imm) ------
    <span class="org-keyword">la</span> a0, sub_msg
    <span class="org-keyword">li</span> a1, 10
    <span class="org-keyword">sub</span> a1, zero, a1
    <span class="org-keyword">jal</span> printf

    ## ------ slt (set less than imm), sltu (set less than imm unsigned) ------
    <span class="org-keyword">la</span> a0, slt_msg
    <span class="org-keyword">li</span> t0, 1023
    <span class="org-keyword">li</span> t1, 1024
    <span class="org-keyword">slt</span> a1, t0, t1
    <span class="org-keyword">jal</span> printf

    ## ------ and, or, xor ------
    <span class="org-keyword">la</span> a0, and_or_xor_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">li</span> t1, 0x01
    <span class="org-keyword">and</span> a1, t0, t1
    <span class="org-keyword">or</span> a2, t0, t1
    <span class="org-keyword">xor</span> a3, t0, t1
    <span class="org-keyword">jal</span> printf

    ## ------ sll (shift left logical imm) ------
    ## ------ srl (shift right logical imm) ------
    ## ------ sra (shift right arithmetic imm) ------
    <span class="org-keyword">la</span> a0, shift_msg
    <span class="org-keyword">li</span> t0, 0x11
    <span class="org-keyword">li</span> t1, 4
    <span class="org-keyword">sll</span> a1, t0, t1
    <span class="org-keyword">srl</span> a2, t0, t1
    <span class="org-keyword">li</span> t0, -0x11
    <span class="org-keyword">srl</span> a3, t0, t1
    <span class="org-keyword">sra</span> a4, t0, t1
    <span class="org-keyword">jal</span> printf

    ## return
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">sub_msg</span>:      .asciz <span class="org-string">"sub: %d\n"</span>
<span class="org-function-name">slt_msg</span>:      .asciz <span class="org-string">"slt: %d\n"</span>
<span class="org-function-name">and_or_xor_msg</span>:     .asciz <span class="org-string">"and_or_xor: 0x%x, 0x%x, 0x%x\n"</span>
<span class="org-function-name">shift_msg</span>:     .asciz <span class="org-string">"sll: 0x%x, srli: 0x%x, negative: srl: %lld srai: %lld\n"</span>

</pre>
</div>

<pre class="example" id="org0000036">
sub: -10
slt: 1
and_or_xor: 0x1, 0x11, 0x10
sll: 0x110, srli: 0x1, negative: srl: 1152921504606846974 srai: -2
</pre>
</div>
</div>

<div id="outline-container-org0000038" class="outline-6">
<h6 id="org0000038"><span class="section-number-6">1.2.3.2.3</span> S-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-3">
<p>
S 指令用于 store, 格式为 `xxx rs1, (imm)rs2`, 表示把 rs1 的数据保存到 (imm)rs2
的地址上. risc-v 的 load/store 只支持这一种寻址方式, 相当于 x86 的 `寄存器相对寻址`
</p>

<p>
一共有三条指令:
</p>

<ul class="org-ul">
<li>sw</li>
<li>sh</li>
<li>sb</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> t0, test_data
    <span class="org-keyword">lw</span> t1, 0(t0)
    <span class="org-keyword">addi</span> t1, t1, 1
    <span class="org-keyword">sw</span> t1, 0(t0)

    <span class="org-keyword">la</span> a0, test_msg
    <span class="org-keyword">lw</span> a1, 0(t0)
    <span class="org-keyword">call</span> printf

    ## return
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">test_data</span>:     .word 1
<span class="org-function-name">test_msg</span>:    .asciz <span class="org-string">"hello: %d\n"</span>

</pre>
</div>

<pre class="example" id="org000003a">
hello: 2
</pre>
</div>
</div>

<div id="outline-container-org000003b" class="outline-6">
<h6 id="org000003b"><span class="section-number-6">1.2.3.2.4</span> B-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-4">
<p>
B 指令用于条件跳转, 它的格式与 S 指令基本相同, 只是 imm 的某些 bit 换了下位置, 格式为 `xxx rs1, rs2, imm`, 表示根据 rs1 的 rs2 比较的结果跳转到 pc+imm 的位置. 有以下几条指令:
</p>

<ul class="org-ul">
<li>beq</li>
<li>bne</li>
<li>blt/bltu</li>
<li>bge/bgeu</li>
</ul>

<p>
由于 imm encode 为 imm[12:1], 所以跳转的范围为 8k
</p>
</div>
</div>

<div id="outline-container-org000003f" class="outline-6">
<h6 id="org000003f"><span class="section-number-6">1.2.3.2.5</span> U-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-5">
<p>
U 指令用来操作一个 imm 的高位, 可以和其它指令配合来操作 32 位数, 有两条指令:
</p>

<ul class="org-ul">
<li>lui (load upper imm)</li>
<li>auipc (append upper imm to pc)</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

<span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## ------ lui ------
    ## lui &#21152;&#36733;&#19968;&#20010; imm &#30340;&#39640; 20 &#20301;&#21040;&#23492;&#23384;&#22120;
    ## &#37197;&#21512; addi &#30340; 12 &#20301; imm, &#21487;&#20197;&#21152;&#36733; 32 &#20301; imm
    <span class="org-keyword">la</span> a0, lui_msg
    <span class="org-keyword">lui</span> a1, 1&lt;&lt;16
    <span class="org-keyword">addi</span> a1, a1, 1
    <span class="org-keyword">call</span> printf

    ## &#36825;&#37324;&#29992; lui, addi &#26469;&#21152;&#36733; lui_msg &#22320;&#22336;&#21040; a0
    ## &#20294;&#19982; la &#20266;&#25351;&#20196;&#25928;&#26524;&#24182;&#38750;&#23436;&#20840;&#30456;&#21516;, &#22240;&#20026;&#36890;&#36807; lui, addi &#26041;&#24335;
    ## &#26159;&#23545; lui_msg &#30340;&#32477;&#23545;&#22320;&#22336;&#23547;&#22336;, &#20294; la &#36890;&#24120;&#20250;&#20351;&#29992; GOT &#25110; pc relative &#23547;&#22336;
    <span class="org-keyword">lui</span> a0, <span class="org-variable-name">%hi</span>(lui_msg)
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%lo</span>(lui_msg)
    <span class="org-keyword">lui</span> a1, 1&lt;&lt;16
    <span class="org-keyword">addi</span> a1, a1, 1
    <span class="org-keyword">call</span> printf

    ## ------ auipc ------
    ## auipc rd, imm &#30456;&#24403;&#20110; rd=pc+imm, &#37197;&#21512;&#20854;&#23427;&#25351;&#20196;&#21487;&#20197;
    ## &#24471;&#21040;&#30456;&#23545;&#20110; pc &#30340; 32 &#20301;&#22320;&#22336;
<span class="org-function-name">1</span>:  <span class="org-keyword">auipc</span> a0, <span class="org-variable-name">%pcrel</span>_hi(auipc_msg)
    ## &#36825;&#37324;&#30340; 1b &#26159; linker &#35748;&#35782;&#30340;&#29305;&#27530;&#20889;&#27861;, &#36825;&#37324;&#26080;&#27861;&#29992; <span class="org-variable-name">%pcrel</span>_lo(auipc_msg), &#22240;&#20026;&#20004;&#26465;&#25351;&#20196;&#22320;&#22336;&#19981;&#21516;
    ## https:<span class="org-comment-delimiter">//</span><span class="org-comment">sourceware.org/binutils/docs/as/RISC_002dV_002dModifiers.html</span>
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%pcrel</span>_lo(1b)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>

<span class="org-function-name">lui_msg</span>:    .asciz <span class="org-string">"lui: %x\n"</span>
<span class="org-function-name">auipc_msg</span>:   .asciz <span class="org-string">"auipc\n"</span>
</pre>
</div>

<pre class="example" id="org0000041">
lui: 10000001
lui: 10000001
auipc
</pre>
</div>
</div>

<div id="outline-container-org0000046" class="outline-6">
<h6 id="org0000046"><span class="section-number-6">1.2.3.2.6</span> J-Type Instructions</h6>
<div class="outline-text-6" id="text-1-2-3-2-6">
<p>
J 指令和 U 指令格式类似, 只有一条 jal (jump and link) 指令, 可以支持 2M 范围的
pc 相对跳转
</p>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> a0, hello_msg
    <span class="org-keyword">jal</span> ra, printf

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">hello_msg</span>:    .asciz <span class="org-string">"hello\n"</span>

</pre>
</div>

<pre class="example" id="org0000045">
hello
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000004c" class="outline-4">
<h4 id="org000004c"><span class="section-number-4">1.2.4</span> Pseudo Instruction</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
伪指令是 assembler 提供的, 和 ISA 没有关系, 主要是为了方便使用, 尤其是涉及到复杂的寻址方式的操作, 例如 la, call 等.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">la rd, symbol</td>
<td class="org-left">auipc rd, symbol[31:12]; addi rd, rd, symbol[11:0]</td>
</tr>

<tr>
<td class="org-left">l{b,h,w,d} rd, symbol</td>
<td class="org-left">auipc rd, symbol[31:12]; l{b,h,w,d} rd, symbol[11:0](rd)</td>
</tr>

<tr>
<td class="org-left">s{b,h,w,d} rd, symbol, rt</td>
<td class="org-left">auipc rt, symbol[31:12]; s{b,h,w,d} rd, symbol[11:0](rt)</td>
</tr>

<tr>
<td class="org-left">fl{w,d} rd, symbol, rt</td>
<td class="org-left">auipc rt, symbol[31:12]; fl{w,d} rd, symbol[11:0](rt)</td>
</tr>

<tr>
<td class="org-left">fs{w,d} rd, symbol, rt</td>
<td class="org-left">auipc rt, symbol[31:12]; fs{w,d} rd, symbol[11:0](rt)</td>
</tr>

<tr>
<td class="org-left">nop</td>
<td class="org-left">addi x0, x0, 0</td>
</tr>

<tr>
<td class="org-left">li rd, immediate</td>
<td class="org-left">myriad sequences</td>
</tr>

<tr>
<td class="org-left">mv rd, rs</td>
<td class="org-left">addi rd, rs, 0</td>
</tr>

<tr>
<td class="org-left">not rd, rs</td>
<td class="org-left">xori rd, rs, -1</td>
</tr>

<tr>
<td class="org-left">neg rd, rs</td>
<td class="org-left">sub rd, x0, rs</td>
</tr>

<tr>
<td class="org-left">negw rd, rs</td>
<td class="org-left">subw rd, x0, rs</td>
</tr>

<tr>
<td class="org-left">sext.b rd, rs</td>
<td class="org-left">slli rd, rs, XLEN - 8; srai rd, rd, XLEN - 8</td>
</tr>

<tr>
<td class="org-left">sext.h rd, rs</td>
<td class="org-left">slli rd, rs, XLEN - 16; srai rd, rd, XLEN - 16</td>
</tr>

<tr>
<td class="org-left">sext.w rd, rs</td>
<td class="org-left">addiw rd, rs, 0</td>
</tr>

<tr>
<td class="org-left">zext.b rd, rs</td>
<td class="org-left">andi rd, rs, 255</td>
</tr>

<tr>
<td class="org-left">zext.h rd, rs</td>
<td class="org-left">slli rd, rs, XLEN - 16; srli rd, rd, XLEN - 16</td>
</tr>

<tr>
<td class="org-left">zext.w rd, rs</td>
<td class="org-left">slli rd, rs, XLEN - 32; srli rd, rd, XLEN - 32</td>
</tr>

<tr>
<td class="org-left">seqz rd, rs</td>
<td class="org-left">sltiu rd, rs, 1</td>
</tr>

<tr>
<td class="org-left">snez rd, rs</td>
<td class="org-left">sltu rd, x0, rs</td>
</tr>

<tr>
<td class="org-left">sltz rd, rs</td>
<td class="org-left">slt rd, rs, x0</td>
</tr>

<tr>
<td class="org-left">sgtz rd, rs</td>
<td class="org-left">slt rd, x0, rs</td>
</tr>

<tr>
<td class="org-left">beqz rs, offset</td>
<td class="org-left">beq rs, x0, offset</td>
</tr>

<tr>
<td class="org-left">bnez rs, offset</td>
<td class="org-left">bne rs, x0, offset</td>
</tr>

<tr>
<td class="org-left">blez rs, offset</td>
<td class="org-left">bge x0, rs, offset</td>
</tr>

<tr>
<td class="org-left">bgez rs, offset</td>
<td class="org-left">bge rs, x0, offset</td>
</tr>

<tr>
<td class="org-left">bltz rs, offset</td>
<td class="org-left">blt rs, x0, offset</td>
</tr>

<tr>
<td class="org-left">bgtz rs, offset</td>
<td class="org-left">blt x0, rs, offset</td>
</tr>

<tr>
<td class="org-left">bgt rs, rt, offset</td>
<td class="org-left">blt rt, rs, offset</td>
</tr>

<tr>
<td class="org-left">ble rs, rt, offset</td>
<td class="org-left">bge rt, rs, offset</td>
</tr>

<tr>
<td class="org-left">bgtu rs, rt, offset</td>
<td class="org-left">bltu rt, rs, offset</td>
</tr>

<tr>
<td class="org-left">bleu rs, rt, offset</td>
<td class="org-left">bgeu rt, rs, offset</td>
</tr>

<tr>
<td class="org-left">j offset</td>
<td class="org-left">jal x0, offset</td>
</tr>

<tr>
<td class="org-left">jal offset</td>
<td class="org-left">jal x1, offset</td>
</tr>

<tr>
<td class="org-left">jr rs</td>
<td class="org-left">jalr x0, rs, 0</td>
</tr>

<tr>
<td class="org-left">jalr rs</td>
<td class="org-left">jalr x1, rs, 0</td>
</tr>

<tr>
<td class="org-left">ret</td>
<td class="org-left">jalr x0, x1, 0</td>
</tr>

<tr>
<td class="org-left">call offset</td>
<td class="org-left">auipc x6, offset[31:12]; jalr x1, x6, offset[11:0]</td>
</tr>

<tr>
<td class="org-left">tail offset</td>
<td class="org-left">auipc x6, offset[31:12]; jalr x0, x6, offset[11:0]</td>
</tr>

<tr>
<td class="org-left">fence</td>
<td class="org-left">fence iorw, iorw</td>
</tr>
</tbody>
</table>

<p>
la (load address) 和 call 很复杂, 因为根据编译参数 (例如 pic) 以及 offset 的大小,
symbol 地址可以有不同的表示.
</p>

<ul class="org-ul">
<li>使用绝对地址</li>
<li>使用 pc-relative</li>
<li>使用 GOT</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## &#32477;&#23545;&#22320;&#22336;
    <span class="org-keyword">lui</span> a0, <span class="org-variable-name">%hi</span>(hello_msg)
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%lo</span>(hello_msg)
    <span class="org-keyword">call</span> printf

    ## pc-relative &#22320;&#22336;
<span class="org-function-name">.1</span>:
    <span class="org-keyword">auipc</span> a0, <span class="org-variable-name">%pcrel</span>_hi(hello_msg)
    <span class="org-keyword">addi</span> a0, a0, <span class="org-variable-name">%pcrel</span>_lo(.1)
    <span class="org-keyword">call</span> printf

    ## got &#22320;&#22336;
    ## auipc a0, $got_pcrel_hi &#22909;&#20687;&#19981;&#25903;&#25345;..
    ## la &#20266;&#25351;&#20196;&#20250;&#32534;&#35793;&#25104;&#31867;&#20284;&#19979;&#38754;&#30340;&#20195;&#30721;:
    ## auipc   a0,0x60
    ## ld      a0,956(a0) # 70810 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;
    <span class="org-keyword">la</span> a0,hello_msg
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

    <span class="org-keyword">.data</span>
<span class="org-function-name">hello_msg</span>:    .asciz <span class="org-string">"hello\n"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000053" class="outline-4">
<h4 id="org0000053"><span class="section-number-4">1.2.5</span> Demo</h4>
<div class="outline-text-4" id="text-1-2-5">
</div>
<div id="outline-container-org0000050" class="outline-5">
<h5 id="org0000050"><span class="section-number-5">1.2.5.1</span> Insertion Sort</h5>
<div class="outline-text-5" id="text-1-2-5-1">
<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>
<span class="org-function-name">print_data</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> s0, data
    <span class="org-keyword">la</span> s1, data_end
    <span class="org-keyword">addi</span> s0, s0, -8

<span class="org-function-name">print_loop</span>:
    <span class="org-keyword">addi</span> s0, s0, 8
    <span class="org-keyword">beq</span> s0, s1, print_end

    <span class="org-keyword">la</span> a0, print_fmt
    <span class="org-keyword">ld</span> a1, 0(s0)
    <span class="org-keyword">call</span> printf
    <span class="org-keyword">j</span> print_loop

<span class="org-function-name">print_end</span>:
    <span class="org-keyword">la</span> a0, print_fmt_new_line
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">ret</span>

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">call</span> print_data

    <span class="org-keyword">la</span> t0, data
    <span class="org-keyword">addi</span> t0, t0, -8
    <span class="org-keyword">la</span> t2, data_end

<span class="org-function-name">main_outer_loop</span>:
    <span class="org-keyword">addi</span> t0, t0, 8
    <span class="org-keyword">beq</span> t0, t2, main_end
    <span class="org-keyword">addi</span> t1, t0, -8

<span class="org-function-name">main_inner_loop</span>:
    <span class="org-keyword">addi</span> t1, t1, 8
    <span class="org-keyword">beq</span> t1, t2, main_outer_loop
    <span class="org-keyword">ld</span> s0, 0(t0)
    <span class="org-keyword">ld</span> s1, 0(t1)
    <span class="org-keyword">blt</span> s0, s1, main_continue
    ## swap
    <span class="org-keyword">sd</span> s1, 0(t0)
    <span class="org-keyword">sd</span> s0, 0(t1)
<span class="org-function-name">main_continue</span>:
    <span class="org-keyword">j</span> main_inner_loop

<span class="org-function-name">main_end</span>:
    <span class="org-keyword">call</span> print_data
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

    <span class="org-keyword">.data</span>
<span class="org-function-name">data</span>:
    <span class="org-keyword">.dword</span> 1
    <span class="org-keyword">.dword</span> 1
    <span class="org-keyword">.dword</span> 4
    <span class="org-keyword">.dword</span> 3
    <span class="org-keyword">.dword</span> 10
    <span class="org-keyword">.dword</span> 5
<span class="org-function-name">data_end</span>:

<span class="org-function-name">print_fmt_new_line</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"\n"</span>

<span class="org-function-name">print_fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%ld "</span>

</pre>
</div>

<pre class="example" id="org0000052">
1 1 4 3 10 5 
1 1 3 4 5 10
</pre>
</div>
</div>

<div id="outline-container-org0000058" class="outline-5">
<h5 id="org0000058"><span class="section-number-5">1.2.5.2</span> Quick Sort</h5>
<div class="outline-text-5" id="text-1-2-5-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>

<span class="org-type">void</span> <span class="org-function-name">swap</span>(<span class="org-type">int</span> *<span class="org-variable-name">data</span>, <span class="org-type">int</span> <span class="org-variable-name">a</span>, <span class="org-type">int</span> <span class="org-variable-name">b</span>) {
    <span class="org-type">int</span> <span class="org-variable-name">temp</span> = data[a];
    data[a] = data[b];
    data[b] = temp;
}

<span class="org-type">void</span> <span class="org-function-name">quick_sort</span>(<span class="org-type">int</span> *<span class="org-variable-name">data</span>, <span class="org-type">int</span> <span class="org-variable-name">start</span>, <span class="org-type">int</span> <span class="org-variable-name">end</span>) {
    <span class="org-type">int</span> <span class="org-variable-name">pivort</span> = start;
    <span class="org-type">int</span> <span class="org-variable-name">curr</span> = start + 1;
    <span class="org-keyword">if</span> (curr &gt;= end) {
        <span class="org-keyword">return</span>;
    }
    <span class="org-keyword">while</span> (curr &lt; end) {
        <span class="org-keyword">if</span> (data[curr] &lt; data[pivort]) {
            swap(data, curr, pivort + 1);
            swap(data, pivort, pivort + 1);
            pivort += 1;
        }
        curr += 1;
    }
    quick_sort(data, start, pivort);
    quick_sort(data, pivort + 1, end);
}

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[]) {
    <span class="org-type">int</span> <span class="org-variable-name">data</span>[] = {1, 1, 4, 3, 10, 5};
    <span class="org-type">int</span> <span class="org-variable-name">len</span> = <span class="org-keyword">sizeof</span>(data) / <span class="org-keyword">sizeof</span>(data[0]);
    <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; len; i++) {
        printf(<span class="org-string">"%d "</span>, data[i]);
    }
    printf(<span class="org-string">"\n"</span>);
    quick_sort(data, 0, len);
    <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; len; i++) {
        printf(<span class="org-string">"%d "</span>, data[i]);
    }
    <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<pre class="example" id="org0000056">
1 1 4 3 10 5 
1 1 3 4 5 10 
</pre>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>

<span class="org-keyword">.macro</span> enter
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)
<span class="org-keyword">.endm</span>

<span class="org-keyword">.macro</span> leave
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>
<span class="org-keyword">.endm</span>

<span class="org-function-name">print_data</span>:
    <span class="org-keyword">enter</span>

    <span class="org-keyword">la</span> s0, .Ldata_start
    <span class="org-keyword">la</span> s1, .Ldata_end
    <span class="org-keyword">addi</span> s0, s0, -8

    <span class="org-keyword">.Lprint_loop</span>:
    <span class="org-keyword">addi</span> s0, s0, 8
    <span class="org-keyword">beq</span> s0, s1, .Lprint_end

    <span class="org-keyword">la</span> a0, .Lprint_fmt
    <span class="org-keyword">ld</span> a1, 0(s0)
    <span class="org-keyword">call</span> printf
    <span class="org-keyword">j</span> .Lprint_loop

    <span class="org-keyword">.Lprint_end</span>:
    <span class="org-keyword">la</span> a0, .Lprint_fmt_new_line
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">leave</span>

<span class="org-function-name">quick_sort</span>:
    <span class="org-keyword">addi</span> sp, sp, -64
    <span class="org-keyword">sw</span> ra, 8(sp)
    <span class="org-keyword">sw</span> s0, 16(sp)
    <span class="org-keyword">sw</span> s1, 24(sp)
    <span class="org-keyword">sw</span> s2, 32(sp)
    <span class="org-keyword">sw</span> s3, 40(sp)
    <span class="org-keyword">sw</span> s4, 48(sp)
    <span class="org-keyword">sw</span> s5, 56(sp)
    <span class="org-keyword">sw</span> s6, 64(sp)

    #define end s6
    #define start s0
    #define loop s1
    #define pivort s2
    #define loop_v s3
    #define pivort_v s4
    #define tmp s5

    <span class="org-keyword">move</span> start, a0
    <span class="org-keyword">move</span> end, a1
    <span class="org-keyword">move</span> pivort, start 
    <span class="org-keyword">addi</span> loop, a0, 8 
    <span class="org-keyword">bge</span> loop, end, .Lquick_sort_end

    <span class="org-keyword">addi</span> loop, loop,-8
<span class="org-function-name">1</span>:  
    <span class="org-keyword">addi</span> loop, loop, 8
    <span class="org-keyword">bge</span> loop, end, 1f

    <span class="org-keyword">ld</span> loop_v, 0(loop)
    <span class="org-keyword">ld</span> pivort_v, 0(pivort)
    <span class="org-keyword">bge</span> loop_v, pivort_v, 1b
    ## swap
    <span class="org-keyword">ld</span> tmp, 8(pivort)
    <span class="org-keyword">sd</span> loop_v, 8(pivort)
    <span class="org-keyword">sd</span> tmp, 0(loop)
    ## swap
    <span class="org-keyword">ld</span> tmp, 8(pivort)
    <span class="org-keyword">sd</span> pivort_v, 8(pivort)
    <span class="org-keyword">sd</span> tmp, 0(pivort)
    ## inc pivort
    <span class="org-keyword">addi</span> pivort, pivort, 8
    <span class="org-keyword">j</span> 1b

<span class="org-function-name">1</span>:  
    <span class="org-keyword">move</span> a0, start
    <span class="org-keyword">move</span> a1, pivort
    <span class="org-keyword">call</span> quick_sort

    <span class="org-keyword">addi</span> a0, pivort, 8
    <span class="org-keyword">move</span> a1, end
    <span class="org-keyword">call</span> quick_sort

    <span class="org-keyword">.Lquick_sort_end</span>:
    <span class="org-keyword">lw</span> ra, 8(sp)
    <span class="org-keyword">lw</span> s0, 16(sp)
    <span class="org-keyword">lw</span> s1, 24(sp)
    <span class="org-keyword">lw</span> s2, 32(sp)
    <span class="org-keyword">lw</span> s3, 40(sp)
    <span class="org-keyword">lw</span> s4, 48(sp)
    <span class="org-keyword">lw</span> s5, 56(sp)
    <span class="org-keyword">lw</span> s6, 64(sp)

    <span class="org-keyword">addi</span> sp, sp, 64
    <span class="org-keyword">ret</span>

<span class="org-function-name">main</span>:
    <span class="org-keyword">enter</span>

    <span class="org-keyword">call</span> print_data

    <span class="org-keyword">la</span> a0, .Ldata_start
    <span class="org-keyword">la</span> a1, .Ldata_end

    <span class="org-keyword">call</span> quick_sort
    <span class="org-keyword">call</span> print_data

    <span class="org-keyword">leave</span>

    <span class="org-keyword">.data</span>
    <span class="org-keyword">.Ldata_start</span>:
    <span class="org-keyword">.dword</span> 4
    <span class="org-keyword">.dword</span> 3
    <span class="org-keyword">.dword</span> 10
    <span class="org-keyword">.dword</span> 5
    <span class="org-keyword">.rep</span> 2
    <span class="org-keyword">.dword</span> 3
    <span class="org-keyword">.endr</span>
    <span class="org-keyword">.fill</span> 2, 8, 1
    <span class="org-keyword">.space</span> 8, 0xff
    <span class="org-keyword">.Ldata_end</span>:

<span class="org-function-name">.Lprint_fmt_new_line</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"\n"</span>

<span class="org-function-name">.Lprint_fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%ld "</span>
</pre>
</div>

<pre class="example" id="org0000057">
4 3 10 5 3 3 1 1 -1 
-1 1 1 3 3 3 4 5 10
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000062" class="outline-3">
<h3 id="org0000062"><span class="section-number-3">1.3</span> GNU Assembler</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<a href="https://sourceware.org/binutils/docs/as/index.html#SEC_Contents">using as</a>
</p>

<ol class="org-ol">
<li>.L 开头的 label, 不会出现在符号表中</li>

<li>数字形式的 label 如 1:, 2: 是 local label, 它们可以重复定义, 通过 1b, 1f 的形式去引用当前位置后面或前面的 label. as 内部会让它们有唯一的名字</li>

<li>directive

<ol class="org-ol">
<li>`.lcomm test_data, 1024` 相当于 static char test_data[1024]={0}; `.comm
test_data, 1024` 相当于 char test_data[1024]={0}, 即两者可以在 .bss 上分配空间, 但 .lcomm 产生 local 符号, .comm 产生 global 符号</li>

<li>`.space 10, 1` 相当于连接 10 个 .byte 1</li>

<li>`.fill 10, 8, 2 ` 相当于 10 个 .dword 2</li>

<li><p>
.rep N, endr
</p>

<pre class="example" id="org0000061">
.rept   3
.word   10
.endr

相当于

.word 10
.word 10
.word 10
</pre></li>

<li>.word, .dword, .half, .byte, .float</li>

<li>.ascii "hello", .asciz "hello"</li>

<li>.global main</li>

<li>.include "header.S"</li>

<li>.macro, .endm</li>

<li>.section</li>

<li>.equ constant 0x1234</li>
</ol></li>

<li><p>
risc-v modifiers
</p>

<p>
symbol 是一个 32 bit 地址, 并没有直接操作 32bit imm 的指令, 需要用 lui, auipc
去操作 symbol 的高 20 位,再用 addi 操作低 12 位, 所以需要 %hi, %lo 等
modifier
</p>

<ol class="org-ol">
<li>%lo(symbol), %hi(symbol)</li>

<li>%pcrel_hi(symbol), %pcrel_lo(symbol)</li>

<li>%got_pcrel_hi(symbol), %got_pcrel_lo(symbol)</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-org000008a" class="outline-3">
<h3 id="org000008a"><span class="section-number-3">1.4</span> Standard Extention</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org0000066" class="outline-4">
<h4 id="org0000066"><span class="section-number-4">1.4.1</span> RV32M</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
RV32M 有 8 条 R 指令:
</p>

<ul class="org-ul">
<li><p>
mul, mulh, mulhu, mulhsu
</p>

<p>
mul 用来获得两个 32 bit 数乘法的低 32 bit
</p>

<p>
mulh (mul high) 用来获得两个 32 bit 数乘法的高 32 bit
</p>

<p>
mulhu (mul hight unsigned) 用来获得两个 unsigned 32 bit 数乘法的高 32 bit
</p>

<p>
mulhsu (mul hight signed unsigned) 用来获得一个 unsigned 32 bit 数和一个
signed 32 bit 数相乘的高 32 bit
</p></li>

<li><p>
div, divu, rem, remu
</p>

<p>
div 获得商, rem 获得余数, 这里的除法是整数除法
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -8
    <span class="org-keyword">sd</span> ra, 8(sp)

    <span class="org-keyword">li</span> t0, 3
    <span class="org-keyword">li</span> t1, 2
    <span class="org-keyword">mul</span> a1, t0, t1
    <span class="org-keyword">div</span> a2, t0, t1
    <span class="org-keyword">rem</span> a3, t0, t1    
    <span class="org-keyword">la</span> a0, .Lprint_fmt
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">ld</span> ra, 8(sp)
    <span class="org-keyword">addi</span> sp, sp, 8
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

<span class="org-function-name">.Lprint_fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%lx %lx %lx\n"</span>

</pre>
</div>

<pre class="example" id="org0000065">
6 1 1
</pre>
</div>
</div>


<div id="outline-container-org0000068" class="outline-4">
<h4 id="org0000068"><span class="section-number-4">1.4.2</span> RV32F and RV32D</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
RV32{F,D} 是针对浮点数的指令.
</p>

<p>
除了用于 load/store 的:
</p>

<ul class="org-ul">
<li>flw (float load word)</li>
<li>fsw (float store word)</li>
<li>fld (float load double word)</li>
<li>fsd (float store double word)</li>
</ul>

<p>
其它都是 R 指令, 且都通过 .{s,d} 后缀区别 single precision 和 double precision,
例如:
</p>
</div>

<div id="outline-container-org0000069" class="outline-5">
<h5 id="org0000069"><span class="section-number-5">1.4.2.1</span> 算术运算</h5>
<div class="outline-text-5" id="text-1-4-2-1">
<ul class="org-ul">
<li>fadd.{s,d}</li>
<li>fsub.{s,d}</li>
<li>fmul.{s,d}</li>
<li>fdiv.{s,d}</li>
<li>fsqrt.{s,d}</li>
<li>fmin.{s,d}</li>
<li>fmax.{s,d}</li>
</ul>
</div>
</div>

<div id="outline-container-org000006d" class="outline-5">
<h5 id="org000006d"><span class="section-number-5">1.4.2.2</span> 比较运算</h5>
<div class="outline-text-5" id="text-1-4-2-2">
<p>
rv32f 没有提供 v32i 的 bne 类似条件跳转的指令, 但提供了浮点比较指令, 比较的结果放在 rd 中, 再使用 x 寄存器上的条件跳转指令进行跳转, 例如:
</p>

<pre class="example" id="org000006c">
flt x5，f1，f2
bne x5，x0，exit
</pre>

<ul class="org-ul">
<li>feq.{s,d}</li>
<li>flt.{s,d}</li>
<li>fle.{s,d}</li>
</ul>
</div>
</div>

<div id="outline-container-org0000070" class="outline-5">
<h5 id="org0000070"><span class="section-number-5">1.4.2.3</span> 浮点与定点互相搬运</h5>
<div class="outline-text-5" id="text-1-4-2-3">
<p>
f 寄存器与 x 寄存器互相复制
</p>

<ul class="org-ul">
<li><p>
fmv.x.{w,d}
</p>

<p>
w 表示单精度, d 表示双精度
</p>

<p>
fmv.x.w a0, fa0
</p></li>

<li><p>
fmv.{w,d}.x
</p>

<p>
fmv.w.x fa0, a0
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org0000073" class="outline-5">
<h5 id="org0000073"><span class="section-number-5">1.4.2.4</span> 寄存器</h5>
<div class="outline-text-5" id="text-1-4-2-4">
<p>
所有浮点操作使用独立的 f0~f31 寄存器, 和 rv32i 使用的 x 寄存器有类似的别名, 例如:
</p>

<ol class="org-ol">
<li>ft0~ft11 是 caller saved temp register</li>
<li>fs0~fs11 是 callee saved register</li>
<li>fa0~fa7 用来保存 argument 和 return value, 同样是 caller saved</li>
</ol>
</div>
</div>

<div id="outline-container-org0000078" class="outline-5">
<h5 id="org0000078"><span class="section-number-5">1.4.2.5</span> 调用约定</h5>
<div class="outline-text-5" id="text-1-4-2-5">
<p>
与 rv32i 类似, rv32{f,d} 也使用 fa0~fa7 传递参数, 例如, foo(int a, float b) 会使用 a0 读取 a, fa0 读取 b.
</p>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>

<span class="org-function-name">foo</span>:    
    <span class="org-keyword">addi</span>    sp,sp,-16
    <span class="org-keyword">sd</span>      ra,8(sp)

    ## &#36825;&#37324;&#26159; gcc &#29983;&#25104;&#30340;&#20195;&#30721;, &#23454;&#38469;&#19978;&#21487;&#20197;&#29992; fmv.x.d a2, fa0 &#20195;&#26367; fsd/ld
    ## fmv.x.d a2, fa0     
    <span class="org-keyword">fsd</span>     fa0,16(sp)
    <span class="org-keyword">ld</span>      a2,16(sp)

    <span class="org-keyword">mv</span>      a1,a0
    <span class="org-keyword">la</span>      a0,.Lprint_fmt
    <span class="org-keyword">call</span>    printf

    <span class="org-keyword">ld</span>      ra,8(sp)
    <span class="org-keyword">addi</span>    sp,sp,16
    <span class="org-keyword">ret</span>

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -8
    <span class="org-keyword">sd</span> ra, 8(sp)

    <span class="org-keyword">li</span> a0, 0x1234
    <span class="org-keyword">la</span> t0, 1f
    <span class="org-keyword">fld</span> fa0, 0(t0)

    <span class="org-keyword">call</span> foo

    <span class="org-keyword">ld</span> ra, 8(sp)
    <span class="org-keyword">addi</span> sp, sp, 8
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

<span class="org-function-name">1</span>:
    <span class="org-keyword">.double</span> 1.1

    <span class="org-keyword">.Lprint_fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%x %f\n"</span>
</pre>
</div>

<pre class="example" id="org0000076">
1234 1.100000
</pre>

<p>
关于 printf 这种 variadic function, 有特殊的处理: 使用 a0, a1, a2 &#x2026; 而不使用
fa0, fa1, &#x2026;, 需要调用者用 fmv.x.{w,d} 把浮点搬运到整数寄存器.
</p>

<div class="org-src-container">
<pre class="src src-asm">    ## riscv64-linux-gnu-gcc test.s -static
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>

<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -8
    <span class="org-keyword">sd</span> ra, 8(sp)

    <span class="org-keyword">la</span> a0, .Lprint_fmt
    <span class="org-keyword">li</span> a1, 0x1234
    <span class="org-keyword">la</span> t0, 1f
    ## &#30452;&#25509;&#20570;&#20026;&#25972;&#25968; load
    <span class="org-keyword">ld</span> a2, 0(t0)
    ## &#25110;&#32773;&#20351;&#29992; fmv.x.d &#25644;&#36816;&#19968;&#27425;
    ## fld fa0, 0(t0)
    ## fmv.x.d a2, fa0

    <span class="org-keyword">call</span> printf

    <span class="org-keyword">ld</span> ra, 8(sp)
    <span class="org-keyword">addi</span> sp, sp, 8
    <span class="org-keyword">move</span> a0, zero
    <span class="org-keyword">ret</span>

<span class="org-function-name">1</span>:
    <span class="org-keyword">.double</span> 1.1

<span class="org-function-name">.Lprint_fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"0x%x %f\n"</span>

</pre>
</div>

<pre class="example" id="org0000077">
0x1234 1.100000
</pre>
</div>
</div>
</div>

<div id="outline-container-org000006b" class="outline-4">
<h4 id="org000006b"><span class="section-number-4">1.4.3</span> RV32A</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
RV32A 定义了原子操作 (atomic operation)
</p>
</div>
</div>

<div id="outline-container-org000006e" class="outline-4">
<h4 id="org000006e"><span class="section-number-4">1.4.4</span> RV32C</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
RV32C 代替 compat 指令, 即把一部分指定替换为 16 bit 的形式, 与 arm thumb 类似
</p>
</div>
</div>

<div id="outline-container-org0000071" class="outline-4">
<h4 id="org0000071"><span class="section-number-4">1.4.5</span> RV32V</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
RV32V 是向量操作, 即 SIMD
</p>
</div>
</div>

<div id="outline-container-org0000074" class="outline-4">
<h4 id="org0000074"><span class="section-number-4">1.4.6</span> RV64G</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
RV32G 针对 64 bit 的扩展
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2022-02-08 Tue 15:30<br />
Last updated: 2022-02-11 Fri 19:51</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
