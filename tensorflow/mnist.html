<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 19:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MNIST</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">MNIST</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgbd0c33e">1. MNIST</a>
<ul>
<li><a href="#org511df17">1.1. simple</a></li>
<li><a href="#orgf1ed7d2">1.2. one-hot</a></li>
<li><a href="#org0e2fddd">1.3. manually fit</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgbd0c33e" class="outline-2">
<h2 id="orgbd0c33e"><span class="section-number-2">1</span> MNIST</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #859900;">import</span> tensorflow <span style="color: #859900;">as</span> tf
<span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np

<span style="color: #859900;">from</span> tensorflow.keras.datasets <span style="color: #859900;">import</span> mnist
<span style="color: #859900;">from</span> tensorflow.keras <span style="color: #859900;">import</span> layers<span style="color: #757575;">,</span>losses<span style="color: #757575;">,</span>metrics<span style="color: #757575;">,</span>optimizers<span style="color: #757575;">,</span> models

<span style="color: #586e75;"># </span><span style="color: #586e75;">load data</span>

</pre>
</div>
</div>

<div id="outline-container-org511df17" class="outline-3">
<h3 id="org511df17"><span class="section-number-3">1.1</span> simple</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span>y_train<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> y_test<span style="color: #757575;">)</span> = mnist.load_data<span style="color: #757575;">()</span>

tf.keras.backend.clear_session<span style="color: #757575;">()</span>

<span style="color: #268bd2;">model</span> = models.Sequential<span style="color: #757575;">()</span>
model.add<span style="color: #757575;">(</span>layers.Flatten<span style="color: #757575;">(</span>input_shape = <span style="color: #757575;">(</span>28<span style="color: #757575;">,</span> 28<span style="color: #757575;">)))</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>100<span style="color: #757575;">,</span>  activation = <span style="color: #2aa198;">"relu"</span><span style="color: #757575;">))</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>10<span style="color: #757575;">,</span> activation = <span style="color: #2aa198;">"softmax"</span><span style="color: #757575;">))</span>

model.<span style="color: #839496;">compile</span><span style="color: #757575;">(</span>optimizer=<span style="color: #2aa198;">"adam"</span><span style="color: #757575;">,</span>loss=<span style="color: #2aa198;">"sparse_categorical_crossentropy"</span><span style="color: #757575;">,</span> metrics=[<span style="color: #2aa198;">"accuracy"</span>]<span style="color: #757575;">)</span>

model.fit<span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span> y_train<span style="color: #757575;">,</span> batch_size = 200<span style="color: #757575;">,</span> epochs = 10<span style="color: #757575;">,</span> verbose = 0<span style="color: #757575;">)</span>

model.evaluate<span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> y_test<span style="color: #757575;">,</span> verbose=2<span style="color: #757575;">)</span>

</pre>
</div>

<p>
313/313 - 0s - loss: 0.3964 - accuracy: 0.9426
</p>
</div>
</div>

<div id="outline-container-orgf1ed7d2" class="outline-3">
<h3 id="orgf1ed7d2"><span class="section-number-3">1.2</span> one-hot</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span>y_train<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> y_test<span style="color: #757575;">)</span> = mnist.load_data<span style="color: #757575;">()</span>

tf.keras.backend.clear_session<span style="color: #757575;">()</span>

<span style="color: #268bd2;">x_train</span> = tf.reshape<span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 28 * 28<span style="color: #757575;">))</span>
<span style="color: #268bd2;">y_train</span> = tf.one_hot<span style="color: #757575;">(</span>y_train<span style="color: #757575;">,</span> depth = 10<span style="color: #757575;">)</span>

<span style="color: #268bd2;">x_test</span> = tf.reshape<span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 28 * 28<span style="color: #757575;">))</span>
<span style="color: #268bd2;">y_test</span> = tf.one_hot<span style="color: #757575;">(</span>y_test<span style="color: #757575;">,</span> depth = 10<span style="color: #757575;">)</span>

<span style="color: #268bd2;">model</span> = models.Sequential<span style="color: #757575;">()</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>100<span style="color: #757575;">,</span> input_shape = <span style="color: #757575;">(</span>28 * 28<span style="color: #757575;">,</span> <span style="color: #757575;">),</span> activation = <span style="color: #2aa198;">"relu"</span><span style="color: #757575;">))</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>10<span style="color: #757575;">,</span> activation = <span style="color: #2aa198;">"softmax"</span><span style="color: #757575;">))</span>

model.<span style="color: #839496;">compile</span><span style="color: #757575;">(</span>optimizer=<span style="color: #2aa198;">"adam"</span><span style="color: #757575;">,</span>loss=<span style="color: #2aa198;">"categorical_crossentropy"</span><span style="color: #757575;">,</span> metrics=[<span style="color: #2aa198;">"accuracy"</span>]<span style="color: #757575;">)</span>
model.fit<span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span> y_train<span style="color: #757575;">,</span> batch_size = 200<span style="color: #757575;">,</span> epochs = 10<span style="color: #757575;">,</span> verbose = 0<span style="color: #757575;">)</span>

model.evaluate<span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> y_test<span style="color: #757575;">,</span> verbose=2<span style="color: #757575;">)</span>
</pre>
</div>

<p>
313/313 - 0s - loss: 0.3311 - accuracy: 0.9362
</p>
</div>
</div>

<div id="outline-container-org0e2fddd" class="outline-3">
<h3 id="org0e2fddd"><span class="section-number-3">1.3</span> manually fit</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span>y_train<span style="color: #757575;">),</span> <span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> y_test<span style="color: #757575;">)</span> = mnist.load_data<span style="color: #757575;">()</span>

tf.keras.backend.clear_session<span style="color: #757575;">()</span>

<span style="color: #268bd2;">x_train</span> = tf.reshape<span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 28 * 28<span style="color: #757575;">))</span>
<span style="color: #268bd2;">y_train</span> = tf.one_hot<span style="color: #757575;">(</span>y_train<span style="color: #757575;">,</span> depth = 10<span style="color: #757575;">)</span>

<span style="color: #268bd2;">x_test</span> = tf.reshape<span style="color: #757575;">(</span>x_test<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>-1<span style="color: #757575;">,</span> 28 * 28<span style="color: #757575;">))</span>
<span style="color: #268bd2;">y_test</span> = tf.one_hot<span style="color: #757575;">(</span>y_test<span style="color: #757575;">,</span> depth = 10<span style="color: #757575;">)</span>

<span style="color: #268bd2;">model</span> = models.Sequential<span style="color: #757575;">()</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>100<span style="color: #757575;">,</span> input_shape = <span style="color: #757575;">(</span>28 * 28<span style="color: #757575;">,</span> <span style="color: #757575;">),</span> activation = <span style="color: #2aa198;">"relu"</span><span style="color: #757575;">))</span>
model.add<span style="color: #757575;">(</span>layers.Dense<span style="color: #757575;">(</span>10<span style="color: #757575;">,</span> activation = <span style="color: #2aa198;">"softmax"</span><span style="color: #757575;">))</span>

<span style="color: #268bd2;">loss_func</span> = tf.keras.losses.CategoricalCrossentropy<span style="color: #757575;">()</span>
<span style="color: #268bd2;">evaluator</span> = tf.keras.metrics.CategoricalAccuracy<span style="color: #757575;">(</span>name=<span style="color: #2aa198;">'test_accuracy'</span><span style="color: #757575;">)</span>

<span style="color: #268bd2;">optimizer</span> = tf.keras.optimizers.Adam<span style="color: #757575;">()</span>

<span style="color: #268bd2;">train_dataset</span> = tf.data.Dataset.from_tensor_slices<span style="color: #757575;">(</span>
    <span style="color: #757575;">(</span>x_train<span style="color: #757575;">,</span> y_train<span style="color: #757575;">))</span>.batch<span style="color: #757575;">(</span>200<span style="color: #757575;">)</span>

<span style="color: #859900;">for</span> epoch <span style="color: #859900;">in</span> <span style="color: #839496;">range</span><span style="color: #757575;">(</span>20<span style="color: #757575;">)</span>:
  <span style="color: #859900;">for</span> x<span style="color: #757575;">,</span> y <span style="color: #859900;">in</span> train_dataset:
      <span style="color: #859900;">with</span> tf.GradientTape<span style="color: #757575;">()</span> <span style="color: #859900;">as</span> tape:
          <span style="color: #268bd2;">y_hat</span>= model<span style="color: #757575;">(</span>x<span style="color: #757575;">)</span>
          <span style="color: #268bd2;">loss</span> = loss_func<span style="color: #757575;">(</span>y<span style="color: #757575;">,</span> y_hat<span style="color: #757575;">)</span>
          <span style="color: #268bd2;">gradients</span> = tape.gradient<span style="color: #757575;">(</span>loss<span style="color: #757575;">,</span> model.trainable_variables<span style="color: #757575;">)</span>
          optimizer.apply_gradients<span style="color: #757575;">(</span><span style="color: #839496;">zip</span><span style="color: #757575;">(</span>gradients<span style="color: #757575;">,</span> model.trainable_variables<span style="color: #757575;">))</span>

evaluator<span style="color: #757575;">(</span>y_test<span style="color: #757575;">,</span> model<span style="color: #757575;">(</span>x_test<span style="color: #757575;">))</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>evaluator.result<span style="color: #757575;">())</span>
</pre>
</div>

<p>
tf.Tensor(0.955, shape=(), dtype=float32)
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2020-07-27 一 00:00<br />
Last updated: 2021-09-16 四 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

           <div id="disqus_thread"></div>
           <script>

           (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sunwayforever-github-io.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
           </script>
</div>
</body>
</html>
