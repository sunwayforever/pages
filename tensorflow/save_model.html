<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Save Model</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Save Model</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0000018">1. Save Model</a>
<ul>
<li><a href="#org0000000">1.1. Frozen Graph</a></li>
<li><a href="#org0000015">1.2. Saved Model</a>
<ul>
<li><a href="#org0000003">1.2.1. 保存</a></li>
<li><a href="#org0000006">1.2.2. 加载</a></li>
<li><a href="#org0000009">1.2.3. 转换为 tflite</a></li>
<li><a href="#org0000012">1.2.4. tensorflow lite</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000018" class="outline-2">
<h2 id="org0000018"><span class="section-number-2">1</span> Save Model</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1</span> Frozen Graph</h3>
</div>

<div id="outline-container-org0000015" class="outline-3">
<h3 id="org0000015"><span class="section-number-3">1.2</span> Saved Model</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0000003" class="outline-4">
<h4 id="org0000003"><span class="section-number-4">1.2.1</span> 保存</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-ipython">import tensorflow as tf
import numpy as np
from tensorflow.keras import layers,losses,metrics,optimizers, models

X = tf.random.uniform([100, 1], minval = 1, maxval = 10.)
Y = tf.pow(X,2)

tf.keras.backend.clear_session()

model = models.Sequential();
model.add(layers.Dense(100, input_shape=(1,),activation="relu"))
model.add(layers.Dense(100,activation="relu"))
model.add(layers.Dense(100,activation="relu"))
model.add(layers.Dense(100,activation="relu"))
model.add(layers.Dense(100,activation="relu"))
model.add(layers.Dense(1))

model.summary()

model.compile(optimizer="adam",loss="mse")
history = model.fit(X,Y,batch_size = 20,epochs = 2000, verbose = 0)
print(model.predict([2.,10.,20]))

model.save("/tmp/pow")

</pre>
</div>

<p>
Model: "sequential"
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
Layer (type)                 Output Shape              Param #   
<code>===============================================================</code>
dense (Dense)                (None, 100)               200       
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
dense_1 (Dense)              (None, 100)               10100     
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
dense_2 (Dense)              (None, 100)               10100     
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
dense_3 (Dense)              (None, 100)               10100     
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
dense_4 (Dense)              (None, 100)               10100     
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
dense_5 (Dense)              (None, 1)                 101       
<code>===============================================================</code>
Total params: 40,701
Trainable params: 40,701
Non-trainable params: 0
<span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline"><span class="underline">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
[[  3.9387243]
 [101.11033  ]
 [258.403    ]]
<a href="tensorflow:Assets">tensorflow:Assets</a> written to: /tmp/pow/assets
<a href="tensorflow:Assets">tensorflow:Assets</a> written to: /tmp/pow/assets
</p>

<div class="org-src-container">
<pre class="src src-sh">ls -l /tmp/pow
</pre>
</div>

<p>
total 144
drwxr-xr-x 1 sunway sunway    512 Jul 24 10:56 assets
-rw-r&#x2013;r&#x2013; 1 sunway sunway 146845 Jul 24 10:56 saved_model.pb
drwxr-xr-x 1 sunway sunway    512 Jul 24 10:56 variables
</p>
</div>
</div>

<div id="outline-container-org0000006" class="outline-4">
<h4 id="org0000006"><span class="section-number-4">1.2.2</span> 加载</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-ipython">import tensorflow as tf

model = tf.keras.models.load_model ("/tmp/pow")
print(model.predict([2, 10]))

</pre>
</div>

<p>
[[ 4.026423]
 [99.485054]]
</p>
</div>
</div>

<div id="outline-container-org0000009" class="outline-4">
<h4 id="org0000009"><span class="section-number-4">1.2.3</span> 转换为 tflite</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-ipython">import tensorflow as tf

converter = tf.lite.TFLiteConverter.from_saved_model("/tmp/pow")
# converter.optimizations = [tf.lite.Optimize.OPTIMIZE_FOR_SIZE]

tflite = converter.convert()
with open ("/tmp/pow.tflite","wb") as f:
    f.write(tflite)
    print("size of tflite:", len(tflite))

converter = tf.lite.TFLiteConverter.from_saved_model("/tmp/pow")
converter.optimizations = [tf.lite.Optimize.OPTIMIZE_FOR_SIZE]

tflite = converter.convert()
with open ("/tmp/pow-q.tflite","wb") as f:
    f.write(tflite)
    print("size of tflite-q:", len(tflite))
</pre>
</div>

<p>
size of tflite: 166160
size of tflite-q: 46496
</p>

<p>
一个 40K 个参数, 不用量化时所有参数的大小大约是 40K*4=160K, 因为每个参数都是
float32, 占用 4B
</p>

<p>
使用 8bit 量化后, 参数大小为 40K, 因为每个参数只占 1B
</p>

<p>
size of tflite: 166160
size of tflite-q: 46496
</p>
</div>
</div>

<div id="outline-container-org0000012" class="outline-4">
<h4 id="org0000012"><span class="section-number-4">1.2.4</span> tensorflow lite</h4>
<div class="outline-text-4" id="text-1-2-4">
</div>
<div id="outline-container-org000000c" class="outline-5">
<h5 id="org000000c"><span class="section-number-5">1.2.4.1</span> python</h5>
<div class="outline-text-5" id="text-1-2-4-1">
<div class="org-src-container">
<pre class="src src-ipython">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# 2020-07-24 15:12
import numpy as np
import tensorflow as tf

interpreter = tf.lite.Interpreter(model_path="/tmp/tflite-q")
interpreter.allocate_tensors()

input_details = interpreter.get_input_details()
output_details = interpreter.get_output_details()

interpreter.set_tensor(input_details[0]['index'], tf.constant([[9.,]]))
interpreter.invoke()

output_data = interpreter.get_tensor(output_details[0]['index'])
print(output_data)
</pre>
</div>

<p>

</p>
</div>
</div>

<div id="outline-container-org000000f" class="outline-5">
<h5 id="org000000f"><span class="section-number-5">1.2.4.2</span> c++</h5>
<div class="outline-text-5" id="text-1-2-4-2">
<div class="org-src-container">
<pre class="src src-c++"><span class="org-comment-delimiter">// </span><span class="org-comment">cd ${TENSORFLOW_ROOT_DIR}/tensorflow/lite/tools/make</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">./download_dependencies.sh</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">./build_lib.sh</span>
<span class="org-comment-delimiter">// </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">g++</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">-I${TENSORFLOW_ROOT_DIR}/tensorflow/lite/tools/make/downloads/flatbuffers/include</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">-I${TENSORFLOW_ROOT_DIR} -pthread -Wall -Wextra -pedantic -o square square.cc</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">-L${TENSORFLOW_ROOT_DIR}/tensorflow/lite/tools/make/gen/linux_x86_64/lib/</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">-ltensorflow-lite -ldl</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">./square /tmp/tflite-q</span>

<span class="org-preprocessor">#include</span> <span class="org-string">&lt;cstdio&gt;</span>

<span class="org-preprocessor">#include</span> <span class="org-string">"tensorflow/lite/interpreter.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"tensorflow/lite/kernels/register.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"tensorflow/lite/model.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"tensorflow/lite/optional_debug_tools.h"</span>

<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">tflite</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>* <span class="org-variable-name">argv</span>[]) {
    <span class="org-keyword">if</span> (argc != 2) {
        fprintf(stderr, <span class="org-string">"square &lt;tflite model&gt;\n"</span>);
        <span class="org-keyword">return</span> 1;
    }
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span> = argv[1];

    <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span>&lt;<span class="org-constant">tflite</span>::FlatBufferModel&gt; <span class="org-variable-name">model</span> =
        <span class="org-constant">tflite</span>::<span class="org-constant">FlatBufferModel</span>::BuildFromFile(filename);

    <span class="org-constant">tflite</span>::<span class="org-constant">ops</span>::<span class="org-constant">builtin</span>::<span class="org-type">BuiltinOpResolver</span> <span class="org-variable-name">resolver</span>;
    <span class="org-type">InterpreterBuilder</span> <span class="org-variable-name">builder</span>(*model, resolver);
    <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span>&lt;Interpreter&gt; <span class="org-variable-name">interpreter</span>;
    builder(&amp;interpreter);

    interpreter-&gt;AllocateTensors();
    <span class="org-type">float</span>* <span class="org-variable-name">input</span> = interpreter-&gt;typed_input_tensor&lt;<span class="org-type">float</span>&gt;(0);
    input[0] = 10;
    interpreter-&gt;Invoke();
    <span class="org-type">float</span>* <span class="org-variable-name">output</span> = interpreter-&gt;typed_output_tensor&lt;<span class="org-type">float</span>&gt;(0);
    printf(<span class="org-string">"%f\n"</span>, output[0]);

    <span class="org-keyword">return</span> 0;
}

</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2020-07-24 Fri 00:00<br />
Last updated: 2020-08-16 Sun 13:47</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
