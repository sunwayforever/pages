<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 12:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Datasets</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Datasets</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org42bc65e">1. <span class="done DONE">DONE</span> Datasets</a></li>
</ul>
</div>
</div>

<div id="outline-container-org42bc65e" class="outline-2">
<h2 id="org42bc65e"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> Datasets</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-12-10 四 10:22]</span></span></li>

<li>tensorflow dataset 不支持 eager execution, 所以 map,filter 等方法无法直接使用
python 代码, 需要用 numpy_function 封装一下</li>

<li>map 支持 num_parallel_calls, 可以自动多线程处理数据</li>

<li>prefetch 可以在 GPU 训练时通过 CPU 提前加载数据</li>

<li>from_generator 返回的数据不应包括 batch 维度, dataset 的 batch 方法会产生最终的 batch 维度</li>

<li>使用 dataset 时, 由于 dataset 已经指定了 batch 大小, 所以 model.fit 不需要再指定 batch_size</li>

<li>对于 from_generator 的 dataset, 由于总大小未知, model.fit 时需要通过
steps_per_epoch 指定一个 epoch 需要多少个 batch 的数据. 或者使用 dataset 的
take(N) 让它只返回 N 个 batch</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">get_dataset</span><span style="color: #757575;">(</span>mode<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> <span style="color: #757575;">(</span>
        tf.data.Dataset.from_generator<span style="color: #757575;">(</span>
            <span style="color: #859900;">lambda</span>: data_generator<span style="color: #757575;">(</span>mode<span style="color: #757575;">),</span>
            output_types=<span style="color: #757575;">(</span>tf.string<span style="color: #757575;">,</span> tf.string<span style="color: #757575;">),</span>
        <span style="color: #757575;">)</span>
        .<span style="color: #839496;">map</span><span style="color: #757575;">(</span>decode_op<span style="color: #757575;">,</span> num_parallel_calls=40<span style="color: #757575;">)</span>
        .<span style="color: #839496;">filter</span><span style="color: #757575;">(</span>filter_op<span style="color: #757575;">)</span>
        .batch<span style="color: #757575;">(</span>BATCH_SIZE<span style="color: #757575;">)</span>
        .prefetch<span style="color: #757575;">(</span>tf.data.experimental.AUTOTUNE<span style="color: #757575;">)</span>
    <span style="color: #757575;">)</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">norm</span><span style="color: #757575;">(</span>x<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> <span style="color: #757575;">(</span>x ** 2<span style="color: #757575;">)</span>.<span style="color: #839496;">sum</span><span style="color: #757575;">()</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">filter_op</span><span style="color: #757575;">(</span>a<span style="color: #757575;">,</span> b<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> tf.numpy_function<span style="color: #757575;">(</span>filter_audio<span style="color: #757575;">,</span> [a<span style="color: #757575;">,</span> b]<span style="color: #757575;">,</span> tf.<span style="color: #839496;">bool</span><span style="color: #757575;">)</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">filter_audio</span><span style="color: #757575;">(</span>a<span style="color: #757575;">,</span> b<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> norm<span style="color: #757575;">(</span>a<span style="color: #757575;">)</span> &gt; MIN_ENERGY


<span style="color: #859900;">def</span> <span style="color: #268bd2;">decode_op</span><span style="color: #757575;">(</span>a<span style="color: #757575;">,</span> b<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> tf.numpy_function<span style="color: #757575;">(</span>decode_audio<span style="color: #757575;">,</span> [a<span style="color: #757575;">,</span> b]<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>tf.float32<span style="color: #757575;">,</span> tf.float32<span style="color: #757575;">))</span>


<span style="color: #268bd2;">zeros</span> = np.zeros<span style="color: #757575;">(</span>SAMPLE_FRAMES<span style="color: #757575;">)</span>.astype<span style="color: #757575;">(</span>np.float32<span style="color: #757575;">)</span>
<span style="color: #268bd2;">ignored</span> = <span style="color: #757575;">(</span>
    zeros<span style="color: #757575;">,</span>
    np.stack<span style="color: #757575;">((</span>zeros<span style="color: #757575;">,</span> zeros<span style="color: #757575;">)),</span>
<span style="color: #757575;">)</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">decode_audio</span><span style="color: #757575;">(</span>clean_file<span style="color: #757575;">,</span> noise_file<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">signal</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">_</span> = librosa.load<span style="color: #757575;">(</span>clean_file<span style="color: #757575;">,</span> sr=SAMPLE_RATE<span style="color: #757575;">,</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">signal, _ = sf.read(clean_file, dtype="float32")</span>
    <span style="color: #859900;">if</span> signal.shape[0] &lt;= SAMPLE_FRAMES:
        <span style="color: #859900;">return</span> ignored

    <span style="color: #268bd2;">beg</span> = np.random.randint<span style="color: #757575;">(</span>signal.shape[0] - SAMPLE_FRAMES<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">end</span> = beg + SAMPLE_FRAMES
    <span style="color: #268bd2;">clean_signal</span> = signal[beg:end]

    <span style="color: #268bd2;">signal</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">_</span> = librosa.load<span style="color: #757575;">(</span>noise_file<span style="color: #757575;">,</span> sr=SAMPLE_RATE<span style="color: #757575;">,</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">signal, _ = sf.read(noise_file, dtype="float32")</span>
    <span style="color: #859900;">if</span> signal.shape[0] &lt;= SAMPLE_FRAMES:
        <span style="color: #859900;">return</span> ignored

    <span style="color: #268bd2;">beg</span> = np.random.randint<span style="color: #757575;">(</span>signal.shape[0] - SAMPLE_FRAMES<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">end</span> = beg + SAMPLE_FRAMES
    <span style="color: #268bd2;">noise_signal</span> = signal[beg:end]

    <span style="color: #268bd2;">noisy</span> = <span style="color: #757575;">(</span>
        clean_signal + np.sqrt<span style="color: #757575;">(</span>norm<span style="color: #757575;">(</span>clean_signal<span style="color: #757575;">)</span> / norm<span style="color: #757575;">(</span>noise_signal<span style="color: #757575;">))</span> * noise_signal
    <span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> noisy<span style="color: #757575;">,</span> np.stack<span style="color: #757575;">((</span>clean_signal<span style="color: #757575;">,</span> noise_signal<span style="color: #757575;">))</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">data_generator</span><span style="color: #757575;">(</span>mode<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">clean_files</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">noise_files</span> = data[mode][<span style="color: #2aa198;">"clean"</span>]<span style="color: #757575;">,</span> data[mode][<span style="color: #2aa198;">"noise"</span>]
    <span style="color: #859900;">while</span> <span style="color: #268bd2; font-weight: bold;">True</span>:
        <span style="color: #859900;">yield</span> np.random.choice<span style="color: #757575;">(</span>clean_files<span style="color: #757575;">),</span> np.random.choice<span style="color: #757575;">(</span>noise_files<span style="color: #757575;">)</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    <span style="color: #268bd2;">dataset</span> = <span style="color: #839496;">iter</span><span style="color: #757575;">(</span>get_dataset<span style="color: #757575;">(</span><span style="color: #2aa198;">"train"</span><span style="color: #757575;">))</span>
    <span style="color: #859900;">print</span><span style="color: #757575;">(</span><span style="color: #839496;">next</span><span style="color: #757575;">(</span>dataset<span style="color: #757575;">))</span>


<span style="color: #586e75;"># </span><span style="color: #586e75;">&#20351;&#29992; dataset </span>
model.fit<span style="color: #757575;">(</span>
    get_dataset<span style="color: #757575;">(</span><span style="color: #2aa198;">"train"</span><span style="color: #757575;">),</span>
    steps_per_epoch=N_BATCH<span style="color: #757575;">,</span>
    epochs=FLAGS.epoch<span style="color: #757575;">,</span>
    callbacks=[save_model_callback<span style="color: #757575;">,</span> tensorboard_callback]<span style="color: #757575;">,</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">validation_data=data_generator("test"),</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">validation_freq=5,</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">validation_steps=2,</span>
    shuffle=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #757575;">,</span>
    verbose=1<span style="color: #757575;">,</span>
<span style="color: #757575;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
