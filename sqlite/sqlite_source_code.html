<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 11:55 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sqlite Source Code</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Sqlite Source Code</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb307b6b">1. SQlite: Source Code</a>
<ul>
<li><a href="#org6941ccf">1.1. data structure</a>
<ul>
<li><a href="#org1065f45">1.1.1. sqlite3</a></li>
<li><a href="#org7442b89">1.1.2. sqlite3_vfs</a></li>
<li><a href="#org265236e">1.1.3. sqlite3_file</a></li>
<li><a href="#org2c00d49">1.1.4. sqlite3_io_methods</a></li>
<li><a href="#org77ca2bd">1.1.5. struct sqlite3_mem_methods</a></li>
<li><a href="#org7f94937">1.1.6. PgHdr</a></li>
<li><a href="#org45d3e64">1.1.7. Schema</a></li>
<li><a href="#org76af1ce">1.1.8. lookaside</a></li>
<li><a href="#orgc7bf229">1.1.9. unixInodeInfo</a></li>
<li><a href="#org9abd302">1.1.10. MemPage</a></li>
<li><a href="#orgab889d7">1.1.11. Btree</a></li>
<li><a href="#orgb8dabe0">1.1.12. BtShared</a></li>
<li><a href="#org901165d">1.1.13. BtCursor</a></li>
<li><a href="#org4a96e58">1.1.14. Mem</a></li>
<li><a href="#orga933bf4">1.1.15. 总结</a></li>
</ul>
</li>
<li><a href="#orgfcb0849">1.2. Pcache</a>
<ul>
<li><a href="#orgf79b20c">1.2.1. sqlite3PcacheFetch</a></li>
<li><a href="#org161dba9">1.2.2. pcache1Fetch</a></li>
<li><a href="#org48f5dba">1.2.3. 总结</a></li>
</ul>
</li>
<li><a href="#orgc4ebaa4">1.3. RowSet</a></li>
<li><a href="#org25c0bfb">1.4. WAL</a>
<ul>
<li><a href="#org2a1c827">1.4.1. sqlite3WalBeginReadTransaction</a></li>
<li><a href="#org0db6df2">1.4.2. walCheckpoint</a></li>
<li><a href="#org13fe742">1.4.3. sqlite3WalFrames</a></li>
<li><a href="#orge712c76">1.4.4. sqlite3WalClose</a></li>
<li><a href="#orgf100825">1.4.5. walLimitSize</a></li>
<li><a href="#orgc74a724">1.4.6. WAL Index</a></li>
</ul>
</li>
<li><a href="#org7a0a998">1.5. Rollback Journal</a>
<ul>
<li><a href="#orgaa2120b">1.5.1. hasHotJournal</a></li>
<li><a href="#org9758aad">1.5.2. syncJournal</a></li>
<li><a href="#org48f2e28">1.5.3. pager_playback</a></li>
</ul>
</li>
<li><a href="#org2ade1a0">1.6. Pager</a>
<ul>
<li><a href="#org38eb5bb">1.6.1. pager_playback</a></li>
<li><a href="#orgf915905">1.6.2. readDbPage</a></li>
<li><a href="#org9960874">1.6.3. syncJournal</a></li>
<li><a href="#orgec0394a">1.6.4. pager_write_pagelist</a></li>
<li><a href="#orgc7cc384">1.6.5. sqlite3PagerSync</a></li>
<li><a href="#org1ac75b8">1.6.6. pagerStress</a></li>
<li><a href="#org377f717">1.6.7. sqlite3PagerAcquire</a></li>
<li><a href="#org73e5a06">1.6.8. sqlite3PagerShrink</a></li>
<li><a href="#orga72623f">1.6.9. pager_open_journal</a></li>
<li><a href="#orgdd82672">1.6.10. sqlite3PagerSharedLock</a></li>
<li><a href="#orgddca0ed">1.6.11. sqlite3PagerBegin</a></li>
<li><a href="#orgdeaf259">1.6.12. sqlite3PagerWrite &amp;&amp; pager_write</a></li>
<li><a href="#orgf497b16">1.6.13. sqlite3PagerCommitPhaseOne</a></li>
<li><a href="#orgdffbe4f">1.6.14. sqlite3PagerCommitPhaseTwo</a></li>
<li><a href="#org13eba1a">1.6.15. sqlite3PagerRollback</a></li>
<li><a href="#org951197a">1.6.16. sqlite3PagerOpen</a></li>
<li><a href="#org85bb94d">1.6.17. sqlite3PagerClose</a></li>
</ul>
</li>
<li><a href="#orgc554f20">1.7. Btree</a>
<ul>
<li><a href="#orgf74952b">1.7.1. Btree</a></li>
<li><a href="#orgd1ea108">1.7.2. BtShared</a></li>
<li><a href="#orgd8daf08">1.7.3. BtCursor</a></li>
</ul>
</li>
<li><a href="#org013834d">1.8. VDBE</a>
<ul>
<li><a href="#org9b3ad6a">1.8.1. Mem</a></li>
</ul>
</li>
<li><a href="#org29ba8da">1.9. 内存分配</a>
<ul>
<li><a href="#orgf15fa8e">1.9.1. alloc</a></li>
<li><a href="#orgf50ad47">1.9.2. status</a></li>
<li><a href="#org389e39e">1.9.3. setting</a></li>
<li><a href="#orgfcf4190">1.9.4. lookaside</a></li>
<li><a href="#orgcd85efa">1.9.5. scratch</a></li>
<li><a href="#orgd314a99">1.9.6. pcache</a></li>
<li><a href="#orge83fdf2">1.9.7. Other</a></li>
</ul>
</li>
<li><a href="#orga272d57">1.10. 文件锁</a>
<ul>
<li><a href="#org065daf2">1.10.1. shared_lock</a></li>
<li><a href="#org2f05a15">1.10.2. reserved_lock</a></li>
<li><a href="#org99076dc">1.10.3. exclusive_lock</a></li>
</ul>
</li>
<li><a href="#org7647a84">1.11. query</a>
<ul>
<li><a href="#org875f97a">1.11.1. sqlite3_open_v2</a></li>
<li><a href="#org7c3916f">1.11.2. sqlite3_prepare</a></li>
<li><a href="#org6fdc2dc">1.11.3. sqlite3_step</a></li>
<li><a href="#org6438428">1.11.4. journal 操作</a></li>
</ul>
</li>
<li><a href="#org7e45fbc">1.12. insert</a>
<ul>
<li><a href="#org9825d5d">1.12.1. sqlite3_step</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgb307b6b" class="outline-2">
<h2 id="orgb307b6b"><span class="section-number-2">1</span> SQlite: Source Code</h2>
<div class="outline-text-2" id="text-1">
<p>
sqlite3.c 分为以下几个模块:
</p>
<ol class="org-ol">
<li>parser</li>
<li>vdbe</li>
<li>btree</li>
<li>pager</li>
<li>pcache</li>
</ol>
</div>

<div id="outline-container-org6941ccf" class="outline-3">
<h3 id="org6941ccf"><span class="section-number-3">1.1</span> data structure</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org1065f45" class="outline-4">
<h4 id="org1065f45"><span class="section-number-4">1.1.1</span> sqlite3</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">sqlite3</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">sqlite3_vfs</span> *<span style="color: #268bd2;">pVfs</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">OS Interface</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">struct</span> <span style="color: #b58900;">Vdbe</span> *<span style="color: #268bd2;">pVdbe</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">List of active virtual machines</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">CollSeq</span> *<span style="color: #268bd2;">pDfltColl</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">The default collating sequence (BINARY)</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">sqlite3_mutex</span> *<span style="color: #268bd2;">mutex</span>;         <span style="color: #586e75;">/* </span><span style="color: #586e75;">Connection mutex</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Db</span> *<span style="color: #268bd2;">aDb</span>;                      <span style="color: #586e75;">/* </span><span style="color: #586e75;">All backends</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nDb</span>;                      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of backends currently in use</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">flags</span>;                    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Miscellaneous flags. See below</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">i64</span> <span style="color: #268bd2;">lastRowid</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">ROWID of most recent insert (see above)</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">openFlags</span>;       <span style="color: #586e75;">/* </span><span style="color: #586e75;">Flags passed to sqlite3_vfs.xOpen()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">errCode</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Most recent error code (SQLITE_*)</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">errMask</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">&amp; result codes with this before returning</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">autoCommit</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">The auto-commit flag.</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">temp_store</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">1: file 2: memory 0: default</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">mallocFailed</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">True if we have seen a malloc failure</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">dfltLockMode</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Default locking-mode for attached dbs</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">signed</span> <span style="color: #b58900;">char</span> <span style="color: #268bd2;">nextAutovac</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Autovac setting after VACUUM if &gt;=0</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">suppressErr</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Do not issue error messages if true</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">vtabOnConflict</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Value to return for s3_vtab_on_conflict()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">isTransactionSavepoint</span>;    <span style="color: #586e75;">/* </span><span style="color: #586e75;">True if the outermost savepoint is a TS</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nextPagesize</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Pagesize after VACUUM if &gt;0</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u32</span> <span style="color: #268bd2;">magic</span>;                    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Magic number for detect library misuse</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nChange</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Value returned by sqlite3_changes()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nTotalChange</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Value returned by sqlite3_total_changes()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">aLimit</span>[SQLITE_N_LIMIT];   <span style="color: #586e75;">/* </span><span style="color: #586e75;">Limits</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">struct</span> <span style="color: #b58900;">sqlite3InitInfo</span> <span style="color: #757575;">{</span>      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Information used during initialization</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">newTnum</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">Rootpage of table being initialized</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">iDb</span>;                     <span style="color: #586e75;">/* </span><span style="color: #586e75;">Which db file is being initialized</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">busy</span>;                    <span style="color: #586e75;">/* </span><span style="color: #586e75;">TRUE if currently initializing</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">orphanTrigger</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Last statement is orphaned TEMP trigger</span><span style="color: #586e75;"> */</span>
    <span style="color: #757575;">}</span> <span style="color: #268bd2;">init</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">activeVdbeCnt</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of VDBEs currently executing</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">writeVdbeCnt</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of active VDBEs that are writing</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">vdbeExecCnt</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of nested calls to VdbeExec()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nExtension</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of loaded extensions</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> **<span style="color: #268bd2;">aExtension</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Array of shared library handles</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xTrace</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">)</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">Trace function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pTraceArg</span>;                          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to the trace function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xProfile</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">u64</span><span style="color: #757575;">)</span>;  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Profiling function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pProfileArg</span>;                        <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to profile function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pCommitArg</span>;                 <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to xCommitCallback()</span><span style="color: #586e75;"> */</span>   
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xCommitCallback</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Invoked at every commit.</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pRollbackArg</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to xRollbackCallback()</span><span style="color: #586e75;"> */</span>   
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xRollbackCallback</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>; <span style="color: #586e75;">/* </span><span style="color: #586e75;">Invoked at every commit.</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pUpdateArg</span>;
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xUpdateCallback</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">int</span><span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">sqlite_int64</span><span style="color: #757575;">)</span>;
<span style="color: #268bd2;">#if</span><span style="color: #268bd2; font-weight: bold;">n</span><span style="color: #268bd2;">def</span> SQLITE_OMIT_WAL
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xWalCallback</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span> *<span style="color: #757575;">,</span> <span style="color: #b58900;">sqlite3</span> *<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #757575;">,</span> <span style="color: #b58900;">int</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pWalArg</span>;
<span style="color: #268bd2;">#endif</span>
    <span style="color: #b58900;">void</span><span style="color: #757575;">(</span>*<span style="color: #268bd2;">xCollNeeded</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">sqlite3</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">eTextRep</span><span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span><span style="color: #757575;">(</span>*<span style="color: #268bd2;">xCollNeeded16</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">sqlite3</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">eTextRep</span><span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pCollNeededArg</span>;
    <span style="color: #b58900;">sqlite3_value</span> *<span style="color: #268bd2;">pErr</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Most recent error message</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zErrMsg</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">Most recent error message (UTF-8 encoded)</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zErrMsg16</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Most recent error message (UTF-16 encoded)</span><span style="color: #586e75;"> */</span>
    <span style="color: #859900;">union</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">volatile</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">isInterrupted</span>; <span style="color: #586e75;">/* </span><span style="color: #586e75;">True if sqlite3_interrupt has been called</span><span style="color: #586e75;"> */</span>
        <span style="color: #b58900;">double</span> <span style="color: #268bd2;">notUsed1</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Spacer</span><span style="color: #586e75;"> */</span>
    <span style="color: #757575;">}</span> <span style="color: #268bd2;">u1</span>;
    <span style="color: #b58900;">Lookaside</span> <span style="color: #268bd2;">lookaside</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Lookaside malloc configuration</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">#if</span><span style="color: #268bd2; font-weight: bold;">n</span><span style="color: #268bd2;">def</span> SQLITE_OMIT_AUTHORIZATION
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xAuth</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">int</span><span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Access authorization function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pAuthArg</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">1st argument to the access auth function</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">#endif</span>
<span style="color: #268bd2;">#if</span><span style="color: #268bd2; font-weight: bold;">n</span><span style="color: #268bd2;">def</span> SQLITE_OMIT_PROGRESS_CALLBACK
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xProgress</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span> *<span style="color: #757575;">)</span>;     <span style="color: #586e75;">/* </span><span style="color: #586e75;">The progress callback</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pProgressArg</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to the progress callback</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nProgressOps</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of opcodes for progress callback</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">#endif</span>
<span style="color: #268bd2;">#if</span><span style="color: #268bd2; font-weight: bold;">n</span><span style="color: #268bd2;">def</span> SQLITE_OMIT_VIRTUALTABLE
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nVTrans</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Allocated size of aVTrans</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">aModule</span>;                 <span style="color: #586e75;">/* </span><span style="color: #586e75;">populated by sqlite3_create_module()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">VtabCtx</span> *<span style="color: #268bd2;">pVtabCtx</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Context for active vtab connect/create</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">VTable</span> **<span style="color: #268bd2;">aVTrans</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Virtual tables with open transactions</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">VTable</span> *<span style="color: #268bd2;">pDisconnect</span>;    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Disconnect these in next sqlite3_prepare()</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">#endif</span>
    <span style="color: #b58900;">FuncDefHash</span> <span style="color: #268bd2;">aFunc</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Hash table of connection functions</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">aCollSeq</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">All collating sequences</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">BusyHandler</span> <span style="color: #268bd2;">busyHandler</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Busy callback</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Db</span> <span style="color: #268bd2;">aDbStatic</span>[2];              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Static space for the 2 default backends</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Savepoint</span> *<span style="color: #268bd2;">pSavepoint</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">List of active savepoints</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">busyTimeout</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Busy handler timeout, in msec</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nSavepoint</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of non-transaction savepoints</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nStatement</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of nested statement-transactions</span><span style="color: #586e75;">  */</span>
    <span style="color: #b58900;">i64</span> <span style="color: #268bd2;">nDeferredCons</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Net deferred constraints this transaction.</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> *<span style="color: #268bd2;">pnBytesFreed</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">If not NULL, increment this in DbFree()</span><span style="color: #586e75;"> */</span>

<span style="color: #268bd2;">#ifdef</span> SQLITE_ENABLE_UNLOCK_NOTIFY
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">The following variables are all protected by the STATIC_MASTER </span>
<span style="color: #586e75;">    ** mutex, not by sqlite3.mutex. They are used by code in notify.c. </span>
<span style="color: #586e75;">    **</span>
<span style="color: #586e75;">    ** When X.pUnlockConnection==Y, that means that X is waiting for Y to</span>
<span style="color: #586e75;">    ** unlock so that it can proceed.</span>
<span style="color: #586e75;">    **</span>
<span style="color: #586e75;">    ** When X.pBlockingConnection==Y, that means that something that X tried</span>
<span style="color: #586e75;">    ** tried to do recently failed with an SQLITE_LOCKED error due to locks</span>
<span style="color: #586e75;">    ** held by Y.</span>
<span style="color: #586e75;">    */</span>
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">pBlockingConnection</span>; <span style="color: #586e75;">/* </span><span style="color: #586e75;">Connection that caused SQLITE_LOCKED</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">pUnlockConnection</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Connection to watch for unlock</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pUnlockArg</span>;                     <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to xUnlockNotify</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xUnlockNotify</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span> **<span style="color: #757575;">,</span> <span style="color: #b58900;">int</span><span style="color: #757575;">)</span>;  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Unlock notify callback</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">pNextBlocked</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">Next in list of all blocked connections</span><span style="color: #586e75;"> */</span>
<span style="color: #268bd2;">#endif</span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7442b89" class="outline-4">
<h4 id="org7442b89"><span class="section-number-4">1.1.2</span> sqlite3_vfs</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
e.g. sqlite3-&gt;pVfs
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">sqlite3_vfs</span> <span style="color: #757575;">{</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">vfs &#20013; xOpen &#30340;&#21442;&#25968; sqlite3_file &#30340;"&#23376;&#31867;"&#20195;&#34920;&#20102;&#19981;&#21516;&#24179;&#21488;&#19978;&#30340;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">file, &#20363;&#22914; unixFile, winFile, ..., &#27599;&#20010;"&#23376;&#31867;"&#30340;&#25104;&#21592;&#21644;&#22823;&#23567;&#37117;&#19981;&#21516;,</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20363;&#22914; unixFile &#20250;&#21253;&#21547; unixInodeInfo, unixShm &#36825;&#20123;&#21644; unix &#30456;&#20851;&#30340;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25104;&#21592;, &#24403;&#20351;&#29992; xOpen &#26102;, &#35843;&#29992;&#32773;&#38656;&#35201;&#26681;&#25454; szOsFile &#21021;&#22987;&#21270;&#30456;&#24212;&#22823;&#23567;&#30340;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20869;&#23384;&#20197;&#23481;&#32435; unixFile &#25110;&#32773; winFile</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">szOsFile</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">Size of subclassed sqlite3_file</span><span style="color: #586e75;"> */</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">sqlite3OsInit &#26102;&#20250;&#36890;&#36807; sqlite3_vfs_register &#27880;&#20876;&#22810;&#20010;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sqlite3_vfs, &#20363;&#22914; "unix_nolock" -&gt; unixVfs, &#36825;&#37324;&#30340; vfs &#30340;&#21306;&#21035;&#24182;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19981;&#26159;&#25351;&#19981;&#21516;&#30340;&#24179;&#21488;&#20363;&#22914; unix, win (&#24179;&#21488;&#30340;&#19981;&#21516;&#20250;&#36890;&#36807;&#32534;&#35793;&#23439;&#26469;&#21306;&#20998;),&#32780;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19981;&#26159;&#25351;&#21516;&#19968;&#20010;&#24179;&#21488;&#19978;&#19981;&#21516;&#30340;&#23454;&#29616;.</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#36825;&#20123; vfs &#36890;&#36807; pNext &#32452;&#32455;&#36215;&#26469;. vfs_register &#21482;&#20250;&#22312;&#31532;&#19968;&#27425;&#35843;&#29992;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sqlite3OsInit &#26102;&#34987;&#35843;&#29992;&#19968;&#27425; sqlite3OsInit &#21518;, &#20197;&#21518;&#27599;&#27425;&#35843;&#29992;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sqlite3_open_v2 &#26102;, &#20250;&#26681;&#25454;&#20256;&#20837;&#30340; zVfs &#21442;&#25968;&#36890;&#36807; sqlite3_vfs_find</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25214;&#21040;&#23545;&#24212;&#30340; sqlite3_vfs, &#24182;&#36171;&#32473; sqlite3-&gt;pVfs</span>
    <span style="color: #b58900;">sqlite3_vfs</span> *<span style="color: #268bd2;">pNext</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Next registered VFS</span><span style="color: #586e75;"> */</span>

    <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span>;       <span style="color: #586e75;">/* </span><span style="color: #586e75;">Name of this virtual file system</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pAppData</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Pointer to application-specific data</span>
<span style="color: #586e75;">                              *</span><span style="color: #586e75;"> */</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">xOpen &#29992;&#26469;&#25171;&#24320;&#25991;&#20214; (&#21253;&#25324; db, journal, wal &#25991;&#20214;), &#26080;&#35770;&#25171;&#24320;&#25991;&#20214;&#26159;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21542;&#25104;&#21151;, sqlite3_file &#30340; sqlite3_io_methods &#37117;&#38656;&#35201;&#34987;&#36171;&#20540;. &#20197;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sqlite3PagerOpen &#20026;&#20363;, sqlite3PagerOpen &#20250;&#25226; sqlite3_file &#36171;&#32473;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">pPager-&gt;fd</span>
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xOpen</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sqlite3_file</span>*<span style="color: #757575;">,</span>
                 <span style="color: #b58900;">int</span> <span style="color: #268bd2;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> *<span style="color: #268bd2;">pOutFlags</span><span style="color: #757575;">)</span>;

    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xDelete</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">syncDir</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xAccess</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">flags</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> *<span style="color: #268bd2;">pResOut</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xFullPathname</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nOut</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zOut</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> *<span style="color: #757575;">(</span>*<span style="color: #268bd2;">xDlOpen</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zFilename</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xDlError</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nByte</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zErrMsg</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #757575;">(</span>*<span style="color: #268bd2;">xDlSym</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zSymbol</span><span style="color: #757575;">))(</span><span style="color: #b58900;">void</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xDlClose</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xRandomness</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nByte</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zOut</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xSleep</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">microseconds</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xCurrentTime</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">double</span>*<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xCurrentTimeInt64</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">sqlite3_int64</span>*<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xSetSystemCall</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">,</span> <span style="color: #b58900;">sqlite3_syscall_ptr</span><span style="color: #757575;">)</span>;
    <span style="color: #b58900;">sqlite3_syscall_ptr</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xGetSystemCall</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">)</span>;
    <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #757575;">(</span>*<span style="color: #268bd2;">xNextSystemCall</span><span style="color: #757575;">)(</span><span style="color: #b58900;">sqlite3_vfs</span>*<span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">zName</span><span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org265236e" class="outline-4">
<h4 id="org265236e"><span class="section-number-4">1.1.3</span> sqlite3_file</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
e.g. Pager-&gt;fd
</p>

<p>
sqlite3_file 是 xOpen 要返回的结果, 代表一个打开了的文件, 其"子类"包括
</p>
<ol class="org-ol">
<li>unixFile, winFile, os2File &#x2026;</li>
<li>JournalFile, MemJournal</li>
</ol>

<p>
sqlite3_file 这个"父类"只规定了一个字段 sqlite3_io_methods, 不同的子类需要实现相应的 io method, 例如 xRead, xWrite, xClose &#x2026;, 除此之外, 子类还定义了和自身相关的字段, 例如 unixFile 会定义 inode 信息.
</p>

<p>
Pager 就是通过 pager-&gt;fd 这个 sqlite3_file 来读取 db 文件的. 
</p>
</div>
</div>

<div id="outline-container-org2c00d49" class="outline-4">
<h4 id="org2c00d49"><span class="section-number-4">1.1.4</span> sqlite3_io_methods</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
e.g. sqlite3_file-&gt;pMethods
</p>
</div>
</div>

<div id="outline-container-org77ca2bd" class="outline-4">
<h4 id="org77ca2bd"><span class="section-number-4">1.1.5</span> struct sqlite3_mem_methods</h4>
<div class="outline-text-4" id="text-1-1-5">
<p>
e.g. sqlite3GlobalConfig-&gt;m
</p>

<p>
通过 sqlite3_config 可以提供一个自定义的 sqlite3_mem_methods, 负责内存的分配与释放.  与一般的 malloc 不同的是, sqlite3_mem_methods 提供了一个 xSize 方法用来获取一个指针所对应的已分配内存的大小. 具体的实现是
xMalloc 时把内存大小信息写到了内存的前一个 int64 的位置. 
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">sqlite3_mem_methods</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">void</span> *<span style="color: #757575;">(</span>*<span style="color: #268bd2;">xMalloc</span><span style="color: #757575;">)(</span><span style="color: #b58900;">int</span><span style="color: #757575;">)</span>;         <span style="color: #586e75;">/* </span><span style="color: #586e75;">Memory allocation function</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xFree</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Free a prior allocation</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #757575;">(</span>*<span style="color: #268bd2;">xRealloc</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">,</span><span style="color: #b58900;">int</span><span style="color: #757575;">)</span>;  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Resize an allocation</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xSize</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Return the size of an allocation</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xRoundup</span><span style="color: #757575;">)(</span><span style="color: #b58900;">int</span><span style="color: #757575;">)</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Round up request size to allocation size</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xInit</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Initialize the memory allocator</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #268bd2;">xShutdown</span><span style="color: #757575;">)(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Deinitialize the memory allocator</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pAppData</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">Argument to xInit() and xShutdown()</span><span style="color: #586e75;"> */</span>
<span style="color: #757575;">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f94937" class="outline-4">
<h4 id="org7f94937"><span class="section-number-4">1.1.6</span> PgHdr</h4>
<div class="outline-text-4" id="text-1-1-6">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">PgHdr</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">sqlite3_pcache_page</span> *<span style="color: #268bd2;">pPage</span>;    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Pcache object page handle</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pData</span>;                   <span style="color: #586e75;">/* </span><span style="color: #586e75;">Page data</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pExtra</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Extra content</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">PgHdr</span> *<span style="color: #268bd2;">pDirty</span>;                 <span style="color: #586e75;">/* </span><span style="color: #586e75;">Transient list of dirty pages</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Pager</span> *<span style="color: #268bd2;">pPager</span>;                 <span style="color: #586e75;">/* </span><span style="color: #586e75;">The pager this page is part of</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Pgno</span> <span style="color: #268bd2;">pgno</span>;                     <span style="color: #586e75;">/* </span><span style="color: #586e75;">Page number for this page</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u32</span> <span style="color: #268bd2;">pageHash</span>;                  <span style="color: #586e75;">/* </span><span style="color: #586e75;">Hash of page content</span><span style="color: #586e75;"> */</span>  
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">flags &#21487;&#33021;&#20026; dirty, need_sync, need_read, dont_write &#31561;</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u16</span> <span style="color: #268bd2;">flags</span>;                     <span style="color: #586e75;">/* </span><span style="color: #586e75;">PGHDR flags defined below</span><span style="color: #586e75;"> */</span>

    <span style="color: #b58900;">i16</span> <span style="color: #268bd2;">nRef</span>;                      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of users of this page</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">PCache</span> *<span style="color: #268bd2;">pCache</span>;                <span style="color: #586e75;">/* </span><span style="color: #586e75;">Cache that owns this page</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">PgHdr</span> *<span style="color: #268bd2;">pDirtyNext</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Next element in list of dirty pages</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">PgHdr</span> *<span style="color: #268bd2;">pDirtyPrev</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">Previous element in list of dirty pages</span><span style="color: #586e75;"> */</span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org45d3e64" class="outline-4">
<h4 id="org45d3e64"><span class="section-number-4">1.1.7</span> Schema</h4>
<div class="outline-text-4" id="text-1-1-7">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">Schema</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">schema_cookie</span>;   <span style="color: #586e75;">/* </span><span style="color: #586e75;">Database schema version number for this file</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">iGeneration</span>;     <span style="color: #586e75;">/* </span><span style="color: #586e75;">Generation counter.  Incremented with each change</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">tblHash</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">All tables indexed by name</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">idxHash</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">All (named) indices indexed by name</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">trigHash</span>;       <span style="color: #586e75;">/* </span><span style="color: #586e75;">All triggers indexed by name</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Hash</span> <span style="color: #268bd2;">fkeyHash</span>;       <span style="color: #586e75;">/* </span><span style="color: #586e75;">All foreign keys by referenced table name</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">Table</span> *<span style="color: #268bd2;">pSeqTab</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">The sqlite_sequence table used by AUTOINCREMENT</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">file_format</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Schema format version for this file</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">enc</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Text encoding used by this database</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u16</span> <span style="color: #268bd2;">flags</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">Flags associated with this schema</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">cache_size</span>;      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of pages to use in the cache</span><span style="color: #586e75;"> */</span>
<span style="color: #757575;">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org76af1ce" class="outline-4">
<h4 id="org76af1ce"><span class="section-number-4">1.1.8</span> lookaside</h4>
<div class="outline-text-4" id="text-1-1-8">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">Lookaside</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">u16</span> <span style="color: #268bd2;">sz</span>;                 <span style="color: #586e75;">/* </span><span style="color: #586e75;">Size of each buffer in bytes</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">bEnabled</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">False to disable new lookaside allocations</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">u8</span> <span style="color: #268bd2;">bMalloced</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">True if pStart obtained from sqlite3_malloc()</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nOut</span>;               <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of buffers currently checked out</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">mxOut</span>;              <span style="color: #586e75;">/* </span><span style="color: #586e75;">Highwater mark for nOut</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">anStat</span>[3];          <span style="color: #586e75;">/* </span><span style="color: #586e75;">0: hits.  1: size misses.  2: full misses</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">LookasideSlot</span> *<span style="color: #268bd2;">pFree</span>;   <span style="color: #586e75;">/* </span><span style="color: #586e75;">List of available buffers</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pStart</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">First byte of available memory space</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">void</span> *<span style="color: #268bd2;">pEnd</span>;             <span style="color: #586e75;">/* </span><span style="color: #586e75;">First byte past end of available space</span><span style="color: #586e75;"> */</span>
<span style="color: #757575;">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7bf229" class="outline-4">
<h4 id="orgc7bf229"><span class="section-number-4">1.1.9</span> unixInodeInfo</h4>
<div class="outline-text-4" id="text-1-1-9">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">struct</span> <span style="color: #b58900;">unixInodeInfo</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">struct</span> <span style="color: #b58900;">unixFileId</span> <span style="color: #268bd2;">fileId</span>;       <span style="color: #586e75;">/* </span><span style="color: #586e75;">The lookup key</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nShared</span>;                    <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of SHARED locks held</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">char</span> <span style="color: #268bd2;">eFileLock</span>;        <span style="color: #586e75;">/* </span><span style="color: #586e75;">One of SHARED_LOCK, RESERVED_LOCK etc.</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">char</span> <span style="color: #268bd2;">bProcessLock</span>;     <span style="color: #586e75;">/* </span><span style="color: #586e75;">An exclusive process lock is held</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nRef</span>;                       <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of pointers to this structure</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unixShmNode</span> *<span style="color: #268bd2;">pShmNode</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Shared memory associated with this inode</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nLock</span>;                      <span style="color: #586e75;">/* </span><span style="color: #586e75;">Number of outstanding file locks</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">UnixUnusedFd</span> *<span style="color: #268bd2;">pUnused</span>;          <span style="color: #586e75;">/* </span><span style="color: #586e75;">Unused file descriptors to close</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unixInodeInfo</span> *<span style="color: #268bd2;">pNext</span>;           <span style="color: #586e75;">/* </span><span style="color: #586e75;">List of all unixInodeInfo objects</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">unixInodeInfo</span> *<span style="color: #268bd2;">pPrev</span>;           <span style="color: #586e75;">/*    </span><span style="color: #586e75;">.... doubly linked</span><span style="color: #586e75;"> */</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
由于 posix 的文件锁实现对于多线程是有问题的 (参考源码中 Posix Advisory
Locking 部分), 所以 sqlite 使用了一个 unixInodeInfo 记录一个进程中对同一个 inode 的加锁情况. 
</p>

<p>
同一个进程的多个线程可能会打开同一个 db 文件多次, 对应多少 unixFile,
但因为这些 unixFile 对应同一个 inode, 所以 unixFile-&gt;pInode 指向同一个
unixInodeInfo 结构.  
</p>

<p>
这样当同一个进程的某个线程对某 unixFile 获得了 shared lock 时, 另一个线程再想对同一个 inode 的另一个 unixFile 加 shared lock 时, 不再需要调用 unixFileLock 真正加锁, 而是通过 nShared + 1 获得 shared lock.
</p>
</div>
</div>

<div id="outline-container-org9abd302" class="outline-4">
<h4 id="org9abd302"><span class="section-number-4">1.1.10</span> MemPage</h4>
<div class="outline-text-4" id="text-1-1-10">
<p>
Btree 眼中的 page, 包括一个对 DbPage 的引用, 以及 page 内部的信息, 例如 cell, overflow 等
</p>
</div>
</div>

<div id="outline-container-orgab889d7" class="outline-4">
<h4 id="orgab889d7"><span class="section-number-4">1.1.11</span> Btree</h4>
</div>

<div id="outline-container-orgb8dabe0" class="outline-4">
<h4 id="orgb8dabe0"><span class="section-number-4">1.1.12</span> BtShared</h4>
</div>

<div id="outline-container-org901165d" class="outline-4">
<h4 id="org901165d"><span class="section-number-4">1.1.13</span> BtCursor</h4>
</div>

<div id="outline-container-org4a96e58" class="outline-4">
<h4 id="org4a96e58"><span class="section-number-4">1.1.14</span> Mem</h4>
</div>

<div id="outline-container-orga933bf4" class="outline-4">
<h4 id="orga933bf4"><span class="section-number-4">1.1.15</span> 总结</h4>
<div class="outline-text-4" id="text-1-1-15">
<ul class="org-ul">
<li>Db -&gt;Btree -&gt; BtShared -&gt; Pager -&gt; pcache, 以上各个结构体都对应了一个数据库文件.</li>
<li>BtShared 包含多个 BtCursor, 代表正在操作的各个表.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfcb0849" class="outline-3">
<h3 id="orgfcb0849"><span class="section-number-3">1.2</span> Pcache</h3>
<div class="outline-text-3" id="text-1-2">
<p>
通过 sqlite3_pcache_methods2 结构体, 用户可以通过 sqlite3_config 指定一个自定义的 pcache 实现. sqlite3 使用 pcache1 做为默认的 pcache 实现. 
</p>
</div>

<div id="outline-container-orgf79b20c" class="outline-4">
<h4 id="orgf79b20c"><span class="section-number-4">1.2.1</span> sqlite3PcacheFetch</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
pager 负责调用 sqlite3PcacheFetch (通过 sqlite3PagerAcquire)
</p>
<div class="org-src-container">
<pre class="src src-text">int sqlite3PcacheFetch(
    PCache *pCache,       /* Obtain the page from this cache */
    Pgno pgno,            /* Page number to obtain */
    int createFlag,       /* If true, create page if it does not exist already */
    PgHdr **ppPage        /* Write the page here */
  ):
  // &#36890;&#36807; pcach1 &#33719;&#24471;&#19968;&#20010; page
  pPage = sqlite3GlobalConfig.pcache2.xFetch(pCache-&gt;pCache, pgno, eCreate);
  // &#33509; pcach1 &#26080;&#27861;&#20998;&#37197;&#19968;&#20010; page: &#20363;&#22914; pcache1 &#28385;&#20102;&#32780; lru list &#20026;&#31354;
  if( !pPage &amp;&amp; eCreate==1 ):
    // &#20174; pcache &#33258;&#24049;&#32500;&#25252;&#30340; pDirty &#20013;&#25214;&#21040;&#19968;&#20010; dirty &#30340;&#20294; nRef &#20026; 0 &#30340; page
    // pDirty &#20013;&#30340; page &#19968;&#23450;&#19981;&#23384;&#22312;&#20110; pcach1 &#30340; lru list &#20013;.
    for(pPg=pCache-&gt;pDirtyTail; pPg &amp;&amp; pPg-&gt;nRef; pPg=pPg-&gt;pDirtyPrev);
    // &#35843;&#29992; pagerStress, &#25226; pPg &#36825;&#20010;&#31354;&#38386;&#30340; dirty page &#21047;&#26032;&#21040;&#25968;&#25454;&#24211;&#20013;
    // &#21047;&#26032;&#21518;&#20250;&#35843;&#29992; pPg
    rc = pCache-&gt;xStress(pCache-&gt;pStress, pPg);
      sqlite3PcacheMakeClean(pPg);
        pcacheRemoveFromDirtyList(p);
        // unpin &#20250;&#23548;&#33268;&#36825;&#20010; page &#34987;&#25918;&#20837; lru list
        pcacheUnpin(p);
    // &#20877;&#27425;&#35843;&#29992; pcache1Fetch
    pPage = sqlite3GlobalConfig.pcache2.xFetch(pCache-&gt;pCache, pgno, 2);
  // page &#30340; nRef + 1
  pPgHdr-&gt;nRef++;

</pre>
</div>
</div>
</div>

<div id="outline-container-org161dba9" class="outline-4">
<h4 id="org161dba9"><span class="section-number-4">1.2.2</span> pcache1Fetch</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-text">// p &#26159; pcache &#23454;&#20363;
// iKey &#23454;&#38469;&#19978;&#26159; pgno
// pcache &#27169;&#22359;&#26412;&#36523;&#28041;&#21450;&#21040; dirty, 
static sqlite3_pcache_page *pcache1Fetch(       
       sqlite3_pcache *p, 
       unsigned int iKey, 
       int createFlag):
  // &#36890;&#36807; pcache1 &#30340; apHash &#26597;&#25214;, apHash &#20013;&#21487;&#33021;&#21253;&#21547;&#20102;&#25152;&#26377;&#30340; cached
  // page, &#21253;&#21547; pinned (&#19981;&#23384;&#22312;&#20110; lru list), unpinned (&#23384;&#22312;&#20110; lru list)
  // &#20197;&#21450; dirty &#30340;&#31561;
  /* Step 1: Search the hash table for an existing entry. */
  if( pCache-&gt;nHash&gt;0 ):
    unsigned int h = iKey % pCache-&gt;nHash;
    for(pPage=pCache-&gt;apHash[h]; pPage&amp;&amp;pPage-&gt;iKey!=iKey; pPage=pPage-&gt;pNext);
  // &#33509; pPage &#25214;&#21040;, &#21017;&#36820;&#22238;&#36825;&#20010; pPage, &#20294;&#36820;&#22238;&#20043;&#21069;&#20808;&#36890;&#36807; pcache1PinPage
  // &#30830;&#20445;&#36825;&#20010; page &#19981;&#23384;&#22312;&#20110; lru list &#20013;, &#22240;&#20026;&#36825;&#20010; lru list &#30340;&#24847;&#20041;&#26159;&#19968;
  // &#20010;&#23545;&#35937;&#32531;&#23384;, &#23384;&#25918;&#30528;&#37027;&#20123;&#24050;&#32463;&#27809;&#26377;&#24847;&#20041;&#30340;&#23545;&#35937;
  if( pPage || createFlag==0 ):
    pcache1PinPage(pPage);
    goto fetch_out;

  /* Step 3: Abort if createFlag is 1 but the cache is nearly full */
  // &#33509; createFlag==1, &#20294; pcache1 &#24050;&#32463;&#24555;&#28385;&#20102;, &#21017;&#36820;&#22238;&#31354;
  if( createFlag==1 &amp;&amp; (
    nPinned&gt;=pGroup-&gt;mxPinned
    || nPinned&gt;=pCache-&gt;n90pct
    || pcache1UnderMemoryPressure(pCache)
    ):
    goto fetch_out;

  /* Step 4. Try to recycle a page. */
  if( pCache-&gt;bPurgeable &amp;&amp; pGroup-&gt;pLruTail &amp;&amp; (
    (pCache-&gt;nPage+1&gt;=pCache-&gt;nMax)
    || pGroup-&gt;nCurrentPage&gt;=pGroup-&gt;nMaxPage
    || pcache1UnderMemoryPressure(pCache)
    )):
    // &#23581;&#35797;&#20174; lru list &#20013;&#33719;&#24471;&#19968;&#20010;&#26080;&#29992;&#30340; page
    // &#20174; lru list &#30340;&#38431;&#23614;&#33719;&#21462;&#19968;&#20010; page
    pPage = pGroup-&gt;pLruTail;
    // &#20174; apHash &#20013;&#21435;&#25481;&#36825;&#20010; page, &#22240;&#20026;&#36807;&#19968;&#20250;&#20799;&#36825;&#20010; page &#30340;&#20869;&#23481;&#37117;&#37325;&#20889;&#21518;
    // &#20854; key &#19982; value &#19981;&#20877;&#23545;&#24212;. 
    pcache1RemoveFromHash(pPage);
    // &#25226; page &#20174; lru list &#20013;&#31227;&#38500;
    pcache1PinPage(pPage);

  /* Step 5. If a usable page buffer has still not been found, 
  ** attempt to allocate a new one. 
  */
  if( !pPage ):
    // &#20998;&#37197;&#19968;&#20010;&#26032;&#30340; page, &#24182;&#21152;&#20837;&#20110; apHash &#20013;
    pPage = pcache1AllocPage(pCache);
    pCache-&gt;apHash[h] = pPage;

</pre>
</div>
</div>
</div>

<div id="outline-container-org48f5dba" class="outline-4">
<h4 id="org48f5dba"><span class="section-number-4">1.2.3</span> 总结</h4>
<div class="outline-text-4" id="text-1-2-3">
<ol class="org-ol">
<li><p>
pcache 的 dirty list
</p>

<p>
dirty list 不仅在 fetch 时可以用来刷新 page 到 db 以便获得更多的
free page, 更重要的是在 commit 阶段可以根据这个 list 知道哪些
pcache 需要被刷新到 db 文件中
</p></li>

<li><p>
pcache1 的 lru list
</p>

<p>
lru list 是一个对象缓存, 通过 pcache1Unpin 可以把一个无用的 page 放到 lru list 中. 凡是存在于 lru list 的 page 其 nRef 都为 0, 表示无人使用. 
</p>

<p>
dirty list 和 lru list 没有交集. 
</p></li>

<li><p>
pcache1 的 apHash
</p>

<p>
apHash 中的 page 可能存在于 dirty list 中, 也可能存在于 lru list 中
</p></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgc4ebaa4" class="outline-3">
<h3 id="orgc4ebaa4"><span class="section-number-3">1.3</span> RowSet</h3>
<div class="outline-text-3" id="text-1-3">
<p>
RowSet 是 sqlite3 的一个用来支持 RowSet 相关 OP code 的数据结构. 
RowSet 相关的 OP code 包括:
</p>

<ol class="org-ol">
<li>RowSetAdd</li>
<li>RowSetRead</li>
<li>RowSetTest</li>
</ol>

<p>
主要用来实现 `delete where`, `update where` 等功能: 因为 btree 无法在遍历的同时执行 delete, update 等操作, 所以需要用 RowSet 来暂存遍历的结果. 
</p>

<p>
而且 RowSet 本身有排序的功能,  RowSetRead OP code 每次都返回最小的一个值.
</p>
</div>
</div>

<div id="outline-container-org25c0bfb" class="outline-3">
<h3 id="org25c0bfb"><span class="section-number-3">1.4</span> WAL</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org2a1c827" class="outline-4">
<h4 id="org2a1c827"><span class="section-number-4">1.4.1</span> sqlite3WalBeginReadTransaction</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-text">sqlite3PagerSharedLock -&gt; pagerBeginReadTransaction -&gt; sqlite3WalBeginReadTransaction
</pre>
</div>

<p>
sqlite3WalBeginReadTransaction 相当对当前的 wal journal 打开一个 read
snapshot: 获得一把 WAL_READ_LOCK, 设定一个相应的 read mark. 
</p>

<p>
这些 READ_LOCK 和 read mark 可以确保 walCheckpoint 时只将合适的部分
wal journal 内容写回数据库文件.
</p>
</div>
</div>

<div id="outline-container-org0db6df2" class="outline-4">
<h4 id="org0db6df2"><span class="section-number-4">1.4.2</span> walCheckpoint</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
walCheckpoint 并不是把 wal journal 所有的内容都写回到 db 中: 因为此时有可能有 wal reader 正在使用 wal. 例如, 若当前有三个 reader, 其 read
mark 分别为 4,6,8, 则 walCheckpoint 可能只会把 4 之前的内容写回到 db,
因为若此时将 5 写回, 后续 reader 1 可能从 db 中读到修改过的 5, 而这是违反了数据库的隔离性的. 
</p>
</div>
</div>

<div id="outline-container-org13fe742" class="outline-4">
<h4 id="org13fe742"><span class="section-number-4">1.4.3</span> sqlite3WalFrames</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
若使用 WAL journal mode, 则在 commit 之前, 对数据库的修改操作只会导致
pcache 的变化, wal journal 不会受任何影响 (若使用 delete journal, 则在
commit 之前, 任何修改数据库的操作就会通过 sqlite3PagerWrite 导致
delete journal 被修改)
</p>

<p>
在 commit 时, 被修改的 pcache 会被写入到 wal journal (通过
sqlite3WalFrames)
</p>

<div class="org-src-container">
<pre class="src src-text">sqlite3PagerCommitPhaseOne
  pagerWalFrames(pPager, pList, pPager-&gt;dbSize, 1);
    sqlite3WalFrames(  Wal *pWal,                      /* Wal handle to write to */
      int szPage,                     /* Database page-size in bytes */
      PgHdr *pList,                   /* List of dirty pages to write */
      Pgno nTruncate,                 /* Database size after this commit */
      int isCommit,                   /* True if this is a commit */
      int sync_flags                  /* Flags to pass to OsSync() (or 0) */pPager)
      // pList &#26159;&#25152;&#26377; dirty &#30340; pcache &#39029;
      iFrame = pWal-&gt;hdr.mxFrame;
      // mxFrame &#26159; wal &#20013;&#24403;&#21069;&#26368;&#22823;&#30340; frame &#21495;, &#33509; mxFrame &#20026; 0, &#35828;&#26126; wal &#26085;&#24535;&#20026;&#31354;
      if( iFrame==0 ):
        // &#20889; wal &#22836;&#21040;&#26085;&#24535;
        sqlite3OsWrite(pWal-&gt;pWalFd, aWalHdr, sizeof(aWalHdr), 0);
      /* Write all frames into the log file exactly once */
      for(p=pList; p; p=p-&gt;pDirty){
        walWriteOneFrame(&amp;w, p, nDbSize, iOffset);

      // &#23545;&#27599;&#19968;&#20010;&#26032;&#20889;&#20837;&#30340; frame, &#26356;&#26032; wal index
      for(p=pList; p &amp;&amp; rc==SQLITE_OK; p=p-&gt;pDirty){
        walIndexAppend(pWal, iFrame, p-&gt;pgno);
</pre>
</div>

<p>
wal 日志中, 每次 commit 都会导致日志中对应 dirty page 的新 iframe 被添加, 所以, 若同一个 page 在多次 commit 中都被修改了, 则 wal 中会包含对应这个 page 的多个 iframe, 相当于该 page 在不同 commit 时间的
snapshot. 所以 wal 日志相对于 delete journal 会占用更多的空间.
</p>
</div>
</div>

<div id="outline-container-orge712c76" class="outline-4">
<h4 id="orge712c76"><span class="section-number-4">1.4.4</span> sqlite3WalClose</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
wal 文件在数据库连接关闭时会被删除:
</p>
<div class="org-src-container">
<pre class="src src-text">sqlite3PagerClose
  sqlite3WalClose
    // &#38656;&#35201;&#20808;&#33719;&#24471;&#23545; db &#25991;&#20214;&#30340; exclusive lock
    // &#32780;&#22312; wal &#27169;&#24335;&#19979;, shared lock &#22312; commit &#26102;&#24182;&#19981;&#20250;&#37322;&#25918;, &#25152;&#20197;
    // &#36825;&#37324;&#23454;&#38469;&#19978;&#20250;&#23548;&#33268;&#26368;&#21518;&#19968;&#20010;&#36830;&#25509;&#20851;&#38381;&#26102;&#25165;&#21024;&#38500; wal &#25991;&#20214;
    sqlite3OsLock(pWal-&gt;pDbFd, SQLITE_LOCK_EXCLUSIVE);
    sqlite3WalCheckpoint
    walIndexClose(pWal, isDelete);
    sqlite3OsClose(pWal-&gt;pWalFd);
    sqlite3OsDelete(pWal-&gt;pVfs, pWal-&gt;zWalName, 0);
</pre>
</div>

<p>
另外, 每次 commit 之后, 若 wal journal 过大 (当前 mxFrame 指示的大小当于真正的文件大小, 说明文件后面一部分实际是无用的), 则会通过
walLimitSize 尝试把文件大小 truncate 为 journal_size_limit 这个 pragma
指定的大小. 
</p>

<p>
注意的是 journal_size_limit 并不能限制日志文件的最大大小, 只是说在某些情况下需要把文件 truncate 到这个大小. 
</p>

<p>
若 wal 在使用时, 进程异常终止, 而磁盘会遗留一个 wal 文件, 而下一次使用
wal 日志时, sqlite3 会调用 walIndexRecover 来根据 wal 日志重建 wal
index.
</p>
</div>
</div>

<div id="outline-container-orgf100825" class="outline-4">
<h4 id="orgf100825"><span class="section-number-4">1.4.5</span> walLimitSize</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
在 sqlite3WalFrames 时, 若当前设置了 journal_size_limit, 则会根据这个值将 wal journal truncate. 与 wal 不同的是, rollback journal 的
truncate 是发生在 sqlite3BtreeCommitPhaseTwo -&gt; pager_end_transaction
-&gt; zeroJournalHdr 时.
</p>
</div>
</div>

<div id="outline-container-orgc74a724" class="outline-4">
<h4 id="orgc74a724"><span class="section-number-4">1.4.6</span> WAL Index</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
wal index 本意是一个共享内存, 多个 sqlite 进程都可以通过这个 index 获得当前 wal 日志的信息, 实际实现上, 这个共享内存只是对 xxx-shm 文件的
mmap. 
</p>

<p>
wal index 是为了解决这样一个问题: 
</p>

<p>
某个 connection 在打开 wal 时, 当时最大的 iFrame 是 X, 则对于 wal 中所有 &lt;= X 的 iFrame, 与 pgno 对应的最大的 iFrame 是哪个? 即 iFrame = Hash(pgno, X)
</p>


<p>
wal 本身维持着多个锁, 例如 WAL_READ_LOCK, WAL_WRITE_LOCK,
WAL_CKPT_LOCK 等, 这些锁彼此之间一般没有关联, 例如 walCheckpoint 时要求获得对 WAL_CKPT_LOCK 的 exclusive lock, 防止多个 checkpoint 同时进行,
这时可以允许有其他连接持有 WAL_READ_LOCK 对 wal 进行读取. 
</p>
</div>
</div>
</div>

<div id="outline-container-org7a0a998" class="outline-3">
<h3 id="org7a0a998"><span class="section-number-3">1.5</span> Rollback Journal</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orgaa2120b" class="outline-4">
<h4 id="orgaa2120b"><span class="section-number-4">1.5.1</span> hasHotJournal</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
检测一个 journal 是否是 hot journal 很简单: 若 journal header 不为空,
则为 hot journal. 
</p>

<p>
要手工生成 hot journal 是很困难的. 因为 hot journal 只在以下情况下才能产生:
</p>
<ol class="org-ol">
<li>在 synchronous 为 FULL/NORMAL 的情况下, CommitPhaseOne 通过
syncJournal 将 journal sync 成功 sync 到磁盘, 但在 CommitPhaseTwo 时因为掉电等原因没有将日志 delete (或 truncate, persist)</li>
<li>在 synchronous 为 NORMAL 的情况下, 在 syncJournal 因为掉电没有完全成功 (只有 journal header 被写到磁盘)</li>
</ol>
</div>
</div>

<div id="outline-container-org9758aad" class="outline-4">
<h4 id="org9758aad"><span class="section-number-4">1.5.2</span> syncJournal</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
在一个 transaction commit 之前, sqlite3PagerWrite 会不断的将原始的
page 加入到 journal 中. 但此时 journal header 是空白的, 以防将来误认为是一个 hot journal.
</p>

<div class="org-src-container">
<pre class="src src-text">syncJournal
  // &#26500;&#36896; zHeader, &#21253;&#21547; magic &#21644; nRec
  u8 zHeader[sizeof(aJournalMagic)+4];
  memcpy(zHeader, aJournalMagic, sizeof(aJournalMagic));
  put32bits(&amp;zHeader[sizeof(aJournalMagic)], pPager-&gt;nRec);
  if( pPager-&gt;fullSync):
    // &#33509;&#20026; fullSync &#27169;&#24335;, &#23558;&#22312;&#20889; header &#21040; journal &#20043;&#21069;, &#20808;&#23558; journal
    // sync
    sqlite3OsSync(pPager-&gt;jfd, pPager-&gt;syncFlags);
  // &#23558; header &#20889;&#21040;&#26085;&#24535;
  sqlite3OsWrite(pPager-&gt;jfd, zHeader, sizeof(zHeader), pPager-&gt;journalHdr);
  // &#20877; sync &#19968;&#27425;, &#27492;&#21518;&#26085;&#24535;&#21464;&#20026; hot journal
  sqlite3OsSync(pPager-&gt;jfd, ...)
  pPager-&gt;eState = PAGER_WRITER_DBMOD;
</pre>
</div>
</div>
</div>

<div id="outline-container-org48f2e28" class="outline-4">
<h4 id="org48f2e28"><span class="section-number-4">1.5.3</span> pager_playback</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
pager_playback 发生在两个时机:
</p>
<ol class="org-ol">
<li>rollback</li>
<li>打开数据库时 sqlite3PagerSharedLock 通过 hasHotJournal 检测到 hot
journal 后, 调用 pager_playback</li>
</ol>

<div class="org-src-container">
<pre class="src src-text">int pager_playback(Pager *pPager, int isHot):
  // &#33719;&#24471; journal &#25991;&#20214;&#22823;&#23567;, &#21518;&#38754;&#21487;&#33021;&#20250;&#20351;&#29992;&#36825;&#20010;&#20540;&#26469;&#30830;&#23450; journal &#20013;&#26377;&#20960;
  // &#20010; page
  sqlite3OsFileSize(pPager-&gt;jfd, &amp;szJ);
  // &#20174; journal header &#20013;&#35835;&#21040; nRec, mxPg.
  // &#23545;&#20110; hot journal, nRec &#22312; journal header &#26159;&#26377;&#35760;&#24405;&#30340;, &#20294;&#23545;&#20110;
  // &#36890;&#36807; rollback &#21457;&#36215;&#30340; playback, &#27492;&#26102; journal &#24182;&#27809;&#26377; sync &#21040;&#30913;&#30424;,
  // &#20854; nRec &#20063;&#26159;&#27809;&#26377;&#20540;&#30340; (0)
  readJournalHdr(pPager, isHot, szJ, &amp;nRec, &amp;mxPg);

  // &#33509; nRec &#27809;&#26377;&#20540;, &#35828;&#26126;&#19981;&#26159; hot journal, &#36890;&#36807; szJ &#35745;&#31639; nRec
  /* If nRec is 0 and this rollback is of a transaction created by this
  ** process and if this is the final header in the journal, then it means
  ** that this part of the journal was being filled but has not yet been
  ** synced to disk.  Compute the number of pages based on the remaining
  ** size of the file.

  if( nRec==0 &amp;&amp; !isHot &amp;&amp;
    pPager-&gt;journalHdr+JOURNAL_HDR_SZ(pPager)==pPager-&gt;journalOff ):
    nRec = (int)((szJ - pPager-&gt;journalOff) / JOURNAL_PG_SZ(pPager));

  for(u=0; u&lt;nRec; u++):
    // &#23545; journal &#20013;&#27599;&#19968;&#20010; page &#36827;&#34892; playback.
    // &#20294;&#23454;&#38469;&#19978;, &#24182;&#19981;&#26159;&#27599;&#20010; page &#37117;&#20250;&#34987; playback,
    // &#20363;&#22914;, persist &#27169;&#24335;&#30340; journal &#20013;&#23454;&#38469;&#20250;&#21253;&#21547;&#19968;&#20123;&#26087;&#30340;, &#24182;&#38750;
    // &#26412;&#27425; transaction &#20462;&#25913;&#36807;&#30340; page, &#36825;&#20123;&#26159;&#19981;&#33021;&#34987; playback &#30340;
    // pager_playback_one_page &#20250;&#36890;&#36807; journal header &#30340; checksum &#19982;
    // journal &#20013;&#21508;&#20010; page &#30340; checksum &#26469;&#20915;&#23450;&#36825;&#20010; page &#26159;&#21542;&#38656;&#35201; playback
    // &#27599;&#27425;&#36890;&#36807; pager_write -&gt; pager_open_journal &#26102;, journal header
    // &#30340; checksum &#20250;&#34987;&#21021;&#22987;&#21270;&#19968;&#20010;&#38543;&#26426;&#25968;, &#30830;&#23450;&#27599;&#27425; transaction &#26102;&#36825;&#20010;&#20540;
    // &#37117;&#26159;&#19981;&#21516;&#30340;
    pager_playback_one_page(pPager,&amp;pPager-&gt;journalOff,0,1,0);
      read32bits(jfd, (*pOffset)-4, &amp;cksum);
      if pager_cksum(pPager, (u8*)aData)!=cksum:
        // &#36825;&#20010; SQLITE_DONE &#23548;&#33268;&#19978;&#23618;&#20989;&#25968;&#36864;&#20986;&#24490;&#29615;, playback &#32467;&#26463;
        return SQLITE_DONE;
      // &#25214;&#21040; &#23545;&#24212;&#30340; pcache, &#33509;&#19981;&#23384;&#22312;, &#35828;&#26126;&#35813; pgno &#22312; pcache &#20013;&#27809;&#26377;&#23545;
      // &#24212;. 
      pPg = pager_lookup(pPager, pgno);
      // &#33509; eState &#26174;&#31034;&#35813; pager &#24050;&#32463; sync &#36807;, &#21017;&#38656;&#35201;&#20889;&#25968;&#25454;&#24211;&#25991;&#20214;
      if (pPager-&gt;eState&gt;=PAGER_WRITER_DBMOD || pPager-&gt;eState==PAGER_OPEN):
        sqlite3OsWrite(pPager-&gt;fd, (u8*)aData, pPager-&gt;pageSize, ofst);
      if( pPg ):
        // pcache &#20013;&#23384;&#22312;&#36825;&#20010; page, &#21017;&#20462;&#25913; pcache &#30340;&#20540;
        pData = pPg-&gt;pData;
        memcpy(pData, (u8*)aData, pPager-&gt;pageSize);
        sqlite3PcacheMakeClean(pPg);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ade1a0" class="outline-3">
<h3 id="org2ade1a0"><span class="section-number-3">1.6</span> Pager</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org38eb5bb" class="outline-4">
<h4 id="org38eb5bb"><span class="section-number-4">1.6.1</span> pager_playback</h4>
</div>

<div id="outline-container-orgf915905" class="outline-4">
<h4 id="orgf915905"><span class="section-number-4">1.6.2</span> readDbPage</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
readDbPage 负责从数据库中读取某个 page 对应的内容用来填充从 pcache 获取的新的 page. 调用路径是 
</p>

<p>
sqlite3PagerAcquire -&gt; sqlite3PcacheFetch -&gt; pcache1Fetch -&gt;
readDbPage
</p>

<p>
实现上 readDbPage 并不一定从 db 文件中获取数据: 若使用 wal, 则可能从
wal 中获取数据. 
</p>

<div class="org-src-container">
<pre class="src src-text">int readDbPage(PgHdr *pPg):
  if pagerUseWal(pPager):
    /* Try to pull the page from the write-ahead log. */
    sqlite3WalRead(pPager-&gt;pWal, pgno, &amp;isInWal, pgsz, pPg-&gt;pData);
  else:
    sqlite3OsRead(pPager-&gt;fd, pPg-&gt;pData, pgsz, iOffset);
</pre>
</div>
</div>
</div>

<div id="outline-container-org9960874" class="outline-4">
<h4 id="org9960874"><span class="section-number-4">1.6.3</span> syncJournal</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
在 sqlite3PagerCommitPhaseOne 时, 若当前没有使用 wal, 则会调用
syncJournal 将 journal sync 到磁盘.
</p>

<div class="org-src-container">
<pre class="src src-text">if( NOT &lt;in-memory journal&gt; ){
  // &#33509; synchronous == FULL, &#21017;&#22312; update journal header &#20043;&#21069; (&#20027;&#35201;&#26159;
  // nRec &#21644; magic number), &#20808;&#25191;&#34892;&#19968;&#27425; sync &#23558; journal &#20869;&#23481;&#20808;&#20889;&#36827;&#30913;&#30424;
  // &#22240;&#20026;&#36825;&#26102; magic &#37096;&#20998;&#20026;&#31354;, &#25152;&#20197;&#36825;&#26102;&#30340; journal &#36824;&#19981;&#26159; hot journal
  if( &lt;full-sync mode&gt; ) xSync(&lt;journal file&gt;);
  // &#26681;&#25454; pager-&gt;nRec &#26356;&#26032; journal &#30340; nRec, &#24182;&#28155;&#21152; magic
  &lt;update nRec field&gt;
  // &#20877; sync &#19968;&#27425; journal &#25991;&#20214;, &#36825;&#26102;&#21253;&#25324;&#25991;&#20214;&#22836;
  // &#21487;&#35265;, synchronous == FULL &#26102;&#20250;&#27604; synchronous == NORMAL &#26102;&#22810;&#19968;&#27425;
  // sync &#25805;&#20316;
  xSync(&lt;journal file&gt;);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec0394a" class="outline-4">
<h4 id="orgec0394a"><span class="section-number-4">1.6.4</span> pager_write_pagelist</h4>
<div class="outline-text-4" id="text-1-6-4">
<p>
在 sqlite3PagerCommitPhaseOne 时, syncJournal 完成后, 通过
pager_write_pagelist 把 dirty pages 写到数据库
</p>
</div>
</div>

<div id="outline-container-orgc7cc384" class="outline-4">
<h4 id="orgc7cc384"><span class="section-number-4">1.6.5</span> sqlite3PagerSync</h4>
<div class="outline-text-4" id="text-1-6-5">
<p>
把 db sync 到磁盘. 在 sqlite3PagerCommitPhaseOne 时 pager_write_pagelist 后被调用.
</p>
</div>
</div>

<div id="outline-container-org1ac75b8" class="outline-4">
<h4 id="org1ac75b8"><span class="section-number-4">1.6.6</span> pagerStress</h4>
<div class="outline-text-4" id="text-1-6-6">
<p>
pagerStress 是一个回调函数, 在 sqlite3PagerOpen 时, 通过
sqlite3PcacheOpen 把 pagerStress 注册到 pCache-&gt;xStress. 
</p>

<p>
pCache-&gt;xStress 在 sqlite3PagerAcquire-&gt; sqlite3PcacheFetch 会被调用:
首先调用 pcache1Fetch(createFlag==0) 尝试获取从 pcache1 中获得一个
page, 若 pcache1 本身的 LRU list 已经没有空闲了, 并且 pCache dirty
list 中包含一个 dirty 的, 但 nRef 为 0 的 page, 则这个 page 是可以通过写回到数据库而释放的. 所以 pcache 会调用 xStress 来写回这个 page, 然后再次调用 pcache1Fetch (上一步的 xStress 必然会导致有一个 page 被加入到
pcache1 的 LRU list)
</p>

<p>
pagerStress 要做的实际就是在 pcache 满了以后将某个 dirty page 写到 db,
因为要改写 db, 所以 journal 也需要被 sync. 整个过程和 commit 一类似的. 
</p>
</div>
</div>

<div id="outline-container-org377f717" class="outline-4">
<h4 id="org377f717"><span class="section-number-4">1.6.7</span> sqlite3PagerAcquire</h4>
<div class="outline-text-4" id="text-1-6-7">
<p>
sqlite3PagerAcquire 是对 sqlite3PcacheFetch 以及 pcache1Fetch 的封装,
主要负责调用 pcache 获得一个 page, 若这个 page 是新的, 则用 readDbPage
把这个 page 的内容读进来. 并更新 nPage-&gt;nHit, nPage-&gt;nMiss 这些统计信息. 
</p>
</div>
</div>

<div id="outline-container-org73e5a06" class="outline-4">
<h4 id="org73e5a06"><span class="section-number-4">1.6.8</span> sqlite3PagerShrink</h4>
</div>

<div id="outline-container-orga72623f" class="outline-4">
<h4 id="orga72623f"><span class="section-number-4">1.6.9</span> pager_open_journal</h4>
</div>

<div id="outline-container-orgdd82672" class="outline-4">
<h4 id="orgdd82672"><span class="section-number-4">1.6.10</span> sqlite3PagerSharedLock</h4>
<div class="outline-text-4" id="text-1-6-10">
<p>
sqlite3PagerSharedLock 是所有 transaction 开始的第一步: OP_Transaction 会通过 lockBtree 调用 sqlite3PagerSharedLock.
</p>

<p>
获得 shared lock, 对于 rollback journal mode, 会检查 hot journal 以及进行 pager_playback. 对于 wal journal mode, 会获得一个 WAL_READ_LOCK,
通过 walTryBeginRead 获得一个 snapshot, 并检测是否需要 walIndexRecover
</p>

<div class="org-src-container">
<pre class="src src-text">if !pagerUseWal(pPager):
  pager_wait_on_lock(pPager, SHARED_LOCK);
  hasHotJournal(pPager, &amp;bHotJournal);
  if bHotJournal:
    pagerLockDb(pPager, EXCLUSIVE_LOCK);
    pagerSyncHotJournal(pPager);
    pager_playback(pPager, 1);
if pagerUseWal(pPager):
  pagerBeginReadTransaction(pPager);
    sqlite3WalBeginReadTransaction
      walTryBeginRead
        walIndexReadHdr
          walIndexRecover
        walLockShared
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddca0ed" class="outline-4">
<h4 id="orgddca0ed"><span class="section-number-4">1.6.11</span> sqlite3PagerBegin</h4>
<div class="outline-text-4" id="text-1-6-11">
<p>
sqlite3PagerBegin 是获取 RESERVED_LOCK 的入口函数. 其调用路径是:
</p>

<p>
OP_Transaction (WRITE_MODE) -&gt; sqlite3BtreeBeginTrans -&gt; sqlite3PagerBegin
</p>

<p>
sqlite3PagerBegin 主要作用就是获得 RESERVED_LOCK, 表示要开始一个写操作. 
</p>

<p>
insert/delete/update 这个语句都会被 parser 编译为
OP_Transaction(WRITE_MODE) 语句, 这就是 insert/delete/update 语句执行时会获得 RESERVED_LOCK 的原因. 
</p>

<p>
若当前没使用 wal, 则对 db 获得 RESERVED_LOCK, 若使用 wal, 则通过
sqlite3WalBeginWriteTransaction 获到 wal 的 WRITE_LOCK. 所以在 wal 模式下, 也不能同时有两个 writer 的.
</p>
</div>
</div>

<div id="outline-container-orgdeaf259" class="outline-4">
<h4 id="orgdeaf259"><span class="section-number-4">1.6.12</span> sqlite3PagerWrite &amp;&amp; pager_write</h4>
<div class="outline-text-4" id="text-1-6-12">
<p>
当 btree 决定要修改某个 page (pcache) 之前, 例如 sqlite3BtreeInsert,
必须先调用 sqlite3PagerWrite 将这个 page 的原始内容写到日志中. 当然这只有对 rollback journal 才会有这个步骤, 因为 wal journal 并不需要这样做. 
</p>

<p>
pager_write 一次写一个 page 到 rollback journal 中. 但
sqlite3PagerWrite 会根据 sector 的大小考虑更多:
例如, 若 sector 为 4k 而 page 为 1K, 因为磁盘控制器每次总是以 sector
为单位写, 所以 sqlite 必须把连续 4 个 page 写入到一个 sector 中, 否则若只写一个 page, 其他三个 page 的内容可能被写成 0.
</p>

<p>
不过因为 sector 大小通常都为 512, 所以实际上 sqlite3PagerWrite 和
pager_wirte 基本是一样的, 即每次只会写一个 page.
</p>

<p>
另外, 虽然每次 btreeXXX 要对 page 进行修改时都需要调用 pager_write, 但
pager_write 并不需要每次都写 page 到 rollback journal: 若 rollback
journal 中已经包含这个 page 的原始内容 (pageInJournal), 则这个
pager_write 是不需要执行的.
</p>
</div>
</div>

<div id="outline-container-orgf497b16" class="outline-4">
<h4 id="orgf497b16"><span class="section-number-4">1.6.13</span> sqlite3PagerCommitPhaseOne</h4>
<div class="outline-text-4" id="text-1-6-13">
<p>
sqlite3PagerCommitPhaseOne 是 commit 的第一个阶段, 主要任务是 sync 日志和数据库文件
</p>

<div class="org-src-container">
<pre class="src src-text">sqlite3PagerCommitPhaseOne
  /* If no database changes have been made, return early. */
  if (pPager-&gt;eState&lt;PAGER_WRITER_CACHEMOD) return SQLITE_OK;
  if( MEMDB ) return SQLITE_OK;
  if( pagerUseWal(pPager) ):
    // &#33509;&#26159; wal, &#21017;&#21482;&#36890;&#36807; pagerWalFrames &#20462;&#25913; wal &#26085;&#24535;
    pagerWalFrames(pPager, pList, pPager-&gt;dbSize, 1);
  else:
    pager_incr_changecounter(pPager, 1);
    syncJournal(pPager, 0);
    pager_write_pagelist(pPager,sqlite3PcacheDirtyList(pPager-&gt;pPCache));
    // &#27492;&#26102;&#25152;&#26377; pcache &#20013;&#30340; page &#19982; db &#37117;&#26159;&#19968;&#33268;&#30340;&#20102;, &#25226; dirty list &#32622;
    // &#31354;, &#24182;&#19988; nRef &#20026; 0 &#30340; page &#36827;&#20837; lru list
    sqlite3PcacheCleanAll(pPager-&gt;pPCache);
    sqlite3PagerSync(pPager);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdffbe4f" class="outline-4">
<h4 id="orgdffbe4f"><span class="section-number-4">1.6.14</span> sqlite3PagerCommitPhaseTwo</h4>
<div class="outline-text-4" id="text-1-6-14">
<p>
sqlite3PagerCommitPhaseTwo 主要用来清理 rollback journal. 或者对于 wal
来说, drop write_lock
</p>
</div>
</div>

<div id="outline-container-org13eba1a" class="outline-4">
<h4 id="org13eba1a"><span class="section-number-4">1.6.15</span> sqlite3PagerRollback</h4>
<div class="outline-text-4" id="text-1-6-15">
<p>
对 pager_playback 的封装
</p>
</div>
</div>

<div id="outline-container-org951197a" class="outline-4">
<h4 id="org951197a"><span class="section-number-4">1.6.16</span> sqlite3PagerOpen</h4>
</div>

<div id="outline-container-org85bb94d" class="outline-4">
<h4 id="org85bb94d"><span class="section-number-4">1.6.17</span> sqlite3PagerClose</h4>
</div>
</div>

<div id="outline-container-orgc554f20" class="outline-3">
<h3 id="orgc554f20"><span class="section-number-3">1.7</span> Btree</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-orgf74952b" class="outline-4">
<h4 id="orgf74952b"><span class="section-number-4">1.7.1</span> Btree</h4>
</div>

<div id="outline-container-orgd1ea108" class="outline-4">
<h4 id="orgd1ea108"><span class="section-number-4">1.7.2</span> BtShared</h4>
</div>

<div id="outline-container-orgd8daf08" class="outline-4">
<h4 id="orgd8daf08"><span class="section-number-4">1.7.3</span> BtCursor</h4>
</div>
</div>

<div id="outline-container-org013834d" class="outline-3">
<h3 id="org013834d"><span class="section-number-3">1.8</span> VDBE</h3>
<div class="outline-text-3" id="text-1-8">
</div>
<div id="outline-container-org9b3ad6a" class="outline-4">
<h4 id="org9b3ad6a"><span class="section-number-4">1.8.1</span> Mem</h4>
</div>
</div>

<div id="outline-container-org29ba8da" class="outline-3">
<h3 id="org29ba8da"><span class="section-number-3">1.9</span> 内存分配</h3>
<div class="outline-text-3" id="text-1-9">
</div>
<div id="outline-container-orgf15fa8e" class="outline-4">
<h4 id="orgf15fa8e"><span class="section-number-4">1.9.1</span> alloc</h4>
<div class="outline-text-4" id="text-1-9-1">
<p>
sqlite 会使用以下函数来分配内存:
</p>
</div>

<div id="outline-container-org93b7941" class="outline-5">
<h5 id="org93b7941"><span class="section-number-5">1.9.1.1</span> sqlite3Malloc</h5>
<div class="outline-text-5" id="text-1-9-1-1">
<p>
对 malloc 的封装, 并且加上了 size 的支持 (可以通过 sqlite3MallocSize
获得 malloc 分配的大小).
</p>

<p>
另外, sqlite3Malloc 也是后面提到的 scratch, lookaside, pcache 三种分配方式的 fallback.
</p>


<p>
实际上 sqlite3Malloc 可以使用多个版本的 memory system:
</p>

<ol class="org-ol">
<li><p>
SQLITE_SYSTEM_MALLOC
</p>

<p>
默认的 malloc 实现
</p></li>

<li><p>
SQLITE_MEMDEBUG
</p>

<p>
这个版本的 sqlite3MemMalloc 会包含一些 memory debug 信息, 例如
backtrace, FOREGUARD, REARGUARD 等.
</p></li>

<li><p>
SQLITE_ENABLE_MEMSYS3 
</p>

<p>
一个基于 memory pool 的分配器
</p></li>

<li><p>
SQLITE_ENABLE_MEMSYS5 
</p>

<p>
一个与 buddy 系统类似的分配器
</p></li>
</ol>
</div>
</div>


<div id="outline-container-org00919af" class="outline-5">
<h5 id="org00919af"><span class="section-number-5">1.9.1.2</span> sqlite3PageMalloc</h5>
<div class="outline-text-5" id="text-1-9-1-2">
<p>
对 pcache 的封装, 用来给 page 分配内存. 
</p>
</div>
</div>

<div id="outline-container-org449c538" class="outline-5">
<h5 id="org449c538"><span class="section-number-5">1.9.1.3</span> sqlite3DbMalloc</h5>
<div class="outline-text-5" id="text-1-9-1-3">
<p>
当给其他对象分配内存时, 例如给 parser, vdbe 等, 会使用
sqlite3DbMalloc, 它会优先使用 lookside 这种分式来分配内存
</p>

<p>
lookaside 类似于一个简化版的 slab 分配器 (slot 大小是固定的), 默认配置为
  128 bytes * 500, 主要用来分配一些小的内存.
</p>

<div class="org-src-container">
<pre class="src src-text">void *sqlite3DbMallocRaw(sqlite3 *db, int n)
  // &#33509; n &#27604; lookaside &#30340; slot &#22823;, &#21017;&#26080;&#27861;&#29992; lookaside &#20998;&#37197;
  // &#36890;&#36807; anStat[1]++ &#21152;&#19968;&#20123; log &#20449;&#24687;
  if( n&gt;db-&gt;lookaside.sz ):
    db-&gt;lookaside.anStat[1]++;
  else if( (pBuf = db-&gt;lookaside.pFree)==0 ):
    // &#22823;&#23567;&#21512;&#36866;&#20294; slot &#29992;&#23436;&#20102;, lookaside &#20998;&#37197;&#22833;&#36133;
    db-&gt;lookaside.anStat[2]++;
  else:
    // &#21462;&#20986;&#19968;&#20010; slot
    db-&gt;lookaside.pFree = pBuf-&gt;pNext;
    // checkout slot &#25968; +1
    db-&gt;lookaside.nOut++;
    db-&gt;lookaside.anStat[0]++;
    return (void*)pBuf;
  // lookaside &#20998;&#37197;&#22833;&#36133;, &#20351;&#29992; malloc &#20998;&#37197;  
  p = sqlite3Malloc(n);

</pre>
</div>

<p>
lookaside malloc 在 openDatabase 被初始化:
</p>
<div class="org-src-container">
<pre class="src src-text">openDatabase()
  // &#40664;&#35748;&#37197;&#32622;&#19979;, szLookaside &#20026; 128 bytes, nLookaside &#20026; 500
  setupLookaside(db, 0, sqlite3GlobalConfig.szLookaside, sqlite3GlobalConfig.nLookaside);
</pre>
</div>
</div>
</div>

<div id="outline-container-orga47cfb2" class="outline-5">
<h5 id="orga47cfb2"><span class="section-number-5">1.9.1.4</span> sqlite3ScratchMalloc</h5>
<div class="outline-text-5" id="text-1-9-1-4">
<p>
scratch malloc 的作用是 alloca 类似, 对某些对象可以分配在栈上的, 会使用这个函数.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf50ad47" class="outline-4">
<h4 id="orgf50ad47"><span class="section-number-4">1.9.2</span> status</h4>
<div class="outline-text-4" id="text-1-9-2">
</div>
<div id="outline-container-orge47915d" class="outline-5">
<h5 id="orge47915d"><span class="section-number-5">1.9.2.1</span> sqlite3_memory_highwater</h5>
</div>

<div id="outline-container-org1f4fee6" class="outline-5">
<h5 id="org1f4fee6"><span class="section-number-5">1.9.2.2</span> sqlite3_memory_used</h5>
</div>

<div id="outline-container-org8b71829" class="outline-5">
<h5 id="org8b71829"><span class="section-number-5">1.9.2.3</span> sqlite3HeapNearlyFull</h5>
</div>
</div>

<div id="outline-container-org389e39e" class="outline-4">
<h4 id="org389e39e"><span class="section-number-4">1.9.3</span> setting</h4>
<div class="outline-text-4" id="text-1-9-3">
</div>
<div id="outline-container-org8896c03" class="outline-5">
<h5 id="org8896c03"><span class="section-number-5">1.9.3.1</span> sqlite3_soft_heap_limit64</h5>
<div class="outline-text-5" id="text-1-9-3-1">
<p>
若设置了 soft_heap_limit, 则后续通过 sqlite3Malloc 时, 若通过 mem0 发现已分配内存将接近 soft limit, 则通过 sqlite3MallocAlarm 方法触发
softHeapLimitEnforcer 这个 alarm, 后者会调用 sqlite3_release_memory,进行调用 sqlite3PcacheReleaseMemory 释放 pcache 的内存.
</p>
</div>
</div>
</div>

<div id="outline-container-orgfcf4190" class="outline-4">
<h4 id="orgfcf4190"><span class="section-number-4">1.9.4</span> lookaside</h4>
</div>

<div id="outline-container-orgcd85efa" class="outline-4">
<h4 id="orgcd85efa"><span class="section-number-4">1.9.5</span> scratch</h4>
</div>

<div id="outline-container-orgd314a99" class="outline-4">
<h4 id="orgd314a99"><span class="section-number-4">1.9.6</span> pcache</h4>
</div>

<div id="outline-container-orge83fdf2" class="outline-4">
<h4 id="orge83fdf2"><span class="section-number-4">1.9.7</span> Other</h4>
<div class="outline-text-4" id="text-1-9-7">
<p>
通过 adb shell dumpsys meminfo pid 可以 dump 出来 sqlite 内存分配相关的信息
</p>
</div>
</div>
</div>

<div id="outline-container-orga272d57" class="outline-3">
<h3 id="orga272d57"><span class="section-number-3">1.10</span> 文件锁</h3>
<div class="outline-text-3" id="text-1-10">
</div>
<div id="outline-container-org065daf2" class="outline-4">
<h4 id="org065daf2"><span class="section-number-4">1.10.1</span> shared_lock</h4>
<div class="outline-text-4" id="text-1-10-1">
<p>
所有 vdbe 执行时, 都会最先在 OP_Transaction 时通过
sqlite3PagerSharedLock 获取 shared_lock. 此时还会包含检测 hot-journal 的动作
</p>
</div>
</div>

<div id="outline-container-org2f05a15" class="outline-4">
<h4 id="org2f05a15"><span class="section-number-4">1.10.2</span> reserved_lock</h4>
<div class="outline-text-4" id="text-1-10-2">
<p>
OP_Transaction 使用了 wrflag = 1 时, 表示该 vdbe 会写数据库, 这时会通过 sqlite3BtreeBeginTrans -&gt; sqlite3PagerBegin 获得 reserved_lock
</p>
</div>
</div>

<div id="outline-container-org99076dc" class="outline-4">
<h4 id="org99076dc"><span class="section-number-4">1.10.3</span> exclusive_lock</h4>
<div class="outline-text-4" id="text-1-10-3">
<p>
OP_Halt 时, vdbeCommit 会获得 exclusive_lock
</p>
</div>
</div>
</div>

<div id="outline-container-org7647a84" class="outline-3">
<h3 id="org7647a84"><span class="section-number-3">1.11</span> query</h3>
<div class="outline-text-3" id="text-1-11">
<p>
下面使用的测试语句及 byte code 如下:
</p>
<div class="org-src-container">
<pre class="src src-text">sqlite&gt; explain select * from test;
0|Trace|0|0|0||00|
1|Goto|0|9|0||00|
2|OpenRead|0|3|0|1|00|test
3|Rewind|0|7|0||00|
4|Column|0|0|1||00|test.name
5|ResultRow|1|1|0||00|
6|Next|0|4|0||01|
7|Close|0|0|0||00|
8|Halt|0|0|0||00|
9|Transaction|0|0|0||00|
10|VerifyCookie|0|1|0||00|
11|TableLock|0|3|0|test|00|
12|Goto|0|2|0||00|
</pre>
</div>
</div>

<div id="outline-container-org875f97a" class="outline-4">
<h4 id="org875f97a"><span class="section-number-4">1.11.1</span> sqlite3_open_v2</h4>
<div class="outline-text-4" id="text-1-11-1">
</div>
<div id="outline-container-org1bfbadf" class="outline-5">
<h5 id="org1bfbadf"><span class="section-number-5">1.11.1.1</span> sqlite3_initialize</h5>
<div class="outline-text-5" id="text-1-11-1-1">
<div class="org-src-container">
<pre class="src src-text">sqlite3_initialize
  // &#21021;&#22987;&#21270; mutex &#31995;&#32479;
  sqlite3MutexInit
    if(!sqlite3GlobalConfig.mutex.xMutexAlloc):
      // &#29992;&#25143;&#21487;&#20197;&#36890;&#36807; sqlite3_config(SQLITE_CONFIG_MUTEX, xxx) &#25351;&#23450;&#19968;&#20010;&#33258;
      // &#23450;&#20041;&#30340; mutex &#23454;&#29616; ... &#33509;&#27809;&#26377;&#25351;&#23450;, &#21017;&#26681;&#25454;&#24179;&#21488;&#30340;&#19981;&#21516;&#36873;&#25321;&#19968;&#20010;&#40664;&#35748;
      // &#30340; mutex &#23454;&#29616;
      if(sqlite3GlobalConfig.bCoreMutex):
        // &#33509; sqlite &#30340;&#32534;&#35793;&#26102;&#36873;&#39033;&#25351;&#23450;&#20102; sqlite &#20026; SINGLETHREAD,
        // &#25110;&#32773;&#36890;&#36807; sqlite3_config &#25351;&#23450;&#20102; SQLITE_CONFIG_SINGLETHREAD &#21017; bCoreMutex
        // &#20250;&#20026;&#31354;, &#36825;&#26102;&#25972;&#20010; mutex &#31995;&#32479;&#20250;&#19981;&#36215;&#20316;&#29992;: &#19981;&#35770;&#26159; core mutex &#36824;&#26159;
        // &#21644; db-&gt;mutex &#30456;&#20851;&#30340; full mutex
        pFrom = sqlite3DefaultMutex();
        // sqlite3DefaultMutex &#22312;&#32534;&#35793;&#26102;&#20250;&#26681;&#25454;&#24179;&#21488;&#36873;&#25321;&#21512;&#36866;&#30340;&#29256;&#26412;
      else:
        pFrom = sqlite3NoopMutex();
        // sqlite3NoopMutex &#20013;&#25152;&#26377;&#20989;&#25968;&#37117;&#20026;&#31354;&#25805;&#20316;.
      memcpy(&amp;sqlite3GlobalConfig.mutex, pFrom, offsetof(sqlite3_mutex_methods, xMutexAlloc));

  // &#21021;&#22987;&#21270; malloc &#31995;&#32479; 
  sqlite3MallocInit();
    // &#29992;&#25143;&#21487;&#20197;&#36890;&#36807; sqlite_config(SQLITE_CONFIG_MALLOC,xxx)
    // &#25351;&#23450;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340; malloc &#23454;&#29616;
    if(sqlite3GlobalConfig.m.xMalloc==0):
        // &#24179;&#21488;&#30456;&#20851;&#30340;&#40664;&#35748;&#23454;&#29616;
        sqlite3MemSetDefault();

  // &#21021;&#22987;&#21270;&#21508;&#31181;&#33258;&#23450;&#20041;&#20989;&#25968;, &#22914; sum, like ..., &#25226;&#36825;&#20123;&#20989;&#25968;&#36890;&#36807;
  // sqlite3FuncDefInsert &#21152;&#20837;&#21040;&#19968;&#20010;&#20840;&#23616;&#30340; hash map &#20013;, &#36825;&#20123;&#20989;&#25968;&#21253;&#25324;:
  // trim, min, max, typeof, length, substr, round, upper, lower,
  // hex, random, nullif, sqlite_version, sqlite_log, last_insert_rowid,
  // sum, total, avg, like, &#31561;
  sqlite3RegisterGlobalFunctions();

  // &#21021;&#22987;&#21270; pcache
  sqlite3PcacheInitialize();
  // &#29992;&#25143;&#21487;&#20197;&#36890;&#36807; sqlite_config &#25351;&#23450;&#19968;&#20010;&#33258;&#23450;&#20041; pcache &#23454;&#29616;
  if(sqlite3GlobalConfig.pcache2.xInit==0):
    // &#35774;&#32622; pcache &#30456;&#20851;&#30340;&#20989;&#25968;&#20026;&#40664;&#35748;&#30340;&#20989;&#25968;, &#22914; pcache1Init,
    // pcache1Truncate, xxx
    sqlite3PCacheSetDefault();

  // &#21021;&#22987;&#21270;&#24179;&#21488;&#30456;&#20851;&#30340;&#20989;&#25968;, &#20027;&#35201;&#26159;&#21644;&#25991;&#20214;&#31995;&#32479;&#30456;&#20851;, &#20363;&#22914; xOpen, xDelete
  // &#31561;, &#20063;&#26377;&#23569;&#37327;&#21644; vfs &#26080;&#20851;&#30340;&#20989;&#25968;, &#20363;&#22914; xSleep, xCurrentTime &#31561;
  // &#27880;&#24847;, io &#30456;&#20851;&#30340;&#26041;&#27861;&#22914; xRead, xWrite &#31561;&#19981;&#23646;&#20110; vfs &#30456;&#20851;, &#20063;&#19981;
  // &#30001; sqlite3OsInit &#26377;&#21021;&#22987;&#21270;: xOpen &#20250;&#36127;&#36131;&#25226;&#30456;&#24212;&#30340; sqlite3_io_methods
  // &#35774;&#32622;&#21040; sqlite3_file-&gt;pMethods &#19978;
  sqlite3OsInit();
</pre>
</div>

<p>
总结:
</p>

<p>
sqlite3_initialize 会初始化 malloc, mutex, pcache, 这三个子系统都是可以通过 sqlite3_config 设置为一个用户自定义实现的. 另外还要初始化平台相关的 vfs 实现. 因为初始化时需要修改一些全局的变量, 所以需要 mutex 子系统必须先初始化成功. 若当前模式为 SINGLETHREAD, 则会因为 bCoreMutex 为假导致 mutex 系统没有初始化, 进行导致上层应用无法正常在两个线程中同时打开数据库.
</p>
</div>
</div>

<div id="outline-container-org687a7d0" class="outline-5">
<h5 id="org687a7d0"><span class="section-number-5">1.11.1.2</span> 初始化 db</h5>
<div class="outline-text-5" id="text-1-11-1-2">
<div class="org-src-container">
<pre class="src src-text">openDatabase
  sqlite3_initialize
  // &#26681;&#25454; mutex &#30340;&#37197;&#32622;&#20915;&#23450;&#26159;&#21542;&#21551;&#29992; db &#30456;&#20851;&#30340; db-&gt;mutex
  // &#26368;&#32456;&#30340;&#32467;&#26524;&#26159;: &#33509; sqlite3_config &#25351;&#23450;&#20102; SERIALIZED
  // &#25110;&#32773; sqlite3_open_v2 &#26102;&#25351;&#23450;&#20102; FULLMUTEX &#36873;&#39033;, &#21017;
  // db-&gt;mutex &#20250;&#34987;&#21551;&#29992;.
  // &#26681;&#25454; sqlite3_config, sqlite3_open_v2 &#25110;&#32534;&#35793;&#36873;&#39033;&#19981;&#21516;
  // bCoreMutex &#21644; bFullMutex &#20250;&#34987;&#19981;&#21516;&#30340;&#32622;&#20301;.
  // sqlite &#20869;&#37096;&#26377;&#20004;&#31181; mutex, &#19968;&#31181;&#26159;&#36890;&#36807;
  // sqlite3MutexAlloc(SQLITE_MUTEX_STATIC_MASTER) &#36825;&#31181;&#24418;&#24335;
  // &#24314;&#31435;&#30340;&#38745;&#24577;&#30340;&#38145;, &#19968;&#20849;&#26377;&#20116;&#20010;, &#23545;&#24212;&#20110; sqlite &#20013;&#20960;&#20010;&#19981;&#21516;&#30340;
  // critical area &#30340;&#21152;&#38145;.  &#21478;&#19968;&#31181;&#26159;&#36890;&#36807; db-&gt;mutex &#20445;&#23384;&#30340;&#21644;
  // &#21333;&#20010; db &#26377;&#20851;&#30340;&#38145;.
  // &#33509; bCoreMutex &#26080;&#25928;, &#21017;&#25152;&#26377; mutex &#37117;&#26080;&#25928;, &#19981;&#33021;&#26377;&#22810;&#20010;&#32447;&#31243;&#21516;&#26102;&#25191;&#34892;
  // sqlite &#30456;&#20851;&#30340;&#20195;&#30721;, &#23545;&#24212;&#20110; SINGLETHREAD &#30340;&#24773; &#20917;.
  // &#33509; bCoreMutex &#26377;&#25928;, bFullMutex &#26080;&#25928;, &#21017;&#37027;&#20960;&#20010;&#38745;&#24577;&#30340;&#38145;&#26377;&#25928;,
  // &#34920;&#31034;&#21487;&#20197;&#26377;&#22810;&#20010;&#32447;&#31243;&#21516;&#26102;&#25805;&#20316;&#19981;&#21516;&#30340; db connection, &#23545;&#24212;&#20110;
  // MULTITHREAD .&#33509; bCoreMutex &#26377;&#25928;, bFullMutex &#26377;&#25928;, &#21017;
  // db-&gt;mutex &#20063;&#26159;&#26377;&#38145;&#20445;&#25252;&#30340;, &#21516;&#19968;&#20010; db connection &#21487;&#20197;&#22312;&#19981;&#21516;&#30340;
  // thread &#20013;&#21516;&#26102;&#20351;&#29992;, &#23545;&#24212;&#20110; SERIALIZED.

  if(sqlite3GlobalConfig.bCoreMutex==0):
    isThreadsafe = 0;
  else if(flags &amp; SQLITE_OPEN_NOMUTEX):
    isThreadsafe = 0;
  else if(flags &amp; SQLITE_OPEN_FULLMUTEX):
    isThreadsafe = 1;
  else:
    isThreadsafe = sqlite3GlobalConfig.bFullMutex;
  if(isThreadsafe):
    db-&gt;mutex = sqlite3MutexAlloc(SQLITE_MUTEX_RECURSIVE);

  // &#35774;&#32622;&#40664;&#35748;&#30340; collation
  createCollation(db, "BINARY", SQLITE_UTF8, 0, binCollFunc, 0);
  createCollation(db, "RTRIM", SQLITE_UTF8, (void*)1, binCollFunc, 0);
  createCollation(db, "NOCASE", SQLITE_UTF8, 0, nocaseCollatingFunc, 0);

  // &#40664;&#35748; collation &#20026; BINARY
  db-&gt;pDfltColl = sqlite3FindCollSeq(db, SQLITE_UTF8, "BINARY", 0);

  // &#21021;&#22987;&#21270; btree &#27169;&#22359;, &#25171;&#24320;&#25968;&#25454;&#24211;&#25991;&#20214;
  sqlite3BtreeOpen(db-&gt;pVfs, zOpen, db, &amp;db-&gt;aDb[0].pBt, 0, flags |SQLITE_OPEN_MAIN_DB);
    // &#30495;&#27491;&#25171;&#24320;&#25991;&#20214;
    sqlite3PagerOpen(pVfs, &amp;pBt-&gt;pPager, zFilename, ..)
    // &#35835;&#21462;&#25991;&#20214;&#22836;, &#33719;&#24471; page size &#31561;, &#27880;&#24847; SHORT_READ &#19981;&#31639;&#38169;&#35823;.
    sqlite3PagerReadFileheader(pBt-&gt;pPager,sizeof(zDbHeader),zDbHeader);
    // &#35774;&#32622;&#40664;&#35748;&#30340; busy handler
    sqlite3PagerSetBusyhandler(pBt-&gt;pPager, btreeInvokeBusyHandler, pBt);
    // &#33509;&#19978;&#19968;&#27493;&#25104;&#21151;&#35835;&#21040;&#20102;&#25991;&#20214;&#22836;, &#21017;&#26681;&#25454;&#25991;&#20214;&#22836;&#35774;&#32622; page size
    sqlite3PagerSetPagesize(pBt-&gt;pPager, &amp;pBt-&gt;pageSize, nReserve);

  // sqlite &#25903;&#25345;&#36890;&#36807; attach &#30340;&#26041;&#27861;&#22312;&#19968;&#20010; db connection &#20013;&#25171;&#24320;&#22810;&#20010; db.
  // &#36825;&#20123; db &#37117;&#25918;&#22312; aDb &#25968;&#25454;&#20013;. &#40664;&#35748;&#21021;&#22987;&#26102;&#26377;&#20004;&#20010; db, &#19968;&#20010; main, &#20195;&#34920;
  // sqlite &#21551;&#21160;&#26102;&#25214;&#24320;&#30340; db, &#36824;&#26377;&#19968;&#20010; temp &#34920;&#31034;&#20020;&#26102; db, &#20363;&#22914;&#36890;&#36807;
  // create temp table &#24314;&#31435;&#30340;&#34920;&#37117;&#25918;&#22312; temp db &#20013;.
  // &#20363;&#22914;:
  // select * from main.test == select * from test;
  // create temp table test2 (name TEXT);
  // select * from temp.test2;
  db-&gt;aDb[0].zName = "main";
  db-&gt;aDb[0].safety_level = 3;
  db-&gt;aDb[1].zName = "temp";
  db-&gt;aDb[1].safety_level = 1;

  // &#33258;&#21160;&#21152;&#36733;&#19968;&#20010; extension, &#21442;&#32771; http://www.sqlite.org/loadext.html
  sqlite3AutoLoadExtensions(db);

  // &#21021;&#22987;&#21270;&#19968;&#20123;&#25193;&#23637;&#27169;&#22359;: fts, icu, r-tree
  sqlite3Fts1Init(db);
  sqlite3IcuInit(db);
  sqlite3RtreeInit(db);
</pre>
</div>
</div>
</div>

<div id="outline-container-org6570e9b" class="outline-5">
<h5 id="org6570e9b"><span class="section-number-5">1.11.1.3</span> 总结</h5>
<div class="outline-text-5" id="text-1-11-1-3">
<p>
sqlite3_open_v2 的过程:
</p>
<ol class="org-ol">
<li>会初始化 malloc, mutex, pcache 等相关的回调函数, 根据平台的不同注册一些 vfs 相关的回调函数</li>
<li>初始化 mutex, 注册一些 min,max, sum 等内部函数, 注册 collation 函数.</li>
<li>然后打开 btree 和 pager 模块, 使用 pager 从文件头中读取 page size 设置到 pager.</li>
<li>加载其他 extension, 初始化 fts, icu, r-tree 模块.</li>
</ol>

<p>
在 pager 初始化时, 会真正打开数据库文件并读取文件头, 其他的内容例如
schema 在 sqlite3_open_v2 过程中暂时不会读取: 后面第一次访问数据库时会读取 schema (即 sqlite_master 表)
</p>
</div>
</div>
</div>

<div id="outline-container-org7c3916f" class="outline-4">
<h4 id="org7c3916f"><span class="section-number-4">1.11.2</span> sqlite3_prepare</h4>
<div class="outline-text-4" id="text-1-11-2">
<div class="org-src-container">
<pre class="src src-text">sqlite3LockAndPrepare
  // prepare &#26102;&#38656;&#35201; lock &#20303; db-&gt;mutex, &#21363; bFullMutex &#27169;&#24335;
  // &#22240;&#20026;&#21482;&#26377; SERIALIZED &#27169;&#24335;&#19979; db-&gt;mutex &#25165;&#36215;&#20316;&#29992;, 
  // &#25152;&#20197;&#38750; SERIALIZED &#27169;&#24335;&#19979;&#19981;&#33021;&#22312;&#19981;&#21516;&#32447;&#31243;&#21516;&#26102;&#35843;&#29992; sqlite3_prepare,
  // &#21542;&#21017;&#20250;&#20986;&#38169;
  sqlite3_mutex_enter(db-&gt;mutex);
  sqlite3Prepare(db, zSql, nBytes, saveSqlFlag, pOld, ppStmt, pzTail);
    sqlite3RunParser(pParse, zSqlCopy, &amp;zErrMsg);
      // the main parser program
      sqlite3Parser();
        do{
          yy_reduce(yypParser,yyact-YYNSTATE);
            switch( yyruleno ):
              case 112: /* cmd ::= select */
                sqlite3Select(pParse, yymsp[0].minor.yy159, &amp;dest);
                  sqlite3SelectPrep(pParse, p, 0);
                    sqlite3SelectExpand(pParse, p);
                      sqlite3WalkSelect(&amp;w, pSelect);
                        sqlite3LocateTable()
                          // &#22312; parse &#38454;&#27573;&#38656;&#35201; read schema
                          sqlite3ReadSchema();
              case xxx:
                // xxx

    *ppStmt = (sqlite3_stmt*)pParse-&gt;pVdbe;    
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fdc2dc" class="outline-4">
<h4 id="org6fdc2dc"><span class="section-number-4">1.11.3</span> sqlite3_step</h4>
<div class="outline-text-4" id="text-1-11-3">
<div class="org-src-container">
<pre class="src src-text">sqlite3_step(stmt)
  sqlite3_mutex_enter(db-&gt;mutex);
  sqlite3Step(stmt)
    sqlite3VdbeExec(vdbe);
    // sqlite3VdbeExec &#30456;&#24403;&#20110;&#19968;&#20010;&#35299;&#37322;&#22120;, &#20869;&#37096;&#23454;&#29616;&#23601;&#26159;&#19968;&#20010; while (true)
    // {swich} &#24490;&#29615;
      for(pc=p-&gt;pc; rc==SQLITE_OK; pc++){
        OP_GOTO:

        OP_Transaction:
          sqlite3BtreeBeginTrans(u.at.pBt, pOp-&gt;p2);
            lockBtree
              sqlite3PagerSharedLock
                pager_wait_on_lock(pPager, SHARED_LOCK);
                // &#26816;&#27979;&#26159;&#21542;&#26377; hot journal
                if hasHotJournal():
                  pagerLockDb(pPager, EXCLUSIVE_LOCK);
                  pagerSyncHotJournal(pPager);
              // if write mode
              sqlite3PagerBegin(pBt-&gt;pPager,wrflag&gt;1,sqlite3TempInMemory(p-&gt;db));
                // &#33719;&#24471; reserved_lock
                pagerLockDb(pPager, RESERVED_LOCK);

        OP_OpenRead:
          allocateCursor(p, pOp-&gt;p1, u.aw.nField, u.aw.iDb, 1);
          sqlite3BtreeCursor(u.aw.pX, ...);
        OP_Rewind:
          sqlite3BtreeFirst(u.bl.pCrsr, &amp;u.bl.res);
          moveToRoot(pCur);
            getAndInitPage;
              btreeGetPage;
                sqlite3PagerAcquire;
                  sqlite3PcacheFetch
                  readDbPage;
                    sqlite3OsRead
        OP_Column:
          // &#20174; cursor &#20013;&#21462;&#20986;&#25968;&#25454;&#25918;&#22312; vdbe-&gt;aMem &#20013;
        OP_ResultRow:
           // &#36825;&#19968;&#21477; byte code &#27491;&#24120;&#20250;&#36820;&#22238; SQLITE_ROW, &#32780;&#19981;&#26159; SQLITE_OK,
           // &#23548;&#33268;&#26368;&#22806;&#23618; for &#36820;&#22238;, &#25972;&#20010; sqlite3_step &#32467;&#26463;
           // &#19979;&#27425; step &#23558;&#20197; p-&gt;pc &#20026;&#36215;&#28857;, &#21363; OP_Next
           p-&gt;pc = pc + 1;
           rc = SQLITE_ROW;
           goto vdbe_return;
        OP_Next:
          sqlite3BtreeNext(u.bm.pCrsr, &amp;u.bm.res);
            moveToChild;
              getAndInitPage;
        OP_Halt:
          sqlite3VdbeHalt(p);
          if autoCommit == 1:
            vdbeCommit(db, p);
              // &#33719;&#24471; exclusive lock
              sqlite3PagerExclusiveLock(sqlite3BtreePager(pBt));
              sqlite3BtreeCommitPhaseOne
              sqlite3BtreeCommitPhaseTwo
                btreeEndTransaction
                  releasePage
                    // &#37322;&#25918;&#38145;
                    pagerUnlockAndRollback;

</pre>
</div>
</div>

<div id="outline-container-org9c5a31e" class="outline-5">
<h5 id="org9c5a31e"><span class="section-number-5">1.11.3.1</span> 总结</h5>
<div class="outline-text-5" id="text-1-11-3-1">
<ol class="org-ol">
<li>OP_Transaction 时 sqlite3BtreeBeginTrans 会获得 shared lock</li>
<li>OP_Halt 时 btreeEndTransaction 需要释放锁</li>
<li>sqlite3PagerAcquire 会调用 pcache 和 pager 来获得 page 的数据. 发生的时机是 btree 移动时(例如 OP_Rewind, OP_Next)</li>
<li>OP_Transaction 会检测 hot journal 并 sync journal</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org6438428" class="outline-4">
<h4 id="org6438428"><span class="section-number-4">1.11.4</span> journal 操作</h4>
<div class="outline-text-4" id="text-1-11-4">
</div>
<div id="outline-container-orgb51a8c1" class="outline-5">
<h5 id="orgb51a8c1"><span class="section-number-5">1.11.4.1</span> pager_write</h5>
<div class="outline-text-5" id="text-1-11-4-1">
<p>
pager_wirte 会导致 journal file 被写入
</p>
</div>
</div>

<div id="outline-container-org4106147" class="outline-5">
<h5 id="org4106147"><span class="section-number-5">1.11.4.2</span> syncJournal</h5>
<div class="outline-text-5" id="text-1-11-4-2">
<p>
在 sqlite3PagerCommitPhaseOne 时, syncJournal 被调用确保 journal 被
sync 到磁盘
</p>
</div>
</div>

<div id="outline-container-org6fd8e42" class="outline-5">
<h5 id="org6fd8e42"><span class="section-number-5">1.11.4.3</span> hasHotJournal</h5>
<div class="outline-text-5" id="text-1-11-4-3">
<p>
在 OP_Transaction (sqlite3PagerSharedLock) 时, 检测 hot journal 是否存在
</p>
</div>
</div>

<div id="outline-container-org483eda8" class="outline-5">
<h5 id="org483eda8"><span class="section-number-5">1.11.4.4</span> pagerSyncHotJournal</h5>
<div class="outline-text-5" id="text-1-11-4-4">
<p>
在 hot journal 存在, 则调用该方法 sync hot journal
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org7e45fbc" class="outline-3">
<h3 id="org7e45fbc"><span class="section-number-3">1.12</span> insert</h3>
<div class="outline-text-3" id="text-1-12">
<div class="org-src-container">
<pre class="src src-text">sqlite&gt; explain insert into test values ("a");
0|Trace|0|0|0||00|
1|Goto|0|9|0||00|
2|OpenWrite|0|3|0|1|00|test
3|NewRowid|0|2|0||00|
4|String8|0|3|0|a|00|
5|MakeRecord|3|1|4|a|00|
6|Insert|0|4|2|test|1b|
7|Close|0|0|0||00|
8|Halt|0|0|0||00|
9|Transaction|0|1|0||00|
10|VerifyCookie|0|1|0||00|
11|TableLock|0|3|1|test|00|
12|Goto|0|2|0||00|
</pre>
</div>
</div>

<div id="outline-container-org9825d5d" class="outline-4">
<h4 id="org9825d5d"><span class="section-number-4">1.12.1</span> sqlite3_step</h4>
<div class="outline-text-4" id="text-1-12-1">
<div class="org-src-container">
<pre class="src src-text">OP_NewRowid:
  // NewRowid &#38656;&#35201;&#20026;&#35813;&#26032;&#35760;&#24405;&#29983;&#25104;&#19968;&#20010;&#21807;&#19968;&#30340; rowid,
  // &#26681;&#25454; schema &#30340;&#19981;&#21516;&#20998;&#20026;&#20004;&#31181;&#24773;&#20917;:
  // 1. &#20551;&#35774;&#35760;&#24405;&#20013;&#20351;&#29992;&#20102; integer primary key autoincrement &#31867;&#22411;&#30340;&#23383;&#27573; _id, &#36825;
  // &#26102; rowid &#20869;&#37096;&#23454;&#29616;&#19978;&#30452;&#25509;&#20351;&#29992;&#36825;&#20010; _id &#23383;&#27573;, _id &#19981;&#20165;&#38656;&#35201;&#21807;&#19968;: &#36824;&#38656;
  // &#35201;&#33258;&#22686;. sqlite &#36890;&#36807; sqlite_sequence &#36825;&#24352;&#34920;&#26469;&#25511;&#21046;&#36825;&#31181;&#24773;&#20917;&#19979; _id &#30340;&#29983;&#25104;
  // 2. schema &#20013;&#24182;&#27809;&#25351;&#23450; autoincrement &#36825;&#31181;&#31867;&#22411;&#30340;&#23383;&#27573;. &#36825;&#26102; NewRowid
  // &#38656;&#35201;&#29983;&#25104;&#19968;&#20010;&#21807;&#19968;&#30340; rowid, sqlite &#23450;&#20041;&#20102;&#20004;&#31181;&#31639;&#27861;:
  // 1) &#25195;&#25551;&#20840;&#34920;, &#25214;&#21040;&#24050;&#32463;&#20351;&#29992;&#30340;&#26368;&#22823; rowid +1, &#24471;&#21040;&#26032;&#30340; rowid
  // 2) &#38543;&#26426;&#29983;&#25104;&#19968;&#20010; rowid, &#36890;&#36807;&#26597;&#34920;&#30830;&#23450;&#26159;&#21542;&#20914;&#31361;, &#33509;&#20914;&#31361;&#20877;&#37325;&#26032;&#29983;&#25104;&#19968;&#20010;
  // &#19981;&#35770;&#21738;&#31181;&#31639;&#27861;, &#25195;&#25551;&#20840;&#34920;&#37117;&#26159;&#24517;&#39035;&#30340;. 

OP_Insert:
  sqlite3BtreeInsert(u.bh.pC-&gt;pCursor, 0, u.bh.iKey,...)
    // &#25214;&#21040;&#23545;&#24212;&#30340; page
    btreeMoveto(pCur, pKey, nKey, appendBias, &amp;loc);
    // &#20889;&#21040; cell &#20013;
    fillInCell(pPage, newCell, pKey, nKey, pData, nData, nZero,&amp;szNew);
    // sqlite3PagerWrite &#20250;&#23548;&#33268; journal &#34987;&#20889;&#20837;
    sqlite3PagerWrite(pPage-&gt;pDbPage);

</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
