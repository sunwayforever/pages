<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 二 15:53 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sqlite Overview</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Sqlite Overview</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga775ec9">1. SQLite：Overview</a>
<ul>
<li><a href="#org2c9cdd4">1.1. sqlite3_analyzer</a></li>
<li><a href="#org1efee07">1.2. sqlite command</a>
<ul>
<li><a href="#org106b35e">1.2.1. .output</a></li>
<li><a href="#org87c3c19">1.2.2. .mode</a></li>
<li><a href="#org7797608">1.2.3. .dump</a></li>
<li><a href="#orge3ccf74">1.2.4. .read</a></li>
<li><a href="#org664889f">1.2.5. .tables</a></li>
<li><a href="#orgf9e6aa3">1.2.6. .separator</a></li>
<li><a href="#org06e4d4c">1.2.7. .schema</a></li>
<li><a href="#org37ad34b">1.2.8. .headers [on|off]</a></li>
<li><a href="#org35079fc">1.2.9. explain query plan</a></li>
<li><a href="#org56f2d22">1.2.10. explain</a></li>
<li><a href="#org2f9c691">1.2.11. vacuum</a></li>
</ul>
</li>
<li><a href="#org969e129">1.3. sqlite SQL</a>
<ul>
<li><a href="#org8bfff29">1.3.1. attach database</a></li>
<li><a href="#orgc181544">1.3.2. create table</a></li>
<li><a href="#org6f438b4">1.3.3. trigger</a></li>
<li><a href="#org3fe616c">1.3.4. transaction</a></li>
<li><a href="#org7330356">1.3.5. confict resolution</a></li>
<li><a href="#org8a67be4">1.3.6. join</a></li>
<li><a href="#orgcf917d6">1.3.7. index</a></li>
<li><a href="#orge4c671f">1.3.8. view</a></li>
<li><a href="#org4229535">1.3.9. insert</a></li>
<li><a href="#org11ceeae">1.3.10. update</a></li>
<li><a href="#orga158f9b">1.3.11. select</a></li>
<li><a href="#orgb3bbfa7">1.3.12. functions</a></li>
<li><a href="#org3591171">1.3.13. fts</a></li>
<li><a href="#org8ba996b">1.3.14. Summary</a></li>
</ul>
</li>
<li><a href="#orgfd1292e">1.4. sqlite limitation</a></li>
<li><a href="#org13bd06e">1.5. sqlite pragma</a>
<ul>
<li><a href="#org4901d12">1.5.1. auto_vacuum = 0/1</a></li>
<li><a href="#org72f8c7f">1.5.2. cache_size</a></li>
<li><a href="#org5759a5c">1.5.3. default_cache_size</a></li>
<li><a href="#orgcb2aae0">1.5.4. case_sensitive_like = 0/1</a></li>
<li><a href="#org13ad847">1.5.5. count_changes = 0/1</a></li>
<li><a href="#org6b4438d">1.5.6. encoding = "UTF-8"</a></li>
<li><a href="#org2e7a4cc">1.5.7. page_size = bytes</a></li>
<li><a href="#org795b455">1.5.8. max_page_count</a></li>
<li><a href="#org1a9434e">1.5.9. synchronous = FULL/NORMAL/OFF</a></li>
<li><a href="#org557f4ba">1.5.10. vdbe_trace=on/off</a></li>
<li><a href="#org74f39e2">1.5.11. vdbe_listing=on/off</a></li>
<li><a href="#org94e5cb5">1.5.12. parser_trace=on/off</a></li>
<li><a href="#orga93246c">1.5.13. temp_store</a></li>
<li><a href="#org14eef8c">1.5.14. locking_mode=normal/exclusive</a></li>
</ul>
</li>
<li><a href="#orge200df7">1.6. optimization</a>
<ul>
<li><a href="#org0cc6a00">1.6.1. 使用索引</a></li>
<li><a href="#org7fe86b1">1.6.2. 避免 transient table (subquery)</a></li>
<li><a href="#orgb528e7b">1.6.3. automatic index</a></li>
<li><a href="#org5cc5978">1.6.4. view 与 subquery 类似, 无法使用索引</a></li>
<li><a href="#org5c167a8">1.6.5. join 的顺序</a></li>
<li><a href="#org024eb53">1.6.6. 使用 limit</a></li>
</ul>
</li>
<li><a href="#orgf1c2404">1.7. references</a></li>
<li><a href="#org546d8e4">1.8. Other</a>
<ul>
<li><a href="#org14efcb6">1.8.1. WAL</a></li>
<li><a href="#orgffdf290">1.8.2. FTS</a></li>
<li><a href="#org857e5a5">1.8.3. ICU</a></li>
<li><a href="#org77a3d1a">1.8.4. R-Tree</a></li>
<li><a href="#org90334fe">1.8.5. SQLite Optimization FAQ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga775ec9" class="outline-2">
<h2 id="orga775ec9"><span class="section-number-2">1</span> SQLite：Overview</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org2c9cdd4" class="outline-3">
<h3 id="org2c9cdd4"><span class="section-number-3">1.1</span> sqlite3_analyzer</h3>
</div>

<div id="outline-container-org1efee07" class="outline-3">
<h3 id="org1efee07"><span class="section-number-3">1.2</span> sqlite command</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org106b35e" class="outline-4">
<h4 id="org106b35e"><span class="section-number-4">1.2.1</span> .output</h4>
</div>

<div id="outline-container-org87c3c19" class="outline-4">
<h4 id="org87c3c19"><span class="section-number-4">1.2.2</span> .mode</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
list|column|insert|line|tabs|tcl|csv
</p>
</div>
</div>

<div id="outline-container-org7797608" class="outline-4">
<h4 id="org7797608"><span class="section-number-4">1.2.3</span> .dump</h4>
</div>

<div id="outline-container-orge3ccf74" class="outline-4">
<h4 id="orge3ccf74"><span class="section-number-4">1.2.4</span> .read</h4>
</div>

<div id="outline-container-org664889f" class="outline-4">
<h4 id="org664889f"><span class="section-number-4">1.2.5</span> .tables</h4>
</div>

<div id="outline-container-orgf9e6aa3" class="outline-4">
<h4 id="orgf9e6aa3"><span class="section-number-4">1.2.6</span> .separator</h4>
</div>

<div id="outline-container-org06e4d4c" class="outline-4">
<h4 id="org06e4d4c"><span class="section-number-4">1.2.7</span> .schema</h4>
</div>

<div id="outline-container-org37ad34b" class="outline-4">
<h4 id="org37ad34b"><span class="section-number-4">1.2.8</span> .headers [on|off]</h4>
</div>

<div id="outline-container-org35079fc" class="outline-4">
<h4 id="org35079fc"><span class="section-number-4">1.2.9</span> explain query plan</h4>
<div class="outline-text-4" id="text-1-2-9">
<p>
see also <a href="http://www.sqlite.org/queryplanner.html">queryplanner</a>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #859900;">query</span> <span style="color: #859900;">plan</span> <span style="color: #859900;">select</span> * <span style="color: #859900;">from</span> foo;
</pre>
</div>
</div>
</div>

<div id="outline-container-org56f2d22" class="outline-4">
<h4 id="org56f2d22"><span class="section-number-4">1.2.10</span> explain</h4>
<div class="outline-text-4" id="text-1-2-10">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #859900;">select</span> * <span style="color: #859900;">from</span> foo;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f9c691" class="outline-4">
<h4 id="org2f9c691"><span class="section-number-4">1.2.11</span> vacuum</h4>
</div>
</div>

<div id="outline-container-org969e129" class="outline-3">
<h3 id="org969e129"><span class="section-number-3">1.3</span> sqlite SQL</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org8bfff29" class="outline-4">
<h4 id="org8bfff29"><span class="section-number-4">1.3.1</span> attach database</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
attach database "foo.db" as db2;
select * from db2.tbl_1;
detach database db2;
</p>
</div>
</div>

<div id="outline-container-orgc181544" class="outline-4">
<h4 id="orgc181544"><span class="section-number-4">1.3.2</span> create table</h4>
<div class="outline-text-4" id="text-1-3-2">
</div>
<div id="outline-container-orgead90ac" class="outline-5">
<h5 id="orgead90ac"><span class="section-number-5">1.3.2.1</span> storage class</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<p>
使用 select typeof (xx) 来查看 storage class
</p>

<ul class="org-ul">
<li>integer</li>
</ul>
<p>
61
</p>
<ul class="org-ul">
<li>real</li>
</ul>
<p>
61.0
</p>
<ul class="org-ul">
<li>text</li>
</ul>
<p>
"a"
</p>
<ul class="org-ul">
<li>blob</li>
</ul>
<p>
x'61'
</p>
</div>
</div>

<div id="outline-container-org7ca3959" class="outline-5">
<h5 id="org7ca3959"><span class="section-number-5">1.3.2.2</span> constrains</h5>
<div class="outline-text-5" id="text-1-3-2-2">
</div>
<ol class="org-ol">
<li><a id="orgaa4c363"></a>column-level constrains<br />
<div class="outline-text-6" id="text-1-3-2-2-1">
<ul class="org-ul">
<li>not null</li>
<li>unique</li>
<li>primary key</li>
<li>foreign key</li>
<li>check</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">temp</span> <span style="color: #859900;">table</span> <span style="color: #268bd2;">foo</span><span style="color: #757575;">(</span>
x <span style="color: #b58900;">integer</span><span style="color: #757575;">,</span>
y <span style="color: #b58900;">integer</span> <span style="color: #859900;">check</span> <span style="color: #757575;">(</span>y&gt;x<span style="color: #757575;">),</span>
z <span style="color: #b58900;">integer</span> <span style="color: #859900;">check</span> <span style="color: #757575;">(</span>z&gt;<span style="color: #839496;">abs</span><span style="color: #757575;">(</span>y<span style="color: #757575;">)),</span>
<span style="color: #757575;">)</span>;
</pre>
</div>
<p>
see also `trigger`
</p>
<ul class="org-ul">
<li>collate
<ul class="org-ul">
<li>binary</li>
<li>nocase</li>
</ul></li>
<li>default</li>
<li>autoincrement</li>
</ul>
</div>
</li>

<li><a id="org7cddc28"></a>table-level constrains<br />
<div class="outline-text-6" id="text-1-3-2-2-2">
<ul class="org-ul">
<li>primary key</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">CREATE</span> <span style="color: #859900;">TABLE</span> <span style="color: #268bd2;">xxx</span> <span style="color: #757575;">(</span>
data1 <span style="color: #b58900;">text</span><span style="color: #757575;">,</span>
data2 <span style="color: #b58900;">text</span><span style="color: #757575;">,</span>
<span style="color: #859900;">primary</span> <span style="color: #859900;">key</span> <span style="color: #757575;">(</span>data1<span style="color: #757575;">,</span> data2<span style="color: #757575;">)</span>
<span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>unique</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">CREATE</span> <span style="color: #859900;">TABLE</span> <span style="color: #268bd2;">xxx</span> <span style="color: #757575;">(</span>
_id <span style="color: #b58900;">integer</span> <span style="color: #859900;">primary</span> <span style="color: #859900;">key</span><span style="color: #757575;">,</span>
data1 <span style="color: #b58900;">text</span><span style="color: #757575;">,</span>
data2 <span style="color: #b58900;">text</span><span style="color: #757575;">,</span>
<span style="color: #859900;">unique</span> <span style="color: #757575;">(</span>data1<span style="color: #757575;">,</span> data2<span style="color: #757575;">)</span>
<span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>check</li>
</ul>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org6f438b4" class="outline-4">
<h4 id="org6f438b4"><span class="section-number-4">1.3.3</span> trigger</h4>
<div class="outline-text-4" id="text-1-3-3">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> [<span style="color: #859900;">temp</span>|<span style="color: #859900;">temporary</span>] <span style="color: #859900;">trigger</span> <span style="color: #859900;">name</span>
[<span style="color: #859900;">before</span>|<span style="color: #859900;">after</span>|<span style="color: #859900;">instead</span> <span style="color: #859900;">of</span>] [<span style="color: #859900;">insert</span>|<span style="color: #859900;">delete</span>|<span style="color: #859900;">update</span>|<span style="color: #859900;">update</span> <span style="color: #859900;">of</span> columns] <span style="color: #859900;">on</span> <span style="color: #859900;">table</span>
[<span style="color: #859900;">for</span> <span style="color: #859900;">each</span> <span style="color: #859900;">row</span>] [<span style="color: #859900;">when</span> expr]
<span style="color: #859900;">begin</span>
<span style="color: #859900;">action</span>
<span style="color: #859900;">end</span>;
</pre>
</div>
<ul class="org-ul">
<li>using trigger to update view</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">trigger</span> <span style="color: #268bd2;">on_update_foods_view</span>
<span style="color: #859900;">instead</span> <span style="color: #859900;">of</span> <span style="color: #859900;">update</span> <span style="color: #859900;">on</span> foods_view
<span style="color: #859900;">for</span> <span style="color: #859900;">each</span> <span style="color: #859900;">row</span>
<span style="color: #859900;">begin</span>
   <span style="color: #859900;">update</span> foods <span style="color: #859900;">set</span> <span style="color: #859900;">name</span>=<span style="color: #859900;">new</span>.fname <span style="color: #859900;">where</span> id=<span style="color: #859900;">new</span>.fid;
   <span style="color: #859900;">update</span> food_types <span style="color: #859900;">set</span> <span style="color: #859900;">name</span>=<span style="color: #859900;">new</span>.tname <span style="color: #859900;">where</span> id=<span style="color: #859900;">new</span>.tid;
<span style="color: #859900;">end</span>;
</pre>
</div>
<p>
注: sqlite 的 trigger 不支持 `for each statement`, 只支持 `for each row`
</p>
</div>
</div>

<div id="outline-container-org3fe616c" class="outline-4">
<h4 id="org3fe616c"><span class="section-number-4">1.3.4</span> transaction</h4>
<div class="outline-text-4" id="text-1-3-4">
<ul class="org-ul">
<li>begin [ deferred | immediate | exclusive ] [transaction]</li>
<li>commit</li>
<li>rollback</li>
<li>savepoint</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">begin</span> <span style="color: #859900;">transaction</span>;
<span style="color: #859900;">insert</span> <span style="color: #859900;">into</span> xxx;
<span style="color: #2aa198;">...</span>
<span style="color: #859900;">savepoint</span> test
<span style="color: #2aa198;">...</span>
<span style="color: #859900;">rollback</span> <span style="color: #859900;">to</span> test
<span style="color: #2aa198;">...</span>
<span style="color: #859900;">commit</span>
</pre>
</div>
<p>
insert into xxx;
save
</p>
</div>
</div>

<div id="outline-container-org7330356" class="outline-4">
<h4 id="org7330356"><span class="section-number-4">1.3.5</span> confict resolution</h4>
<div class="outline-text-4" id="text-1-3-5">
<ul class="org-ul">
<li>replace</li>
<li>ignore
忽略本次错误, 继续执行</li>
<li>fail
结束, 但不回滚</li>
<li>abort
default
回滚, 然后结束</li>
<li>rollback
回滚, 但不结束</li>
</ul>

<p>
confict resolution can be specified in
</p>
<ul class="org-ul">
<li>table or view defination</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">temp</span> <span style="color: #859900;">table</span> <span style="color: #859900;">cast</span><span style="color: #757575;">(</span><span style="color: #859900;">name</span> <span style="color: #b58900;">text</span> <span style="color: #859900;">unique</span> <span style="color: #859900;">on</span> <span style="color: #859900;">conflict</span> <span style="color: #859900;">rollback</span><span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>in `insert`, `update`</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">insert</span> <span style="color: #859900;">or</span> <span style="color: #859900;">replace</span> <span style="color: #859900;">into</span> <span style="color: #859900;">table</span> <span style="color: #859900;">values</span> <span style="color: #757575;">(</span>xxx<span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>trigger</li>
</ul>
</div>
</div>

<div id="outline-container-org8a67be4" class="outline-4">
<h4 id="org8a67be4"><span class="section-number-4">1.3.6</span> join</h4>
<div class="outline-text-4" id="text-1-3-6">
<ul class="org-ul">
<li>inner join</li>
</ul>
<p>
join
</p>
<ul class="org-ul">
<li>left outer join</li>
</ul>
<p>
left out join
</p>
<ul class="org-ul">
<li>right outer join</li>
</ul>
<p>
not supported
</p>
<ul class="org-ul">
<li>full outer join</li>
</ul>
<p>
not supported
</p>
<ul class="org-ul">
<li>cross</li>
</ul>
<p>
select from tbl1, tbl2
</p>
</div>
</div>

<div id="outline-container-orgcf917d6" class="outline-4">
<h4 id="orgcf917d6"><span class="section-number-4">1.3.7</span> index</h4>
<div class="outline-text-4" id="text-1-3-7">
<p>
refers <a href="#org35079fc">1.2.9</a> to delete whether index is used for optimization
</p>

<ul class="org-ul">
<li>index</li>
<li>unique index</li>
<li><p>
covering index
covering index 是指同一个 index 中有多个字段, 查找时直接从 index 中取得了数据, 而不是从 index 取得主键, 再到主表获取数据. 例如:
</p>

<p>
create index m3_index on foo(x,y);
explain query plan select y from foo where x="a";
</p></li>
</ul>

<p>
0|0|0|SEARCH TABLE foo USING COVERING INDEX m3_index (x=?) (~10 rows)
</p>

<p>
Note:
</p>
<ul class="org-ul">
<li>collate 会影响 index, 例如若 select 时或建表时使用的 collate 与建立
index 时指定的 collate 不一致时, index 无法起作用.</li>
<li>create index 可以指定多个字段 (以利于形成 covering index), 但多个字段是联合在一起索引的, 例如 (x,y,z), 则使用 x, x and y, x and y and
z 时索引起作用, 但使用 y and z, z 时不起作用.</li>
</ul>
</div>
</div>

<div id="outline-container-orge4c671f" class="outline-4">
<h4 id="orge4c671f"><span class="section-number-4">1.3.8</span> view</h4>
<div class="outline-text-4" id="text-1-3-8">
<ul class="org-ul">
<li>using trigger to update view</li>
</ul>
</div>
</div>

<div id="outline-container-org4229535" class="outline-4">
<h4 id="org4229535"><span class="section-number-4">1.3.9</span> insert</h4>
</div>

<div id="outline-container-org11ceeae" class="outline-4">
<h4 id="org11ceeae"><span class="section-number-4">1.3.10</span> update</h4>
</div>

<div id="outline-container-orga158f9b" class="outline-4">
<h4 id="orga158f9b"><span class="section-number-4">1.3.11</span> select</h4>
<div class="outline-text-4" id="text-1-3-11">
<pre class="example" id="org71ef4c7">

          -+-------------------------------------------------------------------------------------+
           |       -+-----------------------------------------------------------+                |        result
           |        |                        -+---------------+                 |                |          ^
           |        |                         |               |                 |                |          |
SELECT DISTINCT heading FROM tables WHERE predicate GROUP BY columns HAVING predicate ORDER BY columns LIMIT init,int;
           | 6      | 5         | 1           | 2             | 3               | 4              | 7        | 8
           |        |           |             |               |                 |                |          |
          -+--------+          -+-------------+              -+-----------------+               -+----------+

</pre>
</div>

<div id="outline-container-org1d0efc6" class="outline-5">
<h5 id="org1d0efc6"><span class="section-number-5">1.3.11.1</span> distinct</h5>
<div class="outline-text-5" id="text-1-3-11-1">
<p>
distinct 可以同时修饰多个字段
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> <span style="color: #859900;">distinct</span> id<span style="color: #757575;">,</span> <span style="color: #859900;">name</span> <span style="color: #859900;">from</span> xxx;
</pre>
</div>
<p>
表示只有 (id,name) 都相同时才算相同
</p>
</div>
</div>

<div id="outline-container-orge0f61f4" class="outline-5">
<h5 id="orge0f61f4"><span class="section-number-5">1.3.11.2</span> where</h5>
</div>

<div id="outline-container-orged19e68" class="outline-5">
<h5 id="orged19e68"><span class="section-number-5">1.3.11.3</span> group by</h5>
</div>

<div id="outline-container-org3425347" class="outline-5">
<h5 id="org3425347"><span class="section-number-5">1.3.11.4</span> having</h5>
</div>

<div id="outline-container-orgef11f0f" class="outline-5">
<h5 id="orgef11f0f"><span class="section-number-5">1.3.11.5</span> order by</h5>
</div>

<div id="outline-container-orgbb617a1" class="outline-5">
<h5 id="orgbb617a1"><span class="section-number-5">1.3.11.6</span> limit</h5>
</div>

<div id="outline-container-orgd7b0bcf" class="outline-5">
<h5 id="orgd7b0bcf"><span class="section-number-5">1.3.11.7</span> sub-query</h5>
<div class="outline-text-5" id="text-1-3-11-7">
<ul class="org-ul">
<li>for `select`</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> _id<span style="color: #757575;">,</span> <span style="color: #757575;">(</span><span style="color: #859900;">select</span> <span style="color: #859900;">name</span> <span style="color: #859900;">from</span> xx <span style="color: #859900;">where</span> _id=f._id <span style="color: #757575;">)</span> <span style="color: #859900;">from</span> xx <span style="color: #859900;">as</span> f;
</pre>
</div>
<ul class="org-ul">
<li>for `from`</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> _id <span style="color: #859900;">from</span> <span style="color: #757575;">(</span><span style="color: #859900;">select</span> _id<span style="color: #757575;">,</span><span style="color: #859900;">name</span> <span style="color: #859900;">from</span> xxx<span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>for `order by`</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> _id <span style="color: #859900;">from</span> xxx <span style="color: #859900;">as</span> f <span style="color: #859900;">order</span> <span style="color: #859900;">by</span> <span style="color: #757575;">(</span><span style="color: #859900;">select</span> score <span style="color: #859900;">from</span> xxx <span style="color: #859900;">where</span> _id=f._id<span style="color: #757575;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>for `where'</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> _id <span style="color: #859900;">from</span> xxx <span style="color: #859900;">where</span> _id <span style="color: #859900;">in</span> <span style="color: #757575;">(</span><span style="color: #859900;">select</span> _id <span style="color: #859900;">from</span> xxx<span style="color: #757575;">)</span>;
</pre>
</div>

<p>
Note:
</p>
<ul class="org-ul">
<li>sub-query 几乎可以用在任何地方</li>
<li>sub-query 通常需要设置别名</li>
<li>sub-query 只能返回一列.</li>
<li>sub-query 有时需要返回一行 (例如在 order by 的场合), 这时若返回多行,
则系统只会使用第一行.</li>
</ul>
</div>
</div>

<div id="outline-container-orge106c0b" class="outline-5">
<h5 id="orge106c0b"><span class="section-number-5">1.3.11.8</span> compound query</h5>
<div class="outline-text-5" id="text-1-3-11-8">
<p>
compound query 要求各个查询返回相同的例, 且只能在 compound query 最后有一个 order by
</p>
</div>

<ol class="org-ol">
<li><a id="org4179aa1"></a>union [all]<br />
<div class="outline-text-6" id="text-1-3-11-8-1">
<p>
a | b
</p>
</div>
</li>

<li><a id="orga56c6f0"></a>intercept<br />
<div class="outline-text-6" id="text-1-3-11-8-2">
<p>
a &amp; b
</p>
</div>
</li>

<li><a id="orga1666ad"></a>except<br />
<div class="outline-text-6" id="text-1-3-11-8-3">
<p>
a - b
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4d6a5a2" class="outline-5">
<h5 id="org4d6a5a2"><span class="section-number-5">1.3.11.9</span> conditional result</h5>
<div class="outline-text-5" id="text-1-3-11-9">
<p>
used to transform column values
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">case</span> <span style="color: #859900;">value</span>
  <span style="color: #859900;">when</span> x <span style="color: #859900;">then</span> value_x
  <span style="color: #859900;">when</span> y <span style="color: #859900;">then</span> value_y
  <span style="color: #859900;">when</span> z <span style="color: #859900;">then</span> value_z
  <span style="color: #859900;">else</span> default_value
<span style="color: #859900;">end</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> <span style="color: #859900;">name</span><span style="color: #757575;">,(</span><span style="color: #859900;">select</span>
              <span style="color: #859900;">case</span>
              <span style="color: #859900;">when</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> &gt; 4 <span style="color: #859900;">then</span> <span style="color: #2aa198;">'Very High'</span>
              <span style="color: #859900;">when</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> = 4 <span style="color: #859900;">then</span> <span style="color: #2aa198;">'High'</span>
              <span style="color: #859900;">when</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> <span style="color: #859900;">in</span> <span style="color: #757575;">(</span>2<span style="color: #757575;">,</span>3<span style="color: #757575;">)</span> <span style="color: #859900;">then</span> <span style="color: #2aa198;">'Moderate'</span>
              <span style="color: #859900;">else</span> <span style="color: #2aa198;">'Low'</span>
              <span style="color: #859900;">end</span>
              <span style="color: #859900;">from</span> foods_episodes
              <span style="color: #859900;">where</span> food_id=f.id<span style="color: #757575;">)</span> <span style="color: #859900;">as</span> frequency
<span style="color: #859900;">from</span> foods f
<span style="color: #859900;">where</span> frequency <span style="color: #859900;">like</span> <span style="color: #2aa198;">'%High'</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb3bbfa7" class="outline-4">
<h4 id="orgb3bbfa7"><span class="section-number-4">1.3.12</span> functions</h4>
<div class="outline-text-4" id="text-1-3-12">
</div>
<div id="outline-container-org9846128" class="outline-5">
<h5 id="org9846128"><span class="section-number-5">1.3.12.1</span> core functions</h5>
<div class="outline-text-5" id="text-1-3-12-1">
<ul class="org-ul">
<li>last_insert_rowid()</li>
<li><p>
coalesce (x, y, z, &#x2026;)
return the first not null value, or null
</p>

<p>
e.g. coalesce (null, 1, 2, null) returns 1
</p></li>
<li>ifnull (x, y)
ifnull (x, y) &lt;==&gt; coalesce(x, y)
e.g.
SELECT Name, IFNULL(Age, 'unknown') AS Age FROM People</li>
<li>nullif (x, y)
若 x,y 相同返回 null, 否则返回 x.
e.g.
SELECT COUNT(NULLIF(Bonus, 0)) FROM Employees</li>
<li>glob</li>
<li>like</li>
<li>substr</li>
<li>trim</li>
<li>ltrim</li>
<li>rtrim</li>
<li>instr</li>
<li>quote</li>
<li>length</li>
<li>lower</li>
<li>upper</li>
<li>abs</li>
<li>max</li>
<li>min</li>
<li>random</li>
<li>replace</li>
<li>hex</li>
<li>round</li>
<li>date</li>
</ul>
</div>
</div>

<div id="outline-container-orgb664508" class="outline-5">
<h5 id="orgb664508"><span class="section-number-5">1.3.12.2</span> aggregation function</h5>
<div class="outline-text-5" id="text-1-3-12-2">
<ul class="org-ul">
<li>avg</li>
<li>sum</li>
<li>total</li>
<li>max</li>
<li>min</li>
<li>count (x)</li>
<li>count (*)</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org3591171" class="outline-4">
<h4 id="org3591171"><span class="section-number-4">1.3.13</span> fts</h4>
</div>

<div id="outline-container-org8ba996b" class="outline-4">
<h4 id="org8ba996b"><span class="section-number-4">1.3.14</span> Summary</h4>
<div class="outline-text-4" id="text-1-3-14">
</div>
<div id="outline-container-org96d9e1b" class="outline-5">
<h5 id="org96d9e1b"><span class="section-number-5">1.3.14.1</span> cross-join != full-outer-join</h5>
<div class="outline-text-5" id="text-1-3-14-1">
<p>
例如, 若 A 表为 3 条, 其中 _id 分别为 1,2,3. B 表为 4 条, _id 分别为
5,6,7,8, 则:
</p>
<ul class="org-ul">
<li>select * from A, B where A._id = B._id 返回 0 条</li>
<li>select * from A full outer join B on A._id = B._id 返回 7 条 (此处为假设 full-outer-join 是支持的)</li>
</ul>
</div>
</div>

<div id="outline-container-org7bdbcb8" class="outline-5">
<h5 id="org7bdbcb8"><span class="section-number-5">1.3.14.2</span> having 与 where 的区别</h5>
<div class="outline-text-5" id="text-1-3-14-2">
<ul class="org-ul">
<li>haveing 发生在 group by 之后, 而 where 发生在 group by 之前;</li>
<li>可以使用 aggregation 函数</li>
</ul>
</div>
</div>

<div id="outline-container-org536418f" class="outline-5">
<h5 id="org536418f"><span class="section-number-5">1.3.14.3</span> aggregation 函数只可以使用在 select 之后和 having 之后</h5>
</div>

<div id="outline-container-org7eb484e" class="outline-5">
<h5 id="org7eb484e"><span class="section-number-5">1.3.14.4</span> 使用两个 left-outer-join 模拟 full-outer-join</h5>
<div class="outline-text-5" id="text-1-3-14-4">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> * <span style="color: #859900;">from</span> A <span style="color: #859900;">left</span> <span style="color: #859900;">outer</span> <span style="color: #859900;">join</span> B <span style="color: #859900;">on</span> A._id = B._id
<span style="color: #859900;">UNION</span>
<span style="color: #859900;">select</span> * <span style="color: #859900;">from</span> B <span style="color: #859900;">left</span> <span style="color: #859900;">outer</span> <span style="color: #859900;">join</span> A <span style="color: #859900;">on</span> A._id = B._id
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f7ea94" class="outline-5">
<h5 id="org1f7ea94"><span class="section-number-5">1.3.14.5</span> distinct 可以使用 group by 来模拟</h5>
</div>

<div id="outline-container-org45fcfe0" class="outline-5">
<h5 id="org45fcfe0"><span class="section-number-5">1.3.14.6</span> compound query 只允许在最后使用一个 order-by, 不过可以用 sub-query 来跳过这一限制</h5>
</div>

<div id="outline-container-org9067e7e" class="outline-5">
<h5 id="org9067e7e"><span class="section-number-5">1.3.14.7</span> sub-query 几乎可以使用在任何地方, 不过只允许返回一列, 但可以返回多行 (虽然有时只有第一行有效)</h5>
</div>

<div id="outline-container-org4ea998e" class="outline-5">
<h5 id="org4ea998e"><span class="section-number-5">1.3.14.8</span> sqlite 允许在有 group by 中查询中 select group-by 之外的字段, 只是结果是不可靠的. 例如:</h5>
<div class="outline-text-5" id="text-1-3-14-8">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> <span style="color: #859900;">name</span><span style="color: #757575;">,</span> id <span style="color: #859900;">from</span> xxx <span style="color: #859900;">group</span> <span style="color: #859900;">by</span> id;
</pre>
</div>

<p>
同理适用于 aggregation functions, 例如:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> *<span style="color: #757575;">,</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> <span style="color: #859900;">from</span> xxx;
</pre>
</div>
</div>
</div>

<div id="outline-container-org13a39e6" class="outline-5">
<h5 id="org13a39e6"><span class="section-number-5">1.3.14.9</span> integer primary key =&gt; autoincrement (but with filling-gaps)</h5>
</div>

<div id="outline-container-org7b91c33" class="outline-5">
<h5 id="org7b91c33"><span class="section-number-5">1.3.14.10</span> autoincrement 会导致后续的值一定比之前的大 (不会有 filling-gaps 效果), 当到达最大值后, 返回 data is full error</h5>
<div class="outline-text-5" id="text-1-3-14-10">
<p>
这一点需要与 integer primary key 区别
</p>
</div>
</div>

<div id="outline-container-org6448d87" class="outline-5">
<h5 id="org6448d87"><span class="section-number-5">1.3.14.11</span> autoincrement 必须在 integer primary key 后使用</h5>
</div>

<div id="outline-container-org680d6d1" class="outline-5">
<h5 id="org680d6d1"><span class="section-number-5">1.3.14.12</span> storage class vs. sort</h5>
<div class="outline-text-5" id="text-1-3-14-12">
<p>
storage class 与列的定义无关, 它取决了输入的数据的格式:
61, 61,0, "a", x'61', null 的 storage class 分别为 integer, real,
text, blob, null
</p>

<p>
不同的 storage class 的排序规则:
null &lt; integer = real &lt; text &lt; blob
</p>

<p>
see also 
</p>
</div>
</div>

<div id="outline-container-org7cee8dd" class="outline-5">
<h5 id="org7cee8dd"><span class="section-number-5">1.3.14.13</span> sqlite 的 view 是不可修改的, 但可以用 trigger 来模拟实现可修改的 view</h5>
</div>

<div id="outline-container-org079e7ed" class="outline-5">
<h5 id="org079e7ed"><span class="section-number-5">1.3.14.14</span> index 可以同时指定多个字段, 以便使用 covering index, 但要注意查询条件, 例如</h5>
<div class="outline-text-5" id="text-1-3-14-14">
<p>
(x,y,z)三个字段的索引,使用 x, x and y, x and y and z 会使用索引, 但
y, y and z, z 不会.
</p>
</div>
</div>

<div id="outline-container-org7240beb" class="outline-5">
<h5 id="org7240beb"><span class="section-number-5">1.3.14.15</span> 一次查询可能会使用多个索引, 例如使用 or 的情况下:</h5>
<div class="outline-text-5" id="text-1-3-14-15">
<p>
create index m1_index on foo(x);
create index m1_index on foo(y);
select x from foo where x="a" or y="a";
0|0|0|SEARCH TABLE foo USING INDEX m1_index (x=?) (~10 rows)
0|0|0|SEARCH TABLE foo USING INDEX m2_index (y=?) (~10 rows)
</p>
</div>
</div>

<div id="outline-container-orge56f615" class="outline-5">
<h5 id="orge56f615"><span class="section-number-5">1.3.14.16</span> unique index</h5>
</div>

<div id="outline-container-orgd695b66" class="outline-5">
<h5 id="orgd695b66"><span class="section-number-5">1.3.14.17</span> 有些情况下 index 无法使用, 例如</h5>
<div class="outline-text-5" id="text-1-3-14-17">
<ul class="org-ul">
<li>glob "a*"</li>
<li>like (测试了下似乎 sqlite 并不会对 like 进行优化, 可能和版本有关?)</li>
<li>多列索引时有些情况</li>
<li>select xx from xx where length(x)=5, 等</li>
</ul>
</div>
</div>

<div id="outline-container-org61d35da" class="outline-5">
<h5 id="org61d35da"><span class="section-number-5">1.3.14.18</span> savepoint &amp; rollback to</h5>
</div>

<div id="outline-container-orge9858a0" class="outline-5">
<h5 id="orge9858a0"><span class="section-number-5">1.3.14.19</span> conflict resolution</h5>
</div>

<div id="outline-container-orgfbd4ad0" class="outline-5">
<h5 id="orgfbd4ad0"><span class="section-number-5">1.3.14.20</span> attach database</h5>
</div>
</div>
</div>

<div id="outline-container-orgfd1292e" class="outline-3">
<h3 id="orgfd1292e"><span class="section-number-3">1.4</span> sqlite limitation</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>不支持 right/full outer join</li>
<li>不完全的 alter table 支持</li>
<li>不完全的触发器支持</li>
<li>视图是只读的</li>
<li>不支持物化的视图</li>
<li>不支持 GRAND and REVOKE</li>
<li>不支持表/行级别的锁</li>
<li>不支持存储过程</li>
</ul>
</div>
</div>

<div id="outline-container-org13bd06e" class="outline-3">
<h3 id="org13bd06e"><span class="section-number-3">1.5</span> sqlite pragma</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org4901d12" class="outline-4">
<h4 id="org4901d12"><span class="section-number-4">1.5.1</span> auto_vacuum = 0/1</h4>
</div>

<div id="outline-container-org72f8c7f" class="outline-4">
<h4 id="org72f8c7f"><span class="section-number-4">1.5.2</span> cache_size</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
cache_size 表示 writer 在真正 flush 日志文件和 page cache 之前, 最多能 cache 多少修改.
</p>
</div>
</div>

<div id="outline-container-org5759a5c" class="outline-4">
<h4 id="org5759a5c"><span class="section-number-4">1.5.3</span> default_cache_size</h4>
</div>

<div id="outline-container-orgcb2aae0" class="outline-4">
<h4 id="orgcb2aae0"><span class="section-number-4">1.5.4</span> case_sensitive_like = 0/1</h4>
</div>

<div id="outline-container-org13ad847" class="outline-4">
<h4 id="org13ad847"><span class="section-number-4">1.5.5</span> count_changes = 0/1</h4>
</div>

<div id="outline-container-org6b4438d" class="outline-4">
<h4 id="org6b4438d"><span class="section-number-4">1.5.6</span> encoding = "UTF-8"</h4>
</div>

<div id="outline-container-org2e7a4cc" class="outline-4">
<h4 id="org2e7a4cc"><span class="section-number-4">1.5.7</span> page_size = bytes</h4>
</div>

<div id="outline-container-org795b455" class="outline-4">
<h4 id="org795b455"><span class="section-number-4">1.5.8</span> max_page_count</h4>
</div>

<div id="outline-container-org1a9434e" class="outline-4">
<h4 id="org1a9434e"><span class="section-number-4">1.5.9</span> synchronous = FULL/NORMAL/OFF</h4>
<div class="outline-text-4" id="text-1-5-9">
<p>
synchronous 表示 write 在 commit 或 cache 满后如何 flush 日志文件.
</p>

<p>
FULL 一定不会导致 playback 出错: 在 syncJournal 时, sqlite 会先将数据 sync, 然后再 sync journal 头, 包括 (nRec 字段)
</p>

<p>
NORMAL 可能会导致 playback 出错, 因为 syncJournal 时, sqlite 会先将
header 添加到日志中, 然后一次性 sync 到磁盘, 此时掉电有可能导致
journal 头显示这是一个 hot-journal, 但后续的数据确是错的. 
</p>

<p>
特别的,在 WAL 模式下, synchronous 为 NORMAL 时 commit 也不再写数据库,
只有 checkout 时才刷新.
</p>
</div>
</div>

<div id="outline-container-org557f4ba" class="outline-4">
<h4 id="org557f4ba"><span class="section-number-4">1.5.10</span> vdbe_trace=on/off</h4>
</div>

<div id="outline-container-org74f39e2" class="outline-4">
<h4 id="org74f39e2"><span class="section-number-4">1.5.11</span> vdbe_listing=on/off</h4>
</div>

<div id="outline-container-org94e5cb5" class="outline-4">
<h4 id="org94e5cb5"><span class="section-number-4">1.5.12</span> parser_trace=on/off</h4>
</div>

<div id="outline-container-orga93246c" class="outline-4">
<h4 id="orga93246c"><span class="section-number-4">1.5.13</span> temp_store</h4>
<div class="outline-text-4" id="text-1-5-13">
<p>
临时文件保存在内存(1)还是磁盘(2)或者由编译时指定(0).临时文件包括各种临时表(视图, 子查询), 临时索引(order by, group by, distinct &#x2026;), 临时数据库 (temp table), statement journal.
</p>

<p>
即使选择用磁盘保存临时文件, sqlite 也会通过 pcache 优先将它暂时保存在内存里而避免写磁盘.
</p>
</div>
</div>

<div id="outline-container-org14eef8c" class="outline-4">
<h4 id="org14eef8c"><span class="section-number-4">1.5.14</span> locking_mode=normal/exclusive</h4>
<div class="outline-text-4" id="text-1-5-14">
<p>
在 NORMAL 模式下， (默认值), 一个数据库连接会在每次完成读或写时释放数据库文件锁。 当锁模式设为 EXCLUSIVE 时，数据库连接永远不会释放文件锁。 在该模式下，当第一次读数据库文件时，会获得并持有一个共享锁。 当第一次向数据库写时，将获得并持有一个排它锁。在 EXCLUSIVE 模式下获得的锁可以通过关闭数据库连接来释放， 也可以通过使用该 pragma 将锁模式改为 NORMAL，并且再次访问（读或写） 数据库来释放。仅仅将锁模式置为 NORMAL 是不够的， 直到下一次访问数据库文件时才会释放已持有的锁。有两种原因要求设置
EXCLUSIVE 锁模式。 一是一个应用程序确实不希望其它进程访问数据库文件。
二是在这种模式下可以使用优化器，它可以节省少量的磁盘文件操作。 这在嵌入式系统中可能非常重要
</p>
</div>
</div>
</div>

<div id="outline-container-orge200df7" class="outline-3">
<h3 id="orge200df7"><span class="section-number-3">1.6</span> optimization</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org0cc6a00" class="outline-4">
<h4 id="org0cc6a00"><span class="section-number-4">1.6.1</span> 使用索引</h4>
</div>

<div id="outline-container-org7fe86b1" class="outline-4">
<h4 id="org7fe86b1"><span class="section-number-4">1.6.2</span> 避免 transient table (subquery)</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
许多 sqlite 操作例如 order by, aggregation, subquery 等需要使用到
transient table 来暂存中间结果, 尤其是 subquery. 这些 transient table 主要的问题是无法使用 index.
</p>
<ul class="org-ul">
<li>使用显式的 temp table 并使用索引?</li>
<li><p>
sqlite 本身可以对一些 subquery 进行扁平化 (flattening), 例如:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">SELECT</span> * <span style="color: #859900;">FROM</span> ex1 <span style="color: #859900;">WHERE</span> ex1.a <span style="color: #859900;">IN</span> <span style="color: #757575;">(</span><span style="color: #859900;">SELECT</span> b <span style="color: #859900;">FROM</span> ex2<span style="color: #757575;">)</span>;
</pre>
</div>

<p>
可能被扁平化为
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">SELECT</span> ex1.*<span style="color: #757575;">,</span> ex2.b <span style="color: #859900;">FROM</span> ex1 <span style="color: #859900;">JOIN</span> ex2 <span style="color: #859900;">ON</span> ex2.b=ex1.a;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgb528e7b" class="outline-4">
<h4 id="orgb528e7b"><span class="section-number-4">1.6.3</span> automatic index</h4>
</div>

<div id="outline-container-org5cc5978" class="outline-4">
<h4 id="org5cc5978"><span class="section-number-4">1.6.4</span> view 与 subquery 类似, 无法使用索引</h4>
</div>

<div id="outline-container-org5c167a8" class="outline-4">
<h4 id="org5c167a8"><span class="section-number-4">1.6.5</span> join 的顺序</h4>
</div>

<div id="outline-container-org024eb53" class="outline-4">
<h4 id="org024eb53"><span class="section-number-4">1.6.6</span> 使用 limit</h4>
</div>
</div>

<div id="outline-container-orgf1c2404" class="outline-3">
<h3 id="orgf1c2404"><span class="section-number-3">1.7</span> references</h3>
<div class="outline-text-3" id="text-1-7">
<p>
<a href="http://www.sqlite.org/syntaxdiagrams.html">Syntax Diagrams For SQLite</a>
</p>
</div>
</div>

<div id="outline-container-org546d8e4" class="outline-3">
<h3 id="org546d8e4"><span class="section-number-3">1.8</span> Other</h3>
<div class="outline-text-3" id="text-1-8">
</div>
<div id="outline-container-org14efcb6" class="outline-4">
<h4 id="org14efcb6"><span class="section-number-4">1.8.1</span> WAL</h4>
<div class="outline-text-4" id="text-1-8-1">
<p>
Write Ahead Logging (WAL) 是与 sqlite 默认的 rollback journal (或
delete journal, shadow paging) 完全不同的一种 journal mode. 通过 WAL,
数据库可以做到读和写互相完全不干扰, 并且减少 IO 操作.
</p>
</div>

<div id="outline-container-org71fc613" class="outline-5">
<h5 id="org71fc613"><span class="section-number-5">1.8.1.1</span> How WAL works</h5>
<div class="outline-text-5" id="text-1-8-1-1">
<p>
当 commit 一个 write transaction 时, rollback journal 的作法是先刷新所有修改到 journal, 然后再刷新 cache 到数据库. 而 WAL 的作法是只将修改刷新到 wal journal 中, 而不修改数据库. 只有当用户调用 pragma
wal_checkpoint 或 超过 1000 页被修改时, wal journal 中的修改才会被写回到数据库.
</p>

<p>
为了使 read transaction 能读到最新的数据, 每个 read transaction 开始时会扫描 wal journal, 并在 wal file 中记下一个 mark point, 在读数据库时,
根据一个 wal index shm 判断要读的 page 是否在 wal journal 中, 若存在,
并且不超过 mark point, 则使用 wal journal 中的数据, 否则使用数据库中的数据. 这样可以使得读写不用互相等待. (但这样有一点问题, 就是无法保证读到最新的数据, 因为有可能在读的过程中, 又有新的数据追加到 wal journal
file 中 makr point 之后)
</p>
</div>

<ol class="org-ol">
<li><a id="orge0d4167"></a>WAL 的优点<br />
<div class="outline-text-6" id="text-1-8-1-1-1">
<ul class="org-ul">
<li>读写互不影响</li>
<li><p>
降低了 IO 的使用
</p>

<p>
commit 只需要写 wal journal file, 不需要写数据库. 特别的, 若 WAL 模式下设置 pragma synchronous 为 NORMAL 的话,则 commit 根本不会导致 IO 操作,只有 checkpoint 才会.  因此, 在 wal 模式下, commit 不进行 IO 可能会导致异常重启后数据丢失, 但不会造成数据库崩溃.
</p>

<p>
checkpoint 进行的 IO 操作包括:
</p>
<ol class="org-ol">
<li>写 wal 到磁盘</li>
<li>写 wal 到数据库</li>
<li>重置 wal</li>
</ol></li>
</ul>
</div>
</li>

<li><a id="org8a0d9b6"></a>WAL 的缺点<br />
<div class="outline-text-6" id="text-1-8-1-1-2">
<ul class="org-ul">
<li>可能无法读到"最新"的数据, 因为 read transaction 无法 block write
transaction</li>
<li>过大的 read transaction 会阻止 checkpoint (当 read transaction 正在进行时, 虽然允许 write transaction 追加数据到 wal journal, 但不允许清空,
因为 read transaction 已经在 journal 中标记了 mark point), 进而导致
wal journal 过大, 从而使 read transaction 变慢</li>
</ul>
</div>
</li>

<li><a id="orga2b96ef"></a>WAL 的配置<br />
<div class="outline-text-6" id="text-1-8-1-1-3">
<ul class="org-ul">
<li>pragma journal_mode=wal 开启 wal 模式</li>
<li>pragma journal_mode=delete 关闭 wal 模式</li>
<li>wal 模式的配置是 persistent 的</li>
<li>pragma wal_autocheckpoint=1000 设置 autocheckpoint 的 thresh-hold
特别的, 这个值越大, 则写的性能越高, 这个值越小, 则读的性能越好.</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgad450fb" class="outline-5">
<h5 id="orgad450fb"><span class="section-number-5">1.8.1.2</span> 关于 WAL journal file 的一个实验</h5>
<div class="outline-text-5" id="text-1-8-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75;">-- these are auto-committed</span>
<span style="color: #859900;">insert</span> <span style="color: #859900;">into</span> test <span style="color: #859900;">values</span> <span style="color: #757575;">(</span>"a"<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>;
<span style="color: #859900;">insert</span> <span style="color: #859900;">into</span> test <span style="color: #859900;">values</span> <span style="color: #757575;">(</span>"a"<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>;
<span style="color: #859900;">insert</span> <span style="color: #859900;">into</span> test <span style="color: #859900;">values</span> <span style="color: #757575;">(</span>"a"<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>;
<span style="color: #586e75;">-- &#29616;&#22312;, &#35760;&#24405;&#24212;&#35813;&#23384;&#22312; test.db-wal &#20013;, &#20294;&#36824;&#27809;&#26377;&#20889;&#21040;&#25968;&#25454;&#24211;&#20013;</span>
<span style="color: #586e75;">-- case A: &#19981;&#35843;&#29992; pragma wal_checkpoint</span>
  <span style="color: #586e75;">-- kill sqlite3_process</span>
  <span style="color: #586e75;">-- case A1: &#20808;&#21024;&#38500; test.db-wal, &#20877;&#25171;&#24320; test.db</span>
    <span style="color: #859900;">select</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> <span style="color: #859900;">from</span> test <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>="a";
    0
  <span style="color: #586e75;">-- case A2: &#19981;&#21024;&#38500; test.db-wal, &#25214;&#24320; test.db</span>
    <span style="color: #859900;">select</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> <span style="color: #859900;">from</span> test <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>="a";
    3
<span style="color: #586e75;">-- case B: &#35843;&#29992; pragma wal_checkpoint</span>
  <span style="color: #586e75;">-- kill sqlite3_process</span>
  <span style="color: #586e75;">-- &#26080;&#35770;&#26159;&#21542;&#21024;&#38500; test.db-wal, &#25171;&#24320; test.db</span>
    <span style="color: #859900;">select</span> <span style="color: #839496;">count</span><span style="color: #757575;">(</span>*<span style="color: #757575;">)</span> <span style="color: #859900;">from</span> test <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>="a";
    3
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgffdf290" class="outline-4">
<h4 id="orgffdf290"><span class="section-number-4">1.8.2</span> FTS</h4>
<div class="outline-text-4" id="text-1-8-2">
<p>
FTS (Full Text Search), 即全文检索,主要有以下几个方面:
</p>

<ul class="org-ul">
<li>stemming (词根)</li>
<li>tokenizer &amp;  word segregation (分词)</li>
<li>inverted index (倒排索引)</li>
</ul>
</div>

<div id="outline-container-orgb6ca855" class="outline-5">
<h5 id="orgb6ca855"><span class="section-number-5">1.8.2.1</span> stemming</h5>
<div class="outline-text-5" id="text-1-8-2-1">
<p>
<a href="http://en.wikipedia.org/wiki/Stemming">http://en.wikipedia.org/wiki/Stemming</a>
</p>

<p>
A stemmer for English, for example, should identify the string "cats" (and
possibly "catlike", "catty" etc.) as based on the root "cat".and "stemmer",
"stemming", "stemmed" as based on "stem".
</p>

<p>
A stemming algorithm reduces the words "fishing", "fished", "fish", and "fisher"
to the root word, "fish". On the other hand, "argue", "argued", "argues",
"arguing", and "argus" reduce to the stem "argu"
</p>

<p>
android contacts provider 就是使用的一种叫做 porter 的 stemmer 算法, 所以用 cat
可以查找到名为 catty 的人也是正常的.
</p>
</div>
</div>

<div id="outline-container-org4b780f9" class="outline-5">
<h5 id="org4b780f9"><span class="section-number-5">1.8.2.2</span> tokenizer and word segregation (分词)</h5>
<div class="outline-text-5" id="text-1-8-2-2">
<p>
全文检索是基于`关键字`匹配的检索, 与传统的 grep 等检索方法不同, 全文检索需要先建立索引文件, 建立索引文件的第一步就是将全文分解为一系列的关键字. 例如:
</p>

<p>
"A stemmer for English, for example, should identify the string "cats" (and
possibly "catlike", "catty" etc.) as based on the root "cat""
</p>

<p>
这句话可能会被分解为以下的关键字:
</p>

<p>
stem, english, example, identify, string, cat, possible, base, root
</p>

<p>
tokenize 的过程主要分为三步:
</p>
<ol class="org-ol">
<li>分词, 对英文来说, 基本就是以空格来分词</li>
<li>抛弃一些 stop words, 如 a, for, should, and ,etc, as, on 等</li>
<li>对剩下的非 stop words 使用 stemming 算法, 例如 cats-&gt;cat, stemmer-&gt;stem</li>
</ol>
</div>

<ol class="org-ol">
<li><a id="org78e63e7"></a>分词<br />
<div class="outline-text-6" id="text-1-8-2-2-1">
<p>
英文分词比较简单,就是以空格来分词, 对于中文或其他一些语言就麻烦的多, 以中文为例,
主要有以下几种分词方法:
</p>

<ol class="org-ol">
<li><p>
N 元分词就是简单的每 N 个字算一个词,
</p>
<ul class="org-ul">
<li>1 元分词:</li>
</ul>
<p>
英/文/分/词/比/较/简/单
</p>

<ul class="org-ul">
<li>2 元交叉为例:</li>
</ul>
<p>
英文/文分/分词/词比/比较/较简/简单
</p></li>

<li>基于词典匹配的分词
<ul class="org-ul">
<li>正向最大匹配
"市场/中国/有/企业/才能/发展"</li>
<li>逆向最大匹配
"市场/中/国有/企业/才能/发展"</li>
<li>双向最大匹配</li>
</ul></li>
<li>基于统计的分词</li>
</ol>


<p>
从目前存在的项目看, 综合 N 元分词与基于词典匹配的分词是主流的方法, 以 Apache
Lucene 为例: 它包含以下几种中文分词算法:
<a href="http://blog.csdn.net/chaocy/article/details/5938741">http://blog.csdn.net/chaocy/article/details/5938741</a>
</p>

<ul class="org-ul">
<li>StandardAnalyzer &amp; ChineseAnalyzer (一元分词)</li>
</ul>

<p>
2008/年/8/月/8/日/晚/举/世/瞩/目/的/北/京/第/二/十/九/届/奥/林/匹/克/运/动/会/开
/幕/式/在/国/家/体/育/场/隆/重/举/行
</p>

<ul class="org-ul">
<li>CJKAnalyzer (交叉二元分词)</li>
</ul>

<p>
2008/年/8/月/8/日晚/举世/世瞩/瞩目/目的/的北/北京/京第/第二/二十/十九/九届/届奥/
奥林/林匹/匹克/克运/运动/动会/会开/开幕/幕式/式在/在国/国家/家体/体育/育场/场隆/
隆重/重举/举行/
</p>

<ul class="org-ul">
<li>MIK_CAnalyzer  (最大匹配+二元交叉)</li>
</ul>

<p>
2008 年/8 月/8 日/晚/举世瞩目/目的/北京/第二十九届/奥林匹克运动会/开幕式/在国/国家/体育场/隆重举行/
</p>

<ul class="org-ul">
<li>etc</li>
</ul>

<p>
sqlite3 中因为支持 FTS, 所以也支持几种分词算法:
</p>
<ul class="org-ul">
<li>simple
针对英文, 根据空格分词</li>
<li>porter
针对英文, 使用 port stemmer</li>
<li>icu
使用 icu 库进行简单分词, 没有看懂 fts_icu 的源码, 从分词结果看类似于一元分词
(待确定)</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgde9a829" class="outline-5">
<h5 id="orgde9a829"><span class="section-number-5">1.8.2.3</span> inverted index (倒排索引)</h5>
<div class="outline-text-5" id="text-1-8-2-3">
<p>
通过分词算法确定关键词后, FTS 会使用倒排索引建立索引, 例如全文有两句话:
</p>

<p>
`今天天气怎么样.
今天天气不错. `
</p>

<ul class="org-ul">
<li><p>
分词的结果
</p>

<p>
今天/天气/怎么样/今天/天气/不错
</p></li>

<li><p>
倒排索引结果
</p>

<p>
今天-&gt;1,0;2,0
天气-&gt;1,2;2,2
怎么样-&gt;1,4
不错-&gt;2,4
</p></li>
</ul>

<p>
倒排索引的结果通常会以一种高效的利于查找的形式保存到索引文件中, 例如根据关键字排序, 或使用 B 树
</p>
</div>
</div>

<div id="outline-container-orgd3a29d2" class="outline-5">
<h5 id="orgd3a29d2"><span class="section-number-5">1.8.2.4</span> 查找过程</h5>
<div class="outline-text-5" id="text-1-8-2-4">
<p>
根据索引文件格式的不同, 查找的过程有所区别, 以 B 树为例, 查找过程就是以查找字符串为 KEY 在 B 树中查找该关键字,查到的 VALUE 就是该关键字在文档中的行列位置.
</p>

<p>
全文查找速度很快,但有一个明显的缺点: 检索的效果依赖于关键字的选择.
</p>

<p>
例如,
</p>
<ul class="org-ul">
<li>使用 "tty" 无法检索到 " hello kitty "这句话</li>
<li>使用 "天天" 可能无法检索到 "今天天气不错"</li>
</ul>
</div>
</div>

<div id="outline-container-orgf0f2e25" class="outline-5">
<h5 id="orgf0f2e25"><span class="section-number-5">1.8.2.5</span> FTS in sqlite3</h5>
<div class="outline-text-5" id="text-1-8-2-5">
<ul class="org-ul">
<li>create virtual table search_index using fts3(content TEXT, tokenize=porter);
tokenize 可以为 simple, porter, icu, 但默认情况下 icu tokenizer 功能没有被编译到 sqlite3 中</li>
<li>select * from search_index where content match "token1 token2"</li>
<li>select * from search_index where content match "tok*"</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org857e5a5" class="outline-4">
<h4 id="org857e5a5"><span class="section-number-4">1.8.3</span> ICU</h4>
</div>

<div id="outline-container-org77a3d1a" class="outline-4">
<h4 id="org77a3d1a"><span class="section-number-4">1.8.4</span> R-Tree</h4>
</div>

<div id="outline-container-org90334fe" class="outline-4">
<h4 id="org90334fe"><span class="section-number-4">1.8.5</span> SQLite Optimization FAQ</h4>
<div class="outline-text-4" id="text-1-8-5">
<p>
<a href="http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html">http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html</a>
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-09-09 六 00:00<br />
Last updated: 2021-09-16 四 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
