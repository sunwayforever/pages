<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 20:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SQlite: Benchmark</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">SQlite: Benchmark</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7bfbad2">1. SQlite: Benchmark</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7bfbad2" class="outline-2">
<h2 id="org7bfbad2"><span class="section-number-2">1</span> SQlite: Benchmark</h2>
<div class="outline-text-2" id="text-1">
<p>
分别使用 c,java 程序插入 10w 条记录, 设置 synchronous 为 full 或 off, 保
存数据库文件到 sdcard 或 mtd 设备. java 程序使用 execSQL 或
InsertHelper.
</p>

<ul class="org-ul">
<li>java 测试程序</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">private</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">writeDatabase</span>() {
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">mtd test: use /data/test.db to  mtd</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">sd test: use  /storage/sdcard1/test.db</span>
    <span style="font-weight: bold; text-decoration: underline;">SQLiteDatabase</span> <span style="font-weight: bold; font-style: italic;">db</span> = SQLiteDatabase.openDatabase(<span style="font-style: italic;">"/data/test.db"</span>, <span style="font-weight: bold; text-decoration: underline;">null</span>,<span style="font-weight: bold; text-decoration: underline;">SQLiteDatabase</span>.OPEN_READWRITE, <span style="font-weight: bold; text-decoration: underline;">null</span>);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">synchronous = full</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">synchronous = off</span>
    db.execSQL(<span style="font-style: italic;">"pragma synchronous=full"</span>);
    <span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">startTime</span>=System.currentTimeMillis();
    <span style="font-weight: bold; text-decoration: underline;">InsertHelper</span> <span style="font-weight: bold; font-style: italic;">helper</span>=<span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">InsertHelper</span>(db, <span style="font-style: italic;">"test"</span>);
    <span style="font-weight: bold; text-decoration: underline;">ContentValues</span> <span style="font-weight: bold; font-style: italic;">values</span>=<span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">ContentValues</span>();
    values.put(<span style="font-style: italic;">"name"</span>, <span style="font-style: italic;">"test"</span>);
    values.put(<span style="font-style: italic;">"count"</span>, 3);
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">commit_time</span>=0;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">exec_time</span>=0;
    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i &lt; 10; i++) {
        <span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">time1</span>=System.currentTimeMillis();
        db.beginTransaction();
        <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">j</span> = 0; j &lt; 10000; j++) {
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">execSQL test</span>
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">db.execSQL("insert into test values (\"test\",2)");</span>

            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">InsertHelper</span>
            helper.insert(values);
        }
        db.setTransactionSuccessful();
        <span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">time2</span>=System.currentTimeMillis();
        db.endTransaction();
        <span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">time3</span>=System.currentTimeMillis();

        exec_time+=(time2-time1);
        commit_time+=(time3-time2);
    }
    <span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">endTime</span>=System.currentTimeMillis();
    Log.e(<span style="font-style: italic;">"sunway"</span>,<span style="font-style: italic;">"done: all_time: "</span>+(endTime-startTime)+<span style="font-style: italic;">"mss avg_exec_time: "</span>+exec_time/10 +<span style="font-style: italic;">"ms "</span>+<span style="font-style: italic;">" avg_commit_time: "</span>+commit_time/10+<span style="font-style: italic;">"ms"</span>);

}


</pre>
</div>

<ul class="org-ul">
<li>c 测试程序</li>
</ul>
<div class="org-src-container">
<pre class="src src-makefile"><span style="font-weight: bold; font-style: italic;">LOCAL_PATH</span>:= $(<span style="font-weight: bold; font-style: italic;">call</span> my-dir)

<span style="font-weight: bold;">include</span> $(<span style="font-weight: bold; font-style: italic;">CLEAR_VARS</span>)

<span style="font-weight: bold; font-style: italic;">LOCAL_SRC_FILES</span>:= test_sqlite.c
<span style="font-weight: bold; font-style: italic;">LOCAL_CFLAGS</span> := -Wno-error-unused-parameter
<span style="font-weight: bold; font-style: italic;">LOCAL_MODULE</span>:= test_sqlite
<span style="font-weight: bold; font-style: italic;">LOCAL_MULTILIB</span> := 32

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">LOCAL_LDFLAGS := ...</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">LOCAL_C_INCLUDES := ...</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">LOCAL_STATIC_LIBRARIES := ...</span>
<span style="font-weight: bold; font-style: italic;">LOCAL_SHARED_LIBRARIES</span> := libsqlite

<span style="font-weight: bold;">include</span> $(<span style="font-weight: bold; font-style: italic;">BUILD_EXECUTABLE</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">"sqlite3.h"</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;pthread.h&gt;</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;string.h&gt;</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">insert</span>(<span style="font-weight: bold; text-decoration: underline;">sqlite3</span> * <span style="font-weight: bold; font-style: italic;">db</span>) {
    <span style="font-weight: bold; text-decoration: underline;">char</span> * <span style="font-weight: bold; font-style: italic;">zerr</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">rc</span>=0;
    rc=sqlite3_exec(db,<span style="font-style: italic;">"pragma synchronous=full;"</span>,0,0,&amp;zerr);

    <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">timeval</span> <span style="font-weight: bold; font-style: italic;">tv</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">begin</span>=0;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">end</span>=0;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">exec_time</span>=0;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">commit_time</span>=0;

    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">j</span>=0;

    gettimeofday(&amp;tv,<span style="font-weight: bold; text-decoration: underline;">NULL</span>);
    begin=tv.tv_sec*1000+tv.tv_usec/1000;

    <span style="font-weight: bold;">for</span> (j=0; j&lt;10; j++) {
        gettimeofday(&amp;tv,<span style="font-weight: bold; text-decoration: underline;">NULL</span>);
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">time1</span>=tv.tv_sec*1000+tv.tv_usec/1000;

        rc=sqlite3_exec(db,<span style="font-style: italic;">"begin transaction"</span>,0,0,&amp;zerr);
        <span style="font-weight: bold; text-decoration: underline;">char</span> * <span style="font-weight: bold; font-style: italic;">sql</span>=<span style="font-style: italic;">"insert into test values (?1, ?2)"</span>;
        <span style="font-weight: bold; text-decoration: underline;">sqlite3_stmt</span> *<span style="font-weight: bold; font-style: italic;">stmt</span>;
        <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span> * <span style="font-weight: bold; font-style: italic;">tail</span>;
        rc=sqlite3_prepare_v2(db, sql, strlen(sql), &amp;stmt,&amp;tail);
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">i</span>=0;
        <span style="font-weight: bold;">for</span> (i = 0; i &lt; 10000; ++i) {
            sqlite3_bind_text(stmt, 1, <span style="font-style: italic;">"test"</span>, strlen(<span style="font-style: italic;">"text"</span>), SQLITE_TRANSIENT);
            sqlite3_bind_int(stmt, 2,1);
            sqlite3_step(stmt);
            sqlite3_reset(stmt);
        }
        gettimeofday(&amp;tv,<span style="font-weight: bold; text-decoration: underline;">NULL</span>);
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">time2</span>=tv.tv_sec*1000+tv.tv_usec/1000;

        rc=sqlite3_exec(db,<span style="font-style: italic;">"end transaction"</span>,0,0,&amp;zerr);

        gettimeofday(&amp;tv,<span style="font-weight: bold; text-decoration: underline;">NULL</span>);
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">time3</span>=tv.tv_sec*1000+tv.tv_usec/1000;
        sqlite3_finalize(stmt);
        exec_time+=(time2-time1);
        commit_time+=(time3-time2);
    }
    gettimeofday(&amp;tv,<span style="font-weight: bold; text-decoration: underline;">NULL</span>);
    end=tv.tv_sec*1000+tv.tv_usec/1000;

    printf(<span style="font-style: italic;">"done: total_time: %d ms, avg_exec_time: %d ms, avg_commit_time: %d ms\n"</span>, end-begin, exec_time/10, commit_time/10);
}


<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> *<span style="font-weight: bold; font-style: italic;">argv</span>[]) {
    <span style="font-weight: bold; text-decoration: underline;">sqlite3</span> *<span style="font-weight: bold; font-style: italic;">db</span>;
    sqlite3_open_v2(<span style="font-style: italic;">"/data/test.db"</span>, &amp;db, SQLITE_OPEN_READWRITE, 0);

    <span style="font-weight: bold; text-decoration: underline;">pthread_t</span> <span style="font-weight: bold; font-style: italic;">tid</span>;
    pthread_create(&amp;tid, <span style="font-weight: bold; text-decoration: underline;">NULL</span>, insert, db);
    pthread_join(tid, <span style="font-weight: bold; text-decoration: underline;">NULL</span>);

    <span style="font-weight: bold;">return</span> 0;
}

</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">synchronous</th>
<th scope="col" class="org-left">storage</th>
<th scope="col" class="org-left">method</th>
<th scope="col" class="org-right">total_time (ms)</th>
<th scope="col" class="org-right">avg_exec_time (ms)</th>
<th scope="col" class="org-right">avg_commit_time (ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">off</td>
<td class="org-left">sd</td>
<td class="org-left">c</td>
<td class="org-right">2002</td>
<td class="org-right">172</td>
<td class="org-right">27</td>
</tr>

<tr>
<td class="org-left">off</td>
<td class="org-left">mtd</td>
<td class="org-left">c</td>
<td class="org-right">1888</td>
<td class="org-right">163</td>
<td class="org-right">25</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">full</td>
<td class="org-left">sd</td>
<td class="org-left">c</td>
<td class="org-right">3641</td>
<td class="org-right">165</td>
<td class="org-right">198</td>
</tr>

<tr>
<td class="org-left">full</td>
<td class="org-left">mtd</td>
<td class="org-left">c</td>
<td class="org-right">1913</td>
<td class="org-right">158</td>
<td class="org-right">31</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">full</td>
<td class="org-left">ssd</td>
<td class="org-left">c</td>
<td class="org-right">450</td>
<td class="org-right">19</td>
<td class="org-right">25</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">off</td>
<td class="org-left">sd</td>
<td class="org-left">java/execSQL</td>
<td class="org-right">12996</td>
<td class="org-right">1269</td>
<td class="org-right">29</td>
</tr>

<tr>
<td class="org-left">off</td>
<td class="org-left">sd</td>
<td class="org-left">java/insertHelper</td>
<td class="org-right">10458</td>
<td class="org-right">1029</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-left">off</td>
<td class="org-left">mtd</td>
<td class="org-left">java/insertHelper</td>
<td class="org-right">10067</td>
<td class="org-right">977</td>
<td class="org-right">29</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">full</td>
<td class="org-left">sd</td>
<td class="org-left">java/execSQL</td>
<td class="org-right">15385</td>
<td class="org-right">1252</td>
<td class="org-right">285</td>
</tr>

<tr>
<td class="org-left">full</td>
<td class="org-left">sd</td>
<td class="org-left">java/insertHelper</td>
<td class="org-right">11874</td>
<td class="org-right">987</td>
<td class="org-right">199</td>
</tr>

<tr>
<td class="org-left">full</td>
<td class="org-left">mtd</td>
<td class="org-left">java/insertHelper</td>
<td class="org-right">9948</td>
<td class="org-right">963</td>
<td class="org-right">31</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>总结
<ul class="org-ul">
<li>使用 java  api 测试时, 执行 sql 语句的速度
比 c 程序慢 7 倍左右</li>
<li>insertHelper 比普通的 execSQL 有 20% 的提升</li>
<li>java api 和 c api 在 commit 时间上没有差别</li>
<li>在 sd 卡上, synchronous off 有近 10 倍的性能提长</li>
<li>在 mtd 上, synchronous 似乎没有差别.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: <br />
Last updated: 2022-01-14 Fri 12:04</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
