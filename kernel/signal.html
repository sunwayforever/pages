<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-19 三 13:26 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux Kernel: Signal</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux Kernel: Signal</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7906409">1. Linux Kernel: Signal</a>
<ul>
<li><a href="#org9326e21">1.1. Overview</a></li>
<li><a href="#orgc8ca494">1.2. 数据结构</a></li>
<li><a href="#orga02385e">1.3. 信号产生</a>
<ul>
<li><a href="#orgab5c638">1.3.1. 给单个线程发送信号</a></li>
<li><a href="#org7f14896">1.3.2. 给线程组发送信号</a></li>
<li><a href="#orgc886531">1.3.3. 举例</a></li>
</ul>
</li>
<li><a href="#org02121e1">1.4. 信号传递</a>
<ul>
<li><a href="#orgfc1a04f">1.4.1. do_signal</a></li>
</ul>
</li>
<li><a href="#orgc813597">1.5. 相关的系统调用</a>
<ul>
<li><a href="#orgddb77b1">1.5.1. kill, tkill, tgkill</a></li>
<li><a href="#orgcf2d51f">1.5.2. signal, sigaction</a></li>
<li><a href="#orgfe58264">1.5.3. sigsuspend</a></li>
<li><a href="#org805674f">1.5.4. sigpending</a></li>
<li><a href="#org25ee26b">1.5.5. sigprocmask</a></li>
</ul>
</li>
<li><a href="#org5cab8e8">1.6. Appendix</a>
<ul>
<li><a href="#orgc0b3650">1.6.1. 系统调用的中断与重启</a></li>
<li><a href="#orgcd42986">1.6.2. 信号与 longjmp</a></li>
<li><a href="#orge04434a">1.6.3. 信号与线程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org7906409" class="outline-2">
<h2 id="org7906409"><span class="section-number-2">1</span> Linux Kernel: Signal</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9326e21" class="outline-3">
<h3 id="org9326e21"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
信号 (signal) 是一个很短的消息, 发送者可以是 kernel 本身或某个进程, 接收者可以是单个进程或一组进程(线程), 通常这个消息只会包含一个数字来标识具体是哪个信号, 但新的 sigaction API 可以使 kernel 在消息中保存更多的更多的内容, 例如发送者的 pid, uid 等.
</p>

<p>
传统的信号一个 31 个, 后来 POSIX 又引入了 real-time signal 的概念,
real-time signal 使用的信号范围是 32 .. 64, 所以信号的总数不超过 64 个.
</p>

<p>
task_struct 中针对每个信号都有一个处理函数 (sa_handler)), 用户可以通过
signal 或 sigaction 来设置这个 sa_handler. sa_handler 可以是一段用户空间的代码, 也可以是一些特殊值表示特殊的处理:
</p>

<ol class="org-ol">
<li>SIG_DFL 表示处理这个信号采用 kernel 默认的处理函数</li>

<li>SIG_IGN 表示忽略这个信号, 不做任何处理</li>
</ol>

<p>
用户进程 A 可以通过 kill, tkill, tgkill 三个系统调用向另一个进程 B "发送" 一个特定的信号, 这个过程称为 signal generating, 其中:
</p>

<ol class="org-ol">
<li>tkill 是仅仅向某个线程发送信号, 和线程所在的线程组 (thread group)
中的某它线程无关</li>

<li>tgkill 功能和 tkill 是一样的&#x2026;只不过它会在 tkill 基础上做一些检查</li>

<li>kill 是向整个 thread group 发送信号, kernel 负责从 thread group 中选择某个 thread 来响应这个信号, 另外, 如果这个信号是 fatal 的, 则
kernel 还会向 thread group 的所有线程发送 SIG_KILL 使得整个 thread
group 都结束执行</li>
</ol>

<p>
B 进程事先可以通过 sigprocmask 将特定信息标记为 BLOCKED, A 进程发送过来的信号会被记入 B 进程的 pending signal 列表中, 当 B 后面再次通过
sigprocmask 解除对这个信号的 block 时, B 会立即收到这个信号. 这一点与
SIG_IGN 是不同的: 如果某个信号的处理函数通过 sigal 或 sigaction 设置为
SIG_IGN, 则这个信号并不会进入 pending signal 列表中: 它会被直接丢弃
</p>

<p>
A 发送信号给 B 只是将信号记在 B 的 pending signal 中, B 真正响应这个信号的时机是从 kernel mode 返回 user mode 时, 参考 <a href="interrupt.html#org3ca88d3">ret_from_intr</a> 中关于
work_pending 的描述. B 响应信号的过程称为 signal delivering
</p>

<p>
当 B 事先注册的 sa_handler 被调用时, 因为 sa_handler 是一段用户空间的代码, 而 ret_from_intr 时还在 kernel mode, 所以 kernel 需要一种手段能在 kernel mode 调用 user mode 的代码
</p>
</div>
</div>


<div id="outline-container-orgc8ca494" class="outline-3">
<h3 id="orgc8ca494"><span class="section-number-3">1.2</span> 数据结构</h3>
<div class="outline-text-3" id="text-1-2">

<div id="org5a8bb19" class="figure">
<p><img src="../extra/kernel_signal.png" alt="kernel_signal.png" />
</p>
</div>

<ol class="org-ol">
<li>p-&gt;pending 类型为 sigpending, 其中的 pending-&gt;signal 是一个 64 big
的 mask, 标识有哪个 pending 的信号. pending-&gt;list 是一个 sigqueue
的链表, sigqueue 描述了每一个 pending 的信号的具体信息</li>

<li>p-&gt;signal 中的许多信息和 signal 的处理关系并不紧密, 例如
signal-&gt;rlim 是进程的 rlimit 信息, rlimit 中的大部分信息和信号没有一点关系. p-&gt;signal-&gt;share_pending 和 p-&gt;pending 类似, 如果一个信号是发给整个 thread group 的, 则需要使用 share_pending 做一些记录</li>

<li>p-&gt;sighand 是针对每个信号的 sa_handler 信息, signal 和 sigaction 系统调用会直接修改它的内容.</li>
</ol>
</div>
</div>

<div id="outline-container-orga02385e" class="outline-3">
<h3 id="orga02385e"><span class="section-number-3">1.3</span> 信号产生</h3>
<div class="outline-text-3" id="text-1-3">
<p>
根据信号的来源 (进程通过 kill 发起或 kernel 本身发起的), kernel 通过许多函数来发送信号 (signal generating):
</p>

<ol class="org-ol">
<li>发送给单个线程

<ul class="org-ul">
<li>sys_tkill</li>

<li>sys_tgkill</li>

<li>send_sig{_info}</li>

<li>force_sig{_info}</li>
</ul></li>

<li>发送给整个线程组

<ul class="org-ul">
<li>send_group_sig_info</li>

<li>kill_pg{_info}</li>

<li>kill_proc{_info}</li>

<li>sys_kill</li>
</ul></li>
</ol>

<p>
不论上面提到的哪个函数, 最终都会调用到 specific_send_sig_info 或
group_send_sig_info
</p>
</div>

<div id="outline-container-orgab5c638" class="outline-4">
<h4 id="orgab5c638"><span class="section-number-4">1.3.1</span> 给单个线程发送信号</h4>
<div class="outline-text-4" id="text-1-3-1">
</div>
<div id="outline-container-orgeb2ba10" class="outline-5">
<h5 id="orgeb2ba10"><span class="section-number-5">1.3.1.1</span> specific_send_sig_info</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">specific_send_sig_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">t</span><span style="color: #757575;">)</span>:
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_ignored<span style="color: #757575;">(</span>t<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
        <span style="color: #586e75;">// </span><span style="color: #586e75;">task_struct-&gt;block &#26159;&#19968;&#20010; 64 bit &#30340; mask, &#26631;&#35782;&#21738;&#20123; sig &#34987;</span>
        <span style="color: #586e75;">// </span><span style="color: #586e75;">block. &#34987; block &#30340; sig &#19981;&#33021;&#34987; ignore, &#22240;&#20026;&#23427;&#20204;&#38656;&#35201;&#34987;&#25918;&#22312; pending</span>
        <span style="color: #586e75;">// </span><span style="color: #586e75;">signal &#20013;&#20197;&#20415; unblock &#26102;&#36827;&#31243;&#33021;&#20877;&#27425;&#25910;&#21040;&#36825;&#20010; sig</span>
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sigismember<span style="color: #757575;">(</span>&amp;t-&gt;blocked<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
          <span style="color: #859900;">return</span> 0;
        <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; t-&gt;sighand &#20013; sig &#23545;&#24212;&#30340; handler &#20026; SIG_IGN &#25110; handler &#20026;</span>
        <span style="color: #586e75;">// </span><span style="color: #586e75;">SIG_DFL &#20294; sig &#30340;&#40664;&#35748; handler &#20063;&#20026; ignore, &#21017;&#24573;&#30053;&#36825;&#20010; sig</span>
        handler = t-&gt;sighand-&gt;action[sig-1].sa.sa_handler;
        <span style="color: #859900;">return</span>   handler == SIG_IGN || <span style="color: #757575;">(</span>handler == SIG_DFL &amp;&amp; sig_kernel_ignore<span style="color: #757575;">(</span>sig<span style="color: #757575;">))</span>;
    <span style="color: #859900;">goto</span> <span style="color: #268bd2; font-weight: bold;">out</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#27809;&#26377; ignore &#30340; sig &#26368;&#32456;&#38656;&#22312;&#25918;&#22312; t-&gt;pending &#20013;, sigpending-&gt;signal &#26159;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19968;&#20010; bitmask, &#26631;&#35782; pending &#21015;&#34920;&#20013;&#26159;&#21542;&#24050;&#32463;&#23384;&#22312;&#30456;&#21516; sig &#30340; signal.</span>
  <span style="color: #586e75;">//</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23545;&#20110;&#26222;&#36890;&#30340; (&#38750; real time) &#30340; signal, &#23545;&#20110;&#21516;&#19968;&#20010; sig, pending &#21015;&#34920;&#20013;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26368;&#22810;&#21482;&#20250;&#20445;&#23384;&#19968;&#20010;&#23545;&#24212;&#30340; signal, &#21363;&#22810;&#20010;&#26222;&#36890; signal &#19981;&#20250;&#32047;&#31215;&#22312; pending</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20013;.</span>
  <span style="color: #586e75;">//</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20294;&#23545;&#20110; real time signal, &#22810;&#20010; real time signal &#26159;&#21487;&#20197;&#22312; pending &#20013;&#32047;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#31215;&#30340;</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>LEGACY_QUEUE<span style="color: #757575;">(</span>&amp;t-&gt;pending<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
        <span style="color: #757575;">(((</span>sig<span style="color: #757575;">)</span> &lt; SIGRTMIN<span style="color: #757575;">)</span> &amp;&amp; sigismember<span style="color: #757575;">(</span>&amp;<span style="color: #757575;">(</span>pending<span style="color: #757575;">)</span>-&gt;signal<span style="color: #757575;">,</span> <span style="color: #757575;">(</span>sig<span style="color: #757575;">)))</span>
    <span style="color: #859900;">goto</span> <span style="color: #268bd2; font-weight: bold;">out</span>;

  <span style="color: #268bd2;">send_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">t</span><span style="color: #757575;">,</span> &amp;t-&gt;pending<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22914;&#26524; sig &#27809;&#26377; block, &#21017;&#21796;&#37266;&#36827;&#31243;&#20197;&#20415;&#23427;&#33021;&#21450;&#26102;&#21709;&#24212;&#36825;&#20010; signal</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>ret &amp;&amp; <span style="color: #b58900; font-weight: bold;">!</span>sigismember<span style="color: #757575;">(</span>&amp;t-&gt;blocked<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
    signal_wake_up<span style="color: #757575;">(</span>t<span style="color: #757575;">,</span> sig == SIGKILL<span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#35774;&#32622; TIF_SIGPENDING, &#20197;&#20415; ret_from_intr &#26102;&#33021;&#21457;&#29616;&#26377; pending signal</span>
      <span style="color: #268bd2;">set_tsk_thread_flag</span><span style="color: #757575;">(</span><span style="color: #b58900;">t</span><span style="color: #757575;">,</span> <span style="color: #b58900;">TIF_SIGPENDING</span><span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#27491;&#24120;&#24773;&#20917;&#19979;&#21482;&#26377;&#22788;&#20110; TASK_INTERRUPTIBLE &#29366;&#24577;&#30340;&#36827;&#31243;&#25165;&#20250;&#34987;&#21796;&#37266;, &#20294;&#33509;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">sig &#20026; SIG_KILL, &#21017; TASK_STOPPED &#29366;&#24577;&#21644; TASK_TRACED &#29366;&#24577;&#30340;&#36827;&#31243;&#20063;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20250;&#34987;&#21796;&#37266;.</span>
      <span style="color: #586e75;">//</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25152;&#20197;&#27491;&#22312; sleep &#25110;&#38459;&#22622;&#22312; read &#19978;&#30340;&#36827;&#31243;&#20250;&#34987;&#21796;&#37266;, &#36825;&#20063;&#26159; signal &#23548;&#33268;&#31995;&#32479;&#35843;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#29992;&#25552;&#21069;&#36820;&#22238;&#30340;&#21407;&#22240;. &#21478;&#22806;, &#22788;&#20110; D &#29366;&#24577; (TASK_UNINTERRUPTIBLE) &#30340;&#36827;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#31243;&#19981;&#20250;&#34987;&#21796;&#37266;, &#25152;&#20197; D &#29366;&#24577;&#30340;&#36827;&#31243;&#26080;&#27861;&#21450;&#26102;&#21709;&#24212; signal</span>
      mask = TASK_INTERRUPTIBLE;
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>resume<span style="color: #757575;">)</span>:
        mask |= TASK_STOPPED | TASK_TRACED;
      <span style="color: #268bd2;">wake_up_state</span><span style="color: #757575;">(</span><span style="color: #b58900;">t</span><span style="color: #757575;">,</span> <span style="color: #b58900;">mask</span><span style="color: #757575;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga9dd128" class="outline-5">
<h5 id="orga9dd128"><span class="section-number-5">1.3.1.2</span> send_signal</h5>
<div class="outline-text-5" id="text-1-3-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">send_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">t</span><span style="color: #757575;">,</span> <span style="color: #b58900;">pending</span><span style="color: #757575;">)</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20998;&#37197;&#19968;&#20010; sigqueue, &#21518;&#38754;&#38656;&#35201;&#23558;&#23427;&#25554;&#20837; pending &#38142;&#34920;&#20013;</span>
  q = __sigqueue_alloc<span style="color: #757575;">(</span>t<span style="color: #757575;">,</span> GFP_ATOMIC<span style="color: #757575;">)</span>;
  list_add_tail<span style="color: #757575;">(</span>&amp;q-&gt;list<span style="color: #757575;">,</span> &amp;signals-&gt;list<span style="color: #757575;">)</span>;
  <span style="color: #859900;">switch</span> <span style="color: #757575;">((</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> info<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">send_signal &#26102;&#20256;&#20837;&#30340; info (siginfo) &#19968;&#33324;&#26159;&#30001;&#19978;&#23618;&#22635;&#20805;&#30340;, &#21253;&#21547;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">signo, errno, code, pid, uid, addr &#31561;&#25968;&#25454;. &#28982;&#21518; send_signal &#26102;&#36890;&#36807;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">copy_siginfo &#23558; info &#22797;&#21046;&#21040; q-&gt;info &#20013;.</span>
    <span style="color: #586e75;">//</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20294;&#26377;&#26102; kernel &#26377;&#26102;&#20250;&#36890;&#36807; force_sig, send_sig &#21457;&#36865;&#19968;&#20123;&#20449;&#21495;, &#32780;&#19988;&#36825;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20123;&#20449;&#21495;&#24182;&#19981;&#38656;&#35201;&#36890;&#36807; siginfo &#20256;&#36882;&#22823;&#37096;&#20998;&#20449;&#24687;, &#20026;&#20102;&#36991;&#20813; copy_siginfo,</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">kernel &#20351;&#29992;&#29305;&#23450;&#30340; 0, 1 &#20570;&#20026; info &#24182;&#22312;&#36825;&#37324;&#36827;&#34892;&#29305;&#27530;&#30340;&#22788;&#29702;.</span>
    <span style="color: #859900;">case</span> 0:
      q-&gt;info.si_signo = sig;
      q-&gt;info.si_errno = 0;
      q-&gt;info.si_code = SI_USER;
      q-&gt;info.si_pid = current-&gt;pid;
      q-&gt;info.si_uid = current-&gt;uid;
      <span style="color: #859900;">break</span>;
    <span style="color: #859900;">case</span> 1:
      q-&gt;info.si_signo = sig;
      q-&gt;info.si_errno = 0;
      q-&gt;info.si_code = SI_KERNEL;
      q-&gt;info.si_pid = 0;
      q-&gt;info.si_uid = 0;
      <span style="color: #859900;">break</span>;
    <span style="color: #859900;">default</span>:
      copy_siginfo<span style="color: #757575;">(</span>&amp;q-&gt;info<span style="color: #757575;">,</span> info<span style="color: #757575;">)</span>;
      <span style="color: #859900;">break</span>;

    sigaddset<span style="color: #757575;">(</span>&amp;pending-&gt;signal<span style="color: #757575;">,</span> sig<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f14896" class="outline-4">
<h4 id="org7f14896"><span class="section-number-4">1.3.2</span> 给线程组发送信号</h4>
<div class="outline-text-4" id="text-1-3-2">
</div>
<div id="outline-container-orga479a2f" class="outline-5">
<h5 id="orga479a2f"><span class="section-number-5">1.3.2.1</span> group_send_sig_info</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">group_send_sig_info</span>:
  <span style="color: #268bd2;">__group_send_sig_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21516;&#19968;&#20010; thread group &#30340; t-&gt;signal &#21644; t-&gt;sighand &#26159;&#20849;&#20139;&#30340; (t-&gt;blocked</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21644; t-&gt;pending &#26159;&#21333;&#29420;&#30340;), &#25152;&#20197; sig_ignored &#23545; p &#25110;&#32773; p &#36825;&#20010;&#32447;&#31243;&#32452;&#20013;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30340;&#25152;&#26377;&#32447;&#31243;&#37117;&#20250;&#36820;&#22238;&#30456;&#21516;&#30340;&#32467;&#26524;    </span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_ignored<span style="color: #757575;">(</span>p<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
      <span style="color: #859900;">return</span> ret;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sig &#23558;&#34987;&#21152;&#20837; p-&gt;shared_pending &#32780;&#19981;&#26159; t-&gt;pending    </span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>LEGACY_QUEUE<span style="color: #757575;">(</span>&amp;p-&gt;signal-&gt;shared_pending<span style="color: #757575;">,</span> sig<span style="color: #757575;">))</span>:
      <span style="color: #859900;">return</span> ret;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19982; specific_send_sig_info &#30456;&#21516;, &#21482;&#19981;&#36807;&#26159;&#21152;&#20837;&#21040; p-&gt;shared_pending &#32780;&#19981;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26159; t-&gt;pending    </span>
    <span style="color: #268bd2;">send_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">,</span> &amp;p-&gt;signal-&gt;shared_pending<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23545;&#20110; specific_send_sig_info &#26469;&#35828;, &#36825;&#37324;&#20250;&#36890;&#36807; signal_wake_up &#21796;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#37266; p &#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;. &#20294;&#23545;&#20110; group_send_sig_info &#26469;&#35828;, &#36825;&#37324;&#20250;&#36890;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#36807;__group_complete_signal &#26469;&#36873;&#25321; p &#25152;&#22312;&#30340; thread group &#20013;&#30340;&#26576;&#19968;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20010; "&#21512;&#36866;" &#30340;&#32447;&#31243;&#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;</span>
    <span style="color: #268bd2;">__group_complete_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8827a4e" class="outline-5">
<h5 id="org8827a4e"><span class="section-number-5">1.3.2.2</span> __group_complete_signal</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #586e75;">// </span><span style="color: #586e75;">__group_complete_signal &#30340;&#30446;&#30340;&#26159;&#20174; p &#25152;&#22312;&#30340; thread group &#20013;&#36873;&#25321;&#19968;&#20010;</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#32447;&#31243;&#26469;&#21796;&#37266;, &#20197;&#21709;&#24212;&#20043;&#21069;&#24050;&#32463;&#21152;&#20837;&#21040; p-&gt;shared_pending &#20013;&#30340;&#20449;&#21495;</span>
<span style="color: #268bd2;">__group_complete_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">wants_signal &#29992;&#26469;&#26816;&#26597; thread p &#26159;&#21542; "&#24212;&#35813;" &#21709;&#24212; sig, &#21709;&#24212; sig &#30340;&#26465;&#20214;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20026;:</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">1. sig &#27809;&#26377;&#34987; p block</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">2. p-&gt;state &#19981;&#26159; mask &#25152;&#25351;&#23450;&#30340; state</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">3. p &#27491;&#21344;&#29992;&#30528; cpu &#25110; p &#27809;&#26377;&#20219;&#20309; pending &#20449;&#21495; (p-&gt;pending &#21450;</span>
  <span style="color: #586e75;">//    </span><span style="color: #586e75;">p-&gt;shared_pending &#20026;&#31354;)  </span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>wants_signal<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> p<span style="color: #757575;">,</span> mask<span style="color: #757575;">))</span>:
<span style="color: #268bd2;">        #define</span> <span style="color: #268bd2;">wants_signal</span><span style="color: #757575;">(</span><span style="color: #268bd2;">sig</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">p</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">mask</span><span style="color: #757575;">)</span>                      \
          <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>sigismember<span style="color: #757575;">(</span>&amp;<span style="color: #757575;">(</span>p<span style="color: #757575;">)</span>-&gt;blocked<span style="color: #757575;">,</span> sig<span style="color: #757575;">)</span>      \
           &amp;&amp; <span style="color: #b58900; font-weight: bold;">!</span><span style="color: #757575;">((</span>p<span style="color: #757575;">)</span>-&gt;state &amp; mask<span style="color: #757575;">)</span>           \
           &amp;&amp; <span style="color: #b58900; font-weight: bold;">!</span><span style="color: #757575;">((</span>p<span style="color: #757575;">)</span>-&gt;flags &amp; PF_EXITING<span style="color: #757575;">)</span>                 \
           &amp;&amp; <span style="color: #757575;">(</span>task_curr<span style="color: #757575;">(</span>p<span style="color: #757575;">)</span> || <span style="color: #b58900; font-weight: bold;">!</span>signal_pending<span style="color: #757575;">(</span>p<span style="color: #757575;">)))</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20248;&#20808;&#36873;&#25321; kill syscall &#26368;&#21021;&#25351;&#23450;&#30340;&#32447;&#31243;&#26469;&#21709;&#24212;&#20449;&#21495;    </span>
    t = p;
  <span style="color: #859900;">else</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20174; thread group &#20013;&#36873;&#25321;&#19968;&#20010; wants_signal &#20026;&#30495;&#30340;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">p-&gt;signal-&gt;curr_target &#35760;&#24405;&#20102;&#19978;&#27425;&#21709;&#24212;&#20449;&#21495;&#30340; thread, &#36890;&#36807;&#36825;&#20010;&#21487;&#20197;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22312;&#19968;&#23450;&#31243;&#24230;&#19978;&#23454;&#29616;&#20449;&#21495;&#22788;&#29702;&#30340; load balancing      </span>
    t = p-&gt;signal-&gt;curr_target;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>t == <span style="color: #268bd2; font-weight: bold;">NULL</span><span style="color: #757575;">)</span>:
      t = p-&gt;signal-&gt;curr_target = p;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#36941;&#21382;&#25152;&#26377;&#30340; thread    </span>
    <span style="color: #859900;">while</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>wants_signal<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> t<span style="color: #757575;">,</span> mask<span style="color: #757575;">))</span>:
      t = next_thread<span style="color: #757575;">(</span>t<span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#27809;&#26377;&#20219;&#20309;&#19968;&#20010; thread wants_signal, &#37027;&#36825;&#37324;&#26080;&#27861;&#21796;&#37266;&#20219;&#20309;&#32447;&#31243;: &#21482;&#33021;&#31561;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30528;&#26576;&#20010;&#32447;&#31243; "&#33258;&#28982;" &#21796;&#37266;&#21518;&#26469;&#22788;&#29702;&#36825;&#20010;&#20449;&#21495;&#20102;      </span>
      <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>t == p-&gt;signal-&gt;curr_target<span style="color: #757575;">)</span>
        <span style="color: #859900;">return</span>;
    p-&gt;signal-&gt;curr_target = t;

  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_fatal<span style="color: #757575;">(</span>p<span style="color: #757575;">,</span> sig<span style="color: #757575;">)</span> ....<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22914;&#26524;&#26159; fatal &#20449;&#21495;, &#30452;&#25509; kill &#25481; thread group &#20013;&#25152;&#26377;&#32447;&#31243;, &#36825;&#19968;&#28857;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19982; get_signal_to_deliver &#37324;&#30340;&#36923;&#36753;&#24046;&#19981;&#22810;      </span>
    ...
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26368;&#21518;, &#21796;&#37266; t &#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;      </span>
  signal_wake_up<span style="color: #757575;">(</span>t<span style="color: #757575;">,</span> sig == SIGKILL<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc886531" class="outline-4">
<h4 id="orgc886531"><span class="section-number-4">1.3.3</span> 举例</h4>
<div class="outline-text-4" id="text-1-3-3">
</div>
<div id="outline-container-org7f1db28" class="outline-5">
<h5 id="org7f1db28"><span class="section-number-5">1.3.3.1</span> 应用发起的 kill</h5>
<div class="outline-text-5" id="text-1-3-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">sys_kill</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">pid</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">sig</span><span style="color: #757575;">)</span>:
  <span style="color: #859900;">struct</span> siginfo info;

  info.si_signo = sig;
  info.si_errno = 0;
  info.si_code = SI_USER;
  info.si_pid = current-&gt;tgid;
  info.si_uid = current-&gt;uid;

  <span style="color: #268bd2;">kill_something_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> &amp;info<span style="color: #757575;">,</span> <span style="color: #b58900;">pid</span><span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; pid &#20026; 0, &#21017;&#34920;&#31034;&#35201;&#32473;&#24403;&#21069;&#36827;&#31243;&#25152;&#22312;&#36827;&#31243;&#32452;&#30340;&#25152;&#26377;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;. &#20851;&#20110;&#36827;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#31243;&#32452;, &#21442;&#32771; [[file:process.org::*Processes%20Relationship][Processes Relationship]]  </span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>pid<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> kill_pg_info<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> info<span style="color: #757575;">,</span> process_group<span style="color: #757575;">(</span>current<span style="color: #757575;">))</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">pg &#26159;&#25351; process group, &#21363;&#36827;&#31243;&#32452;</span>
      <span style="color: #268bd2;">do_each_task_pid</span><span style="color: #757575;">(</span><span style="color: #b58900;">pgrp</span><span style="color: #757575;">,</span> <span style="color: #b58900;">PIDTYPE_PGID</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        group_send_sig_info<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> info<span style="color: #757575;">,</span> p<span style="color: #757575;">)</span>;
      <span style="color: #757575;">}</span> <span style="color: #268bd2;">while_each_task_pid</span><span style="color: #757575;">(</span><span style="color: #b58900;">pgrp</span><span style="color: #757575;">,</span> <span style="color: #b58900;">PIDTYPE_PGID</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; pid &#20026;&#36127;&#25968;, &#21017;&#32473; -pid &#25152;&#25351;&#31034;&#30340;&#36827;&#31243;&#32452;&#30340;&#27599;&#20010;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;  </span>
  <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>pid &lt; 0<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> kill_pg_info<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> info<span style="color: #757575;">,</span> -pid<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#32473; pid &#25351;&#31034;&#30340;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;      </span>
  <span style="color: #859900;">else</span>:
    <span style="color: #859900;">return</span> kill_proc_info<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> info<span style="color: #757575;">,</span> pid<span style="color: #757575;">)</span>;
      p = find_task_by_pid<span style="color: #757575;">(</span>pid<span style="color: #757575;">)</span>;
      <span style="color: #268bd2;">group_send_sig_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">p</span><span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org26c2e08" class="outline-5">
<h5 id="org26c2e08"><span class="section-number-5">1.3.3.2</span> page fault 导致的 SIGSEGV</h5>
<div class="outline-text-5" id="text-1-3-3-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">do_page_fault</span>:
  info.si_signo = SIGSEGV;
  info.si_errno = 0;
  info.si_addr = <span style="color: #757575;">(</span><span style="color: #b58900;">void</span> <span style="color: #268bd2;">__user</span> *<span style="color: #757575;">)</span>address;
  <span style="color: #268bd2;">force_sig_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">SIGSEGV</span><span style="color: #757575;">,</span> &amp;info<span style="color: #757575;">,</span> <span style="color: #b58900;">tsk</span><span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; sig &#34987; blocked, &#21017; force_sig_info &#24378;&#21046;&#25226;&#23427; unblock; &#33509;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sa_handler &#34987;&#20462;&#25913;&#20026; SIG_IGN, &#21017; force_sig_info &#20250;&#24378;&#21046;&#25226;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">sa_handler &#21464;&#20026; SIG_DFL...</span>
    <span style="color: #586e75;">// </span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25152;&#20197;&#30475;&#36215;&#26469;&#24212;&#29992;&#25226; sa_handler &#20889;&#25104;&#19968;&#20010;&#31354;&#20989;&#25968;&#21644;&#30452;&#25509;&#35774;&#32622;&#20026; SIG_IGN &#36824;&#26159;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26377;&#20123;&#24046;&#21035;&#30340;          </span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sigismember<span style="color: #757575;">(</span>&amp;t-&gt;blocked<span style="color: #757575;">,</span> sig<span style="color: #757575;">)</span> ||
        t-&gt;sighand-&gt;action[sig-1].sa.sa_handler == SIG_IGN<span style="color: #757575;">)</span>:
      t-&gt;sighand-&gt;action[sig-1].sa.sa_handler = SIG_DFL;
      sigdelset<span style="color: #757575;">(</span>&amp;t-&gt;blocked<span style="color: #757575;">,</span> sig<span style="color: #757575;">)</span>;
      <span style="color: #268bd2;">recalc_sigpending_tsk</span><span style="color: #757575;">(</span><span style="color: #b58900;">t</span><span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">specific_send_sig_info</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">t</span><span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org02121e1" class="outline-3">
<h3 id="org02121e1"><span class="section-number-3">1.4</span> 信号传递</h3>
<div class="outline-text-3" id="text-1-4">
<p>
信号传递 (signal delivering) 是指 pending 信号对应的 sa_handler 真正被执行的过程. 一般情况下, 中断处理的 resume_userspace 会检查是否有需要处理的信号(resume_kernel 并不会做这种检查)
</p>

<p>
resume_userspace 被调用可以分为两种情况:
</p>

<ol class="org-ol">
<li>中断或 syscall 正常完成, 调用 resume_userspace</li>

<li>syscall 阻塞, 但被信号唤醒 (通过 signal_wake_up), 从而调用
resume_userspace</li>
</ol>

<p>
其中后者是 kernel 处理 "syscall 被中断并重启" 问题的关键.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">resume_userspace</span>:
  <span style="color: #b58900;">movl</span> <span style="color: #268bd2;">TI_flags</span><span style="color: #757575;">(</span>%ebp<span style="color: #757575;">),</span> %ecx
  andl $_TIF_WORK_MASK<span style="color: #757575;">,</span> %ecx

  jne work_pending

work_pending:
  testb $_TIF_NEED_RESCHED<span style="color: #757575;">,</span> %cl
  jz work_notifysig

work_notifysig:
  call do_notify_resume
    <span style="color: #586e75;">// </span><span style="color: #586e75;">signal_wake_up &#26102;&#20250;&#32622;&#20301;.</span>
    <span style="color: #586e75;">//</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21478;&#22806;&#26356;&#19968;&#33324;&#30340;&#24773;&#20917;&#19979;, kernel &#27599;&#27425;&#23545; pending &#30340;&#25913;&#21464;&#21518;&#37117;&#20250;&#35843;&#29992;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">recalc_sigpending_tsk &#26681;&#25454; pending-&gt;signal &#26469;&#23545; TIF_SIGPENDING &#32622;&#20301;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25110;&#22797;&#20301;</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>thread_info_flags &amp; _TIF_SIGPENDING<span style="color: #757575;">)</span>:
      do_signal<span style="color: #757575;">(</span>regs<span style="color: #757575;">,</span>oldset<span style="color: #757575;">)</span>;
</pre>
</div>
</div>

<div id="outline-container-orgfc1a04f" class="outline-4">
<h4 id="orgfc1a04f"><span class="section-number-4">1.4.1</span> do_signal</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
do_signal 是信号处理最主要的部分, 它需要完成信号处理中最复杂的部分: 在
kernel space 调用 user space 下的 sa_handler
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">do_signal</span>:
  signr = get_signal_to_deliver<span style="color: #757575;">(</span>&amp;info<span style="color: #757575;">,</span> &amp;ka<span style="color: #757575;">,</span> regs<span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">NULL</span><span style="color: #757575;">)</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>signr &gt; 0<span style="color: #757575;">)</span>:
    handle_signal<span style="color: #757575;">(</span>signr<span style="color: #757575;">,</span> &amp;info<span style="color: #757575;">,</span> &amp;ka<span style="color: #757575;">,</span> oldset<span style="color: #757575;">,</span> regs<span style="color: #757575;">)</span>;
    <span style="color: #859900;">return</span> 1
</pre>
</div>
</div>

<div id="outline-container-orgad6566f" class="outline-5">
<h5 id="orgad6566f"><span class="section-number-5">1.4.1.1</span> get_signal_to_deliver</h5>
<div class="outline-text-5" id="text-1-4-1-1">
<p>
找一个 pending 的 signal, 并交给 handle_signal 去处理. 如果 pending
signal 对应的 handler 是 SIG_DFL, 则执行默认的操作: ignore, coredump
或 exit
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">get_signal_to_deliver</span>:
  <span style="color: #b58900;">sigset_t</span> *<span style="color: #268bd2;">mask</span> = &amp;current-&gt;blocked;
  signr = dequeue_signal<span style="color: #757575;">(</span>current<span style="color: #757575;">,</span> mask<span style="color: #757575;">,</span> info<span style="color: #757575;">)</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">signr</span> = __dequeue_signal<span style="color: #757575;">(</span>&amp;tsk-&gt;pending<span style="color: #757575;">,</span> mask<span style="color: #757575;">,</span> info<span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20174; pending-&gt;signal &#36825;&#20010; bitmask &#25214;&#21040; mask &#20043;&#22806;&#30340;&#31532;&#19968;&#20010; pending</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30340; signr</span>
      sig = next_signal<span style="color: #757575;">(</span>pending<span style="color: #757575;">,</span> mask<span style="color: #757575;">)</span>;
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20174; pending &#21015;&#34920;&#20013;&#25214;&#21040;&#23545;&#24212;&#20110; sig &#30340; siginfo</span>
      <span style="color: #268bd2;">collect_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">pending</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">)</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; pending &#20013;&#27809;&#26377;, &#21017;&#26597;&#25214; shared_pending. group_send_sig_info &#26102;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20250;&#23558;&#20449;&#21495;&#21152;&#20837;&#21040; shared_pending &#20013;      </span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>signr<span style="color: #757575;">)</span>:
      signr = __dequeue_signal<span style="color: #757575;">(</span>&amp;tsk-&gt;signal-&gt;shared_pending<span style="color: #757575;">,</span> mask<span style="color: #757575;">,</span> info<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#27809;&#26377;&#20219;&#20309; pending signal</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>signr<span style="color: #757575;">)</span>:
    <span style="color: #859900;">break</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25214;&#21040;&#19968;&#20010; pending signal</span>
  ka = &amp;current-&gt;sighand-&gt;action[signr-1];
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ka-&gt;sa.sa_handler == SIG_IGN<span style="color: #757575;">)</span>:
    <span style="color: #859900;">continue</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ka-&gt;sa.sa_handler != SIG_DFL<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25214;&#21040;&#19968;&#20010;&#26377; sa_handler &#30340;&#20449;&#21495;, &#36820;&#22238;&#21040;&#19978;&#23618;, &#21518;&#32493;&#20250;&#35843;&#29992; handle_signal</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26469;&#22788;&#29702;&#23427;</span>
    *return_ka = *ka;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ka-&gt;sa.sa_flags &amp; SA_ONESHOT<span style="color: #757575;">)</span>:
      ka-&gt;sa.sa_handler = SIG_DFL;
    <span style="color: #859900;">break</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21069;&#20004;&#20010;&#21028;&#26029;&#37117;&#19981;&#28385;&#36275;, &#36208; SIG_DFL &#30340;&#22788;&#29702;&#36335;&#24452;</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_kernel_ignore<span style="color: #757575;">(</span>signr<span style="color: #757575;">))</span>:
    <span style="color: #859900;">continue</span>;
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>current-&gt;pid == 1<span style="color: #757575;">)</span>:
    <span style="color: #859900;">continue</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sig &#26159; SIGSTOP &#19968;&#31867;&#30340;&#20449;&#21495;</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_kernel_stop<span style="color: #757575;">(</span>signr<span style="color: #757575;">))</span>:
    do_signal_stop<span style="color: #757575;">(</span>signr<span style="color: #757575;">)</span>
    <span style="color: #859900;">continue</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21097;&#19979;&#30340;&#20840;&#26159; fatal &#20449;&#21495;</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>sig_kernel_coredump<span style="color: #757575;">(</span>signr<span style="color: #757575;">))</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#38656;&#35201;&#29983;&#25104; coredump</span>
    do_coredump<span style="color: #757575;">((</span><span style="color: #b58900;">long</span><span style="color: #757575;">)</span>signr<span style="color: #757575;">,</span> signr<span style="color: #757575;">,</span> regs<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23545;&#20110; fatal &#20449;&#21495;, &#19981;&#20165;&#20165;&#26159;&#24403;&#21069;&#32447;&#31243;&#36864;&#20986;, &#32780;&#26159;&#25972;&#20010; thread group &#20013;&#30340;&#25152;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26377;&#32447;&#31243;&#37117;&#20250;&#36864;&#20986;</span>
  <span style="color: #268bd2;">do_group_exit</span><span style="color: #757575;">(</span><span style="color: #b58900;">signr</span><span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">zap_other_threads</span><span style="color: #757575;">(</span><span style="color: #b58900;">current</span><span style="color: #757575;">)</span>;
      <span style="color: #859900;">for</span> <span style="color: #757575;">(</span>t = next_thread<span style="color: #757575;">(</span>p<span style="color: #757575;">)</span>; t != p; t = next_thread<span style="color: #757575;">(</span>t<span style="color: #757575;">))</span>:
        <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30456;&#24403;&#20110;&#32473;&#20854;&#23427;&#27599;&#20010;&#23376;&#32447;&#31243;&#37117;&#21457;&#36865;&#19968;&#20010; SIGKILL</span>
        sigaddset<span style="color: #757575;">(</span>&amp;t-&gt;pending.signal<span style="color: #757575;">,</span> SIGKILL<span style="color: #757575;">)</span>;
        <span style="color: #268bd2;">rm_from_queue</span><span style="color: #757575;">(</span><span style="color: #b58900;">SIG_KERNEL_STOP_MASK</span><span style="color: #757575;">,</span> &amp;t-&gt;pending<span style="color: #757575;">)</span>;
        <span style="color: #268bd2;">signal_wake_up</span><span style="color: #757575;">(</span><span style="color: #b58900;">t</span><span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">do_exit &#19981;&#20250;&#36820;&#22238;, &#25152;&#20197;&#21518;&#38754;&#30340; handle_signal &#24182;&#19981;&#20250;&#25191;&#34892;</span>
    <span style="color: #268bd2;">do_exit</span><span style="color: #757575;">(</span><span style="color: #b58900;">exit_code</span><span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgceedb62" class="outline-5">
<h5 id="orgceedb62"><span class="section-number-5">1.4.1.2</span> handle_signal</h5>
<div class="outline-text-5" id="text-1-4-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">handle_signal</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> <span style="color: #b58900;">info</span><span style="color: #757575;">,</span> <span style="color: #b58900;">ka</span><span style="color: #757575;">,</span> ...<span style="color: #757575;">)</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26368;&#21021;&#24212;&#29992;&#36890;&#36807; sigaction &#26102;&#20351;&#29992;&#20102; SA_SIGINFO &#36825;&#20010; flag, &#34920;&#31034;&#19978;&#23618;&#30340;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">handler &#25191;&#34892;&#26102;&#38656;&#35201;&#25343;&#21040; siginfo &#20449;&#24687;, kernel &#38656;&#35201;&#35843;&#29992; sigaction &#26102;&#27880;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20876;&#30340; sa_sigaction &#22238;&#35843;, &#32780;&#19981;&#26159; sa_handler.</span>
  <span style="color: #586e75;">//</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sa_sigaction &#22238;&#35843;&#30340;&#21407;&#22411;&#20026;:</span>
  <span style="color: #586e75;">//</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">void (sa_action *) (int signr, siginfo_t * info, void *)</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>ka-&gt;sa.sa_flags &amp; SA_SIGINFO<span style="color: #757575;">)</span>:
    setup_rt_frame<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> ka<span style="color: #757575;">,</span> info<span style="color: #757575;">,</span> oldset<span style="color: #757575;">,</span> regs<span style="color: #757575;">)</span>;
  <span style="color: #859900;">else</span>:
    setup_frame<span style="color: #757575;">(</span>sig<span style="color: #757575;">,</span> ka<span style="color: #757575;">,</span> oldset<span style="color: #757575;">,</span> regs<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9157817" class="outline-5">
<h5 id="org9157817"><span class="section-number-5">1.4.1.3</span> setup_frame</h5>
<div class="outline-text-5" id="text-1-4-1-3">

<div id="org388d8cc" class="figure">
<p><img src="../extra/kernel_signal_frame.png" alt="kernel_signal_frame.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">setup_frame</span>:
  <span style="color: #859900;">struct</span> <span style="color: #b58900;">sigframe</span> <span style="color: #b58900;">__user</span> *<span style="color: #268bd2;">frame</span>;
  frame = get_sigframe<span style="color: #757575;">(</span>ka<span style="color: #757575;">,</span> regs<span style="color: #757575;">,</span> <span style="color: #859900;">sizeof</span><span style="color: #757575;">(</span>*frame<span style="color: #757575;">))</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22312; user mode stack &#19978;&#21521;&#19979;&#25193;&#23637;&#20986;&#19968;&#22359;&#21306;&#22495;, &#23384;&#25918; sigframe</span>
    esp = regs-&gt;esp;
    <span style="color: #859900;">return</span> <span style="color: #757575;">(</span><span style="color: #b58900;">void</span> <span style="color: #268bd2;">__user</span> *<span style="color: #757575;">)((</span>esp - frame_size<span style="color: #757575;">)</span> &amp; -8ul<span style="color: #757575;">)</span>;

  <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span><span style="color: #b58900;">sig</span><span style="color: #757575;">,</span> &amp;frame-&gt;sig<span style="color: #757575;">)</span>;
  setup_sigcontext<span style="color: #757575;">(</span>&amp;frame-&gt;sc<span style="color: #757575;">,</span> &amp;frame-&gt;fpstate<span style="color: #757575;">,</span> regs<span style="color: #757575;">,</span> set-&gt;sig[0]<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23558; regs &#20013;&#21407;&#22987;&#20869;&#23481;&#20445;&#23384;&#22312; sigframe &#30340; sigcontext &#20013;, &#22240;&#20026;&#21518;&#38754; regs</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20013;&#30340;&#20869;&#23481;&#20250;&#34987;&#26367;&#25442;&#20026; sa_handler &#23545;&#24212;&#30340;&#37096;&#20998;</span>
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;edi<span style="color: #757575;">,</span> &amp;sc-&gt;edi<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;esi<span style="color: #757575;">,</span> &amp;sc-&gt;esi<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;ebp<span style="color: #757575;">,</span> &amp;sc-&gt;ebp<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;esp<span style="color: #757575;">,</span> &amp;sc-&gt;esp<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;ebx<span style="color: #757575;">,</span> &amp;sc-&gt;ebx<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;edx<span style="color: #757575;">,</span> &amp;sc-&gt;edx<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;ecx<span style="color: #757575;">,</span> &amp;sc-&gt;ecx<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;eax<span style="color: #757575;">,</span> &amp;sc-&gt;eax<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;eip<span style="color: #757575;">,</span> &amp;sc-&gt;eip<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;xcs<span style="color: #757575;">,</span> <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">__user</span> *<span style="color: #757575;">)</span>&amp;sc-&gt;cs<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;eflags<span style="color: #757575;">,</span> &amp;sc-&gt;eflags<span style="color: #757575;">)</span>;
    <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span>regs-&gt;esp<span style="color: #757575;">,</span> &amp;sc-&gt;esp_at_signal<span style="color: #757575;">)</span>;

  restorer = &amp;__kernel_sigreturn;
  <span style="color: #268bd2;">__put_user</span><span style="color: #757575;">(</span><span style="color: #b58900;">restorer</span><span style="color: #757575;">,</span> &amp;frame-&gt;pretcode<span style="color: #757575;">)</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#36825;&#37324;&#23545; regs &#37325;&#26032;&#36171;&#20540;, &#24403; do_signal &#36820;&#22238;&#21518; iret &#20250;&#36127;&#36131;&#29992; regs &#24674;&#22797;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">user space &#30340;&#19978;&#19979;&#25991;, &#23548;&#33268; user space &#20250;&#36339;&#36716;&#21040; sa_handler, &#24182;&#19988;&#21442;&#25968;&#20026;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sig, esp &#20026; frame.</span>
  <span style="color: #586e75;">//   </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25152;&#20197;, sa_handler &#22312; user mode &#25191;&#34892;&#26102; stack &#30340;&#24067;&#23616; (&#20174;&#39640;&#21040;&#20302;) &#20026;:</span>
  <span style="color: #586e75;">//   </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">..</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sigcontext</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sig</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span style="color: #586e75;">//   </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22240;&#20026; x86 &#40664;&#35748;&#20351;&#29992;&#26632;&#26469;&#20256;&#36882;&#21442;&#25968;, &#25152;&#20197; sa_handler &#25191;&#34892;&#26102;&#31532;&#19968;&#20010;&#21442;&#25968; signr</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19982;&#26632;&#19978;&#30340; sig &#26159;&#23545;&#24212;&#30340; // &#36825;&#37324;&#23545; regs &#37325;&#26032;&#36171;&#20540;, &#24403; do_signal &#36820;&#22238;&#21518;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">iret &#20250;&#36127;&#36131;&#29992; regs &#24674;&#22797; user space &#30340;&#19978;&#19979;&#25991;, &#23548;&#33268; user space &#20250;&#36339;&#36716;&#21040;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sa_handler, &#24182;&#19988;&#21442;&#25968;&#20026; sig, esp &#20026; frame.</span>
  <span style="color: #586e75;">//   </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25152;&#20197;, &#21442;&#32771; sigframe &#30340;&#23450;&#20041;, sa_handler &#22312; user mode &#25191;&#34892;&#26102; stack &#30340;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#24067;&#23616; (&#20174;&#39640;&#21040;&#20302;) &#20026;:</span>
  <span style="color: #586e75;">// </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">--high  </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">..</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sigcontext</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sig</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">--low</span>
  <span style="color: #586e75;">//     </span>
  regs-&gt;esp = <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> frame;
  regs-&gt;eip = <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> ka-&gt;sa.sa_handler;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">x86 &#40664;&#35748;&#20351;&#29992;&#26632;&#26469;&#20256;&#36882;&#21442;&#25968;, &#36825;&#37324;&#24182;&#19981;&#26126;&#30830;&#35774;&#32622; eax &#30340;&#30446;&#30340;...</span>
  regs-&gt;eax = <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> sig;
  regs-&gt;edx = <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> 0;
  regs-&gt;ecx = <span style="color: #757575;">(</span><span style="color: #b58900;">unsigned</span> <span style="color: #b58900;">long</span><span style="color: #757575;">)</span> 0;
  regs-&gt;xcs = __USER_CS;
</pre>
</div>

<p>
setup_rt_frame 和 setup_frame 基本相同, 只不过它会在栈上额外设置一个
siginfo 的指针.
</p>
</div>
</div>

<div id="outline-container-org3235c0e" class="outline-5">
<h5 id="org3235c0e"><span class="section-number-5">1.4.1.4</span> __kernel_sigreturn</h5>
<div class="outline-text-5" id="text-1-4-1-4">
<p>
sa_handler 执行结束后, 按照 c 默认的调用约定和前面描述的栈布局, 会跳转到 __kernel_sigreturn 函数, __kernel_sigreturn 函数是保存在 vsyscall
page 中的一个函数, 所以应用可以直接访问, 关于 vsyscall page, 参考

</p>

<p>
通过将 vsyscall page dump 到本地并反汇编, 能看到 __kernel_sigreturn 的代码如下:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #268bd2;">pop</span> <span style="color: #859900;">%eax</span>
<span style="color: #268bd2;">mov</span> <span style="color: #859900;">$0x77</span><span style="color: #757575;">,</span><span style="color: #268bd2;">%eax</span>
<span style="color: #268bd2;">int</span> <span style="color: #859900;">$0x80</span>
</pre>
</div>

<p>
可见它会调用 sys_sigreturn 这个系统调用
</p>

<p>
显然 sys_sigreturn 需要完成以下的任务: 从 sigframe-&gt;sc 中恢复旧的 regs
以便 user mode 能返回到被 sa_handler 打断的位置.
</p>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">sys_sigreturn</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20026;&#20160;&#20040;&#26159; regs-&gt;esp - 8?</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26681;&#25454;&#21069;&#38754;&#25551;&#36848;&#30340; sa_handler &#30340;&#26632;&#24067;&#23616;:</span>
  <span style="color: #586e75;">// </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">--high</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sigcontext</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">sig</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">--low</span>
  <span style="color: #586e75;">// </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#24403; sa_handler &#32467;&#26463;&#26102;&#35843;&#29992; ret &#20043;&#21069;, esp &#26159;&#25351;&#21521; __kernel_sigreturn &#30340;,</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20063;&#23601;&#26159; sigframe. ret &#25351;&#20196;&#20250;&#23548;&#33268; esp + 4, &#28982;&#21518; __kernel_sigreturn &#30340;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#31532;&#19968;&#21477;&#26159; pop %eax, &#23548;&#33268; esp &#20877;&#27425; + 4, &#27492;&#21518;&#36890;&#36807; int 0x80 &#36827;&#20837; syscall</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23548;&#33268;&#24403;&#21069;&#30340; esp &#24050;&#32463;&#20559;&#31163; sigframe 8 &#23383;&#33410;, &#25152;&#20197;&#36825;&#37324;&#38656;&#35201; -8 ... &#33267;&#20110;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">__kernel_sigreturn &#20026;&#21861;&#20250; pop %eax &#19981;&#28165;&#26970;...</span>
  <span style="color: #586e75;">// </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#23545;&#24212;&#20110; sys_rt_sigreturn &#30340; __kernel_rt_sigreturn &#24182;&#27809;&#26377;&#36825;&#20010; pop &#25805;</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20316;, &#25152;&#20197; sys_rt_sigreturn &#33719;&#24471; sigframe &#26102;&#21482;&#38656;&#35201; - 4    </span>
  <span style="color: #859900;">struct</span> <span style="color: #b58900;">sigframe</span> <span style="color: #b58900;">__user</span> *<span style="color: #268bd2;">frame</span> = <span style="color: #757575;">(</span><span style="color: #859900;">struct</span> <span style="color: #b58900;">sigframe</span> <span style="color: #b58900;">__user</span> *<span style="color: #757575;">)(</span>regs-&gt;esp - 8<span style="color: #757575;">)</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20351;&#29992; frame-&gt;sc &#24674;&#22797;&#26087;&#30340; regs  </span>
  <span style="color: #268bd2;">restore_sigcontext</span><span style="color: #757575;">(</span><span style="color: #b58900;">regs</span><span style="color: #757575;">,</span> &amp;frame-&gt;sc<span style="color: #757575;">,</span> &amp;eax<span style="color: #757575;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f1eb54" class="outline-5">
<h5 id="org7f1eb54"><span class="section-number-5">1.4.1.5</span> 观察 sigframe</h5>
<div class="outline-text-5" id="text-1-4-1-5">
<p>
测试程序:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">#include</span> <span style="color: #2aa198;">&lt;signal.h&gt;</span>

<span style="color: #b58900;">void</span> * <span style="color: #268bd2;">foo</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">signr</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>

<span style="color: #757575;">}</span>

<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    signal<span style="color: #757575;">(</span>10<span style="color: #757575;">,</span> foo<span style="color: #757575;">)</span>;
    sleep<span style="color: #757575;">(</span>1000<span style="color: #757575;">)</span>;
    <span style="color: #859900;">return</span> 0;
<span style="color: #757575;">}</span>

</pre>
</div>

<p>
使用 gdb 分析的过程:
</p>

<pre class="example" id="org465d989">
$&gt; gcc -O0 -g test.c -m32
$&gt; gdb ./a.out
(gdb) b main
(gdb) b foo
(gdb) r
Starting program: /home/sunway/a.out 

Breakpoint 1, main (argc=1, argv=0xffffc454) at test.c:8
8           signal(10, foo);
(gdb) n
9           sleep(1000);
(gdb) n

# 在这里使用 kill -10 &lt;pid&gt; 给 a.out 发送一个信号, 导致 sleep 系统调用
# 被打断而提前返回, 但这里的 "提前返回" 并不是指此时控制已经返回到
# sleep 之后的代码 (0xf7fd8d49), 因为在返回 sleep 之后的代码前,
# sa_handler 需要先被执行  

Program received signal SIGUSR1, User defined signal 1.
0xf7fd8d49 in __kernel_vsyscall ()

(gdb) n
Single stepping until exit from function __kernel_vsyscall,
which has no line number information.
foo (signr=10) at test.c:3
3       void * foo(int signr) {

(gdb) x /20x $esp
0xffffbd6c:     0xf7fd8d20      0x0000000a      0x00000063      0x00000000
0xffffbd7c:     0x0000002b      0x0000002b      0xffffc368      0xf7fd4240
0xffffbd8c:     0x00000000      0xffffc32c      0xffffc368      0x7fffffff
0xffffbd9c:     0xffffc368      0xfffffffc      0x00000001      0x00000000
0xffffbdac:     0xf7fd8d49      0x00000023      0x00000246      0xffffc32c

# 按照 setup_frame 设定的栈布局:
# 
# 1. 栈顶的 0xf7fd8d20 即是位于 vsyscall page 的 __kernel_sigreturn
# 2. 0x0000000a 是 signr
# 3. 从 0x00000063 开始后面对应的数据是 sigcontext 中的内容, 其中
#    0xffffbdac 处保存的 0xf7fd8d49 对应于 sigcontext-&gt;eip, 它和前面
#    sleep 被提前打断时显示的 eip 是一致的, 都对应于 __kernel_vsyscall

(gdb) disass 0xf7fd8d20
Dump of assembler code for function __kernel_sigreturn:
   0xf7fd8d20 &lt;+0&gt;:     pop    %eax
   0xf7fd8d21 &lt;+1&gt;:     mov    $0x77,%eax
   0xf7fd8d26 &lt;+6&gt;:     int    $0x80
   0xf7fd8d28 &lt;+8&gt;:     nop
End of assembler dump.

(gdb) disass 0xf7fd8d49
Dump of assembler code for function __kernel_vsyscall:
   0xf7fd8d40 &lt;+0&gt;:     push   %ecx
   0xf7fd8d41 &lt;+1&gt;:     push   %edx
   0xf7fd8d42 &lt;+2&gt;:     push   %ebp
   0xf7fd8d43 &lt;+3&gt;:     mov    %esp,%ebp
   0xf7fd8d45 &lt;+5&gt;:     sysenter
   // 这里的 int $0x80 是什么意思? 和
   // [[file:process.org::*sysenter,%20syscall,%20vsyscall][sysenter,
   // syscall, vsyscall]] 中 dump 的 __kernel_vsyscall 不一样...     
   0xf7fd8d47 &lt;+7&gt;:     int    $0x80
   0xf7fd8d49 &lt;+9&gt;:     pop    %ebp
   0xf7fd8d4a &lt;+10&gt;:    pop    %edx
   0xf7fd8d4b &lt;+11&gt;:    pop    %ecx
   0xf7fd8d4c &lt;+12&gt;:    ret    
End of assembler dump.
</pre>
</div>
</div>

<div id="outline-container-orga9f337f" class="outline-5">
<h5 id="orga9f337f"><span class="section-number-5">1.4.1.6</span> sigaltstack</h5>
<div class="outline-text-5" id="text-1-4-1-6">
<p>
一般情况下 sigframe 都是在 user stack, 但由于 user stack 一般较小, 若
user stack 已满怎么办?
</p>

<p>
可以通过 sigaltstack 通知 kernel 在另一块区域上建立 sigframe, 凡是
sa_flags 中包含 SA_ONSTACK 的 signal 都会使用 altstack (alternative
stack)
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc813597" class="outline-3">
<h3 id="orgc813597"><span class="section-number-3">1.5</span> 相关的系统调用</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orgddb77b1" class="outline-4">
<h4 id="orgddb77b1"><span class="section-number-4">1.5.1</span> kill, tkill, tgkill</h4>
</div>

<div id="outline-container-orgcf2d51f" class="outline-4">
<h4 id="orgcf2d51f"><span class="section-number-4">1.5.2</span> signal, sigaction</h4>
</div>

<div id="outline-container-orgfe58264" class="outline-4">
<h4 id="orgfe58264"><span class="section-number-4">1.5.3</span> sigsuspend</h4>
</div>

<div id="outline-container-org805674f" class="outline-4">
<h4 id="org805674f"><span class="section-number-4">1.5.4</span> sigpending</h4>
</div>

<div id="outline-container-org25ee26b" class="outline-4">
<h4 id="org25ee26b"><span class="section-number-4">1.5.5</span> sigprocmask</h4>
</div>
</div>

<div id="outline-container-org5cab8e8" class="outline-3">
<h3 id="org5cab8e8"><span class="section-number-3">1.6</span> Appendix</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-orgc0b3650" class="outline-4">
<h4 id="orgc0b3650"><span class="section-number-4">1.6.1</span> 系统调用的中断与重启</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
<a href="https://github.com/mozilla/rr/wiki/Linux-signals">https://github.com/mozilla/rr/wiki/Linux-signals</a>
</p>

<p>
有一些系统调用会导致 kernel 进入 TASK_INTERRUPTIBLE 状态, 例如:
</p>

<ol class="org-ol">
<li>nanosleep</li>

<li>针对 pipe 的 read, write</li>

<li>wait 类的调用</li>
</ol>

<p>
但发生信号时, kernel 会通过 signal_wake_up 强制将处理
TASK_INTERRUPTIBLE 状态的进程唤醒, 但此时它们等待的事件并没有完成, 却直接走到了之前造成阻塞的指令的下一条指令, 即结果 syscall 就被打断了.
</p>

<p>
以 pipe read 为例:
</p>

<ol class="org-ol">
<li><p>
用户发起 pipe read 并被信号打断
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">pipe_readv</span>:
  <span style="color: #859900;">for</span> <span style="color: #757575;">(</span>;;<span style="color: #757575;">)</span>:
    <span style="color: #586e75;">// </span><span style="color: #586e75;">pipe &#30340; read &#25805;&#20316;&#38459;&#22622;, &#31561;&#24453; writer &#21521; pipe &#20889;&#25968;&#25454;</span>
    PIPE_WAITING_WRITERS<span style="color: #757575;">(</span>*inode<span style="color: #757575;">)</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20551;&#35774;&#38459;&#22622;&#36807;&#31243;&#20013;&#26377;&#20449;&#21495;&#21457;&#29983;, &#24403;&#21069;&#36827;&#31243;&#34987;&#21796;&#37266;, &#21017; PIPE_WAITING_WRITERS</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#20250;&#30452;&#25509;&#36820;&#22238;, &#25191;&#34892;&#19979;&#19968;&#26465;&#25351;&#20196; (signal_pending)</span>
    <span style="color: #586e75;">// </span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">signal_pending &#20026;&#30495;, &#35828;&#26126;&#24403;&#21069;&#36827;&#31243;&#26377; pending signal, &#21017;&#35828;&#26126;&#26159;&#20449;&#21495;&#21796;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#37266;&#20102;&#24403;&#21069;&#36827;&#31243;, &#21017; syscall &#25552;&#21069;&#36820;&#22238; -ERESTARTSYS</span>
    <span style="color: #586e75;">// </span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30001;&#20110; syscall &#36820;&#22238;&#21518; (&#20294;&#22312;&#35843;&#29992; do_signal &#20043;&#21069;) &#20250;&#23558;&#36820;&#22238;&#20540; (eax) &#25918;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#22312; pt_regs &#20013;, &#21518;&#32493; do_signal &#21487;&#20197;&#26681;&#25454; pt_regs-&gt;eax &#30693;&#36947;&#34987;&#25171;&#26029;&#30340;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">syscall &#20851;&#20110;&#37325;&#21551;&#30340;&#24847;&#22270;: &#36820;&#22238; EINTR &#30001;&#19978;&#23618;&#37325;&#21551; syscall, &#25110;&#30001; kernel</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#30452;&#25509;&#36890;&#36807;&#35774;&#32622; ip &#33258;&#21160;&#37325;&#21551; syscall    </span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>signal_pending<span style="color: #757575;">(</span>current<span style="color: #757575;">))</span>:
      ret = -ERESTARTSYS;
      <span style="color: #859900;">break</span>;
</pre>
</div></li>

<li><p>
handle_signal
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">handle_signal</span>:
  <span style="color: #586e75;">// </span><span style="color: #586e75;">&#24403;&#21069;&#26159;&#19968;&#20010; syscall  </span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>regs-&gt;orig_eax &gt;= 0<span style="color: #757575;">)</span>:
    <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>regs-&gt;eax<span style="color: #757575;">)</span>:
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509;&#34987;&#25171;&#26029;&#30340; syscall &#36820;&#22238; ERESTART_RESTARTBLOCK &#25110; ERESTARTNOHAND,</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21017;&#30452;&#25509;&#23545;&#19978;&#23618;&#36820;&#22238; EINTR, &#30001;&#19978;&#23618;&#20915;&#23450;&#26159;&#21542;&#37325;&#21551; syscall</span>
      <span style="color: #586e75;">// </span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#33509; syscall &#36820;&#22238; ERESTARTSYS, &#21017;&#26681;&#25454; sigaction &#26159;&#21542;&#25351;&#23450;&#20102;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">SA_RESTART &#20915;&#23450;&#26159;&#36820;&#22238; EINTR &#36824;&#26159;&#36890;&#36807;&#20462;&#25913; eip &#21644; eax &#30452;&#25509;&#30001;</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">kernel &#26469;&#37325;&#21551; syscall        </span>
      <span style="color: #859900;">case</span> -ERESTART_RESTARTBLOCK:
      <span style="color: #859900;">case</span> -ERESTARTNOHAND:
        regs-&gt;eax = -EINTR;
        <span style="color: #859900;">break</span>;

      <span style="color: #859900;">case</span> -ERESTARTSYS:
        <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span><span style="color: #757575;">(</span>ka-&gt;sa.sa_flags &amp; SA_RESTART<span style="color: #757575;">))</span>:
          regs-&gt;eax = -EINTR;
          <span style="color: #859900;">break</span>;

      <span style="color: #586e75;">/* </span><span style="color: #586e75;">fallthrough</span><span style="color: #586e75;"> */</span>
      <span style="color: #859900;">case</span> -ERESTARTNOINTR:
        regs-&gt;eax = regs-&gt;orig_eax;
        <span style="color: #586e75;">// </span><span style="color: #586e75;">&#19981;&#35770; int 0x80 &#25110; sysenter, &#25351;&#20196;&#38271;&#24230;&#37117;&#26159; 2 bytes             </span>
        regs-&gt;eip -= 2;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
  setup_frame
</pre>
</div></li>
</ol>

<p>
编程时需要考虑 syscall 被信号打断的情况时, 一般使用如下的代码:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #859900;">do</span> <span style="color: #757575;">{</span>
    rc = <span style="color: #757575;">(</span><span style="color: #b58900;">int</span><span style="color: #757575;">)</span>the_sys_call<span style="color: #757575;">()</span>;
<span style="color: #757575;">}</span> <span style="color: #859900;">while</span><span style="color: #757575;">(</span>rc &lt; 0 &amp;&amp; errno == EINTR<span style="color: #757575;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcd42986" class="outline-4">
<h4 id="orgcd42986"><span class="section-number-4">1.6.2</span> 信号与 longjmp</h4>
<div class="outline-text-4" id="text-1-6-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2;">#include</span> <span style="color: #2aa198;">&lt;setjmp.h&gt;</span>

<span style="color: #b58900;">jmp_buf</span> <span style="color: #268bd2;">buff</span>;

<span style="color: #b58900;">void</span> <span style="color: #268bd2;">foo</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">sig</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    printf<span style="color: #757575;">(</span><span style="color: #2aa198;">"foo\n"</span><span style="color: #757575;">)</span>;
    longjmp<span style="color: #757575;">(</span>buff<span style="color: #757575;">,</span> 1<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>

<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">x</span> = setjmp<span style="color: #757575;">(</span>buff<span style="color: #757575;">)</span>;
    signal<span style="color: #757575;">(</span>11<span style="color: #757575;">,</span> foo<span style="color: #757575;">)</span>;
    printf<span style="color: #757575;">(</span><span style="color: #2aa198;">"hello %d\n"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    sleep<span style="color: #757575;">(</span>20<span style="color: #757575;">)</span>;
    <span style="color: #859900;">return</span> 0;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
由于 longjmp 不会返回, 所以栈上的 __kernel_sigreturn 并不会被调用, 所以 longjmp 后不会再返回到被信号打断的位置.
</p>
</div>
</div>

<div id="outline-container-orge04434a" class="outline-4">
<h4 id="orge04434a"><span class="section-number-4">1.6.3</span> 信号与线程</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
通过 fork 时的 copy_process 代码, 可以看到:
</p>

<ol class="org-ol">
<li>p-&gt;sighand 是共享的, 任何一个线程里修改了 sighand 都会影响到其它线程</li>

<li>p-&gt;blocked 在各个线程中是独立的, 所以 sigprocmask 只会影响当前的线程</li>

<li>p-&gt;pending 是独立的</li>

<li>p-&gt;shared_pending 是共享的</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2016-08-10 三 00:00<br />
Last updated: 2022-01-19 三 13:25</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
