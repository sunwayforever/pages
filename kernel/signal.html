<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Linux Kernel: Signal</title>


<link rel="stylesheet" type="text/css" href="/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="./htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="./readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Linux Kernel: Signal</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org000005d">1. Linux Kernel: Signal</a>
<ul>
<li><a href="#org0000000">1.1. Overview</a></li>
<li><a href="#org0000004">1.2. 数据结构</a></li>
<li><a href="#org0000022">1.3. 信号产生</a>
<ul>
<li><a href="#org000000d">1.3.1. 给单个线程发送信号</a></li>
<li><a href="#org0000016">1.3.2. 给线程组发送信号</a></li>
<li><a href="#org000001f">1.3.3. 举例</a></li>
</ul>
</li>
<li><a href="#org000003c">1.4. 信号传递</a>
<ul>
<li><a href="#org0000039">1.4.1. do_signal</a></li>
</ul>
</li>
<li><a href="#org000004e">1.5. 相关的系统调用</a>
<ul>
<li><a href="#org000003f">1.5.1. kill, tkill, tgkill</a></li>
<li><a href="#org0000042">1.5.2. signal, sigaction</a></li>
<li><a href="#org0000045">1.5.3. sigsuspend</a></li>
<li><a href="#org0000048">1.5.4. sigpending</a></li>
<li><a href="#org000004b">1.5.5. sigprocmask</a></li>
</ul>
</li>
<li><a href="#org000005a">1.6. Appendix</a>
<ul>
<li><a href="#org0000051">1.6.1. 系统调用的中断与重启</a></li>
<li><a href="#org0000054">1.6.2. 信号与 longjmp</a></li>
<li><a href="#org0000057">1.6.3. 信号与线程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000005d" class="outline-2">
<h2 id="org000005d"><span class="section-number-2">1.</span> Linux Kernel: Signal</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000000" class="outline-3">
<h3 id="org0000000"><span class="section-number-3">1.1.</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
信号 (signal) 是一个很短的消息, 发送者可以是 kernel 本身或某个进程, 接收者可以是单个进程或一组进程(线程), 通常这个消息只会包含一个数字来标识具体是哪个信号, 但新的 sigaction API 可以使 kernel 在消息中保存更多的更多的内容, 例如发送者的 pid, uid 等.
</p>

<p>
传统的信号一个 31 个, 后来 POSIX 又引入了 real-time signal 的概念,
real-time signal 使用的信号范围是 32 .. 64, 所以信号的总数不超过 64 个.
</p>

<p>
task_struct 中针对每个信号都有一个处理函数 (sa_handler)), 用户可以通过
signal 或 sigaction 来设置这个 sa_handler. sa_handler 可以是一段用户空间的代码, 也可以是一些特殊值表示特殊的处理:
</p>

<ol class="org-ol">
<li>SIG_DFL 表示处理这个信号采用 kernel 默认的处理函数</li>

<li>SIG_IGN 表示忽略这个信号, 不做任何处理</li>
</ol>

<p>
用户进程 A 可以通过 kill, tkill, tgkill 三个系统调用向另一个进程 B "发送" 一个特定的信号, 这个过程称为 signal generating, 其中:
</p>

<ol class="org-ol">
<li>tkill 是仅仅向某个线程发送信号, 和线程所在的线程组 (thread group)
中的某它线程无关</li>

<li>tgkill 功能和 tkill 是一样的&#x2026;只不过它会在 tkill 基础上做一些检查</li>

<li>kill 是向整个 thread group 发送信号, kernel 负责从 thread group 中选择某个 thread 来响应这个信号, 另外, 如果这个信号是 fatal 的, 则
kernel 还会向 thread group 的所有线程发送 SIG_KILL 使得整个 thread
group 都结束执行</li>
</ol>

<p>
B 进程事先可以通过 sigprocmask 将特定信息标记为 BLOCKED, A 进程发送过来的信号会被记入 B 进程的 pending signal 列表中, 当 B 后面再次通过
sigprocmask 解除对这个信号的 block 时, B 会立即收到这个信号. 这一点与
SIG_IGN 是不同的: 如果某个信号的处理函数通过 sigal 或 sigaction 设置为
SIG_IGN, 则这个信号并不会进入 pending signal 列表中: 它会被直接丢弃
</p>

<p>
A 发送信号给 B 只是将信号记在 B 的 pending signal 中, B 真正响应这个信号的时机是从 kernel mode 返回 user mode 时, 参考 <a href="interrupt.html#org0000033">ret_from_intr</a> 中关于
work_pending 的描述. B 响应信号的过程称为 signal delivering
</p>

<p>
当 B 事先注册的 sa_handler 被调用时, 因为 sa_handler 是一段用户空间的代码, 而 ret_from_intr 时还在 kernel mode, 所以 kernel 需要一种手段能在 kernel mode 调用 user mode 的代码
</p>
</div>
</div>


<div id="outline-container-org0000004" class="outline-3">
<h3 id="org0000004"><span class="section-number-3">1.2.</span> 数据结构</h3>
<div class="outline-text-3" id="text-1-2">

<div id="org0000003" class="figure">
<p><img src="../extra/kernel_signal.png" alt="kernel_signal.png" />
</p>
</div>

<ol class="org-ol">
<li>p-&gt;pending 类型为 sigpending, 其中的 pending-&gt;signal 是一个 64 big
的 mask, 标识有哪个 pending 的信号. pending-&gt;list 是一个 sigqueue
的链表, sigqueue 描述了每一个 pending 的信号的具体信息</li>

<li>p-&gt;signal 中的许多信息和 signal 的处理关系并不紧密, 例如
signal-&gt;rlim 是进程的 rlimit 信息, rlimit 中的大部分信息和信号没有一点关系. p-&gt;signal-&gt;share_pending 和 p-&gt;pending 类似, 如果一个信号是发给整个 thread group 的, 则需要使用 share_pending 做一些记录</li>

<li>p-&gt;sighand 是针对每个信号的 sa_handler 信息, signal 和 sigaction 系统调用会直接修改它的内容.</li>
</ol>
</div>
</div>

<div id="outline-container-org0000022" class="outline-3">
<h3 id="org0000022"><span class="section-number-3">1.3.</span> 信号产生</h3>
<div class="outline-text-3" id="text-1-3">
<p>
根据信号的来源 (进程通过 kill 发起或 kernel 本身发起的), kernel 通过许多函数来发送信号 (signal generating):
</p>

<ol class="org-ol">
<li>发送给单个线程

<ul class="org-ul">
<li>sys_tkill</li>

<li>sys_tgkill</li>

<li>send_sig{_info}</li>

<li>force_sig{_info}</li>
</ul></li>

<li>发送给整个线程组

<ul class="org-ul">
<li>send_group_sig_info</li>

<li>kill_pg{_info}</li>

<li>kill_proc{_info}</li>

<li>sys_kill</li>
</ul></li>
</ol>

<p>
不论上面提到的哪个函数, 最终都会调用到 specific_send_sig_info 或
group_send_sig_info
</p>
</div>

<div id="outline-container-org000000d" class="outline-4">
<h4 id="org000000d"><span class="section-number-4">1.3.1.</span> 给单个线程发送信号</h4>
<div class="outline-text-4" id="text-1-3-1">
</div>
<div id="outline-container-org0000007" class="outline-5">
<h5 id="org0000007"><span class="section-number-5">1.3.1.1.</span> specific_send_sig_info</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">specific_send_sig_info</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">t</span><span class="org-parenthesis">)</span>:
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_ignored<span class="org-parenthesis">(</span>t<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">task_struct-&gt;block &#26159;&#19968;&#20010; 64 bit &#30340; mask, &#26631;&#35782;&#21738;&#20123; sig &#34987;</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">block. &#34987; block &#30340; sig &#19981;&#33021;&#34987; ignore, &#22240;&#20026;&#23427;&#20204;&#38656;&#35201;&#34987;&#25918;&#22312; pending</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">signal &#20013;&#20197;&#20415; unblock &#26102;&#36827;&#31243;&#33021;&#20877;&#27425;&#25910;&#21040;&#36825;&#20010; sig</span>
        <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sigismember<span class="org-parenthesis">(</span>&amp;t-&gt;blocked<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
          <span class="org-keyword">return</span> 0;
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; t-&gt;sighand &#20013; sig &#23545;&#24212;&#30340; handler &#20026; SIG_IGN &#25110; handler &#20026;</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">SIG_DFL &#20294; sig &#30340;&#40664;&#35748; handler &#20063;&#20026; ignore, &#21017;&#24573;&#30053;&#36825;&#20010; sig</span>
        handler = t-&gt;sighand-&gt;action[sig-1].sa.sa_handler;
        <span class="org-keyword">return</span>   handler == SIG_IGN || <span class="org-parenthesis">(</span>handler == SIG_DFL &amp;&amp; sig_kernel_ignore<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">))</span>;
    <span class="org-keyword">goto</span> <span class="org-constant">out</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#27809;&#26377; ignore &#30340; sig &#26368;&#32456;&#38656;&#22312;&#25918;&#22312; t-&gt;pending &#20013;, sigpending-&gt;signal &#26159;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#19968;&#20010; bitmask, &#26631;&#35782; pending &#21015;&#34920;&#20013;&#26159;&#21542;&#24050;&#32463;&#23384;&#22312;&#30456;&#21516; sig &#30340; signal.</span>
  <span class="org-comment-delimiter">//</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#20110;&#26222;&#36890;&#30340; (&#38750; real time) &#30340; signal, &#23545;&#20110;&#21516;&#19968;&#20010; sig, pending &#21015;&#34920;&#20013;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26368;&#22810;&#21482;&#20250;&#20445;&#23384;&#19968;&#20010;&#23545;&#24212;&#30340; signal, &#21363;&#22810;&#20010;&#26222;&#36890; signal &#19981;&#20250;&#32047;&#31215;&#22312; pending</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20013;.</span>
  <span class="org-comment-delimiter">//</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20294;&#23545;&#20110; real time signal, &#22810;&#20010; real time signal &#26159;&#21487;&#20197;&#22312; pending &#20013;&#32047;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#31215;&#30340;</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>LEGACY_QUEUE<span class="org-parenthesis">(</span>&amp;t-&gt;pending<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
        <span class="org-parenthesis">(((</span>sig<span class="org-parenthesis">)</span> &lt; SIGRTMIN<span class="org-parenthesis">)</span> &amp;&amp; sigismember<span class="org-parenthesis">(</span>&amp;<span class="org-parenthesis">(</span>pending<span class="org-parenthesis">)</span>-&gt;signal<span class="org-parenthesis">,</span> <span class="org-parenthesis">(</span>sig<span class="org-parenthesis">)))</span>
    <span class="org-keyword">goto</span> <span class="org-constant">out</span>;

  <span class="org-function-name">send_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">t</span><span class="org-parenthesis">,</span> &amp;t-&gt;pending<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524; sig &#27809;&#26377; block, &#21017;&#21796;&#37266;&#36827;&#31243;&#20197;&#20415;&#23427;&#33021;&#21450;&#26102;&#21709;&#24212;&#36825;&#20010; signal</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>ret &amp;&amp; <span class="org-negation-char">!</span>sigismember<span class="org-parenthesis">(</span>&amp;t-&gt;blocked<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
    signal_wake_up<span class="org-parenthesis">(</span>t<span class="org-parenthesis">,</span> sig == SIGKILL<span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; TIF_SIGPENDING, &#20197;&#20415; ret_from_intr &#26102;&#33021;&#21457;&#29616;&#26377; pending signal</span>
      <span class="org-function-name">set_tsk_thread_flag</span><span class="org-parenthesis">(</span><span class="org-type">t</span><span class="org-parenthesis">,</span> <span class="org-type">TIF_SIGPENDING</span><span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#27491;&#24120;&#24773;&#20917;&#19979;&#21482;&#26377;&#22788;&#20110; TASK_INTERRUPTIBLE &#29366;&#24577;&#30340;&#36827;&#31243;&#25165;&#20250;&#34987;&#21796;&#37266;, &#20294;&#33509;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">sig &#20026; SIG_KILL, &#21017; TASK_STOPPED &#29366;&#24577;&#21644; TASK_TRACED &#29366;&#24577;&#30340;&#36827;&#31243;&#20063;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#20250;&#34987;&#21796;&#37266;.</span>
      <span class="org-comment-delimiter">//</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#25152;&#20197;&#27491;&#22312; sleep &#25110;&#38459;&#22622;&#22312; read &#19978;&#30340;&#36827;&#31243;&#20250;&#34987;&#21796;&#37266;, &#36825;&#20063;&#26159; signal &#23548;&#33268;&#31995;&#32479;&#35843;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#29992;&#25552;&#21069;&#36820;&#22238;&#30340;&#21407;&#22240;. &#21478;&#22806;, &#22788;&#20110; D &#29366;&#24577; (TASK_UNINTERRUPTIBLE) &#30340;&#36827;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#31243;&#19981;&#20250;&#34987;&#21796;&#37266;, &#25152;&#20197; D &#29366;&#24577;&#30340;&#36827;&#31243;&#26080;&#27861;&#21450;&#26102;&#21709;&#24212; signal</span>
      mask = TASK_INTERRUPTIBLE;
      <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>resume<span class="org-parenthesis">)</span>:
        mask |= TASK_STOPPED | TASK_TRACED;
      <span class="org-function-name">wake_up_state</span><span class="org-parenthesis">(</span><span class="org-type">t</span><span class="org-parenthesis">,</span> <span class="org-type">mask</span><span class="org-parenthesis">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org000000a" class="outline-5">
<h5 id="org000000a"><span class="section-number-5">1.3.1.2.</span> send_signal</h5>
<div class="outline-text-5" id="text-1-3-1-2">
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">send_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">t</span><span class="org-parenthesis">,</span> <span class="org-type">pending</span><span class="org-parenthesis">)</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20998;&#37197;&#19968;&#20010; sigqueue, &#21518;&#38754;&#38656;&#35201;&#23558;&#23427;&#25554;&#20837; pending &#38142;&#34920;&#20013;</span>
  q = __sigqueue_alloc<span class="org-parenthesis">(</span>t<span class="org-parenthesis">,</span> GFP_ATOMIC<span class="org-parenthesis">)</span>;
  list_add_tail<span class="org-parenthesis">(</span>&amp;q-&gt;list<span class="org-parenthesis">,</span> &amp;signals-&gt;list<span class="org-parenthesis">)</span>;
  <span class="org-keyword">switch</span> <span class="org-parenthesis">((</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> info<span class="org-parenthesis">)</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">send_signal &#26102;&#20256;&#20837;&#30340; info (siginfo) &#19968;&#33324;&#26159;&#30001;&#19978;&#23618;&#22635;&#20805;&#30340;, &#21253;&#21547;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">signo, errno, code, pid, uid, addr &#31561;&#25968;&#25454;. &#28982;&#21518; send_signal &#26102;&#36890;&#36807;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">copy_siginfo &#23558; info &#22797;&#21046;&#21040; q-&gt;info &#20013;.</span>
    <span class="org-comment-delimiter">//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20294;&#26377;&#26102; kernel &#26377;&#26102;&#20250;&#36890;&#36807; force_sig, send_sig &#21457;&#36865;&#19968;&#20123;&#20449;&#21495;, &#32780;&#19988;&#36825;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20123;&#20449;&#21495;&#24182;&#19981;&#38656;&#35201;&#36890;&#36807; siginfo &#20256;&#36882;&#22823;&#37096;&#20998;&#20449;&#24687;, &#20026;&#20102;&#36991;&#20813; copy_siginfo,</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">kernel &#20351;&#29992;&#29305;&#23450;&#30340; 0, 1 &#20570;&#20026; info &#24182;&#22312;&#36825;&#37324;&#36827;&#34892;&#29305;&#27530;&#30340;&#22788;&#29702;.</span>
    <span class="org-keyword">case</span> 0:
      q-&gt;info.si_signo = sig;
      q-&gt;info.si_errno = 0;
      q-&gt;info.si_code = SI_USER;
      q-&gt;info.si_pid = current-&gt;pid;
      q-&gt;info.si_uid = current-&gt;uid;
      <span class="org-keyword">break</span>;
    <span class="org-keyword">case</span> 1:
      q-&gt;info.si_signo = sig;
      q-&gt;info.si_errno = 0;
      q-&gt;info.si_code = SI_KERNEL;
      q-&gt;info.si_pid = 0;
      q-&gt;info.si_uid = 0;
      <span class="org-keyword">break</span>;
    <span class="org-keyword">default</span>:
      copy_siginfo<span class="org-parenthesis">(</span>&amp;q-&gt;info<span class="org-parenthesis">,</span> info<span class="org-parenthesis">)</span>;
      <span class="org-keyword">break</span>;

    sigaddset<span class="org-parenthesis">(</span>&amp;pending-&gt;signal<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000016" class="outline-4">
<h4 id="org0000016"><span class="section-number-4">1.3.2.</span> 给线程组发送信号</h4>
<div class="outline-text-4" id="text-1-3-2">
</div>
<div id="outline-container-org0000010" class="outline-5">
<h5 id="org0000010"><span class="section-number-5">1.3.2.1.</span> group_send_sig_info</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">group_send_sig_info</span>:
  <span class="org-function-name">__group_send_sig_info</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21516;&#19968;&#20010; thread group &#30340; t-&gt;signal &#21644; t-&gt;sighand &#26159;&#20849;&#20139;&#30340; (t-&gt;blocked</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21644; t-&gt;pending &#26159;&#21333;&#29420;&#30340;), &#25152;&#20197; sig_ignored &#23545; p &#25110;&#32773; p &#36825;&#20010;&#32447;&#31243;&#32452;&#20013;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#30340;&#25152;&#26377;&#32447;&#31243;&#37117;&#20250;&#36820;&#22238;&#30456;&#21516;&#30340;&#32467;&#26524;    </span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_ignored<span class="org-parenthesis">(</span>p<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
      <span class="org-keyword">return</span> ret;
    <span class="org-comment-delimiter">// </span><span class="org-comment">sig &#23558;&#34987;&#21152;&#20837; p-&gt;shared_pending &#32780;&#19981;&#26159; t-&gt;pending    </span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>LEGACY_QUEUE<span class="org-parenthesis">(</span>&amp;p-&gt;signal-&gt;shared_pending<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">))</span>:
      <span class="org-keyword">return</span> ret;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#19982; specific_send_sig_info &#30456;&#21516;, &#21482;&#19981;&#36807;&#26159;&#21152;&#20837;&#21040; p-&gt;shared_pending &#32780;&#19981;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#26159; t-&gt;pending    </span>
    <span class="org-function-name">send_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">,</span> &amp;p-&gt;signal-&gt;shared_pending<span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#20110; specific_send_sig_info &#26469;&#35828;, &#36825;&#37324;&#20250;&#36890;&#36807; signal_wake_up &#21796;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#37266; p &#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;. &#20294;&#23545;&#20110; group_send_sig_info &#26469;&#35828;, &#36825;&#37324;&#20250;&#36890;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#36807;__group_complete_signal &#26469;&#36873;&#25321; p &#25152;&#22312;&#30340; thread group &#20013;&#30340;&#26576;&#19968;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20010; "&#21512;&#36866;" &#30340;&#32447;&#31243;&#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;</span>
    <span class="org-function-name">__group_complete_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000013" class="outline-5">
<h5 id="org0000013"><span class="section-number-5">1.3.2.2.</span> __group_complete_signal</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">// </span><span class="org-comment">__group_complete_signal &#30340;&#30446;&#30340;&#26159;&#20174; p &#25152;&#22312;&#30340; thread group &#20013;&#36873;&#25321;&#19968;&#20010;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#32447;&#31243;&#26469;&#21796;&#37266;, &#20197;&#21709;&#24212;&#20043;&#21069;&#24050;&#32463;&#21152;&#20837;&#21040; p-&gt;shared_pending &#20013;&#30340;&#20449;&#21495;</span>
<span class="org-function-name">__group_complete_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">wants_signal &#29992;&#26469;&#26816;&#26597; thread p &#26159;&#21542; "&#24212;&#35813;" &#21709;&#24212; sig, &#21709;&#24212; sig &#30340;&#26465;&#20214;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20026;:</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">1. sig &#27809;&#26377;&#34987; p block</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">2. p-&gt;state &#19981;&#26159; mask &#25152;&#25351;&#23450;&#30340; state</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">3. p &#27491;&#21344;&#29992;&#30528; cpu &#25110; p &#27809;&#26377;&#20219;&#20309; pending &#20449;&#21495; (p-&gt;pending &#21450;</span>
  <span class="org-comment-delimiter">//    </span><span class="org-comment">p-&gt;shared_pending &#20026;&#31354;)  </span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>wants_signal<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> p<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">))</span>:
<span class="org-preprocessor">        #define</span> <span class="org-function-name">wants_signal</span><span class="org-parenthesis">(</span><span class="org-variable-name">sig</span><span class="org-parenthesis">,</span> <span class="org-variable-name">p</span><span class="org-parenthesis">,</span> <span class="org-variable-name">mask</span><span class="org-parenthesis">)</span>                      \
          <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>sigismember<span class="org-parenthesis">(</span>&amp;<span class="org-parenthesis">(</span>p<span class="org-parenthesis">)</span>-&gt;blocked<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">)</span>     \
           &amp;&amp; <span class="org-negation-char">!</span><span class="org-parenthesis">((</span>p<span class="org-parenthesis">)</span>-&gt;state &amp; mask<span class="org-parenthesis">)</span>          \
           &amp;&amp; <span class="org-negation-char">!</span><span class="org-parenthesis">((</span>p<span class="org-parenthesis">)</span>-&gt;flags &amp; PF_EXITING<span class="org-parenthesis">)</span>                 \
           &amp;&amp; <span class="org-parenthesis">(</span>task_curr<span class="org-parenthesis">(</span>p<span class="org-parenthesis">)</span> || <span class="org-negation-char">!</span>signal_pending<span class="org-parenthesis">(</span>p<span class="org-parenthesis">)))</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20248;&#20808;&#36873;&#25321; kill syscall &#26368;&#21021;&#25351;&#23450;&#30340;&#32447;&#31243;&#26469;&#21709;&#24212;&#20449;&#21495;    </span>
    t = p;
  <span class="org-keyword">else</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20174; thread group &#20013;&#36873;&#25321;&#19968;&#20010; wants_signal &#20026;&#30495;&#30340;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">p-&gt;signal-&gt;curr_target &#35760;&#24405;&#20102;&#19978;&#27425;&#21709;&#24212;&#20449;&#21495;&#30340; thread, &#36890;&#36807;&#36825;&#20010;&#21487;&#20197;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#22312;&#19968;&#23450;&#31243;&#24230;&#19978;&#23454;&#29616;&#20449;&#21495;&#22788;&#29702;&#30340; load balancing      </span>
    t = p-&gt;signal-&gt;curr_target;
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>t == <span class="org-constant">NULL</span><span class="org-parenthesis">)</span>:
      t = p-&gt;signal-&gt;curr_target = p;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#36941;&#21382;&#25152;&#26377;&#30340; thread    </span>
    <span class="org-keyword">while</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>wants_signal<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> t<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">))</span>:
      t = next_thread<span class="org-parenthesis">(</span>t<span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#27809;&#26377;&#20219;&#20309;&#19968;&#20010; thread wants_signal, &#37027;&#36825;&#37324;&#26080;&#27861;&#21796;&#37266;&#20219;&#20309;&#32447;&#31243;: &#21482;&#33021;&#31561;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#30528;&#26576;&#20010;&#32447;&#31243; "&#33258;&#28982;" &#21796;&#37266;&#21518;&#26469;&#22788;&#29702;&#36825;&#20010;&#20449;&#21495;&#20102;      </span>
      <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>t == p-&gt;signal-&gt;curr_target<span class="org-parenthesis">)</span>
        <span class="org-keyword">return</span>;
    p-&gt;signal-&gt;curr_target = t;

  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_fatal<span class="org-parenthesis">(</span>p<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">)</span> ....<span class="org-parenthesis">)</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#26159; fatal &#20449;&#21495;, &#30452;&#25509; kill &#25481; thread group &#20013;&#25152;&#26377;&#32447;&#31243;, &#36825;&#19968;&#28857;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#19982; get_signal_to_deliver &#37324;&#30340;&#36923;&#36753;&#24046;&#19981;&#22810;      </span>
    ...
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26368;&#21518;, &#21796;&#37266; t &#26469;&#21709;&#24212;&#36825;&#20010;&#20449;&#21495;      </span>
  signal_wake_up<span class="org-parenthesis">(</span>t<span class="org-parenthesis">,</span> sig == SIGKILL<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000001f" class="outline-4">
<h4 id="org000001f"><span class="section-number-4">1.3.3.</span> 举例</h4>
<div class="outline-text-4" id="text-1-3-3">
</div>
<div id="outline-container-org0000019" class="outline-5">
<h5 id="org0000019"><span class="section-number-5">1.3.3.1.</span> 应用发起的 kill</h5>
<div class="outline-text-5" id="text-1-3-3-1">
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">sys_kill</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-parenthesis">,</span> <span class="org-type">int</span> <span class="org-variable-name">sig</span><span class="org-parenthesis">)</span>:
  <span class="org-keyword">struct</span> siginfo info;

  info.si_signo = sig;
  info.si_errno = 0;
  info.si_code = SI_USER;
  info.si_pid = current-&gt;tgid;
  info.si_uid = current-&gt;uid;

  <span class="org-function-name">kill_something_info</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> &amp;info<span class="org-parenthesis">,</span> <span class="org-type">pid</span><span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; pid &#20026; 0, &#21017;&#34920;&#31034;&#35201;&#32473;&#24403;&#21069;&#36827;&#31243;&#25152;&#22312;&#36827;&#31243;&#32452;&#30340;&#25152;&#26377;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;. &#20851;&#20110;&#36827;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#31243;&#32452;, &#21442;&#32771; [[file:process.org::*Processes%20Relationship][Processes Relationship]]  </span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>pid<span class="org-parenthesis">)</span>:
    <span class="org-keyword">return</span> kill_pg_info<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> info<span class="org-parenthesis">,</span> process_group<span class="org-parenthesis">(</span>current<span class="org-parenthesis">))</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">pg &#26159;&#25351; process group, &#21363;&#36827;&#31243;&#32452;</span>
      <span class="org-function-name">do_each_task_pid</span><span class="org-parenthesis">(</span><span class="org-type">pgrp</span><span class="org-parenthesis">,</span> <span class="org-type">PIDTYPE_PGID</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
        group_send_sig_info<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> info<span class="org-parenthesis">,</span> p<span class="org-parenthesis">)</span>;
      <span class="org-parenthesis">}</span> <span class="org-function-name">while_each_task_pid</span><span class="org-parenthesis">(</span><span class="org-type">pgrp</span><span class="org-parenthesis">,</span> <span class="org-type">PIDTYPE_PGID</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; pid &#20026;&#36127;&#25968;, &#21017;&#32473; -pid &#25152;&#25351;&#31034;&#30340;&#36827;&#31243;&#32452;&#30340;&#27599;&#20010;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;  </span>
  <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>pid &lt; 0<span class="org-parenthesis">)</span>:
    <span class="org-keyword">return</span> kill_pg_info<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> info<span class="org-parenthesis">,</span> -pid<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#32473; pid &#25351;&#31034;&#30340;&#36827;&#31243;&#21457;&#36865;&#20449;&#21495;      </span>
  <span class="org-keyword">else</span>:
    <span class="org-keyword">return</span> kill_proc_info<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> info<span class="org-parenthesis">,</span> pid<span class="org-parenthesis">)</span>;
      p = find_task_by_pid<span class="org-parenthesis">(</span>pid<span class="org-parenthesis">)</span>;
      <span class="org-function-name">group_send_sig_info</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">p</span><span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org000001c" class="outline-5">
<h5 id="org000001c"><span class="section-number-5">1.3.3.2.</span> page fault 导致的 SIGSEGV</h5>
<div class="outline-text-5" id="text-1-3-3-2">
<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">do_page_fault</span>:
  info.si_signo = SIGSEGV;
  info.si_errno = 0;
  info.si_addr = <span class="org-parenthesis">(</span><span class="org-type">void</span> <span class="org-variable-name">__user</span> *<span class="org-parenthesis">)</span>address;
  <span class="org-function-name">force_sig_info</span><span class="org-parenthesis">(</span><span class="org-type">SIGSEGV</span><span class="org-parenthesis">,</span> &amp;info<span class="org-parenthesis">,</span> <span class="org-type">tsk</span><span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; sig &#34987; blocked, &#21017; force_sig_info &#24378;&#21046;&#25226;&#23427; unblock; &#33509;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">sa_handler &#34987;&#20462;&#25913;&#20026; SIG_IGN, &#21017; force_sig_info &#20250;&#24378;&#21046;&#25226;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">sa_handler &#21464;&#20026; SIG_DFL...</span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#25152;&#20197;&#30475;&#36215;&#26469;&#24212;&#29992;&#25226; sa_handler &#20889;&#25104;&#19968;&#20010;&#31354;&#20989;&#25968;&#21644;&#30452;&#25509;&#35774;&#32622;&#20026; SIG_IGN &#36824;&#26159;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#26377;&#20123;&#24046;&#21035;&#30340;          </span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sigismember<span class="org-parenthesis">(</span>&amp;t-&gt;blocked<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">)</span> ||
        t-&gt;sighand-&gt;action[sig-1].sa.sa_handler == SIG_IGN<span class="org-parenthesis">)</span>:
      t-&gt;sighand-&gt;action[sig-1].sa.sa_handler = SIG_DFL;
      sigdelset<span class="org-parenthesis">(</span>&amp;t-&gt;blocked<span class="org-parenthesis">,</span> sig<span class="org-parenthesis">)</span>;
      <span class="org-function-name">recalc_sigpending_tsk</span><span class="org-parenthesis">(</span><span class="org-type">t</span><span class="org-parenthesis">)</span>;
    <span class="org-function-name">specific_send_sig_info</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">t</span><span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org000003c" class="outline-3">
<h3 id="org000003c"><span class="section-number-3">1.4.</span> 信号传递</h3>
<div class="outline-text-3" id="text-1-4">
<p>
信号传递 (signal delivering) 是指 pending 信号对应的 sa_handler 真正被执行的过程. 一般情况下, 中断处理的 resume_userspace 会检查是否有需要处理的信号(resume_kernel 并不会做这种检查)
</p>

<p>
resume_userspace 被调用可以分为两种情况:
</p>

<ol class="org-ol">
<li>中断或 syscall 正常完成, 调用 resume_userspace</li>

<li>syscall 阻塞, 但被信号唤醒 (通过 signal_wake_up), 从而调用
resume_userspace</li>
</ol>

<p>
其中后者是 kernel 处理 "syscall 被中断并重启" 问题的关键.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">resume_userspace</span>:
  <span class="org-type">movl</span> <span class="org-function-name">TI_flags</span><span class="org-parenthesis">(</span>%ebp<span class="org-parenthesis">),</span> %ecx
  andl $_TIF_WORK_MASK<span class="org-parenthesis">,</span> %ecx

  jne work_pending

work_pending:
  testb $_TIF_NEED_RESCHED<span class="org-parenthesis">,</span> %cl
  jz work_notifysig

work_notifysig:
  call do_notify_resume
    <span class="org-comment-delimiter">// </span><span class="org-comment">signal_wake_up &#26102;&#20250;&#32622;&#20301;.</span>
    <span class="org-comment-delimiter">//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21478;&#22806;&#26356;&#19968;&#33324;&#30340;&#24773;&#20917;&#19979;, kernel &#27599;&#27425;&#23545; pending &#30340;&#25913;&#21464;&#21518;&#37117;&#20250;&#35843;&#29992;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">recalc_sigpending_tsk &#26681;&#25454; pending-&gt;signal &#26469;&#23545; TIF_SIGPENDING &#32622;&#20301;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#25110;&#22797;&#20301;</span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>thread_info_flags &amp; _TIF_SIGPENDING<span class="org-parenthesis">)</span>:
      do_signal<span class="org-parenthesis">(</span>regs<span class="org-parenthesis">,</span>oldset<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>

<div id="outline-container-org0000039" class="outline-4">
<h4 id="org0000039"><span class="section-number-4">1.4.1.</span> do_signal</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
do_signal 是信号处理最主要的部分, 它需要完成信号处理中最复杂的部分: 在
kernel space 调用 user space 下的 sa_handler
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">do_signal</span>:
  signr = get_signal_to_deliver<span class="org-parenthesis">(</span>&amp;info<span class="org-parenthesis">,</span> &amp;ka<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">,</span> <span class="org-constant">NULL</span><span class="org-parenthesis">)</span>;
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>signr &gt; 0<span class="org-parenthesis">)</span>:
    handle_signal<span class="org-parenthesis">(</span>signr<span class="org-parenthesis">,</span> &amp;info<span class="org-parenthesis">,</span> &amp;ka<span class="org-parenthesis">,</span> oldset<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">)</span>;
    <span class="org-keyword">return</span> 1
</pre>
</div>
</div>

<div id="outline-container-org0000025" class="outline-5">
<h5 id="org0000025"><span class="section-number-5">1.4.1.1.</span> get_signal_to_deliver</h5>
<div class="outline-text-5" id="text-1-4-1-1">
<p>
找一个 pending 的 signal, 并交给 handle_signal 去处理. 如果 pending
signal 对应的 handler 是 SIG_DFL, 则执行默认的操作: ignore, coredump
或 exit
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">get_signal_to_deliver</span>:
  <span class="org-type">sigset_t</span> *<span class="org-variable-name">mask</span> = &amp;current-&gt;blocked;
  signr = dequeue_signal<span class="org-parenthesis">(</span>current<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">,</span> info<span class="org-parenthesis">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">signr</span> = __dequeue_signal<span class="org-parenthesis">(</span>&amp;tsk-&gt;pending<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">,</span> info<span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#20174; pending-&gt;signal &#36825;&#20010; bitmask &#25214;&#21040; mask &#20043;&#22806;&#30340;&#31532;&#19968;&#20010; pending</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#30340; signr</span>
      sig = next_signal<span class="org-parenthesis">(</span>pending<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#20174; pending &#21015;&#34920;&#20013;&#25214;&#21040;&#23545;&#24212;&#20110; sig &#30340; siginfo</span>
      <span class="org-function-name">collect_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">pending</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">)</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; pending &#20013;&#27809;&#26377;, &#21017;&#26597;&#25214; shared_pending. group_send_sig_info &#26102;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20250;&#23558;&#20449;&#21495;&#21152;&#20837;&#21040; shared_pending &#20013;      </span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>signr<span class="org-parenthesis">)</span>:
      signr = __dequeue_signal<span class="org-parenthesis">(</span>&amp;tsk-&gt;signal-&gt;shared_pending<span class="org-parenthesis">,</span> mask<span class="org-parenthesis">,</span> info<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#27809;&#26377;&#20219;&#20309; pending signal</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>signr<span class="org-parenthesis">)</span>:
    <span class="org-keyword">break</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">&#25214;&#21040;&#19968;&#20010; pending signal</span>
  ka = &amp;current-&gt;sighand-&gt;action[signr-1];
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>ka-&gt;sa.sa_handler == SIG_IGN<span class="org-parenthesis">)</span>:
    <span class="org-keyword">continue</span>;
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>ka-&gt;sa.sa_handler != SIG_DFL<span class="org-parenthesis">)</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#25214;&#21040;&#19968;&#20010;&#26377; sa_handler &#30340;&#20449;&#21495;, &#36820;&#22238;&#21040;&#19978;&#23618;, &#21518;&#32493;&#20250;&#35843;&#29992; handle_signal</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#26469;&#22788;&#29702;&#23427;</span>
    *return_ka = *ka;
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>ka-&gt;sa.sa_flags &amp; SA_ONESHOT<span class="org-parenthesis">)</span>:
      ka-&gt;sa.sa_handler = SIG_DFL;
    <span class="org-keyword">break</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#21069;&#20004;&#20010;&#21028;&#26029;&#37117;&#19981;&#28385;&#36275;, &#36208; SIG_DFL &#30340;&#22788;&#29702;&#36335;&#24452;</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_kernel_ignore<span class="org-parenthesis">(</span>signr<span class="org-parenthesis">))</span>:
    <span class="org-keyword">continue</span>;
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>current-&gt;pid == 1<span class="org-parenthesis">)</span>:
    <span class="org-keyword">continue</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">sig &#26159; SIGSTOP &#19968;&#31867;&#30340;&#20449;&#21495;</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_kernel_stop<span class="org-parenthesis">(</span>signr<span class="org-parenthesis">))</span>:
    do_signal_stop<span class="org-parenthesis">(</span>signr<span class="org-parenthesis">)</span>
    <span class="org-keyword">continue</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#21097;&#19979;&#30340;&#20840;&#26159; fatal &#20449;&#21495;</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>sig_kernel_coredump<span class="org-parenthesis">(</span>signr<span class="org-parenthesis">))</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#38656;&#35201;&#29983;&#25104; coredump</span>
    do_coredump<span class="org-parenthesis">((</span><span class="org-type">long</span><span class="org-parenthesis">)</span>signr<span class="org-parenthesis">,</span> signr<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#20110; fatal &#20449;&#21495;, &#19981;&#20165;&#20165;&#26159;&#24403;&#21069;&#32447;&#31243;&#36864;&#20986;, &#32780;&#26159;&#25972;&#20010; thread group &#20013;&#30340;&#25152;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26377;&#32447;&#31243;&#37117;&#20250;&#36864;&#20986;</span>
  <span class="org-function-name">do_group_exit</span><span class="org-parenthesis">(</span><span class="org-type">signr</span><span class="org-parenthesis">)</span>;
    <span class="org-function-name">zap_other_threads</span><span class="org-parenthesis">(</span><span class="org-type">current</span><span class="org-parenthesis">)</span>;
      <span class="org-keyword">for</span> <span class="org-parenthesis">(</span>t = next_thread<span class="org-parenthesis">(</span>p<span class="org-parenthesis">)</span>; t != p; t = next_thread<span class="org-parenthesis">(</span>t<span class="org-parenthesis">))</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#30456;&#24403;&#20110;&#32473;&#20854;&#23427;&#27599;&#20010;&#23376;&#32447;&#31243;&#37117;&#21457;&#36865;&#19968;&#20010; SIGKILL</span>
        sigaddset<span class="org-parenthesis">(</span>&amp;t-&gt;pending.signal<span class="org-parenthesis">,</span> SIGKILL<span class="org-parenthesis">)</span>;
        <span class="org-function-name">rm_from_queue</span><span class="org-parenthesis">(</span><span class="org-type">SIG_KERNEL_STOP_MASK</span><span class="org-parenthesis">,</span> &amp;t-&gt;pending<span class="org-parenthesis">)</span>;
        <span class="org-function-name">signal_wake_up</span><span class="org-parenthesis">(</span><span class="org-type">t</span><span class="org-parenthesis">,</span> 1<span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">do_exit &#19981;&#20250;&#36820;&#22238;, &#25152;&#20197;&#21518;&#38754;&#30340; handle_signal &#24182;&#19981;&#20250;&#25191;&#34892;</span>
    <span class="org-function-name">do_exit</span><span class="org-parenthesis">(</span><span class="org-type">exit_code</span><span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000028" class="outline-5">
<h5 id="org0000028"><span class="section-number-5">1.4.1.2.</span> handle_signal</h5>
<div class="outline-text-5" id="text-1-4-1-2">
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">handle_signal</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> <span class="org-type">info</span><span class="org-parenthesis">,</span> <span class="org-type">ka</span><span class="org-parenthesis">,</span> ...<span class="org-parenthesis">)</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26368;&#21021;&#24212;&#29992;&#36890;&#36807; sigaction &#26102;&#20351;&#29992;&#20102; SA_SIGINFO &#36825;&#20010; flag, &#34920;&#31034;&#19978;&#23618;&#30340;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">handler &#25191;&#34892;&#26102;&#38656;&#35201;&#25343;&#21040; siginfo &#20449;&#24687;, kernel &#38656;&#35201;&#35843;&#29992; sigaction &#26102;&#27880;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20876;&#30340; sa_sigaction &#22238;&#35843;, &#32780;&#19981;&#26159; sa_handler.</span>
  <span class="org-comment-delimiter">//</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sa_sigaction &#22238;&#35843;&#30340;&#21407;&#22411;&#20026;:</span>
  <span class="org-comment-delimiter">//</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">void (sa_action *) (int signr, siginfo_t * info, void *)</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>ka-&gt;sa.sa_flags &amp; SA_SIGINFO<span class="org-parenthesis">)</span>:
    setup_rt_frame<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> ka<span class="org-parenthesis">,</span> info<span class="org-parenthesis">,</span> oldset<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">)</span>;
  <span class="org-keyword">else</span>:
    setup_frame<span class="org-parenthesis">(</span>sig<span class="org-parenthesis">,</span> ka<span class="org-parenthesis">,</span> oldset<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org000002c" class="outline-5">
<h5 id="org000002c"><span class="section-number-5">1.4.1.3.</span> setup_frame</h5>
<div class="outline-text-5" id="text-1-4-1-3">

<div id="org000002b" class="figure">
<p><img src="../extra/kernel_signal_frame.png" alt="kernel_signal_frame.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">setup_frame</span>:
  <span class="org-keyword">struct</span> <span class="org-type">sigframe</span> <span class="org-variable-name">__user</span> *frame;
  frame = get_sigframe<span class="org-parenthesis">(</span>ka<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">,</span> <span class="org-keyword">sizeof</span><span class="org-parenthesis">(</span>*frame<span class="org-parenthesis">))</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#22312; user mode stack &#19978;&#21521;&#19979;&#25193;&#23637;&#20986;&#19968;&#22359;&#21306;&#22495;, &#23384;&#25918; sigframe</span>
    esp = regs-&gt;esp;
    <span class="org-keyword">return</span> <span class="org-parenthesis">(</span><span class="org-type">void</span> <span class="org-variable-name">__user</span> *<span class="org-parenthesis">)((</span>esp - frame_size<span class="org-parenthesis">)</span> &amp; -8ul<span class="org-parenthesis">)</span>;

  <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span><span class="org-type">sig</span><span class="org-parenthesis">,</span> &amp;frame-&gt;sig<span class="org-parenthesis">)</span>;
  setup_sigcontext<span class="org-parenthesis">(</span>&amp;frame-&gt;sc<span class="org-parenthesis">,</span> &amp;frame-&gt;fpstate<span class="org-parenthesis">,</span> regs<span class="org-parenthesis">,</span> set-&gt;sig[0]<span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558; regs &#20013;&#21407;&#22987;&#20869;&#23481;&#20445;&#23384;&#22312; sigframe &#30340; sigcontext &#20013;, &#22240;&#20026;&#21518;&#38754; regs</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20013;&#30340;&#20869;&#23481;&#20250;&#34987;&#26367;&#25442;&#20026; sa_handler &#23545;&#24212;&#30340;&#37096;&#20998;</span>
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;edi<span class="org-parenthesis">,</span> &amp;sc-&gt;edi<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;esi<span class="org-parenthesis">,</span> &amp;sc-&gt;esi<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;ebp<span class="org-parenthesis">,</span> &amp;sc-&gt;ebp<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;esp<span class="org-parenthesis">,</span> &amp;sc-&gt;esp<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;ebx<span class="org-parenthesis">,</span> &amp;sc-&gt;ebx<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;edx<span class="org-parenthesis">,</span> &amp;sc-&gt;edx<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;ecx<span class="org-parenthesis">,</span> &amp;sc-&gt;ecx<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;eax<span class="org-parenthesis">,</span> &amp;sc-&gt;eax<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;eip<span class="org-parenthesis">,</span> &amp;sc-&gt;eip<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;xcs<span class="org-parenthesis">,</span> <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">__user</span> *<span class="org-parenthesis">)</span>&amp;sc-&gt;cs<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;eflags<span class="org-parenthesis">,</span> &amp;sc-&gt;eflags<span class="org-parenthesis">)</span>;
    <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span>regs-&gt;esp<span class="org-parenthesis">,</span> &amp;sc-&gt;esp_at_signal<span class="org-parenthesis">)</span>;

  restorer = &amp;__kernel_sigreturn;
  <span class="org-function-name">__put_user</span><span class="org-parenthesis">(</span><span class="org-type">restorer</span><span class="org-parenthesis">,</span> &amp;frame-&gt;pretcode<span class="org-parenthesis">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#37324;&#23545; regs &#37325;&#26032;&#36171;&#20540;, &#24403; do_signal &#36820;&#22238;&#21518; iret &#20250;&#36127;&#36131;&#29992; regs &#24674;&#22797;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">user space &#30340;&#19978;&#19979;&#25991;, &#23548;&#33268; user space &#20250;&#36339;&#36716;&#21040; sa_handler, &#24182;&#19988;&#21442;&#25968;&#20026;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sig, esp &#20026; frame.</span>
  <span class="org-comment-delimiter">//   </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#25152;&#20197;, sa_handler &#22312; user mode &#25191;&#34892;&#26102; stack &#30340;&#24067;&#23616; (&#20174;&#39640;&#21040;&#20302;) &#20026;:</span>
  <span class="org-comment-delimiter">//   </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">..</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sigcontext</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sig</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span class="org-comment-delimiter">//   </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#20026; x86 &#40664;&#35748;&#20351;&#29992;&#26632;&#26469;&#20256;&#36882;&#21442;&#25968;, &#25152;&#20197; sa_handler &#25191;&#34892;&#26102;&#31532;&#19968;&#20010;&#21442;&#25968; signr</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#19982;&#26632;&#19978;&#30340; sig &#26159;&#23545;&#24212;&#30340; // &#36825;&#37324;&#23545; regs &#37325;&#26032;&#36171;&#20540;, &#24403; do_signal &#36820;&#22238;&#21518;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">iret &#20250;&#36127;&#36131;&#29992; regs &#24674;&#22797; user space &#30340;&#19978;&#19979;&#25991;, &#23548;&#33268; user space &#20250;&#36339;&#36716;&#21040;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sa_handler, &#24182;&#19988;&#21442;&#25968;&#20026; sig, esp &#20026; frame.</span>
  <span class="org-comment-delimiter">//   </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#25152;&#20197;, &#21442;&#32771; sigframe &#30340;&#23450;&#20041;, sa_handler &#22312; user mode &#25191;&#34892;&#26102; stack &#30340;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#24067;&#23616; (&#20174;&#39640;&#21040;&#20302;) &#20026;:</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">--high  </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">..</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sigcontext</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sig</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">--low</span>
  <span class="org-comment-delimiter">//     </span>
  regs-&gt;esp = <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> frame;
  regs-&gt;eip = <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> ka-&gt;sa.sa_handler;
  <span class="org-comment-delimiter">// </span><span class="org-comment">x86 &#40664;&#35748;&#20351;&#29992;&#26632;&#26469;&#20256;&#36882;&#21442;&#25968;, &#36825;&#37324;&#24182;&#19981;&#26126;&#30830;&#35774;&#32622; eax &#30340;&#30446;&#30340;...</span>
  regs-&gt;eax = <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> sig;
  regs-&gt;edx = <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> 0;
  regs-&gt;ecx = <span class="org-parenthesis">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-parenthesis">)</span> 0;
  regs-&gt;xcs = __USER_CS;
</pre>
</div>

<p>
setup_rt_frame 和 setup_frame 基本相同, 只不过它会在栈上额外设置一个
siginfo 的指针.
</p>
</div>
</div>

<div id="outline-container-org0000001" class="outline-5">
<h5 id="org0000001"><span class="section-number-5">1.4.1.4.</span> __kernel_sigreturn</h5>
<div class="outline-text-5" id="text-1-4-1-4">
<p>
sa_handler 执行结束后, 按照 c 默认的调用约定和前面描述的栈布局, 会跳转到 __kernel_sigreturn 函数, __kernel_sigreturn 函数是保存在 vsyscall
page 中的一个函数, 所以应用可以直接访问, 关于 vsyscall page, 参考

</p>

<p>
通过将 vsyscall page dump 到本地并反汇编, 能看到 __kernel_sigreturn 的代码如下:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">pop</span> <span class="org-keyword">%eax</span>
<span class="org-function-name">mov</span> <span class="org-keyword">$0x77</span><span class="org-parenthesis">,</span><span class="org-variable-name">%eax</span>
<span class="org-function-name">int</span> <span class="org-keyword">$0x80</span>
</pre>
</div>

<p>
可见它会调用 sys_sigreturn 这个系统调用
</p>

<p>
显然 sys_sigreturn 需要完成以下的任务: 从 sigframe-&gt;sc 中恢复旧的 regs
以便 user mode 能返回到被 sa_handler 打断的位置.
</p>


<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">sys_sigreturn</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20026;&#20160;&#20040;&#26159; regs-&gt;esp - 8?</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26681;&#25454;&#21069;&#38754;&#25551;&#36848;&#30340; sa_handler &#30340;&#26632;&#24067;&#23616;:</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">--high</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sigcontext</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">sig</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">pretcode (__kernel_sigreturn)  &lt;-- esp</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">--low</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#24403; sa_handler &#32467;&#26463;&#26102;&#35843;&#29992; ret &#20043;&#21069;, esp &#26159;&#25351;&#21521; __kernel_sigreturn &#30340;,</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20063;&#23601;&#26159; sigframe. ret &#25351;&#20196;&#20250;&#23548;&#33268; esp + 4, &#28982;&#21518; __kernel_sigreturn &#30340;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#31532;&#19968;&#21477;&#26159; pop %eax, &#23548;&#33268; esp &#20877;&#27425; + 4, &#27492;&#21518;&#36890;&#36807; int 0x80 &#36827;&#20837; syscall</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#23548;&#33268;&#24403;&#21069;&#30340; esp &#24050;&#32463;&#20559;&#31163; sigframe 8 &#23383;&#33410;, &#25152;&#20197;&#36825;&#37324;&#38656;&#35201; -8 ... &#33267;&#20110;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">__kernel_sigreturn &#20026;&#21861;&#20250; pop %eax &#19981;&#28165;&#26970;...</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#24212;&#20110; sys_rt_sigreturn &#30340; __kernel_rt_sigreturn &#24182;&#27809;&#26377;&#36825;&#20010; pop &#25805;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20316;, &#25152;&#20197; sys_rt_sigreturn &#33719;&#24471; sigframe &#26102;&#21482;&#38656;&#35201; - 4    </span>
  <span class="org-keyword">struct</span> <span class="org-type">sigframe</span> <span class="org-variable-name">__user</span> *frame = <span class="org-parenthesis">(</span><span class="org-keyword">struct</span> <span class="org-type">sigframe</span> <span class="org-variable-name">__user</span> *<span class="org-parenthesis">)(</span>regs-&gt;esp - 8<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20351;&#29992; frame-&gt;sc &#24674;&#22797;&#26087;&#30340; regs  </span>
  <span class="org-function-name">restore_sigcontext</span><span class="org-parenthesis">(</span><span class="org-type">regs</span><span class="org-parenthesis">,</span> &amp;frame-&gt;sc<span class="org-parenthesis">,</span> &amp;eax<span class="org-parenthesis">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000033" class="outline-5">
<h5 id="org0000033"><span class="section-number-5">1.4.1.5.</span> 观察 sigframe</h5>
<div class="outline-text-5" id="text-1-4-1-5">
<p>
测试程序:
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;signal.h&gt;</span>

<span class="org-type">void</span> * <span class="org-function-name">foo</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">signr</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>

<span class="org-parenthesis">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span><span class="org-parenthesis">,</span> <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[]<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    signal<span class="org-parenthesis">(</span>10<span class="org-parenthesis">,</span> foo<span class="org-parenthesis">)</span>;
    sleep<span class="org-parenthesis">(</span>1000<span class="org-parenthesis">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-parenthesis">}</span>

</pre>
</div>

<p>
使用 gdb 分析的过程:
</p>

<pre class="example" id="org0000032">
$&gt; gcc -O0 -g test.c -m32
$&gt; gdb ./a.out
(gdb) b main
(gdb) b foo
(gdb) r
Starting program: /home/sunway/a.out 

Breakpoint 1, main (argc=1, argv=0xffffc454) at test.c:8
8           signal(10, foo);
(gdb) n
9           sleep(1000);
(gdb) n

# 在这里使用 kill -10 &lt;pid&gt; 给 a.out 发送一个信号, 导致 sleep 系统调用
# 被打断而提前返回, 但这里的 "提前返回" 并不是指此时控制已经返回到
# sleep 之后的代码 (0xf7fd8d49), 因为在返回 sleep 之后的代码前,
# sa_handler 需要先被执行  

Program received signal SIGUSR1, User defined signal 1.
0xf7fd8d49 in __kernel_vsyscall ()

(gdb) n
Single stepping until exit from function __kernel_vsyscall,
which has no line number information.
foo (signr=10) at test.c:3
3       void * foo(int signr) {

(gdb) x /20x $esp
0xffffbd6c:     0xf7fd8d20      0x0000000a      0x00000063      0x00000000
0xffffbd7c:     0x0000002b      0x0000002b      0xffffc368      0xf7fd4240
0xffffbd8c:     0x00000000      0xffffc32c      0xffffc368      0x7fffffff
0xffffbd9c:     0xffffc368      0xfffffffc      0x00000001      0x00000000
0xffffbdac:     0xf7fd8d49      0x00000023      0x00000246      0xffffc32c

# 按照 setup_frame 设定的栈布局:
# 
# 1. 栈顶的 0xf7fd8d20 即是位于 vsyscall page 的 __kernel_sigreturn
# 2. 0x0000000a 是 signr
# 3. 从 0x00000063 开始后面对应的数据是 sigcontext 中的内容, 其中
#    0xffffbdac 处保存的 0xf7fd8d49 对应于 sigcontext-&gt;eip, 它和前面
#    sleep 被提前打断时显示的 eip 是一致的, 都对应于 __kernel_vsyscall

(gdb) disass 0xf7fd8d20
Dump of assembler code for function __kernel_sigreturn:
   0xf7fd8d20 &lt;+0&gt;:     pop    %eax
   0xf7fd8d21 &lt;+1&gt;:     mov    $0x77,%eax
   0xf7fd8d26 &lt;+6&gt;:     int    $0x80
   0xf7fd8d28 &lt;+8&gt;:     nop
End of assembler dump.

(gdb) disass 0xf7fd8d49
Dump of assembler code for function __kernel_vsyscall:
   0xf7fd8d40 &lt;+0&gt;:     push   %ecx
   0xf7fd8d41 &lt;+1&gt;:     push   %edx
   0xf7fd8d42 &lt;+2&gt;:     push   %ebp
   0xf7fd8d43 &lt;+3&gt;:     mov    %esp,%ebp
   0xf7fd8d45 &lt;+5&gt;:     sysenter
   // 这里的 int $0x80 是什么意思? 和
   // [[file:process.org::*sysenter,%20syscall,%20vsyscall][sysenter,
   // syscall, vsyscall]] 中 dump 的 __kernel_vsyscall 不一样...     
   0xf7fd8d47 &lt;+7&gt;:     int    $0x80
   0xf7fd8d49 &lt;+9&gt;:     pop    %ebp
   0xf7fd8d4a &lt;+10&gt;:    pop    %edx
   0xf7fd8d4b &lt;+11&gt;:    pop    %ecx
   0xf7fd8d4c &lt;+12&gt;:    ret    
End of assembler dump.
</pre>
</div>
</div>

<div id="outline-container-org0000036" class="outline-5">
<h5 id="org0000036"><span class="section-number-5">1.4.1.6.</span> sigaltstack</h5>
<div class="outline-text-5" id="text-1-4-1-6">
<p>
一般情况下 sigframe 都是在 user stack, 但由于 user stack 一般较小, 若
user stack 已满怎么办?
</p>

<p>
可以通过 sigaltstack 通知 kernel 在另一块区域上建立 sigframe, 凡是
sa_flags 中包含 SA_ONSTACK 的 signal 都会使用 altstack (alternative
stack)
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org000004e" class="outline-3">
<h3 id="org000004e"><span class="section-number-3">1.5.</span> 相关的系统调用</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org000003f" class="outline-4">
<h4 id="org000003f"><span class="section-number-4">1.5.1.</span> kill, tkill, tgkill</h4>
</div>

<div id="outline-container-org0000042" class="outline-4">
<h4 id="org0000042"><span class="section-number-4">1.5.2.</span> signal, sigaction</h4>
</div>

<div id="outline-container-org0000045" class="outline-4">
<h4 id="org0000045"><span class="section-number-4">1.5.3.</span> sigsuspend</h4>
</div>

<div id="outline-container-org0000048" class="outline-4">
<h4 id="org0000048"><span class="section-number-4">1.5.4.</span> sigpending</h4>
</div>

<div id="outline-container-org000004b" class="outline-4">
<h4 id="org000004b"><span class="section-number-4">1.5.5.</span> sigprocmask</h4>
</div>
</div>

<div id="outline-container-org000005a" class="outline-3">
<h3 id="org000005a"><span class="section-number-3">1.6.</span> Appendix</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org0000051" class="outline-4">
<h4 id="org0000051"><span class="section-number-4">1.6.1.</span> 系统调用的中断与重启</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
<a href="https://github.com/mozilla/rr/wiki/Linux-signals">https://github.com/mozilla/rr/wiki/Linux-signals</a>
</p>

<p>
有一些系统调用会导致 kernel 进入 TASK_INTERRUPTIBLE 状态, 例如:
</p>

<ol class="org-ol">
<li>nanosleep</li>

<li>针对 pipe 的 read, write</li>

<li>wait 类的调用</li>
</ol>

<p>
但发生信号时, kernel 会通过 signal_wake_up 强制将处理
TASK_INTERRUPTIBLE 状态的进程唤醒, 但此时它们等待的事件并没有完成, 却直接走到了之前造成阻塞的指令的下一条指令, 即结果 syscall 就被打断了.
</p>

<p>
以 pipe read 为例:
</p>

<ol class="org-ol">
<li><p>
用户发起 pipe read 并被信号打断
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">pipe_readv</span>:
  <span class="org-keyword">for</span> <span class="org-parenthesis">(</span>;;<span class="org-parenthesis">)</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">pipe &#30340; read &#25805;&#20316;&#38459;&#22622;, &#31561;&#24453; writer &#21521; pipe &#20889;&#25968;&#25454;</span>
    PIPE_WAITING_WRITERS<span class="org-parenthesis">(</span>*inode<span class="org-parenthesis">)</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20551;&#35774;&#38459;&#22622;&#36807;&#31243;&#20013;&#26377;&#20449;&#21495;&#21457;&#29983;, &#24403;&#21069;&#36827;&#31243;&#34987;&#21796;&#37266;, &#21017; PIPE_WAITING_WRITERS</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#20250;&#30452;&#25509;&#36820;&#22238;, &#25191;&#34892;&#19979;&#19968;&#26465;&#25351;&#20196; (signal_pending)</span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">signal_pending &#20026;&#30495;, &#35828;&#26126;&#24403;&#21069;&#36827;&#31243;&#26377; pending signal, &#21017;&#35828;&#26126;&#26159;&#20449;&#21495;&#21796;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#37266;&#20102;&#24403;&#21069;&#36827;&#31243;, &#21017; syscall &#25552;&#21069;&#36820;&#22238; -ERESTARTSYS</span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#30001;&#20110; syscall &#36820;&#22238;&#21518; (&#20294;&#22312;&#35843;&#29992; do_signal &#20043;&#21069;) &#20250;&#23558;&#36820;&#22238;&#20540; (eax) &#25918;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#22312; pt_regs &#20013;, &#21518;&#32493; do_signal &#21487;&#20197;&#26681;&#25454; pt_regs-&gt;eax &#30693;&#36947;&#34987;&#25171;&#26029;&#30340;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">syscall &#20851;&#20110;&#37325;&#21551;&#30340;&#24847;&#22270;: &#36820;&#22238; EINTR &#30001;&#19978;&#23618;&#37325;&#21551; syscall, &#25110;&#30001; kernel</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#30452;&#25509;&#36890;&#36807;&#35774;&#32622; ip &#33258;&#21160;&#37325;&#21551; syscall    </span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>signal_pending<span class="org-parenthesis">(</span>current<span class="org-parenthesis">))</span>:
      ret = -ERESTARTSYS;
      <span class="org-keyword">break</span>;
</pre>
</div></li>

<li><p>
handle_signal
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-constant">handle_signal</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#24403;&#21069;&#26159;&#19968;&#20010; syscall  </span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>regs-&gt;orig_eax &gt;= 0<span class="org-parenthesis">)</span>:
    <span class="org-keyword">switch</span> <span class="org-parenthesis">(</span>regs-&gt;eax<span class="org-parenthesis">)</span>:
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509;&#34987;&#25171;&#26029;&#30340; syscall &#36820;&#22238; ERESTART_RESTARTBLOCK &#25110; ERESTARTNOHAND,</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#21017;&#30452;&#25509;&#23545;&#19978;&#23618;&#36820;&#22238; EINTR, &#30001;&#19978;&#23618;&#20915;&#23450;&#26159;&#21542;&#37325;&#21551; syscall</span>
      <span class="org-comment-delimiter">// </span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">&#33509; syscall &#36820;&#22238; ERESTARTSYS, &#21017;&#26681;&#25454; sigaction &#26159;&#21542;&#25351;&#23450;&#20102;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">SA_RESTART &#20915;&#23450;&#26159;&#36820;&#22238; EINTR &#36824;&#26159;&#36890;&#36807;&#20462;&#25913; eip &#21644; eax &#30452;&#25509;&#30001;</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">kernel &#26469;&#37325;&#21551; syscall        </span>
      <span class="org-keyword">case</span> -ERESTART_RESTARTBLOCK:
      <span class="org-keyword">case</span> -ERESTARTNOHAND:
        regs-&gt;eax = -EINTR;
        <span class="org-keyword">break</span>;

      <span class="org-keyword">case</span> -ERESTARTSYS:
        <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span><span class="org-parenthesis">(</span>ka-&gt;sa.sa_flags &amp; SA_RESTART<span class="org-parenthesis">))</span>:
          regs-&gt;eax = -EINTR;
          <span class="org-keyword">break</span>;

      <span class="org-comment-delimiter">/* </span><span class="org-comment">fallthrough</span><span class="org-comment-delimiter"> */</span>
      <span class="org-keyword">case</span> -ERESTARTNOINTR:
        regs-&gt;eax = regs-&gt;orig_eax;
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#19981;&#35770; int 0x80 &#25110; sysenter, &#25351;&#20196;&#38271;&#24230;&#37117;&#26159; 2 bytes             </span>
        regs-&gt;eip -= 2;
  <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
  setup_frame
</pre>
</div></li>
</ol>

<p>
编程时需要考虑 syscall 被信号打断的情况时, 一般使用如下的代码:
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">do</span> <span class="org-parenthesis">{</span>
    rc = <span class="org-parenthesis">(</span><span class="org-type">int</span><span class="org-parenthesis">)</span>the_sys_call<span class="org-parenthesis">()</span>;
<span class="org-parenthesis">}</span> <span class="org-keyword">while</span><span class="org-parenthesis">(</span>rc &lt; 0 &amp;&amp; errno == EINTR<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000054" class="outline-4">
<h4 id="org0000054"><span class="section-number-4">1.6.2.</span> 信号与 longjmp</h4>
<div class="outline-text-4" id="text-1-6-2">
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;setjmp.h&gt;</span>

<span class="org-type">jmp_buf</span> <span class="org-variable-name">buff</span>;

<span class="org-type">void</span> <span class="org-function-name">foo</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">sig</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    printf<span class="org-parenthesis">(</span><span class="org-string">"foo\n"</span><span class="org-parenthesis">)</span>;
    longjmp<span class="org-parenthesis">(</span>buff<span class="org-parenthesis">,</span> 1<span class="org-parenthesis">)</span>;
<span class="org-parenthesis">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-parenthesis">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span><span class="org-parenthesis">,</span> <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[]<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">x</span> = setjmp<span class="org-parenthesis">(</span>buff<span class="org-parenthesis">)</span>;
    signal<span class="org-parenthesis">(</span>11<span class="org-parenthesis">,</span> foo<span class="org-parenthesis">)</span>;
    printf<span class="org-parenthesis">(</span><span class="org-string">"hello %d\n"</span><span class="org-parenthesis">,</span> x<span class="org-parenthesis">)</span>;
    sleep<span class="org-parenthesis">(</span>20<span class="org-parenthesis">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-parenthesis">}</span>
</pre>
</div>

<p>
由于 longjmp 不会返回, 所以栈上的 __kernel_sigreturn 并不会被调用, 所以 longjmp 后不会再返回到被信号打断的位置.
</p>
</div>
</div>

<div id="outline-container-org0000057" class="outline-4">
<h4 id="org0000057"><span class="section-number-4">1.6.3.</span> 信号与线程</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
通过 fork 时的 copy_process 代码, 可以看到:
</p>

<ol class="org-ol">
<li>p-&gt;sighand 是共享的, 任何一个线程里修改了 sighand 都会影响到其它线程</li>

<li>p-&gt;blocked 在各个线程中是独立的, 所以 sigprocmask 只会影响当前的线程</li>

<li>p-&gt;pending 是独立的</li>

<li>p-&gt;shared_pending 是共享的</li>
</ol>
</div>
</div>
</div>
</div>


<div id="outline-container-org0000060" class="outline-2 references">
<h2 id="org0000060">Backlinks</h2>
<div class="outline-text-2" id="text-org0000060">
<p>
<a href="../toolchain/risu.html#ID-34243b6c-ab57-4f83-9a5a-3cabc961fa7f">RISU</a>
(<i>RISU &gt; Implementation details &gt; risu.c</i>):  1. master 和 apprentice 通信 2. 通过 sighandler 触发通信和检查, 并且用 sighandler 的 ucontext 读写寄存器 (参    考 <a href="signal.html#ID-94de6f9d-a533-44a4-90ad-d74824f8b1d8">kernel signal</a>, <a href="salsa_signal.html#ID-0847680b-f40d-4363-96bf-b03ea98564af">signal handling in DBT</a>) 3. 检查寄存器, 内存是否一致
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway@dogdog.run<br />
Date: 2016-08-10 Wed 00:00<br />
Last updated: 2023-01-10 Tue 17:48</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</div>
</body>
</html>