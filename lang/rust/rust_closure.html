<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 19:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rust Closure</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Rust Closure</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgaef8c0f">1. Rust Closure</a>
<ul>
<li><a href="#orge086220">1.1. function</a></li>
<li><a href="#org84468cf">1.2. closure</a>
<ul>
<li><a href="#org4ce90c0">1.2.1. memory layout</a></li>
<li><a href="#org182799a">1.2.2. closure 的类型</a></li>
</ul>
</li>
<li><a href="#org0f41cf6">1.3. Fn trait</a></li>
<li><a href="#org2e11b54">1.4. move</a></li>
<li><a href="#org696cee0">1.5. Fn, FnMut, FnOnce</a>
<ul>
<li><a href="#org16857d4">1.5.1. FnOnce</a></li>
<li><a href="#orge043cb8">1.5.2. FnMut</a></li>
<li><a href="#org095d8b0">1.5.3. Fn</a></li>
<li><a href="#org037c693">1.5.4. trait bound</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgaef8c0f" class="outline-2">
<h2 id="orgaef8c0f"><span class="section-number-2">1</span> Rust Closure</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orge086220" class="outline-3">
<h3 id="orge086220"><span class="section-number-3">1.1</span> function</h3>
<div class="outline-text-3" id="text-1-1">
<p>
function 是 first class object, 当函数作为参数, 返回值, 变量等情况下, 实际上使用的是函数指针, 其类型为 fn(args)-&gt;(return).
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span><span style="color: #757575;">()</span> <span style="color: #757575;">{}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">call</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f</span>: <span style="color: #859900;">fn</span><span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"call:"</span><span style="color: #757575;">)</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"f is at </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>f <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _<span style="color: #757575;">)</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"which point to </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> <span style="color: #757575;">())</span>;
    <span style="color: #cb4b16; font-weight: bold;">unsafe</span> <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"also 0x</span><span style="color: #2aa198; font-style: italic;">{:x}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> *<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _ <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> <span style="color: #b58900;">i64</span><span style="color: #757575;">))</span>;
    <span style="color: #757575;">}</span>

    f<span style="color: #757575;">()</span>;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"main:"</span><span style="color: #757575;">)</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"test is at </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> test <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> <span style="color: #757575;">())</span>;
    call<span style="color: #757575;">(</span>test<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
main:
test is at 0x55e8be0037b0
call:
f is at 0x7ffed8b99f40
which point to 0x55e8be0037b0
also 0x55e8be0037b0
</p>
</div>
</div>

<div id="outline-container-org84468cf" class="outline-3">
<h3 id="org84468cf"><span class="section-number-3">1.2</span> closure</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org4ce90c0" class="outline-4">
<h4 id="org4ce90c0"><span class="section-number-4">1.2.1</span> memory layout</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
closure 分为两种情况:
</p>
<ol class="org-ol">
<li>当 closure 不需要 capture 时, 和普通函数相同.</li>
<li>当 closure 需要 capture 时, 需要占用额外的空间保存 capture 的数据</li>
</ol>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"\nmove ---------------"</span><span style="color: #757575;">)</span>;
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = 0xffi64;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"x is at </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>x <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">move</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">foo_move</span> = <span style="color: #859900;">move</span> || <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"size of foo: </span><span style="color: #2aa198; font-style: italic;">{}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #268bd2; font-weight: bold;">mem</span>::size_of_val<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>foo_move<span style="color: #757575;">))</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"foo_move is at </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>foo_move <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _<span style="color: #757575;">)</span>;
    <span style="color: #cb4b16; font-weight: bold;">unsafe</span> <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span>
            <span style="color: #2aa198;">"foo_move val is </span><span style="color: #2aa198; font-style: italic;">{:x}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span>
            *<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>foo_move <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _ <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> <span style="color: #b58900;">i64</span><span style="color: #757575;">)</span>
        <span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">borrow</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"\nborrow ---------------"</span><span style="color: #757575;">)</span>;
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">foo_borrow</span> = || <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"size of foo_borrow: </span><span style="color: #2aa198; font-style: italic;">{}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #268bd2; font-weight: bold;">mem</span>::size_of_val<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>foo_borrow<span style="color: #757575;">))</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"foo_borrow is at </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>foo_borrow <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _<span style="color: #757575;">)</span>;
    <span style="color: #cb4b16; font-weight: bold;">unsafe</span> <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span>
            <span style="color: #2aa198;">"foo_borrow val is </span><span style="color: #2aa198; font-style: italic;">{:x}</span><span style="color: #2aa198;">, whic is &amp;x"</span><span style="color: #757575;">,</span>
            *<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>foo_borrow <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> _ <span style="color: #859900;">as</span> *<span style="color: #859900;">const</span> <span style="color: #b58900;">i64</span><span style="color: #757575;">)</span>
        <span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
move ----------&#x2013;&#x2014;
x is at 0x7ffeab13ce88
size of foo: 8
foo_move is at 0x7ffeab13cee8
foo_move val is ff
</p>

<p>
borrow ----------&#x2013;&#x2014;
size of foo_borrow: 8
foo_borrow is at 0x7ffeab13d020
foo_borrow val is 7ffeab13ce88, whic is &amp;x
</p>

<p>
closure 对应的 code 并不需要包含在 closure 中, 因为每个 closure 都是不同的类型,
编译器知道每个 closure 对应的 code 在哪里. 
</p>
</div>
</div>

<div id="outline-container-org182799a" class="outline-4">
<h4 id="org182799a"><span class="section-number-4">1.2.2</span> closure 的类型</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#![feature</span><span style="color: #757575;">(</span><span style="color: #268bd2;">core_intrinsics</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">fn</span> <span style="color: #268bd2;">type_of</span>&lt;<span style="color: #b58900;">T</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">_</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">T</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">str</span> <span style="color: #757575;">{</span>
    <span style="color: #cb4b16; font-weight: bold;">unsafe</span> <span style="color: #757575;">{</span> <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #268bd2; font-weight: bold;">intrinsics</span>::type_name::&lt;<span style="color: #b58900;">T</span>&gt;<span style="color: #757575;">()</span> <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span><span style="color: #757575;">()</span> -&gt; <span style="color: #757575;">()</span> <span style="color: #757575;">{}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">foo</span> = || <span style="color: #757575;">{}</span>;
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">bar</span> = || <span style="color: #757575;">{}</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"type of foo: </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> type_of<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>foo<span style="color: #757575;">))</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"type of bar: </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> type_of<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>bar<span style="color: #757575;">))</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"type of test: </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> type_of<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>test<span style="color: #757575;">))</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
type of foo: "[closure@src/main.rs:10:15: 10:20]"
type of bar: "[closure@src/main.rs:11:15: 11:20]"
type of test: "fn() {test}"
</p>
</div>
</div>
</div>

<div id="outline-container-org0f41cf6" class="outline-3">
<h3 id="org0f41cf6"><span class="section-number-3">1.3</span> Fn trait</h3>
<div class="outline-text-3" id="text-1-3">
<p>
closure 无法做为函数的参数和返回值等, 因为:
</p>

<ol class="org-ol">
<li>closure 都是动态生成的类型, 无法写在函数的 signature 里, 只能依靠编译器的类型推导 (c++ 的 auto 关键字解决类似的问题)</li>

<li>closure 的大小是不确定的, 同样 signature 的 closure, 会因为 capture 的不同导致不同的大小, 所以无法通过类似 `fn()-&gt;()` 来指示 closure 的类型</li>
</ol>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">call</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f</span>: <span style="color: #859900;">fn</span><span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
    f<span style="color: #757575;">()</span>;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span><span style="color: #757575;">()</span> <span style="color: #757575;">{}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">OK, &#27809;&#26377; capture &#30340; closure &#21487;&#20197; coerce &#20026; fn()</span>
    call<span style="color: #757575;">(</span>|| <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"hello"</span><span style="color: #757575;">)</span>;
    <span style="color: #757575;">})</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">OK</span>
    call<span style="color: #757575;">(</span>test<span style="color: #757575;">)</span>;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">WRONG, &#38656;&#35201; capture &#30340; closure &#26080;&#27861; coerce &#20026; fn()</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">error[E0308]: mismatched types</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">--&gt; src/main.rs:19:10</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">|</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">19 |       call(|| {</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">|  __________^</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">20 | |         println!("{:?}", x);</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">21 | |     })</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">| |_____^ expected fn pointer, found closure</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">|</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">= note: expected type `fn()`</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = 1;
    call<span style="color: #757575;">(</span>|| <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    <span style="color: #757575;">})</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
解决方法是使用 Fn trait, 因为 closure, fn 都会 impl Fn trait
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">call</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #859900;">dyn</span> <span style="color: #b58900;">Fn</span><span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
    f<span style="color: #757575;">()</span>;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"normal fn"</span><span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    call<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>test<span style="color: #757575;">)</span>;

    call<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>|| <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"uncaptured closure"</span><span style="color: #757575;">)</span>;
    <span style="color: #757575;">})</span>;

    <span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = 1;
    call<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>|| <span style="color: #757575;">{</span>
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"captured closure: </span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    <span style="color: #757575;">})</span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e11b54" class="outline-3">
<h3 id="org2e11b54"><span class="section-number-3">1.4</span> move</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">call</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f</span>: <span style="color: #859900;">impl</span> <span style="color: #b58900;">Fn</span><span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
    f<span style="color: #757575;">()</span>
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span> = <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = <span style="color: #2aa198;">"hello"</span>.to_owned<span style="color: #757575;">()</span>;
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">ret</span> = <span style="color: #859900;">move</span> || <span style="color: #757575;">{</span>
            <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
        <span style="color: #757575;">}</span>;
        <span style="color: #586e75;">// </span><span style="color: #586e75;">error[E0382]: borrow of moved value: `x`</span>
        <span style="color: #586e75;">// </span><span style="color: #586e75;">println!("{:?}", x);</span>
        ret
    <span style="color: #757575;">}</span>;

    call<span style="color: #757575;">(</span>f<span style="color: #757575;">)</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
默认情况下会使用 borrow 的方式 capture 环境变量, 若像上面的例子一样无法 borrow,
则需要显式的指定 move.
</p>

<p>
另外, move 是定义 closure 时 (而非执行时) 把环境变量一次性的 move 到 closure 内的. 后面执行 closure 时不会再发生 move
</p>

<p>
另外, 若 closure 代码会 consume 环境变量, 编译器会自动的 move
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">call</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f</span>: <span style="color: #859900;">impl</span> <span style="color: #b58900;">FnOnce</span><span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
    f<span style="color: #757575;">()</span>
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = <span style="color: #2aa198;">"hello"</span>.to_owned<span style="color: #757575;">()</span>;
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span> = || <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">y</span> = x;
        <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>;
    call<span style="color: #757575;">(</span>f<span style="color: #757575;">)</span>
<span style="color: #757575;">}</span>

<span style="color: #586e75;">// </span><span style="color: #586e75;">error[E0382]: borrow of moved value: `x`</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">--&gt; quickrun:11:22</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">|</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">6  |     let x = "hello".to_owned();</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">|         - move occurs because `x` has type `std::string::String`, which does not implement the `Copy` trait</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">7  |     let f = || {</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">|             -- value moved into closure here</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">8  |         let y = x;</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">|                 - variable moved due to use in closure</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">11 |     println!("{:?}", x);</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">|                      ^ value borrowed here after move</span>
<span style="color: #586e75;">//</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">error: aborting due to previous error</span>
<span style="color: #586e75;">//</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">For more information about this error, try `rustc --explain E0382`.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org696cee0" class="outline-3">
<h3 id="org696cee0"><span class="section-number-3">1.5</span> Fn, FnMut, FnOnce</h3>
<div class="outline-text-3" id="text-1-5">
<p>
所有的 function 都 impl Fn.
</p>

<p>
但对于 closure 来说, 针对 capture 的不同, 编译器会自动 impl Fn, FnMut 或 FnOnce
中的一个.
</p>
</div>

<div id="outline-container-org16857d4" class="outline-4">
<h4 id="org16857d4"><span class="section-number-4">1.5.1</span> FnOnce</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">move</span> || <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">z</span> = x;
<span style="color: #757575;">}</span>;
</pre>
</div>

<p>
这个 closure impl FnOnce, 因为 closure 每次执行时都会 move capture 到的变量, 但这个 move 只能进行一次. 所以 FnOnce 表示 closure 只能执行一次. 
</p>

<p>
只有 move closure 才可能是 FnOnce
</p>
</div>
</div>

<div id="outline-container-orge043cb8" class="outline-4">
<h4 id="orge043cb8"><span class="section-number-4">1.5.2</span> FnMut</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
若 closure 会修改 capture variable, 则它会 impl FnMut
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">let</span> <span style="color: #268bd2;">x</span> = 1;
|| <span style="color: #757575;">{</span>
    x += 1;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
上面的 closure 实际会持有 `&amp;mut x`
</p>
</div>
</div>

<div id="outline-container-org095d8b0" class="outline-4">
<h4 id="org095d8b0"><span class="section-number-4">1.5.3</span> Fn</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
Fn 表示 closure 不会修改 capture variable 且可以执行多次.
</p>
</div>
</div>

<div id="outline-container-org037c693" class="outline-4">
<h4 id="org037c693"><span class="section-number-4">1.5.4</span> trait bound</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
Fn 等作为 trait bound 时有不同的意义:
</p>

<ol class="org-ol">
<li>Fn trait bound 表示需要能执行多次且不修改 capture variable</li>

<li>FnMut trait bound 表示需要能执行多次且`可以`修改 (而不是一定要修改)</li>

<li>FnOnce trait bound 表示不需要能执行多次</li>
</ol>

<p>
所以, Fn -&gt; FnMut -&gt; FnOnce 的要求是依次降低的:
</p>

<ol class="org-ol">
<li>Fn trait bound 无法接受 FnMut 和 FnOnce, 因为它要求能执行多次且不修改</li>

<li>FnMut trait bound 无法接受 FnOnce</li>

<li>FnOnce trait bound 可以接受任何 Fn, FnMut 或 FnOnce</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2019-02-27 三 00:00<br />
Last updated: 2021-09-16 四 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

           <div id="disqus_thread"></div>
           <script>

           (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sunwayforever-github-io.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
           </script>
</div>
</body>
</html>
