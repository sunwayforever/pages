<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-14 五 19:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rust Lifetime</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Rust Lifetime</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga1725e6">1. Rust Lifetime</a>
<ul>
<li><a href="#org045dea1">1.1. dangling reference</a></li>
<li><a href="#org20d9461">1.2. 为什么需要提供 lifetime annotation</a></li>
<li><a href="#org18616af">1.3. lifetime annotation 如何解读</a></li>
<li><a href="#orgc885e1b">1.4. 多个 lifetime</a></li>
<li><a href="#org65b7764">1.5. struct 的 lifetime</a></li>
<li><a href="#org1150c08">1.6. method 的 lifetime</a></li>
<li><a href="#orgb89b45c">1.7. lifetime elision</a></li>
<li><a href="#orgc578ee0">1.8. 总结</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga1725e6" class="outline-2">
<h2 id="orga1725e6"><span class="section-number-2">1</span> Rust Lifetime</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org045dea1" class="outline-3">
<h3 id="org045dea1"><span class="section-number-3">1.1</span> dangling reference</h3>
<div class="outline-text-3" id="text-1-1">
<p>
lifetime 是用来解决 dangling reference 问题:
</p>

<ol class="org-ol">
<li>函数返回一个引用</li>

<li>成员函数返回一个引用</li>

<li>结构体中包含一个引用</li>
</ol>

<p>
这三种引用都有可能因为引用的资源被释放而变成 dangling reference   
</p>
</div>
</div>

<div id="outline-container-org20d9461" class="outline-3">
<h3 id="org20d9461"><span class="section-number-3">1.2</span> 为什么需要提供 lifetime annotation</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> f1;
<span style="color: #757575;">}</span>

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
    get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;

    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
对于上面的代码, 若不考虑 lifetime, 则第一个 get_test 有正确的, 而第二个是错误的,
会导致 f 变成 dangling reference.
</p>

<p>
rust 编译器在编译 main 时, 需要深入到 get_test 的 `实现` 才能确定第二个 get_test
是非法的, 对编译器可能有些困难. 另外, 若 get_test 是以 lib 或 ffi 方式提供, 则编译器根本不可能完成这个任务.
</p>

<p>
因此 rust 要求 get_test 把 ` get_test 会返回 f1 的引用` 的信息通过 lifetime 的方式提供给编译器, 而不是依赖编译器自己分析.
</p>


<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> f1;
<span style="color: #757575;">}</span>

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
    get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;

    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
有了 lifetime 信息, 编译器会发现第二个 get_test 是非法的
</p>
</div>
</div>

<div id="outline-container-org18616af" class="outline-3">
<h3 id="org18616af"><span class="section-number-3">1.3</span> lifetime annotation 如何解读</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> f1;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
`'a` 是一个 lifetime annotation, 它告诉编译器两个含义:
</p>

<ol class="org-ol">
<li><p>
在编译 get_test 时, 返回值只能引用着 f1 , 或者是 'static
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> f2;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
编译失败, 因为返回了 f2 的引用
</p></li>

<li><p>
在编译 get_test 的调用者时, 返回值的 lifetime 需要 &lt;= f1, 因为它 `可能` 引用着 f1
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> f1;
<span style="color: #757575;">}</span>

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
编译失败, 因为 f 的 lifetime 比 f1 小. 
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
虽然 get_test 返回的是 g_test, 但编译 main 时仍然会失败, 因为编译器在编译
main 时只看函数的 lifetime annotation
</p></li>
</ol>
</div>
</div>

<div id="outline-container-orgc885e1b" class="outline-3">
<h3 id="orgc885e1b"><span class="section-number-3">1.4</span> 多个 lifetime</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #859900;">true</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">return</span> f1;
    <span style="color: #757575;">}</span>
    <span style="color: #859900;">return</span> f2;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">,</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
f1, f2 有相同的 lifetime annotation 时,
</p>

<ol class="org-ol">
<li>编译 get_test 时, f1, f2, 'static 都可以返回</li>

<li>编译 main 时, 返回值的 lifetime 需要 &lt;= min(f1,f2)</li>
</ol>
</div>
</div>

<div id="outline-container-org65b7764" class="outline-3">
<h3 id="org65b7764"><span class="section-number-3">1.5</span> struct 的 lifetime</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span>&lt;'<span style="color: #268bd2;">a</span>&gt; <span style="color: #757575;">{</span>
    <span style="color: #268bd2;">s</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span><span style="color: #757575;">,</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
编译 struct Test 相关的代码时, Test lifetime 需要比 s 小.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span>&lt;'<span style="color: #268bd2;">a</span>&gt; <span style="color: #757575;">{</span>
    <span style="color: #268bd2;">s</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span><span style="color: #757575;">,</span>
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">test</span>;
    <span style="color: #757575;">{</span>
        test = <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
            <span style="color: #268bd2;">s</span>: &amp;<span style="color: #2aa198;">"hello"</span>.to_owned<span style="color: #757575;">(),</span>
        <span style="color: #757575;">}</span>
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> test<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
编译失败, 因为 Test 的 lifetime 大于 s
</p>
</div>
</div>

<div id="outline-container-org1150c08" class="outline-3">
<h3 id="org1150c08"><span class="section-number-3">1.6</span> method 的 lifetime</h3>
<div class="outline-text-3" id="text-1-6">
<p>
method 的 lifetime 与 函数的 lifetime 类似, 但由于 method 可以引用 &amp;self 的成员,
所以需要指定一个 annotation 表示 &amp;self
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span>&lt;'<span style="color: #268bd2;">a</span>&gt; <span style="color: #757575;">{</span>
    <span style="color: #268bd2;">s</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span><span style="color: #757575;">,</span>
<span style="color: #757575;">}</span>

<span style="color: #586e75;">// </span><span style="color: #586e75;">'x &#20195;&#34920; Test &#30340; lifetime</span>
<span style="color: #859900;">impl</span>&lt;'<span style="color: #268bd2;">x</span>&gt; <span style="color: #b58900;">Test</span>&lt;'<span style="color: #268bd2;">x</span>&gt; <span style="color: #757575;">{</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">method &#30340; 'x &#34920;&#31034; Test &#30340; lifetime</span>
    <span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_str</span><span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">x</span> <span style="color: #859900;">self</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">x</span> <span style="color: #b58900;">str</span> <span style="color: #757575;">{</span>
        <span style="color: #586e75;">// </span><span style="color: #586e75;">return &amp;"hello".to_owned(); &#20250;&#22833;&#36133;</span>
        <span style="color: #859900;">return</span> <span style="color: #859900;">self</span>.s;
    <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">test</span> = <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span> <span style="color: #268bd2;">s</span>: <span style="color: #2aa198;">"hello"</span> <span style="color: #757575;">}</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#32534;&#35793; main &#26102;&#38656;&#35201;&#30830;&#20445; s &#30340; lifetime &lt;= test</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">s</span> = test.get_str<span style="color: #757575;">()</span>;
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> s<span style="color: #757575;">)</span>;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#32534;&#35793;&#22833;&#36133;, &#22240;&#20026;&#36820;&#22238;&#20540;&#30340; lifetime &gt; test</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">let s;</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">{</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">let test = Test { s: "hello" };</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">s = test.get_str();</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">}</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">println!("{:?}", s);    </span>
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb89b45c" class="outline-3">
<h3 id="orgb89b45c"><span class="section-number-3">1.7</span> lifetime elision</h3>
<div class="outline-text-3" id="text-1-7">
<p>
elision rule 是针对 fn 和 impl 的规则:
</p>

<ol class="org-ol">
<li><p>
函数的每个参数都分配一个 lifetime
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span> <span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span> :<span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">str</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>:<span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">str</span><span style="color: #757575;">)</span>  <span style="color: #757575;">{</span>

<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">test2</span>&lt;'<span style="color: #268bd2;">a</span><span style="color: #757575;">,</span> '<span style="color: #268bd2;">b</span>&gt; <span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span> :<span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">f2</span>:<span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">b</span> <span style="color: #b58900;">str</span><span style="color: #757575;">)</span>  <span style="color: #757575;">{</span>

<span style="color: #757575;">}</span>
</pre>
</div></li>

<li><p>
若只有一个参数, 则所有输出的 lifetime 与参数相同
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span> <span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span> :<span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">str</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">str</span> <span style="color: #757575;">{</span>

<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">test</span>&lt;'<span style="color: #268bd2;">a</span>&gt; <span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span> :<span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">str</span> <span style="color: #757575;">{</span>

<span style="color: #757575;">}</span>
</pre>
</div></li>

<li>若参数包含 &amp;self, 则所有输出的 lifetime 与 self 相同</li>
</ol>

<p>
有时 lifetime elision 并不是我们想要的:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>

</pre>
</div>

<p>
get_test 根据 elision 规则, 等价于:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span>&lt;'<span style="color: #268bd2;">a</span>&gt;<span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #268bd2;">a</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
编译 get_test 时没有问题, 但编译 main 时出错,  因为 f &gt; f1, 这里我们需要修改
get_test 为:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #268bd2;">#[derive</span><span style="color: #757575;">(</span><span style="color: #268bd2;">Debug</span><span style="color: #757575;">)</span><span style="color: #268bd2;">]</span>
<span style="color: #859900;">struct</span> <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">static</span> <span style="color: #268bd2;">g_test</span>: <span style="color: #b58900;">Test</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">get_test</span><span style="color: #757575;">(</span><span style="color: #268bd2;">f1</span>: <span style="color: #839496; background-color: #002b36;">&amp;</span><span style="color: #b58900;">Test</span><span style="color: #757575;">)</span> -&gt; <span style="color: #839496; background-color: #002b36;">&amp;</span>'<span style="color: #859900;">static</span> <span style="color: #b58900;">Test</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #839496; background-color: #002b36;">&amp;</span>g_test;
<span style="color: #757575;">}</span>

<span style="color: #859900;">fn</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">let</span> <span style="color: #268bd2;">f</span>;
    <span style="color: #757575;">{</span>
        <span style="color: #859900;">let</span> <span style="color: #268bd2;">f1</span> = <span style="color: #b58900;">Test</span><span style="color: #757575;">()</span>;
        f = get_test<span style="color: #757575;">(</span><span style="color: #839496; background-color: #002b36;">&amp;</span>f1<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #839496;">println!</span><span style="color: #757575;">(</span><span style="color: #2aa198;">"</span><span style="color: #2aa198; font-style: italic;">{:?}</span><span style="color: #2aa198;">"</span><span style="color: #757575;">,</span> f<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc578ee0" class="outline-3">
<h3 id="orgc578ee0"><span class="section-number-3">1.8</span> 总结</h3>
<div class="outline-text-3" id="text-1-8">
<ol class="org-ol">
<li>编译器不想(不能)自动计算出 lifetime</li>

<li>lifetime 类似于函数的 signature</li>

<li>编译 test 时, 需要根据 lifetime annotation 确保输出引用着正确的参数</li>

<li>编译 main 时, 需要根据 lifetime annotation 确保被输出引用的参数有足够长的
lifetime</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2018-12-27 四 00:00<br />
Last updated: 2021-09-16 四 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

           <div id="disqus_thread"></div>
           <script>

           (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sunwayforever-github-io.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
           </script>
</div>
</body>
</html>
