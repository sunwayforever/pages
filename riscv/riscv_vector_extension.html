<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>RISC-V Vector Extension</title>


           <link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
           <link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
           <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
           <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
           <script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
           <script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
           <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
           <link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
           <link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
           <link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
           <link rel = "icon" href = "/icon.png"  type = "image/x-icon">
</head>
<body>
<div id="content" class="content">
<h1 class="title">RISC-V Vector Extension</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0000097">1. RISC-V Vector Extension</a>
<ul>
<li><a href="#org0000013">1.1. setup</a>
<ul>
<li><a href="#org000000c">1.1.1. setup env</a></li>
<li><a href="#org0000010">1.1.2. build and run</a></li>
</ul>
</li>
<li><a href="#org0000072">1.2. rvv 1.0</a>
<ul>
<li><a href="#org0000016">1.2.1. register</a></li>
<li><a href="#org000001c">1.2.2. vsetvl</a></li>
<li><a href="#org000002b">1.2.3. mask</a></li>
<li><a href="#org000006f">1.2.4. insns</a></li>
</ul>
</li>
<li><a href="#org000007e">1.3. gcc rvv intrinsic</a>
<ul>
<li><a href="#org0000075">1.3.1. 数据类型</a></li>
<li><a href="#org0000078">1.3.2. 函数原型</a></li>
<li><a href="#org000007b">1.3.3. impls</a></li>
</ul>
</li>
<li><a href="#org0000088">1.4. example</a>
<ul>
<li><a href="#org0000081">1.4.1. matmul with rvv assembly:</a></li>
<li><a href="#org0000084">1.4.2. matmul with rvv intrinsic:</a></li>
</ul>
</li>
<li><a href="#org000008b">1.5. gcc rvv auto vectorization</a></li>
<li><a href="#org0000094">1.6. misc</a>
<ul>
<li><a href="#org000008e">1.6.1. vector vs. simd</a></li>
<li><a href="#ID-a05733ad-d9ce-4fc4-b76c-9f15770c0c4b">1.6.2. riscv p extension</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000097" class="outline-2">
<h2 id="org0000097"><span class="section-number-2">1.</span> RISC-V Vector Extension</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://github.com/riscv/riscv-v-spec/releases">https://github.com/riscv/riscv-v-spec/releases</a>
</p>

<p>
当前最新的 rvv (risc-v vector extention) 是 rvv 1.0
</p>
</div>

<div id="outline-container-org0000013" class="outline-3">
<h3 id="org0000013"><span class="section-number-3">1.1.</span> setup</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org000000c" class="outline-4">
<h4 id="org000000c"><span class="section-number-4">1.1.1.</span> setup env</h4>
<div class="outline-text-4" id="text-1-1-1">
</div>
<div id="outline-container-org0000000" class="outline-5">
<h5 id="org0000000"><span class="section-number-5">1.1.1.1.</span> gcc</h5>
<div class="outline-text-5" id="text-1-1-1-1">
<p>
<a href="https://github.com/riscv-collab/riscv-gnu-toolchain">https://github.com/riscv-collab/riscv-gnu-toolchain</a>
</p>

<p>
riscv-gcc 的 riscv-gcc-rvv-next 分支 和 riscv-binutils 的 riscv-binutils-2.38 分支看起来支持 rvv 1.0
</p>
</div>
</div>

<div id="outline-container-org0000003" class="outline-5">
<h5 id="org0000003"><span class="section-number-5">1.1.1.2.</span> llvm</h5>
<div class="outline-text-5" id="text-1-1-1-2">
<p>
llvm upsteam 支持 rvv 1.0
</p>
</div>
</div>

<div id="outline-container-org0000006" class="outline-5">
<h5 id="org0000006"><span class="section-number-5">1.1.1.3.</span> qemu</h5>
<div class="outline-text-5" id="text-1-1-1-3">
<p>
qemu upstream 支持 rvv 1.0, 默认配置下需要运行时通过 `qemu-riscv64 -cpu
rv64,v=true` 打开 rvv 支持
</p>
</div>
</div>

<div id="outline-container-org0000009" class="outline-5">
<h5 id="org0000009"><span class="section-number-5">1.1.1.4.</span> spike</h5>
<div class="outline-text-5" id="text-1-1-1-4">
<p>
spike 支持 rvv 1.0
</p>
</div>
</div>

<div id="outline-container-ID-8a5e7866-0a71-4814-8b12-845a1c574383" class="outline-5">
<h5 id="ID-8a5e7866-0a71-4814-8b12-845a1c574383"><span class="section-number-5">1.1.1.5.</span> linux kernel</h5>
<div class="outline-text-5" id="text-1-1-1-5">
<p>
<a href="https://github.com/riscv-software-src/riscv-isa-sim/issues/505">https://github.com/riscv-software-src/riscv-isa-sim/issues/505</a>
</p>

<p>
<a href="https://lore.kernel.org/linux-riscv/cover.1652257230.git.greentime.hu@sifive.com/">https://lore.kernel.org/linux-riscv/cover.1652257230.git.greentime.hu@sifive.com/</a>
</p>

<p>
目前 linux (ubuntu 22.04 for riscv) 还不支持 rvv, 在 linux 上使用 rvv 指令会直接
illegal instruction, 因为相应的 mstatus 等寄存器没有初始化.
</p>

<p>
为了支持 rvv, linux 需要处理上下文切换时和 rvv 相关的寄存器.
</p>

<p>
但存在一些第三方的 kernel 例如 <a href="https://github.com/T-head-Semi/linux">https://github.com/T-head-Semi/linux</a> 对 rvv 有支持
</p>
</div>
</div>
</div>

<div id="outline-container-org0000010" class="outline-4">
<h4 id="org0000010"><span class="section-number-4">1.1.2.</span> build and run</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;riscv_vector.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>

<span class="org-type">void</span> <span class="org-function-name">vec_add_rvv</span>(<span class="org-type">int</span> *<span class="org-variable-name">a</span>, <span class="org-type">int</span> *<span class="org-variable-name">b</span>, <span class="org-type">int</span> *<span class="org-variable-name">c</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span>) {
    <span class="org-type">size_t</span> <span class="org-variable-name">vl</span>;
    <span class="org-type">vint32m2_t</span> <span class="org-variable-name">va</span>, <span class="org-variable-name">vb</span>, <span class="org-variable-name">vc</span>;
    <span class="org-keyword">for</span> (; vl = vsetvl_e32m2(n); n -= vl) {
        vb = vle32_v_i32m2(b, vl);
        vc = vle32_v_i32m2(c, vl);
        va = vadd_vv_i32m2(vb, vc, vl);
        vse32_v_i32m2(a, va, vl);
        a += vl;
        b += vl;
        c += vl;
    }
}

<span class="org-type">int</span> <span class="org-variable-name">x</span>[10] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 0};
<span class="org-type">int</span> <span class="org-variable-name">y</span>[10] = {0, 9, 8, 7, 6, 5, 4, 3, 2, 1};
<span class="org-type">int</span> <span class="org-variable-name">z</span>[10];

<span class="org-type">int</span> <span class="org-function-name">main</span>() {
    <span class="org-type">int</span> <span class="org-variable-name">i</span>;
    vec_add_rvv(z, x, y, 10);
    <span class="org-keyword">for</span> (i = 0; i &lt; 10; i++) printf(<span class="org-string">"%d "</span>, z[i]);
    printf(<span class="org-string">"\n"</span>);
    <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<pre class="example" id="org000000f">
$&gt; /opt/riscv-rvv/bin/riscv64-unknown-linux-gnu-gcc test.c -march=rv64gv -static
$&gt; /opt/riscv-rvv/bin/spike --isa=RV64GCV /opt/riscv-rvv/riscv64-unknown-elf/bin/pk64 a.out
bbl loader
1 11 11 11 11 11 11 11 11 1
$&gt; qemu-riscv64 -cpu rv64,v=true,vlen=256 ./a.out
1 11 11 11 11 11 11 11 11 1
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000072" class="outline-3">
<h3 id="org0000072"><span class="section-number-3">1.2.</span> rvv 1.0</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0000016" class="outline-4">
<h4 id="org0000016"><span class="section-number-4">1.2.1.</span> register</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>v0..v31,  共 32 个 vector 寄存器, 每个寄存器的宽度由 VLEN 确定, 例如 256 bit</li>

<li><p>
vtype, 主要包括 vsew[2:0] (SEW, selected element width) 和 vlmul[2:0] (LMUL, group
multiplier) 以及 ta (tail agonostic) 和 ma (mask agonostic)
</p>

<p>
vsew 可以表示 8/16/32/64
</p>

<p>
vmul 可以表示 1/8, 1/4, 1/2, 1, 2, 4, 8
</p>

<p>
ta 表示 vr 尾部因为 vl 的原因不需要计算的部分是否需要保持不变 (例如 VLMAX 为
32, 但 vl 指定为 30, 则 vr 最后的两个元素是不需要计算的)
</p>

<p>
ma 表示因为 mask 被忽略的元素是否需要保持不变
</p></li>

<li>vl, vector length, 表示向量操作要操作的元素个数, 不能超过 VLEN*LMUL/SEW, 这个限制称为 VLMAX</li>
</ul>
</div>
</div>

<div id="outline-container-org000001c" class="outline-4">
<h4 id="org000001c"><span class="section-number-4">1.2.2.</span> vsetvl</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
vset{i}vl{i} 用来设置 vl 和 vtype, 会影响后续的向量操作
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">li</span> <span class="org-keyword">t0</span>, 10
<span class="org-function-name">vsetvli</span> &lt;rd&gt;, &lt;rs1&gt;, e8, m1, ta, ma
</pre>
</div>

<p>
&lt;rs1&gt; 是期望的 vl, &lt;rd&gt; 在实际的 vl, vsetvli 会设置 vl 为 `min(&lt;rs1&gt;, VLMAX)`,
同时把 vl 通过 &lt;rd&gt; 返回. 这种设置类似高级语言中类似的代码:
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">int</span> <span class="org-variable-name">len</span> = 1021;
<span class="org-type">int</span> <span class="org-variable-name">data</span>[len] = {0};

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * 32 &#31867;&#20284;&#20110; VLMAX</span>
<span class="org-comment"> * max &#30456;&#24403;&#20110; vsetvli</span>
<span class="org-comment-delimiter"> */</span>

<span class="org-keyword">do</span> {
    <span class="org-type">int</span> <span class="org-variable-name">seg</span> = min(len, 32);
    <span class="org-comment-delimiter">/* </span><span class="org-comment">process data[0..seg]</span><span class="org-comment-delimiter"> */</span>
    data += seg;
    len -= seg;
} <span class="org-keyword">while</span> (len &gt; 0)
</pre>
</div>

<p>
`e8` 表示 vsew 的值, 可以选择 e8, e16, e32, e64, 对应 8/16/32/64 bit 的 SEW
</p>

<p>
`m1` 表示 vlmul 的值, 可以选择 mf8, mf4, mf2, m1, m2, m4, m8, 对应 1/8, 1/4,
1/2, 1, 2, 4, 8
</p>

<p>
`ta` 表示 vta (vector tail agonostic), 可以选择 ta, tu, 其中 ta 表示结尾不需要处理的数据不需要保持原来的值, `tu` 表示需要保持
</p>

<p>
`ma` 表示 vma (vector mask agonostic), 可以选择 ma, mu
</p>

<p>
vset{i}vl{i} 的第一个 i 表示关于 vl 的部分是否使用 imm, 第二个 i 表示关于 vtype
的部分是否使用 imm, 例如:
</p>

<div class="org-src-container">
<pre class="src src-asm">## t1 &#26159;&#20043;&#21069;&#20445;&#23384;&#30340; vtype
<span class="org-function-name">vsetivl</span> <span class="org-keyword">t0</span>, 10, t1
<span class="org-function-name">vsetivli</span> <span class="org-keyword">t0</span>, 10, e8, m2
## t2 &#20445;&#23384;&#30528;&#35201;&#27714;&#30340; vl
<span class="org-function-name">vsetvl</span> <span class="org-keyword">t0</span>, t2, t1
<span class="org-function-name">vsetvli</span> <span class="org-keyword">t0</span>, t2, e8 ,2, ta, mu
</pre>
</div>

<p>
一般情况下都使用 vsetvli, vsetvl 一般只在上下文切换时使用(用来恢复 vl 和 vtype)
</p>
</div>

<div id="outline-container-org0000087" class="outline-5">
<h5 id="org0000087"><span class="section-number-5">1.2.2.1.</span> example</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> main
    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    ## VLEN &#20026; 256, &#20351;&#29992; e8 &#26102;&#21333;&#20010; vector register &#33021;&#23481;&#32435;&#30340;&#20803;&#32032;&#20010;&#25968;&#26159; 32, &#36890;&#36807;&#35843;&#29992; vlmul &#20026; m2
    ## &#21487;&#20197;&#19968;&#27425;&#20351;&#29992;&#20004;&#20010; vr &#26469;&#25805;&#20316; 64 &#20010; byte

    <span class="org-keyword">li</span> t0, 64
    <span class="org-keyword">vsetvli</span> a1, t0, e8, m2

    <span class="org-keyword">la</span> t0, origin
    ## vle8.v &#29992;&#26469;&#20174; t0 &#36215;&#22987;&#22320;&#22336; load &#25968;&#25454;&#21040; v0, &#20855;&#20307; load &#22810;&#23569;&#25968;&#25454;&#30001; vl &#20915;&#23450;, &#36825;&#37324;&#26159; 64

    ## &#22914;&#26524;&#36825;&#37324;&#25351;&#23450; v1, &#20250;&#20986;&#29616; illegal instruction.
    ## &#22240;&#20026;&#20351;&#29992; m2, &#25152;&#20197; riscv &#20250;&#38544;&#24335;&#30340;&#20351;&#29992; (v0, v1) &#20004;&#20010;&#23492;&#23384;&#22120;&#26469;&#20445;&#23384; 64 &#20010; byte. &#36825;&#37324;&#25351;&#20196;&#37324;&#20351;&#29992;
    ## v0, v2, v4 ... &#37117;&#21487;&#20197;, &#20294;&#20351;&#29992; v1, v3, v5 ... &#20250;&#25253;&#38169;. &#21516;&#29702;, m4 &#26102;&#21482;&#33021;&#20351;&#29992; v0, v4, v8, ...
    <span class="org-keyword">vle8.v</span> v0, (t0)
    ## vsaddu.vi &#25226; 64 &#20010; byte &#20840;&#37096;&#21152; 1
    <span class="org-keyword">vsaddu.vi</span> v0, v0, 1
    ## vse8.v &#25226; 64 &#20010; byte &#20889;&#22238;&#21040; (t0)
    <span class="org-keyword">vse8.v</span> v0, (t0)

    <span class="org-keyword">la</span> a0, msg
    <span class="org-keyword">lb</span> a1, 63(t0)
    <span class="org-keyword">lb</span> a2, 62(t0)
    <span class="org-keyword">lb</span> a3, 61(t0)
    <span class="org-keyword">lb</span> a4, 60(t0)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">origin</span>:
    <span class="org-keyword">.rep</span> 64
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.endr</span>

<span class="org-function-name">msg</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%d %d %d %d\n"</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> memcpy
    # void *memcpy(void* dest, const void* src, size_t n)
    # a0=dest, a1=src, a2=n
<span class="org-function-name">memcpy</span>:
    <span class="org-keyword">mv</span> a3, a0
<span class="org-function-name">loop</span>:
    <span class="org-keyword">vsetvli</span> t0, a2, e8, m8, ta, ma
    <span class="org-keyword">vle8.v</span> v0, (a1) 
    <span class="org-keyword">add</span> a1, a1, t0 
    <span class="org-keyword">sub</span> a2, a2, t0 
    <span class="org-keyword">vse8.v</span> v0, (a3)
    <span class="org-keyword">add</span> a3, a3, t0 
    <span class="org-keyword">bnez</span> a2, loop 
    <span class="org-keyword">ret</span> 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000002b" class="outline-4">
<h4 id="org000002b"><span class="section-number-4">1.2.3.</span> mask</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
大多数 rvv 指令 (除了 vsetvl) 都支持一个 vm 标志, 表示是否使用 mask
</p>

<div class="org-src-container">
<pre class="src src-asm">## &#19981;&#20351;&#29992; mask
<span class="org-function-name">vop</span>.v* v1, ...
## &#20351;&#29992; mask, &#20854;&#20013; mask &#20445;&#23384;&#22312; v0 &#20013;, &#27599; bit &#20195;&#34920;&#19968;&#20010; element &#26159;&#21542;&#34987; mask
<span class="org-function-name">vop</span>.v* v1, ..., v0.t
</pre>
</div>

<p>
当前只能使用 v0 做 mask 寄存器
</p>
</div>

<div id="outline-container-org0000025" class="outline-5">
<h5 id="org0000025"><span class="section-number-5">1.2.3.1.</span> 操作 mask 的指令</h5>
<div class="outline-text-5" id="text-1-2-3-1">
</div>
<div id="outline-container-ID-22a7c201-dbbd-4d4a-9cb5-aeb3752803cf" class="outline-6">
<h6 id="ID-22a7c201-dbbd-4d4a-9cb5-aeb3752803cf"><span class="section-number-6">1.2.3.1.1.</span> mask and/or/not</h6>
<div class="outline-text-6" id="text-1-2-3-1-1">
<ul class="org-ul">
<li>vmmand.mm vd, vs1, vs2</li>

<li>vmor.mm</li>

<li>vmxor.mm</li>

<li>vmxnor.mm</li>

<li>vmnor.mm</li>

<li>&#x2026;</li>

<li><p>
vmclr.m vd
</p>

<p>
伪指令, 用来把 vd 清零, 相当于 vmxor.mm vd, vd, vd
</p></li>

<li><p>
vmset.m vd
</p>

<p>
伪指令, 用来把 vd 全部置 1, 相当于 vmxnor.mm vd, vd, vd
</p></li>
</ul>
</div>


<ul class="org-ul">
<li><a id="org000009b"></a>Backlinks<br />
<div class="outline-text-7" id="text-org000009b">
<p>
<a href="riscv_vector_extension.html#ID-1a3f764a-c401-4233-bd66-f809ada336f1">RISC-V Vector Extension</a>
(<i>RISC-V Vector Extension &gt; rvv 1.0 &gt; insns &gt; 算术运算 &gt; mask</i>):   <a href="#ID-22a7c201-dbbd-4d4a-9cb5-aeb3752803cf">mask</a>
</p>
</div>
</li>
</ul>
</div>


<div id="outline-container-ID-0acbe995-d66c-4a6e-a6b1-041c409ce74c" class="outline-6">
<h6 id="ID-0acbe995-d66c-4a6e-a6b1-041c409ce74c"><span class="section-number-6">1.2.3.1.2.</span> 根据条件设置 mask</h6>
<div class="outline-text-6" id="text-1-2-3-1-2">
<ul class="org-ul">
<li>vmseq (vector mask set equal):

<ul class="org-ul">
<li><p>
vmseq.vv vd, vs1, vs2
</p>

<p>
.vv 表示 vs1, vs2 都是 vector
</p></li>

<li><p>
vmseq.vx vd, vs1, rs1
</p>

<p>
.vx 表示 rs1 是 scalar
</p></li>

<li><p>
vmseq.vi vd, vs1, imm
</p>

<p>
.vi 表示 imm 是 immediate
</p></li>
</ul></li>

<li>vmsne (vector mask set not equal)</li>

<li>vmsltu</li>

<li>vmslt</li>

<li>vmsleu</li>

<li>vmsle</li>

<li>&#x2026;</li>

<li>vmfeq</li>

<li>vmfne</li>

<li>&#x2026;</li>
</ul>
</div>


<ul class="org-ul">
<li><a id="org0000022"></a>Backlinks<br />
<div class="outline-text-7" id="text-org0000022">
<p>
<a href="riscv_vector_extension.html#ID-1a3f764a-c401-4233-bd66-f809ada336f1">RISC-V Vector Extension</a>
(<i>RISC-V Vector Extension &gt; rvv 1.0 &gt; insns &gt; 算术运算 &gt; mask compare</i>):   <a href="#ID-0acbe995-d66c-4a6e-a6b1-041c409ce74c">mask compare</a>
</p>
</div>
</li>
</ul>
</div>
</div>


<div id="outline-container-org0000028" class="outline-5">
<h5 id="org0000028"><span class="section-number-5">1.2.3.2.</span> example</h5>
<div class="outline-text-5" id="text-1-2-3-2">
<div class="org-src-container">
<pre class="src src-asm">## /opt/riscv-rvv/bin/riscv64-unknown-elf-gcc -march=rv64gv ./main.S -O0 -g
    <span class="org-keyword">.global</span> main
    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">li</span> t0, 4
    <span class="org-keyword">vsetvli</span> a1, t0, e8

    <span class="org-keyword">la</span> t0, origin
    <span class="org-keyword">vle8.v</span> v1, (t0)

    <span class="org-keyword">vmclr.m</span> v0
    ## &#21482;&#26377;&#31561;&#20110; 1 &#30340;&#25165;&#20250;&#34987; mask
    <span class="org-keyword">vmseq.vi</span> v0,v1,1

    ## &#20351;&#29992; mask, &#26368;&#21518;&#30340;&#32467;&#26524;&#20026; 2,2,0,2 (&#32780;&#19981;&#26159; 2,2,1,2)
    <span class="org-keyword">vsaddu.vi</span> v1, v1, 1, v0.t
    <span class="org-keyword">vse8.v</span> v1, (t0)

    <span class="org-keyword">la</span> a0, msg
    <span class="org-keyword">lb</span> a1, (t0)
    <span class="org-keyword">lb</span> a2, 1(t0)
    <span class="org-keyword">lb</span> a3, 2(t0)
    <span class="org-keyword">lb</span> a4, 3(t0)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">origin</span>:
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.byte</span> 0
    <span class="org-keyword">.byte</span> 1

<span class="org-function-name">msg</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%d %d %d %d\n"</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000006f" class="outline-4">
<h4 id="org000006f"><span class="section-number-4">1.2.4.</span> insns</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
所有的 rvv 指令分为三大类:
</p>

<ul class="org-ul">
<li>setvl</li>

<li>load/store</li>

<li>数学运算</li>
</ul>
</div>

<div id="outline-container-org000003b" class="outline-5">
<h5 id="org000003b"><span class="section-number-5">1.2.4.1.</span> load/store</h5>
<div class="outline-text-5" id="text-1-2-4-1">

<div id="org000002e" class="figure">
<p><img src="../extra/riscv_rvv_load_store.png" alt="riscv_rvv_load_store.png" />
</p>
</div>

<p>
load/store 又根据 memory addressing model 分为三类指令:
</p>

<ol class="org-ol">
<li>unit strided</li>

<li>strided</li>

<li>indexed</li>
</ol>

<p>
其中 mop field 用来区别不同类型的 load/store
</p>
</div>

<div id="outline-container-org0000032" class="outline-6">
<h6 id="org0000032"><span class="section-number-6">1.2.4.1.1.</span> strided load/store</h6>
<div class="outline-text-6" id="text-1-2-4-1-1">
<p>
vector load/store 时支持 stride 参数, 通过 stride, 可以很容易的处理 `矩阵按列取数据` 这类问题
</p>

<p>
普通的 load/store 指令是:
</p>

<ul class="org-ul">
<li>vle{8,16,32,64}.v vd, (rs1)</li>
<li>vse{8,16,32,64}.v vd, (rs1)</li>
</ul>

<p>
带 stride 的 load/store 指令为:
</p>

<ul class="org-ul">
<li>vlse{8,16,32,64}.v vd, (rs1), rs2</li>
<li>vsse{8,16,32,64}.v vd, (rs1), rs2</li>
</ul>

<p>
其中 rs2 用来保存 stride
</p>
</div>

<ol class="org-ol">
<li><a id="org000002f"></a>example<br />
<div class="outline-text-7" id="text-1-2-4-1-1-1">
<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> main
    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">li</span> t0, 2
    <span class="org-keyword">vsetvli</span> a1, t0, e8

    <span class="org-keyword">la</span> t0, origin
    ## vector &#21482;&#26377;&#20004;&#20010;&#20803;&#32032;
    <span class="org-keyword">li</span> t2, 2
    ## stride &#20026; 2, &#25152;&#20197; vector &#20013;&#20803;&#32032;&#23545;&#24212; origin[0, 2]
    <span class="org-keyword">vlse8.v</span> v1, (t0), t2
    <span class="org-keyword">vsaddu.vi</span> v1, v1, 1
    ## &#26368;&#32456;&#32467;&#26524;&#20026; 2,1,2,1, &#32780;&#19981;&#26159; 2,2,1,1
    <span class="org-keyword">vsse8.v</span> v1, (t0),t2

    <span class="org-keyword">la</span> a0, msg
    <span class="org-keyword">lb</span> a1, (t0)
    <span class="org-keyword">lb</span> a2, 1(t0)
    <span class="org-keyword">lb</span> a3, 2(t0)
    <span class="org-keyword">lb</span> a4, 3(t0)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">origin</span>:
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.byte</span> 1

<span class="org-function-name">msg</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%d %d %d %d\n"</span>

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org0000038" class="outline-6">
<h6 id="org0000038"><span class="section-number-6">1.2.4.1.2.</span> indexed load/store</h6>
<div class="outline-text-6" id="text-1-2-4-1-2">
<p>
indexed load/store 可以接受一个 index vector, 相当于一个更灵活的 strided load/store
</p>

<p>
相关指令有:
</p>

<ul class="org-ul">
<li><p>
vl{u,o}xei{8,16,32,64}.v vd, (rs1), vs2
</p>

<p>
indexed load, vs2 是 index vector
</p></li>

<li><p>
vs{u,o}xei{8,16,32,64}.v vd, (rs1), vs2
</p>

<p>
indexed store, vs2 是 index vector
</p></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org0000035"></a>example<br />
<div class="outline-text-7" id="text-1-2-4-1-2-1">
<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> main
    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">li</span> t0, 2
    <span class="org-keyword">vsetvli</span> a1, t0, e8

    ## index vector &#20026; [0,2], &#25152;&#20197;&#21482;&#26377; origin[0,2] &#20250;&#34987; load/store
    ## &#26368;&#21518;&#36755;&#20986;&#32467;&#26524;&#20026; 2,1,2,1
    <span class="org-keyword">la</span> t1, index
    <span class="org-keyword">vle8.v</span> v2, (t1)

    <span class="org-keyword">la</span> t0, origin
    <span class="org-keyword">vloxei8.v</span> v1, (t0), v2

    <span class="org-keyword">vsaddu.vi</span> v1, v1, 1
    <span class="org-keyword">vsoxei8.v</span> v1, (t0),v2

    <span class="org-keyword">la</span> a0, msg
    <span class="org-keyword">lb</span> a1, (t0)
    <span class="org-keyword">lb</span> a2, 1(t0)
    <span class="org-keyword">lb</span> a3, 2(t0)
    <span class="org-keyword">lb</span> a4, 3(t0)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">origin</span>:
    <span class="org-keyword">.rep</span> 4
    <span class="org-keyword">.byte</span> 1
    <span class="org-keyword">.endr</span>

<span class="org-function-name">index</span>:
    <span class="org-keyword">.byte</span> 0
    <span class="org-keyword">.byte</span> 2

<span class="org-function-name">msg</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%d %d %d %d\n"</span>

</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org000003f" class="outline-5">
<h5 id="org000003f"><span class="section-number-5">1.2.4.2.</span> setvl</h5>
<div class="outline-text-5" id="text-1-2-4-2">

<div id="org000003e" class="figure">
<p><img src="../extra/riscv_rvv_vsetvl.png" alt="riscv_rvv_vsetvl.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org000006c" class="outline-5">
<h5 id="org000006c"><span class="section-number-5">1.2.4.3.</span> 算术运算</h5>
<div class="outline-text-5" id="text-1-2-4-3">
<p>
根据算术运算的参数不同, 指令有不同的后缀:
</p>

<ul class="org-ul">
<li>v&lt;op&gt;.vv vd, vs1, vs2</li>

<li>v&lt;op&gt;.vx vd, vs1, rs2</li>

<li>v&lt;op&gt;.vi vd, vs1, imm</li>

<li>vf&lt;op&gt;.vv vd, vs1, vs2</li>

<li>vf&lt;op&gt;.vx vd, vs1, rs1</li>
</ul>

<p>
另外, 某些使用 mask 的指令例如 vmerge 会使用 .m 后缀, 例如 vmerge.vvm  
</p>
</div>

<div id="outline-container-org0000042" class="outline-6">
<h6 id="org0000042"><span class="section-number-6">1.2.4.3.1.</span> integer add sub</h6>
<div class="outline-text-6" id="text-1-2-4-3-1">
<ul class="org-ul">
<li>vadd.{} vd, &#x2026;</li>
<li>vsub.{} vd, &#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org0000045" class="outline-6">
<h6 id="org0000045"><span class="section-number-6">1.2.4.3.2.</span> bitwise</h6>
<div class="outline-text-6" id="text-1-2-4-3-2">
<ul class="org-ul">
<li>vand.{}</li>
<li>vor.{}</li>
<li>vxor.{}</li>
</ul>
</div>
</div>


<div id="outline-container-org0000048" class="outline-6">
<h6 id="org0000048"><span class="section-number-6">1.2.4.3.3.</span> shift</h6>
<div class="outline-text-6" id="text-1-2-4-3-3">
<ul class="org-ul">
<li>vsll.{}</li>
<li>vsrl.{}</li>
<li>vsra.{}</li>
</ul>
</div>
</div>

<div id="outline-container-org000004b" class="outline-6">
<h6 id="org000004b"><span class="section-number-6">1.2.4.3.4.</span> <a href="#ID-0acbe995-d66c-4a6e-a6b1-041c409ce74c">mask compare</a></h6>
</div>

<div id="outline-container-org000004e" class="outline-6">
<h6 id="org000004e"><span class="section-number-6">1.2.4.3.5.</span> min/max</h6>
<div class="outline-text-6" id="text-1-2-4-3-5">
<ul class="org-ul">
<li>vmin{u,}.{vv,vx}</li>
<li>vmax{u,}.{vv,vx</li>
</ul>
</div>
</div>

<div id="outline-container-org0000051" class="outline-6">
<h6 id="org0000051"><span class="section-number-6">1.2.4.3.6.</span> multiply/divide</h6>
<div class="outline-text-6" id="text-1-2-4-3-6">
<ul class="org-ul">
<li>vmul{h,hu,hsu,}.{vv,vx}</li>
<li>vdiv{u,}.{vv,vx}</li>
<li>vrem{u,}.{vv,vx}</li>
</ul>
</div>
</div>

<div id="outline-container-org0000054" class="outline-6">
<h6 id="org0000054"><span class="section-number-6">1.2.4.3.7.</span> accumulate</h6>
<div class="outline-text-6" id="text-1-2-4-3-7">
<ul class="org-ul">
<li>vmacc.{vv,vx}</li>
<li>vnmsac.{vv,vx}</li>
<li>vmadd.{vv,vx}</li>
<li>vnmsub.{vv.vx}</li>
</ul>
</div>
</div>

<div id="outline-container-org0000057" class="outline-6">
<h6 id="org0000057"><span class="section-number-6">1.2.4.3.8.</span> merge</h6>
<div class="outline-text-6" id="text-1-2-4-3-8">
<ul class="org-ul">
<li><p>
vmerge.vvm vd, vs1, vs2, v0
</p>

<p>
vd[i] = v0.mask[i] ? vs1[i] : vs2[i]
</p></li>

<li>vmerge.{vx,vi}m</li>
</ul>
</div>
</div>

<div id="outline-container-org000005a" class="outline-6">
<h6 id="org000005a"><span class="section-number-6">1.2.4.3.9.</span> move</h6>
<div class="outline-text-6" id="text-1-2-4-3-9">
<ul class="org-ul">
<li>vmv.v.{v,x,i}</li>
</ul>
</div>
</div>

<div id="outline-container-org000005d" class="outline-6">
<h6 id="org000005d"><span class="section-number-6">1.2.4.3.10.</span> reduction</h6>
<div class="outline-text-6" id="text-1-2-4-3-10">
<ul class="org-ul">
<li>vredsum.vs</li>
<li>vred{max,min}.vs</li>
<li>vred{and,or,xor}.vs</li>
</ul>
</div>
</div>

<div id="outline-container-org0000060" class="outline-6">
<h6 id="org0000060"><span class="section-number-6">1.2.4.3.11.</span> permutation</h6>
<div class="outline-text-6" id="text-1-2-4-3-11">
<ul class="org-ul">
<li>vmv.x.s rd, vs1</li>
<li>vmv.s.x vd, rs1</li>
</ul>
</div>
</div>

<div id="outline-container-org0000066" class="outline-6">
<h6 id="org0000066"><span class="section-number-6">1.2.4.3.12.</span> floating point</h6>
<div class="outline-text-6" id="text-1-2-4-3-12">
<ul class="org-ul">
<li>vfadd.{vv,vf}</li>
<li>vfsub.{vv,vf}</li>
<li>vfmul.{vv,vf}</li>
<li>vfdiv.{vv,vf}</li>
<li>vfmacc.{vv,vf}</li>
<li>vfsqrt.v vd, vs1</li>
<li>vfmin.{vv,vf}</li>
<li>vfmax.{vv,vf}</li>
<li>vmfeq.{vv,vf}</li>
<li>vmfne.{vv,vf}</li>
<li>vfmerge.vfm</li>
<li>vfmv.v.f vd, rs1</li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org0000063"></a>example<br />
<div class="outline-text-7" id="text-1-2-4-3-12-1">
<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> main
    <span class="org-keyword">.text</span>
<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">li</span> t0, 4
    <span class="org-keyword">vsetvli</span> a1, t0, e64

    <span class="org-keyword">la</span> t0, origin
    <span class="org-keyword">vle64.v</span> v1, (t0)

    <span class="org-keyword">la</span> t1, inc
    <span class="org-keyword">fld</span> fa0, (t1)
    <span class="org-keyword">vfadd.vf</span> v1, v1, fa0
    <span class="org-keyword">vse64.v</span> v1, (t0)

    <span class="org-keyword">la</span> a0, msg
    <span class="org-keyword">ld</span> a1, (t0)
    <span class="org-keyword">ld</span> a2, 8(t0)
    <span class="org-keyword">ld</span> a3, 16(t0)
    <span class="org-keyword">ld</span> a4, 24(t0)
    <span class="org-keyword">call</span> printf

    <span class="org-keyword">li</span> a0, 0
    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">jr</span> ra

    <span class="org-keyword">.data</span>
<span class="org-function-name">inc</span>:
    <span class="org-keyword">.double</span> 2.0
<span class="org-function-name">origin</span>:
    <span class="org-keyword">.rep</span> 4
    <span class="org-keyword">.double</span> 1.0
    <span class="org-keyword">.endr</span>

<span class="org-function-name">msg</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%f %f %f %f\n"</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org0000069" class="outline-6">
<h6 id="org0000069"><span class="section-number-6">1.2.4.3.13.</span> <a href="#ID-22a7c201-dbbd-4d4a-9cb5-aeb3752803cf">mask</a></h6>
</div>
</div>
</div>
</div>

<div id="outline-container-org000007e" class="outline-3">
<h3 id="org000007e"><span class="section-number-3">1.3.</span> gcc rvv intrinsic</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<a href="https://raw.githubusercontent.com/riscv-non-isa/rvv-intrinsic-doc/master/intrinsic_funcs.md">https://raw.githubusercontent.com/riscv-non-isa/rvv-intrinsic-doc/master/intrinsic_funcs.md</a>
</p>
</div>

<div id="outline-container-org0000075" class="outline-4">
<h4 id="org0000075"><span class="section-number-4">1.3.1.</span> 数据类型</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
v{int{8,16,32,64}, uint{8,16,32,64},float{16,32,64}}m{f8,f4,f2,1,2,4,8}_t
</p>

<p>
例如:
</p>

<p>
vint8m1_t, vfloat32mf8_t
</p>
</div>
</div>

<div id="outline-container-org0000078" class="outline-4">
<h4 id="org0000078"><span class="section-number-4">1.3.2.</span> 函数原型</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
setvl:
</p>

<ul class="org-ul">
<li>vsetvl_e{8,16,32,64}m{f8,f4,f2,1,2,4,8}(size_t avl)</li>
</ul>

<p>
unit-stride:
</p>

<ul class="org-ul">
<li>vle{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}(base, size)</li>
<li>vle{16,32,64}_v_f{16,32,64}m{}()</li>
</ul>

<p>
strided:
</p>

<ul class="org-ul">
<li>vlse{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}(base, stride,size)</li>
<li>vlse{16,32,64}_v_f{16,32,64}m{}()</li>
</ul>

<p>
unit-stride mask:
</p>

<ul class="org-ul">
<li>vle{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}_m(mask, maskoff,base, size)</li>
<li>vle{8,16,32,64}_v_f{16,32,64}m{}_m(mask, maskoff,base, size)</li>
</ul>

<p>
strided mask:
</p>

<ul class="org-ul">
<li>vlse{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}_m(mask, maskoff, base, stride,size)</li>
<li>vlse{16,32,64}_v_f{16,32,64}m{}_m()</li>
</ul>

<p>
indexed:  
</p>

<ul class="org-ul">
<li>vl{u,o}xei{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}(base, index, vl)</li>
<li>vl{u,o}xei{8,16,32,64}_v_f{16,32,64}m{}(base, index, vl)</li>
</ul>

<p>
indexed mask:
</p>

<ul class="org-ul">
<li>vl{u,o}xei{8,16,32,64}_v<sub>i,u</sub>{8,16,32,64}m{}_m(mask, maskoff,base, index, vl)</li>
<li>vl{u,o}xei{8,16,32,64}_v_f{16,32,64}m{}_m(mask, maskoff,base, index, vl)</li>
</ul>

<p>
arithmetic:
</p>

<ul class="org-ul">
<li>vadd_vv_i{8,16,32,64}m{}(op1, op2, vl)</li>
<li>vadd_vx_i{8,16,32,64}m{}(op1, op2, vl)</li>
<li>&#x2026;</li>
</ul>

<p>
masked arithmetic:
</p>

<ul class="org-ul">
<li>vadd_vv_i8mf8_m (mask, maskedoff, op1, op2, vl)</li>
<li>vint8mf8_t vadd_vx_i8mf8_m (mask, maskedoff, op1, op2, vl)</li>
<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org000007b" class="outline-4">
<h4 id="org000007b"><span class="section-number-4">1.3.3.</span> impls</h4>
</div>
</div>

<div id="outline-container-org0000088" class="outline-3">
<h3 id="org0000088"><span class="section-number-3">1.4.</span> example</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org0000081" class="outline-4">
<h4 id="org0000081"><span class="section-number-4">1.4.1.</span> matmul with rvv assembly:</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-asm">    <span class="org-keyword">.global</span> matmul
    <span class="org-keyword">.global</span> main

    <span class="org-keyword">.text</span>
    #define row_index s3
    #define col_index s4
    #define tmp t0
<span class="org-function-name">matmul</span>:
    #define vlen s0
    #define a_offset s1
    #define b_offset s2
    #define remain s6    
    <span class="org-keyword">li</span> row_index, 0
<span class="org-function-name">.Louter</span>:
    <span class="org-keyword">li</span> col_index, 0    
<span class="org-function-name">.Linner</span>:
    <span class="org-keyword">mul</span> tmp, row_index, a4
    <span class="org-keyword">slli</span> a_offset, tmp, 2
    <span class="org-keyword">add</span> a_offset, a_offset, a0

    <span class="org-keyword">slli</span> b_offset, col_index, 2
    <span class="org-keyword">add</span> b_offset, b_offset, a1

    <span class="org-keyword">mv</span> vlen, a4
    <span class="org-keyword">mv</span> remain, a4
<span class="org-function-name">.Lloop</span>:
    <span class="org-keyword">vsetvli</span> vlen, remain, e32
    ## load a
    <span class="org-keyword">vle32.v</span> v0, (a_offset)
    <span class="org-keyword">slli</span> tmp, vlen, 2
    <span class="org-keyword">add</span> a_offset, a_offset, tmp
    ## load b
    <span class="org-keyword">slli</span> tmp, a5, 2
    <span class="org-keyword">vlse32.v</span> v1, (b_offset), tmp
    <span class="org-keyword">mul</span> tmp, tmp, vlen
    <span class="org-keyword">add</span> b_offset, b_offset, tmp
    ## calc
    <span class="org-keyword">sub</span> remain, remain, vlen    
    <span class="org-keyword">vmul.vv</span> v0, v0, v1
    <span class="org-keyword">vredsum.vs</span> v2, v0, v2
    <span class="org-keyword">bnez</span> remain, .Lloop

    ## save result
    <span class="org-keyword">vmv.x.s</span> tmp, v2
    <span class="org-keyword">vmv.s.x</span> v2, zero
    <span class="org-keyword">sw</span> tmp, (a2)
    <span class="org-keyword">addi</span> a2, a2, 4
    <span class="org-keyword">addi</span> col_index, col_index, 1    
    <span class="org-keyword">blt</span> col_index, a5, .Linner

    <span class="org-keyword">addi</span> row_index, row_index, 1
    <span class="org-keyword">blt</span> row_index, a3, .Louter
    ## finish
    <span class="org-keyword">ret</span>


<span class="org-function-name">dump</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    #define buf s0
    #define total_row s1
    #define total_col s2

    <span class="org-keyword">mv</span> buf, a0
    <span class="org-keyword">mv</span> total_row, a1
    <span class="org-keyword">mv</span> total_col, a2
    <span class="org-keyword">mv</span> row_index, zero
<span class="org-function-name">2</span>:
    <span class="org-keyword">mv</span> col_index, zero
<span class="org-function-name">1</span>:
    <span class="org-keyword">la</span> a0, fmt
    <span class="org-keyword">lw</span> a1, (buf)
    <span class="org-keyword">addi</span> buf, buf, 4
    <span class="org-keyword">call</span> printf
    <span class="org-keyword">addi</span> col_index, col_index, 1
    <span class="org-keyword">blt</span> col_index, total_col, 1b

    <span class="org-keyword">la</span> a0, newline
    <span class="org-keyword">call</span> printf
    <span class="org-keyword">addi</span> row_index, row_index, 1
    <span class="org-keyword">blt</span> row_index, total_row, 2b

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">ret</span>


<span class="org-function-name">main</span>:
    <span class="org-keyword">addi</span> sp, sp, -4
    <span class="org-keyword">sw</span> ra, 4(sp)

    <span class="org-keyword">la</span> a0, a
    <span class="org-keyword">la</span> a1, b
    <span class="org-keyword">la</span> a2, c
    <span class="org-keyword">li</span> a3, 2
    <span class="org-keyword">li</span> a4, 3
    <span class="org-keyword">li</span> a5, 2

    <span class="org-keyword">call</span> matmul

    <span class="org-keyword">la</span> a0, c
    <span class="org-keyword">li</span> a1, 2
    <span class="org-keyword">li</span> a2, 2
    <span class="org-keyword">call</span> dump

    <span class="org-keyword">lw</span> ra, 4(sp)
    <span class="org-keyword">addi</span> sp, sp, 4
    <span class="org-keyword">ret</span>

    <span class="org-keyword">.data</span>
<span class="org-function-name">a</span>:
    <span class="org-keyword">.word</span> 1
    <span class="org-keyword">.word</span> 2
    <span class="org-keyword">.word</span> 3
    <span class="org-keyword">.word</span> 4
    <span class="org-keyword">.word</span> 5
    <span class="org-keyword">.word</span> 6

<span class="org-function-name">b</span>:
    <span class="org-keyword">.word</span> 1
    <span class="org-keyword">.word</span> 2
    <span class="org-keyword">.word</span> 3
    <span class="org-keyword">.word</span> 4
    <span class="org-keyword">.word</span> 5
    <span class="org-keyword">.word</span> 6

<span class="org-function-name">c</span>:
    <span class="org-keyword">.word</span> 0
    <span class="org-keyword">.word</span> 0
    <span class="org-keyword">.word</span> 0
    <span class="org-keyword">.word</span> 0    

<span class="org-function-name">fmt</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"%d "</span>

<span class="org-function-name">newline</span>:
    <span class="org-keyword">.asciz</span> <span class="org-string">"\n"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000084" class="outline-4">
<h4 id="org0000084"><span class="section-number-4">1.4.2.</span> matmul with rvv intrinsic:</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">2022-05-06 09:49</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;riscv_vector.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">c=a@b, a.shape=[x,y] b.shape=[y,z], c.shape=[x,z]</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">void</span> <span class="org-function-name">matmul</span>(<span class="org-type">int</span> *<span class="org-variable-name">a</span>, <span class="org-type">int</span> *<span class="org-variable-name">b</span>, <span class="org-type">int</span> *<span class="org-variable-name">c</span>, <span class="org-type">int</span> <span class="org-variable-name">x</span>, <span class="org-type">int</span> <span class="org-variable-name">y</span>, <span class="org-type">int</span> <span class="org-variable-name">z</span>) {
    <span class="org-type">int</span> <span class="org-variable-name">tmp</span>[] = {0, 0, 0};
    <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; x; i++) {
        <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">j</span> = 0; j &lt; z; j++) {
            <span class="org-type">int</span> *<span class="org-variable-name">a_offset</span> = a + i * y;
            <span class="org-type">int</span> *<span class="org-variable-name">b_offset</span> = b + j;
            <span class="org-type">vint32m1_t</span> <span class="org-variable-name">accu</span> = vmv_v_x_i32m1(0, 1);
            <span class="org-type">int</span> <span class="org-variable-name">remain</span> = y;
            <span class="org-keyword">while</span> (remain != 0) {
                <span class="org-type">int</span> <span class="org-variable-name">vlen</span> = vsetvl_e32m1(remain);
                <span class="org-type">vint32m1_t</span> <span class="org-variable-name">aa</span> = vle32_v_i32m1(a_offset, vlen);
                <span class="org-type">vint32m1_t</span> <span class="org-variable-name">bb</span> = vlse32_v_i32m1(b_offset, z * 4, vlen);
                <span class="org-type">vint32m1_t</span> <span class="org-variable-name">cc</span> = vmul_vv_i32m1(aa, bb, vlen);
                accu = vredsum_vs_i32m1_i32m1(accu, cc, accu, vlen);
                a_offset += vlen;
                b_offset += vlen * z;
                remain -= vlen;
            }
            <span class="org-type">int</span> <span class="org-variable-name">result</span> = vmv_x_s_i32m1_i32(accu);
            *(c++) = result;
        }
    }
}

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[]) {
    <span class="org-type">int</span> <span class="org-variable-name">a</span>[] = {1, 2, 3, 4, 5, 6};
    <span class="org-type">int</span> <span class="org-variable-name">b</span>[] = {1, 2, 3, 4, 5, 6};
    <span class="org-type">int</span> <span class="org-variable-name">c</span>[] = {0, 0, 0, 0};

    matmul(a, b, c, 2, 3, 2);

    <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; 2; i++) {
        <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">j</span> = 0; j &lt; 2; j++) {
            printf(<span class="org-string">"%d "</span>, c[i * 2 + j]);
        }
        printf(<span class="org-string">"\n"</span>);
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000008b" class="outline-3">
<h3 id="org000008b"><span class="section-number-3">1.5.</span> gcc rvv auto vectorization</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">2022-05-06 13:39</span>
<span class="org-type">void</span> <span class="org-function-name">foo</span>(<span class="org-type">int</span> *<span class="org-variable-name">a</span>, <span class="org-type">int</span> *<span class="org-variable-name">b</span>, <span class="org-type">int</span> <span class="org-variable-name">len</span>) {
    <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; len; i++) {
        a[i] += b[i];
    }
}
</pre>
</div>

<pre class="example" id="org000008a">
$&gt; /opt/riscv-rvv/bin/riscv64-unknown-elf-gcc -march=rv64gcv ./rvv.c -g -mrvv -c -ftree-vectorize -O2
$&gt;  /opt/riscv-rvv/bin/riscv64-unknown-elf-objdump -d ./rvv.o
...
...
0000000000000018 &lt;.L4&gt;:
  18:   05067757                vsetvli a4,a2,e32,m1,ta,mu
  1c:   02056c07                vle32.v v24,(a0)
  20:   0205ec87                vle32.v v25,(a1)
  24:   038c8c57                vadd.vv v24,v24,v25
  28:   02056c27                vse32.v v24,(a0)
  2c:   8e19                    sub     a2,a2,a4
  2e:   953e                    add     a0,a0,a5
  30:   95be                    add     a1,a1,a5
  32:   f27d                    bnez    a2,18 &lt;.L4&gt;
  34:   8082                    ret
...
...
</pre>
</div>
</div>

<div id="outline-container-org0000094" class="outline-3">
<h3 id="org0000094"><span class="section-number-3">1.6.</span> misc</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org000008e" class="outline-4">
<h4 id="org000008e"><span class="section-number-4">1.6.1.</span> vector vs. simd</h4>
<div class="outline-text-4" id="text-1-6-1">
<ul class="org-ul">
<li><a href="https://www.bitsnbites.eu/three-fundamental-flaws-of-simd/">Three fundamental flaws of SIMD ISA:s</a></li>
<li><a href="https://www.sigarch.org/simd-instructions-considered-harmful/">SIMD Instructions Considered Harmful</a></li>
</ul>
</div>
</div>

<div id="outline-container-ID-a05733ad-d9ce-4fc4-b76c-9f15770c0c4b" class="outline-4">
<h4 id="ID-a05733ad-d9ce-4fc4-b76c-9f15770c0c4b"><span class="section-number-4">1.6.2.</span> riscv p extension</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
<a href="https://github.com/riscv/riscv-p-spec">riscv p extension</a>
</p>

<p>
<a href="https://www.youtube.com/watch?v=ABlOVjAsi3s">RISC-V DSP (P) Extension Proposal
</a>
</p>

<p>
p extension: Packed-SIMD <b>DSP</b> extension operating on <b>XLEN-bit</b> <b>integer</b>
registers for <b>embedded</b> RISC-V processors
</p>

<ul class="org-ul">
<li>p 扩展不支持 floating point, 它主要面向定点化的 dsp 算法</li>

<li>p 扩展使用普通的 GPR 寄存器, 所以它的宽度就是寄存器的宽度, 例如 RV64 上就是 64
bit, 比 128 bit 的 neon 指令要小</li>

<li>p 扩展支持 add, shift, mul, min, max 以及 cross add and sub 等 simd 计算, 但都是 element wise 的操作, 不存在 vector 中的 reduce 类指令, 也没有 mask, stride,
index 等操作</li>

<li>p 扩展支持一些 dsp (non-simd) 计算, 例如 ave (计算两个 gpr 的均值), ksubh (两个 gpr 的 q15 饱和加法)</li>
</ul>
</div>


<div id="outline-container-org0000091" class="outline-5 references">
<h5 id="org0000091">Backlinks</h5>
<div class="outline-text-5" id="text-org0000091">
<p>
<a href="../toolchain/gcc_backend.html#ID-02e7f924-9cf7-4e3d-8ceb-1765fd3a2bed">GCC Backend</a>
(<i>GCC Backend &gt; misc &gt; intrinsic</i>):  通过 intrinsic 可以扩展 gcc 以支持 backend 自定义指令. 例如, 假设后端包含许多 dsp 指令 (例如 <a href="#ID-a05733ad-d9ce-4fc4-b76c-9f15770c0c4b">RISC-V P Extension</a>), 那么支持它有两种方式:
</p>
</div>
</div>
</div>
</div>
</div>



<div id="outline-container-org000009a" class="outline-2 references">
<h2 id="org000009a">Backlinks</h2>
<div class="outline-text-2" id="text-org000009a">
<p>
<a href="riscv_tutorial.html#ID-653c6b58-7ee1-4e07-bf3f-d5eea450748e">RISC-V Tutorial</a>
(<i>RISC-V Tutorial &gt; Standard Extention &gt; RV32V</i>):  <a href="riscv_vector_extension.html#ID-1a3f764a-c401-4233-bd66-f809ada336f1">RISC-V Vector Extension</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway@dogdog.run<br />
Date: 2022-04-28 Thu 19:05<br />
Last updated: 2022-11-09 Wed 16:02</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</div>
</body>
</html>
