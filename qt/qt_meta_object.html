<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 11:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qt Meta Object</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Qt Meta Object</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcedb64c">1. Qt Meta Object</a>
<ul>
<li><a href="#orgafba2be">1.1. Overview</a></li>
<li><a href="#org1082a5d">1.2. moc_xxx 的结构</a>
<ul>
<li><a href="#orgc85a60f">1.2.1. stringdata</a></li>
<li><a href="#org05aead9">1.2.2. metadata</a></li>
<li><a href="#org9907b60">1.2.3. metacall</a></li>
<li><a href="#orgcba882f">1.2.4. metacast</a></li>
<li><a href="#orga5dcbe8">1.2.5. signal 的实现</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgcedb64c" class="outline-2">
<h2 id="orgcedb64c"><span class="section-number-2">1</span> Qt Meta Object</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgafba2be" class="outline-3">
<h3 id="orgafba2be"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
对于声明了 Q_OBJECT 的 class xxx, moc 会负责生成一个
moc_xxx.cpp, 包含 xxx 对应的 meta object 的定义.
</p>

<p>
meta object 的主要功能是:
</p>

<ol class="org-ol">
<li>metadata, 包括关于 class 的 introspection 信息, property 的 introspection 信
息, method(metacal) 信息等</li>

<li>metacast, 实现 qobject_cast</li>

<li>metacall

<ol class="org-ol">
<li>property 的 READ, WRITE 等功能</li>

<li>invokeable method, signal, slot 的调用</li>
</ol></li>
</ol>

<p>
signal/slot 的具体实现(如何 connect 及调用) 并不包含在 meta object 本身中.
</p>
</div>
</div>

<div id="outline-container-org1082a5d" class="outline-3">
<h3 id="org1082a5d"><span class="section-number-3">1.2</span> moc_xxx 的结构</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orgc85a60f" class="outline-4">
<h4 id="orgc85a60f"><span class="section-number-4">1.2.1</span> stringdata</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
meta object 所有功能都依赖于对 class, property, signal, slot 等的 introspection,
所以需要记下所有相关的字符串, 以便后面查找和匹配
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold;">static</span> <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">qt_meta_stringdata_MessageBox_t</span> <span style="font-weight: bold; font-style: italic;">qt_meta_stringdata_MessageBox</span> = {
    {
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#31867;&#21517;</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">(0,0,10) &#20998;&#21035;&#34920;&#31034; (idx, offset, len)</span>
        QT_MOC_LITERAL(0, 0, 10), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"MessageBox"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signal</span>
        QT_MOC_LITERAL(1, 11, 13), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"heightChanged"</span>
        QT_MOC_LITERAL(2, 25, 0), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">""</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signal</span>
        QT_MOC_LITERAL(3, 26, 15), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"changedTwoTimes"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signal</span>
        QT_MOC_LITERAL(4, 42, 16), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"oopsWidthChanged"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">slot</span>
        QT_MOC_LITERAL(5, 59, 13), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"onTextChanged"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Q_INVOKABLE method</span>
        QT_MOC_LITERAL(6, 73, 3), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"foo"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">property</span>
        QT_MOC_LITERAL(7, 77, 6), <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"height"</span>
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">property</span>
        QT_MOC_LITERAL(8, 84, 5) <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"width"</span>

    },
    <span style="font-style: italic;">"MessageBox\0heightChanged\0\0changedTwoTimes\0"</span>
    <span style="font-style: italic;">"oopsWidthChanged\0onTextChanged\0foo\0"</span>
    <span style="font-style: italic;">"height\0width"</span>
};
</pre>
</div>
</div>
</div>


<div id="outline-container-org05aead9" class="outline-4">
<h4 id="org05aead9"><span class="section-number-4">1.2.2</span> metadata</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold;">static</span> <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">uint</span> <span style="font-weight: bold; font-style: italic;">qt_meta_data_MessageBox</span>[] = {

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">content:</span>
    8,       <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">revision</span>

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">className &#30340; idx &#20026; 0, &#21363; MessageBox</span>
    0,       <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">classname</span>
    0,    0, <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">classinfo</span>

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#26377; 5 &#20010; methods, &#30456;&#20851;&#20449;&#24687;&#25152;&#22312;&#20559;&#31227;&#37327;&#20026; 14, &#21363;&#19979;&#38754;&#30340; // signals:... &#22788;</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">5 &#20010; method &#20998;&#21035;&#26159;: 3 &#20010; signal, 1 &#20010; slot, 1 &#20010; invokeable method</span>
    5,   14, <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">methods</span>

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">2 &#20010; property, &#30456;&#20851;&#20449;&#24687;&#30340;&#25152;&#22312;&#30340;&#20559;&#31227;&#37327;&#20026; 46</span>
    2,   46, <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">properties</span>

    0,    0, <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">enums/sets</span>
    0,    0, <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">constructors</span>
    0,       <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">flags</span>
    3,       <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signalCount</span>

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signals: name, argc, parameters, tag, flags</span>
    1,    0,   39,    2, 0x06 <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Public</span><span style="font-weight: bold; font-style: italic;"> */</span>,
    3,    0,   40,    2, 0x06 <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Public</span><span style="font-weight: bold; font-style: italic;"> */</span>,
    4,    0,   41,    2, 0x06 <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Public</span><span style="font-weight: bold; font-style: italic;"> */</span>,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">slots: name, argc, parameters, tag, flags</span>
    5,    1,   42,    2, 0x0a <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Public</span><span style="font-weight: bold; font-style: italic;"> */</span>,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">methods: name, argc, parameters, tag, flags</span>
    6,    0,   45,    2, 0x02 <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Public</span><span style="font-weight: bold; font-style: italic;"> */</span>,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">signals: parameters</span>
    <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Void,
    <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Void,
    <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Void,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">slots: parameters</span>
    <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Void, <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::QString,    2,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">methods: parameters</span>
    <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Void,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">properties: name, type, flags</span>
    7, <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Int, 0x00495003,
    8, <span style="font-weight: bold; text-decoration: underline;">QMetaType</span>::Int, 0x00095103,

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">properties: notify_signal_id</span>
    0,
    0,

    0        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">eod</span>
}
</pre>
</div>

<p>
该结构体与 QMetaObjectPrivate 对应:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">QMetaObjectPrivate</span>
{
    <span style="font-weight: bold;">enum</span> { <span style="font-weight: bold; font-style: italic;">OutputRevision</span> = 8 }; <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Used by moc, qmetaobjectbuilder and qdbus</span>

    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">revision</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">className</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">classInfoCount</span>, <span style="font-weight: bold; font-style: italic;">classInfoData</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">methodCount</span>, <span style="font-weight: bold; font-style: italic;">methodData</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">propertyCount</span>, <span style="font-weight: bold; font-style: italic;">propertyData</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">enumeratorCount</span>, <span style="font-weight: bold; font-style: italic;">enumeratorData</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">constructorCount</span>, <span style="font-weight: bold; font-style: italic;">constructorData</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">flags</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">signalCount</span>;
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9907b60" class="outline-4">
<h4 id="org9907b60"><span class="section-number-4">1.2.3</span> metacall</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
metacall 是 meta object 最重要的部分, 它实现三种不同的 Call:
</p>

<ol class="org-ol">
<li>InvokeMetaMethod</li>
<li>IndexOfMethod</li>
<li>Property 相关: READ, WRITE, RESET, &#x2026;</li>
</ol>

<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">qt_metacall</span>(<span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::<span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="font-weight: bold; font-style: italic;">_c</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">_id</span>, <span style="font-weight: bold; text-decoration: underline;">void</span> **<span style="font-weight: bold; font-style: italic;">_a</span>)
{
    _id = <span style="font-weight: bold; text-decoration: underline;">QObject</span>::qt_metacall(_c, _id, _a);
    <span style="font-weight: bold;">if</span> (_id &lt; 0)
        <span style="font-weight: bold;">return</span> _id;
    <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::InvokeMetaMethod) {
        <span style="font-weight: bold;">if</span> (_id &lt; 5)
            qt_static_metacall(<span style="font-weight: bold;">this</span>, _c, _id, _a);
        _id -= 5;
    } 
    <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::ReadProperty || _c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::WriteProperty
             || _c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::ResetProperty || _c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::RegisterPropertyMetaType) {
        qt_static_metacall(<span style="font-weight: bold;">this</span>, _c, _id, _a);
        _id -= 2;
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">else ...</span>
    <span style="font-weight: bold;">return</span> _id;
}

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">qt_static_metacall</span>(<span style="font-weight: bold; text-decoration: underline;">QObject</span> *<span style="font-weight: bold; font-style: italic;">_o</span>, <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::<span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="font-weight: bold; font-style: italic;">_c</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">_id</span>, <span style="font-weight: bold; text-decoration: underline;">void</span> **<span style="font-weight: bold; font-style: italic;">_a</span>)
{
    <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::InvokeMetaMethod) {
        <span style="font-weight: bold;">auto</span> *<span style="font-weight: bold; font-style: italic;">_t</span> = <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span> *&gt;(_o);
        Q_UNUSED(_t)
                <span style="font-weight: bold;">switch</span> (_id) {
                    <span style="font-weight: bold;">case</span> 0: _t-&gt;heightChanged(); <span style="font-weight: bold;">break</span>;
                    <span style="font-weight: bold;">case</span> 1: _t-&gt;changedTwoTimes(); <span style="font-weight: bold;">break</span>;
                    <span style="font-weight: bold;">case</span> 2: _t-&gt;oopsWidthChanged(); <span style="font-weight: bold;">break</span>;
                    <span style="font-weight: bold;">case</span> 3: _t-&gt;onTextChanged((*<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">QString</span>(*)&gt;(_a[1]))); <span style="font-weight: bold;">break</span>;
                    <span style="font-weight: bold;">case</span> 4: _t-&gt;foo(); <span style="font-weight: bold;">break</span>;
                    <span style="font-weight: bold;">default</span>: ;
                }
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::IndexOfMethod) {
        <span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">result</span> = <span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">int</span> *&gt;(_a[0]);
        {
            <span style="font-weight: bold;">using</span> <span style="font-weight: bold; text-decoration: underline;">_t</span> = <span style="font-weight: bold; text-decoration: underline;">void</span> (<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::*)();
            <span style="font-weight: bold;">if</span> (*<span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span> *&gt;(_a[1]) == <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span>&gt;(&amp;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::heightChanged)) {
                *result = 0;
                <span style="font-weight: bold;">return</span>;
            }
        }
        {
            <span style="font-weight: bold;">using</span> <span style="font-weight: bold; text-decoration: underline;">_t</span> = <span style="font-weight: bold; text-decoration: underline;">void</span> (<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::*)();
            <span style="font-weight: bold;">if</span> (*<span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span> *&gt;(_a[1]) == <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span>&gt;(&amp;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::changedTwoTimes)) {
                *result = 1;
                <span style="font-weight: bold;">return</span>;
            }
        }
        {
            <span style="font-weight: bold;">using</span> <span style="font-weight: bold; text-decoration: underline;">_t</span> = <span style="font-weight: bold; text-decoration: underline;">void</span> (<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::*)();
            <span style="font-weight: bold;">if</span> (*<span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span> *&gt;(_a[1]) == <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">_t</span>&gt;(&amp;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::oopsWidthChanged)) {
                *result = 2;
                <span style="font-weight: bold;">return</span>;
            }
        }
    }
    <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::ReadProperty) {
        <span style="font-weight: bold;">auto</span> *<span style="font-weight: bold; font-style: italic;">_t</span> = <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span> *&gt;(_o);
        Q_UNUSED(_t)
                <span style="font-weight: bold; text-decoration: underline;">void</span> *<span style="font-weight: bold; font-style: italic;">_v</span> = _a[0];
        <span style="font-weight: bold;">switch</span> (_id) {
            <span style="font-weight: bold;">case</span> 0: *<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">int</span>*&gt;(_v) = _t-&gt;mHeight; <span style="font-weight: bold;">break</span>;
            <span style="font-weight: bold;">case</span> 1: *<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">int</span>*&gt;(_v) = _t-&gt;width(); <span style="font-weight: bold;">break</span>;
            <span style="font-weight: bold;">default</span>: <span style="font-weight: bold;">break</span>;
        }
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::WriteProperty) {
        <span style="font-weight: bold;">auto</span> *<span style="font-weight: bold; font-style: italic;">_t</span> = <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">MessageBox</span> *&gt;(_o);
        Q_UNUSED(_t)
                <span style="font-weight: bold; text-decoration: underline;">void</span> *<span style="font-weight: bold; font-style: italic;">_v</span> = _a[0];
        <span style="font-weight: bold;">switch</span> (_id) {
            <span style="font-weight: bold;">case</span> 0:
                <span style="font-weight: bold;">if</span> (_t-&gt;mHeight != *<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">int</span>*&gt;(_v)) {
                    _t-&gt;mHeight = *<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">int</span>*&gt;(_v);
                    <span style="font-weight: bold; text-decoration: underline;">Q_EMIT</span> <span style="font-weight: bold; font-style: italic;">_t</span>-&gt;heightChanged();
                }
                <span style="font-weight: bold;">break</span>;
            <span style="font-weight: bold;">case</span> 1: _t-&gt;setWidth(*<span style="font-weight: bold;">reinterpret_cast</span>&lt; <span style="font-weight: bold; text-decoration: underline;">int</span>*&gt;(_v)); <span style="font-weight: bold;">break</span>;
            <span style="font-weight: bold;">default</span>: <span style="font-weight: bold;">break</span>;
        }
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (_c == <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::ResetProperty) {
    }
}
</pre>
</div>
</div>

<div id="outline-container-org5e48faa" class="outline-5">
<h5 id="org5e48faa"><span class="section-number-5">1.2.3.1</span> InvokeMetaMethod</h5>
<div class="outline-text-5" id="text-1-2-3-1">
<p>
signal, slot, invokeable method 都可以通过 meta object 的方式被调用, 例如 QML 中
可以直接调用这三种函数, 通过 signal 可以间接调用到 slot 等.
</p>

<p>
调用这些函数最终都要通过 InvokeMetaMethod 进行, 每个方法在编译时确定一个 id, 后
面通过 id 来区分不同的方法.
</p>
</div>
</div>

<div id="outline-container-orgc937dfd" class="outline-5">
<h5 id="orgc937dfd"><span class="section-number-5">1.2.3.2</span> IndexOfMethod</h5>
<div class="outline-text-5" id="text-1-2-3-2">
<p>
connect 时会调用这个方法获得对应的 slot 的 id, 然后在调用 slot 时可以使用
这个 id 调用 InvokeMetaMethod(id).
</p>

<p>
由于这里使用的是 static_cast, 所以它实际是给新的 functor-based connect 使用的, 而
非旧的 string-based connect
</p>
</div>
</div>

<div id="outline-container-org3b21cb5" class="outline-5">
<h5 id="org3b21cb5"><span class="section-number-5">1.2.3.3</span> Property READ/WRITE</h5>
<div class="outline-text-5" id="text-1-2-3-3">
<p>
对 property 的读写会翻译为对应的 metacall
</p>
</div>
</div>

<div id="outline-container-org023748e" class="outline-5">
<h5 id="org023748e"><span class="section-number-5">1.2.3.4</span> 关于 metacall</h5>
<div class="outline-text-5" id="text-1-2-3-4">
<ol class="org-ol">
<li>把 metacall 最终调用到的具体函数设置为 virtual 会导致 metacall 的行为受到多态
的影响</li>

<li>由于 qt_metacall 会先调用基类的 qt_metacall, 所以 property 也会表现出`继承`的
行为</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgcba882f" class="outline-4">
<h4 id="orgcba882f"><span class="section-number-4">1.2.4</span> metacast</h4>
<div class="outline-text-4" id="text-1-2-4">
<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold; text-decoration: underline;">void</span> *<span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">qt_metacast</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span> *<span style="font-weight: bold; font-style: italic;">_clname</span>)
{
    <span style="font-weight: bold;">if</span> (!_clname) <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">nullptr</span>;
    <span style="font-weight: bold;">if</span> (!strcmp(_clname, qt_meta_stringdata_MessageBox.stringdata0))
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">void</span>*&gt;(<span style="font-weight: bold;">this</span>);
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">QObject</span>::qt_metacast(_clname);
}
</pre>
</div>

<p>
由于 meta object 包含了 class 相关的 introspection 信息, 所以它可以不依赖 c++
RTTI 进行 dynamic_cast, 即 qobject_cast.
</p>

<p>
qt_metacast 就是用来实现 qobject_cast 的: 能不能 cast 直接比较 classname 是否相
同即可&#x2026;
</p>
</div>
</div>

<div id="outline-container-orga5dcbe8" class="outline-4">
<h4 id="orga5dcbe8"><span class="section-number-4">1.2.5</span> signal 的实现</h4>
<div class="outline-text-4" id="text-1-2-5">
<p>
xxx 只是声明了 signal 的函数原型, 并不包含具体的实现, moc 会生成一个具体的实现,
用来根据 connection 信息调用到具体的 slot
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">SIGNAL 0</span>
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">heightChanged</span>()
{
    <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::activate(<span style="font-weight: bold;">this</span>, &amp;staticMetaObject, 0, <span style="font-weight: bold; text-decoration: underline;">nullptr</span>);
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">SIGNAL 1</span>
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">changedTwoTimes</span>()
{
    <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::activate(<span style="font-weight: bold;">this</span>, &amp;staticMetaObject, 1, <span style="font-weight: bold; text-decoration: underline;">nullptr</span>);
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">SIGNAL 2</span>
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MessageBox</span>::<span style="font-weight: bold;">oopsWidthChanged</span>()
{
    <span style="font-weight: bold; text-decoration: underline;">QMetaObject</span>::activate(<span style="font-weight: bold;">this</span>, &amp;staticMetaObject, 2, <span style="font-weight: bold; text-decoration: underline;">nullptr</span>);
}
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2020-01-02 Thu 00:00<br />
Last updated: 2021-09-16 Thu 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
