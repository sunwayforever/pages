<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 01:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Java Binder</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Java Binder</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb5a0ff1">1. Java Binder</a>
<ul>
<li><a href="#org3ce9d9d">1.1. Parcel</a>
<ul>
<li><a href="#org9f962ff">1.1.1. Java Parcel 的 recycle</a></li>
</ul>
</li>
<li><a href="#org5c1fc3e">1.2. AIDL</a>
<ul>
<li><a href="#org0de7da7">1.2.1. IXx.stub</a></li>
<li><a href="#org5d3df7d">1.2.2. IXx.stub.proxy</a></li>
</ul>
</li>
<li><a href="#org1efbb5c">1.3. Java Binder vs. C++ binder</a>
<ul>
<li><a href="#orgeb5b385">1.3.1. Java BinderProxy</a></li>
<li><a href="#org6f53d53">1.3.2. Java Binder</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgb5a0ff1" class="outline-2">
<h2 id="orgb5a0ff1"><span class="section-number-2">1</span> Java Binder</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3ce9d9d" class="outline-3">
<h3 id="org3ce9d9d"><span class="section-number-3">1.1</span> Parcel</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org9f962ff" class="outline-4">
<h4 id="org9f962ff"><span class="section-number-4">1.1.1</span> Java Parcel 的 recycle</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
java 提供了一个 parcel pool, 可以通过 Parcel.obtain/Parcel.recycle 有
快速的分配 Parcel.  比如 aidl 生成的代码:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@Override</span> <span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">test</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">x</span>) <span style="font-weight: bold;">throws</span> <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">RemoteException</span>
{
    <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">Parcel</span> <span style="font-weight: bold; font-style: italic;">_data</span> = <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.Parcel.obtain();
    <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">Parcel</span> <span style="font-weight: bold; font-style: italic;">_reply</span> = <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.Parcel.obtain();
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">_result</span>;
    <span style="font-weight: bold;">try</span> {
        _data.writeInterfaceToken(DESCRIPTOR);
        _data.writeInt(x);
        mRemote.transact(<span style="font-weight: bold; text-decoration: underline;">Stub</span>.TRANSACTION_test, _data, _reply, 0);
        _reply.readException();
        _result = _reply.readInt();
    }
    <span style="font-weight: bold;">finally</span> {
        _reply.recycle();       <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">case 1</span>
        _data.recycle();        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">case 2</span>
    }
    <span style="font-weight: bold;">return</span> _result;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@Override</span> <span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">boolean</span> <span style="font-weight: bold;">onTransact</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">code</span>, <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">Parcel</span> <span style="font-weight: bold; font-style: italic;">data</span>, <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">Parcel</span> <span style="font-weight: bold; font-style: italic;">reply</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">flags</span>) <span style="font-weight: bold;">throws</span> <span style="font-weight: bold; text-decoration: underline;">android</span>.<span style="font-weight: bold; text-decoration: underline;">os</span>.<span style="font-weight: bold; text-decoration: underline;">RemoteException</span>
{
    <span style="font-weight: bold;">switch</span> (code)
    {
        <span style="font-weight: bold;">case</span> INTERFACE_TRANSACTION:
        {
            reply.writeString(DESCRIPTOR);
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
        }
        <span style="font-weight: bold;">case</span> TRANSACTION_test:
        {
            data.enforceInterface(DESCRIPTOR);
            <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">_arg0</span>;
            _arg0 = data.readInt();
            <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">_result</span> = <span style="font-weight: bold;">this</span>.test(_arg0);
            reply.writeNoException();
            reply.writeInt(_result);
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">case 3, why data not recycled?</span>
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">true</span>;
        }
    }
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">super</span>.onTransact(code, data, reply, flags);
}
</pre>
</div>

<p>
其中 Parcle.recycle 除了和 Parcle pool 有关, 还会释放 binder_buffer.
</p>

<p>
若一个 parcel 通过 ipcSetDataReference 与 binder_buffer 关联, 则
Parcle.recycle 时调用到底层的 BC_FREE_BUFFER. 
</p>

<p>
client 端的 reply parcel 和 server 端的 data parcel 与 binder_buffer
是关联的.  
</p>

<p>
所以上面代码中, case 1 会释放 client 进程的 binder_buffer, case 2 并不
会释放任务 binder_buffer, 因为 proxy 端的 _data 并不与 binder_buffer
关联.
</p>

<p>
case 3 中的 data 也是需要释放其 binder_buffer 的, 但 aidl 生成代码并没有
做, 因为 c++ 一层的 IPCTheadState 会负责调用 parcel 的析构函数.
</p>
</div>
</div>
</div>

<div id="outline-container-org5c1fc3e" class="outline-3">
<h3 id="org5c1fc3e"><span class="section-number-3">1.2</span> AIDL</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0de7da7" class="outline-4">
<h4 id="org0de7da7"><span class="section-number-4">1.2.1</span> IXx.stub</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
stub is essentially a binder, but it do additional two things:
</p>
<ol class="org-ol">
<li>Imlements some stubs side IXx funtions.</li>
<li>Auto dispatching to those functions according to unmarshalling result.</li>
</ol>

<p>
stub implement both Binder and IXx.
</p>

<ol class="org-ol">
<li>It implements Binder, and implements onTransact(), so it can be
returned when OnBind, or addService as IBinder&#x2026; as the stub.</li>

<li>It implements IXx, so it will implents those stub side functions of
IXx, e.g.  IXx.foo.  stub.onTransact will call IXx.foo according to
the unmarshalling result.</li>
</ol>
</div>
</div>

<div id="outline-container-org5d3df7d" class="outline-4">
<h4 id="org5d3df7d"><span class="section-number-4">1.2.2</span> IXx.stub.proxy</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
proxy only implements IXx, and it will take an IBinder as ctor
param. It should be taken as a helper utility for the ibinder. So:
</p>

<ol class="org-ol">
<li>It implements IXx, so it will implements IXx proxy side functions,
e.g. IXx.foo, those functions do nothing but marshalling the params
and then call remote-&gt;transact.</li>

<li>It take an IBinder as ctor param(the 'remote' var), so it can use
the IBinder to do proxy works. e.g. Call
ibinder-&gt;transact. IXx.asInterface(ibinder) actually call
IXx.stub.proxy(ibinder) to convert the ibinder as an proxy
interface.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org1efbb5c" class="outline-3">
<h3 id="org1efbb5c"><span class="section-number-3">1.3</span> Java Binder vs. C++ binder</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Java binder 是 c++ binder 的简单封装, 其中:
</p>
<ol class="org-ol">
<li>Java Binder 对应 c++ 的 JavaBBinder</li>
<li>Java BinderProxy 对应 c++ 的 BpBinder</li>
</ol>
</div>

<div id="outline-container-orgeb5b385" class="outline-4">
<h4 id="orgeb5b385"><span class="section-number-4">1.3.1</span> Java BinderProxy</h4>
<div class="outline-text-4" id="text-1-3-1">
<ul class="org-ul">
<li><p>
初始化
</p>
<pre class="example" id="org68e0d34">
// BinderProxy (或者说 BpBinder, binder_ref) 都是在 binder 在 parcel 中传递时被初始化的
// (除了 service_manager)
Parcel.java::readStrongBinder
  nativeReadStrongBinder
    javaObjectForIBinder(env, parcel-&gt;readStrongBinder())
      env-&gt;NewObject(gBinderProxyOffsets.mClass, gBinderProxyOffsets.mConstructor);
</pre></li>

<li><p>
transact
</p>
<pre class="example" id="orgda79445">
IBinder.transact()   // binder proxy in java is BinderProxy
  BinderProxy.transact() // native
    android_os_BinderProxy_transact() // in android_util_Binder.cpp
      IBinder* target = env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject); //target is a BpBinder
        err=BpBinder-&gt;transact()-&gt;IPCThreadState-&gt;transact()
          ...
        signalExceptionForError(env, obj, err);
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org6f53d53" class="outline-4">
<h4 id="org6f53d53"><span class="section-number-4">1.3.2</span> Java Binder</h4>
<div class="outline-text-4" id="text-1-3-2">
<ul class="org-ul">
<li><p>
初始化
</p>
<pre class="example" id="org78a2627">
Binder() // ctor
  init(); // native
    android_os_Binder_init()
      // c++
      JavaBBinderHolder(env, clazz); // JavaBBinderHolder is a lazy holder for JavaBBinder
      // lazy evaluation of JavaBBinderHolder.get() will init JavaBBinder and set to gBinderOffsets.mObject
      env-&gt;SetIntField(clazz, gBinderOffsets.mObject, (int)jbh);
</pre></li>

<li><p>
onTransact
</p>
<div class="org-src-container">
<pre class="src src-text">JavaBBinder.onTransact() // c++
  env-&gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact, ...)
    Binder.execTransact()
      Binder.onTransact()
  excep = env-&gt;ExceptionOccurred();
  report_exception(env, excep,...)
</pre>
</div></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2017-04-04 Tue 00:00<br />
Last updated: 2021-08-28 Sat 23:12</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
