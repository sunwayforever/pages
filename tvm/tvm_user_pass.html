<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 Wed 00:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TVM User Pass</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">TVM User Pass</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc5adf37">1. TVM User Pass</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc5adf37" class="outline-2">
<h2 id="orgc5adf37"><span class="section-number-2">1</span> TVM User Pass</h2>
<div class="outline-text-2" id="text-1">
<p>
下面实现的 `Broadcast` transform 是为了解决 dnnl 无法处理 broadcast 的问题, 做法
是针对某些操作 (如 add), 把它的 lhs 和 rhs 按需加上 broadcast_to 操作
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2021-09-24 10:32</span>
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> relay
<span style="font-weight: bold;">from</span> tvm.contrib <span style="font-weight: bold;">import</span> graph_executor
<span style="font-weight: bold;">from</span> tvm.topi.utils <span style="font-weight: bold;">import</span> get_const_tuple


<span style="font-weight: bold; text-decoration: underline;">@relay.transform.function_pass</span>(opt_level=1)
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Broadcast</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, *args):
        <span style="font-weight: bold;">self</span>.supported_ops = args

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">transform_function</span>(<span style="font-weight: bold;">self</span>, func, mod, ctx):
        <span style="font-weight: bold; font-style: italic;">obj</span> = <span style="font-weight: bold;">self</span>

        <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BroadcastTo</span>(tvm.relay.ExprMutator):
            <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">infer_type</span>(<span style="font-weight: bold;">self</span>, node):
                <span style="font-weight: bold; font-style: italic;">mod</span> = tvm.IRModule.from_expr(node)
                <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.InferType()(mod)
                <span style="font-weight: bold; font-style: italic;">entry</span> = mod[<span style="font-style: italic;">"main"</span>]
                <span style="font-weight: bold;">return</span> entry <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">isinstance</span>(node, relay.Function) <span style="font-weight: bold;">else</span> entry.body

            <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">visit_call</span>(<span style="font-weight: bold;">self</span>, call):
                <span style="font-weight: bold;">if</span> call.op.name <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> obj.supported_ops:
                    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">super</span>().visit_call(call)

                <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">len</span>(call.args) != 2:
                    <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">TypeError</span>(
                        f<span style="font-style: italic;">"only 2 args is supported, {call.op.name} have {len(call.args)} args"</span>
                    )
                <span style="font-weight: bold; font-style: italic;">lhs</span> = <span style="font-weight: bold;">self</span>.visit(call.args[0])
                <span style="font-weight: bold; font-style: italic;">rhs</span> = <span style="font-weight: bold;">self</span>.visit(call.args[1])
                <span style="font-weight: bold; font-style: italic;">lhs_shape</span> = get_const_tuple(<span style="font-weight: bold;">self</span>.infer_type(lhs).checked_type.shape)
                <span style="font-weight: bold; font-style: italic;">rhs_shape</span> = get_const_tuple(<span style="font-weight: bold;">self</span>.infer_type(rhs).checked_type.shape)

                <span style="font-weight: bold; font-style: italic;">dtype</span> = <span style="font-weight: bold;">self</span>.infer_type(lhs).checked_type.dtype
                <span style="font-weight: bold; font-style: italic;">out_shape</span> = np.broadcast(np.empty(lhs_shape), np.empty(rhs_shape)).shape

                <span style="font-weight: bold;">if</span> out_shape != lhs_shape:
                    <span style="font-weight: bold; font-style: italic;">lhs</span> = relay.op.broadcast_to(lhs, out_shape)
                <span style="font-weight: bold;">if</span> out_shape != rhs_shape:
                    <span style="font-weight: bold; font-style: italic;">rhs</span> = relay.op.broadcast_to(rhs, out_shape)

                <span style="font-weight: bold;">return</span> relay.expr.Call(
                    call.op, (lhs, rhs), call.attrs, call.type_args, call.span
                )

        <span style="font-weight: bold;">return</span> BroadcastTo().visit(func)


<span style="font-weight: bold; font-style: italic;">shape_a</span>, <span style="font-weight: bold; font-style: italic;">shape_b</span>, <span style="font-weight: bold; font-style: italic;">shape_c</span> = (1, 10), (1,), (1, 10)
<span style="font-weight: bold; font-style: italic;">a</span> = relay.var(<span style="font-style: italic;">"a"</span>, shape=shape_a, dtype=<span style="font-style: italic;">"float32"</span>)
<span style="font-weight: bold; font-style: italic;">b</span> = relay.var(<span style="font-style: italic;">"b"</span>, shape=shape_b, dtype=<span style="font-style: italic;">"float32"</span>)
<span style="font-weight: bold; font-style: italic;">c</span> = relay.var(<span style="font-style: italic;">"c"</span>, shape=shape_c, dtype=<span style="font-style: italic;">"float32"</span>)
<span style="font-weight: bold; font-style: italic;">out</span> = relay.add(a, b)
<span style="font-weight: bold; font-style: italic;">out</span> = relay.add(out, c)

<span style="font-weight: bold; font-style: italic;">func</span> = relay.Function([a, b, c], out)
<span style="font-weight: bold; font-style: italic;">mod</span> = tvm.IRModule.from_expr(func)

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"----------before----------"</span>)
<span style="font-weight: bold;">print</span>(mod)

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"----------after----------"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">tvm &#30340; dnnl &#30340; add &#25805;&#20316;&#19981;&#25903;&#25345;&#33258;&#21160; broadcast, &#25152;&#20197;&#27809;&#26377;&#19979;&#38754;&#19968;&#21477;&#20250;&#25253;&#38169;</span>
<span style="font-weight: bold; font-style: italic;">mod</span> = Broadcast(<span style="font-style: italic;">"add"</span>)(mod)
<span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.AnnotateTarget(<span style="font-style: italic;">"dnnl"</span>)(mod)
<span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.PartitionGraph()(mod)
<span style="font-weight: bold;">print</span>(mod)

<span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=0):
    <span style="font-weight: bold; font-style: italic;">lib</span> = relay.build(mod, target=<span style="font-style: italic;">"llvm"</span>, params=<span style="font-weight: bold; text-decoration: underline;">None</span>)

<span style="font-weight: bold; font-style: italic;">rt_mod</span> = graph_executor.GraphModule(lib[<span style="font-style: italic;">"default"</span>](tvm.cpu(0)))
<span style="font-weight: bold; font-style: italic;">x</span>, <span style="font-weight: bold; font-style: italic;">y</span>, <span style="font-weight: bold; font-style: italic;">z</span> = np.ones(shape_a), np.ones(shape_b), np.ones(shape_c)
rt_mod.set_input(<span style="font-style: italic;">"a"</span>, x)
rt_mod.set_input(<span style="font-style: italic;">"b"</span>, y)
rt_mod.set_input(<span style="font-style: italic;">"c"</span>, z)
rt_mod.run()
<span style="font-weight: bold; font-style: italic;">result</span> = rt_mod.get_output(0).numpy()
<span style="font-weight: bold;">print</span>(result)
</pre>
</div>

<p>
-----&#x2013;&#x2014;before-----&#x2013;&#x2014;
def @main(%a: Tensor[(1, 10), float32], %b: Tensor[(1), float32], %c: Tensor[(1, 10), float32]) {
  %0 = add(%a, %b);
  add(%0, %c)
}
</p>

<p>
-----&#x2013;&#x2014;after-----&#x2013;&#x2014;
def @main(%a: Tensor[(1, 10), float32], %b: Tensor[(1), float32], %c: Tensor[(1, 10), float32]) -&gt; Tensor[(1, 10), float32] {
  %0 = broadcast_to(%b, shape=[1, 10], dtype="") <i>* ty=Tensor[(1, 10), float32] *</i>;
  %1 = @tvmgen_default_dnnl_main_0(%a, %0) <i>* ty=Tensor[(1, 10), float32] *</i>;
  @tvmgen_default_dnnl_main_2(%1, %c) <i>* ty=Tensor[(1, 10), float32] *</i>
}
</p>

<p>
def @tvmgen_default_dnnl_main_0(%dnnl_0_i0: Tensor[(1, 10), float32], %dnnl_0_i1: Tensor[(1, 10), float32], Inline=1, Compiler="dnnl", global_symbol="tvmgen_default_dnnl_main_0", Primitive=1) -&gt; Tensor[(1, 10), float32] {
  add(%dnnl_0_i0, %dnnl_0_i1) <i>* ty=Tensor[(1, 10), float32] *</i>
}
</p>

<p>
def @tvmgen_default_dnnl_main_2(%dnnl_2_i0: Tensor[(1, 10), float32], %dnnl_2_i1: Tensor[(1, 10), float32], Inline=1, Compiler="dnnl", global_symbol="tvmgen_default_dnnl_main_2", Primitive=1) -&gt; Tensor[(1, 10), float32] {
  add(%dnnl_2_i0, %dnnl_2_i1) <i>* ty=Tensor[(1, 10), float32] *</i>
}
</p>

<p>

</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2021-09-26 Sun 00:00<br />
Last updated: 2022-01-24 Mon 21:41</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
