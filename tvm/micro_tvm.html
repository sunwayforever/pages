<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 二 15:54 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Micro TVM</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Micro TVM</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6067b39">1. Micro TVM</a>
<ul>
<li><a href="#org6bd8c40">1.1. system-lib</a>
<ul>
<li><a href="#orgf7b7aca">1.1.1. The Problem of DSO</a></li>
<li><a href="#orgaa9af64">1.1.2. C++ Runtime</a></li>
<li><a href="#org22af66e">1.1.3. C Runtime</a></li>
</ul>
</li>
<li><a href="#org8abfa9c">1.2. Static Deploy</a>
<ul>
<li><a href="#orgcd41106">1.2.1. C++ Runtime</a></li>
<li><a href="#orgf448bdd">1.2.2. C Runtime</a></li>
<li><a href="#orgb40ad48">1.2.3. 交叉编译</a></li>
</ul>
</li>
<li><a href="#org2e4f11e">1.3. Micro TVM</a>
<ul>
<li><a href="#org24c2033">1.3.1. Project API</a></li>
<li><a href="#org2b03663">1.3.2. RPC</a></li>
</ul>
</li>
<li><a href="#org14d9e10">1.4. MicroTVM 与 AutoTVM</a>
<ul>
<li><a href="#orgc7a27a4">1.4.1. Impl</a></li>
</ul>
</li>
<li><a href="#orgab47bd2">1.5. Micro TVM &amp; BYOC</a>
<ul>
<li><a href="#orge195064">1.5.1. system-lib &amp; c++ runtime 注册 __tvm_dev_mblob</a></li>
<li><a href="#orgb9a0dc9">1.5.2. system-lib &amp; c runtime 不支持注册和解析 __tvm_dev_mblob</a></li>
<li><a href="#org6f8a2c5">1.5.3. ModulePackImportsToLLVM 的 Bug</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org6067b39" class="outline-2">
<h2 id="org6067b39"><span class="section-number-2">1</span> Micro TVM</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="file:///home/sunway/source/tvm/docs/dev/microtvm_design.rst">file:~/source/tvm/docs/dev/microtvm_design.rst</a>
</p>
</div>

<div id="outline-container-org6bd8c40" class="outline-3">
<h3 id="org6bd8c40"><span class="section-number-3">1.1</span> system-lib</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgf7b7aca" class="outline-4">
<h4 id="orgf7b7aca"><span class="section-number-4">1.1.1</span> The Problem of DSO</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
library 正常是通过 DSO 的形式保存, 并在运行时通过 dlsym 方式来查找符号,
system-lib 机制是为了解决有些系统不支持 dlopen, dlsym 的问题. 如果无法用 dlsym
来查找, 那用什么方式来找到 `tvmgen_default_fused_add`?
</p>

<p>
有两种方案: c++ runtime 或 c runtime
</p>
</div>
</div>

<div id="outline-container-orgaa9af64" class="outline-4">
<h4 id="orgaa9af64"><span class="section-number-4">1.1.2</span> C++ Runtime</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #859900;">import</span> tvm
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> relay

<span style="color: #268bd2;">x</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1000<span style="color: #757575;">),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
<span style="color: #268bd2;">y</span> = relay.add<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>
<span style="color: #268bd2;">func</span> = relay.Function<span style="color: #757575;">(</span>[x]<span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>
<span style="color: #268bd2;">mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>func<span style="color: #757575;">)</span>
<span style="color: #859900;">print</span><span style="color: #757575;">(</span>mod<span style="color: #757575;">)</span>

<span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=1<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">mod</span> = relay.build<span style="color: #757575;">(</span>mod<span style="color: #757575;">,</span> target=<span style="color: #2aa198;">"llvm --system-lib --runtime=c++"</span><span style="color: #757575;">,</span> params=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">)</span>

mod.lib.save<span style="color: #757575;">(</span><span style="color: #2aa198;">"/tmp/a.o"</span><span style="color: #757575;">)</span>
</pre>
</div>

<p>
def @main(%x: Tensor[(1, 1000), float32]) {
  add(%x, %x)
}
</p>

<div class="org-src-container">
<pre class="src src-shell">readelf -s /tmp/a.o
<span style="color: #839496;">echo</span> <span style="color: #2aa198;">"------"</span>
readelf -a /tmp/a.o|grep <span style="color: #2aa198;">"Relocation section '.rela.ctors'"</span> -A 3
</pre>
</div>

<p>

</p>

<p>
Symbol table '.symtab' contains 14 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000330    40 FUNC    LOCAL  DEFAULT    2 <span class="underline">_tvm_module_startup
     3: 0000000000000210   284 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_add</span>
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    9
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   10
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT   19
    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
    12: 0000000000000000     8 OBJECT  WEAK   DEFAULT    4 __tvm_module_ctx
    13: 0000000000000000   523 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_add
</p>
<hr />
<p>
Relocation section '.rela.ctors' at offset 0x1228 contains 1 entry:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000000  000400000001 R_X86_64_64       0000000000000000 .text + 330
</p>

<p>
相比没有加 system-lib 的情形, a.o 多了几个 symbol:
</p>

<ol class="org-ol">
<li><p>
__tvm_module_startup
</p>

<p>
利用 elf 的 ctor 在应用启动时调用 __tvm_module_startup
</p></li>

<li><p>
TVMBackendRegisterSystemLibSymbol
</p>

<p>
__tvm_module_startup 的代码会通过
TVMBackendRegisterSystemLibSymbol("tvmgen_default_fused_add",tvmgen_default_fused_add)
的方式把 tvmgen_default_fused_add 函数注册到一个 runtime 负责的全局的 `SystemLibrary` 上
</p></li>
</ol>
</div>

<div id="outline-container-org9897434" class="outline-5">
<h5 id="org9897434"><span class="section-number-5">1.1.2.1</span> __tvm_module_startup</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b58900;">void</span> <span style="color: #268bd2; font-weight: bold;">CodeGenCPU</span>::<span style="color: #268bd2;">AddStartupFunction</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>target_c_runtime_<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#26500;&#36896; __tvm_module_startup &#20989;&#25968;</span>
    function_ = <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::Create<span style="color: #757575;">(</span>ftype<span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::InternalLinkage<span style="color: #757575;">,</span>
                                       <span style="color: #2aa198;">"__tvm_module_startup"</span><span style="color: #757575;">,</span> module_.get<span style="color: #757575;">())</span>;
    <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #b58900;">BasicBlock</span>* <span style="color: #268bd2;">startup_entry</span> = <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">BasicBlock</span>::Create<span style="color: #757575;">(</span>*ctx_<span style="color: #757575;">,</span> <span style="color: #2aa198;">"entry"</span><span style="color: #757575;">,</span> function_<span style="color: #757575;">)</span>;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">__tvm_module_startup &#35843;&#29992; f_tvm_register_system_symbol_</span>
    <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #859900;">auto</span>&amp; <span style="color: #268bd2;">kv</span> : export_system_symbols_<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      builder_-&gt;CreateCall<span style="color: #757575;">(</span>f_tvm_register_system_symbol_<span style="color: #757575;">,</span>
                           <span style="color: #757575;">{</span>name<span style="color: #757575;">,</span> builder_-&gt;CreateBitCast<span style="color: #757575;">(</span>kv.second<span style="color: #757575;">,</span> t_void_p_<span style="color: #757575;">)})</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">&#25226; __tvm_module_startup &#21152;&#21040; elf &#30340; .ctor &#20013;</span>
    <span style="color: #268bd2; font-weight: bold;">llvm</span>::appendToGlobalCtors<span style="color: #757575;">(</span>*module_<span style="color: #757575;">,</span> function_<span style="color: #757575;">,</span> 65535<span style="color: #757575;">)</span>;
  <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>

f_tvm_register_system_symbol_ = <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::Create<span style="color: #757575;">(</span>
    <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">FunctionType</span>::get<span style="color: #757575;">(</span>t_int_<span style="color: #757575;">,</span> <span style="color: #757575;">{</span>t_char_-&gt;getPointerTo<span style="color: #757575;">(),</span> t_void_p_<span style="color: #757575;">},</span> <span style="color: #268bd2; font-weight: bold;">false</span><span style="color: #757575;">),</span>
    <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::ExternalLinkage<span style="color: #757575;">,</span> <span style="color: #2aa198;">"TVMBackendRegisterSystemLibSymbol"</span><span style="color: #757575;">,</span> module_.get<span style="color: #757575;">())</span>;
</pre>
</div>

<p>
对应生成的代码为:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #268bd2;">.text</span>:0000000000000340 __tvm_module_startup proc near          <span style="color: #586e75;">; </span><span style="color: #586e75;">DATA XREF: .ctors:0000000000000D50</span>
<span style="color: #268bd2;">.text</span>:0000000000000340                 push    rax
<span style="color: #268bd2;">.text</span>:0000000000000341                 lea     rdi<span style="color: #757575;">,</span> a__tvm_module_c <span style="color: #586e75;">; </span><span style="color: #586e75;">"__tvm_module_ctx"</span>
<span style="color: #268bd2;">.text</span>:0000000000000348                 mov     rsi<span style="color: #757575;">,</span> cs:__tvm_module_ctx_ptr
<span style="color: #268bd2;">.text</span>:000000000000034F                 call    TVMBackendRegisterSystemLibSymbol <span style="color: #586e75;">; </span><span style="color: #586e75;">PIC mode</span>
<span style="color: #268bd2;">.text</span>:0000000000000354                 lea     rdi<span style="color: #757575;">,</span> aTvmgen_default <span style="color: #586e75;">; </span><span style="color: #586e75;">"tvmgen_default_fused_add"</span>
<span style="color: #268bd2;">.text</span>:000000000000035B                 mov     rsi<span style="color: #757575;">,</span> cs:tvmgen_default_fused_add_ptr
<span style="color: #268bd2;">.text</span>:0000000000000362                 pop     rax
<span style="color: #268bd2;">.text</span>:0000000000000363
<span style="color: #268bd2;">.text</span>:0000000000000363 loc_363:                                <span style="color: #586e75;">; </span><span style="color: #586e75;">DATA XREF: .eh_frame:0000000000000D78</span>
<span style="color: #268bd2;">.text</span>:0000000000000363                 jmp     TVMBackendRegisterSystemLibSymbol <span style="color: #586e75;">; </span><span style="color: #586e75;">PIC mode</span>
<span style="color: #268bd2;">.text</span>:0000000000000363 __tvm_module_startup endp
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1393db" class="outline-5">
<h5 id="orgd1393db"><span class="section-number-5">1.1.2.2</span> TVMBackendRegisterSystemLibSymbol</h5>
<div class="outline-text-5" id="text-1-1-2-2">
<p>
TVMBackendRegisterSystemLibSymbol 是 tvm runtime 提供的函数
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b58900;">int</span> <span style="color: #268bd2;">TVMBackendRegisterSystemLibSymbol</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">void</span>* <span style="color: #268bd2;">ptr</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
  <span style="color: #268bd2; font-weight: bold;">tvm</span>::<span style="color: #268bd2; font-weight: bold;">runtime</span>::<span style="color: #268bd2; font-weight: bold;">SystemLibrary</span>::Global<span style="color: #757575;">()</span>-&gt;RegisterSymbol<span style="color: #757575;">(</span>name<span style="color: #757575;">,</span> ptr<span style="color: #757575;">)</span>;
  <span style="color: #859900;">return</span> 0;
<span style="color: #757575;">}</span>

<span style="color: #586e75;">// </span><span style="color: #586e75;">system_library.cc</span>
<span style="color: #b58900;">void</span> <span style="color: #268bd2;">RegisterSymbol</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #b58900;">string</span>&amp; <span style="color: #268bd2;">name</span><span style="color: #757575;">,</span> <span style="color: #b58900;">void</span>* <span style="color: #268bd2;">ptr</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #b58900;">lock_guard</span>&lt;<span style="color: #268bd2; font-weight: bold;">std</span>::mutex&gt; <span style="color: #268bd2;">lock</span><span style="color: #757575;">(</span>mutex_<span style="color: #757575;">)</span>;
    <span style="color: #859900;">auto</span> <span style="color: #268bd2;">it</span> = tbl_.find<span style="color: #757575;">(</span>name<span style="color: #757575;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>it != tbl_.end<span style="color: #757575;">()</span> &amp;&amp; ptr != it-&gt;second<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      LOG<span style="color: #757575;">(</span>WARNING<span style="color: #757575;">)</span> &lt;&lt; <span style="color: #2aa198;">"SystemLib symbol "</span> &lt;&lt; name &lt;&lt; <span style="color: #2aa198;">" get overriden to a different address "</span> &lt;&lt; ptr
                   &lt;&lt; <span style="color: #2aa198;">"-&gt;"</span> &lt;&lt; it-&gt;second;
    <span style="color: #757575;">}</span>
    tbl_[name] = ptr;
  <span style="color: #757575;">}</span>

</pre>
</div>

<p>
SystemLibrary 并是不是一个真正的 `library`: 它的 RegisterSymbol 只是保存了一个
symbol -&gt; function 的 mapping, 但它与 DSOLibrary 一样提供了 GetSymbol 接口:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b58900;">void</span>* <span style="color: #268bd2;">GetSymbol</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>* <span style="color: #268bd2;">name</span><span style="color: #757575;">)</span> <span style="color: #859900;">final</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #b58900;">lock_guard</span>&lt;<span style="color: #268bd2; font-weight: bold;">std</span>::mutex&gt; <span style="color: #268bd2;">lock</span><span style="color: #757575;">(</span>mutex_<span style="color: #757575;">)</span>;
    <span style="color: #859900;">auto</span> <span style="color: #268bd2;">it</span> = tbl_.find<span style="color: #757575;">(</span>name<span style="color: #757575;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>it != tbl_.end<span style="color: #757575;">())</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">return</span> it-&gt;second;
    <span style="color: #757575;">}</span> <span style="color: #859900;">else</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">nullptr</span>;
    <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
有了这个全局的 SystemLibrary 做为 registry, 便不再需要依赖 dso 的 dlsym 了
</p>
</div>
</div>
</div>

<div id="outline-container-org22af66e" class="outline-4">
<h4 id="org22af66e"><span class="section-number-4">1.1.3</span> C Runtime</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
当 TVM 需要跑在开发板上时，会有几个问题：
</p>

<ol class="org-ol">
<li>板子可能没有支持 ctor 的环境</li>
<li>板子上关于内存分配，log 等功能需要有特定的实现</li>
</ol>

<p>
为此，TVM 以提出一个 c runtime.
</p>

<p>
c runtime 的目标场景是那些无法支持 ctor (即 .init/.init_array) 的环境, 例如不支持 rtld 或没有 startfiles 的情况 <a href="toolchain/elf.html#orgf3c19d9">init_array 如何被调用</a>
</p>

<p>
c runtime 无法利用 ctor 来注册 mapping, 所以它实现了一个函数
`TVMSystemLibEntryPoint`, 这个函数会返回一个包含 {names, functions} 的结构体,用来初始化 SystemLib
</p>

<p>
C Runtime 会利用 tvm::codegen::CreateMetadataModule 完成与 c++ 的 __tvm_module_startup 类似的功能.
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #859900;">import</span> tvm
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> relay

<span style="color: #268bd2;">x</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1000<span style="color: #757575;">),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
<span style="color: #268bd2;">y</span> = relay.add<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>
<span style="color: #268bd2;">func</span> = relay.Function<span style="color: #757575;">(</span>[x]<span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>
<span style="color: #268bd2;">mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>func<span style="color: #757575;">)</span>

<span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=1<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">mod</span> = relay.build<span style="color: #757575;">(</span>mod<span style="color: #757575;">,</span> target=<span style="color: #2aa198;">"llvm  --system-lib --runtime=c"</span><span style="color: #757575;">,</span> params=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">)</span>

mod.lib.export_library<span style="color: #757575;">(</span><span style="color: #2aa198;">"/tmp/a.tar"</span><span style="color: #757575;">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">tar zxvf /tmp/a.tar
<span style="color: #839496;">echo</span> <span style="color: #2aa198;">"------lib0.o"</span>
readelf -s /tmp/lib0.o
<span style="color: #839496;">echo</span> <span style="color: #2aa198;">"------lib1.o"</span>
readelf -s /tmp/lib1.o
</pre>
</div>

<p>
lib0.o
devc.o
lib1.o
-&#x2013;&#x2014;lib0.o
</p>

<p>
Symbol table '.symtab' contains 15 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMetadataMod
     2: 0000000000000008    16 OBJECT  LOCAL  DEFAULT    4 _tvm_crt_func_registry
     3: 0000000000000018     8 OBJECT  LOCAL  DEFAULT    4 _tvm_crt_module
     4: 0000000000000000     8 OBJECT  LOCAL  DEFAULT    4 _tvm_func_registry_ptrs
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
    10: 0000000000000000     0 SECTION LOCAL  DEFAULT    9
    11: 0000000000000000     0 SECTION LOCAL  DEFAULT   16
    12: 0000000000000000     0 SECTION LOCAL  DEFAULT   18
    13: 0000000000000000     8 FUNC    GLOBAL DEFAULT    2 TVMSystemLibEntryPoint
    14: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND tvmgen_default_fused_add
-&#x2013;&#x2014;lib1.o
</p>

<p>
Symbol table '.symtab' contains 11 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000210   284 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_add_
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   16
     9: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    10: 0000000000000000   523 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_add
</p>

<ul class="org-ul">
<li>lib1.o 有 tvmgen_default_fused_add 的实现</li>
<li>lib0.o 中的 TVMSystemLibEntryPoint 是用来返回 {"names",funcs} 的数据的</li>
</ul>


<div id="orgd40a449" class="figure">
<p><img src="../extra/tvm_c_runtime_reg.png" alt="tvm_c_runtime_reg.png" />
</p>
</div>

<p>
图中的 unk_28 实际上就是指向 .rodata 上的字符串 "tvmgen_default_fused_add", 所以
lib0.o 中的 TVMSystemLibEntryPoint 最终会返回
</p>

<p>
{"tvmgen_default_fused_add", tvmgen_default_fused_add}
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #586e75;">// </span><span style="color: #586e75;">crt_runtime_api.c</span>
<span style="color: #b58900;">int</span> <span style="color: #268bd2;">SystemLibraryCreate</span><span style="color: #757575;">(</span><span style="color: #b58900;">TVMValue</span>* <span style="color: #268bd2;">args</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span>* <span style="color: #268bd2;">type_codes</span><span style="color: #757575;">,</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">num_args</span><span style="color: #757575;">,</span> <span style="color: #b58900;">TVMValue</span>* <span style="color: #268bd2;">ret_val</span><span style="color: #757575;">,</span>
                        <span style="color: #b58900;">int</span>* <span style="color: #268bd2;">ret_type_codes</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>

  <span style="color: #859900;">const</span> <span style="color: #b58900;">TVMModule</span>* <span style="color: #268bd2;">system_lib</span>;
  system_lib = TVMSystemLibEntryPoint<span style="color: #757575;">()</span>;
  TVMModCreateFromCModule<span style="color: #757575;">(</span>system_lib<span style="color: #757575;">,</span> &amp;system_lib_handle<span style="color: #757575;">)</span>;

  ret_val[0].v_handle = system_lib_handle;
  ret_type_codes[0] = kTVMModuleHandle;
  <span style="color: #859900;">return</span> 0;
<span style="color: #757575;">}</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8abfa9c" class="outline-3">
<h3 id="org8abfa9c"><span class="section-number-3">1.2</span> Static Deploy</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orgcd41106" class="outline-4">
<h4 id="orgcd41106"><span class="section-number-4">1.2.1</span> C++ Runtime</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
<a href="file:///home/sunway/Gitbox/code/hello_world/hello_tvm/cpp_runtime">file:~/Gitbox/code/hello_world/hello_tvm/cpp_runtime</a>
</p>
</div>
</div>

<div id="outline-container-orgf448bdd" class="outline-4">
<h4 id="orgf448bdd"><span class="section-number-4">1.2.2</span> C Runtime</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
<a href="file:///home/sunway/Gitbox/code/hello_world/hello_tvm/c_runtime">file:~/Gitbox/code/hello_world/hello_tvm/c_runtime</a>
</p>
</div>
</div>

<div id="outline-container-orgb40ad48" class="outline-4">
<h4 id="orgb40ad48"><span class="section-number-4">1.2.3</span> 交叉编译</h4>
<div class="outline-text-4" id="text-1-2-3">
<ol class="org-ol">
<li><p>
在 target 中使用 mtriple, mcpu 指定, 由 llvm 负责交叉编译.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">mod</span> = relay.build<span style="color: #757575;">(</span>
    mod<span style="color: #757575;">,</span>
    target=<span style="color: #2aa198;">"llvm  --system-lib --runtime=c, -mtriple=armv8l-linux-gnueabihf -mcpu=cortex-m7"</span><span style="color: #757575;">,</span>
    params=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span>
<span style="color: #757575;">)</span>
</pre>
</div></li>

<li><p>
使用 c target, 生成 c 代码后自己做交叉编译
</p>

<p>
但看起来 c target 没有生成向量化的代码
</p></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2e4f11e" class="outline-3">
<h3 id="org2e4f11e"><span class="section-number-3">1.3</span> Micro TVM</h3>
<div class="outline-text-3" id="text-1-3">
<p>
使用 c_runtime + system_lib, 已经可以编译出一个静态链接的可以在 mcu 上运行的实例了, 实际上 tvm.target.target.micro("stm32f746xx") 返回的 target 字符串基本上为:
"c -system-lib -runtime=c -mcpu=cortex-m7"
</p>

<p>
更多 Micro TVM 相关的内容和 RPC 有关, 即 host 的 python 代码可以像本地模型一样用
graph_runner 运行 mcu 上的实例.
<a href="https://tvm.apache.org/docs/tutorials/micro/micro_tflite.html?highlight=microtvm">https://tvm.apache.org/docs/tutorials/micro/micro_tflite.html?highlight=microtvm</a>
</p>

<p>
<del>具体的</del>
</p>

<ol class="org-ol">
<li><del>用户需要自己提供一个 tvm.micro.Compiler 的实现, 用来把 tvm 编译生成的 c 代码</del>
<del>编译成最终在 mcu 上执行的 bin. 因为 Micro TVM 期望用户自己实现 Compiler 来生</del>
<del>成最终的 bin, 所以 tvm.target.target.micro 使用的 target 是 "c", 而不是</del>
<del>"llvm"</del></li>

<li><del>用户需要自己提供一个 tvm.micro.Flasher, 同时需要自己提供一个</del>
<del>tvm.micro.Transport. 在 host 上用 Flasher 把 bin flash 到 mcu 上, 用</del>
<del>Transport控制 mcu 的执行并拿到结果. host 端的 Transport 需要与 mcu 上的</del>
<del>MicroRPCServer进行通信, 并在通信的基础上封装成一个 RPC 服务, 以便 host 以通过</del>
<del>RPC 直接在mcu 上执行代码.</del></li>
</ol>

<p>
新的 TVM 代码把 Compiler, Flasher, Transport 功能重写了 Project API, 功能与之前的类似
<a href="file:///home/sunway/source/tvm/python/tvm/micro/project.py">file:~/source/tvm/python/tvm/micro/project.py</a>
</p>

<p>
<a href="https://tvm.apache.org/docs/dev/microtvm_design.html?highlight=microtvm%20design">https://tvm.apache.org/docs/dev/microtvm_design.html?highlight=microtvm%20design</a>
</p>
</div>

<div id="outline-container-org24c2033" class="outline-4">
<h4 id="org24c2033"><span class="section-number-4">1.3.1</span> Project API</h4>
<div class="outline-text-4" id="text-1-3-1">
</div>
<div id="outline-container-orga950600" class="outline-5">
<h5 id="orga950600"><span class="section-number-5">1.3.1.1</span> Overview</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<p>
Project API 要求每个板子提供一个 template_project_dir, 例如:
</p>

<p>
tvm/build/standalone_crt/template/host
tvm/apps/microtvm/zephyr/template_project
</p>

<p>
每个 template dir 都需要有一个 microtvm_api_server.py, 这个模块以 popen+pipe 的形式对外提供 build, flash, transport 等功能. 另外, build 时编译出来的 bin 需要在代码中调用 MicroTVMRpcServerLoop 以启动 microtvm RPC server
</p>

<p>
有了这个抽象的 project, TVM 可以:
</p>

<ol class="org-ol">
<li>用 host-driven 的方式在板子上执行 MicroTVM model</li>
<li>使 MicroTVM 支持 AutoTVM</li>
</ol>
</div>
</div>

<div id="outline-container-orgf5b3c4e" class="outline-5">
<h5 id="orgf5b3c4e"><span class="section-number-5">1.3.1.2</span> Example</h5>
<div class="outline-text-5" id="text-1-3-1-2">
<p>
<a href="file:///home/sunway/source/tvm/gallery/how_to/work_with_microtvm/micro_autotune.py">file:~/source/tvm/gallery/how_to/work_with_microtvm/micro_autotune.py</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">import</span> tvm
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> relay

<span style="color: #859900;">import</span> tempfile


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_model</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">x</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> relay.TensorType<span style="color: #757575;">(</span>[1<span style="color: #757575;">,</span> 10]<span style="color: #757575;">,</span> <span style="color: #2aa198;">"float32"</span><span style="color: #757575;">))</span>
    <span style="color: #268bd2;">y</span> = relay.add<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">f</span> = relay.Function<span style="color: #757575;">(</span>[x]<span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">relay_mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>f<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">relay_mod</span> = relay.transform.InferType<span style="color: #757575;">()(</span>relay_mod<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> relay_mod


<span style="color: #859900;">def</span> <span style="color: #268bd2;">run_model</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">relay_mod</span> = get_model<span style="color: #757575;">()</span>
    <span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=3<span style="color: #757575;">,</span> config=<span style="color: #757575;">{</span><span style="color: #2aa198;">"tir.disable_vectorize"</span>: <span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">})</span>:
        <span style="color: #268bd2;">model</span> = relay.build<span style="color: #757575;">(</span>
            relay_mod<span style="color: #757575;">,</span> target=tvm.target.target.micro<span style="color: #757575;">(</span><span style="color: #2aa198;">"host"</span><span style="color: #757575;">),</span> params=<span style="color: #268bd2; font-weight: bold;">None</span>
        <span style="color: #757575;">)</span>

    <span style="color: #268bd2;">project</span> = tvm.micro.generate_project<span style="color: #757575;">(</span>
        <span style="color: #2aa198;">"/home/sunway/source/tvm/build/standalone_crt/template/host"</span><span style="color: #757575;">,</span>
        model<span style="color: #757575;">,</span>
        tempfile.TemporaryDirectory<span style="color: #757575;">()</span>.name<span style="color: #757575;">,</span>
    <span style="color: #757575;">)</span>

    project.build<span style="color: #757575;">()</span>
    project.flash<span style="color: #757575;">()</span>

    <span style="color: #859900;">with</span> tvm.micro.Session<span style="color: #757575;">(</span>project.transport<span style="color: #757575;">())</span> <span style="color: #859900;">as</span> session:
        <span style="color: #268bd2;">debug_module</span> = tvm.micro.create_local_debug_executor<span style="color: #757575;">(</span>
            model.get_graph_json<span style="color: #757575;">(),</span> session.get_system_lib<span style="color: #757575;">(),</span> session.device
        <span style="color: #757575;">)</span>
        debug_module.set_input<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> np.ones<span style="color: #757575;">((</span>1<span style="color: #757575;">,</span> 10<span style="color: #757575;">)))</span>
        debug_module.run<span style="color: #757575;">()</span>
        <span style="color: #859900;">print</span><span style="color: #757575;">(</span>debug_module.get_output<span style="color: #757575;">(</span>0<span style="color: #757575;">))</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Project API &#21487;&#20197;&#29992;&#26469;&#22312; pc &#19978;&#36828;&#31243;&#22312;&#26495;&#23376;&#19978;&#25191;&#34892; model</span>
    run_model<span style="color: #757575;">()</span>
</pre>
</div>

<p>
Node Name                 Ops                       Time(us)  Time(%)  Shape    Inputs  Outputs  
----&#x2013;&#x2014;                 &#x2014;                       ---&#x2013;&#x2014;  --&#x2013;&#x2014;  &#x2013;&#x2014;    -&#x2013;&#x2014;  --&#x2013;&#x2014;  
tvmgen_default_fused_add  tvmgen_default_fused_add  0.0       100.0    (1, 10)  1       1        
Total_time                -                         0.0       -        -        -       -        

</p>
</div>
</div>

<div id="outline-container-org6dc652d" class="outline-5">
<h5 id="org6dc652d"><span class="section-number-5">1.3.1.3</span> Impl</h5>
<div class="outline-text-5" id="text-1-3-1-3">
<p>
Project API 对外提供的主要接口是 generate_project, host-driven 时会直接调用该接口, AutoTVM 使用的 AutoTvmModuleLoader 也需要调用该接口
</p>

<ol class="org-ol">
<li><p>
使用 popen 方式启动 template_project_dir 中的 microtvm_api_server.py 做为 client
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">generate_project</span><span style="color: #757575;">(</span>
    template_project_dir: Union[pathlib.Path<span style="color: #757575;">,</span> <span style="color: #839496;">str</span>]<span style="color: #757575;">,</span>
    module: ExportableModule<span style="color: #757575;">,</span>
    generated_project_dir: Union[pathlib.Path<span style="color: #757575;">,</span> <span style="color: #839496;">str</span>]<span style="color: #757575;">,</span>
    options: <span style="color: #839496;">dict</span> = <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span>
<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">template</span> = TemplateProject.from_directory<span style="color: #757575;">(</span><span style="color: #839496;">str</span><span style="color: #757575;">(</span>template_project_dir<span style="color: #757575;">))</span>
    <span style="color: #859900;">return</span> template.generate_project<span style="color: #757575;">(</span>module<span style="color: #757575;">,</span> <span style="color: #839496;">str</span><span style="color: #757575;">(</span>generated_project_dir<span style="color: #757575;">),</span> options<span style="color: #757575;">)</span>


<span style="color: #859900;">class</span> <span style="color: #b58900;">TemplateProject</span>:
    @<span style="color: #839496;">classmethod</span>
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">from_directory</span><span style="color: #757575;">(</span>cls<span style="color: #757575;">,</span> template_project_dir<span style="color: #757575;">)</span>:
        <span style="color: #859900;">return</span> cls<span style="color: #757575;">(</span>client.instantiate_from_dir<span style="color: #757575;">(</span>template_project_dir<span style="color: #757575;">))</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">&#22312; template_project_dir &#26159;&#26597;&#25214; microtvm_api_server.py &#25110;</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">launch_microtvm_api_server.sh&#29992; popen &#21551;&#21160;&#19968;&#20010;&#23376;&#36827;&#31243;&#25191;&#34892;&#36825;&#20010; script, &#36825;&#20010;</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">script &#20250;&#22312;&#19968;&#20010; while loop &#20013;&#31561;&#24453;&#21518;&#32493;&#21629;&#20196;, &#27604;&#22914; generate_project</span>

<span style="color: #859900;">def</span> <span style="color: #268bd2;">instantiate_from_dir</span><span style="color: #757575;">(</span>project_dir: typing.Union[pathlib.Path<span style="color: #757575;">,</span> <span style="color: #839496;">str</span>]<span style="color: #757575;">,</span> debug: <span style="color: #839496;">bool</span> = <span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">args</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
    <span style="color: #268bd2;">project_dir</span> = pathlib.Path<span style="color: #757575;">(</span>project_dir<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">python_script</span> = project_dir / SERVER_PYTHON_FILENAME
    <span style="color: #859900;">if</span> python_script.is_file<span style="color: #757575;">()</span>:
        <span style="color: #268bd2;">args</span> = [sys.executable<span style="color: #757575;">,</span> <span style="color: #839496;">str</span><span style="color: #757575;">(</span>python_script<span style="color: #757575;">)</span>]

    <span style="color: #268bd2;">launch_script</span> = project_dir / SERVER_LAUNCH_SCRIPT_FILENAME
    <span style="color: #859900;">if</span> launch_script.is_file<span style="color: #757575;">()</span>:
        <span style="color: #268bd2;">args</span> = [<span style="color: #839496;">str</span><span style="color: #757575;">(</span>launch_script<span style="color: #757575;">)</span>]

    <span style="color: #268bd2;">api_server_read_fd</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">tvm_write_fd</span> = os.pipe<span style="color: #757575;">()</span>
    <span style="color: #268bd2;">tvm_read_fd</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">api_server_write_fd</span> = os.pipe<span style="color: #757575;">()</span>

    args.extend<span style="color: #757575;">(</span>[<span style="color: #2aa198;">"--read-fd"</span><span style="color: #757575;">,</span> <span style="color: #839496;">str</span><span style="color: #757575;">(</span>api_server_read_fd<span style="color: #757575;">),</span> <span style="color: #2aa198;">"--write-fd"</span><span style="color: #757575;">,</span> <span style="color: #839496;">str</span><span style="color: #757575;">(</span>api_server_write_fd<span style="color: #757575;">)</span>]<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">api_server_proc</span> = subprocess.Popen<span style="color: #757575;">(</span>  <span style="color: #586e75;"># </span><span style="color: #586e75;">pylint: disable=unused-variable</span>
        args<span style="color: #757575;">,</span> bufsize=0<span style="color: #757575;">,</span> pass_fds=<span style="color: #757575;">(</span>api_server_read_fd<span style="color: #757575;">,</span> api_server_write_fd<span style="color: #757575;">),</span> cwd=project_dir
    <span style="color: #757575;">)</span>
    os.close<span style="color: #757575;">(</span>api_server_read_fd<span style="color: #757575;">)</span>
    os.close<span style="color: #757575;">(</span>api_server_write_fd<span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> ProjectAPIClient<span style="color: #757575;">(</span>
        os.fdopen<span style="color: #757575;">(</span>tvm_read_fd<span style="color: #757575;">,</span> <span style="color: #2aa198;">"rb"</span><span style="color: #757575;">,</span> buffering=0<span style="color: #757575;">),</span> os.fdopen<span style="color: #757575;">(</span>tvm_write_fd<span style="color: #757575;">,</span> <span style="color: #2aa198;">"wb"</span><span style="color: #757575;">,</span> buffering=0<span style="color: #757575;">)</span>
    <span style="color: #757575;">)</span>

</pre>
</div></li>

<li><p>
通过调用 client 的 generate_project 生成新的 GeneratedProject 目录
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #586e75;"># </span><span style="color: #586e75;">&#20808; export_model_library, &#28982;&#21518;&#35843;&#29992; client &#30340; generate_project</span>
<span style="color: #859900;">def</span> <span style="color: #268bd2;">generate_project</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> graph_executor_factory<span style="color: #757575;">,</span> project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">model_library_dir</span> = utils.tempdir<span style="color: #757575;">()</span>
    <span style="color: #268bd2;">model_library_format_path</span> = model_library_dir.relpath<span style="color: #757575;">(</span><span style="color: #2aa198;">"model.tar"</span><span style="color: #757575;">)</span>
    export_model_library_format<span style="color: #757575;">(</span>graph_executor_factory<span style="color: #757575;">,</span> model_library_format_path<span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> <span style="color: #859900;">self</span>.generate_project_from_mlf<span style="color: #757575;">(</span>model_library_format_path<span style="color: #757575;">,</span> project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>


<span style="color: #859900;">def</span> <span style="color: #268bd2;">generate_project_from_mlf</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> model_library_format_path<span style="color: #757575;">,</span> project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>:
    <span style="color: #859900;">self</span>._api_client.generate_project<span style="color: #757575;">(</span>
        model_library_format_path=<span style="color: #839496;">str</span><span style="color: #757575;">(</span>model_library_format_path<span style="color: #757575;">),</span>
        standalone_crt_dir=get_standalone_crt_dir<span style="color: #757575;">(),</span>
        project_dir=project_dir<span style="color: #757575;">,</span>
        options=options<span style="color: #757575;">,</span>
    <span style="color: #757575;">)</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">...</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">_api_client &#30340; generate_project (&#20197; host &#30340; microtvm_api_server.py &#20026;&#20363;), &#23454;&#38469;</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">&#23601;&#26159;&#22797;&#21046;&#20102;&#19968;&#22534;&#25991;&#20214;&#21040; GeneratedProject &#30446;&#24405;</span>
<span style="color: #859900;">def</span> <span style="color: #268bd2;">generate_project</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> model_library_format_path<span style="color: #757575;">,</span> standalone_crt_dir<span style="color: #757575;">,</span> project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>:
    shutil.copy2<span style="color: #757575;">(</span>__file__<span style="color: #757575;">,</span> project_dir / os.path.basename<span style="color: #757575;">(</span>__file__<span style="color: #757575;">))</span>

    <span style="color: #268bd2;">project_model_library_format_path</span> = project_dir / MODEL_LIBRARY_FORMAT_RELPATH
    shutil.copy2<span style="color: #757575;">(</span>model_library_format_path<span style="color: #757575;">,</span> project_model_library_format_path<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">extract_path</span> = project_dir / project_model_library_format_path.stem
    <span style="color: #859900;">with</span> tarfile.TarFile<span style="color: #757575;">(</span>project_model_library_format_path<span style="color: #757575;">)</span> <span style="color: #859900;">as</span> tf:
        os.makedirs<span style="color: #757575;">(</span>extract_path<span style="color: #757575;">)</span>
        tf.extractall<span style="color: #757575;">(</span>path=extract_path<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">crt_path</span> = project_dir / <span style="color: #2aa198;">"crt"</span>
    os.mkdir<span style="color: #757575;">(</span>crt_path<span style="color: #757575;">)</span>
    <span style="color: #859900;">for</span> item <span style="color: #859900;">in</span> <span style="color: #859900;">self</span>.CRT_COPY_ITEMS:
        <span style="color: #586e75;"># </span><span style="color: #586e75;">...</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Populate Makefile.</span>
    shutil.copy2<span style="color: #757575;">(</span>pathlib.Path<span style="color: #757575;">(</span>__file__<span style="color: #757575;">)</span>.parent / <span style="color: #2aa198;">"Makefile"</span><span style="color: #757575;">,</span> project_dir / <span style="color: #2aa198;">"Makefile"</span><span style="color: #757575;">)</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Populate crt-config.h</span>
    <span style="color: #268bd2;">crt_config_dir</span> = project_dir / <span style="color: #2aa198;">"crt_config"</span>
    crt_config_dir.mkdir<span style="color: #757575;">()</span>
    shutil.copy2<span style="color: #757575;">(</span>
        os.path.join<span style="color: #757575;">(</span>os.path.dirname<span style="color: #757575;">(</span>__file__<span style="color: #757575;">),</span> <span style="color: #2aa198;">".."</span><span style="color: #757575;">,</span> <span style="color: #2aa198;">"crt_config-template.h"</span><span style="color: #757575;">),</span>
        os.path.join<span style="color: #757575;">(</span>crt_config_dir<span style="color: #757575;">,</span> <span style="color: #2aa198;">"crt_config.h"</span><span style="color: #757575;">),</span>
    <span style="color: #757575;">)</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">Populate src/</span>
    <span style="color: #268bd2;">src_dir</span> = os.path.join<span style="color: #757575;">(</span>project_dir<span style="color: #757575;">,</span> <span style="color: #2aa198;">"src"</span><span style="color: #757575;">)</span>
    os.mkdir<span style="color: #757575;">(</span>src_dir<span style="color: #757575;">)</span>
    shutil.copy2<span style="color: #757575;">(</span>
        os.path.join<span style="color: #757575;">(</span>os.path.dirname<span style="color: #757575;">(</span>__file__<span style="color: #757575;">),</span> <span style="color: #2aa198;">"main.cc"</span><span style="color: #757575;">),</span> os.path.join<span style="color: #757575;">(</span>src_dir<span style="color: #757575;">,</span> <span style="color: #2aa198;">"main.cc"</span><span style="color: #757575;">)</span>
    <span style="color: #757575;">)</span>

</pre>
</div></li>

<li><p>
generate_project 完成后使用 GeneratedProject 目录中的 microtvm_api_server.py 做为新的 client
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">generate_project_from_mlf</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> model_library_format_path<span style="color: #757575;">,</span> project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>:
    <span style="color: #859900;">self</span>._api_client.generate_project<span style="color: #757575;">(</span>
        <span style="color: #586e75;"># </span><span style="color: #586e75;">...</span>
    <span style="color: #757575;">)</span>

    <span style="color: #859900;">return</span> GeneratedProject.from_directory<span style="color: #757575;">(</span>project_dir<span style="color: #757575;">,</span> options<span style="color: #757575;">)</span>
</pre>
</div></li>

<li>可以通过最后获得的 project 完成 build, flash, transport 等功能</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2b03663" class="outline-4">
<h4 id="org2b03663"><span class="section-number-4">1.3.2</span> RPC</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
RPC 的结构为:
</p>

<pre class="example" id="org1de5b93">
                                         |
Session (Flasher/Transport) [python]     |
   -&gt; RPCSession [c++]                   |
     -&gt; MicroTransportChannel [c++]      -&gt;   MicroTVMRpcServerLoop
                                         |        -&gt; Session
                                         |           -&gt; MinRPCServer
                                         |               -&gt; HandleNormalCallFunc, ...
                                         |
</pre>
</div>

<div id="outline-container-orgd595d24" class="outline-5">
<h5 id="orgd595d24"><span class="section-number-5">1.3.2.1</span> RPC Impl</h5>
<div class="outline-text-5" id="text-1-3-2-1">
</div>
<ol class="org-ol">
<li><a id="org3524cdc"></a>Client<br />
<ol class="org-ol">
<li><a id="org5c1e7d8"></a>初始化 session<br />
<div class="outline-text-7" id="text-1-3-2-1-1-1">
<div class="org-src-container">
<pre class="src src-python">tvm.micro.Session<span style="color: #757575;">(</span>binary=micro_binary<span style="color: #757575;">,</span> flasher=flasher<span style="color: #757575;">)</span>
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">Session</span>.__enter__<span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">)</span>:
        <span style="color: #859900;">self</span>.transport_context_manager = <span style="color: #859900;">self</span>.flasher.flash<span style="color: #757575;">(</span><span style="color: #859900;">self</span>.binary<span style="color: #757575;">)</span>

        <span style="color: #859900;">self</span>.transport = TransportLogger<span style="color: #757575;">(</span>
            <span style="color: #859900;">self</span>.session_name<span style="color: #757575;">,</span> <span style="color: #859900;">self</span>.transport_context_manager<span style="color: #757575;">,</span> level=logging.DEBUG
        <span style="color: #757575;">)</span>.__enter__<span style="color: #757575;">()</span>

        <span style="color: #859900;">self</span>._rpc = RPCSession<span style="color: #757575;">(</span>
            _rpc_connect<span style="color: #757575;">(</span>
                <span style="color: #859900;">self</span>.session_name<span style="color: #757575;">,</span>
                <span style="color: #859900;">self</span>._wrap_transport_write<span style="color: #757575;">,</span>
                <span style="color: #859900;">self</span>._wrap_transport_read<span style="color: #757575;">,</span>
                <span style="color: #839496;">int</span><span style="color: #757575;">(</span>timeouts.session_start_retry_timeout_sec * 1e6<span style="color: #757575;">),</span>
                <span style="color: #839496;">int</span><span style="color: #757575;">(</span>timeouts.session_start_timeout_sec * 1e6<span style="color: #757575;">),</span>
                <span style="color: #839496;">int</span><span style="color: #757575;">(</span>timeouts.session_established_timeout_sec * 1e6<span style="color: #757575;">),</span>
            <span style="color: #757575;">)</span>
        <span style="color: #757575;">)</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">&#20854;&#20013; _wrap_transport_write, _wrap_transport_read &#26159;&#23545; transport &#30340;&#31616;&#21333;&#23553;&#35013;</span>

<span style="color: #859900;">def</span> <span style="color: #268bd2;">_wrap_transport_read</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> n<span style="color: #757575;">,</span> timeout_microsec<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> <span style="color: #859900;">self</span>.transport.read<span style="color: #757575;">(</span>
        n<span style="color: #757575;">,</span> <span style="color: #839496;">float</span><span style="color: #757575;">(</span>timeout_microsec<span style="color: #757575;">)</span> / 1e6 <span style="color: #859900;">if</span> timeout_microsec <span style="color: #859900;">is</span> <span style="color: #859900;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span> <span style="color: #859900;">else</span> <span style="color: #268bd2; font-weight: bold;">None</span>
    <span style="color: #757575;">)</span>    


<span style="color: #859900;">def</span> <span style="color: #268bd2;">_wrap_transport_write</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> data<span style="color: #757575;">,</span> timeout_microsec<span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> <span style="color: #859900;">self</span>.transport.write<span style="color: #757575;">(</span>
        data<span style="color: #757575;">,</span> <span style="color: #839496;">float</span><span style="color: #757575;">(</span>timeout_microsec<span style="color: #757575;">)</span> / 1e6 <span style="color: #859900;">if</span> timeout_microsec <span style="color: #859900;">is</span> <span style="color: #859900;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span> <span style="color: #859900;">else</span> <span style="color: #268bd2; font-weight: bold;">None</span>
    <span style="color: #757575;">)</span>    


TVM_REGISTER_GLOBAL<span style="color: #757575;">(</span><span style="color: #2aa198;">"micro._rpc_connect"</span><span style="color: #757575;">)</span>.set_body<span style="color: #757575;">(</span>[]<span style="color: #757575;">(</span>TVMArgs args<span style="color: #757575;">,</span> TVMRetValue* rv<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
  MicroTransportChannel* micro_channel =
      new MicroTransportChannel<span style="color: #757575;">(</span>args[1]<span style="color: #757575;">,</span> args[2]<span style="color: #757575;">,</span> ::std::chrono::microseconds<span style="color: #757575;">(</span>uint64_t<span style="color: #757575;">(</span>args[3]<span style="color: #757575;">)),</span>
                                ::std::chrono::microseconds<span style="color: #757575;">(</span>uint64_t<span style="color: #757575;">(</span>args[4]<span style="color: #757575;">)),</span>
                                ::std::chrono::microseconds<span style="color: #757575;">(</span>uint64_t<span style="color: #757575;">(</span>args[5]<span style="color: #757575;">)))</span>;
  std::unique_ptr&lt;RPCChannel&gt; channel<span style="color: #757575;">(</span>micro_channel<span style="color: #757575;">)</span>;
  auto ep = RPCEndpoint::Create<span style="color: #757575;">(</span>std::move<span style="color: #757575;">(</span>channel<span style="color: #757575;">),</span> args[0]<span style="color: #757575;">,</span> <span style="color: #2aa198;">""</span><span style="color: #757575;">)</span>;
  auto sess = CreateClientSession<span style="color: #757575;">(</span>ep<span style="color: #757575;">)</span>;
  *rv = CreateRPCSessionModule<span style="color: #757575;">(</span>sess<span style="color: #757575;">)</span>;
<span style="color: #757575;">})</span>;
</pre>
</div>
</div>
</li>

<li><a id="orgc80337e"></a>调用 session.get_system_lib<br />
<div class="outline-text-7" id="text-1-3-2-1-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">session</span>.get_system_lib<span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">)</span>:
    <span style="color: #859900;">return</span> <span style="color: #859900;">self</span>._rpc.get_function<span style="color: #757575;">(</span><span style="color: #2aa198;">"runtime.SystemLib"</span><span style="color: #757575;">)()</span>

PackedFunc RPCModuleNode::GetFunction<span style="color: #757575;">(</span>const std::string&amp; name<span style="color: #757575;">,</span> const ObjectPtr&lt;Object&gt;&amp; sptr_to_self<span style="color: #757575;">)</span> final <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> WrapRemoteFunc<span style="color: #757575;">(</span>sess_-&gt;GetFunction<span style="color: #757575;">(</span>name<span style="color: #757575;">))</span>;                                          
<span style="color: #757575;">}</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">&#20889;&#20837;&#21040; stream &#30340; RPCCode &#20026; kGetGlobalFunc</span>
PackedFuncHandle RPCClientSession::GetFunction<span style="color: #757575;">(</span>const std::string&amp; name<span style="color: #757575;">)</span> final <span style="color: #757575;">{</span>
    <span style="color: #859900;">return</span> endpoint_-&gt;SysCallRemote<span style="color: #757575;">(</span>RPCCode::kGetGlobalFunc<span style="color: #757575;">,</span> name<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>

<span style="color: #268bd2;">syscall_remote_</span> = PackedFunc<span style="color: #757575;">(</span>[this]<span style="color: #757575;">(</span>TVMArgs all_args<span style="color: #757575;">,</span> TVMRetValue* rv<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    RPCCode code = static_cast&lt;RPCCode&gt;<span style="color: #757575;">(</span>all_args[0].operator <span style="color: #839496;">int</span><span style="color: #757575;">())</span>;
    TVMArgs args<span style="color: #757575;">(</span>all_args.values + 1<span style="color: #757575;">,</span> all_args.type_codes + 1<span style="color: #757575;">,</span> all_args.num_args - 1<span style="color: #757575;">)</span>;

    uint64_t packet_nbytes = sizeof<span style="color: #757575;">(</span>code<span style="color: #757575;">)</span> + handler_-&gt;PackedSeqGetNumBytes<span style="color: #757575;">(</span>
                                                args.values<span style="color: #757575;">,</span> args.type_codes<span style="color: #757575;">,</span> args.num_args<span style="color: #757575;">,</span> true<span style="color: #757575;">)</span>;

    // All packet begins <span style="color: #859900;">with</span> packet nbytes
    handler_-&gt;Write<span style="color: #757575;">(</span>packet_nbytes<span style="color: #757575;">)</span>;
    handler_-&gt;Write<span style="color: #757575;">(</span>code<span style="color: #757575;">)</span>;
    handler_-&gt;SendPackedSeq<span style="color: #757575;">(</span>args.values<span style="color: #757575;">,</span> args.type_codes<span style="color: #757575;">,</span> args.num_args<span style="color: #757575;">,</span> true<span style="color: #757575;">)</span>;

    code = HandleUntilReturnEvent<span style="color: #757575;">(</span>true<span style="color: #757575;">,</span> [rv]<span style="color: #757575;">(</span>TVMArgs args<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      ICHECK_EQ<span style="color: #757575;">(</span>args.size<span style="color: #757575;">(),</span> 1<span style="color: #757575;">)</span>;
      *rv = args[0];
    <span style="color: #757575;">})</span>;
    ICHECK<span style="color: #757575;">(</span>code == RPCCode::kReturn<span style="color: #757575;">)</span> &lt;&lt; <span style="color: #2aa198;">"code="</span> &lt;&lt; static_cast&lt;<span style="color: #839496;">int</span>&gt;<span style="color: #757575;">(</span>code<span style="color: #757575;">)</span>;
  <span style="color: #757575;">})</span>;

<span style="color: #586e75;"># </span><span style="color: #586e75;">handler &#26159; EventHandler &#23454;&#20363;</span>
void RPCEndpoint::Init<span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
  // ...
  handler_ = std::make_shared&lt;EventHandler&gt;<span style="color: #757575;">(</span>&amp;reader_<span style="color: #757575;">,</span> &amp;writer_<span style="color: #757575;">,</span> name_<span style="color: #757575;">,</span> &amp;remote_key_<span style="color: #757575;">,</span> flush_writer<span style="color: #757575;">)</span>;
  // ...
<span style="color: #757575;">}</span>

<span style="color: #859900;">class</span> <span style="color: #b58900;">RPCEndpoint</span>::EventHandler : public dmlc::Stream <span style="color: #757575;">{</span>
 public:
  EventHandler<span style="color: #757575;">(</span>support::RingBuffer* reader<span style="color: #757575;">,</span> support::RingBuffer* writer<span style="color: #757575;">,</span> std::string name<span style="color: #757575;">,</span>
               std::string* remote_key<span style="color: #757575;">,</span> std::function&lt;void<span style="color: #757575;">()</span>&gt; flush_writer<span style="color: #757575;">)</span>
      : reader_<span style="color: #757575;">(</span>reader<span style="color: #757575;">),</span>
        writer_<span style="color: #757575;">(</span>writer<span style="color: #757575;">),</span>
        name_<span style="color: #757575;">(</span>name<span style="color: #757575;">),</span>
        remote_key_<span style="color: #757575;">(</span>remote_key<span style="color: #757575;">),</span>
        flush_writer_<span style="color: #757575;">(</span>flush_writer<span style="color: #757575;">)</span> <span style="color: #757575;">{}</span>

void EventHandler::Write<span style="color: #757575;">(</span>const void* data<span style="color: #757575;">,</span> size_t size<span style="color: #757575;">)</span> final <span style="color: #757575;">{</span> writer_-&gt;Write<span style="color: #757575;">(</span>data<span style="color: #757575;">,</span> size<span style="color: #757575;">)</span>; <span style="color: #757575;">}</span>        

<span style="color: #586e75;"># </span><span style="color: #586e75;">&#26368;&#32456;&#22312; stream &#37324;&#20889;&#20102;&#19968;&#20010; "{kGetGlobalFunc}runtime.SystemLib..."</span>

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org9f89b32"></a>Server<br />
<div class="outline-text-6" id="text-1-3-2-1-2">
<p>
server 端 (mcu 端) 需要应用自己启动 loop, 从transport (例如 serial port) 获得数据后交给 MicroRPCServer 处理
</p>
</div>

<ol class="org-ol">
<li><a id="org8806bc7"></a>初始化 rpc_server<br />
<div class="outline-text-7" id="text-1-3-2-1-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #586e75;">// </span><span style="color: #586e75;">writer_func &#26159;&#29992;&#25143;&#33258;&#24049;&#25552;&#20379;&#30340; function, &#29992;&#26469;&#25226; rpc_server &#38656;&#35201;&#36820;&#22238;&#30340;&#25968;&#25454;&#36890;&#36807;&#36825;</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#20010; function &#20889;&#21040; transport &#19978;</span>
rpc_server = MicroTVMRpcServerInit<span style="color: #757575;">(</span>&amp;writer_func<span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">nullptr</span><span style="color: #757575;">)</span>;
<span style="color: #268bd2; font-weight: bold;">tvm</span>::<span style="color: #268bd2; font-weight: bold;">runtime</span>::<span style="color: #268bd2; font-weight: bold;">micro_rpc</span>::g_write_func = write_func;

<span style="color: #b58900;">tvm_crt_error_t</span> <span style="color: #268bd2;">err</span> = TVMInitializeRuntime<span style="color: #757575;">()</span>;
TVMPlatformMemoryAllocate<span style="color: #757575;">(</span>
    TVM_CRT_MAX_PACKET_SIZE_BYTES<span style="color: #757575;">,</span> dev<span style="color: #757575;">,</span> &amp;receive_buffer_memory<span style="color: #757575;">)</span>;
<span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
rpc_server-&gt;Initialize<span style="color: #757575;">()</span>;

<span style="color: #586e75;">// </span><span style="color: #586e75;">MicroRPCServer &#21021;&#22987;&#21270;&#26102;&#35760;&#24405;&#20102;&#19968;&#20010; unframer_ &#19982; session_ &#32465;&#23450;, &#21518;&#32493;&#29992;&#25143;&#38656;&#35201;&#36890;</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#36807; MicroTVMRpcServerLoop &#25163;&#21160;&#32473; unframer_ &#21890;&#25968;&#25454;, session_ &#25343;&#21040;&#35299;&#26512;&#25968;&#25454;&#21518;&#20250;&#35843;</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#29992; HandleCompleteMessageCb</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#21478;&#19968;&#26041;&#38754;, &#19982; framer_ &#32465;&#23450;&#30340; send_stream_ &#20250;&#29992;&#21040; writer_func (&#36890;&#36807;&#19968;&#20010;&#20840;&#23616;&#21464;&#37327;)</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">&#25226;&#20135;&#29983;&#30340;&#25968;&#25454;&#20889;&#22238;&#21040; transport &#19978;</span>
<span style="color: #859900;">class</span> <span style="color: #b58900;">MicroRPCServer</span> <span style="color: #757575;">{</span>
   <span style="color: #859900;">public</span>:
    <span style="color: #268bd2;">MicroRPCServer</span><span style="color: #757575;">(</span>
        <span style="color: #b58900;">uint8_t</span>* <span style="color: #268bd2;">receive_storage</span><span style="color: #757575;">,</span> <span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">receive_storage_size_bytes</span><span style="color: #757575;">,</span>
        <span style="color: #b58900;">microtvm_rpc_channel_write_t</span> <span style="color: #268bd2;">write_func</span><span style="color: #757575;">,</span> <span style="color: #b58900;">void</span>* <span style="color: #268bd2;">write_func_ctx</span><span style="color: #757575;">)</span>
        : receive_buffer_<span style="color: #757575;">{</span>receive_storage<span style="color: #757575;">,</span> receive_storage_size_bytes<span style="color: #757575;">},</span>
          framer_<span style="color: #757575;">{</span>&amp;send_stream_<span style="color: #757575;">},</span>
          session_<span style="color: #757575;">{</span>&amp;framer_<span style="color: #757575;">,</span> &amp;receive_buffer_<span style="color: #757575;">,</span> &amp;HandleCompleteMessageCb<span style="color: #757575;">,</span> <span style="color: #859900;">this</span><span style="color: #757575;">},</span>
          io_<span style="color: #757575;">{</span>&amp;session_<span style="color: #757575;">,</span> &amp;receive_buffer_<span style="color: #757575;">},</span>
          unframer_<span style="color: #757575;">{</span>session_.Receiver<span style="color: #757575;">()},</span>
          rpc_server_<span style="color: #757575;">{</span>&amp;io_<span style="color: #757575;">},</span>
          is_running_<span style="color: #757575;">{</span><span style="color: #268bd2; font-weight: bold;">true</span><span style="color: #757575;">}</span> <span style="color: #757575;">{}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">Initialize</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
        <span style="color: #b58900;">uint8_t</span> <span style="color: #268bd2;">initial_session_nonce</span> = <span style="color: #268bd2; font-weight: bold;">Session</span>::kInvalidNonce;
        session_.Initialize<span style="color: #757575;">(</span>initial_session_nonce<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="orged40618"></a>rpc_server loop<br />
<div class="outline-text-7" id="text-1-3-2-1-2-2">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b58900;">tvm_crt_error_t</span> <span style="color: #268bd2;">MicroTVMRpcServerLoop</span><span style="color: #757575;">(</span><span style="color: #b58900;">microtvm_rpc_server_t</span> <span style="color: #268bd2;">server_ptr</span><span style="color: #757575;">,</span> <span style="color: #b58900;">uint8_t</span>** <span style="color: #268bd2;">new_data</span><span style="color: #757575;">,</span> <span style="color: #b58900;">size_t</span>* <span style="color: #268bd2;">new_data_size_bytes</span><span style="color: #757575;">)</span>:
  server-&gt;Loop<span style="color: #757575;">(</span>new_data<span style="color: #757575;">,</span> new_data_size_bytes<span style="color: #757575;">)</span>;

<span style="color: #b58900;">tvm_crt_error_t</span> <span style="color: #268bd2;">Loop</span><span style="color: #757575;">(</span><span style="color: #b58900;">uint8_t</span>** <span style="color: #268bd2;">new_data</span><span style="color: #757575;">,</span> <span style="color: #b58900;">size_t</span>* <span style="color: #268bd2;">new_data_size_bytes</span><span style="color: #757575;">)</span>: 
  err = unframer_.Write<span style="color: #757575;">(</span>*new_data<span style="color: #757575;">,</span> *new_data_size_bytes<span style="color: #757575;">,</span> &amp;bytes_consumed<span style="color: #757575;">)</span>;

<span style="color: #b58900;">tvm_crt_error_t</span> <span style="color: #268bd2; font-weight: bold;">Unframer</span>::<span style="color: #268bd2;">Write</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">uint8_t</span>* <span style="color: #268bd2;">data</span><span style="color: #757575;">,</span> <span style="color: #b58900;">size_t</span> <span style="color: #268bd2;">data_size_bytes</span><span style="color: #757575;">,</span><span style="color: #b58900;">size_t</span>* <span style="color: #268bd2;">bytes_consumed</span><span style="color: #757575;">)</span>:
    <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>state_<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
      <span style="color: #859900;">case</span> <span style="color: #268bd2; font-weight: bold;">State</span>::kFindCrcEnd:
        return_code = FindCrcEnd<span style="color: #757575;">()</span>;
          stream_-&gt;PacketDone<span style="color: #757575;">(</span>crc_ == *<span style="color: #859900;">reinterpret_cast</span>&lt;<span style="color: #b58900;">uint16_t</span>*&gt;<span style="color: #757575;">(</span>buffer_<span style="color: #757575;">))</span>;
            <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>header.message_type<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
              <span style="color: #859900;">default</span>:
                session_-&gt;message_received_func_<span style="color: #757575;">(</span>session_-&gt;message_received_func_context_<span style="color: #757575;">,</span>
                                         header.message_type<span style="color: #757575;">,</span> session_-&gt;receive_buffer_<span style="color: #757575;">)</span>;

<span style="color: #586e75;">// </span><span style="color: #586e75;">message_received_func_ &#21363; session &#21021;&#22987;&#21270;&#26102;&#30340; HandleCompleteMessageCb</span>

<span style="color: #b58900;">void</span> <span style="color: #268bd2; font-weight: bold;">MicroRPCServer</span>::<span style="color: #268bd2;">HandleCompleteMessage</span><span style="color: #757575;">(</span>MessageType message_type<span style="color: #757575;">,</span> FrameBuffer* buf<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
  rpc_server_.ProcessOnePacket<span style="color: #757575;">()</span>;
    <span style="color: #859900;">this</span>-&gt;Read<span style="color: #757575;">(</span>&amp;packet_len<span style="color: #757575;">)</span>;
    <span style="color: #859900;">this</span>-&gt;Read<span style="color: #757575;">(</span>&amp;code<span style="color: #757575;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>code &gt;= <span style="color: #268bd2; font-weight: bold;">RPCCode</span>::kSyscallCodeStart<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #859900;">this</span>-&gt;HandleSyscallFunc<span style="color: #757575;">(</span>code<span style="color: #757575;">)</span>;
    <span style="color: #757575;">}</span> <span style="color: #859900;">else</span> <span style="color: #757575;">{</span>
      <span style="color: #859900;">switch</span> <span style="color: #757575;">(</span>code<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #859900;">case</span> <span style="color: #268bd2; font-weight: bold;">RPCCode</span>::kCallFunc: <span style="color: #757575;">{</span>
          HandleNormalCallFunc<span style="color: #757575;">()</span>;
            TVMFuncCall<span style="color: #757575;">(</span><span style="color: #859900;">reinterpret_cast</span>&lt;<span style="color: #b58900;">void</span>*&gt;<span style="color: #757575;">(</span>call_handle<span style="color: #757575;">),</span> values<span style="color: #757575;">,</span> tcodes<span style="color: #757575;">,</span> num_args<span style="color: #757575;">,</span> &amp;<span style="color: #757575;">(</span>ret_value[1]<span style="color: #757575;">),</span> &amp;<span style="color: #757575;">(</span>ret_tcode[1]<span style="color: #757575;">))</span>;

          <span style="color: #859900;">break</span>;
        <span style="color: #757575;">}</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org1a6c7d4"></a>To summarize<br />
<div class="outline-text-6" id="text-1-3-2-1-3">
<p>
为了实现基于串口的 RPC, TVM 已经实现了大部分功能, 剩余需要自己实现的包括:
</p>

<ol class="org-ol">
<li><p>
client (python) 端需要实现一个串口的 tranport, 通过 Flasher 返回
</p>

<p>
<a href="file:///home/sunway/source/tvm/python/tvm/micro/contrib/zephyr.py">file:~/source/tvm/python/tvm/micro/contrib/zephyr.py</a>
</p></li>

<li><p>
server (mcu) 端需要:
</p>

<p>
<a href="file:///home/sunway/source/tvm/apps/microtvm/zephyr/host_driven/src/main.c">file:~/source/tvm/apps/microtvm/zephyr/host_driven/src/main.c</a>
</p>

<ol class="org-ol">
<li>实现一个写串口数据的 writer_func, 在 MicroTVMRpcServerInit 时注册上去</li>

<li>自己从串口读数据, 然后调用 MicroTVMRpcServerLoop</li>
</ol></li>
</ol>

<p>
Project API 的 host template 实现了一个基于 popen+pipe 的 RPC 的 demo:
<a href="file:///home/sunway/source/tvm/build/standalone_crt/template/host/main.cc">file:~/source/tvm/build/standalone_crt/template/host/main.cc</a>
</p>

<p>
Project API 的 zephyr template 实现了一个基于 uart 的 RPC 的 demo:
<a href="file:///home/sunway/source/tvm/apps/microtvm/zephyr/template_project/src/host_driven/main.c">file:~/source/tvm/apps/microtvm/zephyr/template_project/src/host_driven/main.c</a>
</p>
</div>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org14d9e10" class="outline-3">
<h3 id="org14d9e10"><span class="section-number-3">1.4</span> MicroTVM 与 AutoTVM</h3>
<div class="outline-text-3" id="text-1-4">
<p>
MicroTVM 通过 Proejct API 和 MicroTVM RPC 支持 AutoTVM
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">import</span> tvm
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> relay

<span style="color: #859900;">import</span> tempfile


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_model</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">x</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> relay.TensorType<span style="color: #757575;">(</span>[1<span style="color: #757575;">,</span> 10]<span style="color: #757575;">,</span> <span style="color: #2aa198;">"float32"</span><span style="color: #757575;">))</span>
    <span style="color: #268bd2;">y</span> = relay.add<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">f</span> = relay.Function<span style="color: #757575;">(</span>[x]<span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">relay_mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>f<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">relay_mod</span> = relay.transform.InferType<span style="color: #757575;">()(</span>relay_mod<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> relay_mod


<span style="color: #859900;">def</span> <span style="color: #268bd2;">tune</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">relay_mod</span> = get_model<span style="color: #757575;">()</span>
    <span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=3<span style="color: #757575;">,</span> config=<span style="color: #757575;">{</span><span style="color: #2aa198;">"tir.disable_vectorize"</span>: <span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">})</span>:
        <span style="color: #268bd2;">tasks</span> = tvm.autotvm.task.extract_from_program<span style="color: #757575;">(</span>
            relay_mod[<span style="color: #2aa198;">"main"</span>]<span style="color: #757575;">,</span> <span style="color: #757575;">{},</span> tvm.target.target.micro<span style="color: #757575;">(</span><span style="color: #2aa198;">"host"</span><span style="color: #757575;">)</span>
        <span style="color: #757575;">)</span>

    <span style="color: #268bd2;">module_loader</span> = tvm.micro.AutoTvmModuleLoader<span style="color: #757575;">(</span>
        template_project_dir=<span style="color: #2aa198;">"~/source/tvm/build/standalone_crt/template/host"</span><span style="color: #757575;">,</span>
        project_options=<span style="color: #757575;">{</span><span style="color: #2aa198;">"verbose"</span>: <span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #757575;">},</span>
    <span style="color: #757575;">)</span>
    <span style="color: #268bd2;">runner</span> = tvm.autotvm.LocalRunner<span style="color: #757575;">(</span>
        number=1<span style="color: #757575;">,</span> repeat=1<span style="color: #757575;">,</span> timeout=100<span style="color: #757575;">,</span> module_loader=module_loader
    <span style="color: #757575;">)</span>

    <span style="color: #268bd2;">builder</span> = tvm.autotvm.LocalBuilder<span style="color: #757575;">(</span>
        n_parallel=1<span style="color: #757575;">,</span>
        build_kwargs=<span style="color: #757575;">{</span><span style="color: #2aa198;">"build_option"</span>: <span style="color: #757575;">{</span><span style="color: #2aa198;">"tir.disable_vectorize"</span>: <span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">}},</span>
        build_func=tvm.micro.autotvm_build_func<span style="color: #757575;">,</span>
    <span style="color: #757575;">)</span>

    <span style="color: #859900;">for</span> task <span style="color: #859900;">in</span> tasks:
        <span style="color: #268bd2;">tuner</span> = tvm.autotvm.tuner.GATuner<span style="color: #757575;">(</span>task<span style="color: #757575;">)</span>
        tuner.tune<span style="color: #757575;">(</span>
            n_trial=1<span style="color: #757575;">,</span>
            measure_option=tvm.autotvm.measure_option<span style="color: #757575;">(</span>builder=builder<span style="color: #757575;">,</span> runner=runner<span style="color: #757575;">),</span>
        <span style="color: #757575;">)</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Project API &#20063;&#21487;&#20197;&#29992;&#26469;&#20570; autotvm</span>
    tune<span style="color: #757575;">()</span>

</pre>
</div>
</div>

<div id="outline-container-orgc7a27a4" class="outline-4">
<h4 id="orgc7a27a4"><span class="section-number-4">1.4.1</span> Impl</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">class</span> <span style="color: #b58900;">AutoTvmModuleLoader</span>:
    <span style="color: #b58900;">@contextlib.contextmanager</span>
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">__call__</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> remote_kw<span style="color: #757575;">,</span> build_result<span style="color: #757575;">)</span>:
        <span style="color: #859900;">with</span> <span style="color: #839496;">open</span><span style="color: #757575;">(</span>build_result.filename<span style="color: #757575;">,</span> <span style="color: #2aa198;">"rb"</span><span style="color: #757575;">)</span> <span style="color: #859900;">as</span> build_file:
            <span style="color: #268bd2;">build_result_bin</span> = build_file.read<span style="color: #757575;">()</span>

        <span style="color: #268bd2;">tracker</span> = _rpc.connect_tracker<span style="color: #757575;">(</span>remote_kw[<span style="color: #2aa198;">"host"</span>]<span style="color: #757575;">,</span> remote_kw[<span style="color: #2aa198;">"port"</span>]<span style="color: #757575;">)</span>
        <span style="color: #268bd2;">remote</span> = tracker.request<span style="color: #757575;">(</span>
            remote_kw[<span style="color: #2aa198;">"device_key"</span>]<span style="color: #757575;">,</span>
            priority=remote_kw[<span style="color: #2aa198;">"priority"</span>]<span style="color: #757575;">,</span>
            session_timeout=remote_kw[<span style="color: #2aa198;">"timeout"</span>]<span style="color: #757575;">,</span>
            session_constructor_args=[
                <span style="color: #2aa198;">"tvm.micro.compile_and_create_micro_session"</span><span style="color: #757575;">,</span>
                build_result_bin<span style="color: #757575;">,</span>
                <span style="color: #859900;">self</span>._template_project_dir<span style="color: #757575;">,</span>
                json.dumps<span style="color: #757575;">(</span><span style="color: #859900;">self</span>._project_options<span style="color: #757575;">),</span>
            ]<span style="color: #757575;">,</span>
        <span style="color: #757575;">)</span>
        <span style="color: #268bd2;">system_lib</span> = remote.get_function<span style="color: #757575;">(</span><span style="color: #2aa198;">"runtime.SystemLib"</span><span style="color: #757575;">)()</span>
        <span style="color: #859900;">yield</span> remote<span style="color: #757575;">,</span> system_lib


<span style="color: #859900;">def</span> <span style="color: #268bd2;">compile_and_create_micro_session</span><span style="color: #757575;">(</span>
    mod_src_bytes: <span style="color: #839496;">bytes</span><span style="color: #757575;">,</span>
    template_project_dir: <span style="color: #839496;">str</span><span style="color: #757575;">,</span>
    project_options: <span style="color: #839496;">dict</span> = <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span>
<span style="color: #757575;">)</span>:
    <span style="color: #268bd2;">temp_dir</span> = utils.tempdir<span style="color: #757575;">()</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Keep temp directory for generate project</span>
    temp_dir.set_keep_for_debug<span style="color: #757575;">(</span><span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">model_library_format_path</span> = temp_dir / <span style="color: #2aa198;">"model.tar.gz"</span>
    <span style="color: #859900;">with</span> <span style="color: #839496;">open</span><span style="color: #757575;">(</span>model_library_format_path<span style="color: #757575;">,</span> <span style="color: #2aa198;">"wb"</span><span style="color: #757575;">)</span> <span style="color: #859900;">as</span> mlf_f:
        mlf_f.write<span style="color: #757575;">(</span>mod_src_bytes<span style="color: #757575;">)</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">&#36825;&#37324;&#20351;&#29992;&#20102; Project API &#36827;&#34892; build, flash</span>
    <span style="color: #268bd2;">template_project</span> = project.TemplateProject.from_directory<span style="color: #757575;">(</span>template_project_dir<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">generated_project</span> = template_project.generate_project_from_mlf<span style="color: #757575;">(</span>
        model_library_format_path<span style="color: #757575;">,</span>
        <span style="color: #839496;">str</span><span style="color: #757575;">(</span>temp_dir / <span style="color: #2aa198;">"generated-project"</span><span style="color: #757575;">),</span>
        options=json.loads<span style="color: #757575;">(</span>project_options<span style="color: #757575;">),</span>
    <span style="color: #757575;">)</span>

    generated_project.build<span style="color: #757575;">()</span>
    generated_project.flash<span style="color: #757575;">()</span>
    <span style="color: #268bd2;">transport</span> = generated_project.transport<span style="color: #757575;">()</span>

    <span style="color: #586e75;"># </span><span style="color: #586e75;">&#36825;&#37324;&#20351;&#29992;&#20102; transport &#21644; bin &#20013;&#30340; microtvm rpc server &#20132;&#20114;</span>
    <span style="color: #268bd2;">rpc_session</span> = Session<span style="color: #757575;">(</span>transport_context_manager=transport<span style="color: #757575;">)</span>
    rpc_session.__enter__<span style="color: #757575;">()</span>
    <span style="color: #859900;">return</span> rpc_session._rpc._sess
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgab47bd2" class="outline-3">
<h3 id="orgab47bd2"><span class="section-number-3">1.5</span> Micro TVM &amp; BYOC</h3>
<div class="outline-text-3" id="text-1-5">
<p>
先说结论: Micro TVM 不支持 基于 __tvm_dev_mblob 方式的 BYOC, 但可以支持 c_src 形式的 BYOC <a href="#org22af66e">C Runtime</a>
</p>

<p>
为了支持 __tvm_dev_mblob, 最重要的一点是把 __tvm_dev_mblob 注册到 SystemLib 上.
</p>

<p>
TVM Runtime 的启动有三种方式:
</p>

<ol class="org-ol">
<li>通过 LoadFromFile 加载 DSOLibrary, 具体实现是 CreateModuleFromLibrary</li>
<li>通过 runtime.SystemLib 加载 SystemLibrary
<ol class="org-ol">
<li>c++ runtime 的 runtime.SystemLib 的实现与 DSOLibrary 一样, 是 CreateModuleFromLibrary</li>
<li>c runtime 的 runtime.SystemLib 的实现是 SystemLibraryCreate</li>
</ol></li>
</ol>

<p>
编译时: 1 和 2.1 编译时会注册 __tvm_dev_mblob, 而 2.2 不支持运行时: 1 和 2.1 在运行时都会去加载 __tvm_dev_mblob, 而 2.2 则不支持.
</p>
</div>

<div id="outline-container-orge195064" class="outline-4">
<h4 id="orge195064"><span class="section-number-4">1.5.1</span> system-lib &amp; c++ runtime 注册 __tvm_dev_mblob</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
2.1 (system-lib &amp; c++ runtime) 是支持注册 __tvm_dev_mblob 的
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">export_library</span><span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> file_name<span style="color: #757575;">,</span> fcompile=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> addons=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> workspace_dir=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">,</span> **kwargs<span style="color: #757575;">)</span>:
    <span style="color: #586e75;"># </span><span style="color: #586e75;">...</span>
    <span style="color: #859900;">if</span> <span style="color: #859900;">self</span>.imported_modules:
        <span style="color: #859900;">if</span> enabled<span style="color: #757575;">(</span><span style="color: #2aa198;">"llvm"</span><span style="color: #757575;">)</span> <span style="color: #859900;">and</span> llvm_target_triple:
            <span style="color: #268bd2;">path_obj</span> = os.path.join<span style="color: #757575;">(</span>workspace_dir<span style="color: #757575;">,</span> f<span style="color: #2aa198;">"devc.{object_format}"</span><span style="color: #757575;">)</span>
            <span style="color: #268bd2;">m</span> = _ffi_api.ModulePackImportsToLLVM<span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> is_system_lib<span style="color: #757575;">,</span> llvm_target_triple<span style="color: #757575;">)</span>
            m.save<span style="color: #757575;">(</span>path_obj<span style="color: #757575;">)</span>
            files.append<span style="color: #757575;">(</span>path_obj<span style="color: #757575;">)</span>
        <span style="color: #859900;">else</span>:
            <span style="color: #268bd2;">path_cc</span> = os.path.join<span style="color: #757575;">(</span>workspace_dir<span style="color: #757575;">,</span> <span style="color: #2aa198;">"devc.c"</span><span style="color: #757575;">)</span>
            <span style="color: #859900;">with</span> <span style="color: #839496;">open</span><span style="color: #757575;">(</span>path_cc<span style="color: #757575;">,</span> <span style="color: #2aa198;">"w"</span><span style="color: #757575;">)</span> <span style="color: #859900;">as</span> f:
                f.write<span style="color: #757575;">(</span>_ffi_api.ModulePackImportsToC<span style="color: #757575;">(</span><span style="color: #859900;">self</span><span style="color: #757575;">,</span> is_system_lib<span style="color: #757575;">))</span>
            files.append<span style="color: #757575;">(</span>path_cc<span style="color: #757575;">)</span>

</pre>
</div>

<p>
ModulePackImportsToLLVM 和 ModulePackImportsToC 会生成类似下面的代码:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #859900;">extern</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">TVMBackendRegisterSystemLibSymbol</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #b58900;">char</span>*<span style="color: #757575;">,</span> <span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>;
<span style="color: #859900;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">__tvm_dev_mblob_reg_</span> = TVMBackendRegisterSystemLibSymbol<span style="color: #757575;">(</span>
    <span style="color: #2aa198;">"__tvm_dev_mblob"</span><span style="color: #757575;">,</span> <span style="color: #757575;">(</span><span style="color: #b58900;">void</span>*<span style="color: #757575;">)</span>__tvm_dev_mblob<span style="color: #757575;">)</span>;
</pre>
</div>

<p>
通过 c++ 的 ctor 完成对 TVMBackendRegisterSystemLibSymbol 的调用.
</p>
</div>
</div>

<div id="outline-container-orgb9a0dc9" class="outline-4">
<h4 id="orgb9a0dc9"><span class="section-number-4">1.5.2</span> system-lib &amp; c runtime 不支持注册和解析 __tvm_dev_mblob</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
从当前的代码来看:
</p>

<ol class="org-ol">
<li>在 export_library 时不会针对 c_runtime 生成注册 __tvm_dev_mblob 的代码 (例如
ModulePackImportsToLLVM)</li>
<li>运行时 c runtime 也不会解析 __tvm_dev_mblob</li>
<li>以及一些其它的问题例如: <a href="file:///home/sunway/source/tvm/src/target/metadata_module.cc#orgd6089ea">file:///home/sunway/source/tvm/src/target/metadata_module.cc#orgd6089ea</a></li>
</ol>

<p>
所以 microtvm 无法支持 BYOC.
</p>

<p>
但是如果 c runtime 只是为了解决 c++ runtime ctor 的问题, 我们其实可以手动调用
c++ ctor:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span style="color: #268bd2;">#include</span> <span style="color: #2aa198;">&lt;stdio.h&gt;</span>
<span style="color: #859900;">class</span> <span style="color: #b58900;">A</span> <span style="color: #757575;">{</span>
   <span style="color: #859900;">public</span>:
    <span style="color: #268bd2;">A</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span> printf<span style="color: #757575;">(</span><span style="color: #2aa198;">"hello\n"</span><span style="color: #757575;">)</span>; <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>;

<span style="color: #b58900;">A</span> <span style="color: #268bd2;">a</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">b</span><span style="color: #757575;">,</span> <span style="color: #268bd2;">c</span>;

<span style="color: #859900;">typedef</span> <span style="color: #b58900;">void</span> <span style="color: #757575;">(</span>*<span style="color: #b58900;">FP</span><span style="color: #757575;">)()</span>;

<span style="color: #586e75;">// </span><span style="color: #586e75;">__init_array_start, __init_array_end &#26159;&#36890;&#36807; linker script &#23450;&#20041;&#30340;&#31526;&#21495;</span>
<span style="color: #859900;">extern</span> <span style="color: #b58900;">FP</span> <span style="color: #268bd2;">__init_array_start</span>;
<span style="color: #859900;">extern</span> <span style="color: #b58900;">FP</span> <span style="color: #268bd2;">__init_array_end</span>;

<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span><span style="color: #757575;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span><span style="color: #757575;">,</span> <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    printf<span style="color: #757575;">(</span><span style="color: #2aa198;">"----------main----------\n"</span><span style="color: #757575;">)</span>;
    <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #b58900;">FP</span> *<span style="color: #268bd2;">p</span> = &amp;__init_array_start; p &lt; &amp;__init_array_end; p++<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
        <span style="color: #757575;">(</span>*p<span style="color: #757575;">)()</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #859900;">return</span> 0;
<span style="color: #757575;">}</span>
</pre>
</div>

<p>
hello
hello
hello
-----&#x2013;&#x2014;main-----&#x2013;&#x2014;
hello
hello
hello
</p>
</div>
</div>

<div id="outline-container-org6f8a2c5" class="outline-4">
<h4 id="org6f8a2c5"><span class="section-number-4">1.5.3</span> ModulePackImportsToLLVM 的 Bug</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
ModulePackImportsToLLVM 时如果 is_system_lib 为 False, 则不会生成注册
__tvm_dev_mblob 的代码, 但 is_system_lib 的判断条件是:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">is_system_lib</span> = <span style="color: #757575;">(</span>
    module.type_key == <span style="color: #2aa198;">"llvm"</span> <span style="color: #859900;">and</span> module.get_function<span style="color: #757575;">(</span><span style="color: #2aa198;">"__tvm_is_system_module"</span><span style="color: #757575;">)()</span>
<span style="color: #757575;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b58900;">PackedFunc</span> <span style="color: #268bd2;">GetFunction</span><span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #b58900;">string</span>&amp; <span style="color: #268bd2;">name</span><span style="color: #757575;">,</span> <span style="color: #859900;">const</span> <span style="color: #b58900;">ObjectPtr</span>&lt;Object&gt;&amp; <span style="color: #268bd2;">sptr_to_self</span><span style="color: #757575;">)</span> <span style="color: #859900;">final</span> <span style="color: #757575;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #757575;">(</span>name == <span style="color: #2aa198;">"__tvm_is_system_module"</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #586e75;">// </span><span style="color: #586e75;">&#21028;&#26029;&#26377;&#27809;&#26377; __tvm_module_startup        </span>
      <span style="color: #b58900;">bool</span> <span style="color: #268bd2;">flag</span> = <span style="color: #757575;">(</span>mptr_-&gt;getFunction<span style="color: #757575;">(</span><span style="color: #2aa198;">"__tvm_module_startup"</span><span style="color: #757575;">)</span> != <span style="color: #268bd2; font-weight: bold;">nullptr</span><span style="color: #757575;">)</span>;
      <span style="color: #859900;">return</span> PackedFunc<span style="color: #757575;">(</span>[<span style="color: #268bd2; font-weight: bold;">flag</span>]<span style="color: #757575;">(</span><span style="color: #b58900;">TVMArgs</span> <span style="color: #268bd2;">args</span><span style="color: #757575;">,</span> <span style="color: #b58900;">TVMRetValue</span>* <span style="color: #268bd2;">rv</span><span style="color: #757575;">)</span> <span style="color: #757575;">{</span> *rv = flag; <span style="color: #757575;">})</span>;
    <span style="color: #757575;">}</span>
    <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
<span style="color: #757575;">}</span>

<span style="color: #586e75;">// </span><span style="color: #586e75;">&#28155;&#21152; __tvm_module_startup &#30340;&#20195;&#30721;</span>
<span style="color: #b58900;">void</span> <span style="color: #268bd2; font-weight: bold;">CodeGenCPU</span>::<span style="color: #268bd2;">AddStartupFunction</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
  <span style="color: #859900;">if</span> <span style="color: #757575;">(</span><span style="color: #b58900; font-weight: bold;">!</span>target_c_runtime_<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
    <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #b58900;">FunctionType</span>* <span style="color: #268bd2;">ftype</span> = <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">FunctionType</span>::get<span style="color: #757575;">(</span>t_void_<span style="color: #757575;">,</span> <span style="color: #757575;">{},</span> <span style="color: #268bd2; font-weight: bold;">false</span><span style="color: #757575;">)</span>;
    function_ = <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::Create<span style="color: #757575;">(</span>ftype<span style="color: #757575;">,</span> <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #268bd2; font-weight: bold;">Function</span>::InternalLinkage<span style="color: #757575;">,</span>
                                       <span style="color: #2aa198;">"__tvm_module_startup"</span><span style="color: #757575;">,</span> module_.get<span style="color: #757575;">())</span>;
    <span style="color: #859900;">for</span> <span style="color: #757575;">(</span><span style="color: #859900;">const</span> <span style="color: #859900;">auto</span>&amp; <span style="color: #268bd2;">kv</span> : export_system_symbols_<span style="color: #757575;">)</span> <span style="color: #757575;">{</span>
      <span style="color: #268bd2; font-weight: bold;">llvm</span>::<span style="color: #b58900;">Value</span>* <span style="color: #268bd2;">name</span> = GetConstString<span style="color: #757575;">(</span>kv.first<span style="color: #757575;">)</span>;
      builder_-&gt;CreateCall<span style="color: #757575;">(</span>f_tvm_register_system_symbol_<span style="color: #757575;">,</span>
                           <span style="color: #757575;">{</span>name<span style="color: #757575;">,</span> builder_-&gt;CreateBitCast<span style="color: #757575;">(</span>kv.second<span style="color: #757575;">,</span> t_void_p_<span style="color: #757575;">)})</span>;
    <span style="color: #757575;">}</span>    
    <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
  <span style="color: #757575;">}</span>
<span style="color: #757575;">}</span>

<span style="color: #268bd2; font-weight: bold;">std</span>::<span style="color: #b58900;">unique_ptr</span>&lt;<span style="color: #268bd2; font-weight: bold;">llvm</span>::Module&gt; <span style="color: #268bd2; font-weight: bold;">CodeGenLLVM</span>::<span style="color: #268bd2;">Finish</span><span style="color: #757575;">()</span> <span style="color: #757575;">{</span>
  <span style="color: #859900;">this</span>-&gt;AddStartupFunction<span style="color: #757575;">()</span>;
  <span style="color: #586e75;">// </span><span style="color: #586e75;">...</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">optimize</span>
  <span style="color: #859900;">this</span>-&gt;Optimize<span style="color: #757575;">()</span>;
  <span style="color: #859900;">return</span> <span style="color: #268bd2; font-weight: bold;">std</span>::move<span style="color: #757575;">(</span>module_<span style="color: #757575;">)</span>;
<span style="color: #757575;">}</span>

</pre>
</div>

<p>
问题出在最后那个 llvm::Optimize
</p>

<p>
当 relay IR 时没有任何函数需要在 CPU 执行时 (所有代码都交给 dnnl 执行),
export_system_symbols_ 会为空, 这时虽然已经在 llvm module 里生成了一个
__tvm_module_startup 函数, 但因为它的函数体为空且函数是 InternalLinkage,
llvm::Optimize 会把它删除&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/usr/bin/env python3</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">-*- coding: utf-8 -*-</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">2021-08-03 11:11</span>
<span style="color: #859900;">import</span> tvm
<span style="color: #859900;">import</span> numpy <span style="color: #859900;">as</span> np
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> te
<span style="color: #859900;">from</span> tvm <span style="color: #859900;">import</span> relay
<span style="color: #859900;">import</span> os


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_good_mod</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">d1</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"d1"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 32<span style="color: #757575;">,</span> 56<span style="color: #757575;">,</span> 56<span style="color: #757575;">),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">w1</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"w1"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>32<span style="color: #757575;">,</span> 32<span style="color: #757575;">,</span> 3<span style="color: #757575;">,</span> 3<span style="color: #757575;">),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">b1</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"b1"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>32<span style="color: #757575;">,),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">conv</span> = relay.nn.conv2d<span style="color: #757575;">(</span>d1<span style="color: #757575;">,</span> w1<span style="color: #757575;">,</span> strides=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">),</span> padding=<span style="color: #757575;">(</span>1<span style="color: #757575;">,</span> 1<span style="color: #757575;">))</span>
    <span style="color: #268bd2;">bias</span> = relay.nn.bias_add<span style="color: #757575;">(</span>conv<span style="color: #757575;">,</span> b1<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">relu</span> = relay.nn.relu<span style="color: #757575;">(</span>bias<span style="color: #757575;">)</span>

    <span style="color: #268bd2;">func</span> = relay.Function<span style="color: #757575;">(</span>[d1<span style="color: #757575;">,</span> w1<span style="color: #757575;">,</span> b1]<span style="color: #757575;">,</span> relu<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>func<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">mod</span> = relay.transform.InferType<span style="color: #757575;">()(</span>mod<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> mod


<span style="color: #859900;">def</span> <span style="color: #268bd2;">get_bug_mod</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">x</span> = relay.var<span style="color: #757575;">(</span><span style="color: #2aa198;">"x"</span><span style="color: #757575;">,</span> shape=<span style="color: #757575;">(</span>10<span style="color: #757575;">,),</span> dtype=<span style="color: #2aa198;">"float32"</span><span style="color: #757575;">)</span>
    <span style="color: #268bd2;">y</span> = relay.add<span style="color: #757575;">(</span>x<span style="color: #757575;">,</span> x<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">func</span> = relay.Function<span style="color: #757575;">(</span>[x]<span style="color: #757575;">,</span> y<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">mod</span> = tvm.IRModule.from_expr<span style="color: #757575;">(</span>func<span style="color: #757575;">)</span>
    <span style="color: #859900;">return</span> mod


<span style="color: #859900;">def</span> <span style="color: #268bd2;">prepare_relay_libs</span><span style="color: #757575;">()</span>:
    <span style="color: #268bd2;">mod</span> = get_bug_mod<span style="color: #757575;">()</span>
    <span style="color: #268bd2;">mod</span> = relay.transform.AnnotateTarget<span style="color: #757575;">(</span><span style="color: #2aa198;">"dnnl"</span><span style="color: #757575;">)(</span>mod<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">mod</span> = relay.transform.PartitionGraph<span style="color: #757575;">()(</span>mod<span style="color: #757575;">)</span>
    <span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=1<span style="color: #757575;">)</span>:
        <span style="color: #268bd2;">mod</span> = relay.build<span style="color: #757575;">(</span>mod<span style="color: #757575;">,</span> target=<span style="color: #2aa198;">"llvm --system-lib --runtime=c++"</span><span style="color: #757575;">,</span> params=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">)</span>
    mod.lib.export_library<span style="color: #757575;">(</span><span style="color: #2aa198;">"/tmp/libdouble_bug.tar"</span><span style="color: #757575;">)</span>

    <span style="color: #268bd2;">mod</span> = get_good_mod<span style="color: #757575;">()</span>
    <span style="color: #268bd2;">mod</span> = relay.transform.AnnotateTarget<span style="color: #757575;">(</span><span style="color: #2aa198;">"dnnl"</span><span style="color: #757575;">)(</span>mod<span style="color: #757575;">)</span>
    <span style="color: #268bd2;">mod</span> = relay.transform.PartitionGraph<span style="color: #757575;">()(</span>mod<span style="color: #757575;">)</span>
    <span style="color: #859900;">with</span> tvm.transform.PassContext<span style="color: #757575;">(</span>opt_level=1<span style="color: #757575;">)</span>:
        <span style="color: #268bd2;">mod</span> = relay.build<span style="color: #757575;">(</span>mod<span style="color: #757575;">,</span> target=<span style="color: #2aa198;">"llvm --system-lib --runtime=c++"</span><span style="color: #757575;">,</span> params=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #757575;">)</span>
    mod.lib.export_library<span style="color: #757575;">(</span><span style="color: #2aa198;">"/tmp/libdouble_good.tar"</span><span style="color: #757575;">)</span>


<span style="color: #859900;">if</span> <span style="color: #839496;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    prepare_relay_libs<span style="color: #757575;">()</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #839496;">echo</span> <span style="color: #2aa198;">"----------good----------"</span>
tar xvf /tmp/libdouble_good.tar -C /tmp
readelf -s /tmp/lib0.o
readelf -s /tmp/devc.o
<span style="color: #839496;">echo</span> <span style="color: #2aa198;">"----------bug----------"</span>
tar xvf /tmp/libdouble_bug.tar -C /tmp
readelf -s /tmp/lib0.o
readelf -s /tmp/devc.o
</pre>
</div>

<p>
-----&#x2013;&#x2014;good-----&#x2013;&#x2014;
lib0.o
devc.o
</p>

<p>
Symbol table '.symtab' contains 16 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    4 .LCPI0_0
     3: 00000000000005f0    40 FUNC    LOCAL  DEFAULT    2 __tvm_module_startup
     4: 0000000000000370    40 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_nn_b
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    2 
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    9 
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   10 
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT   11 
    10: 0000000000000000     0 SECTION LOCAL  DEFAULT   20 
    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    12: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendParallelLaunch
    13: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
    14: 0000000000000000     8 OBJECT  WEAK   DEFAULT    5 __tvm_module_ctx
    15: 0000000000000000   869 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_nn_b
</p>

<p>
Symbol table '.symtab' contains 10 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS devc
     2: 0000000000000000     8 FUNC    LOCAL  DEFAULT    3 _GLOBAL__sub_I_devc
     3: 0000000000000010    28 FUNC    LOCAL  DEFAULT    3 <span class="underline">_cxx_global_var_init
     4: 0000000000000000     4 OBJECT  LOCAL  DEFAULT    6 __tvm_dev_mblob_reg</span>
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 
     8: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
     9: 0000000000000000  2990 OBJECT  GLOBAL DEFAULT    5 __tvm_dev_mblob
-----&#x2013;&#x2014;bug-----&#x2013;&#x2014;
lib0.o
devc.o
</p>

<p>
Symbol table '.symtab' contains 6 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT   12 
</p>

<p>
Symbol table '.symtab' contains 3 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS devc
     2: 0000000000000000  1015 OBJECT  GLOBAL DEFAULT    3 __tvm_dev_mblob
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2021-08-03 二 00:00<br />
Last updated: 2022-01-24 一 19:28</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
