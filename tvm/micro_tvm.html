<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!--  -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Micro TVM</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Micro TVM</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org000005c">1. Micro TVM</a>
<ul>
<li><a href="#org0000010">1.1. system-lib</a>
<ul>
<li><a href="#org0000000">1.1.1. The Problem of DSO</a></li>
<li><a href="#org0000009">1.1.2. C++ Runtime</a></li>
<li><a href="#org000000d">1.1.3. C Runtime</a></li>
</ul>
</li>
<li><a href="#org000001c">1.2. Static Deploy</a>
<ul>
<li><a href="#org0000013">1.2.1. C++ Runtime</a></li>
<li><a href="#org0000016">1.2.2. C Runtime</a></li>
<li><a href="#org0000019">1.2.3. 交叉编译</a></li>
</ul>
</li>
<li><a href="#org0000047">1.3. Micro TVM</a>
<ul>
<li><a href="#org0000028">1.3.1. Project API</a></li>
<li><a href="#org0000044">1.3.2. RPC</a></li>
</ul>
</li>
<li><a href="#org0000001">1.4. MicroTVM 与 AutoTVM</a>
<ul>
<li><a href="#org000004a">1.4.1. Impl</a></li>
</ul>
</li>
<li><a href="#org0000059">1.5. Micro TVM &amp; BYOC</a>
<ul>
<li><a href="#org0000050">1.5.1. system-lib &amp; c++ runtime 注册 __tvm_dev_mblob</a></li>
<li><a href="#org0000053">1.5.2. system-lib &amp; c runtime 不支持注册和解析 __tvm_dev_mblob</a></li>
<li><a href="#org0000056">1.5.3. ModulePackImportsToLLVM 的 Bug</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000005c" class="outline-2">
<h2 id="org000005c"><span class="section-number-2">1</span> Micro TVM</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="file:///home/sunway/source/tvm/docs/dev/microtvm_design.rst">file:~/source/tvm/docs/dev/microtvm_design.rst</a>
</p>
</div>

<div id="outline-container-org0000010" class="outline-3">
<h3 id="org0000010"><span class="section-number-3">1.1</span> system-lib</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000000" class="outline-4">
<h4 id="org0000000"><span class="section-number-4">1.1.1</span> The Problem of DSO</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
library 正常是通过 DSO 的形式保存, 并在运行时通过 dlsym 方式来查找符号,
system-lib 机制是为了解决有些系统不支持 dlopen, dlsym 的问题. 如果无法用 dlsym
来查找, 那用什么方式来找到 `tvmgen_default_fused_add`?
</p>

<p>
有两种方案: c++ runtime 或 c runtime
</p>
</div>
</div>

<div id="outline-container-org0000009" class="outline-4">
<h4 id="org0000009"><span class="section-number-4">1.1.2</span> C++ Runtime</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-ipython">import tvm
from tvm import relay

x = relay.var("x", shape=(1, 1000), dtype="float32")
y = relay.add(x, x)
func = relay.Function([x], y)
mod = tvm.IRModule.from_expr(func)
print(mod)

with tvm.transform.PassContext(opt_level=1):
    mod = relay.build(mod, target="llvm --system-lib --runtime=c++", params=None)

mod.lib.save("/tmp/a.o")
</pre>
</div>

<p>
def @main(%x: Tensor[(1, 1000), float32]) {
  add(%x, %x)
}
</p>

<div class="org-src-container">
<pre class="src src-shell">readelf -s /tmp/a.o
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"------"</span>
readelf -a /tmp/a.o|grep <span style="font-style: italic;">"Relocation section '.rela.ctors'"</span> -A 3
</pre>
</div>

<p>

</p>

<p>
Symbol table '.symtab' contains 14 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000330    40 FUNC    LOCAL  DEFAULT    2 <span class="underline">_tvm_module_startup
     3: 0000000000000210   284 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_add</span>
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    9
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   10
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT   19
    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
    12: 0000000000000000     8 OBJECT  WEAK   DEFAULT    4 __tvm_module_ctx
    13: 0000000000000000   523 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_add
</p>
<hr />
<p>
Relocation section '.rela.ctors' at offset 0x1228 contains 1 entry:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000000  000400000001 R_X86_64_64       0000000000000000 .text + 330
</p>

<p>
相比没有加 system-lib 的情形, a.o 多了几个 symbol:
</p>

<ol class="org-ol">
<li><p>
__tvm_module_startup
</p>

<p>
利用 elf 的 ctor 在应用启动时调用 __tvm_module_startup
</p></li>

<li><p>
TVMBackendRegisterSystemLibSymbol
</p>

<p>
__tvm_module_startup 的代码会通过
TVMBackendRegisterSystemLibSymbol("tvmgen_default_fused_add",tvmgen_default_fused_add)
的方式把 tvmgen_default_fused_add 函数注册到一个 runtime 负责的全局的 `SystemLibrary` 上
</p></li>
</ol>
</div>

<div id="outline-container-org0000003" class="outline-5">
<h5 id="org0000003"><span class="section-number-5">1.1.2.1</span> __tvm_module_startup</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">CodeGenCPU</span>::<span style="font-weight: bold;">AddStartupFunction</span>() {
  <span style="font-weight: bold;">if</span> (!target_c_runtime_) {
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#26500;&#36896; __tvm_module_startup &#20989;&#25968;</span>
    function_ = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::Create(ftype, <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::InternalLinkage,
                                       <span style="font-style: italic;">"__tvm_module_startup"</span>, module_.get());
    <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">BasicBlock</span>* <span style="font-weight: bold; font-style: italic;">startup_entry</span> = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">BasicBlock</span>::Create(*ctx_, <span style="font-style: italic;">"entry"</span>, function_);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">__tvm_module_startup &#35843;&#29992; f_tvm_register_system_symbol_</span>
    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; <span style="font-weight: bold; font-style: italic;">kv</span> : export_system_symbols_) {
      builder_-&gt;CreateCall(f_tvm_register_system_symbol_,
                           {name, builder_-&gt;CreateBitCast(kv.second, t_void_p_)});
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25226; __tvm_module_startup &#21152;&#21040; elf &#30340; .ctor &#20013;</span>
    <span style="font-weight: bold; text-decoration: underline;">llvm</span>::appendToGlobalCtors(*module_, function_, 65535);
  }
}

f_tvm_register_system_symbol_ = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::Create(
    <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">FunctionType</span>::get(t_int_, {t_char_-&gt;getPointerTo(), t_void_p_}, <span style="font-weight: bold; text-decoration: underline;">false</span>),
    <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::ExternalLinkage, <span style="font-style: italic;">"TVMBackendRegisterSystemLibSymbol"</span>, module_.get());
</pre>
</div>

<p>
对应生成的代码为:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="font-weight: bold;">.text</span>:0000000000000340 __tvm_module_startup proc near          <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">DATA XREF: .ctors:0000000000000D50</span>
<span style="font-weight: bold;">.text</span>:0000000000000340                 push    rax
<span style="font-weight: bold;">.text</span>:0000000000000341                 lea     rdi, a__tvm_module_c <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">"__tvm_module_ctx"</span>
<span style="font-weight: bold;">.text</span>:0000000000000348                 mov     rsi, cs:__tvm_module_ctx_ptr
<span style="font-weight: bold;">.text</span>:000000000000034F                 call    TVMBackendRegisterSystemLibSymbol <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">PIC mode</span>
<span style="font-weight: bold;">.text</span>:0000000000000354                 lea     rdi, aTvmgen_default <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">"tvmgen_default_fused_add"</span>
<span style="font-weight: bold;">.text</span>:000000000000035B                 mov     rsi, cs:tvmgen_default_fused_add_ptr
<span style="font-weight: bold;">.text</span>:0000000000000362                 pop     rax
<span style="font-weight: bold;">.text</span>:0000000000000363
<span style="font-weight: bold;">.text</span>:0000000000000363 loc_363:                                <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">DATA XREF: .eh_frame:0000000000000D78</span>
<span style="font-weight: bold;">.text</span>:0000000000000363                 jmp     TVMBackendRegisterSystemLibSymbol <span style="font-weight: bold; font-style: italic;">; </span><span style="font-weight: bold; font-style: italic;">PIC mode</span>
<span style="font-weight: bold;">.text</span>:0000000000000363 __tvm_module_startup endp
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000006" class="outline-5">
<h5 id="org0000006"><span class="section-number-5">1.1.2.2</span> TVMBackendRegisterSystemLibSymbol</h5>
<div class="outline-text-5" id="text-1-1-2-2">
<p>
TVMBackendRegisterSystemLibSymbol 是 tvm runtime 提供的函数
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">TVMBackendRegisterSystemLibSymbol</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">name</span>, <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">ptr</span>) {
  <span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">SystemLibrary</span>::Global()-&gt;RegisterSymbol(name, ptr);
  <span style="font-weight: bold;">return</span> 0;
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">system_library.cc</span>
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">RegisterSymbol</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span>&amp; <span style="font-weight: bold; font-style: italic;">name</span>, <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">ptr</span>) {
    <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">lock_guard</span>&lt;<span style="font-weight: bold; text-decoration: underline;">std</span>::mutex&gt; <span style="font-weight: bold; font-style: italic;">lock</span>(mutex_);
    <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">it</span> = tbl_.find(name);
    <span style="font-weight: bold;">if</span> (it != tbl_.end() &amp;&amp; ptr != it-&gt;second) {
      LOG(WARNING) &lt;&lt; <span style="font-style: italic;">"SystemLib symbol "</span> &lt;&lt; name &lt;&lt; <span style="font-style: italic;">" get overriden to a different address "</span> &lt;&lt; ptr
                   &lt;&lt; <span style="font-style: italic;">"-&gt;"</span> &lt;&lt; it-&gt;second;
    }
    tbl_[name] = ptr;
  }

</pre>
</div>

<p>
SystemLibrary 并是不是一个真正的 `library`: 它的 RegisterSymbol 只是保存了一个
symbol -&gt; function 的 mapping, 但它与 DSOLibrary 一样提供了 GetSymbol 接口:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold;">GetSymbol</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">name</span>) <span style="font-weight: bold;">final</span> {
    <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">lock_guard</span>&lt;<span style="font-weight: bold; text-decoration: underline;">std</span>::mutex&gt; <span style="font-weight: bold; font-style: italic;">lock</span>(mutex_);
    <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">it</span> = tbl_.find(name);
    <span style="font-weight: bold;">if</span> (it != tbl_.end()) {
        <span style="font-weight: bold;">return</span> it-&gt;second;
    } <span style="font-weight: bold;">else</span> {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">nullptr</span>;
    }
}
</pre>
</div>

<p>
有了这个全局的 SystemLibrary 做为 registry, 便不再需要依赖 dso 的 dlsym 了
</p>
</div>
</div>
</div>

<div id="outline-container-org000000d" class="outline-4">
<h4 id="org000000d"><span class="section-number-4">1.1.3</span> C Runtime</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
当 TVM 需要跑在开发板上时，会有几个问题：
</p>

<ol class="org-ol">
<li>板子可能没有支持 ctor 的环境</li>
<li>板子上关于内存分配，log 等功能需要有特定的实现</li>
</ol>

<p>
为此，TVM 以提出一个 c runtime.
</p>

<p>
c runtime 的目标场景是那些无法支持 ctor (即 .init/.init_array) 的环境, 例如不支
持 rtld 或没有 startfiles 的情况 <a href="toolchain/elf.html#org0000023">init_array 如何被调用</a>
</p>

<p>
c runtime 无法利用 ctor 来注册 mapping, 所以它实现了一个函数
`TVMSystemLibEntryPoint`, 这个函数会返回一个包含 {names, functions} 的结构体,用
来初始化 SystemLib
</p>

<p>
C Runtime 会利用 tvm::codegen::CreateMetadataModule 完成与 c++ 的 __tvm_module_startup 类似的功能.
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-ipython">import tvm
from tvm import relay

x = relay.var("x", shape=(1, 1000), dtype="float32")
y = relay.add(x, x)
func = relay.Function([x], y)
mod = tvm.IRModule.from_expr(func)

with tvm.transform.PassContext(opt_level=1):
    mod = relay.build(mod, target="llvm  --system-lib --runtime=c", params=None)

mod.lib.export_library("/tmp/a.tar")

</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">tar zxvf /tmp/a.tar
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"------lib0.o"</span>
readelf -s /tmp/lib0.o
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"------lib1.o"</span>
readelf -s /tmp/lib1.o
</pre>
</div>

<p>
lib0.o
devc.o
lib1.o
-&#x2013;&#x2014;lib0.o
</p>

<p>
Symbol table '.symtab' contains 15 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMetadataMod
     2: 0000000000000008    16 OBJECT  LOCAL  DEFAULT    4 _tvm_crt_func_registry
     3: 0000000000000018     8 OBJECT  LOCAL  DEFAULT    4 _tvm_crt_module
     4: 0000000000000000     8 OBJECT  LOCAL  DEFAULT    4 _tvm_func_registry_ptrs
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
    10: 0000000000000000     0 SECTION LOCAL  DEFAULT    9
    11: 0000000000000000     0 SECTION LOCAL  DEFAULT   16
    12: 0000000000000000     0 SECTION LOCAL  DEFAULT   18
    13: 0000000000000000     8 FUNC    GLOBAL DEFAULT    2 TVMSystemLibEntryPoint
    14: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND tvmgen_default_fused_add
-&#x2013;&#x2014;lib1.o
</p>

<p>
Symbol table '.symtab' contains 11 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000210   284 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_add_
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   16
     9: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    10: 0000000000000000   523 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_add
</p>

<ul class="org-ul">
<li>lib1.o 有 tvmgen_default_fused_add 的实现</li>
<li>lib0.o 中的 TVMSystemLibEntryPoint 是用来返回 {"names",funcs} 的数据的</li>
</ul>


<div id="org000000c" class="figure">
<p><img src="../extra/tvm_c_runtime_reg.png" alt="tvm_c_runtime_reg.png" />
</p>
</div>

<p>
图中的 unk_28 实际上就是指向 .rodata 上的字符串 "tvmgen_default_fused_add", 所以
lib0.o 中的 TVMSystemLibEntryPoint 最终会返回
</p>

<p>
{"tvmgen_default_fused_add", tvmgen_default_fused_add}
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">crt_runtime_api.c</span>
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">SystemLibraryCreate</span>(<span style="font-weight: bold; text-decoration: underline;">TVMValue</span>* <span style="font-weight: bold; font-style: italic;">args</span>, <span style="font-weight: bold; text-decoration: underline;">int</span>* <span style="font-weight: bold; font-style: italic;">type_codes</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">num_args</span>, <span style="font-weight: bold; text-decoration: underline;">TVMValue</span>* <span style="font-weight: bold; font-style: italic;">ret_val</span>,
                        <span style="font-weight: bold; text-decoration: underline;">int</span>* <span style="font-weight: bold; font-style: italic;">ret_type_codes</span>) {

  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">TVMModule</span>* <span style="font-weight: bold; font-style: italic;">system_lib</span>;
  system_lib = TVMSystemLibEntryPoint();
  TVMModCreateFromCModule(system_lib, &amp;system_lib_handle);

  ret_val[0].v_handle = system_lib_handle;
  ret_type_codes[0] = kTVMModuleHandle;
  <span style="font-weight: bold;">return</span> 0;
}

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000001c" class="outline-3">
<h3 id="org000001c"><span class="section-number-3">1.2</span> Static Deploy</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0000013" class="outline-4">
<h4 id="org0000013"><span class="section-number-4">1.2.1</span> C++ Runtime</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
<a href="file:///home/sunway/Gitbox/code/hello_world/hello_tvm/cpp_runtime">file:~/Gitbox/code/hello_world/hello_tvm/cpp_runtime</a>
</p>
</div>
</div>

<div id="outline-container-org0000016" class="outline-4">
<h4 id="org0000016"><span class="section-number-4">1.2.2</span> C Runtime</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
<a href="file:///home/sunway/Gitbox/code/hello_world/hello_tvm/c_runtime">file:~/Gitbox/code/hello_world/hello_tvm/c_runtime</a>
</p>
</div>
</div>

<div id="outline-container-org0000019" class="outline-4">
<h4 id="org0000019"><span class="section-number-4">1.2.3</span> 交叉编译</h4>
<div class="outline-text-4" id="text-1-2-3">
<ol class="org-ol">
<li><p>
在 target 中使用 mtriple, mcpu 指定, 由 llvm 负责交叉编译.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">mod</span> = relay.build(
    mod,
    target=<span style="font-style: italic;">"llvm  --system-lib --runtime=c, -mtriple=armv8l-linux-gnueabihf -mcpu=cortex-m7"</span>,
    params=<span style="font-weight: bold; text-decoration: underline;">None</span>,
)
</pre>
</div></li>

<li><p>
使用 c target, 生成 c 代码后自己做交叉编译
</p>

<p>
但看起来 c target 没有生成向量化的代码
</p></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org0000047" class="outline-3">
<h3 id="org0000047"><span class="section-number-3">1.3</span> Micro TVM</h3>
<div class="outline-text-3" id="text-1-3">
<p>
使用 c_runtime + system_lib, 已经可以编译出一个静态链接的可以在 mcu 上运行的实例
了, 实际上 tvm.target.target.micro("stm32f746xx") 返回的 target 字符串基本上为:
"c -system-lib -runtime=c -mcpu=cortex-m7"
</p>

<p>
更多 Micro TVM 相关的内容和 RPC 有关, 即 host 的 python 代码可以像本地模型一样用
graph_runner 运行 mcu 上的实例.
<a href="https://tvm.apache.org/docs/tutorials/micro/micro_tflite.html?highlight=microtvm">https://tvm.apache.org/docs/tutorials/micro/micro_tflite.html?highlight=microtvm</a>
</p>

<p>
<del>具体的</del>
</p>

<ol class="org-ol">
<li><del>用户需要自己提供一个 tvm.micro.Compiler 的实现, 用来把 tvm 编译生成的 c 代码</del>
<del>编译成最终在 mcu 上执行的 bin. 因为 Micro TVM 期望用户自己实现 Compiler 来生</del>
<del>成最终的 bin, 所以 tvm.target.target.micro 使用的 target 是 "c", 而不是</del>
<del>"llvm"</del></li>

<li><del>用户需要自己提供一个 tvm.micro.Flasher, 同时需要自己提供一个</del>
<del>tvm.micro.Transport. 在 host 上用 Flasher 把 bin flash 到 mcu 上, 用</del>
<del>Transport控制 mcu 的执行并拿到结果. host 端的 Transport 需要与 mcu 上的</del>
<del>MicroRPCServer进行通信, 并在通信的基础上封装成一个 RPC 服务, 以便 host 以通过</del>
<del>RPC 直接在mcu 上执行代码.</del></li>
</ol>

<p>
新的 TVM 代码把 Compiler, Flasher, Transport 功能重写了 Project API, 功能与之前的类似
<a href="file:///home/sunway/source/tvm/python/tvm/micro/project.py">file:~/source/tvm/python/tvm/micro/project.py</a>
</p>

<p>
<a href="https://tvm.apache.org/docs/dev/microtvm_design.html?highlight=microtvm%20design">https://tvm.apache.org/docs/dev/microtvm_design.html?highlight=microtvm%20design</a>
</p>
</div>

<div id="outline-container-org0000028" class="outline-4">
<h4 id="org0000028"><span class="section-number-4">1.3.1</span> Project API</h4>
<div class="outline-text-4" id="text-1-3-1">
</div>
<div id="outline-container-org000001f" class="outline-5">
<h5 id="org000001f"><span class="section-number-5">1.3.1.1</span> Overview</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<p>
Project API 要求每个板子提供一个 template_project_dir, 例如:
</p>

<p>
tvm/build/standalone_crt/template/host
tvm/apps/microtvm/zephyr/template_project
</p>

<p>
每个 template dir 都需要有一个 microtvm_api_server.py, 这个模块以 popen+pipe 的
形式对外提供 build, flash, transport 等功能. 另外, build 时编译出来的 bin 需要在
代码中调用 MicroTVMRpcServerLoop 以启动 microtvm RPC server
</p>

<p>
有了这个抽象的 project, TVM 可以:
</p>

<ol class="org-ol">
<li>用 host-driven 的方式在板子上执行 MicroTVM model</li>
<li>使 MicroTVM 支持 AutoTVM</li>
</ol>
</div>
</div>

<div id="outline-container-org0000022" class="outline-5">
<h5 id="org0000022"><span class="section-number-5">1.3.1.2</span> Example</h5>
<div class="outline-text-5" id="text-1-3-1-2">
<p>
<a href="file:///home/sunway/source/tvm/gallery/how_to/work_with_microtvm/micro_autotune.py">file:~/source/tvm/gallery/how_to/work_with_microtvm/micro_autotune.py</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> relay

<span style="font-weight: bold;">import</span> tempfile


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_model</span>():
    <span style="font-weight: bold; font-style: italic;">x</span> = relay.var(<span style="font-style: italic;">"x"</span>, relay.TensorType([1, 10], <span style="font-style: italic;">"float32"</span>))
    <span style="font-weight: bold; font-style: italic;">y</span> = relay.add(x, x)
    <span style="font-weight: bold; font-style: italic;">f</span> = relay.Function([x], y)

    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = tvm.IRModule.from_expr(f)
    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = relay.transform.InferType()(relay_mod)
    <span style="font-weight: bold;">return</span> relay_mod


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">run_model</span>():
    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = get_model()
    <span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=3, config={<span style="font-style: italic;">"tir.disable_vectorize"</span>: <span style="font-weight: bold; text-decoration: underline;">True</span>}):
        <span style="font-weight: bold; font-style: italic;">model</span> = relay.build(
            relay_mod, target=tvm.target.target.micro(<span style="font-style: italic;">"host"</span>), params=<span style="font-weight: bold; text-decoration: underline;">None</span>
        )

    <span style="font-weight: bold; font-style: italic;">project</span> = tvm.micro.generate_project(
        <span style="font-style: italic;">"/home/sunway/source/tvm/build/standalone_crt/template/host"</span>,
        model,
        tempfile.TemporaryDirectory().name,
    )

    project.build()
    project.flash()

    <span style="font-weight: bold;">with</span> tvm.micro.Session(project.transport()) <span style="font-weight: bold;">as</span> session:
        <span style="font-weight: bold; font-style: italic;">debug_module</span> = tvm.micro.create_local_debug_executor(
            model.get_graph_json(), session.get_system_lib(), session.device
        )
        debug_module.set_input(<span style="font-style: italic;">"x"</span>, np.ones((1, 10)))
        debug_module.run()
        <span style="font-weight: bold;">print</span>(debug_module.get_output(0))


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Project API &#21487;&#20197;&#29992;&#26469;&#22312; pc &#19978;&#36828;&#31243;&#22312;&#26495;&#23376;&#19978;&#25191;&#34892; model</span>
    run_model()
</pre>
</div>

<p>
Node Name                 Ops                       Time(us)  Time(%)  Shape    Inputs  Outputs  
----&#x2013;&#x2014;                 &#x2014;                       ---&#x2013;&#x2014;  --&#x2013;&#x2014;  &#x2013;&#x2014;    -&#x2013;&#x2014;  --&#x2013;&#x2014;  
tvmgen_default_fused_add  tvmgen_default_fused_add  0.0       100.0    (1, 10)  1       1        
Total_time                -                         0.0       -        -        -       -        

</p>
</div>
</div>

<div id="outline-container-org0000025" class="outline-5">
<h5 id="org0000025"><span class="section-number-5">1.3.1.3</span> Impl</h5>
<div class="outline-text-5" id="text-1-3-1-3">
<p>
Project API 对外提供的主要接口是 generate_project, host-driven 时会直接调用该接
口, AutoTVM 使用的 AutoTvmModuleLoader 也需要调用该接口
</p>

<ol class="org-ol">
<li><p>
使用 popen 方式启动 template_project_dir 中的 microtvm_api_server.py 做为 client
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_project</span>(
    template_project_dir: Union[pathlib.Path, <span style="font-weight: bold;">str</span>],
    module: ExportableModule,
    generated_project_dir: Union[pathlib.Path, <span style="font-weight: bold;">str</span>],
    options: <span style="font-weight: bold;">dict</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>,
):
    <span style="font-weight: bold; font-style: italic;">template</span> = TemplateProject.from_directory(<span style="font-weight: bold;">str</span>(template_project_dir))
    <span style="font-weight: bold;">return</span> template.generate_project(module, <span style="font-weight: bold;">str</span>(generated_project_dir), options)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TemplateProject</span>:
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">from_directory</span>(cls, template_project_dir):
        <span style="font-weight: bold;">return</span> cls(client.instantiate_from_dir(template_project_dir))

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22312; template_project_dir &#26159;&#26597;&#25214; microtvm_api_server.py &#25110;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">launch_microtvm_api_server.sh&#29992; popen &#21551;&#21160;&#19968;&#20010;&#23376;&#36827;&#31243;&#25191;&#34892;&#36825;&#20010; script, &#36825;&#20010;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">script &#20250;&#22312;&#19968;&#20010; while loop &#20013;&#31561;&#24453;&#21518;&#32493;&#21629;&#20196;, &#27604;&#22914; generate_project</span>

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">instantiate_from_dir</span>(project_dir: typing.Union[pathlib.Path, <span style="font-weight: bold;">str</span>], debug: <span style="font-weight: bold;">bool</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>):
    <span style="font-weight: bold; font-style: italic;">args</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>
    <span style="font-weight: bold; font-style: italic;">project_dir</span> = pathlib.Path(project_dir)

    <span style="font-weight: bold; font-style: italic;">python_script</span> = project_dir / SERVER_PYTHON_FILENAME
    <span style="font-weight: bold;">if</span> python_script.is_file():
        <span style="font-weight: bold; font-style: italic;">args</span> = [sys.executable, <span style="font-weight: bold;">str</span>(python_script)]

    <span style="font-weight: bold; font-style: italic;">launch_script</span> = project_dir / SERVER_LAUNCH_SCRIPT_FILENAME
    <span style="font-weight: bold;">if</span> launch_script.is_file():
        <span style="font-weight: bold; font-style: italic;">args</span> = [<span style="font-weight: bold;">str</span>(launch_script)]

    <span style="font-weight: bold; font-style: italic;">api_server_read_fd</span>, <span style="font-weight: bold; font-style: italic;">tvm_write_fd</span> = os.pipe()
    <span style="font-weight: bold; font-style: italic;">tvm_read_fd</span>, <span style="font-weight: bold; font-style: italic;">api_server_write_fd</span> = os.pipe()

    args.extend([<span style="font-style: italic;">"--read-fd"</span>, <span style="font-weight: bold;">str</span>(api_server_read_fd), <span style="font-style: italic;">"--write-fd"</span>, <span style="font-weight: bold;">str</span>(api_server_write_fd)])
    <span style="font-weight: bold; font-style: italic;">api_server_proc</span> = subprocess.Popen(  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">pylint: disable=unused-variable</span>
        args, bufsize=0, pass_fds=(api_server_read_fd, api_server_write_fd), cwd=project_dir
    )
    os.close(api_server_read_fd)
    os.close(api_server_write_fd)

    <span style="font-weight: bold;">return</span> ProjectAPIClient(
        os.fdopen(tvm_read_fd, <span style="font-style: italic;">"rb"</span>, buffering=0), os.fdopen(tvm_write_fd, <span style="font-style: italic;">"wb"</span>, buffering=0)
    )

</pre>
</div></li>

<li><p>
通过调用 client 的 generate_project 生成新的 GeneratedProject 目录
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20808; export_model_library, &#28982;&#21518;&#35843;&#29992; client &#30340; generate_project</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_project</span>(<span style="font-weight: bold;">self</span>, graph_executor_factory, project_dir, options):
    <span style="font-weight: bold; font-style: italic;">model_library_dir</span> = utils.tempdir()
    <span style="font-weight: bold; font-style: italic;">model_library_format_path</span> = model_library_dir.relpath(<span style="font-style: italic;">"model.tar"</span>)
    export_model_library_format(graph_executor_factory, model_library_format_path)

    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.generate_project_from_mlf(model_library_format_path, project_dir, options)


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_project_from_mlf</span>(<span style="font-weight: bold;">self</span>, model_library_format_path, project_dir, options):
    <span style="font-weight: bold;">self</span>._api_client.generate_project(
        model_library_format_path=<span style="font-weight: bold;">str</span>(model_library_format_path),
        standalone_crt_dir=get_standalone_crt_dir(),
        project_dir=project_dir,
        options=options,
    )
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">_api_client &#30340; generate_project (&#20197; host &#30340; microtvm_api_server.py &#20026;&#20363;), &#23454;&#38469;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23601;&#26159;&#22797;&#21046;&#20102;&#19968;&#22534;&#25991;&#20214;&#21040; GeneratedProject &#30446;&#24405;</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_project</span>(<span style="font-weight: bold;">self</span>, model_library_format_path, standalone_crt_dir, project_dir, options):
    shutil.copy2(__file__, project_dir / os.path.basename(__file__))

    <span style="font-weight: bold; font-style: italic;">project_model_library_format_path</span> = project_dir / MODEL_LIBRARY_FORMAT_RELPATH
    shutil.copy2(model_library_format_path, project_model_library_format_path)

    <span style="font-weight: bold; font-style: italic;">extract_path</span> = project_dir / project_model_library_format_path.stem
    <span style="font-weight: bold;">with</span> tarfile.TarFile(project_model_library_format_path) <span style="font-weight: bold;">as</span> tf:
        os.makedirs(extract_path)
        tf.extractall(path=extract_path)

    <span style="font-weight: bold; font-style: italic;">crt_path</span> = project_dir / <span style="font-style: italic;">"crt"</span>
    os.mkdir(crt_path)
    <span style="font-weight: bold;">for</span> item <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">self</span>.CRT_COPY_ITEMS:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Populate Makefile.</span>
    shutil.copy2(pathlib.Path(__file__).parent / <span style="font-style: italic;">"Makefile"</span>, project_dir / <span style="font-style: italic;">"Makefile"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Populate crt-config.h</span>
    <span style="font-weight: bold; font-style: italic;">crt_config_dir</span> = project_dir / <span style="font-style: italic;">"crt_config"</span>
    crt_config_dir.mkdir()
    shutil.copy2(
        os.path.join(os.path.dirname(__file__), <span style="font-style: italic;">".."</span>, <span style="font-style: italic;">"crt_config-template.h"</span>),
        os.path.join(crt_config_dir, <span style="font-style: italic;">"crt_config.h"</span>),
    )

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Populate src/</span>
    <span style="font-weight: bold; font-style: italic;">src_dir</span> = os.path.join(project_dir, <span style="font-style: italic;">"src"</span>)
    os.mkdir(src_dir)
    shutil.copy2(
        os.path.join(os.path.dirname(__file__), <span style="font-style: italic;">"main.cc"</span>), os.path.join(src_dir, <span style="font-style: italic;">"main.cc"</span>)
    )

</pre>
</div></li>

<li><p>
generate_project 完成后使用 GeneratedProject 目录中的 microtvm_api_server.py 做为新的 client
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_project_from_mlf</span>(<span style="font-weight: bold;">self</span>, model_library_format_path, project_dir, options):
    <span style="font-weight: bold;">self</span>._api_client.generate_project(
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
    )

    <span style="font-weight: bold;">return</span> GeneratedProject.from_directory(project_dir, options)
</pre>
</div></li>

<li>可以通过最后获得的 project 完成 build, flash, transport 等功能</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org0000044" class="outline-4">
<h4 id="org0000044"><span class="section-number-4">1.3.2</span> RPC</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
RPC 的结构为:
</p>

<pre class="example" id="org000002b">
                                         |
Session (Flasher/Transport) [python]     |
   -&gt; RPCSession [c++]                   |
     -&gt; MicroTransportChannel [c++]      -&gt;   MicroTVMRpcServerLoop
                                         |        -&gt; Session
                                         |           -&gt; MinRPCServer
                                         |               -&gt; HandleNormalCallFunc, ...
                                         |
</pre>
</div>

<div id="outline-container-org0000041" class="outline-5">
<h5 id="org0000041"><span class="section-number-5">1.3.2.1</span> RPC Impl</h5>
<div class="outline-text-5" id="text-1-3-2-1">
</div>
<div id="outline-container-org0000032" class="outline-6">
<h6 id="org0000032"><span class="section-number-6">1.3.2.1.1</span> Client</h6>
<div class="outline-text-6" id="text-1-3-2-1-1">
</div>
<ol class="org-ol">
<li><a id="org000002c"></a>初始化 session<br />
<div class="outline-text-7" id="text-1-3-2-1-1-1">
<div class="org-src-container">
<pre class="src src-python">tvm.micro.Session(binary=micro_binary, flasher=flasher)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">Session</span>.__enter__(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">self</span>.transport_context_manager = <span style="font-weight: bold;">self</span>.flasher.flash(<span style="font-weight: bold;">self</span>.binary)

        <span style="font-weight: bold;">self</span>.transport = TransportLogger(
            <span style="font-weight: bold;">self</span>.session_name, <span style="font-weight: bold;">self</span>.transport_context_manager, level=logging.DEBUG
        ).__enter__()

        <span style="font-weight: bold;">self</span>._rpc = RPCSession(
            _rpc_connect(
                <span style="font-weight: bold;">self</span>.session_name,
                <span style="font-weight: bold;">self</span>._wrap_transport_write,
                <span style="font-weight: bold;">self</span>._wrap_transport_read,
                <span style="font-weight: bold;">int</span>(timeouts.session_start_retry_timeout_sec * 1e6),
                <span style="font-weight: bold;">int</span>(timeouts.session_start_timeout_sec * 1e6),
                <span style="font-weight: bold;">int</span>(timeouts.session_established_timeout_sec * 1e6),
            )
        )

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20854;&#20013; _wrap_transport_write, _wrap_transport_read &#26159;&#23545; transport &#30340;&#31616;&#21333;&#23553;&#35013;</span>

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_wrap_transport_read</span>(<span style="font-weight: bold;">self</span>, n, timeout_microsec):
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.transport.read(
        n, <span style="font-weight: bold;">float</span>(timeout_microsec) / 1e6 <span style="font-weight: bold;">if</span> timeout_microsec <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span> <span style="font-weight: bold;">else</span> <span style="font-weight: bold; text-decoration: underline;">None</span>
    )    


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_wrap_transport_write</span>(<span style="font-weight: bold;">self</span>, data, timeout_microsec):
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.transport.write(
        data, <span style="font-weight: bold;">float</span>(timeout_microsec) / 1e6 <span style="font-weight: bold;">if</span> timeout_microsec <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span> <span style="font-weight: bold;">else</span> <span style="font-weight: bold; text-decoration: underline;">None</span>
    )    


TVM_REGISTER_GLOBAL(<span style="font-style: italic;">"micro._rpc_connect"</span>).set_body([](TVMArgs args, TVMRetValue* rv) {
  MicroTransportChannel* micro_channel =
      new MicroTransportChannel(args[1], args[2], ::std::chrono::microseconds(uint64_t(args[3])),
                                ::std::chrono::microseconds(uint64_t(args[4])),
                                ::std::chrono::microseconds(uint64_t(args[5])));
  std::unique_ptr&lt;RPCChannel&gt; channel(micro_channel);
  auto ep = RPCEndpoint::Create(std::move(channel), args[0], <span style="font-style: italic;">""</span>);
  auto sess = CreateClientSession(ep);
  *rv = CreateRPCSessionModule(sess);
});
</pre>
</div>
</div>
</li>

<li><a id="org000002f"></a>调用 session.get_system_lib<br />
<div class="outline-text-7" id="text-1-3-2-1-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">session</span>.get_system_lib(<span style="font-weight: bold;">self</span>):
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>._rpc.get_function(<span style="font-style: italic;">"runtime.SystemLib"</span>)()

PackedFunc RPCModuleNode::GetFunction(const std::string&amp; name, const ObjectPtr&lt;Object&gt;&amp; sptr_to_self) final {
    <span style="font-weight: bold;">return</span> WrapRemoteFunc(sess_-&gt;GetFunction(name));                                          
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20889;&#20837;&#21040; stream &#30340; RPCCode &#20026; kGetGlobalFunc</span>
PackedFuncHandle RPCClientSession::GetFunction(const std::string&amp; name) final {
    <span style="font-weight: bold;">return</span> endpoint_-&gt;SysCallRemote(RPCCode::kGetGlobalFunc, name);
}

<span style="font-weight: bold; font-style: italic;">syscall_remote_</span> = PackedFunc([this](TVMArgs all_args, TVMRetValue* rv) {
    RPCCode code = static_cast&lt;RPCCode&gt;(all_args[0].operator <span style="font-weight: bold;">int</span>());
    TVMArgs args(all_args.values + 1, all_args.type_codes + 1, all_args.num_args - 1);

    uint64_t packet_nbytes = sizeof(code) + handler_-&gt;PackedSeqGetNumBytes(
                                                args.values, args.type_codes, args.num_args, true);

    // All packet begins <span style="font-weight: bold;">with</span> packet nbytes
    handler_-&gt;Write(packet_nbytes);
    handler_-&gt;Write(code);
    handler_-&gt;SendPackedSeq(args.values, args.type_codes, args.num_args, true);

    code = HandleUntilReturnEvent(true, [rv](TVMArgs args) {
      ICHECK_EQ(args.size(), 1);
      *rv = args[0];
    });
    ICHECK(code == RPCCode::kReturn) &lt;&lt; <span style="font-style: italic;">"code="</span> &lt;&lt; static_cast&lt;<span style="font-weight: bold;">int</span>&gt;(code);
  });

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">handler &#26159; EventHandler &#23454;&#20363;</span>
void RPCEndpoint::Init() {
  // ...
  handler_ = std::make_shared&lt;EventHandler&gt;(&amp;reader_, &amp;writer_, name_, &amp;remote_key_, flush_writer);
  // ...
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RPCEndpoint</span>::EventHandler : public dmlc::Stream {
 public:
  EventHandler(support::RingBuffer* reader, support::RingBuffer* writer, std::string name,
               std::string* remote_key, std::function&lt;void()&gt; flush_writer)
      : reader_(reader),
        writer_(writer),
        name_(name),
        remote_key_(remote_key),
        flush_writer_(flush_writer) {}

void EventHandler::Write(const void* data, size_t size) final { writer_-&gt;Write(data, size); }        

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26368;&#32456;&#22312; stream &#37324;&#20889;&#20102;&#19968;&#20010; "{kGetGlobalFunc}runtime.SystemLib..."</span>

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org000003b" class="outline-6">
<h6 id="org000003b"><span class="section-number-6">1.3.2.1.2</span> Server</h6>
<div class="outline-text-6" id="text-1-3-2-1-2">
<p>
server 端 (mcu 端) 需要应用自己启动 loop, 从transport (例如 serial port) 获得数
据后交给 MicroRPCServer 处理
</p>
</div>

<ol class="org-ol">
<li><a id="org0000035"></a>初始化 rpc_server<br />
<div class="outline-text-7" id="text-1-3-2-1-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">writer_func &#26159;&#29992;&#25143;&#33258;&#24049;&#25552;&#20379;&#30340; function, &#29992;&#26469;&#25226; rpc_server &#38656;&#35201;&#36820;&#22238;&#30340;&#25968;&#25454;&#36890;&#36807;&#36825;</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#20010; function &#20889;&#21040; transport &#19978;</span>
rpc_server = MicroTVMRpcServerInit(&amp;writer_func, <span style="font-weight: bold; text-decoration: underline;">nullptr</span>);
<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">micro_rpc</span>::g_write_func = write_func;

<span style="font-weight: bold; text-decoration: underline;">tvm_crt_error_t</span> <span style="font-weight: bold; font-style: italic;">err</span> = TVMInitializeRuntime();
TVMPlatformMemoryAllocate(
    TVM_CRT_MAX_PACKET_SIZE_BYTES, dev, &amp;receive_buffer_memory);
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
rpc_server-&gt;Initialize();

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">MicroRPCServer &#21021;&#22987;&#21270;&#26102;&#35760;&#24405;&#20102;&#19968;&#20010; unframer_ &#19982; session_ &#32465;&#23450;, &#21518;&#32493;&#29992;&#25143;&#38656;&#35201;&#36890;</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#36807; MicroTVMRpcServerLoop &#25163;&#21160;&#32473; unframer_ &#21890;&#25968;&#25454;, session_ &#25343;&#21040;&#35299;&#26512;&#25968;&#25454;&#21518;&#20250;&#35843;</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#29992; HandleCompleteMessageCb</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21478;&#19968;&#26041;&#38754;, &#19982; framer_ &#32465;&#23450;&#30340; send_stream_ &#20250;&#29992;&#21040; writer_func (&#36890;&#36807;&#19968;&#20010;&#20840;&#23616;&#21464;&#37327;)</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25226;&#20135;&#29983;&#30340;&#25968;&#25454;&#20889;&#22238;&#21040; transport &#19978;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MicroRPCServer</span> {
   <span style="font-weight: bold;">public</span>:
    <span style="font-weight: bold;">MicroRPCServer</span>(
        <span style="font-weight: bold; text-decoration: underline;">uint8_t</span>* <span style="font-weight: bold; font-style: italic;">receive_storage</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">receive_storage_size_bytes</span>,
        <span style="font-weight: bold; text-decoration: underline;">microtvm_rpc_channel_write_t</span> <span style="font-weight: bold; font-style: italic;">write_func</span>, <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">write_func_ctx</span>)
        : receive_buffer_{receive_storage, receive_storage_size_bytes},
          framer_{&amp;send_stream_},
          session_{&amp;framer_, &amp;receive_buffer_, &amp;HandleCompleteMessageCb, <span style="font-weight: bold;">this</span>},
          io_{&amp;session_, &amp;receive_buffer_},
          unframer_{session_.Receiver()},
          rpc_server_{&amp;io_},
          is_running_{<span style="font-weight: bold; text-decoration: underline;">true</span>} {}

    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">Initialize</span>() {
        <span style="font-weight: bold; text-decoration: underline;">uint8_t</span> <span style="font-weight: bold; font-style: italic;">initial_session_nonce</span> = <span style="font-weight: bold; text-decoration: underline;">Session</span>::kInvalidNonce;
        session_.Initialize(initial_session_nonce);
    }
</pre>
</div>
</div>
</li>

<li><a id="org0000038"></a>rpc_server loop<br />
<div class="outline-text-7" id="text-1-3-2-1-2-2">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">tvm_crt_error_t</span> <span style="font-weight: bold;">MicroTVMRpcServerLoop</span>(<span style="font-weight: bold; text-decoration: underline;">microtvm_rpc_server_t</span> <span style="font-weight: bold; font-style: italic;">server_ptr</span>, <span style="font-weight: bold; text-decoration: underline;">uint8_t</span>** <span style="font-weight: bold; font-style: italic;">new_data</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span>* <span style="font-weight: bold; font-style: italic;">new_data_size_bytes</span>):
  server-&gt;Loop(new_data, new_data_size_bytes);

<span style="font-weight: bold; text-decoration: underline;">tvm_crt_error_t</span> <span style="font-weight: bold;">Loop</span>(<span style="font-weight: bold; text-decoration: underline;">uint8_t</span>** <span style="font-weight: bold; font-style: italic;">new_data</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span>* <span style="font-weight: bold; font-style: italic;">new_data_size_bytes</span>): 
  err = unframer_.Write(*new_data, *new_data_size_bytes, &amp;bytes_consumed);

<span style="font-weight: bold; text-decoration: underline;">tvm_crt_error_t</span> <span style="font-weight: bold; text-decoration: underline;">Unframer</span>::<span style="font-weight: bold;">Write</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">uint8_t</span>* <span style="font-weight: bold; font-style: italic;">data</span>, <span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">data_size_bytes</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span>* <span style="font-weight: bold; font-style: italic;">bytes_consumed</span>):
    <span style="font-weight: bold;">switch</span> (state_) {
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
      <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">State</span>::kFindCrcEnd:
        return_code = FindCrcEnd();
          stream_-&gt;PacketDone(crc_ == *<span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">uint16_t</span>*&gt;(buffer_));
            <span style="font-weight: bold;">switch</span> (header.message_type) {
              <span style="font-weight: bold;">default</span>:
                session_-&gt;message_received_func_(session_-&gt;message_received_func_context_,
                                         header.message_type, session_-&gt;receive_buffer_);

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">message_received_func_ &#21363; session &#21021;&#22987;&#21270;&#26102;&#30340; HandleCompleteMessageCb</span>

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MicroRPCServer</span>::<span style="font-weight: bold; font-style: italic;">HandleCompleteMessage</span>(MessageType message_type, FrameBuffer* buf) {
  rpc_server_.ProcessOnePacket();
    <span style="font-weight: bold;">this</span>-&gt;Read(&amp;packet_len);
    <span style="font-weight: bold;">this</span>-&gt;Read(&amp;code);

    <span style="font-weight: bold;">if</span> (code &gt;= <span style="font-weight: bold; text-decoration: underline;">RPCCode</span>::kSyscallCodeStart) {
      <span style="font-weight: bold;">this</span>-&gt;HandleSyscallFunc(code);
    } <span style="font-weight: bold;">else</span> {
      <span style="font-weight: bold;">switch</span> (code) {
        <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">RPCCode</span>::kCallFunc: {
          HandleNormalCallFunc();
            TVMFuncCall(<span style="font-weight: bold;">reinterpret_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">void</span>*&gt;(call_handle), values, tcodes, num_args, &amp;(ret_value[1]), &amp;(ret_tcode[1]));

          <span style="font-weight: bold;">break</span>;
        }
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org000003e" class="outline-6">
<h6 id="org000003e"><span class="section-number-6">1.3.2.1.3</span> To summarize</h6>
<div class="outline-text-6" id="text-1-3-2-1-3">
<p>
为了实现基于串口的 RPC, TVM 已经实现了大部分功能, 剩余需要自己实现的包括:
</p>

<ol class="org-ol">
<li><p>
client (python) 端需要实现一个串口的 tranport, 通过 Flasher 返回
</p>

<p>
<a href="file:///home/sunway/source/tvm/python/tvm/micro/contrib/zephyr.py">file:~/source/tvm/python/tvm/micro/contrib/zephyr.py</a>
</p></li>

<li><p>
server (mcu) 端需要:
</p>

<p>
<a href="file:///home/sunway/source/tvm/apps/microtvm/zephyr/host_driven/src/main.c">file:~/source/tvm/apps/microtvm/zephyr/host_driven/src/main.c</a>
</p>

<ol class="org-ol">
<li>实现一个写串口数据的 writer_func, 在 MicroTVMRpcServerInit 时注册上去</li>

<li>自己从串口读数据, 然后调用 MicroTVMRpcServerLoop</li>
</ol></li>
</ol>

<p>
Project API 的 host template 实现了一个基于 popen+pipe 的 RPC 的 demo:
<a href="file:///home/sunway/source/tvm/build/standalone_crt/template/host/main.cc">file:~/source/tvm/build/standalone_crt/template/host/main.cc</a>
</p>

<p>
Project API 的 zephyr template 实现了一个基于 uart 的 RPC 的 demo:
<a href="file:///home/sunway/source/tvm/apps/microtvm/zephyr/template_project/src/host_driven/main.c">file:~/source/tvm/apps/microtvm/zephyr/template_project/src/host_driven/main.c</a>
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000001" class="outline-3">
<h3 id="org0000001"><span class="section-number-3">1.4</span> MicroTVM 与 AutoTVM</h3>
<div class="outline-text-3" id="text-1-4">
<p>
MicroTVM 通过 Proejct API 和 MicroTVM RPC 支持 AutoTVM
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> relay

<span style="font-weight: bold;">import</span> tempfile


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_model</span>():
    <span style="font-weight: bold; font-style: italic;">x</span> = relay.var(<span style="font-style: italic;">"x"</span>, relay.TensorType([1, 10], <span style="font-style: italic;">"float32"</span>))
    <span style="font-weight: bold; font-style: italic;">y</span> = relay.add(x, x)
    <span style="font-weight: bold; font-style: italic;">f</span> = relay.Function([x], y)

    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = tvm.IRModule.from_expr(f)
    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = relay.transform.InferType()(relay_mod)
    <span style="font-weight: bold;">return</span> relay_mod


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">tune</span>():
    <span style="font-weight: bold; font-style: italic;">relay_mod</span> = get_model()
    <span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=3, config={<span style="font-style: italic;">"tir.disable_vectorize"</span>: <span style="font-weight: bold; text-decoration: underline;">True</span>}):
        <span style="font-weight: bold; font-style: italic;">tasks</span> = tvm.autotvm.task.extract_from_program(
            relay_mod[<span style="font-style: italic;">"main"</span>], {}, tvm.target.target.micro(<span style="font-style: italic;">"host"</span>)
        )

    <span style="font-weight: bold; font-style: italic;">module_loader</span> = tvm.micro.AutoTvmModuleLoader(
        template_project_dir=<span style="font-style: italic;">"~/source/tvm/build/standalone_crt/template/host"</span>,
        project_options={<span style="font-style: italic;">"verbose"</span>: <span style="font-weight: bold; text-decoration: underline;">False</span>},
    )
    <span style="font-weight: bold; font-style: italic;">runner</span> = tvm.autotvm.LocalRunner(
        number=1, repeat=1, timeout=100, module_loader=module_loader
    )

    <span style="font-weight: bold; font-style: italic;">builder</span> = tvm.autotvm.LocalBuilder(
        n_parallel=1,
        build_kwargs={<span style="font-style: italic;">"build_option"</span>: {<span style="font-style: italic;">"tir.disable_vectorize"</span>: <span style="font-weight: bold; text-decoration: underline;">True</span>}},
        build_func=tvm.micro.autotvm_build_func,
    )

    <span style="font-weight: bold;">for</span> task <span style="font-weight: bold;">in</span> tasks:
        <span style="font-weight: bold; font-style: italic;">tuner</span> = tvm.autotvm.tuner.GATuner(task)
        tuner.tune(
            n_trial=1,
            measure_option=tvm.autotvm.measure_option(builder=builder, runner=runner),
        )


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Project API &#20063;&#21487;&#20197;&#29992;&#26469;&#20570; autotvm</span>
    tune()

</pre>
</div>
</div>

<div id="outline-container-org000004a" class="outline-4">
<h4 id="org000004a"><span class="section-number-4">1.4.1</span> Impl</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AutoTvmModuleLoader</span>:
    <span style="font-weight: bold; text-decoration: underline;">@contextlib.contextmanager</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__call__</span>(<span style="font-weight: bold;">self</span>, remote_kw, build_result):
        <span style="font-weight: bold;">with</span> <span style="font-weight: bold;">open</span>(build_result.filename, <span style="font-style: italic;">"rb"</span>) <span style="font-weight: bold;">as</span> build_file:
            <span style="font-weight: bold; font-style: italic;">build_result_bin</span> = build_file.read()

        <span style="font-weight: bold; font-style: italic;">tracker</span> = _rpc.connect_tracker(remote_kw[<span style="font-style: italic;">"host"</span>], remote_kw[<span style="font-style: italic;">"port"</span>])
        <span style="font-weight: bold; font-style: italic;">remote</span> = tracker.request(
            remote_kw[<span style="font-style: italic;">"device_key"</span>],
            priority=remote_kw[<span style="font-style: italic;">"priority"</span>],
            session_timeout=remote_kw[<span style="font-style: italic;">"timeout"</span>],
            session_constructor_args=[
                <span style="font-style: italic;">"tvm.micro.compile_and_create_micro_session"</span>,
                build_result_bin,
                <span style="font-weight: bold;">self</span>._template_project_dir,
                json.dumps(<span style="font-weight: bold;">self</span>._project_options),
            ],
        )
        <span style="font-weight: bold; font-style: italic;">system_lib</span> = remote.get_function(<span style="font-style: italic;">"runtime.SystemLib"</span>)()
        <span style="font-weight: bold;">yield</span> remote, system_lib


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">compile_and_create_micro_session</span>(
    mod_src_bytes: <span style="font-weight: bold;">bytes</span>,
    template_project_dir: <span style="font-weight: bold;">str</span>,
    project_options: <span style="font-weight: bold;">dict</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>,
):
    <span style="font-weight: bold; font-style: italic;">temp_dir</span> = utils.tempdir()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Keep temp directory for generate project</span>
    temp_dir.set_keep_for_debug(<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">model_library_format_path</span> = temp_dir / <span style="font-style: italic;">"model.tar.gz"</span>
    <span style="font-weight: bold;">with</span> <span style="font-weight: bold;">open</span>(model_library_format_path, <span style="font-style: italic;">"wb"</span>) <span style="font-weight: bold;">as</span> mlf_f:
        mlf_f.write(mod_src_bytes)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#20351;&#29992;&#20102; Project API &#36827;&#34892; build, flash</span>
    <span style="font-weight: bold; font-style: italic;">template_project</span> = project.TemplateProject.from_directory(template_project_dir)
    <span style="font-weight: bold; font-style: italic;">generated_project</span> = template_project.generate_project_from_mlf(
        model_library_format_path,
        <span style="font-weight: bold;">str</span>(temp_dir / <span style="font-style: italic;">"generated-project"</span>),
        options=json.loads(project_options),
    )

    generated_project.build()
    generated_project.flash()
    <span style="font-weight: bold; font-style: italic;">transport</span> = generated_project.transport()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#20351;&#29992;&#20102; transport &#21644; bin &#20013;&#30340; microtvm rpc server &#20132;&#20114;</span>
    <span style="font-weight: bold; font-style: italic;">rpc_session</span> = Session(transport_context_manager=transport)
    rpc_session.__enter__()
    <span style="font-weight: bold;">return</span> rpc_session._rpc._sess
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000059" class="outline-3">
<h3 id="org0000059"><span class="section-number-3">1.5</span> Micro TVM &amp; BYOC</h3>
<div class="outline-text-3" id="text-1-5">
<p>
先说结论: Micro TVM 不支持 基于 __tvm_dev_mblob 方式的 BYOC, 但可以支持 c_src 形
式的 BYOC <a href="#org000000d">C Runtime</a>
</p>

<p>
为了支持 __tvm_dev_mblob, 最重要的一点是把 __tvm_dev_mblob 注册到 SystemLib 上.
</p>

<p>
TVM Runtime 的启动有三种方式:
</p>

<ol class="org-ol">
<li>通过 LoadFromFile 加载 DSOLibrary, 具体实现是 CreateModuleFromLibrary</li>
<li>通过 runtime.SystemLib 加载 SystemLibrary
<ol class="org-ol">
<li>c++ runtime 的 runtime.SystemLib 的实现与 DSOLibrary 一样, 是 CreateModuleFromLibrary</li>
<li>c runtime 的 runtime.SystemLib 的实现是 SystemLibraryCreate</li>
</ol></li>
</ol>

<p>
编译时: 1 和 2.1 编译时会注册 __tvm_dev_mblob, 而 2.2 不支持
运行时: 1 和 2.1 在运行时都会去加载 __tvm_dev_mblob, 而 2.2 则不支持.
</p>
</div>

<div id="outline-container-org0000050" class="outline-4">
<h4 id="org0000050"><span class="section-number-4">1.5.1</span> system-lib &amp; c++ runtime 注册 __tvm_dev_mblob</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
2.1 (system-lib &amp; c++ runtime) 是支持注册 __tvm_dev_mblob 的
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">export_library</span>(<span style="font-weight: bold;">self</span>, file_name, fcompile=<span style="font-weight: bold; text-decoration: underline;">None</span>, addons=<span style="font-weight: bold; text-decoration: underline;">None</span>, workspace_dir=<span style="font-weight: bold; text-decoration: underline;">None</span>, **kwargs):
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">self</span>.imported_modules:
        <span style="font-weight: bold;">if</span> enabled(<span style="font-style: italic;">"llvm"</span>) <span style="font-weight: bold;">and</span> llvm_target_triple:
            <span style="font-weight: bold; font-style: italic;">path_obj</span> = os.path.join(workspace_dir, f<span style="font-style: italic;">"devc.{object_format}"</span>)
            <span style="font-weight: bold; font-style: italic;">m</span> = _ffi_api.ModulePackImportsToLLVM(<span style="font-weight: bold;">self</span>, is_system_lib, llvm_target_triple)
            m.save(path_obj)
            files.append(path_obj)
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">path_cc</span> = os.path.join(workspace_dir, <span style="font-style: italic;">"devc.c"</span>)
            <span style="font-weight: bold;">with</span> <span style="font-weight: bold;">open</span>(path_cc, <span style="font-style: italic;">"w"</span>) <span style="font-weight: bold;">as</span> f:
                f.write(_ffi_api.ModulePackImportsToC(<span style="font-weight: bold;">self</span>, is_system_lib))
            files.append(path_cc)

</pre>
</div>

<p>
ModulePackImportsToLLVM 和 ModulePackImportsToC 会生成类似下面的代码:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">extern</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">TVMBackendRegisterSystemLibSymbol</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>*, <span style="font-weight: bold; text-decoration: underline;">void</span>*);
<span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">__tvm_dev_mblob_reg_</span> = TVMBackendRegisterSystemLibSymbol(
    <span style="font-style: italic;">"__tvm_dev_mblob"</span>, (<span style="font-weight: bold; text-decoration: underline;">void</span>*)__tvm_dev_mblob);
</pre>
</div>

<p>
通过 c++ 的 ctor 完成对 TVMBackendRegisterSystemLibSymbol 的调用.
</p>
</div>
</div>

<div id="outline-container-org0000053" class="outline-4">
<h4 id="org0000053"><span class="section-number-4">1.5.2</span> system-lib &amp; c runtime 不支持注册和解析 __tvm_dev_mblob</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
从当前的代码来看:
</p>

<ol class="org-ol">
<li>在 export_library 时不会针对 c_runtime 生成注册 __tvm_dev_mblob 的代码 (例如
ModulePackImportsToLLVM)</li>
<li>运行时 c runtime 也不会解析 __tvm_dev_mblob</li>
<li>以及一些其它的问题例如: <a href="file:///home/sunway/source/tvm/src/target/metadata_module.cc#org0000000">file:///home/sunway/source/tvm/src/target/metadata_module.cc#org0000000</a></li>
</ol>

<p>
所以 microtvm 无法支持 BYOC.
</p>

<p>
但是如果 c runtime 只是为了解决 c++ runtime ctor 的问题, 我们其实可以手动调用
c++ ctor:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
   <span style="font-weight: bold;">public</span>:
    <span style="font-weight: bold;">A</span>() { printf(<span style="font-style: italic;">"hello\n"</span>); }
};

<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>, <span style="font-weight: bold; font-style: italic;">b</span>, <span style="font-weight: bold; font-style: italic;">c</span>;

<span style="font-weight: bold;">typedef</span> <span style="font-weight: bold; text-decoration: underline;">void</span> (*<span style="font-weight: bold; text-decoration: underline;">FP</span>)();

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">__init_array_start, __init_array_end &#26159;&#36890;&#36807; linker script &#23450;&#20041;&#30340;&#31526;&#21495;</span>
<span style="font-weight: bold;">extern</span> <span style="font-weight: bold; text-decoration: underline;">FP</span> <span style="font-weight: bold; font-style: italic;">__init_array_start</span>;
<span style="font-weight: bold;">extern</span> <span style="font-weight: bold; text-decoration: underline;">FP</span> <span style="font-weight: bold; font-style: italic;">__init_array_end</span>;

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> *<span style="font-weight: bold; font-style: italic;">argv</span>[]) {
    printf(<span style="font-style: italic;">"----------main----------\n"</span>);
    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">FP</span> *<span style="font-weight: bold; font-style: italic;">p</span> = &amp;__init_array_start; p &lt; &amp;__init_array_end; p++) {
        (*p)();
    }
    <span style="font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
hello
hello
hello
-----&#x2013;&#x2014;main-----&#x2013;&#x2014;
hello
hello
hello
</p>
</div>
</div>

<div id="outline-container-org0000056" class="outline-4">
<h4 id="org0000056"><span class="section-number-4">1.5.3</span> ModulePackImportsToLLVM 的 Bug</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
ModulePackImportsToLLVM 时如果 is_system_lib 为 False, 则不会生成注册
__tvm_dev_mblob 的代码, 但 is_system_lib 的判断条件是:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">is_system_lib</span> = (
    module.type_key == <span style="font-style: italic;">"llvm"</span> <span style="font-weight: bold;">and</span> module.get_function(<span style="font-style: italic;">"__tvm_is_system_module"</span>)()
)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">PackedFunc</span> <span style="font-weight: bold;">GetFunction</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span>&amp; <span style="font-weight: bold; font-style: italic;">name</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">ObjectPtr</span>&lt;Object&gt;&amp; <span style="font-weight: bold; font-style: italic;">sptr_to_self</span>) <span style="font-weight: bold;">final</span> {
    <span style="font-weight: bold;">if</span> (name == <span style="font-style: italic;">"__tvm_is_system_module"</span>) {
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21028;&#26029;&#26377;&#27809;&#26377; __tvm_module_startup        </span>
      <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">flag</span> = (mptr_-&gt;getFunction(<span style="font-style: italic;">"__tvm_module_startup"</span>) != <span style="font-weight: bold; text-decoration: underline;">nullptr</span>);
      <span style="font-weight: bold;">return</span> PackedFunc([<span style="font-weight: bold; text-decoration: underline;">flag</span>](<span style="font-weight: bold; text-decoration: underline;">TVMArgs</span> <span style="font-weight: bold; font-style: italic;">args</span>, <span style="font-weight: bold; text-decoration: underline;">TVMRetValue</span>* <span style="font-weight: bold; font-style: italic;">rv</span>) { *rv = flag; });
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152; __tvm_module_startup &#30340;&#20195;&#30721;</span>
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">CodeGenCPU</span>::<span style="font-weight: bold;">AddStartupFunction</span>() {
  <span style="font-weight: bold;">if</span> (!target_c_runtime_) {
    <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">FunctionType</span>* <span style="font-weight: bold; font-style: italic;">ftype</span> = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">FunctionType</span>::get(t_void_, {}, <span style="font-weight: bold; text-decoration: underline;">false</span>);
    function_ = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::Create(ftype, <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::InternalLinkage,
                                       <span style="font-style: italic;">"__tvm_module_startup"</span>, module_.get());
    <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; <span style="font-weight: bold; font-style: italic;">kv</span> : export_system_symbols_) {
      <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Value</span>* <span style="font-weight: bold; font-style: italic;">name</span> = GetConstString(kv.first);
      builder_-&gt;CreateCall(f_tvm_register_system_symbol_,
                           {name, builder_-&gt;CreateBitCast(kv.second, t_void_p_)});
    }    
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
  }
}

<span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">unique_ptr</span>&lt;<span style="font-weight: bold; text-decoration: underline;">llvm</span>::Module&gt; <span style="font-weight: bold; text-decoration: underline;">CodeGenLLVM</span>::<span style="font-weight: bold;">Finish</span>() {
  <span style="font-weight: bold;">this</span>-&gt;AddStartupFunction();
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">optimize</span>
  <span style="font-weight: bold;">this</span>-&gt;Optimize();
  <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">std</span>::move(module_);
}

</pre>
</div>

<p>
问题出在最后那个 llvm::Optimize
</p>

<p>
当 relay IR 时没有任何函数需要在 CPU 执行时 (所有代码都交给 dnnl 执行),
export_system_symbols_ 会为空, 这时虽然已经在 llvm module 里生成了一个
__tvm_module_startup 函数, 但因为它的函数体为空且函数是 InternalLinkage,
llvm::Optimize 会把它删除&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2021-08-03 11:11</span>
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> te
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> relay
<span style="font-weight: bold;">import</span> os


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_good_mod</span>():
    <span style="font-weight: bold; font-style: italic;">d1</span> = relay.var(<span style="font-style: italic;">"d1"</span>, shape=(1, 32, 56, 56), dtype=<span style="font-style: italic;">"float32"</span>)
    <span style="font-weight: bold; font-style: italic;">w1</span> = relay.var(<span style="font-style: italic;">"w1"</span>, shape=(32, 32, 3, 3), dtype=<span style="font-style: italic;">"float32"</span>)
    <span style="font-weight: bold; font-style: italic;">b1</span> = relay.var(<span style="font-style: italic;">"b1"</span>, shape=(32,), dtype=<span style="font-style: italic;">"float32"</span>)
    <span style="font-weight: bold; font-style: italic;">conv</span> = relay.nn.conv2d(d1, w1, strides=(1, 1), padding=(1, 1))
    <span style="font-weight: bold; font-style: italic;">bias</span> = relay.nn.bias_add(conv, b1)
    <span style="font-weight: bold; font-style: italic;">relu</span> = relay.nn.relu(bias)

    <span style="font-weight: bold; font-style: italic;">func</span> = relay.Function([d1, w1, b1], relu)
    <span style="font-weight: bold; font-style: italic;">mod</span> = tvm.IRModule.from_expr(func)
    <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.InferType()(mod)
    <span style="font-weight: bold;">return</span> mod


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_bug_mod</span>():
    <span style="font-weight: bold; font-style: italic;">x</span> = relay.var(<span style="font-style: italic;">"x"</span>, shape=(10,), dtype=<span style="font-style: italic;">"float32"</span>)
    <span style="font-weight: bold; font-style: italic;">y</span> = relay.add(x, x)
    <span style="font-weight: bold; font-style: italic;">func</span> = relay.Function([x], y)
    <span style="font-weight: bold; font-style: italic;">mod</span> = tvm.IRModule.from_expr(func)
    <span style="font-weight: bold;">return</span> mod


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">prepare_relay_libs</span>():
    <span style="font-weight: bold; font-style: italic;">mod</span> = get_bug_mod()
    <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.AnnotateTarget(<span style="font-style: italic;">"dnnl"</span>)(mod)
    <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.PartitionGraph()(mod)
    <span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=1):
        <span style="font-weight: bold; font-style: italic;">mod</span> = relay.build(mod, target=<span style="font-style: italic;">"llvm --system-lib --runtime=c++"</span>, params=<span style="font-weight: bold; text-decoration: underline;">None</span>)
    mod.lib.export_library(<span style="font-style: italic;">"/tmp/libdouble_bug.tar"</span>)

    <span style="font-weight: bold; font-style: italic;">mod</span> = get_good_mod()
    <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.AnnotateTarget(<span style="font-style: italic;">"dnnl"</span>)(mod)
    <span style="font-weight: bold; font-style: italic;">mod</span> = relay.transform.PartitionGraph()(mod)
    <span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=1):
        <span style="font-weight: bold; font-style: italic;">mod</span> = relay.build(mod, target=<span style="font-style: italic;">"llvm --system-lib --runtime=c++"</span>, params=<span style="font-weight: bold; text-decoration: underline;">None</span>)
    mod.lib.export_library(<span style="font-style: italic;">"/tmp/libdouble_good.tar"</span>)


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    prepare_relay_libs()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"----------good----------"</span>
tar xvf /tmp/libdouble_good.tar -C /tmp
readelf -s /tmp/lib0.o
readelf -s /tmp/devc.o
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"----------bug----------"</span>
tar xvf /tmp/libdouble_bug.tar -C /tmp
readelf -s /tmp/lib0.o
readelf -s /tmp/devc.o
</pre>
</div>

<p>
-----&#x2013;&#x2014;good-----&#x2013;&#x2014;
lib0.o
devc.o
</p>

<p>
Symbol table '.symtab' contains 16 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    4 .LCPI0_0
     3: 00000000000005f0    40 FUNC    LOCAL  DEFAULT    2 __tvm_module_startup
     4: 0000000000000370    40 FUNC    LOCAL  DEFAULT    2 tvmgen_default_fused_nn_b
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    2 
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    9 
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   10 
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT   11 
    10: 0000000000000000     0 SECTION LOCAL  DEFAULT   20 
    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMAPISetLastError
    12: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendParallelLaunch
    13: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
    14: 0000000000000000     8 OBJECT  WEAK   DEFAULT    5 __tvm_module_ctx
    15: 0000000000000000   869 FUNC    GLOBAL DEFAULT    2 tvmgen_default_fused_nn_b
</p>

<p>
Symbol table '.symtab' contains 10 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS devc
     2: 0000000000000000     8 FUNC    LOCAL  DEFAULT    3 _GLOBAL__sub_I_devc
     3: 0000000000000010    28 FUNC    LOCAL  DEFAULT    3 <span class="underline">_cxx_global_var_init
     4: 0000000000000000     4 OBJECT  LOCAL  DEFAULT    6 __tvm_dev_mblob_reg</span>
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 
     8: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND TVMBackendRegisterSystemL
     9: 0000000000000000  2990 OBJECT  GLOBAL DEFAULT    5 __tvm_dev_mblob
-----&#x2013;&#x2014;bug-----&#x2013;&#x2014;
lib0.o
devc.o
</p>

<p>
Symbol table '.symtab' contains 6 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS TVMMod
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT   12 
</p>

<p>
Symbol table '.symtab' contains 3 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS devc
     2: 0000000000000000  1015 OBJECT  GLOBAL DEFAULT    3 __tvm_dev_mblob
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: <br />
Last updated: </p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
