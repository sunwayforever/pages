<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 Tue 15:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TVM Build</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">TVM Build</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org98fc8eb">1. TVM Build</a>
<ul>
<li><a href="#org863c545">1.1. Relay Optimizations</a>
<ul>
<li><a href="#org1a0fd08">1.1.1. Overview</a></li>
<li><a href="#org944155d">1.1.2. optimize</a></li>
<li><a href="#org9aa1c9a">1.1.3. PassContext</a></li>
<li><a href="#org2f5a10d">1.1.4. Relay Transform</a></li>
</ul>
</li>
<li><a href="#org364b28b">1.2. Relay IR -&gt; TE -&gt; TIR</a>
<ul>
<li><a href="#org42323b3">1.2.1. Relay IR -&gt; OpRegistry</a></li>
<li><a href="#orgc8651c6">1.2.2. OpRegistry -&gt; TE</a></li>
<li><a href="#org4a71f7b">1.2.3. TE -&gt; TIR</a></li>
</ul>
</li>
<li><a href="#org901b52d">1.3. TIR -&gt; Codegen</a>
<ul>
<li><a href="#org675cdd8">1.3.1. Example</a></li>
</ul>
</li>
<li><a href="#org041bf3f">1.4. Build Target</a>
<ul>
<li><a href="#orgc5c2401">1.4.1. target 参数是如何被解析和使用的</a></li>
<li><a href="#orgcf70f1a">1.4.2. LLVMTargetToString</a></li>
<li><a href="#org1c8a85b">1.4.3. arm_cpu 针对 arm 的特殊处理</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org98fc8eb" class="outline-2">
<h2 id="org98fc8eb"><span class="section-number-2">1</span> TVM Build</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org863c545" class="outline-3">
<h3 id="org863c545"><span class="section-number-3">1.1</span> Relay Optimizations</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org1a0fd08" class="outline-4">
<h4 id="org1a0fd08"><span class="section-number-4">1.1.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">with</span> tvm.transform.PassContext(
    opt_level=3, disabled_pass=[], required_pass=[], config={}
):
    <span style="font-weight: bold; font-style: italic;">graph</span>, <span style="font-weight: bold; font-style: italic;">lib</span>, <span style="font-weight: bold; font-style: italic;">params</span> = relay.build(mod, target=<span style="font-style: italic;">"c"</span>, params=<span style="font-weight: bold; text-decoration: underline;">None</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">build_module.py@relay:</span>
relay.build():
  <span style="font-weight: bold; font-style: italic;">bld_mod</span> = BuildModule()
  bld_mod.build(mod=ir_mod, target=target, params=params, executor=executor,
                mod_name=mod_name)
    <span style="font-weight: bold;">self</span>._build(mod, target, target_host, executor, mod_name)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++">
<span style="font-weight: bold;"># build_module</span>.cc@relay.backend
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">Build</span>(<span style="font-weight: bold; text-decoration: underline;">IRModule</span> <span style="font-weight: bold; font-style: italic;">mod</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">TargetsMap</span>&amp; <span style="font-weight: bold; font-style: italic;">targets</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">Target</span>&amp; <span style="font-weight: bold; font-style: italic;">target_host</span>,
             <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">executor</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">mod_name</span>) {
  targets_ = targets;
  target_host_ = target_host;
  executor_ = executor;
  BuildRelay(mod, params_, mod_name);

<span style="font-weight: bold; text-decoration: underline;">BuildRelay</span>:
  relay_module = Optimize(relay_module, targets_, params);
</pre>
</div>
</div>
</div>

<div id="outline-container-org944155d" class="outline-4">
<h4 id="org944155d"><span class="section-number-4">1.1.2</span> optimize</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
所有的针对 relay 的 optimizations pass 在 tvm::relay::transform 下.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">IRModule</span> <span style="font-weight: bold;">Optimize</span>(
    <span style="font-weight: bold; text-decoration: underline;">IRModule</span> <span style="font-weight: bold; font-style: italic;">relay_module</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">TargetsMap</span>&amp; <span style="font-weight: bold; font-style: italic;">targets</span>,
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">unordered_map</span>&lt;<span style="font-weight: bold; text-decoration: underline;">std</span>::string, <span style="font-weight: bold; text-decoration: underline;">runtime</span>::NDArray&gt;&amp; <span style="font-weight: bold; font-style: italic;">params</span>) {
    <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;Pass&gt; <span style="font-weight: bold; font-style: italic;">pass_seqs</span> = GetPassPrefix(targets, <span style="font-weight: bold; text-decoration: underline;">false</span>);
    <span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">Pass</span> <span style="font-weight: bold; font-style: italic;">seq</span> = <span style="font-weight: bold; text-decoration: underline;">transform</span>::Sequential(pass_seqs);
    relay_module = seq(relay_module);

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Handle heterogeneous compilation.</span>
    <span style="font-weight: bold; font-style: italic;">//</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21482;&#26377; targets &#25351;&#23450;&#20102;&#22810;&#20010;&#26102;&#25165;&#20250;&#25191;&#34892; RunDeviceAnnotationPass, &#21363;&#22788;&#29702;</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">on_device annotation, &#20363;&#22914; build vta &#26102;&#38656;&#35201;&#25351;&#23450;</span>
    <span style="font-weight: bold; font-style: italic;">//   </span><span style="font-weight: bold; font-style: italic;">target={"cpu": env.target_vta_cpu, "ext_dev": env.target},</span>
    <span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">PassContext</span> <span style="font-weight: bold; font-style: italic;">pass_ctx</span> = <span style="font-weight: bold; text-decoration: underline;">PassContext</span>::Current();
    <span style="font-weight: bold;">if</span> (targets_.size() &gt; 1) {
        <span style="font-weight: bold; text-decoration: underline;">Optional</span>&lt;Integer&gt; <span style="font-weight: bold; font-style: italic;">opt_fallback_dev</span> = pass_ctx-&gt;GetConfig(
            <span style="font-style: italic;">"relay.fallback_device_type"</span>, Integer(<span style="font-weight: bold;">static_cast</span>&lt;<span style="font-weight: bold; text-decoration: underline;">int</span>&gt;(kDLCPU)));
        <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">fallback_dev</span> = opt_fallback_dev.value();
        relay_module =
            RunDeviceAnnotationPass(relay_module, fallback_dev-&gt;value);
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    relay_module = <span style="font-weight: bold; text-decoration: underline;">transform</span>::FuseOps()(relay_module);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    relay_module = <span style="font-weight: bold; text-decoration: underline;">transform</span>::Inline()(relay_module);
    relay_module = <span style="font-weight: bold; text-decoration: underline;">transform</span>::InferType()(relay_module);
    relay_module = <span style="font-weight: bold; text-decoration: underline;">transform</span>::LabelOps()(relay_module);

    <span style="font-weight: bold;">return</span> relay_module;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;Pass&gt; <span style="font-weight: bold;">GetPassPrefix</span>(
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">Map</span>&lt;<span style="font-weight: bold; text-decoration: underline;">tvm</span>::Integer, <span style="font-weight: bold; text-decoration: underline;">tvm</span>::Target&gt;&amp; <span style="font-weight: bold; font-style: italic;">targets</span>, <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">is_vm</span>) {
    <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;Pass&gt; <span style="font-weight: bold; font-style: italic;">pass_seqs</span>;
    <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">runtime</span>::String&gt; <span style="font-weight: bold; font-style: italic;">entry_functions</span>{<span style="font-style: italic;">"main"</span>};
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::RemoveUnusedFunctions(entry_functions));
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::ToBasicBlockNormalForm());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">relay</span>::<span style="font-weight: bold; text-decoration: underline;">qnn</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::Legalize());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::SimplifyInference());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::DynamicToStatic());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::EliminateCommonSubexpr(fskip));
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::SimplifyExpr());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::CombineParallelConv2D(3));
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::CombineParallelDense(3));
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::CombineParallelBatchMatmul(3));
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::FoldConstant());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::FoldScaleAxis());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::CanonicalizeCast());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::CanonicalizeOps());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::FastMath());
    pass_seqs.push_back(<span style="font-weight: bold; text-decoration: underline;">transform</span>::FoldConstant());
    <span style="font-weight: bold;">return</span> pass_seqs;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9aa1c9a" class="outline-4">
<h4 id="org9aa1c9a"><span class="section-number-4">1.1.3</span> PassContext</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
PassContext 可以控制 pass 的开关, 包括 relay 和 tir 相关的 pass. 有时会需要关掉
某个 pass, 例如: batchnorm 正常会被 SimplifyInference Pass 转换成 mul/add, 也许
对某些 target 有更高效的实现
</p>
</div>

<div id="outline-container-org0e0b29b" class="outline-5">
<h5 id="org0e0b29b"><span class="section-number-5">1.1.3.1</span> opt_level</h5>
</div>

<div id="outline-container-orgd60c195" class="outline-5">
<h5 id="orgd60c195"><span class="section-number-5">1.1.3.2</span> disabled_pass</h5>
</div>

<div id="outline-container-org448265e" class="outline-5">
<h5 id="org448265e"><span class="section-number-5">1.1.3.3</span> required_pass</h5>
</div>

<div id="outline-container-org17c4905" class="outline-5">
<h5 id="org17c4905"><span class="section-number-5">1.1.3.4</span> config</h5>
<div class="outline-text-5" id="text-1-1-3-4">
<div class="org-src-container">
<pre class="src src-c++">TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.noalias"</span>, Bool);
TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.detect_global_barrier"</span>, Bool);
TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.instrument_bound_checkers"</span>, Bool);
TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.disable_assert"</span>, Bool);
TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.disable_vectorize"</span>, Bool);
TVM_REGISTER_PASS_CONFIG_OPTION(<span style="font-style: italic;">"tir.add_lower_pass"</span>, <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;ObjectRef&gt;&gt;);
</pre>
</div>

<p>
<a href="tvm_vta.html#orgba691e6">tir.add_lower_pass</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org2f5a10d" class="outline-4">
<h4 id="org2f5a10d"><span class="section-number-4">1.1.4</span> <a href="relay_transform.html#org4a687c4">Relay Transform</a></h4>
</div>
</div>

<div id="outline-container-org364b28b" class="outline-3">
<h3 id="org364b28b"><span class="section-number-3">1.2</span> Relay IR -&gt; TE -&gt; TIR</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org42323b3" class="outline-4">
<h4 id="org42323b3"><span class="section-number-4">1.2.1</span> Relay IR -&gt; OpRegistry</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>

</p>

<p>
Relay IR 例如 relay.op.sort() 返回的实际上是 Relay Expr:
tvm::relay::Call(Op::Get("sort"))
</p>
</div>
</div>

<div id="outline-container-orgc8651c6" class="outline-4">
<h4 id="orgc8651c6"><span class="section-number-4">1.2.2</span> OpRegistry -&gt; TE</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<div id="outline-container-orgdcf7832" class="outline-5">
<h5 id="orgdcf7832"><span class="section-number-5">1.2.2.1</span> BuildRelay</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">BuildRelay</span>:
  executor_codegen_ = MakeExecutorCodegen(executor_);
  executor_codegen_-&gt;Init(<span style="font-weight: bold; text-decoration: underline;">nullptr</span>, targets_);
  executor_codegen_-&gt;Codegen(func, mod_name);
    <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">lowered_module</span> = <span style="font-weight: bold; text-decoration: underline;">tec</span>::LowerTE()
  executor_codegen_-&gt;UpdateOutput(&amp;ret_);
  ret_.params = executor_codegen_-&gt;GetParams();

  <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">lowered_funcs</span> = executor_codegen_-&gt;GetIRModule();

</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc43fc6" class="outline-5">
<h5 id="orgbc43fc6"><span class="section-number-5">1.2.2.2</span> ExecutorCodegen</h5>
<div class="outline-text-5" id="text-1-2-2-2">
</div>
<ol class="org-ol">
<li><a id="orgbf5ed17"></a>GraphExecutorCodegen<br /></li>

<li><a id="org59a0bc7"></a>AOTExecutorCodegen<br /></li>
</ol>
</div>

<div id="outline-container-orga0839f9" class="outline-5">
<h5 id="orga0839f9"><span class="section-number-5">1.2.2.3</span> LowerTE</h5>
<div class="outline-text-5" id="text-1-2-2-3">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">LowerTE</span>:
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324; VisitExpr &#22788;&#29702;&#30340;&#37117;&#26159; Relay IR</span>
  LowerTensorExpr.VisitExpr()
    LowerInternal()
      <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">cfunc</span> = PrimFuncFor(key-&gt;source_func, key-&gt;target, [&amp;](<span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">name</span>) {
        <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">mangled</span> = mangle_fn(name);
        <span style="font-weight: bold;">return</span> GetUniqueName(mangled, &amp;name_map_);
      });
        <span style="font-weight: bold;">return</span> ScheduleBuilder(target).Create(source_func, renamer);
          <span style="font-weight: bold;">this</span>-&gt;VisitExpr(prim_func-&gt;body);
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">VisitExpr_(xxx)</span>
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#20250;&#35843;&#29992;&#21040; python, &#26597;&#25214; strategy,</span>
            <span style="font-weight: bold;">static</span> <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">flower_call</span> = <span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">Registry</span>::Get(<span style="font-style: italic;">"relay.backend.lower_call"</span>);
            <span style="font-weight: bold; text-decoration: underline;">LoweredOutput</span> <span style="font-weight: bold; font-style: italic;">lowered_out</span> = (*flower_call)(GetRef&lt;Call&gt;(call_node), inputs, target_);
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">!!! outputs &#26159; relay &#23545;&#24212;&#30340; te</span>
            outputs = lowered_out-&gt;outputs;
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">!!! impl &#20013;&#21253;&#25324; schedule</span>
            impl = lowered_out-&gt;implementation;
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">external functional, &#21442;&#32771;  [[file:tvm_byoc_codegen.org::*&#32534;&#35793; external functions][&#32534;&#35793; external functions]]</span>
  lowered_module.external_mods = compiler-&gt;LowerExternalFunctions();

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4a71f7b" class="outline-4">
<h4 id="org4a71f7b"><span class="section-number-4">1.2.3</span> TE -&gt; TIR</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
TE 是没有经过 schedule 的 TIR， 因为 te.compute 返回的已经是 TIR 了.
</p>

<p>
以下面代码为例：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">M</span> = 10
<span style="font-weight: bold; font-style: italic;">A</span> = te.placeholder((M, ), name=<span style="font-style: italic;">"A"</span>)
<span style="font-weight: bold; font-style: italic;">B</span> = te.placeholder((M, ), name=<span style="font-style: italic;">"B"</span>)
<span style="font-weight: bold;">import</span> ipdb; ipdb.set_trace()
<span style="font-weight: bold; font-style: italic;">C</span> = te.compute((M, ), <span style="font-weight: bold;">lambda</span> x: A[x] + B[x])
</pre>
</div>

<p>
当 te.compute 返回后， C.op 是由 TIR 组成的 ComputeOp:
</p>

<p>
加了些 log 后打印出来的 ComputeOp 中的表达式类型为:
</p>
<pre class="example" id="org42557e7">
&lt;Array&gt;
  &lt;tir.Add&gt;
    &lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}
    &lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}
</pre>

<p>
te.compute 执行时会直接执行 lambda 产生 Op, 具体过程依赖于 python 的 operator
overloading, 例如:
</p>

<ol class="org-ol">
<li>A 的类型为 Tensor, A[x] 会调用 Tensor.__getitem__, 产生一个 tir:ProducerLoad</li>
<li>A[x]+B[x] 会调用 ExprOp.__add__， 产生一个 tir::Add</li>
</ol>
</div>


<div id="outline-container-org270708c" class="outline-5">
<h5 id="org270708c"><span class="section-number-5">1.2.3.1</span> Schedule</h5>
<div class="outline-text-5" id="text-1-2-3-1">
<p>
Schedule 的原理: <a href="tvm_schedule.html#orgcc9e57a">Schedule</a>
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">LowerInternal</span> :
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">LowerSchedule &#25226; TE &#26681;&#25454; schedule &#32763;&#35793;&#25104; TIR</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">tvm.build, tvm.lower &#20063;&#26159;&#35843;&#29992;&#30340;&#36825;&#20010;&#20989;&#25968;&#25226; te.schedule &#32763;&#35793;&#25104; TIR</span>
    cfunc-&gt;funcs-&gt;Update(
        <span style="font-weight: bold; text-decoration: underline;">tvm</span>::LowerSchedule(cfunc-&gt;schedule, all_args, func_name, binds));
</pre>
</div>

<p>
以一个简单的 split 为例:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2021-08-03 11:11</span>
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> te

<span style="font-weight: bold; font-style: italic;">M</span> = 10
<span style="font-weight: bold; font-style: italic;">A</span> = te.placeholder((M,), name=<span style="font-style: italic;">"A"</span>)
<span style="font-weight: bold; font-style: italic;">B</span> = te.placeholder((M,), name=<span style="font-style: italic;">"B"</span>)

<span style="font-weight: bold; font-style: italic;">C</span> = te.compute((M,), <span style="font-weight: bold;">lambda</span> x: A[x] + B[x])
<span style="font-weight: bold; font-style: italic;">s</span> = te.create_schedule(C.op)
s[C].split(C.op.axis[0], factor=5)

<span style="font-weight: bold; font-style: italic;">f</span> = tvm.build(s, [A, B, C], target=<span style="font-style: italic;">"c"</span>, name=<span style="font-style: italic;">"hello"</span>)
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org131df1d"></a>ScheduleToModule<br />
<div class="outline-text-6" id="text-1-2-3-1-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">LowerSchedule</span>:
  <span style="font-weight: bold; text-decoration: underline;">IRModule</span> <span style="font-weight: bold; font-style: italic;">mod</span> = ScheduleToModule(<span style="font-weight: bold; text-decoration: underline;">std</span>::move(sch), args, name, binds);
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold; font-style: italic;">pass_list</span> = CreatePassList(simple_mode, <span style="font-weight: bold; text-decoration: underline;">true</span>);
  <span style="font-weight: bold;">return</span> LowerWithPassList(mod, pass_list);

<span style="font-weight: bold; text-decoration: underline;">ScheduleToModule</span>:
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">InferBound &#26681;&#25454; split &#30340; factor &#24471;&#21040; itervar &#21450;&#20854;&#24490;&#29615;&#30340;&#33539;&#22260;&#65292; &#27604;&#22914;&#36825;&#37324;&#25171;&#21360;</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#20986; bounds &#30340;&#20449;&#24687;:</span>
  <span style="font-weight: bold; font-style: italic;">// </span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">for (auto&amp; p : bounds) {</span>
  <span style="font-weight: bold; font-style: italic;">//     </span><span style="font-weight: bold; font-style: italic;">LOG_INFO &lt;&lt; p.first &lt;&lt; p.second;</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">}</span>
  <span style="font-weight: bold; font-style: italic;">// </span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25171;&#21360;&#20986;&#32467;&#26524;&#20026;:</span>
  <span style="font-weight: bold; font-style: italic;">// </span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x.outer, )}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;2})}</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x, {&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;10})})}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;10})}</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x.inner, )}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;5})}  </span>
  <span style="font-weight: bold; text-decoration: underline;">Map</span>&lt;<span style="font-weight: bold; text-decoration: underline;">tir</span>::IterVar, Range&gt; <span style="font-weight: bold; font-style: italic;">bounds</span> = <span style="font-weight: bold; text-decoration: underline;">te</span>::InferBound(sch);
  <span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">Stmt</span> <span style="font-weight: bold; font-style: italic;">stmt</span> = <span style="font-weight: bold; text-decoration: underline;">te</span>::ScheduleOps(sch, <span style="font-weight: bold; text-decoration: underline;">std</span>::move(bounds), <span style="font-weight: bold; text-decoration: underline;">false</span>);
    body = MakePipeline(s, dom_map, body, debug_keep_trivial_loop);
      <span style="font-weight: bold; text-decoration: underline;">Stmt</span> <span style="font-weight: bold; font-style: italic;">producer</span> = s-&gt;op-&gt;BuildProvide(s, dom_map,  debug_keep_trivial_loop);
        MakeComputeStmt(<span style="font-weight: bold;">this</span>, stage, dom_map, <span style="font-weight: bold; text-decoration: underline;">debug_</span> <span style="font-weight: bold; font-style: italic;">keep_trivial_loop</span>);
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987; body &#20013;&#21482;&#26377;&#19968;&#26465; stmt, &#21363; lambda(x) :A[x]+B[x] &#36890;&#36807; compute &#29983;&#25104; &#30340; stmt</span>
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.ProducerStore&gt;compute[{&lt;tir.Var&gt;x }] ={&lt;tir.Add&gt;({&lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}]} + {&lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}]})}</span>
          <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">i</span> = 0; i &lt; self-&gt;body.size(); ++i) {
            provides.emplace_back(MakeProvide(self, stage-&gt;op.output(i)));
          } 
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">MergeNest &#26368;&#32456;&#26681;&#25454; bounds (&#21363; dom_map)  &#29983;&#25104;&#39069;&#22806;&#30340;&#24490;&#29615;&#35821;&#21477;&#65292;</span>
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">MergeNest &#36820;&#22238;&#30340; stmt &#20026;: </span>
          <span style="font-weight: bold; font-style: italic;">//  </span>
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.For&gt;for ({&lt;tir.Var&gt;x.outer}, {&lt;In tImm&gt;0}, {&lt;IntImm&gt;2}) {</span>
          <span style="font-weight: bold; font-style: italic;">//   </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.AttrStmt&gt;  // attr [{&lt;tir.IterV ar&gt;iter_var(x.outer, )}] loop_scope = {&lt;tir.Var&gt;x.outer}</span>
          <span style="font-weight: bold; font-style: italic;">//   </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.For&gt;  for ({&lt;tir.Var&gt;x.inner},  {&lt;IntImm&gt;0}, {&lt;IntImm&gt;5}) {</span>
          <span style="font-weight: bold; font-style: italic;">//     </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.AttrStmt&gt;    // attr [{&lt;tir.I terVar&gt;iter_var(x.inner, )}] loop_scope = {&lt;tir.Var&gt;x.inner}</span>
          <span style="font-weight: bold; font-style: italic;">//     </span><span style="font-weight: bold; font-style: italic;">{&lt;tir.ProducerStore&gt;    compute[{&lt;t ir.Var&gt;x}] ={&lt;tir.Add&gt;({&lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}]} + {&lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}]})}}}</span>
          <span style="font-weight: bold; font-style: italic;">//   </span><span style="font-weight: bold; font-style: italic;">}}}} </span>
          <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">}           </span>
          provide = MergeNest(n.main_nest, provide); 
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org6451bf3" class="outline-5">
<h5 id="org6451bf3"><span class="section-number-5">1.2.3.2</span> TIR Optimizations</h5>
<div class="outline-text-5" id="text-1-2-3-2">
</div>
<ol class="org-ol">
<li><a id="orgd39e462"></a>LowerWithPassList<br />
<div class="outline-text-6" id="text-1-2-3-2-1">
<p>
ScheduleToModule 得到 tir 后, LowerWithPassList 可以对 tir 做进一步的修改和优化,
每一种修改称为一个 pass, 针对 tir 的 pass 在 tvm::tir::transform 下
</p>

<p>
其中 tir.add_lower_pass 是用户自己添加的 pass, 通过 add_lower_pass 机制, 上层可
以定制生成的 tir. VTA 就是通过 add_lower_pass 添加自定义的 pass, 把一个 tir (例
如 tir.add) 转换为对 vta runtime 的调用的 (例如 VTAPushALUOp)
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold;">CreatePassList</span>(<span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">disable_loop_partition</span>, <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">for_te_schedule</span>) {
  <span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">PassContext</span> <span style="font-weight: bold; font-style: italic;">pass_ctx</span> = <span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">PassContext</span>::Current();

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Get any user-added passes</span>
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;ObjectRef&gt;&gt; <span style="font-weight: bold; font-style: italic;">add_lower_pass</span> =
      pass_ctx-&gt;GetConfig&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;ObjectRef&gt;&gt;&gt;(<span style="font-style: italic;">"tir.add_lower_pass"</span>, Array&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;ObjectRef&gt;&gt;())
          .value();

  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold; font-style: italic;">user_lower_phase0</span> = Array&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt;();
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold; font-style: italic;">user_lower_phase1</span> = Array&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt;();
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold; font-style: italic;">user_lower_phase2</span> = Array&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt;();
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt; <span style="font-weight: bold; font-style: italic;">user_lower_phase3</span> = Array&lt;<span style="font-weight: bold; text-decoration: underline;">transform</span>::Pass&gt;();

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">phase pasees is of the form</span>
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">[[phase_number, pass], [phase_number, pass]... ]</span>
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;ObjectRef&gt; <span style="font-weight: bold; font-style: italic;">phase_pass</span> : add_lower_pass) {
    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">IntImmNode</span>* <span style="font-weight: bold; font-style: italic;">phase_num</span> = phase_pass[0].as&lt;<span style="font-weight: bold; text-decoration: underline;">IntImmNode</span>&gt;();
    ICHECK(phase_num)
        &lt;&lt; <span style="font-style: italic;">"Expected the first entry in the inner Array of tir.add_lower_pass to be an integer"</span>;
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">phase_num_val</span> = phase_num-&gt;value;

    CHECK_GE(phase_num_val, 0);

    <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">PassNode</span>* <span style="font-weight: bold; font-style: italic;">pass_node</span> = phase_pass[1].as&lt;<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">PassNode</span>&gt;();
    <span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">Pass</span> <span style="font-weight: bold; font-style: italic;">pass</span> = GetRef&lt;<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">Pass</span>&gt;(pass_node);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Copy the pass into the correct phase</span>
    <span style="font-weight: bold;">if</span> (phase_num_val == 0) {
      user_lower_phase0.push_back(pass);
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (phase_num_val == 1) {
      user_lower_phase1.push_back(pass);
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (phase_num_val == 2) {
      user_lower_phase2.push_back(pass);
    } <span style="font-weight: bold;">else</span> <span style="font-weight: bold;">if</span> (phase_num_val &gt;= 3) {
      user_lower_phase3.push_back(pass);
    }
  }

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Construct the pass list, inserting the user provided passes at the end of the phase</span>

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">PHASE 0</span>
  <span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::<span style="font-weight: bold; text-decoration: underline;">Pass</span>&gt; <span style="font-weight: bold; font-style: italic;">pass_list</span> = user_lower_phase0;

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">PHASE 1</span>
  <span style="font-weight: bold;">if</span> (for_te_schedule) {
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::InjectPrefetch());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::StorageFlatten(64, instrument_bound_checkers));
  } <span style="font-weight: bold;">else</span> {
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::LowerInitBlock());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::PlanAndUpdateBufferAllocationLocation());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::ConvertBlocksToOpaque());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::CompactBufferAllocation());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::LowerMatchBuffer());
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::FlattenBuffer());
  }
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::BF16Legalize());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::NarrowDataType(32));
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::Simplify());

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Add user-defined phase-1 passes</span>
  pass_list.insert(pass_list.end(), user_lower_phase1.begin(), user_lower_phase1.end());

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">PHASE 2</span>
  <span style="font-weight: bold;">if</span> (!disable_loop_partition) {
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::LoopPartition());
  }

  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::VectorizeLoop(!disable_vectorize));
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::InjectVirtualThread());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::InjectDoubleBuffer());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::StorageRewrite());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::UnrollLoop());

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Add user-defined phase-2 passes</span>
  pass_list.insert(pass_list.end(), user_lower_phase2.begin(), user_lower_phase2.end());

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">PHASE 3</span>
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::Simplify());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::RemoveNoOp());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::RewriteUnsafeSelect());
  pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::HoistIfThenElse());

  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Add user-defined phase-3 passes</span>
  pass_list.insert(pass_list.end(), user_lower_phase3.begin(), user_lower_phase3.end());

  <span style="font-weight: bold;">if</span> (instrument_bound_checkers) {
    pass_list.push_back(<span style="font-weight: bold; text-decoration: underline;">tir</span>::<span style="font-weight: bold; text-decoration: underline;">transform</span>::InstrumentBoundCheckers());
  }
  <span style="font-weight: bold;">return</span> pass_list;
}

</pre>
</div>
</div>
</li>

<li><a id="org8f3526e"></a><a href="tir_transform.html#org751d9e6">TIR Transform</a><br /></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org901b52d" class="outline-3">
<h3 id="org901b52d"><span class="section-number-3">1.3</span> TIR -&gt; Codegen</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; text-decoration: underline;">BuildRelay</span>:
  ret_.mod = <span style="font-weight: bold; text-decoration: underline;">tvm</span>::build(lowered_funcs, target_host_);

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">driver_api.cc</span>
<span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">Module</span> <span style="font-weight: bold;">build</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">Map</span>&lt;Target, IRModule&gt;&amp; <span style="font-weight: bold; font-style: italic;">inputs_arg</span>, <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">Target</span>&amp; <span style="font-weight: bold; font-style: italic;">target_host_arg</span>) :
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; <span style="font-weight: bold; font-style: italic;">it</span> : inputs) {
    <span style="font-weight: bold;">if</span> (mdevice-&gt;functions.size() != 0) {
      device_modules.push_back(<span style="font-weight: bold; text-decoration: underline;">codegen</span>::Build(mdevice, it.first));

  <span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">Module</span> <span style="font-weight: bold; font-style: italic;">mhost</span> = <span style="font-weight: bold; text-decoration: underline;">codegen</span>::Build(mhost_all, target_host);        

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">codegen.cc @ src/target/</span>
<span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">Module</span> <span style="font-weight: bold; font-style: italic;">Build</span>(IRModule mod, Target target) {
  <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">build_f_name</span> = <span style="font-style: italic;">"target.build."</span> + target-&gt;kind-&gt;name;
  <span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">PackedFunc</span>* <span style="font-weight: bold; font-style: italic;">bf</span> = <span style="font-weight: bold; text-decoration: underline;">runtime</span>::<span style="font-weight: bold; text-decoration: underline;">Registry</span>::Get(build_f_name);
  <span style="font-weight: bold;">return</span> (*bf)(mod, target);

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">"target.build.llvm" @ src/target/llvm/llvm_module.cc</span>
TVM_REGISTER_GLOBAL(<span style="font-style: italic;">"target.build.llvm"</span>)
    .set_body_typed([](<span style="font-weight: bold; text-decoration: underline;">IRModule</span> <span style="font-weight: bold; font-style: italic;">mod</span>, <span style="font-weight: bold; text-decoration: underline;">Target</span> <span style="font-weight: bold; font-style: italic;">target</span>) -&gt; <span style="font-weight: bold; text-decoration: underline;">runtime</span>::Module {
      <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; font-style: italic;">n</span> = make_object&lt;LLVMModuleNode&gt;();
      n-&gt;Init(mod, target);
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">runtime</span>::Module(n);
    });

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">LLVMModuleNode</span>::<span style="font-weight: bold; font-style: italic;">Init</span>(<span style="font-weight: bold;">const</span> IRModule&amp; mod, <span style="font-weight: bold;">const</span> Target&amp; target):
  InitializeLLVM();
  tm_ = GetLLVMTargetMachine(target);
  <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">system_lib</span> = target-&gt;GetAttr&lt;Bool&gt;(<span style="font-style: italic;">"system-lib"</span>).value_or(Bool(<span style="font-weight: bold; text-decoration: underline;">false</span>));
  <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">target_c_runtime</span> = (target-&gt;GetAttr&lt;String&gt;(<span style="font-style: italic;">"runtime"</span>).value_or(<span style="font-style: italic;">""</span>) == kTvmRuntimeCrt);
  ctx_ = <span style="font-weight: bold; text-decoration: underline;">std</span>::make_shared&lt;<span style="font-weight: bold; text-decoration: underline;">llvm</span>::LLVMContext&gt;();
  <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">unique_ptr</span>&lt;CodeGenLLVM&gt; <span style="font-weight: bold; font-style: italic;">cg</span> = <span style="font-weight: bold; text-decoration: underline;">CodeGenLLVM</span>::Create(tm_.get());
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
  <span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">const</span> <span style="font-weight: bold;">auto</span>&amp; <span style="font-weight: bold; font-style: italic;">f</span> : funcs):
    cg-&gt;AddFunction(f);
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">....</span>
  module_ = cg-&gt;Finish();  

</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">codegen_llvm.cc @ src/target/llvm</span>
<span style="font-weight: bold; text-decoration: underline;">AddFunction</span>:
  <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">CodeGenLLVM</span>::<span style="font-weight: bold;">AddFunctionInternal</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">PrimFunc</span>&amp; <span style="font-weight: bold; font-style: italic;">f</span>, <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">ret_void</span>):
    function_ = <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::Create(ftype, <span style="font-weight: bold; text-decoration: underline;">llvm</span>::<span style="font-weight: bold; text-decoration: underline;">Function</span>::ExternalLinkage,
                                     global_symbol.value().<span style="font-weight: bold;">operator</span> <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span>(), module_.get());
    <span style="font-weight: bold;">this</span>-&gt;VisitStmt(f-&gt;body);
      <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">.....</span>
      <span style="font-weight: bold; text-decoration: underline;">CodeGenLLVM</span>::VisitStmt_()
        MakeValue()
          VisitExpr()
            VisitExpr_()
</pre>
</div>
</div>

<div id="outline-container-org675cdd8" class="outline-4">
<h4 id="org675cdd8"><span class="section-number-4">1.3.1</span> Example</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
由于 relay.build 时无法看到对应的 TIR,
<a href="https://discuss.tvm.apache.org/t/capture-tensor-level-ir-and-schedule-from-relay/9630">https://discuss.tvm.apache.org/t/capture-tensor-level-ir-and-schedule-from-relay/9630</a>,
所以直接使用一段 TE 来展示 codegen 的过程
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2021-08-03 11:11</span>
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> te

<span style="font-weight: bold; font-style: italic;">M</span> = 10
<span style="font-weight: bold; font-style: italic;">N</span> = 10
<span style="font-weight: bold; font-style: italic;">A</span> = te.placeholder((M, N), name=<span style="font-style: italic;">"A"</span>)
<span style="font-weight: bold; font-style: italic;">B</span> = te.placeholder((M, N), name=<span style="font-style: italic;">"B"</span>)
<span style="font-weight: bold; font-style: italic;">C</span> = te.compute((M, N), <span style="font-weight: bold;">lambda</span> x, y: A[x, y] + B[x, y])

<span style="font-weight: bold; font-style: italic;">s</span> = te.create_schedule(C.op)
<span style="font-weight: bold;">print</span>(tvm.lower(s, [A, B, C]))
<span style="font-weight: bold; font-style: italic;">f</span> = tvm.build(s, [A, B, C], target = <span style="font-style: italic;">"c"</span>, name = <span style="font-style: italic;">"hello"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">print(f.get_source())</span>
</pre>
</div>

<p>
primfn(A_1: handle, B_1: handle, compute_1: handle) -&gt; ()
  attr = {"global_symbol": "main", "tir.noalias": True}
  buffers = {A: Buffer(A_2: Pointer(float32), float32, [10, 10], []),
             compute: Buffer(compute_2: Pointer(float32), float32, [10, 10], []),
             B: Buffer(B_2: Pointer(float32), float32, [10, 10], [])}
  buffer_map = {A_1: A, B_1: B, compute_1: compute} {
  for (x: int32, 0, 10) {
    for (y: int32, 0, 10) {
      compute_2[((x*10) + y)] = ((float32*)A_2[((x*10) + y)] + (float32*)B_2[((x*10) + y)])
    }
  }
}
</p>

<p>
下面的 log 展示的是 codegen_c.cc 生成如下的 TE 的过程
</p>

<pre class="example" id="org46b721e">
for (x: int32, 0, 10) {
  for (y: int32, 0, 10) {
    compute_2[((x*10) + y)] = ((float32*)A_2[((x*10) + y)] + (float32*)B_2[((x*10) + y)])
  }
}
</pre>

<pre class="example" id="orgeb68f4c">
tvm/src/target/source/codegen_c.cc:920: &gt;&gt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:469:   VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:922:   extent: 10
tvm/src/target/source/codegen_c.cc:925:   vid: x name_hint: x
tvm/src/target/source/codegen_c.cc:920:   &gt;&gt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:469:     VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:922:     extent: 10
tvm/src/target/source/codegen_c.cc:925:     vid: y name_hint: y
tvm/src/target/source/codegen_c.cc:754:     &gt;&gt;VisitStmt_:StoreNode
tvm/src/target/source/codegen_c.cc:526:       &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:159:         &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:           &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:             &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:               VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:             &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:           &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:         &lt;&lt;GetBufferRef:((float*)A)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:159:         &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:           &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:             &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:               VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:             &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:           &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:         &lt;&lt;GetBufferRef:((float*)B)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:528:       &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:758:     &lt;&lt;VisitStmt_:StoreNode: (((float*)A)[(((x * 10) + y))] + ((float*)B)[(((x * 10) + y))])
tvm/src/target/source/codegen_c.cc:159:     &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:       &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:         &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:           VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:         &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:       &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:     &lt;&lt;GetBufferRef:((float*)compute)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:935:   &lt;&lt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:935: &lt;&lt;VisitStmt_:ForNode

</pre>
</div>
</div>
</div>

<div id="outline-container-org041bf3f" class="outline-3">
<h3 id="org041bf3f"><span class="section-number-3">1.4</span> Build Target</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-orgc5c2401" class="outline-4">
<h4 id="orgc5c2401"><span class="section-number-4">1.4.1</span> target 参数是如何被解析和使用的</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
build 时的 target 参数, 例如
</p>

<pre class="example" id="org4f95663">
llvm --device=arm_cpu --mtriple=armv7a-linux-gnueabihf,
</pre>

<p>
会通过 TargetInternal::FromConfig 进行解析, 变成一个 Target 对象, 打印出来是
</p>

<pre class="example" id="org93760f4">
llvm -keys=arm_cpu,cpu -device=arm_cpu -link-params=0 -mtriple=armv7a-linux-gnueabihf
</pre>

<p>
keys 中的 `arm_cpu, cpu` 是 TargetInternal::FromConfig 补上去的.
</p>

<p>
后续代码可能会根据需求访问 target 中的成员, 例如 x86 相关的 topi 会通过 "mcpu"
成员确定 simd 宽度:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_simd_32bit_lanes</span>():
    <span style="font-weight: bold; font-style: italic;">mcpu</span> = tvm.target.Target.current().mcpu
    <span style="font-weight: bold; font-style: italic;">fp32_vec_len</span> = 4
    <span style="font-weight: bold;">if</span> target_has_avx512(mcpu):
        <span style="font-weight: bold; font-style: italic;">fp32_vec_len</span> = 16
    <span style="font-weight: bold;">elif</span> target_has_avx2(mcpu):
        <span style="font-weight: bold; font-style: italic;">fp32_vec_len</span> = 8
    <span style="font-weight: bold;">return</span> fp32_vec_len
</pre>
</div>

<p>
Target 的支持的成员通过 target_kind 定义的, 主要包括:
</p>

<ol class="org-ol">
<li>kind</li>
<li>keys</li>
<li>device</li>
<li>mcpu</li>
<li>mtriple</li>
<li>runtime</li>
<li>system-lib</li>
</ol>

<div class="org-src-container">
<pre class="src src-C++">TVM_REGISTER_TARGET_KIND(<span style="font-style: italic;">"llvm"</span>, kDLCPU)
    .add_attr_option&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;String&gt;&gt;(<span style="font-style: italic;">"mattr"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"mcpu"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"mtriple"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"mfloat-abi"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"mabi"</span>)
    .add_attr_option&lt;Bool&gt;(<span style="font-style: italic;">"system-lib"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"runtime"</span>)
    .add_attr_option&lt;Bool&gt;(<span style="font-style: italic;">"link-params"</span>, Bool(<span style="font-weight: bold; text-decoration: underline;">false</span>))
    .add_attr_option&lt;Bool&gt;(<span style="font-style: italic;">"unpacked-api"</span>)
    .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"interface-api"</span>)
    .set_default_keys({<span style="font-style: italic;">"cpu"</span>});

<span style="font-weight: bold;">#define</span> <span style="font-weight: bold;">TVM_REGISTER_TARGET_KIND</span>(<span style="font-weight: bold; font-style: italic;">TargetKindName</span>, <span style="font-weight: bold; font-style: italic;">DeviceType</span>)      \
  TVM_STR_CONCAT(TVM_TARGET_KIND_REGISTER_VAR_DEF, __COUNTER__) = \
      ::<span style="font-weight: bold; text-decoration: underline;">tvm</span>::<span style="font-weight: bold; text-decoration: underline;">TargetKindRegEntry</span>::RegisterOrGet(TargetKindName)    \
          .set_name()                                             \
          .set_device_type(DeviceType)                            \
          .add_attr_option&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;String&gt;&gt;(<span style="font-style: italic;">"keys"</span>)                 \
          .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"tag"</span>)                         \
          .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"device"</span>)                      \
          .add_attr_option&lt;String&gt;(<span style="font-style: italic;">"model"</span>)                       \
          .add_attr_option&lt;<span style="font-weight: bold; text-decoration: underline;">Array</span>&lt;String&gt;&gt;(<span style="font-style: italic;">"libs"</span>)                 \
          .add_attr_option&lt;Target&gt;(<span style="font-style: italic;">"host"</span>)                        \
          .add_attr_option&lt;Integer&gt;(<span style="font-style: italic;">"from_device"</span>)

}  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">namespace tvm</span>

</pre>
</div>

<p>
Target 中最重要的成员是 kind 和 keys:
</p>

<ol class="org-ol">
<li><p>
kind 决定了 target codegen
</p>

<div class="org-src-container">
<pre class="src src-C++"><span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">build_f_name</span> = <span style="font-style: italic;">"target.build."</span> + target-&gt;kind-&gt;name;
</pre>
</div></li>

<li>keys 决定了查找哪些 strategy
<a href="file:///home/sunway/source/tvm/python/tvm/target/generic_func.py#orgc349448">file:///home/sunway/source/tvm/python/tvm/target/generic_func.py#orgc349448</a></li>
</ol>
</div>
</div>

<div id="outline-container-orgcf70f1a" class="outline-4">
<h4 id="orgcf70f1a"><span class="section-number-4">1.4.2</span> LLVMTargetToString</h4>
</div>

<div id="outline-container-org1c8a85b" class="outline-4">
<h4 id="org1c8a85b"><span class="section-number-4">1.4.3</span> arm_cpu 针对 arm 的特殊处理</h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<div id="outline-container-org21e4c69" class="outline-5">
<h5 id="org21e4c69"><span class="section-number-5">1.4.3.1</span> vectorize</h5>
<div class="outline-text-5" id="text-1-4-3-1">
<p>
<a href="https://community.arm.com/arm-community-blogs/b/operating-systems-blog/posts/arm-neon-programming-quick-reference">https://community.arm.com/arm-community-blogs/b/operating-systems-blog/posts/arm-neon-programming-quick-reference</a>
</p>

<p>
neon 最多支持 16 字节的向量操作, 所以 tvm 使用 vectorize shedule 时需要使用特定
大小的 split
</p>

<p>
arm_cpu 对应的 schedule_injective 为:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">schedule_injective</span>(outs):
    <span style="font-weight: bold; font-style: italic;">outs</span> = [outs] <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">isinstance</span>(outs, te.tensor.Tensor) <span style="font-weight: bold;">else</span> outs
    <span style="font-weight: bold; font-style: italic;">s</span> = te.create_schedule([x.op <span style="font-weight: bold;">for</span> x <span style="font-weight: bold;">in</span> outs])
    <span style="font-weight: bold; font-style: italic;">x</span> = outs[0]

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">list</span>(s[x].op.axis):
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">split &#22823;&#23567;&#20026; 4, &#22240;&#20026; 4 &#20010; float32 &#30340;&#22823;&#23567;&#21363;&#20026; 16</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340;&#20195;&#30721;&#26377;&#38382;&#39064;: &#33509;&#25968;&#25454;&#31867;&#22411;&#26159; int8, &#36825;&#37324;&#30340; split &#35774;&#32622;&#20026; 16 &#24615;&#33021;&#25165;&#26159;&#26368;&#22909;&#30340;</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">https://github.com/apache/tvm/pull/9339</span>
        (io, ii) = s[x].split(<span style="font-weight: bold;">list</span>(s[x].op.axis)[-1], 4)
        s[x].vectorize(ii)
    tvm.te.schedule.AutoInlineInjective(s)

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> is_empty_shape(x.shape):
        schedule_injective_from_existing(s, x)
    <span style="font-weight: bold;">return</span> s

</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-*- coding: utf-8 -*-</span>
<span style="font-weight: bold;">import</span> tvm
<span style="font-weight: bold;">from</span> tvm <span style="font-weight: bold;">import</span> relay

<span style="font-weight: bold; font-style: italic;">x</span> = relay.var(<span style="font-style: italic;">"x"</span>, shape=(1, 1024), dtype=<span style="font-style: italic;">"float32"</span>)
<span style="font-weight: bold; font-style: italic;">y</span> = relay.add(x, x)
<span style="font-weight: bold; font-style: italic;">func</span> = relay.Function([x], y)
<span style="font-weight: bold; font-style: italic;">mod</span> = tvm.IRModule.from_expr(func)

<span style="font-weight: bold;">with</span> tvm.transform.PassContext(opt_level=3):
    <span style="font-weight: bold; font-style: italic;">graph</span>, <span style="font-weight: bold; font-style: italic;">lib</span>, <span style="font-weight: bold; font-style: italic;">params</span> = relay.build(
        mod,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">target &#20013;&#30340; `-mtriple=armv7a-linux-gnueabihf -mattr=+neon` &#20250;&#30452;&#25509;&#20256;&#32473; llvm</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">(LLVMTargetToString), &#20854;&#20013;armv7a &#30340; neon &#26159;&#21487;&#36873;&#25903;&#25345;, &#25152;&#20197;&#19981;&#20351;&#29992; +neon</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30340;&#35805; llvm &#20250;&#20351;&#29992; vfp. &#22914;&#26524; triple &#25913;&#25104; armv8l &#21017;&#19981;&#38656;&#35201;&#25351;&#23450; +neon, &#22240;&#20026;</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">neon &#23545;&#20110; armv8l &#26159;&#24517;&#36873;&#25903;&#25345;</span>
        target=<span style="font-style: italic;">"llvm --device=arm_cpu -mtriple=armv7a-linux-gnueabihf -mattr=+neon"</span>,
        params=<span style="font-weight: bold; text-decoration: underline;">None</span>,
    )

lib.save(<span style="font-style: italic;">"/tmp/a.o"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">arm-linux-gnueabihf-objdump -d /tmp/a.o|tail -n 12
</pre>
</div>

<p>

</p>

<p>
000002a8 &lt;tvmgen_default_fused_add_compute_&gt;:
 2a8:	e3a02000 	mov	r2, #0
 2ac:	e0813002 	add	r3, r1, r2
 2b0:	f4630aef 	vld1.64	{d16-d17}, [r3 :128]
 2b4:	e0803002 	add	r3, r0, r2
 2b8:	f2400de0 	vadd.f32	q8, q8, q8
 2bc:	e2822010 	add	r2, r2, #16
 2c0:	e3520a01 	cmp	r2, #4096	; 0x1000
 2c4:	f4430aef 	vst1.64	{d16-d17}, [r3 :128]
 2c8:	1afffff7 	bne	2ac &lt;tvmgen_default_fused_add_compute_+0x4&gt;
 2cc:	e12fff1e 	bx	lr
</p>
</div>
</div>

<div id="outline-container-org8ee54f6" class="outline-5">
<h5 id="org8ee54f6"><span class="section-number-5">1.4.3.2</span> tensorize</h5>
<div class="outline-text-5" id="text-1-4-3-2">
<p>
<a href="https://stackoverflow.com/questions/2268562/what-are-intrinsics">what are intrinsics</a>
</p>

<p>
为了加速 arm_cpu 的 conv2d, TVM 会直接使用 neon 相关的 llvm_intrin 进行
tensorize, 例如:
</p>

<ul class="org-ul">
<li>llvm.aarch64.neon.sdot</li>
<li>llvm.aarch64.neon.udot</li>
<li>llvm.aarch64.neon.ummla</li>
<li>llvm.aarch64.neon.smmla</li>
<li>llvm.aarch64.neon.umull</li>
<li>llvm.aarch64.neon.smull</li>
<li>llvm.aarch64.neon.saddlp</li>
<li>llvm.aarch64.neon.uaddlp</li>
<li>llvm.aarch64.neon.addp</li>
<li>llvm.aarch64.neon.sqrdmulh</li>
<li>llvm.aarch64.neon.srshl</li>
<li>llvm.arm.neon.vpadd.v8i8</li>
<li>llvm.arm.neon.vpadd.v8u8</li>
<li>llvm.arm.neon.vpadals.v16i8.v8i16</li>
<li>llvm.arm.neon.vpadalu.v16u8.v8u16</li>
</ul>

<p>
最终 llvm 会生成对 ummla/smmla/udot/sdot 等指令的调用
</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2021-08-16 Mon 00:00<br />
Last updated: 2022-01-24 Mon 19:28</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
