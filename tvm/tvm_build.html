<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>TVM Build</title>


<link rel="stylesheet" type="text/css" href="/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="./htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="./readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
</head>
<body>
<div id="content" class="content">
<h1 class="title">TVM Build</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0000062">1. TVM Build</a>
<ul>
<li><a href="#org0000018">1.1. Relay Optimizations</a>
<ul>
<li><a href="#org0000000">1.1.1. Overview</a></li>
<li><a href="#org0000003">1.1.2. optimize</a></li>
<li><a href="#org0000012">1.1.3. PassContext</a></li>
<li><a href="#org0000015">1.1.4. Relay Transform</a></li>
</ul>
</li>
<li><a href="#org0000043">1.2. Relay IR -&gt; TE -&gt; TIR</a>
<ul>
<li><a href="#org000001b">1.2.1. Relay IR -&gt; OpRegistry</a></li>
<li><a href="#org000002d">1.2.2. OpRegistry -&gt; TE</a></li>
<li><a href="#org0000040">1.2.3. TE -&gt; TIR</a></li>
</ul>
</li>
<li><a href="#org000004b">1.3. TIR -&gt; Codegen</a>
<ul>
<li><a href="#org0000048">1.3.1. Example</a></li>
</ul>
</li>
<li><a href="#org000005f">1.4. Build Target</a>
<ul>
<li><a href="#org0000050">1.4.1. target 参数是如何被解析和使用的</a></li>
<li><a href="#org0000053">1.4.2. LLVMTargetToString</a></li>
<li><a href="#org000005c">1.4.3. arm_cpu 针对 arm 的特殊处理</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0000062" class="outline-2">
<h2 id="org0000062"><span class="section-number-2">1.</span> TVM Build</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0000018" class="outline-3">
<h3 id="org0000018"><span class="section-number-3">1.1.</span> Relay Optimizations</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org0000000" class="outline-4">
<h4 id="org0000000"><span class="section-number-4">1.1.1.</span> Overview</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> tvm.transform.PassContext<span class="org-parenthesis">(</span>
    opt_level<span class="org-operator">=</span>3<span class="org-parenthesis">,</span> disabled_pass<span class="org-operator">=</span>[]<span class="org-parenthesis">,</span> required_pass<span class="org-operator">=</span>[]<span class="org-parenthesis">,</span> config<span class="org-operator">=</span><span class="org-parenthesis">{}</span>
<span class="org-parenthesis">)</span>:
    <span class="org-variable-name">graph</span><span class="org-parenthesis">,</span> <span class="org-variable-name">lib</span><span class="org-parenthesis">,</span> <span class="org-variable-name">params</span> <span class="org-operator">=</span> relay.build<span class="org-parenthesis">(</span>mod<span class="org-parenthesis">,</span> target<span class="org-operator">=</span><span class="org-string">"c"</span><span class="org-parenthesis">,</span> params<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-parenthesis">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">build_module.py@relay:</span>
relay.build<span class="org-parenthesis">()</span>:
  <span class="org-variable-name">bld_mod</span> <span class="org-operator">=</span> BuildModule<span class="org-parenthesis">()</span>
  bld_mod.build<span class="org-parenthesis">(</span>mod<span class="org-operator">=</span>ir_mod<span class="org-parenthesis">,</span> target<span class="org-operator">=</span>target<span class="org-parenthesis">,</span> params<span class="org-operator">=</span>params<span class="org-parenthesis">,</span> executor<span class="org-operator">=</span>executor<span class="org-parenthesis">,</span>
                mod_name<span class="org-operator">=</span>mod_name<span class="org-parenthesis">)</span>
    <span class="org-keyword">self</span>._build<span class="org-parenthesis">(</span>mod<span class="org-parenthesis">,</span> target<span class="org-parenthesis">,</span> target_host<span class="org-parenthesis">,</span> executor<span class="org-parenthesis">,</span> mod_name<span class="org-parenthesis">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++">
<span class="org-preprocessor"># build_module</span>.cc@relay.backend
<span class="org-type">void</span> <span class="org-function-name">Build</span><span class="org-parenthesis">(</span><span class="org-type">IRModule</span> <span class="org-variable-name">mod</span><span class="org-parenthesis">,</span> <span class="org-keyword">const</span> <span class="org-type">TargetsMap</span>&amp; <span class="org-variable-name">targets</span><span class="org-parenthesis">,</span> <span class="org-keyword">const</span> <span class="org-constant">tvm</span>::<span class="org-type">Target</span>&amp; <span class="org-variable-name">target_host</span><span class="org-parenthesis">,</span>
             <span class="org-keyword">const</span> <span class="org-type">String</span> <span class="org-variable-name">executor</span><span class="org-parenthesis">,</span> <span class="org-keyword">const</span> <span class="org-type">String</span> <span class="org-variable-name">mod_name</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
  targets_ = targets;
  target_host_ = target_host;
  executor_ = executor;
  BuildRelay<span class="org-parenthesis">(</span>mod<span class="org-parenthesis">,</span> params_<span class="org-parenthesis">,</span> mod_name<span class="org-parenthesis">)</span>;

<span class="org-constant">BuildRelay</span>:
  relay_module = Optimize<span class="org-parenthesis">(</span>relay_module<span class="org-parenthesis">,</span> targets_<span class="org-parenthesis">,</span> params<span class="org-parenthesis">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000003" class="outline-4">
<h4 id="org0000003"><span class="section-number-4">1.1.2.</span> optimize</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
所有的针对 relay 的 optimizations pass 在 tvm::relay::transform 下.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-type">IRModule</span> <span class="org-function-name">Optimize</span><span class="org-parenthesis">(</span>
    <span class="org-type">IRModule</span> <span class="org-variable-name">relay_module</span><span class="org-parenthesis">,</span> <span class="org-keyword">const</span> <span class="org-type">TargetsMap</span>&amp; <span class="org-variable-name">targets</span><span class="org-parenthesis">,</span>
    <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">unordered_map</span>&lt;<span class="org-constant">std</span>::string<span class="org-parenthesis">,</span> <span class="org-constant">runtime</span>::NDArray&gt;&amp; <span class="org-variable-name">params</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-type">Array</span>&lt;Pass&gt; <span class="org-variable-name">pass_seqs</span> = GetPassPrefix<span class="org-parenthesis">(</span>targets<span class="org-parenthesis">,</span> <span class="org-constant">false</span><span class="org-parenthesis">)</span>;
    <span class="org-constant">transform</span>::<span class="org-type">Pass</span> <span class="org-variable-name">seq</span> = <span class="org-constant">transform</span>::Sequential<span class="org-parenthesis">(</span>pass_seqs<span class="org-parenthesis">)</span>;
    relay_module = seq<span class="org-parenthesis">(</span>relay_module<span class="org-parenthesis">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Handle heterogeneous compilation.</span>
    <span class="org-comment-delimiter">//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21482;&#26377; targets &#25351;&#23450;&#20102;&#22810;&#20010;&#26102;&#25165;&#20250;&#25191;&#34892; RunDeviceAnnotationPass, &#21363;&#22788;&#29702;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">on_device annotation, &#20363;&#22914; build vta &#26102;&#38656;&#35201;&#25351;&#23450;</span>
    <span class="org-comment-delimiter">//   </span><span class="org-comment">target={"cpu": env.target_vta_cpu, "ext_dev": env.target},</span>
    <span class="org-constant">transform</span>::<span class="org-type">PassContext</span> <span class="org-variable-name">pass_ctx</span> = <span class="org-constant">PassContext</span>::Current<span class="org-parenthesis">()</span>;
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>targets_.size<span class="org-parenthesis">()</span> &gt; 1<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
        <span class="org-type">Optional</span>&lt;Integer&gt; <span class="org-variable-name">opt_fallback_dev</span> = pass_ctx-&gt;GetConfig<span class="org-parenthesis">(</span>
            <span class="org-string">"relay.fallback_device_type"</span><span class="org-parenthesis">,</span> Integer<span class="org-parenthesis">(</span><span class="org-keyword">static_cast</span>&lt;<span class="org-type">int</span>&gt;<span class="org-parenthesis">(</span>kDLCPU<span class="org-parenthesis">)))</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">fallback_dev</span> = opt_fallback_dev.value<span class="org-parenthesis">()</span>;
        relay_module =
            RunDeviceAnnotationPass<span class="org-parenthesis">(</span>relay_module<span class="org-parenthesis">,</span> fallback_dev-&gt;value<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
    relay_module = <span class="org-constant">transform</span>::FuseOps<span class="org-parenthesis">()(</span>relay_module<span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
    relay_module = <span class="org-constant">transform</span>::Inline<span class="org-parenthesis">()(</span>relay_module<span class="org-parenthesis">)</span>;
    relay_module = <span class="org-constant">transform</span>::InferType<span class="org-parenthesis">()(</span>relay_module<span class="org-parenthesis">)</span>;
    relay_module = <span class="org-constant">transform</span>::LabelOps<span class="org-parenthesis">()(</span>relay_module<span class="org-parenthesis">)</span>;

    <span class="org-keyword">return</span> relay_module;
<span class="org-parenthesis">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-type">Array</span>&lt;Pass&gt; <span class="org-function-name">GetPassPrefix</span><span class="org-parenthesis">(</span>
    <span class="org-keyword">const</span> <span class="org-type">Map</span>&lt;<span class="org-constant">tvm</span>::Integer<span class="org-parenthesis">,</span> <span class="org-constant">tvm</span>::Target&gt;&amp; <span class="org-variable-name">targets</span><span class="org-parenthesis">,</span> <span class="org-type">bool</span> <span class="org-variable-name">is_vm</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-type">Array</span>&lt;Pass&gt; <span class="org-variable-name">pass_seqs</span>;
    <span class="org-type">Array</span>&lt;<span class="org-constant">runtime</span>::String&gt; <span class="org-variable-name">entry_functions</span><span class="org-parenthesis">{</span><span class="org-string">"main"</span><span class="org-parenthesis">}</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::RemoveUnusedFunctions<span class="org-parenthesis">(</span>entry_functions<span class="org-parenthesis">))</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::ToBasicBlockNormalForm<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">relay</span>::<span class="org-constant">qnn</span>::<span class="org-constant">transform</span>::Legalize<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::SimplifyInference<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::DynamicToStatic<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::EliminateCommonSubexpr<span class="org-parenthesis">(</span>fskip<span class="org-parenthesis">))</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::SimplifyExpr<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::CombineParallelConv2D<span class="org-parenthesis">(</span>3<span class="org-parenthesis">))</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::CombineParallelDense<span class="org-parenthesis">(</span>3<span class="org-parenthesis">))</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::CombineParallelBatchMatmul<span class="org-parenthesis">(</span>3<span class="org-parenthesis">))</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::FoldConstant<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::FoldScaleAxis<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::CanonicalizeCast<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::CanonicalizeOps<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::FastMath<span class="org-parenthesis">())</span>;
    pass_seqs.push_back<span class="org-parenthesis">(</span><span class="org-constant">transform</span>::FoldConstant<span class="org-parenthesis">())</span>;
    <span class="org-keyword">return</span> pass_seqs;
<span class="org-parenthesis">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0000012" class="outline-4">
<h4 id="org0000012"><span class="section-number-4">1.1.3.</span> PassContext</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
PassContext 可以控制 pass 的开关, 包括 relay 和 tir 相关的 pass. 有时会需要关掉某个 pass, 例如: batchnorm 正常会被 SimplifyInference Pass 转换成 mul/add, 也许对某些 target 有更高效的实现
</p>
</div>

<div id="outline-container-org0000006" class="outline-5">
<h5 id="org0000006"><span class="section-number-5">1.1.3.1.</span> opt_level</h5>
</div>

<div id="outline-container-org0000009" class="outline-5">
<h5 id="org0000009"><span class="section-number-5">1.1.3.2.</span> disabled_pass</h5>
</div>

<div id="outline-container-org000000c" class="outline-5">
<h5 id="org000000c"><span class="section-number-5">1.1.3.3.</span> required_pass</h5>
</div>

<div id="outline-container-org000000f" class="outline-5">
<h5 id="org000000f"><span class="section-number-5">1.1.3.4.</span> config</h5>
<div class="outline-text-5" id="text-1-1-3-4">
<div class="org-src-container">
<pre class="src src-c++">TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.noalias"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">)</span>;
TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.detect_global_barrier"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">)</span>;
TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.instrument_bound_checkers"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">)</span>;
TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.disable_assert"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">)</span>;
TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.disable_vectorize"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">)</span>;
TVM_REGISTER_PASS_CONFIG_OPTION<span class="org-parenthesis">(</span><span class="org-string">"tir.add_lower_pass"</span><span class="org-parenthesis">,</span> <span class="org-type">Array</span>&lt;<span class="org-type">Array</span>&lt;ObjectRef&gt;&gt;<span class="org-parenthesis">)</span>;
</pre>
</div>

<p>
<a href="tvm_vta.html#org0000001">tir.add_lower_pass</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org0000015" class="outline-4">
<h4 id="org0000015"><span class="section-number-4">1.1.4.</span> <a href="relay_transform.html#org0000036">Relay Transform</a></h4>
</div>
</div>

<div id="outline-container-org0000043" class="outline-3">
<h3 id="org0000043"><span class="section-number-3">1.2.</span> Relay IR -&gt; TE -&gt; TIR</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org000001b" class="outline-4">
<h4 id="org000001b"><span class="section-number-4">1.2.1.</span> Relay IR -&gt; OpRegistry</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>

</p>

<p>
Relay IR 例如 relay.op.sort() 返回的实际上是 Relay Expr:
tvm::relay::Call(Op::Get("sort"))
</p>
</div>
</div>

<div id="outline-container-org000002d" class="outline-4">
<h4 id="org000002d"><span class="section-number-4">1.2.2.</span> OpRegistry -&gt; TE</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<div id="outline-container-org000001e" class="outline-5">
<h5 id="org000001e"><span class="section-number-5">1.2.2.1.</span> BuildRelay</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">BuildRelay</span>:
  executor_codegen_ = MakeExecutorCodegen<span class="org-parenthesis">(</span>executor_<span class="org-parenthesis">)</span>;
  executor_codegen_-&gt;Init<span class="org-parenthesis">(</span><span class="org-constant">nullptr</span><span class="org-parenthesis">,</span> targets_<span class="org-parenthesis">)</span>;
  executor_codegen_-&gt;Codegen<span class="org-parenthesis">(</span>func<span class="org-parenthesis">,</span> mod_name<span class="org-parenthesis">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">lowered_module</span> = <span class="org-constant">tec</span>::LowerTE<span class="org-parenthesis">()</span>
  executor_codegen_-&gt;UpdateOutput<span class="org-parenthesis">(</span>&amp;ret_<span class="org-parenthesis">)</span>;
  ret_.params = executor_codegen_-&gt;GetParams<span class="org-parenthesis">()</span>;

  <span class="org-keyword">auto</span> <span class="org-variable-name">lowered_funcs</span> = executor_codegen_-&gt;GetIRModule<span class="org-parenthesis">()</span>;

</pre>
</div>
</div>
</div>

<div id="outline-container-org0000027" class="outline-5">
<h5 id="org0000027"><span class="section-number-5">1.2.2.2.</span> ExecutorCodegen</h5>
<div class="outline-text-5" id="text-1-2-2-2">
</div>
<div id="outline-container-org0000021" class="outline-6">
<h6 id="org0000021"><span class="section-number-6">1.2.2.2.1.</span> GraphExecutorCodegen</h6>
</div>

<div id="outline-container-org0000024" class="outline-6">
<h6 id="org0000024"><span class="section-number-6">1.2.2.2.2.</span> AOTExecutorCodegen</h6>
</div>
</div>

<div id="outline-container-org000002a" class="outline-5">
<h5 id="org000002a"><span class="section-number-5">1.2.2.3.</span> LowerTE</h5>
<div class="outline-text-5" id="text-1-2-2-3">
<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">LowerTE</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#37324; VisitExpr &#22788;&#29702;&#30340;&#37117;&#26159; Relay IR</span>
  LowerTensorExpr.VisitExpr<span class="org-parenthesis">()</span>
    LowerInternal<span class="org-parenthesis">()</span>
      <span class="org-keyword">auto</span> <span class="org-variable-name">cfunc</span> = PrimFuncFor<span class="org-parenthesis">(</span>key-&gt;source_func<span class="org-parenthesis">,</span> key-&gt;target<span class="org-parenthesis">,</span> [&amp;]<span class="org-parenthesis">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">mangled</span> = mangle_fn<span class="org-parenthesis">(</span>name<span class="org-parenthesis">)</span>;
        <span class="org-keyword">return</span> GetUniqueName<span class="org-parenthesis">(</span>mangled<span class="org-parenthesis">,</span> &amp;name_map_<span class="org-parenthesis">)</span>;
      <span class="org-parenthesis">})</span>;
        <span class="org-keyword">return</span> ScheduleBuilder<span class="org-parenthesis">(</span>target<span class="org-parenthesis">)</span>.Create<span class="org-parenthesis">(</span>source_func<span class="org-parenthesis">,</span> renamer<span class="org-parenthesis">)</span>;
          <span class="org-keyword">this</span>-&gt;VisitExpr<span class="org-parenthesis">(</span>prim_func-&gt;body<span class="org-parenthesis">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">VisitExpr_(xxx)</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#37324;&#20250;&#35843;&#29992;&#21040; python, &#26597;&#25214; strategy,</span>
            <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">flower_call</span> = <span class="org-constant">tvm</span>::<span class="org-constant">runtime</span>::<span class="org-constant">Registry</span>::Get<span class="org-parenthesis">(</span><span class="org-string">"relay.backend.lower_call"</span><span class="org-parenthesis">)</span>;
            <span class="org-type">LoweredOutput</span> <span class="org-variable-name">lowered_out</span> = <span class="org-parenthesis">(</span>*flower_call<span class="org-parenthesis">)(</span>GetRef&lt;Call&gt;<span class="org-parenthesis">(</span>call_node<span class="org-parenthesis">),</span> inputs<span class="org-parenthesis">,</span> target_<span class="org-parenthesis">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">!!! outputs &#26159; relay &#23545;&#24212;&#30340; te</span>
            outputs = lowered_out-&gt;outputs;
            <span class="org-comment-delimiter">// </span><span class="org-comment">!!! impl &#20013;&#21253;&#25324; schedule</span>
            impl = lowered_out-&gt;implementation;
  <span class="org-comment-delimiter">// </span><span class="org-comment">external functional, &#21442;&#32771;  [[file:tvm_byoc_codegen.org::*&#32534;&#35793; external functions][&#32534;&#35793; external functions]]</span>
  lowered_module.external_mods = compiler-&gt;LowerExternalFunctions<span class="org-parenthesis">()</span>;

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000040" class="outline-4">
<h4 id="org0000040"><span class="section-number-4">1.2.3.</span> TE -&gt; TIR</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
TE 是没有经过 schedule 的 TIR， 因为 te.compute 返回的已经是 TIR 了.
</p>

<p>
以下面代码为例：
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">M</span> <span class="org-operator">=</span> 10
<span class="org-variable-name">A</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> <span class="org-parenthesis">),</span> name<span class="org-operator">=</span><span class="org-string">"A"</span><span class="org-parenthesis">)</span>
<span class="org-variable-name">B</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> <span class="org-parenthesis">),</span> name<span class="org-operator">=</span><span class="org-string">"B"</span><span class="org-parenthesis">)</span>
<span class="org-keyword">import</span> ipdb; ipdb.set_trace<span class="org-parenthesis">()</span>
<span class="org-variable-name">C</span> <span class="org-operator">=</span> te.compute<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> <span class="org-parenthesis">),</span> <span class="org-keyword">lambda</span> x: A[x] <span class="org-operator">+</span> B[x]<span class="org-parenthesis">)</span>
</pre>
</div>

<p>
当 te.compute 返回后， C.op 是由 TIR 组成的 ComputeOp:
</p>

<p>
加了些 log 后打印出来的 ComputeOp 中的表达式类型为:
</p>
<pre class="example" id="org0000030">
&lt;Array&gt;
  &lt;tir.Add&gt;
    &lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}
    &lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}
</pre>

<p>
te.compute 执行时会直接执行 lambda 产生 Op, 具体过程依赖于 python 的 operator
overloading, 例如:
</p>

<ol class="org-ol">
<li>A 的类型为 Tensor, A[x] 会调用 Tensor.__getitem__, 产生一个 tir:ProducerLoad</li>
<li>A[x]+B[x] 会调用 ExprOp.__add__， 产生一个 tir::Add</li>
</ol>
</div>


<div id="outline-container-org0000034" class="outline-5">
<h5 id="org0000034"><span class="section-number-5">1.2.3.1.</span> Schedule</h5>
<div class="outline-text-5" id="text-1-2-3-1">
<p>
Schedule 的原理: <a href="tvm_schedule.html#org000003c">Schedule</a>
</p>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">LowerInternal</span> :
    <span class="org-comment-delimiter">// </span><span class="org-comment">LowerSchedule &#25226; TE &#26681;&#25454; schedule &#32763;&#35793;&#25104; TIR</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">tvm.build, tvm.lower &#20063;&#26159;&#35843;&#29992;&#30340;&#36825;&#20010;&#20989;&#25968;&#25226; te.schedule &#32763;&#35793;&#25104; TIR</span>
    cfunc-&gt;funcs-&gt;Update<span class="org-parenthesis">(</span>
        <span class="org-constant">tvm</span>::LowerSchedule<span class="org-parenthesis">(</span>cfunc-&gt;schedule<span class="org-parenthesis">,</span> all_args<span class="org-parenthesis">,</span> func_name<span class="org-parenthesis">,</span> binds<span class="org-parenthesis">))</span>;
</pre>
</div>

<p>
以一个简单的 split 为例:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding: utf-8 -*-</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2021-08-03 11:11</span>
<span class="org-keyword">import</span> tvm
<span class="org-keyword">from</span> tvm <span class="org-keyword">import</span> te

<span class="org-variable-name">M</span> <span class="org-operator">=</span> 10
<span class="org-variable-name">A</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,),</span> name<span class="org-operator">=</span><span class="org-string">"A"</span><span class="org-parenthesis">)</span>
<span class="org-variable-name">B</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,),</span> name<span class="org-operator">=</span><span class="org-string">"B"</span><span class="org-parenthesis">)</span>

<span class="org-variable-name">C</span> <span class="org-operator">=</span> te.compute<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,),</span> <span class="org-keyword">lambda</span> x: A[x] <span class="org-operator">+</span> B[x]<span class="org-parenthesis">)</span>
<span class="org-variable-name">s</span> <span class="org-operator">=</span> te.create_schedule<span class="org-parenthesis">(</span>C.op<span class="org-parenthesis">)</span>
s[C].split<span class="org-parenthesis">(</span>C.op.axis[0]<span class="org-parenthesis">,</span> factor<span class="org-operator">=</span>5<span class="org-parenthesis">)</span>

<span class="org-variable-name">f</span> <span class="org-operator">=</span> tvm.build<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> [A<span class="org-parenthesis">,</span> B<span class="org-parenthesis">,</span> C]<span class="org-parenthesis">,</span> target<span class="org-operator">=</span><span class="org-string">"c"</span><span class="org-parenthesis">,</span> name<span class="org-operator">=</span><span class="org-string">"hello"</span><span class="org-parenthesis">)</span>
</pre>
</div>
</div>

<div id="outline-container-org0000031" class="outline-6">
<h6 id="org0000031"><span class="section-number-6">1.2.3.1.1.</span> ScheduleToModule</h6>
<div class="outline-text-6" id="text-1-2-3-1-1">
<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">LowerSchedule</span>:
  <span class="org-type">IRModule</span> <span class="org-variable-name">mod</span> = ScheduleToModule<span class="org-parenthesis">(</span><span class="org-constant">std</span>::move<span class="org-parenthesis">(</span>sch<span class="org-parenthesis">),</span> args<span class="org-parenthesis">,</span> name<span class="org-parenthesis">,</span> binds<span class="org-parenthesis">)</span>;
  <span class="org-type">Array</span>&lt;<span class="org-constant">transform</span>::Pass&gt; <span class="org-variable-name">pass_list</span> = CreatePassList<span class="org-parenthesis">(</span>simple_mode<span class="org-parenthesis">,</span> <span class="org-constant">true</span><span class="org-parenthesis">)</span>;
  <span class="org-keyword">return</span> LowerWithPassList<span class="org-parenthesis">(</span>mod<span class="org-parenthesis">,</span> pass_list<span class="org-parenthesis">)</span>;

<span class="org-constant">ScheduleToModule</span>:
  <span class="org-comment-delimiter">// </span><span class="org-comment">InferBound &#26681;&#25454; split &#30340; factor &#24471;&#21040; itervar &#21450;&#20854;&#24490;&#29615;&#30340;&#33539;&#22260;&#65292; &#27604;&#22914;&#36825;&#37324;&#25171;&#21360;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20986; bounds &#30340;&#20449;&#24687;:</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">for (auto&amp; p : bounds) {</span>
  <span class="org-comment-delimiter">//     </span><span class="org-comment">LOG_INFO &lt;&lt; p.first &lt;&lt; p.second;</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">}</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360;&#20986;&#32467;&#26524;&#20026;:</span>
  <span class="org-comment-delimiter">// </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x.outer, )}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;2})}</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x, {&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;10})})}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;10})}</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">bound.cc:262: {&lt;tir.IterVar&gt;iter_var(x.inner, )}{&lt;Range&gt;range(min={&lt;IntImm&gt;0}, ext={&lt;IntImm&gt;5})}  </span>
  <span class="org-type">Map</span>&lt;<span class="org-constant">tir</span>::IterVar<span class="org-parenthesis">,</span> Range&gt; <span class="org-variable-name">bounds</span> = <span class="org-constant">te</span>::InferBound<span class="org-parenthesis">(</span>sch<span class="org-parenthesis">)</span>;
  <span class="org-constant">tir</span>::<span class="org-type">Stmt</span> <span class="org-variable-name">stmt</span> = <span class="org-constant">te</span>::ScheduleOps<span class="org-parenthesis">(</span>sch<span class="org-parenthesis">,</span> <span class="org-constant">std</span>::move<span class="org-parenthesis">(</span>bounds<span class="org-parenthesis">),</span> <span class="org-constant">false</span><span class="org-parenthesis">)</span>;
    body = MakePipeline<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> dom_map<span class="org-parenthesis">,</span> body<span class="org-parenthesis">,</span> debug_keep_trivial_loop<span class="org-parenthesis">)</span>;
      <span class="org-type">Stmt</span> <span class="org-variable-name">producer</span> = s-&gt;op-&gt;BuildProvide<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> dom_map<span class="org-parenthesis">,</span>  debug_keep_trivial_loop<span class="org-parenthesis">)</span>;
        MakeComputeStmt<span class="org-parenthesis">(</span><span class="org-keyword">this</span><span class="org-parenthesis">,</span> stage<span class="org-parenthesis">,</span> dom_map<span class="org-parenthesis">,</span> debug_ keep_trivial_loop<span class="org-parenthesis">)</span>;
          <span class="org-comment-delimiter">// </span><span class="org-comment">&#21021;&#22987; body &#20013;&#21482;&#26377;&#19968;&#26465; stmt, &#21363; lambda(x) :A[x]+B[x] &#36890;&#36807; compute &#29983;&#25104; &#30340; stmt</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">{&lt;tir.ProducerStore&gt;compute[{&lt;tir.Var&gt;x }] ={&lt;tir.Add&gt;({&lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}]} + {&lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}]})}</span>
          <span class="org-keyword">for</span> <span class="org-parenthesis">(</span><span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0; i &lt; self-&gt;body.size<span class="org-parenthesis">()</span>; ++i<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
            provides.emplace_back<span class="org-parenthesis">(</span>MakeProvide<span class="org-parenthesis">(</span>self<span class="org-parenthesis">,</span> stage-&gt;op.output<span class="org-parenthesis">(</span>i<span class="org-parenthesis">)))</span>;
          <span class="org-parenthesis">}</span> 
          <span class="org-comment-delimiter">// </span><span class="org-comment">MergeNest &#26368;&#32456;&#26681;&#25454; bounds (&#21363; dom_map)  &#29983;&#25104;&#39069;&#22806;&#30340;&#24490;&#29615;&#35821;&#21477;&#65292;</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">MergeNest &#36820;&#22238;&#30340; stmt &#20026;: </span>
          <span class="org-comment-delimiter">//  </span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">{&lt;tir.For&gt;for ({&lt;tir.Var&gt;x.outer}, {&lt;In tImm&gt;0}, {&lt;IntImm&gt;2}) {</span>
          <span class="org-comment-delimiter">//   </span><span class="org-comment">{&lt;tir.AttrStmt&gt;  // attr [{&lt;tir.IterV ar&gt;iter_var(x.outer, )}] loop_scope = {&lt;tir.Var&gt;x.outer}</span>
          <span class="org-comment-delimiter">//   </span><span class="org-comment">{&lt;tir.For&gt;  for ({&lt;tir.Var&gt;x.inner},  {&lt;IntImm&gt;0}, {&lt;IntImm&gt;5}) {</span>
          <span class="org-comment-delimiter">//     </span><span class="org-comment">{&lt;tir.AttrStmt&gt;    // attr [{&lt;tir.I terVar&gt;iter_var(x.inner, )}] loop_scope = {&lt;tir.Var&gt;x.inner}</span>
          <span class="org-comment-delimiter">//     </span><span class="org-comment">{&lt;tir.ProducerStore&gt;    compute[{&lt;t ir.Var&gt;x}] ={&lt;tir.Add&gt;({&lt;tir.ProducerLoad&gt;A[{&lt;tir.Var&gt;x}]} + {&lt;tir.ProducerLoad&gt;B[{&lt;tir.Var&gt;x}]})}}}</span>
          <span class="org-comment-delimiter">//   </span><span class="org-comment">}}}} </span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">}           </span>
          provide = MergeNest<span class="org-parenthesis">(</span>n.main_nest<span class="org-parenthesis">,</span> provide<span class="org-parenthesis">)</span>; 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org000003d" class="outline-5">
<h5 id="org000003d"><span class="section-number-5">1.2.3.2.</span> TIR Optimizations</h5>
<div class="outline-text-5" id="text-1-2-3-2">
</div>
<div id="outline-container-org0000037" class="outline-6">
<h6 id="org0000037"><span class="section-number-6">1.2.3.2.1.</span> LowerWithPassList</h6>
<div class="outline-text-6" id="text-1-2-3-2-1">
<p>
ScheduleToModule 得到 tir 后, LowerWithPassList 可以对 tir 做进一步的修改和优化,
每一种修改称为一个 pass, 针对 tir 的 pass 在 tvm::tir::transform 下
</p>

<p>
其中 tir.add_lower_pass 是用户自己添加的 pass, 通过 add_lower_pass 机制, 上层可以定制生成的 tir. VTA 就是通过 add_lower_pass 添加自定义的 pass, 把一个 tir (例如 tir.add) 转换为对 vta runtime 的调用的 (例如 VTAPushALUOp)
</p>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-type">Array</span>&lt;<span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::Pass&gt; <span class="org-function-name">CreatePassList</span><span class="org-parenthesis">(</span><span class="org-type">bool</span> <span class="org-variable-name">disable_loop_partition</span><span class="org-parenthesis">,</span> <span class="org-type">bool</span> <span class="org-variable-name">for_te_schedule</span><span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
  <span class="org-constant">transform</span>::<span class="org-type">PassContext</span> <span class="org-variable-name">pass_ctx</span> = <span class="org-constant">transform</span>::<span class="org-constant">PassContext</span>::Current<span class="org-parenthesis">()</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get any user-added passes</span>
  <span class="org-type">Array</span>&lt;<span class="org-type">Array</span>&lt;ObjectRef&gt;&gt; <span class="org-variable-name">add_lower_pass</span> =
      pass_ctx-&gt;GetConfig&lt;<span class="org-type">Array</span>&lt;<span class="org-type">Array</span>&lt;ObjectRef&gt;&gt;&gt;<span class="org-parenthesis">(</span><span class="org-string">"tir.add_lower_pass"</span><span class="org-parenthesis">,</span> Array&lt;<span class="org-type">Array</span>&lt;ObjectRef&gt;&gt;<span class="org-parenthesis">())</span>
          .value<span class="org-parenthesis">()</span>;

  <span class="org-type">Array</span>&lt;<span class="org-constant">transform</span>::Pass&gt; <span class="org-variable-name">user_lower_phase0</span> = Array&lt;<span class="org-constant">transform</span>::Pass&gt;<span class="org-parenthesis">()</span>;
  <span class="org-type">Array</span>&lt;<span class="org-constant">transform</span>::Pass&gt; <span class="org-variable-name">user_lower_phase1</span> = Array&lt;<span class="org-constant">transform</span>::Pass&gt;<span class="org-parenthesis">()</span>;
  <span class="org-type">Array</span>&lt;<span class="org-constant">transform</span>::Pass&gt; <span class="org-variable-name">user_lower_phase2</span> = Array&lt;<span class="org-constant">transform</span>::Pass&gt;<span class="org-parenthesis">()</span>;
  <span class="org-type">Array</span>&lt;<span class="org-constant">transform</span>::Pass&gt; <span class="org-variable-name">user_lower_phase3</span> = Array&lt;<span class="org-constant">transform</span>::Pass&gt;<span class="org-parenthesis">()</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">phase pasees is of the form</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">[[phase_number, pass], [phase_number, pass]... ]</span>
  <span class="org-keyword">for</span> <span class="org-parenthesis">(</span><span class="org-type">Array</span>&lt;ObjectRef&gt; <span class="org-variable-name">phase_pass</span> : add_lower_pass<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-keyword">const</span> <span class="org-type">IntImmNode</span>* <span class="org-variable-name">phase_num</span> = phase_pass[0].as&lt;<span class="org-type">IntImmNode</span>&gt;<span class="org-parenthesis">()</span>;
    ICHECK<span class="org-parenthesis">(</span>phase_num<span class="org-parenthesis">)</span>
        &lt;&lt; <span class="org-string">"Expected the first entry in the inner Array of tir.add_lower_pass to be an integer"</span>;
    <span class="org-type">int</span> <span class="org-variable-name">phase_num_val</span> = phase_num-&gt;value;

    CHECK_GE<span class="org-parenthesis">(</span>phase_num_val<span class="org-parenthesis">,</span> 0<span class="org-parenthesis">)</span>;

    <span class="org-keyword">const</span> <span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::<span class="org-type">PassNode</span>* <span class="org-variable-name">pass_node</span> = phase_pass[1].as&lt;<span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::<span class="org-type">PassNode</span>&gt;<span class="org-parenthesis">()</span>;
    <span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::<span class="org-type">Pass</span> <span class="org-variable-name">pass</span> = GetRef&lt;<span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::<span class="org-type">Pass</span>&gt;<span class="org-parenthesis">(</span>pass_node<span class="org-parenthesis">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Copy the pass into the correct phase</span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>phase_num_val == 0<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      user_lower_phase0.push_back<span class="org-parenthesis">(</span>pass<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>phase_num_val == 1<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      user_lower_phase1.push_back<span class="org-parenthesis">(</span>pass<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>phase_num_val == 2<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      user_lower_phase2.push_back<span class="org-parenthesis">(</span>pass<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>phase_num_val &gt;= 3<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      user_lower_phase3.push_back<span class="org-parenthesis">(</span>pass<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">}</span>
  <span class="org-parenthesis">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Construct the pass list, inserting the user provided passes at the end of the phase</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">PHASE 0</span>
  <span class="org-type">Array</span>&lt;<span class="org-constant">tvm</span>::<span class="org-constant">transform</span>::<span class="org-type">Pass</span>&gt; <span class="org-variable-name">pass_list</span> = user_lower_phase0;

  <span class="org-comment-delimiter">// </span><span class="org-comment">PHASE 1</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>for_te_schedule<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::InjectPrefetch<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::StorageFlatten<span class="org-parenthesis">(</span>64<span class="org-parenthesis">,</span> instrument_bound_checkers<span class="org-parenthesis">))</span>;
  <span class="org-parenthesis">}</span> <span class="org-keyword">else</span> <span class="org-parenthesis">{</span>
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::LowerInitBlock<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::PlanAndUpdateBufferAllocationLocation<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::ConvertBlocksToOpaque<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::CompactBufferAllocation<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::LowerMatchBuffer<span class="org-parenthesis">())</span>;
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::FlattenBuffer<span class="org-parenthesis">())</span>;
  <span class="org-parenthesis">}</span>
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::BF16Legalize<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::NarrowDataType<span class="org-parenthesis">(</span>32<span class="org-parenthesis">))</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::Simplify<span class="org-parenthesis">())</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Add user-defined phase-1 passes</span>
  pass_list.insert<span class="org-parenthesis">(</span>pass_list.end<span class="org-parenthesis">(),</span> user_lower_phase1.begin<span class="org-parenthesis">(),</span> user_lower_phase1.end<span class="org-parenthesis">())</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">PHASE 2</span>
  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span><span class="org-negation-char">!</span>disable_loop_partition<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::LoopPartition<span class="org-parenthesis">())</span>;
  <span class="org-parenthesis">}</span>

  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::VectorizeLoop<span class="org-parenthesis">(</span><span class="org-negation-char">!</span>disable_vectorize<span class="org-parenthesis">))</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::InjectVirtualThread<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::InjectDoubleBuffer<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::StorageRewrite<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::UnrollLoop<span class="org-parenthesis">())</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Add user-defined phase-2 passes</span>
  pass_list.insert<span class="org-parenthesis">(</span>pass_list.end<span class="org-parenthesis">(),</span> user_lower_phase2.begin<span class="org-parenthesis">(),</span> user_lower_phase2.end<span class="org-parenthesis">())</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">PHASE 3</span>
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::Simplify<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::RemoveNoOp<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::RewriteUnsafeSelect<span class="org-parenthesis">())</span>;
  pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::HoistIfThenElse<span class="org-parenthesis">())</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Add user-defined phase-3 passes</span>
  pass_list.insert<span class="org-parenthesis">(</span>pass_list.end<span class="org-parenthesis">(),</span> user_lower_phase3.begin<span class="org-parenthesis">(),</span> user_lower_phase3.end<span class="org-parenthesis">())</span>;

  <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>instrument_bound_checkers<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    pass_list.push_back<span class="org-parenthesis">(</span><span class="org-constant">tir</span>::<span class="org-constant">transform</span>::InstrumentBoundCheckers<span class="org-parenthesis">())</span>;
  <span class="org-parenthesis">}</span>
  <span class="org-keyword">return</span> pass_list;
<span class="org-parenthesis">}</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org000003a" class="outline-6">
<h6 id="org000003a"><span class="section-number-6">1.2.3.2.2.</span> </h6>
</div>
</div>
</div>
</div>

<div id="outline-container-org000004b" class="outline-3">
<h3 id="org000004b"><span class="section-number-3">1.3.</span> TIR -&gt; Codegen</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">BuildRelay</span>:
  ret_.mod = <span class="org-constant">tvm</span>::build<span class="org-parenthesis">(</span>lowered_funcs<span class="org-parenthesis">,</span> target_host_<span class="org-parenthesis">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">driver_api.cc</span>
<span class="org-constant">runtime</span>::<span class="org-type">Module</span> <span class="org-function-name">build</span><span class="org-parenthesis">(</span><span class="org-keyword">const</span> <span class="org-type">Map</span>&lt;Target<span class="org-parenthesis">,</span> IRModule&gt;&amp; <span class="org-variable-name">inputs_arg</span><span class="org-parenthesis">,</span> <span class="org-keyword">const</span> <span class="org-type">Target</span>&amp; <span class="org-variable-name">target_host_arg</span><span class="org-parenthesis">)</span> :
  <span class="org-keyword">for</span> <span class="org-parenthesis">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">it</span> : inputs<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
    <span class="org-keyword">if</span> <span class="org-parenthesis">(</span>mdevice-&gt;functions.size<span class="org-parenthesis">()</span> != 0<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
      device_modules.push_back<span class="org-parenthesis">(</span><span class="org-constant">codegen</span>::Build<span class="org-parenthesis">(</span>mdevice<span class="org-parenthesis">,</span> it.first<span class="org-parenthesis">))</span>;

  <span class="org-constant">runtime</span>::<span class="org-type">Module</span> <span class="org-variable-name">mhost</span> = <span class="org-constant">codegen</span>::Build<span class="org-parenthesis">(</span>mhost_all<span class="org-parenthesis">,</span> target_host<span class="org-parenthesis">)</span>;        

<span class="org-comment-delimiter">// </span><span class="org-comment">codegen.cc @ src/target/</span>
<span class="org-constant">runtime</span>::<span class="org-type">Module</span> <span class="org-variable-name">Build</span><span class="org-parenthesis">(</span>IRModule mod<span class="org-parenthesis">,</span> Target target<span class="org-parenthesis">)</span> <span class="org-parenthesis">{</span>
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">build_f_name</span> = <span class="org-string">"target.build."</span> + target-&gt;kind-&gt;name;
  <span class="org-keyword">const</span> <span class="org-type">PackedFunc</span>* <span class="org-variable-name">bf</span> = <span class="org-constant">runtime</span>::<span class="org-constant">Registry</span>::Get<span class="org-parenthesis">(</span>build_f_name<span class="org-parenthesis">)</span>;
  <span class="org-keyword">return</span> <span class="org-parenthesis">(</span>*bf<span class="org-parenthesis">)(</span>mod<span class="org-parenthesis">,</span> target<span class="org-parenthesis">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">"target.build.llvm" @ src/target/llvm/llvm_module.cc</span>
TVM_REGISTER_GLOBAL<span class="org-parenthesis">(</span><span class="org-string">"target.build.llvm"</span><span class="org-parenthesis">)</span>
    .set_body_typed<span class="org-parenthesis">(</span>[]<span class="org-parenthesis">(</span><span class="org-type">IRModule</span> <span class="org-variable-name">mod</span><span class="org-parenthesis">,</span> <span class="org-type">Target</span> <span class="org-variable-name">target</span><span class="org-parenthesis">)</span> -&gt; <span class="org-constant">runtime</span>::Module <span class="org-parenthesis">{</span>
      <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = make_object&lt;LLVMModuleNode&gt;<span class="org-parenthesis">()</span>;
      n-&gt;Init<span class="org-parenthesis">(</span>mod<span class="org-parenthesis">,</span> target<span class="org-parenthesis">)</span>;
      <span class="org-keyword">return</span> <span class="org-constant">runtime</span>::Module<span class="org-parenthesis">(</span>n<span class="org-parenthesis">)</span>;
    <span class="org-parenthesis">})</span>;

<span class="org-type">void</span> <span class="org-constant">LLVMModuleNode</span>::<span class="org-variable-name">Init</span><span class="org-parenthesis">(</span><span class="org-keyword">const</span> IRModule&amp; mod<span class="org-parenthesis">,</span> <span class="org-keyword">const</span> Target&amp; target<span class="org-parenthesis">)</span>:
  InitializeLLVM<span class="org-parenthesis">()</span>;
  tm_ = GetLLVMTargetMachine<span class="org-parenthesis">(</span>target<span class="org-parenthesis">)</span>;
  <span class="org-type">bool</span> <span class="org-variable-name">system_lib</span> = target-&gt;GetAttr&lt;Bool&gt;<span class="org-parenthesis">(</span><span class="org-string">"system-lib"</span><span class="org-parenthesis">)</span>.value_or<span class="org-parenthesis">(</span>Bool<span class="org-parenthesis">(</span><span class="org-constant">false</span><span class="org-parenthesis">))</span>;
  <span class="org-type">bool</span> <span class="org-variable-name">target_c_runtime</span> = <span class="org-parenthesis">(</span>target-&gt;GetAttr&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"runtime"</span><span class="org-parenthesis">)</span>.value_or<span class="org-parenthesis">(</span><span class="org-string">""</span><span class="org-parenthesis">)</span> == kTvmRuntimeCrt<span class="org-parenthesis">)</span>;
  ctx_ = <span class="org-constant">std</span>::make_shared&lt;<span class="org-constant">llvm</span>::LLVMContext&gt;<span class="org-parenthesis">()</span>;
  <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span>&lt;CodeGenLLVM&gt; <span class="org-variable-name">cg</span> = <span class="org-constant">CodeGenLLVM</span>::Create<span class="org-parenthesis">(</span>tm_.get<span class="org-parenthesis">())</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
  <span class="org-keyword">for</span> <span class="org-parenthesis">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">f</span> : funcs<span class="org-parenthesis">)</span>:
    cg-&gt;AddFunction<span class="org-parenthesis">(</span>f<span class="org-parenthesis">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">....</span>
  module_ = cg-&gt;Finish<span class="org-parenthesis">()</span>;  

</pre>
</div>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-comment-delimiter">// </span><span class="org-comment">codegen_llvm.cc @ src/target/llvm</span>
<span class="org-constant">AddFunction</span>:
  <span class="org-type">void</span> <span class="org-constant">CodeGenLLVM</span>::<span class="org-function-name">AddFunctionInternal</span><span class="org-parenthesis">(</span><span class="org-keyword">const</span> <span class="org-type">PrimFunc</span>&amp; <span class="org-variable-name">f</span><span class="org-parenthesis">,</span> <span class="org-type">bool</span> <span class="org-variable-name">ret_void</span><span class="org-parenthesis">)</span>:
    function_ = <span class="org-constant">llvm</span>::<span class="org-constant">Function</span>::Create<span class="org-parenthesis">(</span>ftype<span class="org-parenthesis">,</span> <span class="org-constant">llvm</span>::<span class="org-constant">Function</span>::ExternalLinkage<span class="org-parenthesis">,</span>
                                     global_symbol.value<span class="org-parenthesis">()</span>.<span class="org-keyword">operator</span> <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-parenthesis">(),</span> module_.get<span class="org-parenthesis">())</span>;
    <span class="org-keyword">this</span>-&gt;VisitStmt<span class="org-parenthesis">(</span>f-&gt;body<span class="org-parenthesis">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">.....</span>
      <span class="org-constant">CodeGenLLVM</span>::VisitStmt_<span class="org-parenthesis">()</span>
        MakeValue<span class="org-parenthesis">()</span>
          VisitExpr<span class="org-parenthesis">()</span>
            VisitExpr_<span class="org-parenthesis">()</span>
</pre>
</div>
</div>

<div id="outline-container-org0000048" class="outline-4">
<h4 id="org0000048"><span class="section-number-4">1.3.1.</span> Example</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
由于 relay.build 时无法看到对应的 TIR,
<a href="https://discuss.tvm.apache.org/t/capture-tensor-level-ir-and-schedule-from-relay/9630">https://discuss.tvm.apache.org/t/capture-tensor-level-ir-and-schedule-from-relay/9630</a>,
所以直接使用一段 TE 来展示 codegen 的过程
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding: utf-8 -*-</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2021-08-03 11:11</span>
<span class="org-keyword">import</span> tvm
<span class="org-keyword">from</span> tvm <span class="org-keyword">import</span> te

<span class="org-variable-name">M</span> <span class="org-operator">=</span> 10
<span class="org-variable-name">N</span> <span class="org-operator">=</span> 10
<span class="org-variable-name">A</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> N<span class="org-parenthesis">),</span> name<span class="org-operator">=</span><span class="org-string">"A"</span><span class="org-parenthesis">)</span>
<span class="org-variable-name">B</span> <span class="org-operator">=</span> te.placeholder<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> N<span class="org-parenthesis">),</span> name<span class="org-operator">=</span><span class="org-string">"B"</span><span class="org-parenthesis">)</span>
<span class="org-variable-name">C</span> <span class="org-operator">=</span> te.compute<span class="org-parenthesis">((</span>M<span class="org-parenthesis">,</span> N<span class="org-parenthesis">),</span> <span class="org-keyword">lambda</span> x<span class="org-parenthesis">,</span> y: A[x<span class="org-parenthesis">,</span> y] <span class="org-operator">+</span> B[x<span class="org-parenthesis">,</span> y]<span class="org-parenthesis">)</span>

<span class="org-variable-name">s</span> <span class="org-operator">=</span> te.create_schedule<span class="org-parenthesis">(</span>C.op<span class="org-parenthesis">)</span>
<span class="org-builtin">print</span><span class="org-parenthesis">(</span>tvm.lower<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> [A<span class="org-parenthesis">,</span> B<span class="org-parenthesis">,</span> C]<span class="org-parenthesis">))</span>
<span class="org-variable-name">f</span> <span class="org-operator">=</span> tvm.build<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> [A<span class="org-parenthesis">,</span> B<span class="org-parenthesis">,</span> C]<span class="org-parenthesis">,</span> target <span class="org-operator">=</span> <span class="org-string">"c"</span><span class="org-parenthesis">,</span> name <span class="org-operator">=</span> <span class="org-string">"hello"</span><span class="org-parenthesis">)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">print(f.get_source())</span>
</pre>
</div>

<p>
primfn(A_1: handle, B_1: handle, compute_1: handle) -&gt; ()
  attr = {"global_symbol": "main", "tir.noalias": True}
  buffers = {A: Buffer(A_2: Pointer(float32), float32, [10, 10], []),
             compute: Buffer(compute_2: Pointer(float32), float32, [10, 10], []),
             B: Buffer(B_2: Pointer(float32), float32, [10, 10], [])}
  buffer_map = {A_1: A, B_1: B, compute_1: compute} {
  for (x: int32, 0, 10) {
    for (y: int32, 0, 10) {
      compute_2[((x*10) + y)] = ((float32*)A_2[((x*10) + y)] + (float32*)B_2[((x*10) + y)])
    }
  }
}
</p>

<p>
下面的 log 展示的是 codegen_c.cc 生成如下的 TE 的过程
</p>

<pre class="example" id="org0000046">
for (x: int32, 0, 10) {
  for (y: int32, 0, 10) {
    compute_2[((x*10) + y)] = ((float32*)A_2[((x*10) + y)] + (float32*)B_2[((x*10) + y)])
  }
}
</pre>

<pre class="example" id="org0000047">
tvm/src/target/source/codegen_c.cc:920: &gt;&gt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:469:   VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:922:   extent: 10
tvm/src/target/source/codegen_c.cc:925:   vid: x name_hint: x
tvm/src/target/source/codegen_c.cc:920:   &gt;&gt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:469:     VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:922:     extent: 10
tvm/src/target/source/codegen_c.cc:925:     vid: y name_hint: y
tvm/src/target/source/codegen_c.cc:754:     &gt;&gt;VisitStmt_:StoreNode
tvm/src/target/source/codegen_c.cc:526:       &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:159:         &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:           &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:             &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:               VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:             &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:           &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:         &lt;&lt;GetBufferRef:((float*)A)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:159:         &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:           &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:             &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:               VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:             &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:           &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:         &lt;&lt;GetBufferRef:((float*)B)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:528:       &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:758:     &lt;&lt;VisitStmt_:StoreNode: (((float*)A)[(((x * 10) + y))] + ((float*)B)[(((x * 10) + y))])
tvm/src/target/source/codegen_c.cc:159:     &gt;&gt;GetBufferRef
tvm/src/target/source/codegen_c.cc:526:       &gt;&gt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:534:         &gt;&gt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:469:           VisitExpr_: IntImmNode: 10
tvm/src/target/source/codegen_c.cc:536:         &lt;&lt;VisitExpr_:MUL
tvm/src/target/source/codegen_c.cc:528:       &lt;&lt;VisitExpr_:ADD
tvm/src/target/source/codegen_c.cc:231:     &lt;&lt;GetBufferRef:((float*)compute)[(((x * 10) + y))]
tvm/src/target/source/codegen_c.cc:935:   &lt;&lt;VisitStmt_:ForNode
tvm/src/target/source/codegen_c.cc:935: &lt;&lt;VisitStmt_:ForNode

</pre>
</div>
</div>
</div>

<div id="outline-container-org000005f" class="outline-3">
<h3 id="org000005f"><span class="section-number-3">1.4.</span> Build Target</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org0000050" class="outline-4">
<h4 id="org0000050"><span class="section-number-4">1.4.1.</span> target 参数是如何被解析和使用的</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
build 时的 target 参数, 例如
</p>

<pre class="example" id="org000004e">
llvm --device=arm_cpu --mtriple=armv7a-linux-gnueabihf,
</pre>

<p>
会通过 TargetInternal::FromConfig 进行解析, 变成一个 Target 对象, 打印出来是
</p>

<pre class="example" id="org000004f">
llvm -keys=arm_cpu,cpu -device=arm_cpu -link-params=0 -mtriple=armv7a-linux-gnueabihf
</pre>

<p>
keys 中的 `arm_cpu, cpu` 是 TargetInternal::FromConfig 补上去的.
</p>

<p>
后续代码可能会根据需求访问 target 中的成员, 例如 x86 相关的 topi 会通过 "mcpu"
成员确定 simd 宽度:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">get_simd_32bit_lanes</span><span class="org-parenthesis">()</span>:
    <span class="org-variable-name">mcpu</span> <span class="org-operator">=</span> tvm.target.Target.current<span class="org-parenthesis">()</span>.mcpu
    <span class="org-variable-name">fp32_vec_len</span> <span class="org-operator">=</span> 4
    <span class="org-keyword">if</span> target_has_avx512<span class="org-parenthesis">(</span>mcpu<span class="org-parenthesis">)</span>:
        <span class="org-variable-name">fp32_vec_len</span> <span class="org-operator">=</span> 16
    <span class="org-keyword">elif</span> target_has_avx2<span class="org-parenthesis">(</span>mcpu<span class="org-parenthesis">)</span>:
        <span class="org-variable-name">fp32_vec_len</span> <span class="org-operator">=</span> 8
    <span class="org-keyword">return</span> fp32_vec_len
</pre>
</div>

<p>
Target 的支持的成员通过 target_kind 定义的, 主要包括:
</p>

<ol class="org-ol">
<li>kind</li>
<li>keys</li>
<li>device</li>
<li>mcpu</li>
<li>mtriple</li>
<li>runtime</li>
<li>system-lib</li>
</ol>

<div class="org-src-container">
<pre class="src src-C++">TVM_REGISTER_TARGET_KIND<span class="org-parenthesis">(</span><span class="org-string">"llvm"</span><span class="org-parenthesis">,</span> kDLCPU<span class="org-parenthesis">)</span>
    .add_attr_option&lt;<span class="org-type">Array</span>&lt;String&gt;&gt;<span class="org-parenthesis">(</span><span class="org-string">"mattr"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"mcpu"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"mtriple"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"mfloat-abi"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"mabi"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;Bool&gt;<span class="org-parenthesis">(</span><span class="org-string">"system-lib"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"runtime"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;Bool&gt;<span class="org-parenthesis">(</span><span class="org-string">"link-params"</span><span class="org-parenthesis">,</span> Bool<span class="org-parenthesis">(</span><span class="org-constant">false</span><span class="org-parenthesis">))</span>
    .add_attr_option&lt;Bool&gt;<span class="org-parenthesis">(</span><span class="org-string">"unpacked-api"</span><span class="org-parenthesis">)</span>
    .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"interface-api"</span><span class="org-parenthesis">)</span>
    .set_default_keys<span class="org-parenthesis">({</span><span class="org-string">"cpu"</span><span class="org-parenthesis">})</span>;

<span class="org-preprocessor">#define</span> <span class="org-function-name">TVM_REGISTER_TARGET_KIND</span><span class="org-parenthesis">(</span><span class="org-variable-name">TargetKindName</span><span class="org-parenthesis">,</span> <span class="org-variable-name">DeviceType</span><span class="org-parenthesis">)</span>      \
  TVM_STR_CONCAT<span class="org-parenthesis">(</span>TVM_TARGET_KIND_REGISTER_VAR_DEF<span class="org-parenthesis">,</span> __COUNTER__<span class="org-parenthesis">)</span> = \
      ::<span class="org-constant">tvm</span>::<span class="org-constant">TargetKindRegEntry</span>::RegisterOrGet<span class="org-parenthesis">(</span>TargetKindName<span class="org-parenthesis">)</span>    \
          .set_name<span class="org-parenthesis">()</span>                                             \
          .set_device_type<span class="org-parenthesis">(</span>DeviceType<span class="org-parenthesis">)</span>                            \
          .add_attr_option&lt;Array&lt;String&gt;&gt;<span class="org-parenthesis">(</span><span class="org-string">"keys"</span><span class="org-parenthesis">)</span>                 \
          .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"tag"</span><span class="org-parenthesis">)</span>                         \
          .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"device"</span><span class="org-parenthesis">)</span>                      \
          .add_attr_option&lt;String&gt;<span class="org-parenthesis">(</span><span class="org-string">"model"</span><span class="org-parenthesis">)</span>                       \
          .add_attr_option&lt;Array&lt;String&gt;&gt;<span class="org-parenthesis">(</span><span class="org-string">"libs"</span><span class="org-parenthesis">)</span>                 \
          .add_attr_option&lt;Target&gt;<span class="org-parenthesis">(</span><span class="org-string">"host"</span><span class="org-parenthesis">)</span>                        \
          .add_attr_option&lt;Integer&gt;<span class="org-parenthesis">(</span><span class="org-string">"from_device"</span><span class="org-parenthesis">)</span>

<span class="org-parenthesis">}</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">namespace tvm</span>

</pre>
</div>

<p>
Target 中最重要的成员是 kind 和 keys:
</p>

<ol class="org-ol">
<li><p>
kind 决定了 target codegen
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">build_f_name</span> = <span class="org-string">"target.build."</span> + target-&gt;kind-&gt;name;
</pre>
</div></li>

<li>keys 决定了查找哪些 strategy
<code>tvm/python/tvm/target/generic_func.py::for k in target.keys:</code></li>
</ol>
</div>
</div>

<div id="outline-container-org0000053" class="outline-4">
<h4 id="org0000053"><span class="section-number-4">1.4.2.</span> LLVMTargetToString</h4>
</div>

<div id="outline-container-org000005c" class="outline-4">
<h4 id="org000005c"><span class="section-number-4">1.4.3.</span> arm_cpu 针对 arm 的特殊处理</h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<div id="outline-container-org0000056" class="outline-5">
<h5 id="org0000056"><span class="section-number-5">1.4.3.1.</span> vectorize</h5>
<div class="outline-text-5" id="text-1-4-3-1">
<p>
<a href="https://community.arm.com/arm-community-blogs/b/operating-systems-blog/posts/arm-neon-programming-quick-reference">https://community.arm.com/arm-community-blogs/b/operating-systems-blog/posts/arm-neon-programming-quick-reference</a>
</p>

<p>
neon 最多支持 16 字节的向量操作, 所以 tvm 使用 vectorize shedule 时需要使用特定大小的 split
</p>

<p>
arm_cpu 对应的 schedule_injective 为:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">schedule_injective</span><span class="org-parenthesis">(</span>outs<span class="org-parenthesis">)</span>:
    <span class="org-variable-name">outs</span> <span class="org-operator">=</span> [outs] <span class="org-keyword">if</span> <span class="org-builtin">isinstance</span><span class="org-parenthesis">(</span>outs<span class="org-parenthesis">,</span> te.tensor.Tensor<span class="org-parenthesis">)</span> <span class="org-keyword">else</span> outs
    <span class="org-variable-name">s</span> <span class="org-operator">=</span> te.create_schedule<span class="org-parenthesis">(</span>[x.op <span class="org-keyword">for</span> x <span class="org-keyword">in</span> outs]<span class="org-parenthesis">)</span>
    <span class="org-variable-name">x</span> <span class="org-operator">=</span> outs[0]

    <span class="org-keyword">if</span> <span class="org-builtin">list</span><span class="org-parenthesis">(</span>s[x].op.axis<span class="org-parenthesis">)</span>:
        <span class="org-comment-delimiter"># </span><span class="org-comment">split &#22823;&#23567;&#20026; 4, &#22240;&#20026; 4 &#20010; float32 &#30340;&#22823;&#23567;&#21363;&#20026; 16</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#36825;&#37324;&#30340;&#20195;&#30721;&#26377;&#38382;&#39064;: &#33509;&#25968;&#25454;&#31867;&#22411;&#26159; int8, &#36825;&#37324;&#30340; split &#35774;&#32622;&#20026; 16 &#24615;&#33021;&#25165;&#26159;&#26368;&#22909;&#30340;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">https://github.com/apache/tvm/pull/9339</span>
        <span class="org-parenthesis">(</span><span class="org-variable-name">io</span><span class="org-parenthesis">,</span> <span class="org-variable-name">ii</span><span class="org-parenthesis">)</span> <span class="org-operator">=</span> s[x].split<span class="org-parenthesis">(</span><span class="org-builtin">list</span><span class="org-parenthesis">(</span>s[x].op.axis<span class="org-parenthesis">)</span>[<span class="org-operator">-</span>1]<span class="org-parenthesis">,</span> 4<span class="org-parenthesis">)</span>
        s[x].vectorize<span class="org-parenthesis">(</span>ii<span class="org-parenthesis">)</span>
    tvm.te.schedule.AutoInlineInjective<span class="org-parenthesis">(</span>s<span class="org-parenthesis">)</span>

    <span class="org-keyword">if</span> <span class="org-keyword">not</span> is_empty_shape<span class="org-parenthesis">(</span>x.shape<span class="org-parenthesis">)</span>:
        schedule_injective_from_existing<span class="org-parenthesis">(</span>s<span class="org-parenthesis">,</span> x<span class="org-parenthesis">)</span>
    <span class="org-keyword">return</span> s

</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding: utf-8 -*-</span>
<span class="org-keyword">import</span> tvm
<span class="org-keyword">from</span> tvm <span class="org-keyword">import</span> relay

<span class="org-variable-name">x</span> <span class="org-operator">=</span> relay.var<span class="org-parenthesis">(</span><span class="org-string">"x"</span><span class="org-parenthesis">,</span> shape<span class="org-operator">=</span><span class="org-parenthesis">(</span>1<span class="org-parenthesis">,</span> 1024<span class="org-parenthesis">),</span> dtype<span class="org-operator">=</span><span class="org-string">"float32"</span><span class="org-parenthesis">)</span>
<span class="org-variable-name">y</span> <span class="org-operator">=</span> relay.add<span class="org-parenthesis">(</span>x<span class="org-parenthesis">,</span> x<span class="org-parenthesis">)</span>
<span class="org-variable-name">func</span> <span class="org-operator">=</span> relay.Function<span class="org-parenthesis">(</span>[x]<span class="org-parenthesis">,</span> y<span class="org-parenthesis">)</span>
<span class="org-variable-name">mod</span> <span class="org-operator">=</span> tvm.IRModule.from_expr<span class="org-parenthesis">(</span>func<span class="org-parenthesis">)</span>

<span class="org-keyword">with</span> tvm.transform.PassContext<span class="org-parenthesis">(</span>opt_level<span class="org-operator">=</span>3<span class="org-parenthesis">)</span>:
    <span class="org-variable-name">graph</span><span class="org-parenthesis">,</span> <span class="org-variable-name">lib</span><span class="org-parenthesis">,</span> <span class="org-variable-name">params</span> <span class="org-operator">=</span> relay.build<span class="org-parenthesis">(</span>
        mod<span class="org-parenthesis">,</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">target &#20013;&#30340; `-mtriple=armv7a-linux-gnueabihf -mattr=+neon` &#20250;&#30452;&#25509;&#20256;&#32473; llvm</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">(LLVMTargetToString), &#20854;&#20013;armv7a &#30340; neon &#26159;&#21487;&#36873;&#25903;&#25345;, &#25152;&#20197;&#19981;&#20351;&#29992; +neon</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#30340;&#35805; llvm &#20250;&#20351;&#29992; vfp. &#22914;&#26524; triple &#25913;&#25104; armv8l &#21017;&#19981;&#38656;&#35201;&#25351;&#23450; +neon, &#22240;&#20026;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">neon &#23545;&#20110; armv8l &#26159;&#24517;&#36873;&#25903;&#25345;</span>
        target<span class="org-operator">=</span><span class="org-string">"llvm --device=arm_cpu -mtriple=armv7a-linux-gnueabihf -mattr=+neon"</span><span class="org-parenthesis">,</span>
        params<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-parenthesis">,</span>
    <span class="org-parenthesis">)</span>

lib.save<span class="org-parenthesis">(</span><span class="org-string">"/tmp/a.o"</span><span class="org-parenthesis">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">arm-linux-gnueabihf-objdump -d /tmp/a.o|tail -n 12
</pre>
</div>

<p>

</p>

<p>
000002a8 &lt;tvmgen_default_fused_add_compute_&gt;:
 2a8:	e3a02000 	mov	r2, #0
 2ac:	e0813002 	add	r3, r1, r2
 2b0:	f4630aef 	vld1.64	{d16-d17}, [r3 :128]
 2b4:	e0803002 	add	r3, r0, r2
 2b8:	f2400de0 	vadd.f32	q8, q8, q8
 2bc:	e2822010 	add	r2, r2, #16
 2c0:	e3520a01 	cmp	r2, #4096	; 0x1000
 2c4:	f4430aef 	vst1.64	{d16-d17}, [r3 :128]
 2c8:	1afffff7 	bne	2ac &lt;tvmgen_default_fused_add_compute_+0x4&gt;
 2cc:	e12fff1e 	bx	lr
</p>
</div>
</div>

<div id="outline-container-org0000059" class="outline-5">
<h5 id="org0000059"><span class="section-number-5">1.4.3.2.</span> tensorize</h5>
<div class="outline-text-5" id="text-1-4-3-2">
<p>
<a href="https://stackoverflow.com/questions/2268562/what-are-intrinsics">what are intrinsics</a>
</p>

<p>
为了加速 arm_cpu 的 conv2d, TVM 会直接使用 neon 相关的 llvm_intrin 进行
tensorize, 例如:
</p>

<ul class="org-ul">
<li>llvm.aarch64.neon.sdot</li>
<li>llvm.aarch64.neon.udot</li>
<li>llvm.aarch64.neon.ummla</li>
<li>llvm.aarch64.neon.smmla</li>
<li>llvm.aarch64.neon.umull</li>
<li>llvm.aarch64.neon.smull</li>
<li>llvm.aarch64.neon.saddlp</li>
<li>llvm.aarch64.neon.uaddlp</li>
<li>llvm.aarch64.neon.addp</li>
<li>llvm.aarch64.neon.sqrdmulh</li>
<li>llvm.aarch64.neon.srshl</li>
<li>llvm.arm.neon.vpadd.v8i8</li>
<li>llvm.arm.neon.vpadd.v8u8</li>
<li>llvm.arm.neon.vpadals.v16i8.v8i16</li>
<li>llvm.arm.neon.vpadalu.v16u8.v8u16</li>
</ul>

<p>
最终 llvm 会生成对 ummla/smmla/udot/sdot 等指令的调用
</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway@dogdog.run<br />
Date: 2021-08-16 Mon 00:00<br />
Last updated: 2023-12-01 Fri 18:10</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</div>
</body>
</html>