<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Kalman Filter</title>

<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="../main.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Kalman Filter</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org000002c">1. Kalman Filter</a>
<ul>
<li><a href="#org000000d">1.1. Overview</a>
<ul>
<li><a href="#org0000001">1.1.1. 初始化</a></li>
<li><a href="#org0000004">1.1.2. measure</a></li>
<li><a href="#org0000007">1.1.3. correct</a></li>
<li><a href="#org000000a">1.1.4. predict</a></li>
</ul>
</li>
<li><a href="#org0000018">1.2. Example</a>
<ul>
<li><a href="#org0000011">1.2.1. constant dynamics</a></li>
<li><a href="#org0000015">1.2.2. non-constant dynamics</a></li>
</ul>
</li>
<li><a href="#org000001f">1.3. 多维 kalman filter</a></li>
<li><a href="#org0000026">1.4. cv2.KalmanFilter</a>
<ul>
<li><a href="#org0000023">1.4.1. 匀速运动的小车</a></li>
<li><a href="#org000001b">1.4.2. 跟踪鼠标</a></li>
</ul>
</li>
<li><a href="#org0000029">1.5. HMM vs. Kalman Filter</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org000002c" class="outline-2">
<h2 id="org000002c"><span class="section-number-2">1</span> Kalman Filter</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://www.kalmanfilter.net/CN/default_cn.aspx">https://www.kalmanfilter.net/CN/default_cn.aspx</a>
</p>

<p>
<a href="https://stackoverflow.com/questions/43377626/how-to-use-kalman-filter-in-python-for-location-data">https://stackoverflow.com/questions/43377626/how-to-use-kalman-filter-in-python-for-location-data</a>
</p>

<p>
<a href="https://www.bilibili.com/video/BV1TW411N7Hg/">https://www.bilibili.com/video/BV1TW411N7Hg/</a>
</p>

<p>
<a href="http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/">http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/</a>
</p>
</div>

<div id="outline-container-org000000d" class="outline-3">
<h3 id="org000000d"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>\(K_n=\frac{p_{n-1}}{p_{n-1}+r_{n}}\)</li>

<li>\(p_n=(1-K_n)p_{n-1}\)</li>

<li>\(\hat{x}_n=(1-K_n)\hat{x}_{n-1}+K_nZ_n\)</li>

<li>\(\hat{x}_n = \hat{x}_{n-1}\)</li>

<li>\(p_n = p_{n-1}\)</li>
</ol>



<div id="org0000000" class="figure">
<p><img src="../extra/kalman_filter.png" alt="kalman_filter.png" />
</p>
</div>
</div>

<div id="outline-container-org0000001" class="outline-4">
<h4 id="org0000001"><span class="section-number-4">1.1.1</span> 初始化</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
kalman filter update 时需要的前一时刻的数据, 包含:
</p>

<ol class="org-ol">
<li>\(p_{n-1}\) predicted variance</li>
<li>\(X_{n-1}\) predicted state</li>
</ol>
</div>
</div>

<div id="outline-container-org0000004" class="outline-4">
<h4 id="org0000004"><span class="section-number-4">1.1.2</span> measure</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
通过 measure 获得:
</p>

<ol class="org-ol">
<li>\(r_n\) measured variance</li>
<li>\(Z_n\) measured state</li>
</ol>
</div>
</div>

<div id="outline-container-org0000007" class="outline-4">
<h4 id="org0000007"><span class="section-number-4">1.1.3</span> correct</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
通过 measured 来更正 predicted
</p>

<ul class="org-ul">
<li>通过公式 1 计算 \(K_n\)</li>
<li>通过公式 2 计算 \(p_n\)</li>
<li>通过公式 3 计算 \(\hat{x}_n\)</li>
</ul>
</div>
</div>

<div id="outline-container-org000000a" class="outline-4">
<h4 id="org000000a"><span class="section-number-4">1.1.4</span> predict</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
根据系统的 dynamics 预测 x, p
</p>

<p>
若系统是 constant dynamics, 则不需要 predict, 直接 \(x_{n}=x_{n-1}\)
</p>
</div>
</div>
</div>

<div id="outline-container-org0000018" class="outline-3">
<h3 id="org0000018"><span class="section-number-3">1.2</span> Example</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0000011" class="outline-4">
<h4 id="org0000011"><span class="section-number-4">1.2.1</span> constant dynamics</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt

<span class="org-variable-name">t</span> = np.arange(50)
<span class="org-variable-name">position</span> = np.ones(50)

<span class="org-variable-name">STD_POSITION</span> = 10
<span class="org-variable-name">poisy_position</span> = position + np.random.normal(0, STD_POSITION, size=(position.shape[0]))

plt.plot(t, position, label=<span class="org-string">"truth position"</span>)
plt.plot(t, poisy_position, label=<span class="org-string">"measured"</span>)

<span class="org-variable-name">predicts</span> = [poisy_position[0]]
<span class="org-variable-name">position_predict</span> = predicts[0]

<span class="org-variable-name">p</span> = 100
<span class="org-variable-name">r</span> = STD_POSITION ** 2
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, 50):
    <span class="org-variable-name">k</span> = p / (p + r)
    <span class="org-variable-name">position_predict</span> = position_predict * (1 - k) + poisy_position[i] * k
    <span class="org-variable-name">p</span> = (1 - k) * p
    predicts.append(position_predict)

plt.plot(t, predicts, label=<span class="org-string">"kalman"</span>)

plt.legend()
plt.show()
</pre>
</div>


<div id="org0000010" class="figure">
<p><img src="../extra/kalman_filter_simple1.png" alt="kalman_filter_simple1.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org0000015" class="outline-4">
<h4 id="org0000015"><span class="section-number-4">1.2.2</span> non-constant dynamics</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt

<span class="org-variable-name">t</span> = np.linspace(1, 100, 100)
<span class="org-variable-name">a</span> = 5
<span class="org-variable-name">position</span> = 10 * t + 1

<span class="org-variable-name">STD_POSITION</span> = 100
<span class="org-variable-name">STD_IMU</span> = 30

<span class="org-variable-name">poisy_position</span> = position + np.random.normal(0, STD_POSITION, size=(t.shape[0]))

plt.plot(t, position, label=<span class="org-string">"truth position"</span>)
plt.plot(t, poisy_position, label=<span class="org-string">"measured"</span>)

<span class="org-variable-name">predicts</span> = [poisy_position[0]]
<span class="org-variable-name">position_predict</span> = predicts[0]

<span class="org-variable-name">p</span> = 0
<span class="org-variable-name">r</span> = STD_POSITION ** 2
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, 100):

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------measure</span>
    <span class="org-variable-name">dv</span> = (position[i] - position[i - 1]) + np.random.normal(0, STD_IMU)

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------predict</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#26681;&#25454; dynamics &#26469;&#26356;&#26032; position_predict &#21644; p</span>
    <span class="org-variable-name">position_predict</span> = position_predict + dv
    <span class="org-comment-delimiter"># </span><span class="org-comment">aX+bY &#20173;&#26159;&#27491;&#24120;&#20998;&#24067;, &#19988;&#26041;&#24046;&#20026; a^2*variance(X) + b^2*variance(Y)</span>
    <span class="org-variable-name">p</span> += STD_IMU ** 2

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------update</span>
    <span class="org-variable-name">k</span> = p / (p + r)
    <span class="org-variable-name">position_predict</span> = position_predict * (1 - k) + poisy_position[i] * k
    <span class="org-variable-name">p</span> = (1 - k) * p
    predicts.append(position_predict)


plt.plot(t, predicts, label=<span class="org-string">"kalman"</span>)

plt.legend()
plt.show()
</pre>
</div>


<div id="org0000014" class="figure">
<p><img src="../extra/kalman_filter_simple.png" alt="kalman_filter_simple.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org000001f" class="outline-3">
<h3 id="org000001f"><span class="section-number-3">1.3</span> 多维 kalman filter</h3>
<div class="outline-text-3" id="text-1-3">
<p>
以一个在一维空间里匀速运动的小车为例:
</p>

<ol class="org-ol">
<li>z,x 变为 2x1 矩阵 [[x],[v]]</li>

<li>需要一个 F 描述 dynamics, 设 dynamics 为: x = x+v*dt, v=v, 则 F =
[[1,dt],[0,1]]</li>

<li>p,r 变为 2x2 矩阵, 是一个关于 x,v 的协方差矩阵, 例如 r=[[A,0],[0,B]], 表示 x
方差为 A, v 的方差为 B. x,v 不相关, 协方差为 0</li>
</ol>

<p>
相应的五个公式变为:
</p>

<p>
<a href="https://www.kalmanfilter.net/multiSummary.html">https://www.kalmanfilter.net/multiSummary.html</a>
</p>

<ol class="org-ol">
<li>\(K_n=P_nH^T(HP_nH^T+R)^{-1}\)</li>
<li>\(P_n=(I-K_nH)P_n(I-K_nH)^T+K_nR_n{K_n}^T\)</li>
<li>\(\hat{x}_n=\hat{x}_n+K_n(Z_n-H\hat{x}_n)\)</li>
<li>\(\hat{x}_{n}=F\hat{x}_{n-1}\)</li>
<li>\(P_n=FP_{n}F^T+Q\)</li>
</ol>

<p>
涉及到 P, R 的公式都是 \(APA^T\) 的形式, 因为当 X, Y 是不相关的正态分布是, \(aX+bY\)
也是正态分布, 且其方差为 \(a^2\delta^2_X+b^2\delta^2_Y\)
</p>

<p>
其中 H 为 observation matrix, 用来处理 predict 中某些数据不能 measure 的情况 <a href="#org000001b">跟踪鼠标</a>
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt

<span class="org-variable-name">N</span> = 100
<span class="org-variable-name">t</span> = np.linspace(1, N, N)
<span class="org-variable-name">position</span> = 2 * t + 1

<span class="org-variable-name">STD_POSITION</span> = 10
<span class="org-variable-name">STD_IMU</span> = 3

<span class="org-variable-name">noisy_position</span> = position + np.random.normal(0, STD_POSITION, size=N)
<span class="org-variable-name">noisy_speed</span> = (position[1:] - position[:-1]) + np.random.normal(0, STD_IMU, size=N - 1)

plt.plot(t, position, label=<span class="org-string">"truth position"</span>)
plt.plot(t, noisy_position, label=<span class="org-string">"measured"</span>)

<span class="org-variable-name">predicts</span> = [0]
<span class="org-comment-delimiter"># </span><span class="org-comment">2x1</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">X=[[x],[v]]</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2x2</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">F=[[1,dt],[0,1]]</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2x2</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">P=[[1,0],[0,1]]</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2x2</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">r=[[STD_POSITION**2,0],[0,STD_IMU**2]]</span>
<span class="org-comment-delimiter">#</span>
<span class="org-variable-name">dt</span> = 1
<span class="org-variable-name">X</span> = np.array([[0], [0]])
<span class="org-variable-name">P</span> = [[1, 0], [0, 1]]
<span class="org-comment-delimiter"># </span><span class="org-comment">F,R &#26159;&#25105;&#20204;&#29992; kalman filter &#26102;&#24517;&#38656;&#25552;&#20379;&#30340;&#20004;&#20010;&#21442;&#25968;, F &#20195;&#34920; dynamics &#21442;&#25968;, R &#20195;&#34920;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">correct &#21442;&#25968;</span>
<span class="org-variable-name">F</span> = np.array([[1, dt], [0, 1]])
<span class="org-variable-name">R</span> = [[STD_POSITION ** 2, 0], [0, STD_IMU ** 2]]

<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, N):
    <span class="org-comment-delimiter"># </span><span class="org-comment">measure</span>
    <span class="org-variable-name">Z</span> = [
        [noisy_position[i]],
        [(position[i] - position[i - 1]) + np.random.normal(0, STD_IMU)],
    ]
    <span class="org-comment-delimiter"># </span><span class="org-comment">predict</span>
    <span class="org-variable-name">X</span> = F @ X
    <span class="org-variable-name">P</span> = F @ P @ F.T

    <span class="org-comment-delimiter"># </span><span class="org-comment">update</span>
    <span class="org-variable-name">K</span> = P @ np.linalg.inv(P + R)
    <span class="org-variable-name">X</span> = X + K @ (Z - X)
    <span class="org-variable-name">P</span> = (np.eye(2) - K) @ P @ (np.eye(2) - K).T + K @ R @ K.T

    predicts.append(X[0][0])


plt.plot(t, predicts, label=<span class="org-string">"kalman"</span>)

plt.legend()
plt.show()
</pre>
</div>


<div id="org000001e" class="figure">
<p><img src="../extra/kalman_filter_2d.png" alt="kalman_filter_2d.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org0000026" class="outline-3">
<h3 id="org0000026"><span class="section-number-3">1.4</span> cv2.KalmanFilter</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org0000023" class="outline-4">
<h4 id="org0000023"><span class="section-number-4">1.4.1</span> 匀速运动的小车</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-keyword">import</span> cv2

<span class="org-variable-name">N</span> = 100
<span class="org-variable-name">t</span> = np.linspace(1, N, N)
<span class="org-variable-name">position</span> = 3 * t + 1

<span class="org-variable-name">STD_POSITION</span> = 10
<span class="org-variable-name">STD_IMU</span> = 3

<span class="org-variable-name">noisy_position</span> = position + np.random.normal(0, STD_POSITION, size=N)
<span class="org-variable-name">noisy_speed</span> = (position[1:] - position[:-1]) + np.random.normal(0, STD_IMU, size=N - 1)

plt.plot(t, position, label=<span class="org-string">"truth position"</span>)
plt.plot(t, noisy_position, label=<span class="org-string">"measured"</span>)

<span class="org-variable-name">predicts</span> = [0]

<span class="org-variable-name">dt</span> = 1
<span class="org-variable-name">F</span> = np.array([[1, dt], [0, 1]], np.float32)
<span class="org-variable-name">R</span> = np.array([[STD_POSITION ** 2, 0], [0, STD_IMU ** 2]], np.float32)

<span class="org-builtin">filter</span> = cv2.KalmanFilter(2, 2, 0)
<span class="org-comment-delimiter"># </span><span class="org-comment">F</span>
<span class="org-builtin">filter</span>.transitionMatrix = F
<span class="org-comment-delimiter"># </span><span class="org-comment">R</span>
<span class="org-builtin">filter</span>.measurementNoiseCov = R
<span class="org-comment-delimiter"># </span><span class="org-comment">H</span>
<span class="org-builtin">filter</span>.measurementMatrix = np.eye(2, dtype=np.float32)
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, N):
    <span class="org-comment-delimiter"># </span><span class="org-comment">measure</span>
    <span class="org-variable-name">Z</span> = np.array(
        [
            noisy_position[i],
            (position[i] - position[i - 1]) + np.random.normal(0, STD_IMU),
        ],
        np.float32,
    )
    <span class="org-comment-delimiter"># </span><span class="org-comment">predict</span>
    <span class="org-builtin">filter</span>.predict()
    <span class="org-comment-delimiter"># </span><span class="org-comment">corrent</span>
    <span class="org-variable-name">output</span> = <span class="org-builtin">filter</span>.correct(Z)
    predicts.append(output[0])

plt.plot(t, predicts, label=<span class="org-string">"kalman"</span>)

plt.legend()
plt.show()
</pre>
</div>


<div id="org0000022" class="figure">
<p><img src="../extra/kalman_filter_cv2.png" alt="kalman_filter_cv2.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-org000001b" class="outline-4">
<h4 id="org000001b"><span class="section-number-4">1.4.2</span> 跟踪鼠标</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3</span>
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> cv2


<span class="org-keyword">class</span> <span class="org-type">Stabilizer</span>:
    <span class="org-doc">"""Using Kalman filter as a point stabilizer."""</span>

    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>, state_num=4, measure_num=2, cov_process=0.0001, cov_measure=0.1):

        <span class="org-comment-delimiter"># </span><span class="org-comment">Store the parameters.</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#38544;&#34255;&#29366;&#24577;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">X &#20026; [[x],[y],[v_x],[v_y]]</span>
        <span class="org-keyword">self</span>.state_num = state_num
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#35266;&#27979;&#29366;&#24577;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Z &#20026; [[x],[y]]</span>
        <span class="org-keyword">self</span>.measure_num = measure_num

        <span class="org-comment-delimiter"># </span><span class="org-comment">The filter itself.</span>
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span> = cv2.KalmanFilter(state_num, measure_num, 0)

        <span class="org-comment-delimiter"># </span><span class="org-comment">&#36716;&#31227;&#30697;&#38453;: FX+Q</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">F</span>
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.transitionMatrix = np.array(
            [[1, 0, 1, 0], [0, 1, 0, 1], [0, 0, 1, 0], [0, 0, 0, 1]], np.float32
        )
        <span class="org-comment-delimiter"># </span><span class="org-comment">Q</span>
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.processNoiseCov = np.eye(4, dtype=np.float32) * cov_process
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#35266;&#27979;&#30697;&#38453;: HX+R</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">H, &#30001;&#20110; measure &#20449;&#24687;&#37324;&#21482;&#26377; x,y, &#19981;&#21253;&#25324; v_x, v_y, &#25152;&#20197;&#38656;&#35201;&#29992; H &#25226; x &#20013;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">&#30340;&#21518;&#20004;&#20010;&#25968;&#25454; mask &#25481;</span>
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.measurementMatrix = np.eye(2, 4, dtype=np.float32)
        <span class="org-comment-delimiter"># </span><span class="org-comment">R</span>
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.measurementNoiseCov = np.eye(2, dtype=np.float32) * cov_measure

    <span class="org-keyword">def</span> <span class="org-function-name">update</span>(<span class="org-keyword">self</span>, measurement):
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.predict()
        <span class="org-keyword">self</span>.<span class="org-builtin">filter</span>.correct(measurement)
        <span class="org-comment-delimiter"># </span><span class="org-comment">statePost &#26159; correct &#20043;&#21518;&#30340; state</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">statePre &#26159; predict &#20043;&#21518;, corrent &#20043;&#21069;&#30340; state</span>


<span class="org-keyword">def</span> <span class="org-function-name">main</span>():
    <span class="org-keyword">global</span> mp
    <span class="org-variable-name">mp</span> = np.array((2, 1), np.float32)  <span class="org-comment-delimiter"># </span><span class="org-comment">measurement</span>

    <span class="org-keyword">def</span> <span class="org-function-name">onmouse</span>(k, x, y, s, p):
        <span class="org-keyword">global</span> mp
        <span class="org-variable-name">mp</span> = np.array([[np.float32(x)], [np.float32(y)]])

    cv2.namedWindow(<span class="org-string">"kalman"</span>)
    cv2.setMouseCallback(<span class="org-string">"kalman"</span>, onmouse)
    <span class="org-variable-name">kalman</span> = Stabilizer(4, 2)
    <span class="org-variable-name">frame</span> = np.zeros((768, 1024, 3), np.uint8)

    <span class="org-keyword">while</span> <span class="org-constant">True</span>:
        kalman.update(mp)
        <span class="org-variable-name">state</span> = kalman.<span class="org-builtin">filter</span>.statePost
        cv2.circle(frame, (<span class="org-builtin">int</span>(mp[0]), <span class="org-builtin">int</span>(mp[1])), 2, (255, 0, 0), -1)
        cv2.circle(frame, (<span class="org-builtin">int</span>(state[0]), <span class="org-builtin">int</span>(state[1])), 2, (0, 0, 255), -1)
        cv2.imshow(<span class="org-string">"kalman"</span>, frame)
        <span class="org-variable-name">k</span> = cv2.waitKey(30) &amp; 0xFF
        <span class="org-keyword">if</span> k == 27:
            <span class="org-keyword">break</span>


<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> == <span class="org-string">"__main__"</span>:
    main()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0000029" class="outline-3">
<h3 id="org0000029"><span class="section-number-3">1.5</span> HMM vs. Kalman Filter</h3>
<div class="outline-text-3" id="text-1-5">
<p>
实际上，卡尔曼滤波与隐马尔可夫类似. HMM 的离散高斯动态模型, 而 kalman filter 是连续高斯动态模型. HX+R 相当于观测矩阵, FX+Q 相当于转移矩阵。卡尔曼滤波是给定观测状态序列 Z 求概率最大的隐含状态序列 X
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2020-12-19 Sat 00:00<br />
Last updated: 2022-02-06 Sun 00:02</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
