<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-25 Tue 16:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dagger</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/main.css" media="screen" />
<link rel = "icon" href = "/icon.png"  type = "image/x-icon">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Dagger</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb023a09">1. Dagger</a>
<ul>
<li><a href="#org4a4deda">1.1. DI</a>
<ul>
<li><a href="#orge201a98">1.1.1. 依赖</a></li>
<li><a href="#org1177eb7">1.1.2. DI</a></li>
</ul>
</li>
<li><a href="#org4ea9ae5">1.2. Dagger</a>
<ul>
<li><a href="#org361db78">1.2.1. Inject</a></li>
<li><a href="#orga65df42">1.2.2. Component</a></li>
<li><a href="#orgcf1ab4f">1.2.3. Module &amp; Provides</a></li>
<li><a href="#org9c897cd">1.2.4. Scope 与单例</a></li>
</ul>
</li>
<li><a href="#org89f1bc1">1.3. Dagger Internal</a>
<ul>
<li><a href="#org51bf083">1.3.1. 简单的 inject</a></li>
<li><a href="#orgfa57216">1.3.2. 使用 module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgb023a09" class="outline-2">
<h2 id="orgb023a09"><span class="section-number-2">1</span> Dagger</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org4a4deda" class="outline-3">
<h3 id="org4a4deda"><span class="section-number-3">1.1</span> DI</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orge201a98" class="outline-4">
<h4 id="orge201a98"><span class="section-number-4">1.1.1</span> 依赖</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
若 A 的功能依赖于 B, 则称为 A 对 B 有依赖, 没有使用 DI 时, 依赖通常有几种处理方
式:
</p>

<ol class="org-ol">
<li><p>
在 A 的构造函数中初始化 B, 例如:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">public</span> <span style="font-weight: bold;">A</span>() {
    <span style="font-weight: bold;">this</span>.b = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
}
</pre>
</div></li>

<li><p>
通过 A 的 setter 来初始化 B, 例如:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
a.setB(<span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>());
</pre>
</div></li>
</ol>
</div>

<div id="outline-container-org3285909" class="outline-5">
<h5 id="org3285909"><span class="section-number-5">1.1.1.1</span> 构造函数</h5>
<div class="outline-text-5" id="text-1-1-1-1">
</div>
<ol class="org-ol">
<li><a id="org16fb026"></a>优点<br />
<div class="outline-text-6" id="text-1-1-1-1-1">
<p>
通过构造函数处理依赖的优点是容易处理复杂的依赖关系: 每个依赖自身的构造函数负责处
理它自己的依赖,不需要外界的干预, 例如:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">A</span>() {
        <span style="font-weight: bold;">this</span>.b = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
        <span style="font-weight: bold;">this</span>.c = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">C</span>();
    }
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span> () {
        <span style="font-weight: bold;">this</span>.d = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">D</span>();
    }
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">C</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">C</span> () {
        <span style="font-weight: bold;">this</span>.e = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">E</span>();
        <span style="font-weight: bold;">this</span>.f = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">F</span>();
    }
}

</pre>
</div>
</div>
</li>

<li><a id="org6b4fe06"></a>缺点<br />
<div class="outline-text-6" id="text-1-1-1-1-2">
<p>
各个依赖耦合的一起, 每个依赖不容易替换. 这种耦合对扩展和测试都不利. 例如在单元测
试时, 若要测试 A, 通常需要使用 MockB, MockC 来代替 B, C. 
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org21e0024" class="outline-5">
<h5 id="org21e0024"><span class="section-number-5">1.1.1.2</span> Setter</h5>
<div class="outline-text-5" id="text-1-1-1-2">
</div>
<ol class="org-ol">
<li><a id="org02bf7b6"></a>优点<br />
<div class="outline-text-6" id="text-1-1-1-2-1">
<p>
容易在运行时替换单个依赖
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;
    <span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold; font-style: italic;">c</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">D</span> <span style="font-weight: bold; font-style: italic;">d</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">C</span> {
    <span style="font-weight: bold; text-decoration: underline;">E</span> <span style="font-weight: bold; font-style: italic;">e</span>;
    <span style="font-weight: bold; text-decoration: underline;">F</span> <span style="font-weight: bold; font-style: italic;">f</span>;
}

<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
<span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
<span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold; font-style: italic;">c</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">C</span>();
<span style="font-weight: bold; text-decoration: underline;">D</span> <span style="font-weight: bold; font-style: italic;">d</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">D</span>();
<span style="font-weight: bold; text-decoration: underline;">E</span> <span style="font-weight: bold; font-style: italic;">e</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">E</span>();
<span style="font-weight: bold; text-decoration: underline;">F</span> <span style="font-weight: bold; font-style: italic;">f</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">F</span>();
a.setB(b);
a.setC(c);
b.setD(d);
c.setE(e);
c.setF(f);
</pre>
</div>
</div>
</li>

<li><a id="org229c2b2"></a>缺点<br />
<div class="outline-text-6" id="text-1-1-1-2-2">
<p>
需要人为的分析依赖的顺序并提前生成所有的依赖, 耗时且易出错.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgc57f38e" class="outline-5">
<h5 id="orgc57f38e"><span class="section-number-5">1.1.1.3</span> Factory</h5>
<div class="outline-text-5" id="text-1-1-1-3">
<p>
使用构造函数不必分析依赖关系, 使用 setter 可以灵活的修改依赖, 通过 Factory 可以
结合两者的优点
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">A</span>() {
        b = Factory.getB();
    }
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold; font-style: italic;">c</span>;
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span>() {
        c = Factory.getC();
    }
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Factory</span> {
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold;">getB</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
    }

    <span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold;">getC</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">C</span>();
    }
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span> {
    <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1177eb7" class="outline-4">
<h4 id="org1177eb7"><span class="section-number-4">1.1.2</span> DI</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
Dependency Injection (DI) 的效果和 Factory 类似, 但不需要自己手写 Factory 的那些
boilerplate 代码, 它的主要功能是:
</p>

<ol class="org-ol">
<li>分析依赖关系</li>
<li>自动生成对象并使它们满足依赖</li>
</ol>
</div>

<div id="outline-container-org57817f9" class="outline-5">
<h5 id="org57817f9"><span class="section-number-5">1.1.2.1</span> JSR-330</h5>
</div>
</div>
</div>

<div id="outline-container-org4ea9ae5" class="outline-3">
<h3 id="org4ea9ae5"><span class="section-number-3">1.2</span> Dagger</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<a href="https://www.jianshu.com/p/24af4c102f62?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">dagger2 教程</a>
</p>

<p>

</p>

<p>
Dagger 是编译时的 DI 框架: 它在编译时通过 annotation 分析依赖关系, 并生成相应的
代码, 而不是在运行时通过反射及动态代码生成等方式.
</p>

<p>
Dagger 主要定义是以下的 annotation:
</p>

<ol class="org-ol">
<li>Inject</li>
<li>Component</li>
<li>Module</li>
<li>Provides</li>
<li>Singleton</li>
</ol>
</div>

<div id="outline-container-org361db78" class="outline-4">
<h4 id="org361db78"><span class="section-number-4">1.2.1</span> Inject</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
对于一个依赖 `A -&gt; B`, Inject annotation 有两个作用:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span>() {}
}
</pre>
</div>

<p>
对于 A 来说, 把成员 b 声明为 Inject, 表示 A 依赖 B, 需要 dagger 自动给 b 赋值
对于 B 来说, 把构造函数声明为 Inject, 表示 dagger 可以通过这个构造函数给需要 b
的地方 (例如 A.b) 提供一个 B 的对象.
</p>

<p>
Inject 主要用来 inject 成员变量和构造函数, 除此以外, inject 也可以:
</p>

<ol class="org-ol">
<li><p>
Inject 构造函数时, 构造函数的参数自动构成一个依赖
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span>(<span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold; font-style: italic;">c</span>) {}
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">C</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">C</span>() {}
}
</pre>
</div></li>

<li>Inject 普通成员函数, 该成员函数会在 Inject 构造函数之后自动执行, 且其参数也自
动构成一个依赖</li>
</ol>
</div>
</div>

<div id="outline-container-orga65df42" class="outline-4">
<h4 id="orga65df42"><span class="section-number-4">1.2.2</span> Component</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
通过 Inject 声明了依赖关系后, 需要通过 Component 来实施真正的注入动作, 因为
dagger 是编译时的 DI 框架, 期望 `new A` 时自动注入似乎并不可行.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span>() {}
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span>
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AInjector</span> {
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">inject &#21487;&#20197;&#26159;&#20219;&#24847;&#21517;&#23383;</span>
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>);
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span>() {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span>[] <span style="font-weight: bold; font-style: italic;">args</span>) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        DaggerAInjector.create().inject(a);
        assert(a.b != <span style="font-weight: bold; text-decoration: underline;">null</span>);
    }
}
</pre>
</div>

<p>
dagger 要求 AInjector 是一个接口, 并且会自动生成一个 DaggerAInjector 的类, 通过
DaggerAInjector.create().inject(a) 可以注入 a 的依赖.
</p>
</div>
</div>

<div id="outline-container-orgcf1ab4f" class="outline-4">
<h4 id="orgcf1ab4f"><span class="section-number-4">1.2.3</span> Module &amp; Provides</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
Inject 和 Component 能实现基本的依赖分析与注入, 但有三种情况无法完成:
</p>

<ol class="org-ol">
<li>被依赖的是一个接口, dagger 无法对依赖进行实例化</li>

<li>被依赖的类的构造函数需要用户提供参数</li>

<li>被依赖的是第三方库, 无法给它的构造函数加个 Inject 注解</li>
</ol>

<p>
通过 Module 和 Provides 可以处理这三种情况
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">IB</span> <span style="font-weight: bold; font-style: italic;">b</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold;">implements</span> <span style="font-weight: bold; text-decoration: underline;">IB</span> {

}

<span style="font-weight: bold; text-decoration: underline;">@Module</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span> {
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">provideIB &#21487;&#20197;&#26159;&#20219;&#24847;&#21517;&#23383;, &#21482;&#35201;&#36820;&#22238;&#31867;&#22411;&#19968;&#33268;&#23601;&#21487;&#20197;</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25552;&#20379;&#25509;&#21475;&#30340;&#23454;&#29616;</span>
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">IB</span> <span style="font-weight: bold;">provideIB</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21487;&#20197; provide &#22810;&#20010;&#20381;&#36182;</span>
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">C</span> <span style="font-weight: bold;">provideC</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">C</span>();
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21487;&#20197;&#24102;&#21442;&#25968;</span>
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">D</span> <span style="font-weight: bold;">provideD</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">D</span>(1);
    }
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">provide &#31532;&#19977;&#26041;&#24211;&#20013;&#30340;&#23545;&#35937;</span>
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">HttpClient</span> <span style="font-weight: bold;">provideHttpClient</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">HttpClient</span>();
    }
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Component &#21487;&#20197;&#25351;&#23450;&#22810;&#20010; module, &#27599;&#20010; module &#23545;&#24212;&#19981;&#21516;&#30340;&#21151;&#33021;&#27169;&#22359;</span>
<span style="font-weight: bold; text-decoration: underline;">@Component</span> (module = {TestModule.<span style="font-weight: bold;">class</span><span style="font-weight: bold; font-style: italic;">/*</span><span style="font-weight: bold; font-style: italic;">, Test2Module.class</span><span style="font-weight: bold; font-style: italic;"> */</span>})
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AInjector</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">target</span>);
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span>[] <span style="font-weight: bold; font-style: italic;">args</span>) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>= <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        DaggerAInjector.create().inject(a);
        assert(a.b <span style="font-weight: bold;">instanceof</span> B);
    }
}
</pre>
</div>

<p>
通过修改 Component 使用的 Module, 可以很容易的实现测试时需要的 Mock Object:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; text-decoration: underline;">@Module</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MockBModule</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">IB</span> <span style="font-weight: bold;">provideIB</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">MockB</span>();
    }
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span> (module = MockBModule.<span style="font-weight: bold;">class</span>)
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AUnitTestInjector</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">target</span>);
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UnitTest</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span>[] <span style="font-weight: bold; font-style: italic;">args</span>) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>= <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        DaggerAUnitTestInjector.create().inject(a);
        assert(a.b <span style="font-weight: bold;">instanceof</span> B);
    }
}
</pre>
</div>
</div>
</div>


<div id="outline-container-org9c897cd" class="outline-4">
<h4 id="org9c897cd"><span class="section-number-4">1.2.4</span> Scope 与单例</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
依赖图是唯一的, 但默认情况下 dagger 每次使用 component 注入依赖时都会按初始化新
的依赖对象.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b</span>;

    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b2</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">B</span>() {}
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span>
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AInjector</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>);
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span>() {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span>[] <span style="font-weight: bold; font-style: italic;">args</span>) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        DaggerAInjector.create().inject(a);
        assert(a.b != a.b2);
    }
}

</pre>
</div>

<p>
有两种方式可以实现单例:
</p>

<ol class="org-ol">
<li>通过自己控制 module 的 provideXXX 返回一个单例的对象</li>
<li>通过 Scope</li>
</ol>
</div>

<div id="outline-container-orged7a74d" class="outline-5">
<h5 id="orged7a74d"><span class="section-number-5">1.2.4.1</span> Module 实现单例</h5>
<div class="outline-text-5" id="text-1-2-4-1">
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b1</span>;

    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b2</span>;
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">B</span> {}

<span style="font-weight: bold; text-decoration: underline;">@Module</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span> {
    <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">sB</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold;">provideB</span>() {
        <span style="font-weight: bold;">return</span> sB;
    }
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span> (module = TestModule.<span style="font-weight: bold;">class</span>)
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AInjector</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">target</span>);
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span>[] <span style="font-weight: bold; font-style: italic;">args</span>) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span>= <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        DaggerAInjector.create().inject(a);
        assert(a.b1 == a.b2)
    }
}

</pre>
</div>
</div>
</div>

<div id="outline-container-org1700588" class="outline-5">
<h5 id="org1700588"><span class="section-number-5">1.2.4.2</span> Scope 实现单例</h5>
<div class="outline-text-5" id="text-1-2-4-2">
<ol class="org-ol">
<li>声明一个 Scope annotation</li>
<li>声明 Component 属于这个 scope</li>
<li>声明 Provides A 属于这个 scope</li>
</ol>

<p>
则使用同一个 Component 注入的 A 都是重用的
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">A</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b1</span>;

    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold; font-style: italic;">b2</span>;
}

<span style="font-weight: bold; text-decoration: underline;">@Scope</span>
<span style="font-weight: bold;">@interface</span> <span style="font-weight: bold; text-decoration: underline;">TestScope</span> {}

<span style="font-weight: bold; text-decoration: underline;">@Module</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">@TestScope</span>
    <span style="font-weight: bold; text-decoration: underline;">B</span> <span style="font-weight: bold;">provideB</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">B</span>();
    }
}

<span style="font-weight: bold; text-decoration: underline;">@TestScope</span>
<span style="font-weight: bold; text-decoration: underline;">@Component</span> (modules = TestModule.<span style="font-weight: bold;">class</span>)
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AInjector</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">target</span>);
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">argv</span>[]) {
        <span style="font-weight: bold; text-decoration: underline;">A</span> <span style="font-weight: bold; font-style: italic;">a</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">A</span>();
        <span style="font-weight: bold; text-decoration: underline;">AInjector</span> <span style="font-weight: bold; font-style: italic;">injector</span> = DaggerAInjector.create();
        injector.inject(a);
        assert(a.b1 == a.b2);
    }
}
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org89f1bc1" class="outline-3">
<h3 id="org89f1bc1"><span class="section-number-3">1.3</span> Dagger Internal</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org51bf083" class="outline-4">
<h4 id="org51bf083"><span class="section-number-4">1.3.1</span> 简单的 inject</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">--------------------------------</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BBB</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">BBB</span>() {}
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span>
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">BasicComponent</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">target</span>);
}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AAA</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">BBB</span> <span style="font-weight: bold; font-style: italic;">bbb</span>;
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">---------------------------------</span>
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HelloDaggerSimple</span> {
    <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">testInjection</span>() {
        <span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">program</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">AAA</span>();
        DaggerBasicComponent.create().inject(program);

    }

    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">argv</span>[]) {
        testInjection();
    }
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#33258;&#21160;&#29983;&#25104;&#30340;&#20195;&#30721;:</span>

<span style="font-weight: bold; text-decoration: underline;">DaggerBasicComponent</span>:

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">BasicComponent</span> <span style="font-weight: bold;">create</span>() {
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">Builder</span>().build();
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">target</span>) {
    injectAAA(target);
}

<span style="font-weight: bold;">private</span> <span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold;">injectAAA</span>(<span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">instance</span>) {
    AAA_MembersInjector.injectBbb(instance, <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">BBB</span>());
    <span style="font-weight: bold;">return</span> instance;
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">AAAMembersInjector:</span>
<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">injectBbb</span>(<span style="font-weight: bold; text-decoration: underline;">Object</span> <span style="font-weight: bold; font-style: italic;">instance</span>, <span style="font-weight: bold; text-decoration: underline;">Object</span> <span style="font-weight: bold; font-style: italic;">bbb</span>) {
    ((<span style="font-weight: bold; text-decoration: underline;">AAA</span>) instance).bbb = (<span style="font-weight: bold; text-decoration: underline;">BBB</span>) bbb;
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25152;&#20197; DaggerBasicComponent.create().inject(program) &#23637;&#24320;&#21518;&#31561;&#20215;&#20026;:</span>
program.bbb = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">BBB</span>();
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa57216" class="outline-4">
<h4 id="orgfa57216"><span class="section-number-4">1.3.2</span> 使用 module</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-java"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BBB</span> {
    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">BBB</span>() {}

}

<span style="font-weight: bold; text-decoration: underline;">@Module</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Provides</span>
    <span style="font-weight: bold; text-decoration: underline;">BBB</span> <span style="font-weight: bold;">provideBBB</span>() {
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">BBB</span>();
    }
}

<span style="font-weight: bold; text-decoration: underline;">@Component</span>(modules = TestModule.<span style="font-weight: bold;">class</span>)
<span style="font-weight: bold;">interface</span> <span style="font-weight: bold; text-decoration: underline;">AAAComponent</span> {
    <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">inject</span>(<span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">aaa</span>);

}

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AAA</span> {
    <span style="font-weight: bold; text-decoration: underline;">@Inject</span>
    <span style="font-weight: bold; text-decoration: underline;">BBB</span> <span style="font-weight: bold; font-style: italic;">mClient</span>;
}

<span style="font-weight: bold;">public</span> <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HelloDaggerModule</span> {
    <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">testModule</span> () {
        <span style="font-weight: bold; text-decoration: underline;">AAA</span> <span style="font-weight: bold; font-style: italic;">aaa</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">AAA</span>();
        DaggerAAAComponent.create().inject(aaa);
    }

    <span style="font-weight: bold;">public</span> <span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">main</span>(<span style="font-weight: bold; text-decoration: underline;">String</span> <span style="font-weight: bold; font-style: italic;">argv</span>[]) {
        testModule();
    }
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">DaggerAAAComponent.create()</span>
<span style="font-weight: bold;">this</span>.testModule = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span>();
<span style="font-weight: bold;">return</span> <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">DaggerAAAComponent</span>(<span style="font-weight: bold;">this</span>);

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">inject</span>
AAA_MembersInjector.injectMClient(
    instance, TestModule_ProvideBBBFactory.proxyProvideBBB(testModule));

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">TestModule_ProvideBBBFactory.proxyProvideBBB</span>
<span style="font-weight: bold;">return</span> instance.provideBBB()

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">AAAMembersInjector.injectMClient</span>
((<span style="font-weight: bold; text-decoration: underline;">AAA</span>) instance).mClient = (<span style="font-weight: bold; text-decoration: underline;">BBB</span>) mClient;

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25152;&#20197;  DaggerAAAComponent.create().inject(aaa) &#23637;&#24320;&#20026;:</span>
aaa.mClient = (<span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">TestModule</span>()).provideBBB();

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">TestModule &#30340;&#20316;&#29992;&#19982; Factory &#31867;&#20284;</span>

</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

<p class="author">Author: sunway (sunwayforever@gmail.com)<br />
Date: 2019-07-03 Wed 00:00<br />
Last updated: 2021-09-16 Thu 11:06</p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
<br />

<div id="disqus_thread"></div>
<script>

(function() { // DON'T EDIT BELOW THIS LINE
         var d = document, s = d.createElement('script');
         s.src = '//sunwayforever-github-io.disqus.com/embed.js';
         s.setAttribute('data-timestamp', +new Date());
         (d.head || d.body).appendChild(s);
         })();
</script>
</div>
</body>
</html>
